<style>
    /* ğŸš© ê·¸ë¦¬ê¸° í¼ ìœ„ì¹˜ ê°•ì œ ì„¤ì • - ì¢Œì¸¡ í•˜ë‹¨ (ìµœìš°ì„  ìˆœìœ„) */
    div#drawingForm[style],
    div#drawingForm {
        position: absolute !important;
        bottom: 10px !important;
        left: 10px !important;
        right: auto !important;
        top: auto !important;
        transform: none !important;
        z-index: 1000 !important;
        background: rgba(30, 42, 56, 0.95) !important;
        padding: 12px 16px !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        max-width: 90% !important;
        width: auto !important;
        color: #ecf0f1 !important;
    }
    
    #drawingForm form,
    div#drawingForm form {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        gap: 10px !important;
        flex-wrap: wrap !important;
        justify-content: flex-start !important;
    }

    /* íŒì—…ì´ í•­ìƒ label marker ìœ„ì— ì˜¤ë„ë¡ z-index ê°•ì œ */
    .leaflet-popup-pane {
        z-index: 1000 !important;
            </div>

            <!-- ğŸš© [ìˆ˜ì •] ì˜¤ë¥¸ìª½ ì»¨íŠ¸ë¡¤ ê·¸ë£¹ (í•„í„° ë° ê²€ìƒ‰) -->
            gap: 6px;
        }
    }
</style>
<script>
// (removed duplicate/conflicting menu toggle logic)
</script>
<style>
/* ì„¸ë¡œê°€ ê°€ë¡œë³´ë‹¤ ê¸¸ë©´(ëª¨ë°”ì¼ ê°•ì œ) ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ì ìš© */
body.force-mobile #mainContainer {
    flex-direction: column !important;
    height: 100% !important;
    padding: 0 !important;
}
body.force-mobile #leftColumn {
    flex-basis: 100% !important;
}
body.force-mobile #rightPanel {
    position: fixed !important;
    z-index: 1002;
    background-color: #1e2a38e0;
    backdrop-filter: blur(10px);
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
body.force-mobile #controls-wrapper {
    position: static !important;
    top: auto !important;
    left: auto !important;
    width: 100% !important;
    margin-top: 0 !important;
    border-bottom: 2px solid #00aaff;
    z-index: 1000 !important;
    background-color: #1e2a38e0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 0 0 12px 12px;
    display: block !important;
    transform: none !important;
    animation: none !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
}
body.force-mobile #controls-wrapper.visible {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
body.force-mobile #controls-wrapper:not(.visible) {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
@keyframes slideDownMenu {
    /* í”Œë¡œíŒ… ì• ë‹ˆë©”ì´ì…˜ ì‚¬ìš© ì•ˆí•¨ */
}
/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ top-bar ë‚´ìš© ìˆ¨ê¸°ê¸° */
body.force-mobile #top-bar-container {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding: 10px !important;
    position: relative !important;
    z-index: 1005 !important;
    background-color: #1e2a38 !important;
}
body.force-mobile #top-left-icons {
    display: none !important;
}
body.force-mobile #main-title {
    display: none !important;
}
body.force-mobile #top-right-auth {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    flex-wrap: wrap !important;
}
/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ top-right-authì˜ ìš”ì†Œë“¤ í‘œì‹œ ì œì–´ */
body.force-mobile #usernameDisplay {
    display: block !important;
    white-space: nowrap !important;
    font-weight: bold !important;
    font-size: 12px !important;
}
body.force-mobile #pcTopPanelToggleBtn {
    display: none !important;
}
body.force-mobile #accountLink {
    display: inline-block !important;
    padding: 4px 8px !important;
    font-size: 11px !important;
}
body.force-mobile #adminLink {
    display: inline-block !important;
    padding: 4px 8px !important;
    font-size: 11px !important;
}
body.force-mobile #logoutBtnHeader {
    padding: 4px 8px !important;
    font-size: 11px !important;
}
body.force-mobile #rightPanel {
    top: 0;
    right: 0;
    width: 85vw;
    max-width: 400px;
    height: 100vh;
    border-left: 2px solid #00aaff;
    border-top: none;
    display: none !important;
    transform: translateX(100%) !important;
}
body.force-mobile #rightPanel.visible {
    display: flex !important;
    transform: none !important;
}
body.force-mobile #rightPanelToggleBtn {
    top: auto;
    bottom: 15px;
    left: auto;
    right: 15px;
    z-index: 1003;
    writing-mode: horizontal-tb;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 40px;
    padding: 0;
    display: block !important;
}
/* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œ í•„í„°/ê²€ìƒ‰ í–‰ì„ í•œ ì¤„ë¡œ ì»´íŒ©íŠ¸í•˜ê²Œ í‘œì‹œ */
body.force-mobile .right-controls {
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
    gap: 2px !important;
}
body.force-mobile #country-filter-container {
    order: 1 !important;
    flex-basis: auto !important;
    height: 24px !important;
}
body.force-mobile #country-filter-container label {
    font-size: 9px !important;
}
body.force-mobile #countryFilterSelect {
    font-size: 9px !important;
    padding: 1px 2px !important;
    height: 100% !important;
    min-width: 60px !important;
    width: 60px !important;
}
body.force-mobile #dynastyTimelineFilterPanel {
    order: 2 !important;
    flex-basis: auto !important;
    height: 24px !important;
}
body.force-mobile #ethnicityFilterContainer {
    font-size: 9px !important;
    height: 100% !important;
}
body.force-mobile #ethnicityFilterContainer label {
    font-size: 9px !important;
}
body.force-mobile #ethnicityFilterContainer select {
    font-size: 9px !important;
    padding: 1px 2px !important;
    height: 100% !important;
    min-width: 65px !important;
    width: 65px !important;
}
body.force-mobile .right-controls > div:last-child {
    order: 3 !important;
    flex: 0 0 auto !important;
    min-width: unset !important;
    width: auto !important;
    height: 24px !important;
    display: flex !important;
    align-items: center !important;
    gap: 1px !important;
}
body.force-mobile #searchInput {
    font-size: 9px !important;
    padding: 1px 3px !important;
    height: 100% !important;
    flex: 0 0 80px !important;
    min-width: 80px !important;
}
body.force-mobile #searchBtn {
    font-size: 9px !important;
    padding: 1px 4px !important;
    height: 100% !important;
    flex: 0 0 56px !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì§€ë„ ìƒì˜ ì»¨íŠ¸ë¡¤ë“¤ í‘œì‹œ */
body.force-mobile #time-controls-map {
    display: flex !important;
    position: fixed !important;
    top: 56px !important;
    left: 5px !important;
    right: 5px !important;
    z-index: 500 !important;
    max-width: calc(100% - 10px) !important;
    padding: 4px !important;
    margin: 0 !important;
}

body.force-mobile #time-controls-map {
    gap: 2px !important;
    flex-wrap: wrap !important;
    flex-direction: row !important;
    align-items: center !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì—°ë„ í‘œì‹œ ì˜ì—­ì„ ì²« ì¤„ë¡œ ê³ ì • */
body.force-mobile #time-controls-map #timeLabelDisplay {
    font-size: 8px !important;
    flex: 1 1 auto !important;
    min-width: 0 !important;
    max-width: none !important;
    overflow: hidden !important;
    white-space: nowrap !important;
    order: 1 !important;
}

body.force-mobile #time-controls-map #yearLabel {
    display: inline-block !important;
    min-width: 45px !important;
    text-align: right !important;
}

body.force-mobile #time-controls-map #monthLabel {
    display: inline-block !important;
    min-width: 12px !important;
    text-align: right !important;
}

body.force-mobile #time-controls-map #ganjiLabel {
    display: inline-block !important;
    min-width: 25px !important;
}

body.force-mobile #time-controls-map #yearInput {
    width: 45px !important;
    min-height: 24px !important;
    font-size: 10px !important;
    padding: 2px 3px !important;
    order: 2 !important;
}

body.force-mobile #time-controls-map #monthInput {
    width: 30px !important;
    min-height: 24px !important;
    font-size: 10px !important;
    padding: 2px 3px !important;
    order: 3 !important;
}

body.force-mobile #time-controls-map .time-control-btn {
    min-height: 24px !important;
    font-size: 9px !important;
    padding: 2px 3px !important;
    min-width: 24px !important;
    flex: 0 0 auto !important;
    order: 10 !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì¬ìƒ/ì •ì§€ ë²„íŠ¼ ë° ì»¨í…Œì´ë„ˆ ê°•ì œ ìˆ¨ê¸°ê¸° */
body.force-mobile .playback-button-container,
body.force-mobile #playBtn,
body.force-mobile #pauseBtn,
body.force-mobile #time-controls-map .playback-button-container,
body.force-mobile #time-controls-map #playBtn,
body.force-mobile #time-controls-map #pauseBtn {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì¬ìƒì†ë„ ìŠ¬ë¼ì´ë” ë° ê´€ë ¨ ìš”ì†Œ ê°•ì œ ìˆ¨ê¸°ê¸° */
body.force-mobile #playbackSpeedSlider,
body.force-mobile label[for="playbackSpeedSlider"],
body.force-mobile #speedDisplay,
body.force-mobile #time-controls-map #playbackSpeedSlider,
body.force-mobile #time-controls-map label[for="playbackSpeedSlider"],
body.force-mobile #time-controls-map #speedDisplay {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
}

body.force-mobile #time-controls-map input[type="range"] {
    min-height: 32px !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ì„ ë‘ ë²ˆì§¸ ì¤„ì— ë°°ì¹˜ */
body.force-mobile #layer-toggles {
    display: flex !important;
    flex-wrap: nowrap !important;
    gap: 1px !important;
    margin-left: 0 !important;
    padding-left: 0 !important;
    border-left: none !important;
    width: 100% !important;
    justify-content: flex-start !important;
    order: 20 !important;
    flex-basis: 100% !important;
}

body.force-mobile #layer-toggles .layer-toggle-btn {
    min-height: 20px !important;
    font-size: 7px !important;
    padding: 1px 2px !important;
    min-width: 0 !important;
    flex: 1 1 auto !important;
    white-space: nowrap !important;
    line-height: 1.2 !important;
    text-align: center !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì™• ëª©ë¡ íŒ¨ë„ ì¶•ì†Œ */
body.force-mobile #map-king-panel {
    width: 200px !important;
    max-height: 20vh !important;
    padding: 6px !important;
    bottom: 75px !important;
    left: 5px !important;
}

body.force-mobile #map-king-panel h3 {
    font-size: 9px !important;
    margin-bottom: 4px !important;
    padding-bottom: 3px !important;
}

body.force-mobile #map-king-list {
    font-size: 7px !important;
    line-height: 1.3 !important;
}

/* ğŸš© [ì¶”ê°€] PCì—ì„œ ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ */
#map-history-panel {
    transition: width 0.3s ease, padding 0.3s ease !important;
}

#map-history-panel:not(.expanded) {
    width: 32px !important;
    padding: 4px 2px !important;
    overflow: hidden !important;
}

/* ê°ì¶˜ ìƒíƒœì—ì„œ ìˆ¨ê¸¸ ìš”ì†Œë“¤ - IDì™€ ìì‹ ì„ íƒìë¡œ ì •í™•íˆ ì§€ì • */
#map-history-panel:not(.expanded) #map-history-resizer,
#map-history-panel:not(.expanded) > div:nth-child(2) > span,
#map-history-panel:not(.expanded) > div:nth-child(3),
#map-history-panel:not(.expanded) > div:nth-child(4),
#map-history-panel:not(.expanded) #map-prev-history-btn,
#map-history-panel:not(.expanded) #map-next-history-btn,
#map-history-panel:not(.expanded) #map-open-history-form-btn {
    display: none !important;
}

/* í† ê¸€ ë²„íŠ¼ë§Œ ìœ ì§€ - ë” ì‘ê²Œ */
#map-history-panel:not(.expanded) #map-history-toggle-btn {
    display: inline-block !important;
    margin: 0 !important;
    padding: 4px 3px !important;
    width: 24px !important;
    min-width: 24px !important;
    font-size: 10px !important;
}

/* ê°ì¶˜ ìƒíƒœì—ì„œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆëŠ” ì¤‘ì•™ ì •ë ¬ */
#map-history-panel:not(.expanded) > div:nth-child(2) {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    margin: 0 !important;
}

#map-history-panel.expanded {
    width: 320px !important;
    padding: 12px !important;
}

#map-history-panel.expanded #map-history-resizer {
    display: block !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ìë™ ì¶•ì†Œ */
body.force-mobile #map-history-panel {
    width: 40px !important;
    padding: 8px 4px !important;
    right: 5px !important;
}

body.force-mobile #map-history-panel.expanded {
    width: calc(100vw - 10px) !important;
    max-width: 320px !important;
    padding: 8px !important;
    right: 5px !important;
    left: auto !important;
    max-height: 50vh !important;
    overflow-y: auto !important;
}

body.force-mobile #map-history-panel > div:first-child span {
    display: none !important;
}

body.force-mobile #map-history-panel h3,
body.force-mobile #map-history-panel #map-history-records,
body.force-mobile #map-history-panel #map-prev-history-btn,
body.force-mobile #map-history-panel #map-next-history-btn,
body.force-mobile #map-history-panel #map-open-history-form-btn {
    display: none !important;
}

body.force-mobile #map-history-panel.expanded > div:first-child span {
    display: inline !important;
}

body.force-mobile #map-history-panel.expanded h3,
body.force-mobile #map-history-panel.expanded #map-history-records {
    display: block !important;
}

body.force-mobile #map-history-panel.expanded #map-prev-history-btn,
body.force-mobile #map-history-panel.expanded #map-next-history-btn,
body.force-mobile #map-history-panel.expanded #map-open-history-form-btn {
    display: inline-block !important;
}

body.force-mobile #map-history-panel h3 {
    font-size: 11px !important;
}

body.force-mobile #map-history-panel.expanded h3 {
    font-size: 11px !important;
}

body.force-mobile #map-history-records {
    font-size: 9px !important;
    line-height: 1.4 !important;
}

body.force-mobile #map-history-panel #map-history-toggle-btn {
    transform: rotate(90deg);
}

body.force-mobile #map-history-panel.expanded #map-history-toggle-btn {
    transform: rotate(0deg);
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì—°ëŒ€í‘œë¥¼ time-controls ì•„ë˜ ë” ë‚´ë ¤ì„œ ë°°ì¹˜ */
body.force-mobile #timeline-container {
    position: fixed !important;
    top: 140px !important;
    left: 5px !important;
    right: 5px !important;
    z-index: 499 !important;
    width: calc(100% - 10px) !important;
}

body.force-mobile #edit-controls {
    display: flex !important;
    position: fixed !important;
    top: 10px !important;
    right: 5px !important;
    left: auto !important;
    z-index: 1001 !important;
    gap: 2px !important;
}

body.force-mobile #edit-controls button {
    min-height: 26px !important;
    padding: 3px 5px !important;
    font-size: 10px !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì§€ë„ í™•ëŒ€/ì¶•ì†Œ ë²„íŠ¼ê³¼ ìŠ¤ì¼€ì¼ ìˆ¨ê¸°ê¸° */
body.force-mobile .leaflet-control-zoom,
body.force-mobile .leaflet-control-scale {
    display: none !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ê³ ëŒ€ ì§€ë„ ë§í¬ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸° */
body.force-mobile #ancient-map-button-container {
    display: none !important;
}

body.force-mobile #map-search-filter {
    position: fixed !important;
    bottom: 5px !important;
    left: 5px !important;
    right: 5px !important;
    transform: none !important;
    width: auto !important;
    padding: 2px 4px !important;
    flex-wrap: nowrap !important;
    gap: 2px !important;
    font-size: 8px !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
}

body.force-mobile #map-search-filter select,
body.force-mobile #map-search-filter input,
body.force-mobile #map-search-filter button {
    font-size: 8px !important;
    padding: 1px 3px !important;
    min-height: 22px !important;
    flex-shrink: 0 !important;
}

body.force-mobile #map-search-filter label {
    font-size: 8px !important;
    white-space: nowrap !important;
}

body.force-mobile #drawingForm {
    display: none !important; /* ë³´ì´ì§€ ì•Šì„ ë•Œ */
    position: fixed !important;
    bottom: 10px !important;
    left: 10px !important;
    right: auto !important;
    top: auto !important;
    transform: none !important;
    max-width: 95% !important;
    width: auto !important;
    padding: 8px !important;
}

body.force-mobile #drawingForm[style*="display: block"],
body.force-mobile #drawingForm[style*="display:block"] {
    display: flex !important; /* ë³´ì¼ ë•Œ */
}

body.force-mobile #drawingForm button {
    min-height: 36px !important;
    font-size: 12px !important;
    padding: 6px 8px !important;
}

body.force-mobile #drawingForm input,
body.force-mobile #drawingForm select {
    min-height: 32px !important;
    font-size: 12px !important;
    padding: 4px 6px !important;
}

body.force-mobile #drawingForm label {
    font-size: 11px !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ëª¨ë“  í¸ì§‘ í¼ í¬ê¸° ì¡°ì • */
body.force-mobile #castleForm,
body.force-mobile #historyForm,
body.force-mobile #countryForm,
body.force-mobile #kingForm,
body.force-mobile #eventForm {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 90vw !important;
    max-width: 90vw !important;
    max-height: 85vh !important;
    overflow-y: auto !important;
    padding: 15px !important;
}

body.force-mobile #castleForm h3,
body.force-mobile #historyForm h3,
body.force-mobile #countryForm h3,
body.force-mobile #kingForm h3,
body.force-mobile #eventForm h3 {
    font-size: 16px !important;
    margin: 0 0 10px 0 !important;
}

body.force-mobile .form-row {
    margin-bottom: 8px !important;
}

body.force-mobile .form-row label {
    font-size: 13px !important;
    margin-bottom: 4px !important;
}

body.force-mobile .form-row input,
body.force-mobile .form-row select,
body.force-mobile .form-row textarea {
    font-size: 14px !important;
    padding: 8px !important;
    min-height: 40px !important;
}

body.force-mobile .form-row textarea {
    min-height: 80px !important;
}

body.force-mobile .form-actions button {
    font-size: 14px !important;
    padding: 10px 16px !important;
    min-height: 44px !important;
    margin: 4px !important;
}

body.force-mobile .marker-type-selector button {
    font-size: 13px !important;
    padding: 8px 12px !important;
    min-height: 40px !important;
}
</style>
<!DOCTYPE html>
<html lang="ko">
<head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>ê³ ë ¤ë§Œë¦¬ì§€ë„ (é«˜éº—è¬é‡Œåœ°åœ–)</title>
  <link rel="icon" type="image/jpg" href="https://pds.joongang.co.kr/news/component/htmlphoto_mmdata/200609/htm_20060904073327a000a010-001.JPG">
  <!-- ğŸš© [ì¶”ê°€] Google Fonts (Noto Serif KR) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- ğŸš© [ìˆ˜ì •] Nanum Brush Script ê¸€ê¼´ ì¶”ê°€ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Yeon+Sung&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- ğŸš© [ì¶”ê°€] Leaflet.draw í”ŒëŸ¬ê·¸ì¸ -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath/leaflet.textpath.min.js"></script>
  <!-- ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì´ë²¤íŠ¸ë¥¼ ìœ„í•œ Hammer.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <!-- ğŸš© [ì¶”ê°€] Leaflet.PolylineDecorator í”ŒëŸ¬ê·¸ì¸ (í™”ì‚´í‘œìš©) -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <style>
    /* ------------------- 1. ì „ì²´ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ CSS ------------------- */
    /* ğŸš© [ì¶”ê°€] ë·°í¬íŠ¸ ì „ì²´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ html, body ë†’ì´ ì„¤ì • */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
    body {
        background-color: #19191b; 
        /* background-image: url('https://i.pinimg.com/1200x/ea/ff/c5/eaffc5798174bca27342dc968d58a61a.jpg'); */
        /* background-size: cover; */
        /* background-position: center; */
        /* background-attachment: fixed; */
        color: #dbdbdb; 
        font-family: Arial, sans-serif;
        font-size:medium;
        display: flex; /* ğŸš© [ì¶”ê°€] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
        flex-direction: column; /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ì •ë ¬ */
    }
    /* ğŸš© [ìˆ˜ì •] mainContainerê°€ bodyì˜ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ flex-grow: 1 ì„¤ì • */
    #mainContainer {
        display: flex; /* ğŸš© [ìˆ˜ì •] mainContainerë¥¼ flexë¡œ ë³€ê²½ */
        width: 100%; /* ë„ˆë¹„ 100% */
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        padding: 0 10px 10px; /* ìƒë‹¨ ì—¬ë°± ì œê±°, ì¢Œìš°/í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
        box-sizing: border-box; /* íŒ¨ë”©ì„ ë„ˆë¹„/ë†’ì´ì— í¬í•¨ */
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    #map { 
        height: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #19191b; /* ğŸš© [ì¶”ê°€] íƒ€ì¼ ë¡œë”© ì „ ë°°ê²½ìƒ‰ ì„¤ì • */
        position: relative; /* ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ì˜ ê¸°ì¤€ì ìœ¼ë¡œ ì„¤ì • */
        overflow: hidden; /* ğŸš© [ì¶”ê°€] íƒ€ì¼ ë¡œë”© ì¤‘ ê²½ê³„ê°€ ë³´ì´ëŠ” í˜„ìƒ ë°©ì§€ */
    }
    /* ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì € í•¸ë“¤ ìŠ¤íƒ€ì¼ */
    #resizer { 
        width: 5px; 
        cursor: col-resize; 
        background-color: #5d7185; 
        flex-shrink: 0; 
        transition: background-color 0.2s; 
    } 
    #resizer:hover { 
        background-color: #00aaff; 
    }
    /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ë¦¬ì‚¬ì´ì € í•¸ë“¤ ìŠ¤íƒ€ì¼ */
    #vertical-resizer {
        height: 1px;
        cursor: row-resize;
        background-color: #ffffff;
        flex-shrink: 0; /* ë¦¬ì‚¬ì´ì € ë†’ì´ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
    }
    #rightPanel {
        /* ğŸš© [ìˆ˜ì •] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ë‚´ë¶€ ìš”ì†Œ ì œì–´ */
        display: flex;
        flex-direction: column;
        flex-basis: 30%; /* ğŸš© [ìˆ˜ì •] widthë¥¼ flex-basisë¡œ ë³€ê²½ */
        transition: all 0.3s ease-in-out; /* ğŸš© [ì¶”ê°€] ì ‘ê³  í´ì§ˆ ë•Œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        position: relative; /* ğŸš© [ì¶”ê°€] í† ê¸€ ë²„íŠ¼ì˜ ìœ„ì¹˜ ê¸°ì¤€ì  */
        border-top: 3px solid #00aaff; 
        /* ğŸš© [í•µì‹¬ ìˆ˜ì •] ì˜¤ë¥¸ìª½ íŒ¨ë„ì— ë°°ê²½ ì´ë¯¸ì§€ ë° ê°€ë…ì„±ì„ ìœ„í•œ ì˜¤ë²„ë ˆì´ ì¶”ê°€ */
        background-image: url('https://i.namu.wiki/i/VnqWqBvjxcHxswDWPKyIinchC7ZIdLK1N5LfaklC7gnTyzvTRTlekzY8Ln249BOp5cWCv2QbtwSnjZ1OYDq8yQ.webp');
        background-size: cover;
        background-position: center;
        background-color: rgba(0, 0, 0, 0.5); /* ì–´ë‘ìš´ ì˜¤ë²„ë ˆì´ */
        background-blend-mode: multiply; /* ì´ë¯¸ì§€ë¥¼ ì–´ë‘¡ê²Œ ë§Œë“¦ */
        min-height: 0; /* ğŸš© [ì¶”ê°€] flex ìì‹ ìš”ì†Œì˜ ìŠ¤í¬ë¡¤ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ ì„¤ì • */
    }
    /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #rightPanelToggleBtn {
        position: absolute;
        top: 10px;
        left: -28px; /* íŒ¨ë„ ì™¼ìª½ì— ë¶™ë„ë¡ ìœ„ì¹˜ ì¡°ì • */
        z-index: 999;
        padding: 10px 5px;
        writing-mode: vertical-rl; /* í…ìŠ¤íŠ¸ë¥¼ ì„¸ë¡œë¡œ í‘œì‹œ */
        border-radius: 5px 0 0 5px;
        border-right: none;
        font-size: 12px;
        line-height: 1;
    }
    /* ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì €ë„ í•¨ê»˜ ìˆ¨ê¹€ ì²˜ë¦¬ */
    #resizer.hidden {
        display: none; /* ë¦¬ì‚¬ì´ì €ëŠ” ì™„ì „íˆ ìˆ¨ê¹€ */
    }
    #kingPanel {
        display: flex; /* ğŸš© [ì¶”ê°€] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
        flex-direction: column; /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ì •ë ¬ */
        flex-shrink: 0; /* ğŸš© [ì¶”ê°€] íŒ¨ë„ ë†’ì´ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
        border-bottom: 1px solid #5d7185;
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    /* ğŸš© [ì¶”ê°€] ì™• ëª©ë¡ ë‚´ìš© ì˜ì—­ ìŠ¤í¬ë¡¤ ì ìš© */
    #kingPanel .slider-label {
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ë°” í‘œì‹œ */
    }
    #historyPanelContainer {
        display: flex; /* ğŸš© [ìˆ˜ì •] ë‚´ë¶€ ìš”ì†Œë¥¼ flexë¡œ ì œì–´ */
        flex-direction: column;
        flex-basis: 70%;
        padding-top: 15px;
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    /* ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ ë‚´ìš© ì˜ì—­ ìŠ¤í¬ë¡¤ ì ìš© */
    #historyRecords {
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ë°” í‘œì‹œ */
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
        padding-right: 5px; /* ìŠ¤í¬ë¡¤ë°”ì™€ì˜ ê°„ê²© í™•ë³´ */
    }
    #historyPanel {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        transition: all 0.3s ease-in-out; /* ğŸš© [ì¶”ê°€] ì ‘ê³  í´ì§ˆ ë•Œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
    }
    #historyPanel.collapsed {
        display: none;
    }
    #historyPanelToggleBtn {
        margin-left: 10px;
        cursor: pointer;
    }
    /* ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë”ì™€ ì—°ëŒ€í‘œ ë˜í¼ ìŠ¤íƒ€ì¼ */
    #timeline-slider-wrapper {
        background: transparent;
        padding: 0;
    }

    /* ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì»¨í…Œì´ë„ˆë¥¼ ì§€ë„ ë‚´ë¶€ì— ë°°ì¹˜ */
    #timeline-container {
        position: relative;
        width: 100%;
        height: 45px; /* ğŸš© [ìˆ˜ì •] tick ê³µê°„ì„ ìœ„í•´ ë†’ì´ ì¦ê°€ */
        overflow-x: hidden; /* ğŸš© [ìˆ˜ì •] ê°€ë¡œ ìŠ¤í¬ë¡¤ë§Œ ìˆ¨ê¹€ */
        overflow-y: visible; /* ğŸš© [ìˆ˜ì •] ì„¸ë¡œëŠ” visibleë¡œ tick í‘œì‹œ */
        box-sizing: border-box;
        margin-top: 5px; /* ğŸš© [ìˆ˜ì •] ê³µë°± ìµœì†Œí™” */
    }
    
    /* ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì½˜í…ì¸  - ë§ˆìŠ¤í¬ ì œê±° */
    #timeline-content {
        position: relative;
        height: 100%;
        min-width: 3000px; /* ì¶©ë¶„íˆ ë„“ì€ ìº”ë²„ìŠ¤ */
        padding-top: 0; /* ğŸš© [ìˆ˜ì •] tickì´ ìœ„ì— ìˆìœ¼ë¯€ë¡œ padding ì œê±° */
    }
    
    /* ğŸš© [ìˆ˜ì •] í˜ì´ë“œ ë ˆì´ì–´ ì œê±° */
    #timeline-fade-left,
    #timeline-fade-right {
        display: none;
    }
    
    /* ğŸš© [ì¶”ê°€] ì¤‘ì•™ ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ */
    #timeline-center-indicator {
        animation: pulseIndicator 2s ease-in-out infinite;
    }
    
    @keyframes pulseIndicator {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; }
    }
    
    /* ğŸš© [ì¶”ê°€] í•„í„° ì„ íƒ ì‹œ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
    select.filter-active {
        background-color: #4a90e2 !important;
        color: white !important;
        border-color: #357abd !important;
        font-weight: bold;
    }
    
    /* ğŸš© [ì¶”ê°€] í™•ëŒ€ì¶•ì†Œ ë²„íŠ¼ ê°€ë¡œ ì •ë ¬ */
    .leaflet-control-zoom {
        display: flex !important;
        flex-direction: row !important;
        border: none !important;
    }
    
    .leaflet-control-zoom a {
        width: 24px !important;
        height: 24px !important;
        line-height: 22px !important;
        font-size: 14px !important;
        border: 2px solid rgba(0,0,0,0.2) !important;
        margin: 0 2px !important;
    }
    
    /* ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar {
        position: absolute;
        height: 10px;
        border-radius: 0px;
        cursor: pointer;
        pointer-events: auto; /* ğŸš© [ìˆ˜ì •] í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ ë°›ë„ë¡ autoë¡œ ë³€ê²½ */
        transition: filter 0.2s;
        color: white;
        font-size: 9px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        text-align: left; /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ë¥¼ ì™¼ìª½ ì •ë ¬í•©ë‹ˆë‹¤. */
        line-height: 10px; /* í…ìŠ¤íŠ¸ê°€ ë§‰ëŒ€ ì•ˆì— ì˜¤ë„ë¡ ì¡°ì • */
        padding-left: 5px; /* ğŸš© [ì¶”ê°€] ì™¼ìª½ì— ì—¬ë°±ì„ ì¤ë‹ˆë‹¤. */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .timeline-bar:hover {
        filter: none; /* ğŸš© [ìˆ˜ì •] ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë°ê¸° íš¨ê³¼ë¥¼ ì œê±°í•˜ì—¬ íˆ¬ëª…ë„ ê´€ë ¨ í˜¼ë€ì„ ë°©ì§€í•©ë‹ˆë‹¤. */
        transform: scaleY(1.5);
    }
    /* ğŸš© [ì¶”ê°€] ì£¼ìš” ì™•ì¡° ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar.main-dynasty {
        height: 10px; /* ë” êµµê²Œ í‘œì‹œ */
        z-index: 10; /* ë‹¤ë¥¸ ë§‰ëŒ€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        line-height: 10px; /* í…ìŠ¤íŠ¸ ì„¸ë¡œ ì •ë ¬ */
    }
    /* ğŸš© [ì¶”ê°€] ë‚˜ë¨¸ì§€ êµ­ê°€ ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar.minor-dynasty {
        height: 8px; /* ì£¼ìš” ì™•ì¡°ë³´ë‹¤ ì•½ê°„ ì–‡ê²Œ */
        z-index: 5; /* ì£¼ìš” ì™•ì¡°ë³´ë‹¤ ì•„ë˜ì— ì˜¤ë„ë¡ ì„¤ì • */
        opacity: 0.85; /* ğŸš© [ìˆ˜ì •] ë” ì˜ ë³´ì´ë„ë¡ íˆ¬ëª…ë„ ì¦ê°€ */
    }
    /* ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
    #combinedSlider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        background: rgba(255, 255, 255, 0.1); /* ì•½ê°„ ë³´ì´ëŠ” íŠ¸ë™ ë°°ê²½ */
        outline: none;
        height: 4px;
        border-radius: 2px;
    }

    /* Chrome, Safari, Opera, Edge */
    /* ğŸš© [ìˆ˜ì •] ìŠ¬ë¼ì´ë” í•¸ë“¤ ìˆ¨ê¸°ê¸° */
    #combinedSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 0;
        height: 0;
        opacity: 0;
        display: none;
    }

    /* Firefox */
    #combinedSlider::-moz-range-thumb {
        width: 0;
        height: 0;
        opacity: 0;
        display: none;
    }
    
    #combinedSlider::-moz-range-track { 
        background: transparent; 
    }

    /* ğŸš© [ì¶”ê°€] Leaflet ì¤Œ ì»¨íŠ¸ë¡¤ ìœ„ì¹˜ ì¡°ì • */
    .leaflet-bottom.leaflet-left {
        bottom: 10px;
        left: 10px;
    }
    .leaflet-control-zoom {
        margin: 0 !important;
    }

    /* ------------------- 2. ë§ˆì»¤ ë””ìì¸ CSS ------------------- */
    
    /* ì „ì¥ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .battle-marker {
        font-size: 36px; /* ì „ì¥ ì•„ì´ì½˜ í¬ê¸° í‚¤ì›€ */
        color: #ffffff; /* ë¶‰ì€ìƒ‰ */ /* ì „ì¥ ë§ˆì»¤ ìƒ‰ìƒ */
        font-weight: bold;
        background-color: transparent; /* ë°°ê²½ íˆ¬ëª…í•˜ê²Œ ë³€ê²½ */
        padding: 2px 5px; /* íŒ¨ë”© ì¶”ê°€ */
        text-shadow: 1px 1px 2px #000;
        text-align: center;
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));
    }
    
    /* ì „ì¥ ë§ˆì»¤ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .battle-marker-text {
        font-size: 12px;
        color: white;
        white-space: nowrap;
        margin-top: -5px;
    }
    
    /* ì§€ì—­ëª… ë¼ë²¨ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .label-text-marker {
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));
    }
    
    /* ì¼ë°˜ ì„±/ë„ì‹œ ë§ˆì»¤ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .city-marker-text {
        /* ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆì§€ë§Œ, í•„ìš”ì‹œ ì—¬ê¸°ì„œ ì¶”ê°€ ì¡°ì • ê°€ëŠ¥ */
    }
    
/* ------------------- ì™•ì„± ë§ˆì»¤ CSS ì¶”ê°€ ------------------- */
    .capital-marker {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 20px; /* ì™•ê´€ í¬ê¸° */
        color: gold; /* í™©ê¸ˆìƒ‰ */
        font-weight: bold;
        text-shadow: 1px 1px 2px #000;
        line-height: 1;
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));
    }
    /* ğŸš© [ìˆ˜ì •] ì™•ì„± ë° ì¼ë°˜ì„± ì´ë¦„í‘œ ë°°ê²½ ì´ë¯¸ì§€ ë° ìŠ¤íƒ€ì¼ ì ìš© */
    .capital-marker .city-name {
        font-size: 12px;
        color: #ffffff; /* ë°ì€ í…ìŠ¤íŠ¸ */
        background-image: url('https://github.com/projeffmanager-design/img/blob/main/%E1%84%89%E1%85%A5%E1%86%AB.png?raw=true');
        background-size: 100% 100%;
        background-repeat: no-repeat;
        padding: 4px 12px; /* ğŸš© ìˆ˜ì •: íŒ¨ë”© ì¡°ì • */
        border-radius: 5px;
        display: inline-block; /* ğŸš© ìˆ˜ì •: ë„ˆë¹„ê°€ ë‚´ìš©ì— ë§ê²Œ ì¡°ì ˆë˜ë„ë¡ ë³€ê²½ */
        white-space: nowrap; /* ğŸš© ìˆ˜ì •: í…ìŠ¤íŠ¸ê°€ í•œ ì¤„ë¡œ í‘œì‹œë˜ë„ë¡ ì„¤ì • */
        margin-top: -3px; /* ğŸš© ìˆ˜ì •: ì™•ê´€ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²©ì„ ë” ì¢í˜ */
        text-align: center; /* ğŸš© [ì¶”ê°€] ì´ë¦„í‘œ ë‚´ë¶€ í…ìŠ¤íŠ¸ë¥¼ ì¤‘ì•™ ì •ë ¬í•©ë‹ˆë‹¤. */
        text-shadow: -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000, 0px 0px 3px #000; /* ğŸš© ê°•í™”: í…ìŠ¤íŠ¸ ê°€ë…ì„±ì„ ìœ„í•œ ê·¸ë¦¼ì */
        transform: scale(var(--marker-scale, 1));
    }

    /* ğŸš© [ì¶”ê°€] êµ­ê¸° ì´ë¯¸ì§€ í†¤ ë‹¤ìš´ */
    .country-flag-img {
        filter: saturate(60%) brightness(90%) drop-shadow(2px 2px 3px rgba(0,0,0,0.7));
    }

    /* ì¥ìˆ˜/ë³‘ë ¥ ì •ë³´: ë°°ê²½ìƒ‰ ìœ ì§€ */
    .military-flag-details {
        background-color: transparent;
        padding: 1px 3px;
        border-radius: 3px;
        display: inline-block;
        white-space: nowrap; 
        text-align: center; 
        color: white;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
    }
        .flag-icon-container {
        /* ì‚¬ìš©ì ì§€ì • ê³ ì • í¬ê¸° ìœ ì§€ */
        display: flex; /* Flexbox í™œì„±í™” */
        flex-direction: column; /* ìˆ˜ì§ ì •ë ¬ (ê¹ƒë°œ ìœ„, í…ìŠ¤íŠ¸ ì•„ë˜) */
        align-items: center; /* ë‚´ë¶€ ì•„ì´í…œ ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
        text-align: center;
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));

        /* ì „ì²´ ë§ˆì»¤ í¬ê¸° ë° ìœ„ì¹˜ ì¡°ì • (êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤) */
        width: 30px; 
        height: 30px; /* í¬ê¸° ì¡°ì • */
        
        line-height: 1; 
        font-weight: bold;
        color: #ecf0f1; 
        text-shadow: 1px 1px 1px #000; /* í…ìŠ¤íŠ¸ ê·¸ë¦¼ì ì¶”ê°€ */
        font-size: 15px; /* ê¹ƒë°œ ê¸°í˜¸ í¬ê¸° */
    }
    /* ê¹ƒë°œ ê¸°í˜¸ (âš‘) ìŠ¤íƒ€ì¼ */
    .flag-icon-symbol {
        font-size: 20px; /* ê¹ƒë°œ ê¸°í˜¸ í¬ê¸°ë¥¼ ì¢€ ë” í‚¤ì›ë‹ˆë‹¤. */
        line-height: 1;
        height: 30px; /* í…ìŠ¤íŠ¸ì™€ì˜ ë¶„ë¦¬ë¥¼ ìœ„í•´ ë†’ì´ ê³ ì • */
        margin-bottom: 2px;
    }

    /* ------------------- ì§€ì—­ëª… í…ìŠ¤íŠ¸ ë§ˆì»¤ CSS ì¶”ê°€ ------------------- */
        .location-label-marker {
    font-size: var(--label-font-size, 15px);
    font-weight: bold;
    color: #ffffff;
    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
    background-color: rgba(44, 62, 80, 0);
    border-radius: 5px;
    padding: 5px 10px;
    white-space: nowrap;
    line-height: 1.2;
    text-align: center;
    z-index: 600;
    pointer-events: none;
    transform: scale(var(--marker-scale, 1));
        }

        /* ëª¨ë°”ì¼ì—ì„œ ì§€ë„ ë§ˆì»¤/ì§€ëª…/ì•„ì´ì½˜ë§Œ í¬ê²Œ */
        @media (max-width: 900px) {
            .location-label-marker { font-size: 16px !important; }
            .capital-marker { font-size: 22px !important; }
            .capital-marker .city-name { font-size: 12px !important; }
            .battle-marker { font-size: 36px !important; }
            .flag-icon-container { font-size: 16px !important; }
            .flag-icon-symbol { font-size: 20px !important; }
            .natural-feature-marker { font-size: 20px !important; }
        }
        @media (max-width: 600px) {
            .location-label-marker { font-size: 18px !important; }
            .capital-marker { font-size: 24px !important; }
            .capital-marker .city-name { font-size: 13px !important; }
            .battle-marker { font-size: 42px !important; }
            .flag-icon-container { font-size: 18px !important; }
            .flag-icon-symbol { font-size: 22px !important; }
            .natural-feature-marker { font-size: 22px !important; }
        }
        @media (max-width: 400px) {
            .location-label-marker { font-size: 20px !important; }
            .capital-marker { font-size: 26px !important; }
            .capital-marker .city-name { font-size: 14px !important; }
            .battle-marker { font-size: 48px !important; }
            .flag-icon-container { font-size: 20px !important; }
            .flag-icon-symbol { font-size: 24px !important; }
            .natural-feature-marker { font-size: 24px !important; }
        }

    /* ------------------- 3. í¼ ë° íŒ¨ë„ ë””ìì¸ CSS ------------------- */
    /* ğŸš© [ìˆ˜ì •] í¼ íŒ¨ë„ ìŠ¤íƒ€ì¼ ê°œì„  */
    /* ğŸš© [ìˆ˜ì •] í¼ ì´ë™ì„ ìœ„í•´ left, transform ì†ì„± ì œê±° */
        #castleForm, #historyForm, #countryForm, #kingForm, #eventForm {
            /* ğŸš© [ìˆ˜ì •] top ì†ì„±ì„ ì œê±°í•˜ê³  JSì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. */
            position: absolute; 
            background: #2c3e50; color: #ecf0f1; border: 1px solid #5d7185;
            padding: 20px; 
            z-index: 1000; 
            border-radius: 8px;
            width: 600px;
            left: calc(50% - 300px); /* (100% - 600px) / 2 */
            /* ğŸš© [ì¶”ê°€] í¼ì´ ë„ˆë¬´ ê¸¸ì–´ì§ˆ ê²½ìš° ìŠ¤í¬ë¡¤ì´ ìƒê¸°ë„ë¡ max-height ì„¤ì • */
            max-height: 90vh;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); max-width: 90%; min-width: 350px;
            overflow: auto; /* ğŸš© [ìˆ˜ì •] í¼ í¬ê¸°ë¥¼ ì¤„ì´ë©´ ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ìƒê¸°ë„ë¡ */
            resize: both;
            min-width: 250px;
            min-height: 200px;
            max-width: 98vw;
            max-height: 95vh;
        }
        
        /* drawingForm ìŠ¤íƒ€ì¼ì€ íŒŒì¼ ìƒë‹¨ì— í†µí•©ë¨ */
        
        #drawingForm .form-row {
            display: contents !important;
        }
        
        #drawingForm label {
            font-size: 12px;
            margin: 0;
            white-space: nowrap;
        }
        
        #drawingForm input[type="text"] {
            width: 100px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        #drawingForm input[type="number"] {
            width: 70px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        #drawingForm select {
            width: 80px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        #drawingForm button {
            padding: 4px 12px;
            font-size: 12px;
        }

        /* ------------------- ëª¨ë°”ì¼ í¼ ë°˜ì‘í˜• ------------------- */
                @media (max-width: 967px) {
                    #castleForm, #historyForm, #countryForm, #kingForm, #eventForm {
                        width: 90vw !important;
                        left: 5vw !important;
                        min-width: unset !important;
                        max-width: 95vw !important;
                        max-height: 90vh !important;
                        overflow-y: auto !important;
                        padding-bottom: 80px !important; /* ë²„íŠ¼ ê³µê°„ í™•ë³´ */
                    }
                    #castleForm .form-actions,
                    #historyForm .form-actions,
                    #countryForm .form-actions,
                    #kingForm .form-actions,
                    #eventForm .form-actions,
                    #drawingForm .form-actions {
                        position: sticky;
                        bottom: 0;
                        background: #2c3e50;
                        z-index: 10;
                        padding: 10px 0 0 0;
                        margin-bottom: 0;
                        width: 100%;
                        justify-content: flex-end;
                        display: flex;
                    }
                    /* í¼ì€ JSë¡œ ì—´ë¦´ ë•Œë§Œ display:block/flexê°€ ë¨. ê°•ì œ display: flex !important ì œê±° */
                    #castleForm,
                    #historyForm,
                    #countryForm,
                    #kingForm,
                    #eventForm {
                        flex-direction: column !important;
                    }
                    #castleForm form,
                    #historyForm form,
                    #countryForm form,
                    #kingForm form,
                    #eventForm form {
                        display: flex;
                        flex-direction: column;
                        flex: 1 1 auto;
                        min-height: 0;
                    }
                    /* drawingForm ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ì€ íŒŒì¼ ìƒë‹¨ì— í†µí•©ë¨ */
                    #drawingForm input,
                    #drawingForm select {
                        font-size: 11px !important;
                        padding: 3px 6px !important;
                    }
                    #drawingForm button {
                        font-size: 11px !important;
                        padding: 3px 10px !important;
                    }
                }

</body>
<script>
// ğŸš© í¼ ë“œë˜ê·¸: í„°ì¹˜ ì§€ì› ì¶”ê°€ (ëª¨ë°”ì¼)
function enableFormDrag(formId) {
    const form = document.getElementById(formId);
    if (!form) return;
    const header = form.querySelector('h3');
    if (!header) return;
    let offsetX = 0, offsetY = 0, startX = 0, startY = 0, dragging = false;

    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
    header.onmousedown = function(e) {
        dragging = true;
        startX = e.clientX;
        startY = e.clientY;
        const rect = form.getBoundingClientRect();
        offsetX = startX - rect.left;
        offsetY = startY - rect.top;
        document.onmousemove = function(e2) {
            if (!dragging) return;
            form.style.left = (e2.clientX - offsetX) + 'px';
            form.style.top = (e2.clientY - offsetY) + 'px';
            form.style.right = '';
        };
        document.onmouseup = function() {
            dragging = false;
            document.onmousemove = null;
            document.onmouseup = null;
        };
    };

    // í„°ì¹˜ ì´ë²¤íŠ¸
    header.ontouchstart = function(e) {
        if (e.touches.length !== 1) return;
        dragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        const rect = form.getBoundingClientRect();
        offsetX = startX - rect.left;
        offsetY = startY - rect.top;
        document.ontouchmove = function(e2) {
            if (!dragging || e2.touches.length !== 1) return;
            form.style.left = (e2.touches[0].clientX - offsetX) + 'px';
            form.style.top = (e2.touches[0].clientY - offsetY) + 'px';
            form.style.right = '';
            e2.preventDefault();
        };
        document.ontouchend = function() {
            dragging = false;
            document.ontouchmove = null;
            document.ontouchend = null;
        };
    };
}

// ì—¬ëŸ¬ í¼ì— ì ìš© (drawingFormì€ ì œì™¸ - í•˜ë‹¨ ê³ ì •)
['castleForm','historyForm','countryForm','kingForm','eventForm'].forEach(enableFormDrag);
    <!-- ìƒë‹¨ ë©”ë‰´ëŠ” í•­ìƒ ë³´ì´ë„ë¡ JS í† ê¸€ ë¡œì§ ì œê±° -->
    
    /* ì‚¬ì„œ ê¸°ë¡ ì¹¼ëŸ¼ ìŠ¤íƒ€ì¼ */
    .record-column { 
        border: 1px solid #ffffff00; border-radius: 4px; background: #3e526800; 
        font-size: 12px; /* ğŸš© [ì¶”ê°€] 'ê¸°ë¡ ì—†ìŒ' í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
        padding: 1px; /* ğŸš© [ì¶”ê°€] ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
    }
    .record-column h2 { border-bottom: 1px solid #000000; }
    .record-item {
        /* ğŸš© [ìˆ˜ì •] ë°°ê²½ ì´ë¯¸ì§€ ë° ê´€ë ¨ ìŠ¤íƒ€ì¼ ì ìš© */
        background-image: url('https://img.freepik.com/free-photo/vintage-grungy-textured-paper-background_53876-103932.jpg?semt=ais_hybrid&w=740&q=80');
        background-size: cover;
        color: #000000; /* ì–´ë‘ìš´ ê¸€ììƒ‰ */
        border: 1px solid #7c481c; /* í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½ */
        border-radius: 4px;
        padding: 10px; /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
        margin-bottom: 5px; /* ğŸš© [ìˆ˜ì •] ì•„ì´í…œ ê°„ ê°„ê²© ì¡°ì • */
        font-size: 12px; /* ğŸš© [ìˆ˜ì •] ê¸€ì”¨ í¬ê¸° 10pxë¡œ ì¡°ì • */
        white-space: pre-wrap;
        line-height: 1.5; /* ğŸš© [ì¶”ê°€] ì „ì²´ì ì¸ ì¤„ ê°„ê²© ì„¤ì • */
        font-family: 'Noto Serif KR', serif; /* íŒì—…ê³¼ ë™ì¼í•œ í°íŠ¸ ì ìš© */
    }
    .record-item.foreign { 
        /* ğŸš© [ìˆ˜ì •] foreign ê¸°ë¡ë„ ë™ì¼í•œ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ë„ë¡ ë°°ê²½ìƒ‰ ì œê±° */
        border: 1px solid #8c7b6c; border-radius: 4px; 
        font-size: 12px; /* ğŸš© [ì¶”ê°€] 'ê¸°ë¡ ì—†ìŒ' í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
    } 
    .record-item.true_history { border-left: 3px solid #2ecc71; } 
    


    /* ğŸš© [ìˆ˜ì •] í¼ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ê°œì„  (ë‹¤í¬ í…Œë§ˆ ì ìš©) */
    #castleForm input, #historyForm input, #countryForm input, #kingForm input, #eventForm input, #drawingForm input,
    #castleForm select, #historyForm select, #countryForm select, #kingForm select, #eventForm select, #drawingForm select, #castleForm textarea,
    #historyForm textarea {
        margin: 4px 0; 
        padding: 8px; 
        width: 100%; 
        box-sizing: border-box; 
        background-color: #1c2833;
        color: #ecf0f1;
        border: 1px solid #5d7185;
        border-radius: 4px;
    }
    #castleForm input:focus, #historyForm input:focus, #countryForm input:focus, #kingForm input:focus, #eventForm input:focus, #drawingForm input:focus,
    #castleForm select:focus, #historyForm select:focus, #countryForm select:focus, #kingForm select:focus, #eventForm select:focus, #drawingForm select:focus, #castleForm textarea:focus,
    #historyForm textarea:focus {
        outline: none;
        border-color: #00aaff;
        box-shadow: 0 0 5px rgba(0, 170, 255, 0.5);
    }
    .record-item button {
        float: right; margin-left: 10px; background-color: #be0000; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer;
    }

    /* ê²½ë¡œ ë°ì´í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .path-point-row {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
      align-items: center;
      padding: 5px;
      border: 1px solid #5d7185;
      border-radius: 3px;
    }
    .path-point-row input {
      flex-grow: 1;
      width: auto; /* flex-grow ë•Œë¬¸ì— width: 100% ë¬´ì‹œ */
      min-width: 0;
    }
    .path-point-row .path-time-input {
      width: 50px;
    }
    .path-point-row button {
      width: 30px;
      padding: 5px;
      margin: 0;
      background-color: #e74c3c;
    }
    #pathDataSection h4 {
      white-space: nowrap; /* ì œëª© ì¤„ë°”ê¿ˆ ë°©ì§€ */
    }

    /* ğŸš© [ì¶”ê°€] í¼ ë ˆì´ì•„ì›ƒ ê°œì„  */
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 10px;
    }
    .form-row label {
      width: 100px; /* ë ˆì´ë¸” ë„ˆë¹„ ê³ ì • */
      flex-shrink: 0; /* ë ˆì´ë¸” ë„ˆë¹„ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
      text-align: right;
      padding-right: 5px;
    }
    .form-row input, .form-row select, .form-row textarea, .form-row .input-group {
      flex-grow: 1; /* ì…ë ¥ í•„ë“œê°€ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
    }
    .input-group {
      display: flex;
      gap: 5px;
    }
    /* ì¬ìƒ/ì •ì§€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
    .playback-button-container {
        position: relative;
        width: auto; /* ğŸš© [ìˆ˜ì •] ë„ˆë¹„ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ë„ë¡ ë³€ê²½ */
        height: auto; /* ğŸš© [ìˆ˜ì •] ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ë„ë¡ ë³€ê²½ */
        align-self: center; /* flex ì•„ì´í…œ ìŠ¤ìŠ¤ë¡œ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
    }

    /* ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒ ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
    .marker-type-selector {
      display: flex;
      border: 1px solid #5d7185;
      border-radius: 5px;
      overflow: hidden;
    }
    /* ğŸš© [í•µì‹¬ ìˆ˜ì •] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ì´ ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ë„ë¡ ìˆ˜ì • */
    .marker-type-selector button {
      flex-grow: 1;
      /* ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ìœ¼ë¯€ë¡œ ì•„ë˜ ì†ì„±ë“¤ì€ ì œê±° ë˜ëŠ” ìˆ˜ì •ë©ë‹ˆë‹¤. */
      /* all: unset; */
      /* text-align: center; */
      /* padding: 6px 5px; */
      /* cursor: pointer; */
      transition: all 0.2s ease; /* ğŸš© [ìˆ˜ì •] ê¸°ë³¸ ë²„íŠ¼ê³¼ ë™ì¼í•œ ì „í™˜ íš¨ê³¼ ì ìš© */
      opacity: 0.5; /* ë¹„í™œì„± ìƒíƒœì¼ ë•Œ ë°˜íˆ¬ëª… ì²˜ë¦¬ */
      border-radius: 0; /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ ê·¸ë£¹ì˜ ì¤‘ê°„ ë²„íŠ¼ë“¤ì€ ê°ì§„ ëª¨ì„œë¦¬ë¡œ */
      border-right: none; /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ ì œê±°í•˜ì—¬ ë²„íŠ¼ë“¤ì´ ë¶™ì–´ë³´ì´ê²Œ í•¨ */
    }
    .marker-type-selector button.active {
      background-color: #008cff; /* ğŸš© [ìˆ˜ì •] í™œì„± ìƒ‰ìƒì„ ë‹¤ë¥¸ ë²„íŠ¼ê³¼ í†µì¼ */
      opacity: 1; /* í™œì„± ìƒíƒœì¼ ë•Œ ì™„ì „ ë¶ˆíˆ¬ëª… */
      font-weight: bold;
    }
    .marker-type-selector button:hover:not(.active) {
      background-color: #36434f; /* ğŸš© [ìˆ˜ì •] í˜¸ë²„ ìƒ‰ìƒì„ ë‹¤ë¥¸ ë²„íŠ¼ê³¼ í†µì¼ */
      opacity: 0.8; /* ğŸš© [ì¶”ê°€] ë¹„í™œì„± ë²„íŠ¼ í˜¸ë²„ ì‹œ ì•½ê°„ ë” ì§„í•˜ê²Œ */
    }

    /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µí•© ë° ì—­í• ë³„ í´ë˜ìŠ¤ ì •ì˜ */
    button, .button-style, input[type="button"], input[type="submit"] {
        all: unset; /* ëª¨ë“  ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        display: inline-block;
        box-sizing: border-box;
        background-color: #3e4a56; /* ë” ì–´ë‘ìš´ ê¸°ë³¸ ë°°ê²½ìƒ‰ */
        color: #f0f0f0; /* ğŸš© [ìˆ˜ì •] ë” ë°ì€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        border: 1px solid #5d7185; /* ğŸš© [ìˆ˜ì •] í…Œë‘ë¦¬ ìƒ‰ìƒ ë°ê²Œ ì¡°ì • */
        padding: 5px 5px; /* ğŸš© [ìˆ˜ì •] íŒ¨ë”© ì¡°ì • */
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease; /* ğŸš© [ìˆ˜ì •] ëª¨ë“  ì†ì„±ì— ì „í™˜ íš¨ê³¼ ì ìš© */
        font-size: 12px; /* ğŸš© [ìˆ˜ì •] í°íŠ¸ í¬ê¸° ì¡°ì • */
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* ğŸš© [ì¶”ê°€] í…ìŠ¤íŠ¸ ê·¸ë¦¼ìë¡œ ê°€ë…ì„± í–¥ìƒ */
        text-align: center;
        line-height: 1.2;
    }

    button:hover, .button-style:hover, input[type="button"]:hover, input[type="submit"]:hover {
        background-color: #36434f; /* ì–´ë‘ìš´ í˜¸ë²„ ìƒ‰ìƒ */
        border-color: #5d7185;
    }

    button.primary, button.active, .button-style.active, button:active, input[type="submit"] {
        background-color: #008cff; /* ğŸš© [ìˆ˜ì •] í™œì„±/ì£¼ìš” ìƒ‰ìƒì„ ë” ë°ì€ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        border-color: #008cff;
    }

    button.primary:hover, input[type="submit"]:hover {
        background-color: #006bb3; /* ğŸš© [ìˆ˜ì •] primary ë²„íŠ¼ í˜¸ë²„ ì‹œ ë” ì–´ë‘ìš´ íŒŒë€ìƒ‰ */
        border-color: #006bb3;
    }

    button.danger {
        background-color: #c0392b; /* í†¤ ë‹¤ìš´ëœ ìœ„í—˜ ìƒ‰ìƒ */
        border-color: #c0392b;
    }
    button.danger:hover {
        background-color: #e74c3c;
    }

        /* ìì—° ì§€ë¬¼ ë§ˆì»¤ ìŠ¤íƒ€ì¼ (NEW) */
    .natural-feature-marker {
        font-size: 20px; /* ì•„ì´ì½˜ í¬ê¸° */
        font-weight: bold;
        text-shadow: 1px 1px 2px #000;
        text-align: center;
        line-height: 1.2;
        padding: 5px;
        border-radius: 50%;
    }
    /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
    .natural-feature-marker { transform: scale(var(--marker-scale, 1)); }
    .natural-feature-marker .feature-name {
        font-size: 11px;
        color: #ecf0f1; 
        background: rgba(54, 77, 99, 0.7);
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
        white-space: nowrap; 
        margin-top: 2px;
    }
    /* íŠ¹ì • íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ */
    .feature-mountain { color: #2ecc71; background-color: transparent; } /* ì‚°/ìˆ² */
    .feature-sea { color: #3498db; background-color: transparent; } /* ë°”ë‹¤/í˜¸ìˆ˜ */
    .feature-river { color: #1abc9c; background-color: transparent; } /* ê°•/ë‚´ë¥™ */
    .feature-mudflat { color: #f1c40f; background-color: transparent; } /* ë»˜/ëŠª */
    .feature-hunting { color: #e67e22; background-color: transparent; } /* ì‚¬ëƒ¥í„° */
    .feature-construction { color: #95a5a6; background-color: transparent; } /* ê±´ì„¤ */
    .feature-other { color: #ecf0f1; background-color: transparent; } /* ê¸°íƒ€ */

    /* ğŸš© [ì¶”ê°€] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #layer-toggles .layer-toggle-btn {
        padding: 6px 8px; /* ğŸš© [ìˆ˜ì •] ë‹¤ë¥¸ ë²„íŠ¼ê³¼ ë†’ì´ ë§ì¶¤ (ì¶•ì†Œ) */
        font-size: 11px;
    }

    /* ğŸš© [ì‹ ê·œ] í¸ì§‘ ì»¨íŠ¸ë¡¤ PC ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    #edit-controls {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
        height: 26px;
    }
    #edit-controls #mainEditBtn {
        height: 100%;
        padding: 4px 10px;
        font-size: 13px;
        line-height: 1.2;
        box-sizing: border-box;
    }
    #edit-dropdown-container {
        position: relative;
        display: none;
        height: 100%;
    }
    #edit-dropdown-container #mainEditBtn {
        white-space: nowrap;
    }

    /* í¼ ë‚´ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #castleForm .form-actions button, #historyForm .form-actions button, 
    #countryForm .form-actions button, #kingForm .form-actions button,
    #eventForm .form-actions button, #drawingForm .form-actions button {
        width: 80px;
    }

    /* ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ìŠ¤íƒ€ì¼: ì„±ê³½ ë°°ê²½/ì „ê²½ ìŠ¤íƒ€ì¼ */
    .wall-background, .wall-foreground {
        /* í´ë¦­ ì´ë²¤íŠ¸ê°€ ì „ê²½ ë ˆì´ì–´ì—ë§Œ ë°œìƒí•˜ë„ë¡ ì„¤ì • */
        pointer-events: none;
    }
    .wall-foreground { pointer-events: auto; }

    /* ì™• ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .king-item {
        font-size: 12px; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
        line-height: 1.5;
        margin-bottom: 4px;
    }

    /* ğŸš© [ì¶”ê°€] ê²€ìƒ‰ì°½ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #searchInput {
        display: flex;
        align-items: center;
        all: unset;
        box-sizing: border-box;
        padding: 6px 10px; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ê³¼ ë†’ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ íŒ¨ë”© ì¡°ì • */
        border: 1px solid #4e5d6c;
        border-radius: 4px 0 0 4px; /* ì™¼ìª½ë§Œ ë‘¥ê¸€ê²Œ */
        background-color: #f0f0f0;
        color: black;
        font-size: 12px;
        line-height: 1.2;
        width: 180px; /* ğŸš© [ìˆ˜ì •] ê²€ìƒ‰ì°½ ë„ˆë¹„ í™•ëŒ€ */
    }

    /* ------------------- 4. ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ CSS (NEW) ------------------- */
    /* í™”ë©´ ë„ˆë¹„ê°€ 1200px ì´í•˜ì¼ ë•Œ ì ìš© */
    @media (max-width: 1200px) {
        #top-controls-container {
            flex-direction: column; /* ìˆ˜ì§ìœ¼ë¡œ ìŒ“ê¸° */
            align-items: flex-start; /* ì™¼ìª½ ì •ë ¬ */
            gap: 15px;
        }
        .time-controls, .right-controls {
            width: 100%; /* ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
            flex-wrap: wrap; /* ë‚´ë¶€ ìš”ì†Œë“¤ì´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ì–´ê°€ë„ë¡ ì„¤ì • */
            justify-content: flex-start; /* ì™¼ìª½ë¶€í„° ì •ë ¬ */
            gap: 10px; /* ìš”ì†Œ ê°„ ê°„ê²© ì¶”ê°€ */
        }
        .right-controls {
            justify-content: flex-start; /* ì˜¤ë¥¸ìª½ ì»¨íŠ¸ë¡¤ë„ ì™¼ìª½ë¶€í„° ì •ë ¬ */
        }
    }
    /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë‹«ê¸° ë²„íŠ¼ */
    #closeControlsBtn {
        display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 1003;
        /* ğŸš© [ìˆ˜ì •] ë°°ê²½ê³¼ í…Œë‘ë¦¬ ì œê±° */
        background: none;
        border: none;
        /* ğŸš© [ìˆ˜ì •] í¬ê¸°ì™€ ìƒ‰ìƒ ì¡°ì • */
        font-size: 22px;
        color: #dbdbdb;
    }

    /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¼ í¬ê¸°ê°€ ì¡°ì ˆë  ë§ˆì»¤ë“¤ì˜ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .custom-city-marker, .custom-flag-name-marker, .custom-capital-flag-marker, .battle-marker {
        transform: scale(var(--marker-scale, 1.0));
    }

    /* ğŸš© [ì¶”ê°€] ê³ ëŒ€ ì§€ë„ ë³´ê¸° ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #ancient-map-button-container {
        display: flex; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ì„ ê°€ë¡œë¡œ ë‚˜ì—´í•˜ê¸° ìœ„í•´ flex ì‚¬ìš© */
        gap: 8px; /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        margin-top: auto; /* ğŸš© [ìˆ˜ì •] ìƒë‹¨ ì—¬ë°±ì„ ìë™ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë§¨ ì•„ë˜ë¡œ ë°€ì–´ëƒ„ */
        padding-top: 15px; /* ğŸš© [ì¶”ê°€] ìœ„ìª½ ì½˜í…ì¸ ì™€ì˜ ê°„ê²© í™•ë³´ */
        justify-content: left; /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ë“¤ì„ ì¤‘ì•™ì— ì •ë ¬ */
    }
    /* ğŸš© [ì¶”ê°€] ì„±ê³½ ê·¸ë¦¼ì íš¨ê³¼ë¥¼ ìœ„í•œ SVG í•„í„° */
    .svg-shadow-filter {
        -webkit-filter: drop-shadow( 0px 0px 1.5px rgba(0,0,0,1));
        filter: drop-shadow( 0px 0px 1.5px rgba(0,0,0,1));
        /* ì°¸ê³ : ì¼ë¶€ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•´ -webkit- ì ‘ë‘ì‚¬ í¬í•¨ */
    }

    /* ------------------- 5. ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¬ë¼ì´ë“œ íŒ¨ë„ (NEW) ------------------- */
    @media (max-width: 967px) { /* ğŸš© [ìˆ˜ì •] ê°•ì œ ëª¨ë°”ì¼ ë·° í´ë˜ìŠ¤ ì œê±° */
        /* ê¸°ë³¸ì ìœ¼ë¡œ body ìŠ¤í¬ë¡¤ì„ ë§‰ìŠµë‹ˆë‹¤. */
        html, body {
            /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ê¸°ë³¸ ê¸€ì”¨ í¬ê¸° í‚¤ì›Œì„œ ê°€ë…ì„± í–¥ìƒ */
            font-size: 15px;
            overflow: hidden;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆë¥¼ í™”ë©´ ì „ì²´ë¡œ í™•ì¥í•©ë‹ˆë‹¤. */
        #mainContainer {
            flex-direction: column !important; /* ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ˜ì§ìœ¼ë¡œ ìŒ“ìŠµë‹ˆë‹¤. */
            height: 100%;
            padding: 0;
        }

        /* ì§€ë„ê°€ í•­ìƒ ì „ì²´ í™”ë©´ì„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. */
        #leftColumn {
            flex-basis: 100% !important;
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ë§Œ í™”ë©´ ë°–ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤. */
        #rightPanel {
            position: fixed !important;
            z-index: 1002; /* í¼ë³´ë‹¤ ìœ„ì—, ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ë³´ë‹¤ ìœ„ì— */
            background-color: #1e2a38e0; /* ë°˜íˆ¬ëª… ë°°ê²½ */
            display: block !important;
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* ìƒë‹¨ ë©”ë‰´ëŠ” í•­ìƒ ë³´ì´ê³  ì´ë™í•˜ì§€ ì•ŠìŒ */
        #controls-wrapper {
            position: static !important;
            top: auto !important;
            left: auto !important;
            width: 100% !important;
            transform: none !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            border-bottom: 2px solid #00aaff;
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ ì´ˆê¸° ìœ„ì¹˜ (í™”ë©´ ì˜¤ë¥¸ìª½) */
        #rightPanel {
            /* ğŸš© [ìˆ˜ì •] íŒ¨ë„ì´ ì˜¤ë¥¸ìª½ì—ì„œ ë‚˜ì˜¤ë„ë¡ ë³µì› */
            top: 0;
            right: 0;
            width: 85%; /* í™”ë©´ì˜ 85% ë„ˆë¹„ */
            max-width: 400px;
            height: 100%;
            transform: translateX(100%);
            border-left: 2px solid #00aaff;
            border-top: none; /* ìƒë‹¨ í…Œë‘ë¦¬ ì œê±° */
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ì€ í† ê¸€ë¨ */
        #rightPanel.visible {
            transform: translateX(0);
        }

        /* ê°€ë¡œ/ì„¸ë¡œ ë¦¬ì‚¬ì´ì €ëŠ” ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¹ë‹ˆë‹¤. */
        #resizer, #vertical-resizer {
            display: none;
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
        #rightPanelToggleBtn {
            /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ í•˜ë‹¨ìœ¼ë¡œ ì´ë™ */
            top: auto;
            bottom: 15px;
            left: auto; /* ì˜¤ë¥¸ìª½ ì •ë ¬ì„ ìœ„í•´ leftëŠ” autoë¡œ ë‘¡ë‹ˆë‹¤. */
            right: 15px;
            z-index: 1003; /* ğŸš© [ì¶”ê°€] íŒ¨ë„(z-index: 1002)ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
            /* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ìš© ë””ìì¸ ë³€ê²½ */
            writing-mode: horizontal-tb; /* ì„¸ë¡œì“°ê¸° í•´ì œ */
            width: 40px; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
            height: 40px; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
            border-radius: 50%; /* ì›í˜• ë²„íŠ¼ */
            font-size: 20px; /* ğŸš© [ìˆ˜ì •] ì•„ì´ì½˜ í¬ê¸° ì¶•ì†Œ */
            line-height: 40px; /* ğŸš© [ìˆ˜ì •] ì•„ì´ì½˜ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            padding: 0;
        }
        /* ğŸš© [ì¶”ê°€] íŒ¨ë„ì´ ì—´ë ¸ì„ ë•Œ ë‹«ê¸° ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
        #rightPanel.visible + #rightPanelToggleBtn {
            /* ğŸš© [ìˆ˜ì •] íŒ¨ë„ì´ ì—´ë ¸ì„ ë•Œ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ íŒ¨ë„ì˜ ì™¼ìª½ ìƒë‹¨ìœ¼ë¡œ ì´ë™ */
            right: auto;
            left: 10px;
        }


        /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì˜¤ë¥¸ìª½ íŒ¨ë„ ë‚´ë¶€ ê¸€ì”¨ í¬ê¸° ì¡°ì • */
        #rightPanel .king-item,
        #rightPanel .record-item {
            font-size: 14px;
        }

        /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë ˆì´ì•„ì›ƒ: 4ì¤„ë¡œ ë¶„ë¦¬ */
        #top-controls-container {
            flex-direction: column !important;
            width: 100% !important;
            gap: 5px !important;
            justify-content: flex-start !important;
        }
        
        /* 1ì¤„: ì‹œê°„ ë° ì†ë„ ì»¨íŠ¸ë¡¤ */
        .time-controls {
            width: 100% !important;
            flex-wrap: wrap !important;
            order: 1;
            flex-basis: 100% !important;
            margin-bottom: 0 !important;
        }
        /* ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ ì‹œê°„ ì»¨íŠ¸ë¡¤ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        #time-controls-map {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            right: auto !important;
            max-width: calc(100% - 20px) !important;
            font-size: 11px !important;
            padding: 6px !important;
            flex-wrap: wrap !important;
        }
        #time-controls-map input[type="number"] {
            width: 60px !important;
            font-size: 11px !important;
            padding: 2px !important;
        }
        #time-controls-map button {
            font-size: 11px !important;
            padding: 3px 6px !important;
        }
        #time-controls-map #playbackSpeedSlider {
            width: 50px !important;
        }
        
        /* ğŸš© [ì‹ ê·œ] ëª¨ë°”ì¼ì—ì„œ í¸ì§‘ ì»¨íŠ¸ë¡¤ ì •ë ¬ - ì˜¤ë¥¸ìª½ ìƒë‹¨ */
        #edit-controls {
            position: fixed !important;
            top: 10px !important;
            right: 10px !important;
            bottom: auto !important;
            left: auto !important;
            margin-left: 0 !important;
            gap: 5px !important;
            height: auto !important;
            flex-wrap: wrap !important;
        }
        #edit-controls #mainEditBtn {
            height: 26px !important;
            padding: 4px 6px !important;
            font-size: 12px !important;
            white-space: nowrap !important;
        }
        #edit-dropdown-container {
            flex-shrink: 0 !important;
        }
        #edit-dropdown-menu {
            position: absolute !important;
            top: 100% !important;
            left: 0 !important;
            background-color: #1e2a38 !important;
            border: 1px solid #00aaff !important;
            border-radius: 4px !important;
            z-index: 1000 !important;
            min-width: 120px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
            display: none !important;
        }
        #edit-dropdown-menu.show {
            display: flex !important;
            flex-direction: column !important;
        }
        #edit-dropdown-menu .dropdown-item {
            display: block !important;
            width: 100% !important;
            padding: 6px 10px !important;
            text-align: left !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            font-size: 12px !important;
            color: #f0f0f0 !important;
            transition: background-color 0.2s !important;
        }
        #edit-dropdown-menu .dropdown-item:hover {
            background-color: #00aaff !important;
            color: #1e2a38 !important;
        }
        
        /* 2ì¤„: í•„í„° ë° ê²€ìƒ‰ (êµ­ê°€í•„í„°, ë¯¼ì¡±í•„í„°, ê²€ìƒ‰ì„ í•œ ì¤„ì—) */
        .right-controls {
            width: 100% !important;
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: wrap !important;
            order: 2;
            justify-content: flex-start !important;
            gap: 5px !important;
            align-items: center !important;
            margin-top: 0 !important;
            flex-basis: 100% !important;
        }
        /* êµ­ê°€í•„í„° - ê³ ì • í¬ê¸° */
        #country-filter-container {
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            height: 26px !important;
            gap: 3px !important;
            order: 1 !important;
        }
        #country-filter-container label {
            display: none !important;
        }
        #countryFilterSelect {
            width: 90px !important;
            font-size: 13px !important;
            padding: 5px 4px !important;
            height: 100% !important;
            box-sizing: border-box !important;
            line-height: 1.8 !important;
        }
        /* select option ê¸€ì”¨ í¬ê¸° */
        #countryFilterSelect option {
            font-size: 16px !important;
            padding: 12px 6px !important;
            line-height: 2 !important;
            background-color: #3e4a56 !important;
            color: #ffffff !important;
        }
        /* ë¯¼ì¡±í•„í„° - ê³ ì • í¬ê¸° */
        #dynastyTimelineFilterPanel {
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            gap: 2px !important;
            height: 26px !important;
            order: 2 !important;
        }
        #ethnicityFilterContainer {
            font-size: 13px !important;
            display: flex !important;
            align-items: center !important;
            gap: 2px !important;
            height: 100% !important;
        }
        /* ë¯¼ì¡±í•„í„° select ìš”ì†Œ - ë†’ì´ ë° ê¸€ì”¨ í¬ê¸° í†µì¼ */
        #ethnicityFilterContainer select {
            font-size: 13px !important;
            padding: 5px 4px !important;
            height: 100% !important;
            box-sizing: border-box !important;
            line-height: 1.8 !important;
        }
        /* ë¯¼ì¡±í•„í„° select option ê¸€ì”¨ í¬ê¸° */
        #ethnicityFilterContainer select option {
            font-size: 20px !important;
            padding: 12px 6px !important;
            line-height: 2 !important;
            background-color: #3e4a56 !important;
            color: #ffffff !important;
        }
        /* ê²€ìƒ‰ ì…ë ¥ ë° ë²„íŠ¼ - ë‚¨ì€ ê³µê°„ ì°¨ì§€í•˜ì§€ ì•Šê³  ê³ ì • í¬ê¸° */
        .right-controls > div:last-child {
            display: flex !important;
            align-items: center !important;
            position: relative !important;
            height: 26px !important;
            gap: 0 !important;
            flex: 0 0 auto !important;
            width: auto !important;
            order: 3 !important;
        }
        #searchInput {
            height: 100% !important;
            padding: 4px 6px !important;
            flex: 0 0 120px !important;
            font-size: 13px !important;
            min-width: 120px !important;
            box-sizing: border-box !important;
        }
        #searchBtn {
            height: 100% !important;
            flex-shrink: 0 !important;
            padding: 4px 10px !important;
            font-size: 13px !important;
            border-radius: 0 4px 4px 0 !important;
            border-left: none !important;
            box-sizing: border-box !important;
        }
        
        /* ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ - ì‹œê°„ ì»¨íŠ¸ë¡¤ ë‚´ë¶€ë¡œ ì´ë™ (ëª¨ë°”ì¼ì—ì„œ ì¤„ë°”ê¿ˆ) */
        #time-controls-map {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            right: 10px !important;
            max-width: calc(100% - 20px) !important;
            flex-wrap: wrap !important;
        }
        
        #time-controls-map > div {
            border-left: none !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
            width: 100% !important;
            margin-top: 8px !important;
            padding-top: 8px !important;
            border-top: 1px solid rgba(255,255,255,0.2) !important;
        }
        
        .layer-toggle-btn {
            flex: 0 0 calc(25% - 4px) !important;
            font-size: 10px !important;
            padding: 3px 2px !important;
            margin: 2px !important;
        }
        #country-filter-container {
            flex: 0 0 auto !important;
            min-width: 85px !important;
            margin: 0 !important;
        }
        #country-filter-container label {
            display: none !important;
        }
        #countryFilterSelect {
            width: 85px !important;
            font-size: 11px !important;
            padding: 3px !important;
        }
        #dynastyTimelineFilterPanel {
            flex: 0 0 auto !important;
            min-width: auto !important;
            order: 2;
            margin: 0 !important;
        }
        #dynastyTimelineFilterPanel > div {
            display: flex !important;
            flex-direction: row !important;
            gap: 2px !important;
            font-size: 11px !important;
        }
        /* ê²€ìƒ‰ ë°•ìŠ¤ - ë‚¨ì€ ê³µê°„ ì‚¬ìš© */
        .right-controls > div:last-child {
            flex: 1 1 auto !important;
            min-width: 100px !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            position: relative !important;
        }
        #searchInput {
            width: 100% !important;
            font-size: 11px !important;
            padding: 4px !important;
        }
        #searchBtn {
            padding: 4px 6px !important;
            font-size: 11px !important;
            flex-shrink: 0 !important;
        }
        
        /* 4ì¤„: ìŠ¬ë¼ì´ë”ì™€ ì—°ëŒ€í‘œ */
        #timeline-slider-wrapper {
            position: fixed !important;
            top: 110px !important; /* ì‹œê°„ ì»¨íŠ¸ë¡¤ ì•„ë˜ì— ë°°ì¹˜ */
            left: 10px !important;
            right: 10px !important;
            width: calc(100% - 20px) !important;
            z-index: 499 !important;
        }
        
        #timeline-container {
            height: 35px !important;
        }
        
        #timeline-fade-left,
        #timeline-fade-right {
            width: 80px !important;
        }
        
        /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #controls-wrapper .layer-toggle-btn {
            font-size: 11px !important;
            padding: 4px 2px !important;
        }
        /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ í¸ì§‘ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ ì¡°ì • */
        #edit-dropdown-menu {
            min-width: 150px; /* ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ ë„ˆë¹„ í™•ë³´ */
        }
        
        /* ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ë¶€ ì»¨íŠ¸ë¡¤ë“¤ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        #time-controls-map {
            position: fixed !important;
            top: 55px !important;
            left: 10px !important;
            right: 10px !important;
            width: auto !important;
            max-width: calc(100vw - 90px) !important;
            z-index: 500 !important;
            flex-wrap: wrap !important;
            padding: 6px !important;
        }
        
        #time-controls-map #timeLabelDisplay {
            font-size: 10px !important;
            min-width: 160px !important;
        }
        
        #time-controls-map #yearLabel {
            display: inline-block !important;
            min-width: 60px !important;
            text-align: right !important;
        }
        
        #time-controls-map #monthLabel {
            display: inline-block !important;
            min-width: 18px !important;
            text-align: right !important;
        }
        
        #time-controls-map #ganjiLabel {
            display: inline-block !important;
            min-width: 35px !important;
        }
        
        #time-controls-map #yearInput {
            width: 55px !important;
            min-height: 32px !important;
            font-size: 13px !important;
            padding: 4px !important;
        }
        
        #time-controls-map #monthInput {
            width: 38px !important;
            min-height: 32px !important;
            font-size: 13px !important;
            padding: 4px !important;
        }
        
        #time-controls-map .time-control-btn,
        #time-controls-map #playBtn,
        #time-controls-map #pauseBtn {
            min-height: 28px !important;
            font-size: 11px !important;
            padding: 3px 6px !important;
        }
        
        #time-controls-map input[type="range"] {
            min-height: 32px !important;
        }
        
        #time-controls-map label,
        #time-controls-map #speedDisplay {
            font-size: 11px !important;
        }
        
        #layer-toggles {
            width: 100% !important;
            margin-top: 8px !important;
            flex-wrap: wrap !important;
        }
        
        #layer-toggles .layer-toggle-btn {
            flex: 0 0 calc(33.333% - 6px) !important;
            min-height: 26px !important;
            font-size: 9px !important;
            padding: 3px 4px !important;
            margin: 2px !important;
        }
        
        #edit-controls {
            position: fixed !important;
            top: 55px !important;
            right: 10px !important;
            z-index: 500 !important;
        }
        
        #edit-controls button {
            min-height: 32px !important;
            padding: 6px 10px !important;
            font-size: 12px !important;
        }
        
        #map-search-filter {
            position: fixed !important;
            bottom: 10px !important;
            left: 10px !important;
            right: 10px !important;
            transform: none !important;
            width: auto !important;
            padding: 6px 8px !important;
            flex-wrap: wrap !important;
            gap: 6px !important;
            z-index: 1000 !important;
        }
        
        #map-search-filter select,
        #map-search-filter input,
        #map-search-filter button {
            font-size: 10px !important;
            padding: 3px 5px !important;
            min-height: 28px !important;
        }
        
        /* ëª¨ë“  í¸ì§‘ í¼ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        #castleForm, #historyForm, #editForm, #battleForm,
        #cityForm, #labelForm, #naturalForm, #armyForm, #eventForm, #editBattleForm {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 90vw !important;
            max-width: 500px !important;
            max-height: 85vh !important;
            overflow-y: auto !important;
            z-index: 10000 !important;
            padding: 15px !important;
        }
        
        #castleForm input, #historyForm input, #editForm input, #battleForm input,
        #cityForm input, #labelForm input, #naturalForm input, #armyForm input,
        #eventForm input, #editBattleForm input,
        #castleForm select, #historyForm select, #editForm select, #battleForm select,
        #cityForm select, #labelForm select, #naturalForm select, #armyForm select,
        #eventForm select, #editBattleForm select,
        #castleForm textarea, #historyForm textarea, #editForm textarea, #battleForm textarea,
        #cityForm textarea, #labelForm textarea, #naturalForm textarea, #armyForm textarea,
        #eventForm textarea, #editBattleForm textarea {
            min-height: 44px !important;
            font-size: 14px !important;
            padding: 10px !important;
            margin-bottom: 8px !important;
        }
        
        #castleForm button, #historyForm button, #editForm button, #battleForm button,
        #cityForm button, #labelForm button, #naturalForm button, #armyForm button,
        #eventForm button, #editBattleForm button {
            min-height: 44px !important;
            font-size: 14px !important;
            padding: 10px !important;
            margin: 5px !important;
        }
    }

    /* ğŸš© [ì¶”ê°€] í¸ì§‘ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        #edit-dropdown-menu {
                display: none;
                position: absolute;
                right: 0;
                top: 100%;
                background-color: #2c3e50;
                border: 1px solid #5d7185;
                border-radius: 4px;
                z-index: 1010;
                min-width: 120px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                max-height: 60vh;
                overflow-y: auto;
        }
        /* (max-width: 967px) ë¯¸ë””ì–´ ì¿¼ë¦¬ ë‚´ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ì€ force-mobileì™€ ë™ì¼í•˜ê²Œ ë§ì¶”ê±°ë‚˜ ì‚­ì œ */
    #edit-dropdown-menu.show {
        display: block;
    }
    /* ğŸš© [ì¶”ê°€] ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
    .dropdown-item {
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: none;
        background: none;
    }
    .dropdown-item.danger {
        color: #ff7675;
        font-weight: 600;
    }
    .dropdown-item.danger:hover {
        background-color: #c0392b;
        color: #fff;
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] íŒì—… ìŠ¤íƒ€ì¼ -->
  <style>
    .leaflet-popup-content-wrapper {
        background-image: url('https://img.freepik.com/free-photo/vintage-grungy-textured-paper-background_53876-103932.jpg?semt=ais_hybrid&w=740&q=80');
        background-size: cover;
        background-repeat: no-repeat;
        color: #333; /* ì–´ë‘ìš´ ê¸€ììƒ‰ìœ¼ë¡œ ê°€ë…ì„± í™•ë³´ */
        border-radius: 5px;
        box-shadow: 0 3px 14px rgba(0,0,0,0.4);
    }
    .leaflet-popup-content {
        font-family: 'Noto Serif KR', serif; /* íŒì—… í°íŠ¸ ë³€ê²½ */
        margin: 13px 19px;
        line-height: 1.5;
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ë³€ê²½ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ -->
  <style>
    .leaflet-control-layers-selector {
        display: flex;
        flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
        gap: 4px;
        background-color: rgba(30, 42, 56, 0.95);
        padding: 4px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .leaflet-control-layers-selector button {
        padding: 2px 8px;
        font-size: 13px;
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° íˆ´ë°” ìœ„ì¹˜ ì¡°ì • -->
  <style>
    .leaflet-center.leaflet-left .leaflet-draw {
        position: absolute;
        top: 100%;
        transform: translateY(-50%);
        margin-top: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] í—¤ë” ì»¨í…Œì´ë„ˆ ë° ë¡œê·¸ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ -->
  <style>
    /* ğŸš© [ìˆ˜ì •] ìµœìƒë‹¨ ë°” (ë¡œê·¸ì¸ ì •ë³´ ë“±) ìŠ¤íƒ€ì¼ */
    #top-bar-container {
        display: flex;
        justify-content: space-between;
        align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        padding: 5px 20px; /* ìƒí•˜ íŒ¨ë”© ì¶•ì†Œ */
        width: 100%;
        box-sizing: border-box;
    }
    /* ğŸš© [ìˆ˜ì •] ì œëª© ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #title-container {
        text-align: center;
        padding: 0 20px 10px; /* ì œëª© ì•„ë˜ì—ë§Œ íŒ¨ë”© ì ìš© */
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #top-right-auth {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
    }
    #top-left-icons {
        display: flex; /* ì•„ì´ì½˜ë“¤ì„ ê°€ë¡œë¡œ ë‚˜ì—´ */
        gap: 5px;     /* ì•„ì´ì½˜ ì‚¬ì´ì˜ ê°„ê²© */
        flex-shrink: 0;
    }
    @media (min-width: 968px) {
        #top-left-icons {
            display: flex !important;
        }
    }
    @media (max-width: 967px) {
        #top-left-icons {
            display: none !important;
        }
    }
    /* ğŸš© [ìˆ˜ì •] ì œëª© ìŠ¤íƒ€ì¼ ì¡°ì • */
    #title-container h1 {
        margin: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
        display: inline-block;
    }

    /* ğŸš© [ìˆ˜ì •] ì»¨íŠ¸ë¡¤ íŒ¨ë„ ì „ì²´ ê¸€ê¼´ í†µì¼ */
    #controls-wrapper {
        font-family: Arial, sans-serif;
        font-weight: 700;
    }

    /* ğŸš© [ì¶”ê°€] í•œì ì œëª©ì„ ìœ„í•œ ë¶“ê¸€ì”¨ í°íŠ¸ ìŠ¤íƒ€ì¼ */
    .hanja-title {
        font-family: 'Yeon Sung', cursive;
        font-weight: 400;
        font-size: 0.9em; /* í•œê¸€ê³¼ì˜ ì¡°í™”ë¥¼ ìœ„í•´ í¬ê¸° ë¯¸ì„¸ ì¡°ì • */
    }
  </style>
  <!-- ğŸš© [í•µì‹¬ ìˆ˜ì •] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ì„ ë³„ë„ì˜ <style> íƒœê·¸ë¡œ ë¶„ë¦¬í•˜ì—¬ CSS ì¶©ëŒ í•´ê²° -->
  <style> 
    #event-overlay {
        position: absolute;
        top: 50%;
        left: 50%; /* ğŸš© [ìˆ˜ì •] leftColumn ë‚´ë¶€ì—ì„œ ì¤‘ì•™ ì •ë ¬ */
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 1);
        color: #e5ff00;
        padding: 20px 40px;
        border-radius: 12px; /* ğŸš© [ìˆ˜ì •] z-indexë¥¼ ë§¤ìš° ë†’ê²Œ ì„¤ì •í•˜ì—¬ ëª¨ë“  ìš”ì†Œ ìœ„ì— ì˜¤ë„ë¡ í•¨ */
        z-index: 9999;
        font-size: 2.5em;
        /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ í‘œì‹œí•˜ê¸° ìœ„í•´ flexbox ì‚¬ìš© */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;

        font-weight: bold;
        text-shadow: 2px 2px 5px #000;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none; /* ì˜¤ë²„ë ˆì´ê°€ ì§€ë„ í´ë¦­ì„ ë§‰ì§€ ì•Šë„ë¡ ì„¤ì • */
        white-space: nowrap;
        border: 0px solid rgba(255, 255, 255, 0.5);
    }
    #event-overlay.visible { opacity: 1; }
    /* ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    #event-overlay-image {
        max-width: 40vw;
        max-height: 25vh;
        border-radius: 8px;
        object-fit: contain;
    }
    /* ğŸš© [ì¶”ê°€] PC ë²„ì „ ìƒë‹¨ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #pcTopPanelToggleBtn {
        display: none; /* ğŸš© [ìˆ˜ì •] ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¸°ê³ , ëª¨ë°”ì¼ì—ì„œë§Œ í‘œì‹œ */
        /* ğŸš© [ì œê±°] ê°œë³„ ë§ˆì§„ ì œê±°, gapìœ¼ë¡œ í†µì¼ */
        padding: 6px 10px;
        background-color: transparent; /* ë°°ê²½ íˆ¬ëª… */
        font-size: 22px; /* ğŸš© [ìˆ˜ì •] ì•„ì´ì½˜ í¬ê¸° í‚¤ì›€ */
        border: none; /* ğŸš© [ìˆ˜ì •] í…Œë‘ë¦¬ ì œê±° */
        color: #dbdbdb; /* ğŸš© [ì¶”ê°€] ê¸°ë³¸ ì•„ì´ì½˜ ìƒ‰ìƒ */
        color: #00aaff; /* ğŸš© [ìˆ˜ì •] í˜¸ë²„ ë° í™œì„± ìƒíƒœ ìƒ‰ìƒ (ì•„ì´ì½˜ ìƒ‰ìƒ ë³€ê²½) */
    }

    /* ğŸš© [ì¶”ê°€] ìƒë‹¨ íŒ¨ë„ ìˆ¨ê¹€ í´ë˜ìŠ¤ */
    /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ ìˆ¨ê¹€ í´ë˜ìŠ¤ */
    body.right-panel-hidden #rightPanel {
        flex-basis: 0 !important; /* Force to 0 */
        overflow: hidden;
        padding: 0;
        border: none;
    }
    body.right-panel-hidden #resizer {
        display: none;
    }

    /* ğŸš© [ìˆ˜ì •] ì˜¤ë¥¸ìª½ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ PC/íƒœë¸”ë¦¿/ëª¨ë°”ì¼ ëª¨ë‘ ë³´ì´ë„ë¡ */
    @media (min-width: 901px) {
        #rightPanelToggleBtn {
            writing-mode: vertical-rl;
            top: 10px;
            left: -28px;
            right: auto;
            bottom: auto;
            width: auto;
            height: auto;
            border-radius: 5px 0 0 5px;
            font-size: 12px;
            line-height: 1;
            padding: 10px 5px;
            display: block !important;
        }
    }
    @media (max-width: 900px) {
        #rightPanelToggleBtn {
            display: block !important;
        }
    }
    @media (max-width: 967px) {
        #pcTopPanelToggleBtn { display: block; }
    }
</style>
<body>
  <!-- ğŸš© [ìˆ˜ì •] í—¤ë”ë¥¼ ìµœìƒë‹¨ ë°”ì™€ ì œëª© ì»¨í…Œì´ë„ˆë¡œ ë¶„ë¦¬ -->
  <div id="top-bar-container">
      <div id="top-left-icons">
          <a href="https://www.youtube.com/@booksbogo" target="_blank" rel="noopener noreferrer" title="ì±…ë³´ê³ "><img style="width: 26px; height: 26px; border-radius: 50%;" src="https://yt3.googleusercontent.com/ZiZJsEzG5LkM6UItGT5mrhygyGxYWsj8OmpLYeVnMNAbtD3D7KWtGX3NsjhMMFbMFUyZ-tY-Pg=s160-c-k-c0x00ffffff-no-rj"></a>
          <a href="https://www.youtube.com/@%EC%9D%B4%EC%9A%A9%ED%9B%88%EB%B0%95%EC%82%AC%EC%9D%98%EC%B0%90%EC%82%BC%EA%B5%AD%EC%82%AC" target="_blank" rel="noopener noreferrer" title="ì°ì‚¼êµ­ì‚¬"><img style="width: 26px; height: 26px; border-radius: 50%;" src="https://yt3.googleusercontent.com/adIg0ayz8Thp44XkOP7Wscn4cebPYCNhr2I_ZVuMEGPMdfXRZZTRI-qBiCh68BpHZa_ZmcH9YZ8=s160-c-k-c0x00ffffff-no-rj"></a>
          <a href="https://www.youtube.com/@Ourhistory2023" target="_blank" rel="noopener noreferrer" title="ìš°ë¦¬ì—­ì‚¬"><img style="width: 26px; height: 26px; border-radius: 50%;" src="https://yt3.googleusercontent.com/90aOk5qirQI3Ug5MZGEtOSonAKL3AYWZSeYXnYTtQpC8XDWdbYOEr4D5V5Dy-V_ADN6fdhwV=s160-c-k-c0x00ffffff-no-rj"></a>
        </div>
    <h1 id="main-title" style="font-family: 'Noto Serif KR', serif; margin: 0; display: inline-block; color: #f5e9d2; text-shadow: 2px 2px 4px #000;">ê³ ë ¤ë§Œë¦¬ì§€ë„ <span class="hanja-title">(é«˜éº—è¬é‡Œåœ°åœ–)</span></h1>

        <div id="top-right-auth">

        <span id="usernameDisplay" style="font-weight: bold;"></span>
        <!-- ğŸš© [ì´ë™ë¨] í¸ì§‘ ì»¨íŠ¸ë¡¤ì„ ì§€ë„ ë‚´ë¶€ë¡œ ì´ë™ -->
          
          <!-- ğŸš© [ì´ë™] PCìš© ì»¨íŠ¸ë¡¤ í† ê¸€ ë²„íŠ¼ì„ ì•„ì´ë”” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ -->
          <!-- ëª¨ë°”ì¼ì—ì„œëŠ” í†±ë‹ˆ ë²„íŠ¼ ì œê±° -->
          <button id="pcTopPanelToggleBtn" class="button-style" title="ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°" style="display:none;">âš™ï¸</button>
          <a id="accountLink" href="account.html" class="button-style" style="display: none;">ê³„ì • ê´€ë¦¬</a>
          <a id="adminLink" href="admin.html" class="button-style" style="display: none;">íšŒì› ê´€ë¦¬</a>
          <button id="logoutBtnHeader" class="danger">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
  </div>


  <!-- ğŸš© [ìˆ˜ì •] ì»¨íŠ¸ë¡¤ëŸ¬ë“¤ì„ ë³„ë„ì˜ wrapperë¡œ ë¶„ë¦¬ -->
  <!-- ğŸš© [ìˆ˜ì •] contentContainerë¥¼ mainContainerë¡œ ë³€ê²½í•˜ê³ , leftColumnê³¼ rightPanelì„ í¬í•¨í•˜ë„ë¡ êµ¬ì¡° ë³€ê²½ -->
  <div id="mainContainer">
    <div id="leftColumn" style="flex-basis: 70%; flex-grow: 1; flex-shrink: 1;">
      <div id="map" style="width: 100%; height: 100%; min-height: 0; position: relative;">
        <!-- ğŸš© [ì¶”ê°€] ì‹œê°„ ì»¨íŠ¸ë¡¤ê³¼ ë ˆì´ì–´ í† ê¸€ì„ ì§€ë„ ë‚´ë¶€ ì™¼ìª½ ìƒë‹¨ì— ë°°ì¹˜ -->
        <div id="time-controls-map" class="time-controls" style="position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(30, 42, 56, 0.95); padding: 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 5px; flex-wrap: wrap; max-width: calc(100% - 180px);">
            <span id="timeLabelDisplay" style="white-space: nowrap; text-align: left; font-size: 12px; display: inline-block; min-width: 180px;">
                ì—°ë„: <span id="yearLabel" style="display: inline-block; min-width: 65px; text-align: right;"></span>ë…„ <span id="monthLabel" style="display: inline-block; min-width: 20px; text-align: right;"></span>ì›” <span id="ganjiLabel" style="display: inline-block; min-width: 40px;"></span>
            </span>
            <input type="number" id="yearInput" min="-2333" max="2030" step="1" value="400" style="width:60px !important; padding: 4px;">
            <input type="number" id="monthInput" min="1" max="12" step="1" value="1" style="width:40px !important; padding: 4px;">
            <div class="playback-button-container">
                <button id="playBtn" class="primary" style="padding: 3px 6px; font-size: 11px;">ì¬ìƒ</button>
                <button id="pauseBtn" class="danger" style="display: none; padding: 3px 6px; font-size: 11px;">ì •ì§€</button>
            </div>
            <label for="playbackSpeedSlider" style="font-weight: normal; font-size: 12px;">ì†ë„:</label>
            <input type="range" id="playbackSpeedSlider" min="1" max="60" value="12" style="width: 60px; vertical-align: middle;">
            <span id="speedDisplay" style="vertical-align: middle; font-size: 12px;">12ì›”/ì´ˆ</span>
            
            <!-- ğŸš© [ì¶”ê°€] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ì„ ì‹œê°„ ì»¨íŠ¸ë¡¤ ì˜†ì— ë°°ì¹˜ -->
            <div id="layer-toggles" style="display: flex; align-items: center; gap: 2px; margin-left: 8px; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 8px;">
                <button type="button" class="layer-toggle-btn active" data-layer="city" style="padding: 2px 4px; font-size: 10px;">ì„±ë„ì‹œ</button>
                <button type="button" class="layer-toggle-btn active" data-layer="label" style="padding: 2px 4px; font-size: 10px;">ì§€ëª…</button>
                <button type="button" class="layer-toggle-btn active" data-layer="military" style="padding: 2px 4px; font-size: 10px;">êµ°ëŒ€</button>
                <button type="button" class="layer-toggle-btn active" data-layer="natural" style="padding: 2px 4px; font-size: 10px;">ìì—°</button>
                <button type="button" class="layer-toggle-btn active" data-layer="event" style="padding: 2px 4px; font-size: 10px;">ì´ë²¤íŠ¸</button>
                <button type="button" class="layer-toggle-btn" data-layer="territory" style="padding: 2px 4px; font-size: 10px;">ê°•ì—­</button>
                <button type="button" class="layer-toggle-btn active" data-layer="timeline" style="padding: 2px 4px; font-size: 10px;">ì—°ëŒ€í‘œ</button>
            </div>
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë”ì™€ ì—°ëŒ€í‘œë¥¼ ì§€ë„ ë‚´ë¶€ì— ë°°ì¹˜ -->
        <div id="timeline-slider-wrapper" style="position: absolute; top: 60px; left: 10px; right: 10px; z-index: 999; pointer-events: none;">
            <input type="range" id="combinedSlider" min="-28008" max="24359" step="1" value="4800" style="width: 100%; pointer-events: auto; margin-bottom: 5px;">
            <div id="timeline-container" style="position: relative; height: 45px; overflow-x: hidden; overflow-y: visible; pointer-events: auto; cursor: grab;">
                <div id="timeline-fade-left" style="position: absolute; left: 0; top: 0; bottom: 0; width: 150px; z-index: 10; pointer-events: none;"></div>
                <div id="timeline-content" style="position: relative; transition: transform 0.3s ease;"></div>
                <div id="timeline-fade-right" style="position: absolute; right: 0; top: 0; bottom: 0; width: 150px; z-index: 10; pointer-events: none;"></div>
                <!-- ğŸš© [ì¶”ê°€] ì¤‘ì•™ í˜„ì¬ ì‹œì  ì¸ë””ì¼€ì´í„° -->
                <div id="timeline-center-indicator" style="position: absolute; left: 50%; top: 0; bottom: 0; width: 3px; background: rgba(255, 200, 0, 0.8); transform: translateX(-50%); z-index: 11; pointer-events: none; box-shadow: 0 0 10px rgba(255, 200, 0, 0.6);"></div>
            </div>
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] í¸ì§‘ ì»¨íŠ¸ë¡¤ì„ ì§€ë„ ë‚´ë¶€ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ë°°ì¹˜ -->
        <div id="edit-controls" style="position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
            <div id="edit-dropdown-container" style="position: relative; display: none;">
                <button id="mainEditBtn" class="primary" style="padding: 6px 12px; white-space: nowrap; font-size: 13px; background: rgba(30, 42, 56, 0.95); border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">í¸ì§‘ â–¾</button>
                <div id="edit-dropdown-menu">
                    <button id="cityEditBtnDropdown" class="dropdown-item">ì„±/ë„ì‹œ í¸ì§‘</button>
                    <button id="countryEditBtnDropdown" class="dropdown-item">êµ­ê°€ í¸ì§‘</button>
                    <button id="kingEditBtnDropdown" class="dropdown-item">ì™• í¸ì§‘</button>
                    <button id="eventEditBtnDropdown" class="dropdown-item">ì´ë²¤íŠ¸ í¸ì§‘</button>
                    <button id="exitEditBtnDropdown" class="dropdown-item danger">í¸ì§‘ëª¨ë“œ ì¢…ë£Œ</button>
                </div>
            </div>
            <!-- ğŸš© [ì´ë™] ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ë³€ê²½ ì»¨íŠ¸ë¡¤ -->
            <div id="tile-layer-control" class="leaflet-control-layers-selector">
                <button id="satellite-tile-btn" class="active">ìœ„ì„±</button>
                <button id="normal-tile-btn">ì¼ë°˜</button>
            </div>
        </div>
        
        <!-- ğŸš© [ìˆ˜ì •] ì™• ëª©ë¡ íˆ¬ëª… ë°•ìŠ¤ (ì§€ë„ ì™¼ìª½ í•˜ë‹¨, í™•ëŒ€ì¶•ì†Œ ë²„íŠ¼ ìœ„) -->
        <div id="map-king-panel" style="position: absolute; bottom: 80px; left: 10px; width: 370px; max-height: 30vh; z-index: 998; background: rgba(30, 42, 56, 0.40); backdrop-filter: blur(3px); padding: 12px; border-radius: 8px; box-shadow: 1 2px 8px rgba(0,0,0,0.3); overflow-y: auto; pointer-events: auto;">
            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #f5e9d2; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 8px;">êµ­ê°€ë³„ ì™• ëª©ë¡</h3>
            <div id="map-king-list" style="font-size: 12px; line-height: 1.6; color: #ddd;">
                í•´ë‹¹ ì—°ë„ ì™• ì •ë³´ ì—†ìŒ
            </div>
        </div>
        
        <!-- ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ íˆ¬ëª… ë°•ìŠ¤ (ì§€ë„ ì˜¤ë¥¸ìª½, ì—°ëŒ€í‘œ ì•„ë˜ê¹Œì§€) -->
        <div id="map-history-panel" style="position: absolute; top: 180px; bottom: 50px; right: 10px; width: 320px; z-index: 1000; background: rgba(30, 42, 56, 0.60); backdrop-filter: blur(5px); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); overflow-y: auto; pointer-events: auto;">
            <!-- ğŸš© [ì¶”ê°€] í¬ê¸° ì¡°ì ˆ í•¸ë“¤ (ì™¼ìª½ ê°€ì¥ìë¦¬) -->
            <div id="map-history-resizer" style="position: absolute; left: 0; top: 0; bottom: 0; width: 8px; cursor: ew-resize; z-index: 1001; background: rgba(255, 255, 255, 0.1);"></div>
            <!-- ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ì¤„ì— "ì—­ì‚¬ ê¸°ë¡" ì œëª© ì¶”ê°€ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <span style="font-size: 13px; font-weight: bold; color: #f5e9d2;">ì—­ì‚¬ ê¸°ë¡</span>
                <div style="display: flex; gap: 4px; flex-shrink: 0;">
                    <button id="map-open-history-form-btn" class="primary" title="ì—­ì‚¬ ê¸°ë¡ ì¶”ê°€" style="display: none; padding: 2px 8px; font-size: 11px; min-width: 40px;">ì¶”ê°€</button>
                    <button id="map-prev-history-btn" title="ì´ì „ ê¸°ë¡" style="padding: 2px 6px; font-size: 11px; width: 28px; min-width: 28px;">â—€</button>
                    <button id="map-next-history-btn" title="ë‹¤ìŒ ê¸°ë¡" style="padding: 2px 6px; font-size: 11px; width: 28px; min-width: 28px;">â–¶</button>
                    <button id="map-history-toggle-btn" title="íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°" style="padding: 2px 6px; font-size: 11px; width: 28px; min-width: 28px;">â—†</button>
                </div>
            </div>
            <!-- ğŸš© [ì¶”ê°€] ì—°ë„ë³„ ì œëª©ì„ ë³„ë„ ì¤„ë¡œ ë¶„ë¦¬ -->
            <div style="margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 8px;">
                <h3 style="margin: 0; font-size: 13px; color: #f5e9d2; word-wrap: break-word; white-space: normal;"><span id="map-history-year-title"></span></h3>
            </div>
            <div id="map-history-records" style="font-size: 12px; line-height: 1.5; color: #ddd;">
                <div id="map-all-records">
                    <div id="map-all-records-content">ê¸°ë¡ ì—†ìŒ</div>
                </div>
            </div>
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] ê³ ëŒ€ ì§€ë„ ë§í¬ ë²„íŠ¼ë“¤ (ì§€ë„ í•˜ë‹¨ ì˜¤ë¥¸ìª½) -->
        <div id="ancient-map-button-container" style="position: absolute; bottom: 10px; right: 10px; z-index: 997; display: flex; gap: 4px; pointer-events: auto;">
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] ê²€ìƒ‰ ë° í•„í„°ë¥¼ ì§€ë„ ë‚´ë¶€ í•˜ë‹¨ì— ë°°ì¹˜ -->
        <div id="map-search-filter" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(30, 42, 56, 0.95); padding: 8px 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center;">
            <!-- êµ­ê°€ í•„í„° -->
            <div style="display: flex; align-items: center; gap: 4px;">
                <label for="mapCountryFilter" style="font-size: 11px; white-space: nowrap; margin: 0;">êµ­ê°€:</label>
                <select id="mapCountryFilter" style="padding: 4px 6px; border-radius: 4px; border: 1px solid #5d7185; font-size: 11px; min-width: 100px;">
                    <option value="all">-- ì „ì²´ --</option>
                </select>
            </div>
            
            <!-- ë¯¼ì¡± í•„í„° -->
            <div style="display: flex; align-items: center; gap: 4px;">
                <label for="mapEthnicityFilterSelect" style="font-size: 11px; white-space: nowrap; margin: 0;">ë¯¼ì¡±:</label>
                <div id="mapEthnicityContainer" style="display: flex; align-items: center; gap: 2px;">
                </div>
            </div>
            
            <!-- ê²€ìƒ‰ -->
            <div style="display: flex; align-items: center; gap: 0; position: relative;">
                <input type="text" id="mapSearchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" autocomplete="off" style="padding: 4px 6px; font-size: 11px; width: 90px; border-radius: 4px 0 0 4px;"/>
                <button id="mapSearchBtn" class="primary" style="padding: 4px 8px; font-size: 11px; border-radius: 0 4px 4px 0; border-left: none;">ê²€ìƒ‰</button>
                <div id="mapSearchResults" style="position: absolute; bottom: 100%; left: 0; right: 0; background: #3e4a56; border: 1px solid #5d7185; z-index: 1001; max-height: 250px; overflow-y: auto; display: none; font-size: 12px; margin-bottom: 4px;">
                </div>
            </div>
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° íˆ´ë°”ë¥¼ ì§€ë„ ì¢Œì¸¡ í•˜ë‹¨ì— ê°€ë¡œë¡œ ë°°ì¹˜ -->
        <div id="drawingForm" style="display:none; position: absolute !important; bottom: 10px !important; left: 10px !important; right: auto !important; top: auto !important;">
            <form id="editDrawingForm">
                <input type="hidden" id="drawingMongoId">
                <input type="hidden" id="drawingGeoJson">
                
                <label for="drawingName">ì´ë¦„:</label>
                <input type="text" id="drawingName" required>
                
                <label for="drawingType">ìœ í˜•:</label>
                <select id="drawingType">
                    <option value="river">ê°•</option>
                    <option value="wall">ì„±ê³½</option>
                    <option value="arrow">í™”ì‚´í‘œ</option>
                    <option value="mountain">ì‚°ë§¥</option>
                </select>
                
                <label for="drawingStartYear">ì‹œì‘:</label>
                <input type="number" id="drawingStartYear" required>
                
                <label for="drawingEndYear">ì¢…ë£Œ:</label>
                <input type="number" id="drawingEndYear" placeholder="ì„ íƒ">
                
                <button type="button" id="cancelDrawingBtn">ì·¨ì†Œ</button>
                <button type="button" id="deleteDrawingBtn" class="danger" style="display:none;">ì‚­ì œ</button>
                <button type="submit" id="saveDrawingBtn" class="primary">ì €ì¥</button>
            </form>
        </div>
        
        <!-- ğŸš© [ìˆ˜ì •] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ë¥¼ map div ì•ˆìœ¼ë¡œ ì´ë™ -->
        <div id="event-overlay">
            <img id="event-overlay-image" src="" style="display: none;">
            <video id="event-overlay-video" controls style="display: none; max-width: 100%; max-height: 300px;"></video>
            <span id="event-overlay-text"></span>
        </div>
      </div> 
    </div>
    <!-- ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ í¬ê¸° ì¡°ì ˆì„ ìœ„í•œ ë¦¬ì‚¬ì´ì € í•¸ë“¤ -->
    <div id="resizer"></div>

  </div> <!-- mainContainer ì¢…ë£Œ -->

    <div id="castleForm" style="display:none;">
        <h3>ìƒˆë¡œìš´ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€/í¸ì§‘</h3> <form id="addCastleForm"><input type="hidden" id="castleKey"><div class="form-row"><label>ë§ˆì»¤ íƒ€ì…:</label><div id="markerTypeSelector" class="marker-type-selector"><button type="button" data-type="normal" class="active">ì„±/ë„ì‹œ</button><button type="button" data-type="battle">ì „ì¥</button><button type="button" data-type="military">êµ°ëŒ€</button><button type="button" data-type="natural">ìì—°</button><button type="button" data-type="label">ì§€ëª…</button></div></div><div class="form-row"><label for="castleName">ì´ë¦„:</label>
        <input type="text" id="castleName" style="width: 280px;" required> 
      </div>
      <div class="form-row" id="labelColorRow" style="display:none;">
    <label for="labelColor">ê¸€ì ìƒ‰ìƒ:</label>
        <input type="color" id="labelColor" value="#FFFFFF" style="height: 30px; padding: 2px;">
      </div>
      <!-- ğŸš© [ì¶”ê°€] ì§€ëª… ê¸€ì í¬ê¸° ì„ íƒ -->
      <div class="form-row" id="labelSizeRow" style="display:none;">
    <label for="labelSize">ê¸€ì í¬ê¸°:</label>
        <select id="labelSize">
            <option value="medium">ì¤‘</option><option value="large">ëŒ€</option><option value="small">ì†Œ</option></select>
      </div>
      <div class="form-row">
        <label>ìœ„ë„/ê²½ë„:</label>
        <div class="input-group">
          <input type="number" id="castleLat" step="any" required placeholder="ìœ„ë„">
          <input type="number" id="castleLng" step="any" required placeholder="ê²½ë„">
        </div>
      </div>
      <!-- ğŸš© [ì¶”ê°€] ì „ì¥, ì§€ëª…, ìì—° íƒ€ì…ì„ ìœ„í•œ ë‹¨ì¼ ê¸°ê°„ ì„¤ì • ì„¹ì…˜ -->
      <div id="simpleDateSection" style="display:none;">
          <div class="form-row">
              <label for="simpleStartYear">ì‹œì‘ ì—°ë„:</label>
              <div class="input-group">
                  <input type="number" id="simpleStartYear" placeholder="ì‹œì‘ ì—°ë„">
                  <input type="number" id="simpleStartMonth" min="1" max="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
              </div>
          </div>
          <div class="form-row">
              <label for="simpleEndYear">ì¢…ë£Œ ì—°ë„:</label>
              <div class="input-group">
                  <input type="number" id="simpleEndYear" placeholder="ì¢…ë£Œ ì—°ë„">
                  <input type="number" id="simpleEndMonth" min="1" max="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
              </div>
          </div>
      </div>
      <div class="form-row">
    <label for="castleDesc">ì„¤ëª…:</label>
        <textarea id="castleDesc" rows="3"></textarea>
      </div>
      <div class="form-row">
    <label for="castlePhoto">ì‚¬ì§„ URL:</label>
        <input type="text" id="castlePhoto" placeholder="ì„ íƒ ì‚¬í•­">
      </div>
      <!-- ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ì„¤ì • ì„¹ì…˜ -->
      <div class="form-row">
    <label for="customIcon">ì»¤ìŠ¤í…€ ì•„ì´ì½˜ URL:</label>
        <input type="text" id="customIcon" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ ì‚¬í•­)">
      </div>
      <div class="form-row">
        <label>ì•„ì´ì½˜ í¬ê¸°:</label>
        <div class="input-group">
          <input type="number" id="iconWidth" placeholder="ë„ˆë¹„ (px)" min="10" max="200" style="width: 120px;">
          <input type="number" id="iconHeight" placeholder="ë†’ì´ (px)" min="10" max="200" style="width: 120px;">
        </div>
      </div>
      <!-- ğŸš© [ìˆ˜ì •] 'ì„±' íƒ€ì… ì „ìš© ì—­ì‚¬ ê¸°ë¡ ê´€ë¦¬ ì„¹ì…˜ -->
      <div id="castleHistorySection" style="border: 1px solid #00aaff; padding: 10px; margin-top: 10px; border-radius: 4px;">
          <h4>ğŸ“œ ì„±/ë„ì‹œ ì—­ì‚¬ ê¸°ë¡</h4>
          <!-- ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ ëª©ë¡ì— ìŠ¤í¬ë¡¤ì„ ì ìš©í•©ë‹ˆë‹¤. -->
          <div id="castleHistoryList" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
              <!-- ì—­ì‚¬ ê¸°ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
          </div>
          <button type="button" id="addCastleHistoryBtn" style="margin-top: 5px;">ì—­ì‚¬ ê¸°ë¡ ì¶”ê°€</button>
      </div>
      <style>
          .history-record-row {
              display: flex; /* ğŸš© [ìˆ˜ì •] flexbox ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
              flex-wrap: nowrap; /* ğŸš© [ì¶”ê°€] í•œ ì¤„ë¡œ í‘œì‹œ */
              align-items: center; /* ğŸš© [ì¶”ê°€] ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
              gap: 5px;
              width: 100%;

              margin-bottom: 10px; /* ğŸš© [ìˆ˜ì •] í–‰ ê°„ ê°„ê²© ì¡°ì • */
              padding-bottom: 10px; /* ğŸš© [ì¶”ê°€] í–‰ ì•„ë˜ì— íŒ¨ë”© ì¶”ê°€ */
              border-bottom: 1px solid #4e5d6c; /* ğŸš© [ì¶”ê°€] í–‰ êµ¬ë¶„ì„  */
          }

          /* ğŸš© [ì¶”ê°€] ê° ì…ë ¥ í•„ë“œë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
          .history-field-container {
              display: flex;
              flex-direction: column;
          }
          .history-field-container label {
              font-size: 11px;
              color: #bdc3c7;
              margin-bottom: 3px;
          }
          /* ğŸš© [ìˆ˜ì •] ê° ì…ë ¥ í•„ë“œì˜ ë„ˆë¹„ë¥¼ flex ì†ì„±ìœ¼ë¡œ ì§€ì • (ë ˆì´ë¸” ì¶”ê°€ì— ë”°ë¥¸ ì¡°ì •) */
          /* ğŸš© [ì¶”ê°€] ìë™ ì™„ì„± ê²°ê³¼ ëª©ë¡ ìŠ¤íƒ€ì¼ */
          .autocomplete-results {
              display: none; position: absolute; top: 100%; left: 0; right: 0; 
              background: #3e4a56; border: 1px solid #5d7185; 
              z-index: 1002; max-height: 150px; overflow-y: auto;
          }
          .autocomplete-item { padding: 8px; cursor: pointer; }
          .autocomplete-item:hover { background-color: #5d7185; }
          .history-field-container.history-name { flex: 1 1 100px; }
          .history-field-container.history-country { flex: 1 1 100px; }
          .history-field-container.history-start-year { flex: 0 1 70px; }
          .history-field-container.history-start-month { flex: 0 1 50px; }
          .history-field-container.history-end-year { flex: 0 1 70px; }
          .history-field-container.history-end-month { flex: 0 1 50px; }
          .history-record-row button { align-self: flex-end; flex-shrink: 0; width: 30px; padding: 5px; margin: 0; background-color: #e74c3c; }
          .history-record-row input[type="checkbox"] { width: auto; margin: 0; }
      </style>
        <style>
            /* ë°˜ì‘í˜•: í™”ë©´ì´ ì¤„ë©´ ê³ ë ¤ë§Œë¦¬ì§€ë„ ì œëª© í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
            #main-title {
                transition: font-size 0.2s;
            }
            @media (max-width: 900px) {
                #main-title { font-size: 1.3em; }
            }
            @media (max-width: 600px) {
                #main-title { font-size: 0.8em; margin: 0 !important; padding: 0 !important; display: none !important; }
            }
            @media (max-width: 500px) {
                #main-title {
                    display: none !important;
                }
            }
        </style>
      

         <hr style="margin: 15px 0;">
      <div class="form-row" id="naturalFeatureDetails">
    <label for="naturalFeatureType">ì§€ë¬¼ ì¢…ë¥˜:</label>
        <select id="naturalFeatureType">
            <option value="mountain">ì‚°/ìˆ²</option>
            <option value="sea">ë°”ë‹¤/í˜¸ìˆ˜</option>
            <option value="river">ê°•/ë‚´ë¥™</option>
            <option value="mudflat">ë»˜/ëŠª</option>
            <option value="horse">ë§</option>
            <option value="buffalo">ë¬¼ì†Œ</option>
            <option value="mongky">ì›ìˆ­ì´</option>
            <option value="camel">ë‚™íƒ€</option>
                                    <option value="hunting">ì‚¬ëƒ¥í„° ğŸ¹</option>
            <option value="construction">ê±´ì„¤ âš’ï¸</option>
        </select>
      </div>
     <div id="militaryFlagDetails" style="border-top: 0px solid #ccc; padding-top: 5px; margin-top: 10px;">
    <div class="form-row">
        <label for="militaryCountryNameInput">ì†Œì† êµ­ê°€:</label>
        <!-- ğŸš© [í•µì‹¬ ìˆ˜ì •] êµ­ê°€ ê²€ìƒ‰ ì…ë ¥ì°½ê³¼ ì„ íƒ ëª©ë¡ì„ ë‚˜ë€íˆ ë°°ì¹˜í•©ë‹ˆë‹¤. -->
        <div style="display: flex; flex-grow: 1; gap: 10px; position: relative;">
            <input type="text" id="militaryCountryNameInput" placeholder="ì†Œì† êµ­ê°€ëª… ì…ë ¥..." autocomplete="off" required style="flex-grow: 1;">
            <div class="autocomplete-results" id="militaryCountryResults"></div>
            <select id="militaryCountrySelect" style="width: 180px; flex-shrink: 0;"></select>
        </div>
        <input type="hidden" id="militaryCountryId" value="">
    </div>
    <div class="form-row">
        <label for="generalName">ì¥ìˆ˜ ì´ë¦„:</label>
        <input type="text" id="generalName" placeholder="ì¥ìˆ˜ ì´ë¦„">
    </div>
    <div class="form-row">
        <label for="troopCount">ë³‘ë ¥ (ëª…):</label>
        <input type="number" id="troopCount" placeholder="ìˆ«ìë§Œ">
    </div>
    <div class="form-row">
        <label for="generalPhoto">ì¥ìˆ˜ ì‚¬ì§„ URL:</label>
        <input type="text" id="generalPhoto" placeholder="ì„ íƒ ì‚¬í•­">
    </div>
</div>
<div id="pathDataSection" style="border: 1px solid #00aaff; padding: 10px; margin-top: 10px; border-radius: 4px;">
                <h4>âš”ï¸ êµ°ëŒ€ ì´ë™ ê²½ë¡œ (Path Data)</h4>
                <div id="pathDataList"></div>
                <button type="button" onclick="addPathPoint()" style="margin-top: 5px;">ê²½ë¡œ ì§€ì  ì¶”ê°€</button>
            </div>

      <br>
      <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
        <!-- ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ìˆœì„œ ë³€ê²½ ë° ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì ìš© -->
        <button type="button" id="cloneCastle" class="primary" style="display:none;">ë³µì œ</button> <!-- ğŸš© [ìˆ˜ì •] ë³µì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì ìš© -->
        <button type="button" id="deleteCastle" class="danger" style="display:none;">ì‚­ì œ</button>
        <button type="button" id="cancelCastle">ì·¨ì†Œ</button>
        <button type="submit" class="primary">ì €ì¥</button> <!-- ğŸš© [ìˆ˜ì •] ID ì¶”ê°€ -->
      </div>
    </form>
  </div>

  <!-- ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± í¸ì§‘ ì„ íƒ í¼ -->
  <div id="editCitySelectionForm" style="display: none; position: absolute; top: 100px; left: calc(50% - 225px); background: #2c3e50; color: #ecf0f1; border: 1px solid #5d7185; padding: 20px; z-index: 1000; border-radius: 8px; width: 450px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); max-width: 90%; min-width: 350px;">
      <h3>í¸ì§‘í•  ë„ì‹œ/ì„± ì„ íƒ</h3>
      <!-- ğŸš© [í•µì‹¬ ìˆ˜ì •] ë„ì‹œ/ì„± ì„ íƒ UIë¥¼ ìë™ ì™„ì„± ê²€ìƒ‰ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ -->
      <div class="form-row" style="margin-bottom: 15px;">
          <label for="citySearchInputForEdit">ë„ì‹œ/ì„±:</label>
          <div style="display: flex; flex-grow: 1; gap: 10px; position: relative;">
              <div style="position: relative; flex-grow: 1;">
                  <input type="text" id="citySearchInputForEdit" placeholder="ë„ì‹œ/ì„± ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." autocomplete="off">
                  <div id="citySearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: #3e4a56; border: 1px solid #5d7185; z-index: 1001; max-height: 150px; overflow-y: auto; display: none;"></div>
              </div>
              <select id="citySelectForEdit" style="width: 180px; flex-shrink: 0;"></select>
          </div>
      </div>
      <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelCitySelectionBtn">ì·¨ì†Œ</button>
          <button type="button" id="editSelectedCityBtn" class="primary">í¸ì§‘</button>
      </div>
  </div>
    <div id="historyForm" style="display:none;">
      <h3>ì‚¬ì„œ ê¸°ë¡ í¸ì§‘/ì¶”ê°€</h3>
      <form id="addHistoryForm">
          <input type="hidden" id="historyKey"> 
          <div class="form-row">
            <label for="historyYear">ì—°ë„:</label>
            <div class="input-group">
              <input type="number" id="historyYear" required>
              <input type="number" id="historyMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
          </div>
          <div class="form-row">
            <label for="historyEvent">ì´ë²¤íŠ¸ëª…:</label>
            <input type="text" id="historyEvent" required>
          </div>
          <div class="form-row">
            <label for="historyPhoto">ì‚¬ì§„ URL:</label>
            <input type="text" id="historyPhoto" placeholder="ì„ íƒ ì‚¬í•­">
          </div>
          <div class="form-row">
            <label for="createEvent">ì´ë²¤íŠ¸ ë°œìƒ:</label>
            <input type="checkbox" id="createEvent" style="width: auto; justify-self: start;">
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**1. ìš°ë¦¬ ì—­ì‚¬ì„œ**</h4>
          <div class="form-row">
            <label for="koreanSource">ì¶œì „:</label>
            <input type="text" id="koreanSource" placeholder="ì˜ˆ: ì‚¼êµ­ì‚¬ê¸°">
          </div>
          <div class="form-row">
            <label for="koreanContent">ë‚´ìš©:</label>
            <textarea id="koreanContent" rows="3"></textarea>
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**2. ì¡êµ­ ì—­ì‚¬ì„œ**</h4>
          <div class="form-row">
            <label for="foreignSource">ì¶œì „:</label>
            <input type="text" id="foreignSource" placeholder="ì˜ˆ: êµ¬ë‹¹ì„œ">
          </div>
          <div class="form-row">
            <label for="foreignContent">ë‚´ìš©:</label>
            <textarea id="foreignContent" rows="3"></textarea>
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**3. ì§„ì§œ ì—­ì‚¬ (ì²œë¬¸/ì§€ë¦¬ ê¸°ë°˜ ì—°êµ¬)**</h4>
          <div class="form-row">
            <label for="trueHistoryContent">ë‚´ìš©:</label>
            <textarea id="trueHistoryContent" rows="3"></textarea>
          </div>
          <div class="form-actions" style="text-align: right; margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" id="cancelHistoryBtn">ì·¨ì†Œ</button>
            <button type="button" id="deleteHistoryBtn" class="danger" style="display: none;">ì‚­ì œ</button>
            <button type="submit" id="saveHistoryBtn" class="primary">ì €ì¥</button>
          </div>
      </form>
  </div>

    <div id="countryForm" style="display:none;">
    <h3>êµ­ê°€ ì •ë³´ í¸ì§‘</h3>
    <!-- ğŸš© [ìˆ˜ì •] êµ­ê°€ ì„ íƒ UIë¥¼ ìë™ ì™„ì„± ê²€ìƒ‰ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ -->
    <div class="form-row" style="margin-bottom: 15px;">
        <label for="countrySelectForEdit">ê¸°ì¡´ êµ­ê°€:</label>
        <div style="display: flex; flex-grow: 1; gap: 10px; position: relative;">
            <input type="text" id="countrySearchForEdit" placeholder="êµ­ê°€ëª… ë˜ëŠ” ë¯¼ì¡±ìœ¼ë¡œ ê²€ìƒ‰..." autocomplete="off" style="flex-grow: 1;">
            <div id="countrySearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: #3e4a56; border: 1px solid #5d7185; z-index: 1001; max-height: 150px; overflow-y: auto; display: none;"></div>
            <select id="countrySelectForEdit" style="width: 180px; flex-shrink: 0;"></select>
        </div>
    </div>
    <form id="editCountryForm">
        <input type="hidden" id="countryOriginalName">
        <div class="form-row">
            <label for="countryName">êµ­ê°€ ì´ë¦„:</label>
            <input type="text" id="countryName" required>
        </div>
        <div class="form-row">
            <label for="countryStart">ì‹œì‘ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="countryStart" required value="-2333">
                <input type="number" id="countryStartMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="countryEnd">ì¢…ë£Œ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="countryEnd">
                <input type="number" id="countryEndMonth" min="1" max="12" value="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="countryColor">ë§ˆì»¤ ìƒ‰ìƒ:</label>
            <input type="color" id="countryColor" value="#ffffff" required style="width: 100%; padding: 0;">
        </div>
        <div class="form-row">
            <label for="countryFlag">í”Œë˜ê·¸ URL:</label>
            <input type="text" id="countryFlag" placeholder="ì„ íƒ ì‚¬í•­">
        </div>
        <div class="form-row">
            <label for="countryEthnicity">ë¯¼ì¡±:</label>
            <input type="text" id="countryEthnicity" placeholder="ì˜ˆ: ê³ êµ¬ë ¤ì¡±">
        </div>
        <div class="form-row">
            <label for="isMainDynasty">ìš°ë¦¬ ë¯¼ì¡±:</label>
            <input type="checkbox" id="isMainDynasty" style="width: auto; justify-self: start;">
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelCountryBtn">ì·¨ì†Œ</button>
          <button type="button" id="deleteCountryBtn" class="danger">ì‚­ì œ</button>
          <button type="submit" id="saveCountryBtn" class="primary">ì €ì¥/ì¶”ê°€</button>
        </div>
    </form>
  </div>
  
    <div id="kingForm" style="display:none;">
    <h3>ì™• ì •ë³´ í¸ì§‘</h3>
    <form id="editKingForm">
        <input type="hidden" id="kingMongoId" name="kingMongoId">
        <input type="hidden" id="kingOriginalKey">
        <input type="hidden" id="kingOriginalIndex">
        <!-- ğŸš© [ìˆ˜ì •] êµ­ê°€ ì„ íƒì„ ìë™ ì™„ì„± ê²€ìƒ‰ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ -->
        <input type="hidden" id="kingCountryId">
        <div class="form-row" style="margin-bottom: 15px;">
            <label for="kingCountryNameInput">êµ­ê°€:</label>
            <!-- ğŸš© [í•µì‹¬ ìˆ˜ì •] êµ­ê°€ ê²€ìƒ‰ ì…ë ¥ì°½ê³¼ ì„ íƒ ëª©ë¡ì„ ë‚˜ë€íˆ ë°°ì¹˜í•©ë‹ˆë‹¤. -->
            <div style="display: flex; flex-grow: 1; gap: 10px; position: relative;">
                <div style="position: relative; flex-grow: 1;">
                    <input type="text" id="kingCountryNameInput" placeholder="êµ­ê°€ëª… ì…ë ¥..." autocomplete="off">
                    <div id="kingCountryResults" style="position: absolute; top: 100%; left: 0; right: 0; background: #3e4a56; border: 1px solid #5d7185; z-index: 1001; max-height: 150px; overflow-y: auto; display: none;"></div>
                </div>
                <select id="kingCountrySelect" style="width: 180px; flex-shrink: 0;"></select>
            </div>
        </div>
        <div class="form-row">
            <label for="kingSelect">ì™• ì„ íƒ/ì¶”ê°€:</label>
            <select id="kingSelect">
                <option value="">ìƒˆ ì™• ì¶”ê°€</option>
            </select>
        </div>
        <div class="form-row">
            <label for="kingName">ì™• ì´ë¦„:</label>
            <input type="text" id="kingName" required>
        </div>
        <div class="form-row">
            <label for="kingStart">ì‹œì‘ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="kingStart" required>
                <input type="number" id="kingStartMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="kingEnd">ì¢…ë£Œ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="kingEnd">
                <input type="number" id="kingEndMonth" min="1" max="12" value="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelKingBtn">ì·¨ì†Œ</button>
          <button type="button" id="deleteKingBtn" class="danger" style="display:none;">ì‚­ì œ</button>
          <button type="submit" id="saveKingBtn" class="primary">ì¶”ê°€</button>
        </div>
    </form>
  </div>

  <!-- ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ í¸ì§‘ í¼ -->
    <div id="eventForm" style="display:none;">
    <h3>ì—°ë„ë³„ ì´ë²¤íŠ¸ í¸ì§‘</h3> <!-- ğŸš© [ìˆ˜ì •] í¼ êµ¬ì¡°ë¥¼ ë‹¤ë¥¸ í¼ê³¼ í†µì¼ -->
    <form id="editEventForm">
        <input type="hidden" id="eventMongoId">
        <div class="form-row" style="margin-bottom: 15px;">
            <label for="eventSelect">ê¸°ì¡´ ì´ë²¤íŠ¸:</label>
            <select id="eventSelect" style="flex-grow: 1;"></select>
        </div>
        <div class="form-row">
            <label for="eventYear">ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="eventYear" required>
                <input type="number" id="eventMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="eventText">ì´ë²¤íŠ¸ ë‚´ìš©:</label>
            <input type="text" id="eventText" required>
        </div>
        <div class="form-row">
            <label for="eventPhoto">ì‚¬ì§„ URL:</label>
            <input type="text" id="eventPhoto" placeholder="ì„ íƒ ì‚¬í•­">
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;"> <!-- ğŸš© [ìˆ˜ì •] form-actions í´ë˜ìŠ¤ ì ìš© -->
            <button type="button" id="cancelEventBtn">ì·¨ì†Œ</button>
            <button type="button" id="deleteEventBtn" class="danger" style="display:none;">ì‚­ì œ</button>
            <button type="submit" id="saveEventBtn" class="primary">ì €ì¥/ì¶”ê°€</button>
        </div>
    </form>
  </div>
  
  <!-- ğŸš© [ì´ë™ë¨] ê·¸ë¦¬ê¸° í¼ì„ ì§€ë„ ë‚´ë¶€ë¡œ ì´ë™ -->

<script>
    
    // ğŸš© [ì¶”ê°€] JWT í† í°ì„ ë””ì½”ë”©í•˜ì—¬ payloadë¥¼ ì–»ëŠ” í•¨ìˆ˜
    function parseJwt(token) {
        try {
            // í† í°ì˜ payload ë¶€ë¶„ì„ ì¶”ì¶œ (ë‘ ë²ˆì§¸ ë¶€ë¶„)
            const base64Url = token.split('.')[1];
            // Base64Urlì„ ì¼ë°˜ Base64ë¡œ ë³€í™˜
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            // Base64 ë””ì½”ë”© í›„ UTF-8 ë¬¸ìì—´ë¡œ ë³€í™˜
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null; // ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
        }
    }
    // ğŸš© [ìˆ˜ì •] localStorage ë˜ëŠ” sessionStorageì—ì„œ í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
    }


    // ----------------------------------------------------
    // âš™ï¸ ì„¤ì •
    // ----------------------------------------------------
    // ğŸš© [ìˆ˜ì •] ê³ ëŒ€ ì§€ë„ ì •ë³´ë¥¼ ë°°ì—´ë¡œ ê´€ë¦¬
    const ancientMaps = [
        {
            id: 'daecheongBtn', 
            name: 'ëŒ€ì²­ê´‘ì—¬ë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/1.%20%E1%84%83%E1%85%A2%E1%84%8E%E1%85%A5%E1%86%BC%E1%84%80%E1%85%AA%E1%86%BC%E1%84%8B%E1%85%A7%E1%84%83%E1%85%A9.JPG?raw=true' 
        },
        { 
            id: 'cheonhaBtn', 
            name: 'ì²œí•˜ê³ ê¸ˆëŒ€ì´í¸ëŒë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/3%20%E1%84%8E%E1%85%A5%E1%86%AB%E1%84%92%E1%85%A1%E1%84%80%E1%85%A9%E1%84%80%E1%85%B3%E1%86%B7%E1%84%83%E1%85%A2%E1%84%8E%E1%85%A9%E1%86%BC%E1%84%91%E1%85%A7%E1%86%AB%E1%84%85%E1%85%A1%E1%86%B7%E1%84%83%E1%85%A9%20%E1%84%92%E1%85%A1%E1%86%AB%E1%84%80%E1%85%B3%E1%86%AF%E1%84%91%E1%85%A1%E1%86%AB(%E1%84%8E%E1%85%A2%E1%86%A8%E1%84%87%E1%85%A9%E1%84%80%E1%85%A9%E1%84%87%E1%85%A5%E1%86%AB%E1%84%8B%E1%85%A7%E1%86%A8).JPG?raw=true' 
        },
        {   id: 'honilBtn', 
            name: 'í˜¼ì¼ê°•ë¦¬ì—­ëŒ€êµ­ë„ì§€ë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/4%20%E1%84%87%E1%85%A9%E1%84%80%E1%85%B3%E1%86%B8%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%92%E1%85%A9%E1%86%AB%E1%84%8B%E1%85%B5%E1%86%AF%E1%84%80%E1%85%A1%E1%86%BC%E1%84%85%E1%85%B5%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%83%E1%85%A2%E1%84%80%E1%85%AE%E1%86%A8%E1%84%83%E1%85%A9%E1%84%8C%E1%85%B5%E1%84%83%E1%85%A9%20(%E1%84%8E%E1%85%A2%E1%86%A8%E1%84%87%E1%85%A9%E1%84%80%E1%85%A9%20%E1%84%92%E1%85%A1%E1%86%AB%E1%84%80%E1%85%B3%E1%86%AF%E1%84%87%E1%85%A5%E1%86%AB%E1%84%8B%E1%85%A7%E1%86%A8).JPG?raw=true' 
        },
        {   id: 'woojukdoBtn', 
            name: 'ìš°ì ë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/2%20%E1%84%8B%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%A8%E1%84%83%E1%85%A9%20%E1%84%8E%E1%85%A2%E1%86%A8%E1%84%87%E1%85%A9%E1%84%80%E1%85%A9%20%E1%84%92%E1%85%A1%E1%86%AB%E1%84%80%E1%85%B3%E1%86%AF%E1%84%91%E1%85%A1%E1%86%AB.JPG?raw=true' 
        }
    ];

    const API_BASE_URL = '/api'; // ğŸ’¡ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½
    let isLoggedIn = true; // ì´ í˜ì´ì§€ëŠ” í•­ìƒ ë¡œê·¸ì¸ëœ ìƒíƒœì…ë‹ˆë‹¤.
    // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
    let countries = [];
    let currentUser = null; // ğŸš© [ì¶”ê°€] í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì €ì¥
    let countryColors = {};
    let castles = [];
    let history = [];
    let kings = {}; // { countryKey: [ {name, start, end}, ... ] }
    let events = []; // ğŸš© [ì¶”ê°€] ì—°ë„ë³„ ì´ë²¤íŠ¸ ë°ì´í„° ì €ì¥ì†Œ
    let historyEventTimes = []; // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ì˜ ì—°/ì›” ëª©ë¡
    let historyYears = []; // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ì´ ìˆëŠ” ì—°ë„ ëª©ë¡
    let drawings = []; // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ë°ì´í„° ì €ì¥ì†Œ
    let markers = [];
    let heatmapLayers = {}; // êµ­ê°€ë³„ íˆíŠ¸ë§µ ë ˆì´ì–´ ì €ì¥ 
    let heatmapSourceDebug = {}; // ğŸš© [ì¶”ê°€] ê°•ì—­ íˆíŠ¸ë§µ ì›ë³¸ ë°ì´í„°ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ ë””ë²„ê·¸ ë§µ
    let phantomDebugLayerGroup = null; // ğŸš© [ì¶”ê°€] ìœ ë ¹ ê°•ì—­ í•˜ì´ë¼ì´íŠ¸ìš© ë ˆì´ì–´ ê·¸ë£¹

    function getCastleDebugKey(castle) {
        if (!castle) return 'unknown';
        if (castle._id) return `id:${castle._id}`;
        const latPart = typeof castle.lat === 'number' ? castle.lat.toFixed(4) : 'lat?';
        const lngPart = typeof castle.lng === 'number' ? castle.lng.toFixed(4) : 'lng?';
        return `${castle.name || 'unknown'}@${latPart},${lngPart}`;
    }

    function getCastleLayerType(castle) {
        if (!castle) return 'city';
        if (castle.is_label) return 'label';
        if (castle.is_natural_feature) return 'natural';
        if (castle.is_battle) return 'battle';
        if (castle.is_military_flag) return 'military';
        return 'city';
    }

    function computeCountryActiveState(countryInfo, currentMonths) {
        if (!countryInfo) return false;
        const startYear = countryInfo.start ?? -4000;
        const startMonth = countryInfo.start_month ?? 1;
        const endYear = (countryInfo.end === undefined || countryInfo.end === null) ? null : countryInfo.end;
        const endMonth = (countryInfo.end_month === undefined || countryInfo.end_month === null) ? 12 : countryInfo.end_month;
        const startTotal = yearMonthToTotalMonths(startYear, startMonth);
        const endTotal = endYear === null ? Infinity : yearMonthToTotalMonths(endYear, endMonth);
        return startTotal <= currentMonths && currentMonths <= endTotal;
    }

    function getPhantomReason(entry) {
        if (!entry) return 'ì •ë³´ ì—†ìŒ';
        if (!entry.matchesSelectedCountry) return 'êµ­ê°€ í•„í„°ì—ì„œ ì œì™¸ë¨';
        if (!entry.layerVisible) return `ë ˆì´ì–´ "${entry.castleType}" ë¹„í™œì„±í™”`; 
        if ((entry.castleType === 'city' || entry.castleType === 'label') && !entry.countryActive) {
            return 'êµ­ê°€ ì¡´ì† ê¸°ê°„ ë°– (í‘œì‹œ ì•ˆ ë¨)';
        }
        if (entry.countryInfoMissing) return 'êµ­ê°€ ë°ì´í„° ëˆ„ë½';
        if (entry.castleType === 'military') return entry.hasPathData ? 'êµ°ëŒ€ ê²½ë¡œ ë²”ìœ„ í™•ì¸ í•„ìš”' : 'êµ°ëŒ€ ë ˆì´ì–´ í‘œì‹œ ì¡°ê±´ í™•ì¸';
        return 'ì¶”ê°€ í™•ì¸ í•„ìš”';
    }

    // UI ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ (isLoggedIn ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸°í™”)
    let editMode = false;
    // ğŸš© [ìˆ˜ì •] ë¡œê·¸ì¸ í›„ í•­ìƒ ì¼ë°˜ ë·° ëª¨ë“œë¡œ ì‹œì‘ (í¸ì§‘ëª¨ë“œ ìë™ ë³µì› ì œê±°)
    // localStorageì˜ editModeëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    let editingCastleKey = null;
    let editingHistoryKey = null;
    let editMarker = null; // ë“œë˜ê·¸ ê°€ëŠ¥í•œ í¸ì§‘ìš© ë§ˆì»¤
    let mouseOutTimer = null; // íŒì—… ë‹«ê¸° ì§€ì—° íƒ€ì´ë¨¸
    let eventDisplayTimeout = null; // ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ì‚¬ë¼ì§ íƒ€ì´ë¨¸
    let lastCheckedEventTime = { year: null, month: null }; // ğŸš© [ìˆ˜ì •] ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•œ ì—°/ì›”ì„ ì¶”ì 
    let activePopupMarker = null; // í˜„ì¬ íŒì—…ì´ ì—´ë¦° ë§ˆì»¤ë¥¼ ì¶”ì 
    
    // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ê´€ë ¨ ë³€ìˆ˜
    let drawnItems = new L.FeatureGroup();
    let drawControl;
    let isDrawing = false; // ğŸš© [ì¶”ê°€] í˜„ì¬ ë„í˜•ì„ ê·¸ë¦¬ê³  ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” ìƒíƒœ ë³€ìˆ˜
    
    // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ ìƒíƒœ ì €ì¥ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
    let lastSearchQuery = '';
    let lastSearchResults = [];
    let lastSearchIndex = -1;

    // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„° ìƒíƒœ
    let selectedCountryId = 'all';
    // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„° ìƒíƒœ
    let selectedEthnicity = 'all';

    // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ê°€ì‹œì„± ìƒíƒœ
    let layerVisibility = {
        city: true,       // ì„±/ë„ì‹œ
        label: true,      // ì§€ëª…
        military: true,   // êµ°ëŒ€
        battle: true,     // ì „ì¥ (ë…ë¦½ ë§ˆì»¤)
        natural: true,    // ìì—°
        territory: false,
        event: true,      // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ë ˆì´ì–´ ê°€ì‹œì„±
        timeline: true    // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ê°€ì‹œì„±
    };
    // ğŸš© [ìˆ˜ì •] battle ë ˆì´ì–´: ë…ë¦½ ì „ì¥ ë§ˆì»¤(is_battle=true) + ì—­ì‚¬ ë ˆì½”ë“œ ì „ì¥(history[].is_battle=true) ë‘˜ ë‹¤ ì§€ì›

    // --- 2. DOM ìš”ì†Œ ë§µí•‘ ---
    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ëª¨ë°”ì¼ ë·°ì¼ ë•Œ ê¸°ë³¸ ì¤Œ ë ˆë²¨ì„ ë‹¤ë¥´ê²Œ ì„¤ì •í•©ë‹ˆë‹¤.
    const isMobileOnLoad = window.innerWidth <= 967;
    const map = L.map('map', {
        center: [36, 120],
        zoom: isMobileOnLoad ? 5 : 6, // ëª¨ë°”ì¼ì´ë©´ 5, ë°ìŠ¤í¬í†±ì´ë©´ 6
        minZoom: 4, // ì§€ë„ë¥¼ ë„ˆë¬´ ì‘ê²Œ ì¶•ì†Œí•˜ëŠ” ê²ƒì„ ë°©ì§€
        worldCopyJump: true, // ğŸš© [ì¶”ê°€] ì§€ë„ ì¢Œìš° ë¡¤ë§(ì—°ì† ìŠ¤í¬ë¡¤) ê¸°ëŠ¥ í™œì„±í™”
        attributionControl: false, // ğŸš© [ì¶”ê°€] leaflet attribution(ë§í¬) ìˆ¨ê¹€
        zoomControl: false // ğŸš© [ì¶”ê°€] ê¸°ë³¸ ì¤Œ ì»¨íŠ¸ë¡¤ ë¹„í™œì„±í™” (ìˆ˜ë™ìœ¼ë¡œ ìœ„ì¹˜ ì§€ì •)
    });
    
    // ğŸš© [ì¶”ê°€] ì¤Œ ì»¨íŠ¸ë¡¤ì„ ì™¼ìª½ í•˜ë‹¨ì— ì¶”ê°€
    L.control.zoom({
        position: 'bottomleft'
    }).addTo(map);
    // ğŸš© [ìˆ˜ì •] ìœ„ì„± ì§€ë„ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •í•˜ê³ , í† ê¸€ ìˆœì„œ ë³€ê²½
    const tileLayers = {
        'ìœ„ì„±': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18, // ìµœëŒ€ ì¤Œ ë ˆë²¨
            keepBuffer: 8, // ë·°í¬íŠ¸ ì£¼ë³€ì— ì¶”ê°€ë¡œ ë¡œë“œí•  íƒ€ì¼ ìˆ˜
            updateWhenIdle: false, // ğŸš© [ìˆ˜ì •] ì§€ë„ ì´ë™ ì¤‘ì—ë„ íƒ€ì¼ ë¡œë”©ì„ ê³„ì†í•˜ì—¬ ì‘ë‹µì„± í–¥ìƒ
            updateInterval: 200, // ğŸš© [ì¶”ê°€] íƒ€ì¼ ì—…ë°ì´íŠ¸ ì£¼ê¸°(ms)ë¥¼ ì„¤ì •í•˜ì—¬ ê³¼ë„í•œ ìš”ì²­ ë°©ì§€
            unloadInvisibleTiles: true, // ğŸš© [ì¶”ê°€] ë³´ì´ì§€ ì•ŠëŠ” íƒ€ì¼ì„ ë©”ëª¨ë¦¬ì—ì„œ ì œê±°í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ
            fadeAnimation: false // íƒ€ì¼ ë¡œë”© ì‹œ í˜ì´ë“œ íš¨ê³¼ ì œê±°
        }),
   //     'ë‹¤í¬': L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', { maxZoom: 20 }),
        'ì¼ë°˜': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, // ìµœëŒ€ ì¤Œ ë ˆë²¨
            keepBuffer: 8, // ë·°í¬íŠ¸ ì£¼ë³€ì— ì¶”ê°€ë¡œ ë¡œë“œí•  íƒ€ì¼ ìˆ˜
            updateWhenIdle: false, // ğŸš© [ìˆ˜ì •] ì§€ë„ ì´ë™ ì¤‘ì—ë„ íƒ€ì¼ ë¡œë”©ì„ ê³„ì†í•˜ì—¬ ì‘ë‹µì„± í–¥ìƒ
            updateInterval: 200, // ğŸš© [ì¶”ê°€] íƒ€ì¼ ì—…ë°ì´íŠ¸ ì£¼ê¸°(ms)ë¥¼ ì„¤ì •í•˜ì—¬ ê³¼ë„í•œ ìš”ì²­ ë°©ì§€
            unloadInvisibleTiles: true, // ğŸš© [ì¶”ê°€] ë³´ì´ì§€ ì•ŠëŠ” íƒ€ì¼ì„ ë©”ëª¨ë¦¬ì—ì„œ ì œê±°í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ
            fadeAnimation: false // íƒ€ì¼ ë¡œë”© ì‹œ í˜ì´ë“œ íš¨ê³¼ ì œê±°
        })
    };
    let currentTileLayer = tileLayers['ìœ„ì„±']; // ê¸°ë³¸ ë ˆì´ì–´
    currentTileLayer.addTo(map);

    // ğŸš© [ì¶”ê°€] ì§€ë„ ì™¼ìª½ ì•„ë˜ì— ì¶•ì²™ ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    L.control.scale({ imperial: false }).addTo(map); // ë¯¸í„°ë²•(metric)ë§Œ í‘œì‹œ

    // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ë ˆì´ì–´ë¥¼ ìœ„í•œ ì „ìš© Pane ìƒì„±
    // zIndexë¥¼ ë†’ê²Œ ì„¤ì •í•˜ì—¬ ë‹¤ë¥¸ ë ˆì´ì–´(ë§ˆì»¤, íˆíŠ¸ë§µ ë“±)ë³´ë‹¤ í•­ìƒ ìœ„ì— ìˆë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.
    map.createPane('drawingPane');
    map.getPane('drawingPane').style.zIndex = 650;

    // ğŸš© [ì¶”ê°€] ì§€ëª…(label)ë§Œì„ ìœ„í•œ ìµœìƒìœ„ pane ìƒì„±
    if (!map.getPane('labelPane')) {
    map.createPane('labelPane');
    map.getPane('labelPane').style.zIndex = 700;
    }

    let castleLayerGroup = L.layerGroup().addTo(map); 
    map.addLayer(drawnItems); // ğŸš© [ì¶”ê°€] ê·¸ë¦° ë„í˜•ì„ ë‹´ì„ ë ˆì´ì–´ ê·¸ë£¹ ì¶”ê°€
    const combinedSlider = document.getElementById('combinedSlider'); // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” DOM ìš”ì†Œ
    const yearLabel = document.getElementById('yearLabel');
    const ganjiLabel = document.getElementById('ganjiLabel'); // ğŸš© [ìˆ˜ì •] ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë³€ìˆ˜ ì œê±°
    const monthLabel = document.getElementById('monthLabel'); // ğŸš© [ìˆ˜ì •] ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë³€ìˆ˜ ì œê±°
    const yearInput = document.getElementById('yearInput');
    const sliderTicks = document.getElementById('sliderTicks');
    const castleForm = document.getElementById('castleForm');
    const addCastleForm = document.getElementById('addCastleForm');
    const searchInput = document.getElementById('mapSearchInput'); // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ì°½
    const searchBtn = document.getElementById('mapSearchBtn'); // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ ë²„íŠ¼
    // const openHistoryFormBtn = document.getElementById('openHistoryFormBtn'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
    const countrySelectForEdit = document.getElementById('countrySelectForEdit');
    // const prevHistoryBtn = document.getElementById('prevHistoryBtn'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
    // const nextHistoryBtn = document.getElementById('nextHistoryBtn'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
    const kingCountrySelectForForm = document.getElementById('kingCountryName');
    const kingSelect = document.getElementById('kingSelect');
    
    // ğŸš© [ì¶”ê°€] ì„±/ìœ„ì¹˜ í¼ ë‚´ êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ì‚¬ìš©)
    // ì„±/ìœ„ì¹˜ í¼ ë‚´ ì²´í¬ë°•ìŠ¤ ë° ìƒì„¸ ì •ë³´
    const layerToggles = document.getElementById('layer-toggles');
    const countryFilterSelect = document.getElementById('mapCountryFilter'); // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ë¶€ êµ­ê°€ í•„í„°
    const militaryFlagDetails = document.getElementById('militaryFlagDetails');
    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° DOM ìš”ì†Œ
    const militaryCountryNameInput = document.getElementById('militaryCountryNameInput');
    const militaryCountrySelect = document.getElementById('militaryCountrySelect');
    const castleHistorySection = document.getElementById('castleHistorySection');
    const simpleDateSection = document.getElementById('simpleDateSection');
    const castleDescRow = document.getElementById('castleDesc').closest('.form-row');
    const castlePhotoRow = document.getElementById('castlePhoto').closest('.form-row');

    const markerTypeSelector = document.getElementById('markerTypeSelector');

// ğŸš© ìˆ˜ì •: ìƒˆë¡œ ì¶”ê°€ëœ êµ°ëŒ€ ê´€ë ¨ ì…ë ¥ í•„ë“œ ë§µí•‘
const generalNameInput = document.getElementById('generalName');
const troopCountInput = document.getElementById('troopCount');
const generalPhotoInput = document.getElementById('generalPhoto'); // 1ë‹¨ê³„ì—ì„œ ì¶”ê°€í•œ í•„ë“œ


    const pathDataSection = document.getElementById('pathDataSection'); 
    const pathDataList = document.getElementById('pathDataList'); 
    
    // ğŸš© [ì¶”ê°€] ì¬ìƒ ê´€ë ¨ DOM ìš”ì†Œ ë§µí•‘
    const timeLabelDisplay = document.getElementById('timeLabelDisplay'); 
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const playbackSpeedSlider = document.getElementById('playbackSpeedSlider');
    const speedDisplay = document.getElementById('speedDisplay'); // ì†ë„ ë””ìŠ¤í”Œë ˆì´ ë§µí•‘
    // ğŸš© NEW: ìì—° ì§€ë¬¼ ê´€ë ¨ DOM ìš”ì†Œ ë§µí•‘
    const isNaturalFeature = document.getElementById('isNaturalFeature');
    const naturalFeatureDetails = document.getElementById('naturalFeatureDetails');
    const naturalFeatureType = document.getElementById('naturalFeatureType');

    // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ DOM ìš”ì†Œ
    const eventOverlay = document.getElementById('event-overlay');
    const eventOverlayImage = document.getElementById('event-overlay-image');
    const eventOverlayVideo = document.getElementById('event-overlay-video');
    const eventOverlayText = document.getElementById('event-overlay-text');

    // ğŸš© [ì¶”ê°€] í¼ì„ ì—´ê³  í™”ë©´ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚¤ëŠ” í•¨ìˆ˜
    function openForm(formId) {
        const form = document.getElementById(formId);
        if (!form) return;

        form.style.display = 'block';

        // í¼ì„ ë·°í¬íŠ¸ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚µë‹ˆë‹¤.
        const formHeight = form.offsetHeight;
        const windowHeight = window.innerHeight;
        const topPosition = Math.max(20, (windowHeight - formHeight) / 2); // ìƒë‹¨ì— ìµœì†Œ 20px ì—¬ë°±
        form.style.top = `${topPosition}px`;
    }

    // --- 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
    
    /** êµ­ê°€ ì´ë¦„ìœ¼ë¡œ êµ­ê°€ ì •ë³´ë¥¼ ì°¾ìŠµë‹ˆë‹¤. */
    function getCountryInfo(name) {
      return countries.find(c => c.name === name);
    }

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì‹œê°„ ê³„ì‚° ë¡œì§ì„ 'ì´ ì›”ìˆ˜' ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½

    /**
     * ì—°ë„ì™€ ì›”ì„ 'ì´ ì›”ìˆ˜'ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (AD 1ë…„ 1ì›” = 0)
     * @param {number} year - ì—°ë„ (BCëŠ” ìŒìˆ˜)
     * @param {number} month - ì›” (1-12)
     * @returns {number} ì´ ì›”ìˆ˜
     */
    function yearMonthToTotalMonths(year, month) {
        // 0ë…„ì€ ì—†ìœ¼ë¯€ë¡œ, BC 1ë…„(year=-1)ì€ AD 1ë…„(year=1) ë°”ë¡œ ì´ì „ ì‹œê°„ì…ë‹ˆë‹¤.
        // AD: (year - 1) * 12
        // BC: year * 12 (ì˜ˆ: -1ë…„ì€ -12ë¶€í„° ì‹œì‘)
        const baseMonths = year >= 1 ? (year - 1) * 12 : year * 12;
        return baseMonths + (month - 1);
    }

    /**
     * 'ì´ ì›”ìˆ˜'ë¥¼ ì—°ë„ì™€ ì›” ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * @param {number} totalMonths - ì´ ì›”ìˆ˜
     * @returns {{year: number, month: number}} ì—°ë„ì™€ ì›”
     */
    function totalMonthsToYearMonth(totalMonths) {
        const year = totalMonths >= 0 ? Math.floor(totalMonths / 12) + 1 : Math.floor(totalMonths / 12);
        const month = (totalMonths % 12 + 12) % 12 + 1;
        // 0ë…„ì€ ì—†ìœ¼ë¯€ë¡œ, ê³„ì‚°ëœ yearê°€ 0ì´ë©´ -1(BC 1ë…„)ë¡œ ì¡°ì •í•©ë‹ˆë‹¤.
        return { year: year === 0 ? -1 : year, month };
    }

    function normalizeHistoryNumber(value, fallback) {
        if (value === undefined || value === null || value === '') return fallback;
        const parsed = parseInt(value, 10);
        return Number.isNaN(parsed) ? fallback : parsed;
    }

    function sortHistoryByStart(historyList) {
        if (!Array.isArray(historyList)) return [];
        return [...historyList].sort((a, b) => {
            const aYear = normalizeHistoryNumber(a?.start_year, Number.MAX_SAFE_INTEGER);
            const bYear = normalizeHistoryNumber(b?.start_year, Number.MAX_SAFE_INTEGER);
            if (aYear !== bYear) return aYear - bYear;

            const aMonth = normalizeHistoryNumber(a?.start_month, 1);
            const bMonth = normalizeHistoryNumber(b?.start_month, 1);
            return aMonth - bMonth;
        });
    }

    /**
     * ì£¼ì–´ì§„ ì´ ì›”ìˆ˜ ì‹œì ì— í•´ë‹¹í•˜ëŠ” ì—­ì‚¬ ê¸°ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
     * ë°°ì—´ì˜ ë’¤ì— ìˆëŠ” ë ˆì½”ë“œê°€ ìš°ì„ ë˜ë„ë¡ ì—­ìˆœìœ¼ë¡œ íƒìƒ‰í•©ë‹ˆë‹¤.
     * @param {Array} historyList - ì„±/ë„ì‹œì˜ ì—­ì‚¬ ê¸°ë¡ ë°°ì—´
     * @param {number} currentTotalMonths - ë¹„êµí•  ì´ ì›”ìˆ˜ ê°’
     * @returns {{record: object, startYear: number, startMonth: number, endYear: number|null, endMonth: number, startTotalMonths: number, endTotalMonths: number}|null}
     */
    function getActiveHistoryInfo(historyList, currentTotalMonths) {
        if (!Array.isArray(historyList) || historyList.length === 0) return null;

        for (let index = historyList.length - 1; index >= 0; index--) {
            const record = historyList[index];
            if (!record) continue;

            const startYear = normalizeHistoryNumber(record.start_year, -4000);
            const startMonth = normalizeHistoryNumber(record.start_month, 1);
            const startTotalMonths = yearMonthToTotalMonths(startYear, startMonth);

            const hasEndYear = !(record.end_year === undefined || record.end_year === null || record.end_year === '');
            const endYear = hasEndYear ? normalizeHistoryNumber(record.end_year, null) : null;
            const endMonth = hasEndYear ? normalizeHistoryNumber(record.end_month, 12) : 12;
            const endTotalMonths = hasEndYear && endYear !== null
                ? yearMonthToTotalMonths(endYear, endMonth)
                : Infinity;

            if (currentTotalMonths >= startTotalMonths && currentTotalMonths <= endTotalMonths) {
                return {
                    record,
                    startYear,
                    startMonth,
                    endYear,
                    endMonth,
                    startTotalMonths,
                    endTotalMonths
                };
            }
        }

        return null;
    }


    /** ì—°ë„ì™€ ì›”ì„ ë°›ì•„ 60ê°‘ì(ê°„ì§€)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
    function getGanji(year, month) {
        const gan = ["ê°‘", "ì„", "ë³‘", "ì •", "ë¬´", "ê¸°", "ê²½", "ì‹ ", "ì„", "ê³„"];
        const ji = ["ì", "ì¶•", "ì¸", "ë¬˜", "ì§„", "ì‚¬", "ì˜¤", "ë¯¸", "ì‹ ", "ìœ ", "ìˆ ", "í•´"];

        const baseYear = 1804;
        const baseGanIndex = 0; 
        const baseJiIndex = 0; 

        const diff = year - baseYear;

        const ganIndex = (baseGanIndex + diff) % 10;
        const jiIndex = (baseJiIndex + diff) % 12;

        return `${gan[ganIndex < 0 ? ganIndex + 10 : ganIndex]}${ji[jiIndex < 0 ? jiIndex + 12 : jiIndex]}ë…„`;
    }
    

    /** íŠ¹ì • ì—°ë„ì— ì¬ìœ„ ì¤‘ì¸ ì™• ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. */
function getKingByYear(countryName, year, month) {
  // ğŸš© ìˆ˜ì •: êµ­ê°€ ì´ë¦„ìœ¼ë¡œ í•´ë‹¹ êµ­ê°€ì˜ ObjectIdë¥¼ ì°¾ìŠµë‹ˆë‹¤.
  const country = getCountryInfo(countryName);
  if (!country) return null;
  const kingKey = country._id; // <- ObjectIdë¥¼ í‚¤ë¡œ ì‚¬ìš©
  const list = kings[kingKey];
      
      if (!list) return null;
      return list.find(k => {
        const startCombined = yearMonthToTotalMonths(k.start, k.start_month);
        const endCombined = (k.end === null || k.end === undefined || isNaN(k.end)) 
                            ? Infinity 
                            : yearMonthToTotalMonths(k.end, k.end_month);
        const currentCombined = yearMonthToTotalMonths(year, month);

        return startCombined <= currentCombined && currentCombined < endCombined;
      });
    }

    /** í˜„ì¬ ì—°ë„ì™€ ì›”ì˜ ì™• ì •ë³´ë¥¼ íŒ¨ë„ì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. */
    function updateKingLabel(year, month) {
      let html = "";
      countries.forEach(country => { // ğŸš© [ìˆ˜ì •] ë¶ˆí•„ìš”í•œ ê´„í˜¸ ì œê±°
        const king = getKingByYear(country.name, year, month); // <-- THIS LINE WAS MISSING OR MISPLACED
       if (king) { // <-- Now the 'if' statement works because 'king' is defined
            const startMonth = king.start_month || 1;
            const endMonth = king.end_month || 12;
            const endYearText = king.end === null ? 'í˜„ì¬' : `${king.end}ë…„ ${endMonth}ì›”`; 
            const period = `${king.start}ë…„ ${startMonth}ì›” ~ ${endYearText}`;
            let iconHtml;
            const countryColor = country.color || 'gray'; 

            if (country.flag) {
                iconHtml = `<img src="${country.flag}" class="country-flag-img" style="width: 18px; height: 12px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;">`;
            } else {
                iconHtml = `<span style="color:${countryColor}; style="width: 18px; height: 12px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;"">â–£</span>`;
            }

            let kingHtml = `${iconHtml} <b><span class="country-name-link" style="cursor: pointer; text-decoration: underline;" onclick="zoomToCountryCapital('${country._id}')">${country.name}</span></b>: ${king.name} (${period})`;

            html += `<div class="king-item">${kingHtml}</div>`;
        }
    });
    const kingContent = html || "í•´ë‹¹ ì—°ë„ ì™• ì •ë³´ ì—†ìŒ";
    // document.getElementById('kingList').innerHTML = kingContent; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°ë¡œ ë¹„í™œì„±í™”
    // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ ì™• ëª©ë¡ íŒ¨ë„ë§Œ ì—…ë°ì´íŠ¸
    const mapKingList = document.getElementById('map-king-list');
    if (mapKingList) {
        mapKingList.innerHTML = kingContent;
    }
}
    
    /** êµ­ê°€ì˜ ìˆ˜ë„ë¡œ ì§€ë„ë¥¼ í™•ëŒ€/ì´ë™í•˜ëŠ” í•¨ìˆ˜ */
    window.zoomToCountryCapital = function(countryId) {
        // í•´ë‹¹ êµ­ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const country = countries.find(c => c._id === countryId);
        if (!country) return;
        
        // í˜„ì¬ ì‹œì  ê°€ì ¸ì˜¤ê¸°
        const { year, month } = getCurrentYearMonth();
        const currentTotalMonths = yearMonthToTotalMonths(year, month);
        
        // í•´ë‹¹ êµ­ê°€ì˜ ìˆ˜ë„(is_capital: true) ì°¾ê¸°
        const capital = castles.find(castle => 
            castle.country_id === countryId && 
            castle.is_capital === true &&
            castle.lat && castle.lng
        );
        
        if (capital) {
            // ìˆ˜ë„ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
            map.setView([capital.lat, capital.lng], 8, { animate: true, duration: 1 });
        } else {
            // ìˆ˜ë„ê°€ ì—†ìœ¼ë©´ í•´ë‹¹ êµ­ê°€ì˜ ì²« ë²ˆì§¸ ì„±/ë„ì‹œë¡œ ì´ë™
            const firstCity = castles.find(castle => 
                castle.country_id === countryId && 
                castle.lat && castle.lng
            );
            if (firstCity) {
                map.setView([firstCity.lat, firstCity.lng], 8, { animate: true, duration: 1 });
            }
        }
    };
    
    /** * path_dataì™€ í˜„ì¬ ì‹œì ì„ ë°”íƒ•ìœ¼ë¡œ êµ°ëŒ€ì˜ ë³´ê°„ëœ ìœ„ì¹˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. */
    function getMilitaryPosition(pathData, currentCombined) {
        if (!pathData || pathData.length < 2) return null; 

        const currentTotalMonths = currentCombined;

        for (let i = 1; i < pathData.length; i++) {
            const startPoint = pathData[i - 1];
            const endPoint = pathData[i];

            const startTotalMonths = yearMonthToTotalMonths(startPoint.target_year, startPoint.target_month);
            const endTotalMonths = yearMonthToTotalMonths(endPoint.target_year, endPoint.target_month);
            
            if (startTotalMonths <= currentTotalMonths && currentTotalMonths < endTotalMonths) {
                const totalMonths = endTotalMonths - startTotalMonths;
                if (totalMonths <= 0) continue; 
                
                const monthsPassed = currentTotalMonths - startTotalMonths;
                
                let progress = monthsPassed / totalMonths;
                if (progress > 1) progress = 1; 

                const lat = startPoint.lat + (endPoint.lat - startPoint.lat) * progress;
                const lng = startPoint.lng + (endPoint.lng - startPoint.lng) * progress;
                
                return { lat: lat, lng: lng }; 
            }
        }
        
        if (pathData.length > 0) {
            const firstPoint = pathData[0];
            const lastPoint = pathData[pathData.length - 1];
            const firstTotalMonths = yearMonthToTotalMonths(firstPoint.target_year, firstPoint.target_month);
            const lastTotalMonths = yearMonthToTotalMonths(lastPoint.target_year, lastPoint.target_month);
            
            if (currentTotalMonths >= lastTotalMonths) {
                return { lat: lastPoint.lat, lng: lastPoint.lng };
            }
            if (currentTotalMonths < firstTotalMonths) {
                return { lat: firstPoint.lat, lng: firstPoint.lng };
            }
        }

        return null; 
    }

    /** í™œì„±í™”ëœ í¼ì„ ì œì™¸í•œ ëª¨ë“  í¼ì„ ë‹«ìŠµë‹ˆë‹¤. (ë™ì¼) */
    function closeAllFormsExcept(exceptId) {
        ['castleForm', 'historyForm', 'countryForm', 'kingForm', 'eventForm', 'drawingForm'].forEach(id => {
            if (id !== exceptId) { // ğŸš© [ìˆ˜ì •] drawingForm ì¶”ê°€
                document.getElementById(id).style.display = "none"; // ğŸš© [ìˆ˜ì •] eventForm ì¶”ê°€
            }
        });
    }

        /** ìì—° ì§€ë¬¼ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ì‹¬ë³¼ê³¼ í´ë˜ìŠ¤ ë§¤í•‘ (NEW) */
    function getNaturalFeatureIcon(type) {
        const icons = {
            'mountain': { symbol: 'â§Š', className: 'feature-mountain' }, // ì‚°
            'sea': { symbol: 'â™’ï¸', className: 'feature-sea' }, // ë°”ë‹¤/í˜¸ìˆ˜
            'river': { symbol: 'ğŸ›¶', className: 'feature-river' }, // ê°•/ë‚´ë¥™
            'mudflat': { symbol: 'ğŸ•³ï¸', className: 'feature-mudflat' }, // ë»˜/ëŠª (ê°ˆìƒ‰ ì›)
            'buffalo': { symbol: 'ğŸƒ', className: 'feature-other' },
            'horse': { symbol: 'ğŸ', className: 'feature-other' },
            'camel': { symbol: 'ğŸ«', className: 'feature-other' },
            'mongky': { symbol: 'ğŸ’', className: 'feature-other' },
            'hunting': { symbol: 'ğŸ¹', className: 'feature-hunting' },
            'construction': { symbol: 'âš’ï¸', className: 'feature-construction' },
            'other': { symbol: 'â–', className: 'feature-other' }
        };
        return icons[type] || icons['other'];
    }

/** ì—°ë„/ì›”ì— í•´ë‹¹í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì°¾ì•„ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
    function checkAndDisplayEvent(year, month) {
        // ğŸš© [ìˆ˜ì •] í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤ ì´ì „ì˜ ì´ë²¤íŠ¸ í‘œì‹œ íƒ€ì´ë¨¸ë¥¼ í•­ìƒ ì·¨ì†Œí•©ë‹ˆë‹¤.
        if (eventDisplayTimeout) clearTimeout(eventDisplayTimeout);

        // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ë ˆì´ì–´ê°€ ë¹„í™œì„±í™” ìƒíƒœì´ë©´, ì¦‰ì‹œ ìˆ¨ê¸°ê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
        if (!layerVisibility.event) {
            eventOverlay.classList.remove('visible');
            // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ë ˆì´ì–´ê°€ ë¹„í™œì„±í™”ë˜ë©´, ìˆ¨ê¹€ íƒ€ì´ë¨¸ë„ ì·¨ì†Œí•˜ê³  nullë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
            if (eventDisplayTimeout) {
                clearTimeout(eventDisplayTimeout);
                eventDisplayTimeout = null;
            }
            return;
        }

        const currentEvent = events.find(e => e.year === year && (e.month ?? 1) === month);

        if (currentEvent) {
            // ğŸš© [í•µì‹¬ ìˆ˜ì •] setTimeoutì„ ì‚¬ìš©í•œ ê¹œë¹¡ì„ íš¨ê³¼ë¥¼ ì œê±°í•˜ê³ , ì§ì ‘ DOMì„ ì¡°ì‘í•˜ì—¬ ë Œë”ë§ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.
            eventOverlayText.textContent = currentEvent.text;
            
            // ğŸš© [ì¶”ê°€] URLì´ ë¹„ë””ì˜¤ì¸ì§€ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸í•˜ì—¬ ì ì ˆí•˜ê²Œ í‘œì‹œ
            if (currentEvent.photo) {
                const url = currentEvent.photo.toLowerCase();
                const isVideo = url.includes('youtube.com') || url.includes('youtu.be') || 
                                url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.ogg');
                
                if (isVideo) {
                    // YouTube URLì¸ ê²½ìš° embed í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    let videoSrc = currentEvent.photo;
                    if (url.includes('youtube.com/watch?v=')) {
                        const videoId = currentEvent.photo.split('v=')[1].split('&')[0];
                        videoSrc = `https://www.youtube.com/embed/${videoId}`;
                    } else if (url.includes('youtu.be/')) {
                        const videoId = currentEvent.photo.split('youtu.be/')[1].split('?')[0];
                        videoSrc = `https://www.youtube.com/embed/${videoId}`;
                    }
                    
                    // YouTubeì¸ ê²½ìš° iframe ì‚¬ìš©, ì•„ë‹ˆë©´ video íƒœê·¸ ì‚¬ìš©
                    if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        eventOverlayVideo.innerHTML = `<iframe width="100%" height="300" src="${videoSrc}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                        eventOverlayVideo.style.display = 'block';
                        eventOverlayImage.style.display = 'none';
                    } else {
                        eventOverlayVideo.innerHTML = '';
                        eventOverlayVideo.src = currentEvent.photo;
                        eventOverlayVideo.style.display = 'block';
                        eventOverlayImage.style.display = 'none';
                    }
                } else {
                    // ì´ë¯¸ì§€ì¸ ê²½ìš°
                    eventOverlayVideo.innerHTML = '';
                    eventOverlayVideo.style.display = 'none';
                    eventOverlayImage.src = currentEvent.photo;
                    eventOverlayImage.style.display = 'block';
                }
            } else {
                eventOverlayVideo.innerHTML = '';
                eventOverlayVideo.style.display = 'none';
                eventOverlayImage.style.display = 'none';
            }
            eventOverlay.classList.add('visible');

            // 1.5ì´ˆ í›„ì— ì°½ì„ ìˆ¨ê¸°ëŠ” íƒ€ì´ë¨¸ì˜ ì—­í• ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
            eventDisplayTimeout = setTimeout(() => {
                eventOverlay.classList.remove('visible');
                eventDisplayTimeout = null;
            }, 2000);

        } else {
            // ì´ë²¤íŠ¸ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì°½ì„ ìˆ¨ê¹ë‹ˆë‹¤.
            eventOverlay.classList.remove('visible');
        }
    }

// --- 4. ì§€ë„ ë Œë”ë§ ë° ë§ˆì»¤ ìƒì„± í•¨ìˆ˜ ---

function updateMap(year, month) {
        // Leaflet.heat ì´ˆê¸°í™”ëŠ” ì§€ë„ load ì´í›„ì—ë§Œ ì•ˆì „í•˜ê²Œ ì§„í–‰ ê°€ëŠ¥í•˜ë¯€ë¡œ, ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë‹¤ì‹œ í˜¸ì¶œì„ ì˜ˆì•½í•©ë‹ˆë‹¤.
        if (!map || !map._loaded) {
            if (map && typeof map.once === 'function') {
                map.once('load', () => updateMap(year, month));
            }
            return;
        }
        heatmapSourceDebug = {};
        // ğŸš© [ìˆ˜ì •] íˆíŠ¸ë§µ ë ˆì´ì–´ë¥¼ í¬í•¨í•œ ëª¨ë“  ë ˆì´ì–´ ì´ˆê¸°í™”
        Object.values(heatmapLayers).forEach(layer => map.removeLayer(layer));
        heatmapLayers = {};

        // ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ê¸° ë ˆì´ì–´ ì´ˆê¸°í™”ë¥¼ ë‹¤ë¥¸ ë ˆì´ì–´ ì´ˆê¸°í™”ì™€ í•¨ê»˜ ì²˜ë¦¬
        if (drawnItems) drawnItems.clearLayers();

        // ğŸš© [ì¶”ê°€] ì €ì¥ëœ ê·¸ë¦¬ê¸° ë°ì´í„° ë Œë”ë§
        drawings.forEach(drawing => {
            const startYear = drawing.start_year || -Infinity;
            const endYear = drawing.end_year || Infinity;

            if (!(year >= startYear && year <= endYear)) return; // í˜„ì¬ ì‹œê°„ëŒ€ì— ì—†ìœ¼ë©´ ë Œë”ë§ ì•ˆí•¨

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] 'ê°•' ìœ í˜•ì€ 'ìì—°' ë ˆì´ì–´ í† ê¸€ì— ë”°ë¼ í‘œì‹œ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
            if (drawing.type === 'river' && !layerVisibility.natural) {
                return; // 'ìì—°' ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìœ¼ë©´ ê°•ì„ ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
            }
            if (drawing.type === 'mountain' && !layerVisibility.natural) {
                return; // 'ìì—°' ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìœ¼ë©´ ê°•ì„ ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
            }

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê·¸ë¦¬ê¸° ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
            let layer;
            switch (drawing.type) {
                case 'wall': // ğŸš© [ìˆ˜ì •] ì„±ê³½ ìŠ¤íƒ€ì¼ì„ 'å‡¹' í…ìŠ¤íŠ¸ë¥¼ ì´ìš©í•œ í…ìŠ¤ì²˜ë¡œ ë³€ê²½
                    // ğŸš© [ìˆ˜ì •] onEachFeatureë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
                    // ğŸš© [í•µì‹¬ ìˆ˜ì •] setTextëŠ” FeatureGroupì„ ë°˜í™˜í•˜ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°”ì¸ë”©ì„ onEachFeatureì—ì„œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
                    layer = L.geoJSON(drawing.geojson, { style: { color: 'transparent', weight: 10, opacity: 0 } })
                             .setText('å‡¹', {
                        repeat: true,
                        offset: 0,
                        attributes: { 'font-size': '12', 'fill': '#ffffff', 'dy': 5, 'class': 'svg-shadow-filter' }
                    });
                    // ìƒì„±ëœ ë ˆì´ì–´ ê·¸ë£¹ì— ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
                    bindDrawingEvents(layer, drawing);
                    break;
                
                case 'river': // ğŸš© [ì¶”ê°€] ê°• ìŠ¤íƒ€ì¼
                    layer = L.geoJSON(drawing.geojson, {
                        style: { color: "#3498db", weight: 6, opacity: 0.7 }, // íŒŒë€ìƒ‰
                        onEachFeature: function (feature, layer) {
                            bindDrawingEvents(layer, drawing);
                        }
                    }); 
                    break;

                case 'mountain': // ğŸš© [ì¶”ê°€] ì‚°ë§¥ ìŠ¤íƒ€ì¼
                    layer = L.geoJSON(drawing.geojson, {
                        style: { 
                            color: "#A0522D", // ê°ˆìƒ‰ ê³„ì—´ (Sienna)
                            weight: 9,
                            opacity: 0.5,
                            dashArray: '5, 10' // ì ì„  ìŠ¤íƒ€ì¼ë¡œ ì‚°ë§¥ í‘œí˜„
                        },
                        pane: 'drawingPane',
                        onEachFeature: (feature, layer) => bindDrawingEvents(layer, drawing)
                    });
                    break;
                case 'arrow': 
                    // ğŸš© [ìˆ˜ì •] ì—¬ëŸ¬ ì„ ë¶„(segment)ì— ì•„ì´ì½˜ì´ ì¤‘ë³µë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ L.polylineìœ¼ë¡œ ë³€í™˜
                    if (drawing.geojson.geometry.type === 'LineString') {
                        const latlngs = drawing.geojson.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        // ğŸš© [í•µì‹¬ ìˆ˜ì •] setTextëŠ” FeatureGroupì„ ë°˜í™˜í•˜ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°”ì¸ë”©ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤.
                        layer = L.polyline(latlngs, { color: 'transparent', weight: 10, opacity: 0, pane: 'drawingPane' })
                                 .setText('â±', {
                                     repeat: true,
                                     offset: 0,
                                     attributes: { 'font-size': '20', 'fill': '#ffffff', 'dy': 5 }
                                 });
                        bindDrawingEvents(layer, drawing); // ìƒì„±ëœ ë ˆì´ì–´ ê·¸ë£¹ì— ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
                    } else { // Polygon ë“± ë‹¤ë¥¸ íƒ€ì…ì€ ê¸°ì¡´ ë°©ì‹ ìœ ì§€
                        layer = L.geoJSON(drawing.geojson, { style: { color: 'transparent', weight: 10, opacity: 0 } }); // ì´ë²¤íŠ¸ ë°”ì¸ë”© í•„ìš” ì‹œ ì¶”ê°€
                    }
                    break;

                default: // ì‚°ë§¥, ë„ë¡œ ë“± ê¸°íƒ€
                    // ğŸš© [ìˆ˜ì •] í™”ì‚´í‘œ ë°ì½”ë ˆì´í„°ë¥¼ ì œê±°í•˜ê³ , ì¼ë°˜ ì„ /ë„í˜•ë§Œ ê·¸ë¦¬ë„ë¡ ë³€ê²½
                    layer = L.geoJSON(drawing.geojson, {
                        style: { 
                            color: "#ffffff", // í°ìƒ‰ ì„ 
                            weight: 5,       // ë‘ê»˜
                            opacity: 0.5     // íˆ¬ëª…ë„
                        },
                        pane: 'drawingPane', // ì „ìš© Paneì— ê·¸ë¦¬ê¸°
                        onEachFeature: function (feature, layer) {
                            bindDrawingEvents(layer, drawing);
                        }
                    });
                    break;
            }

            if (layer) {
                // layer._leaflet_idëŠ” bindDrawingEvents ë‚´ë¶€ì—ì„œ ì„¤ì •ë©ë‹ˆë‹¤.
                drawnItems.addLayer(layer);
            }
        });

        // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ë ˆì´ì–´ì— ëŒ€í•œ ê³µí†µ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜
        function bindDrawingEvents(layer, drawingData) {
            layer._leaflet_id = drawingData._id; // ì‚­ì œ/í¸ì§‘ì„ ìœ„í•œ ID ì—°ê²°
            layer.bindPopup(`<b>${drawingData.name}</b> (${drawingData.type})`);
            
            // ğŸš© [ìˆ˜ì •] mouseover íŒì—…ì„ ì œê±°í•˜ê³ , í´ë¦­ ì‹œì—ë§Œ íŒì—…ì´ ë‚˜íƒ€ë‚˜ë„ë¡ ìˆ˜ì •
            layer.on('click', (e) => { 
                layer.openPopup(e.latlng); // í´ë¦­í•œ ìœ„ì¹˜ì— íŒì—…ì„ ì—½ë‹ˆë‹¤.
                const bounds = layer.getBounds(); if (bounds.isValid()) { map.flyTo(bounds.getCenter(), 8); }
                if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) {
                    const geojsonToEdit = drawingData.geojson;
                    openDrawingForm(geojsonToEdit, drawingData);
                }
            });
        }

        // ğŸš© [ì¶”ê°€] ê°•ì—­ í‘œì‹œë¥¼ ìœ„í•œ êµ­ê°€ë³„ í¬ì¸íŠ¸ ë°ì´í„° ìˆ˜ì§‘
        const currentTotalMonths = yearMonthToTotalMonths(year, month);
        const newHeatmapData = {}; // { countryId: [[lat, lng, intensity], ...] }

        if (layerVisibility.territory) {
            castles.forEach(castle => {
                if (typeof castle.lat !== "number" || typeof castle.lng !== "number") return;

                // ğŸš© [í•µì‹¬ ìˆ˜ì •] í˜„ì¬ ì‹œê°„ì— ë§ëŠ” ì—­ì‚¬ ê¸°ë¡ì„ ì°¾ì•„ì„œ ê·¸ country_idë¥¼ ì‚¬ìš©
                const activeHistoryInfo = getActiveHistoryInfo(castle.history, currentTotalMonths);

                // ğŸš© [í•µì‹¬ ìˆ˜ì •] í˜„ì¬ ì‹œê°„ì— ë§ëŠ” ì—­ì‚¬ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                if (!activeHistoryInfo || !activeHistoryInfo.record.country_id) return;

                const { record: activeHistoryRecord } = activeHistoryInfo;
                const countryId = activeHistoryRecord.country_id || castle.country_id || castle.countryId;

                if (!countryId) return;
                
                // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„°ë§ ë¡œì§
                if (selectedEthnicity !== 'all') {
                    const countryInfo = getCountryInfoById(countryId);
                    if (countryInfo && countryInfo.ethnicity !== selectedEthnicity) {
                        return; // ì„ íƒëœ ë¯¼ì¡±ê³¼ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ íˆíŠ¸ë§µì—ì„œ ì œì™¸
                    }
                }

                const debugKey = getCastleDebugKey(castle);
                const layerType = getCastleLayerType(castle);
                const matchesSelectedCountry = selectedCountryId === 'all' || countryId === selectedCountryId;
                const countryInfoForDebug = getCountryInfoById(countryId);
                heatmapSourceDebug[debugKey] = {
                    castleId: castle._id ?? null,
                    name: activeHistoryRecord.name || castle.name || '(ì´ë¦„ ì—†ìŒ)',
                    castleType: layerType,
                    countryId,
                    countryName: countryInfoForDebug?.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
                    lat: castle.lat,
                    lng: castle.lng,
                    matchesSelectedCountry,
                    layerVisible: layerVisibility[layerType] ?? true,
                    countryActive: computeCountryActiveState(countryInfoForDebug, currentTotalMonths),
                    countryInfoMissing: !countryInfoForDebug,
                    hasPathData: Array.isArray(castle.path_data) && castle.path_data.length >= 2,
                    contributesToHeatmap: true
                };

                if (!newHeatmapData[countryId]) {
                    newHeatmapData[countryId] = [];
                }

                // ğŸš© [ìˆ˜ì •] êµ­ê°€ ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ íˆíŠ¸ë§µ ê°•ë„(intensity)ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •
                let intensity = 1.2; // ğŸš© [ìˆ˜ì •] ê¸°ë³¸ ê°•ë„ ìƒí–¥
                if (selectedCountryId !== 'all') {
                    if (countryId === selectedCountryId) {
                        intensity = 2.0; // ğŸš© [ìˆ˜ì •] ì„ íƒëœ êµ­ê°€ëŠ” ë” ê°•í•˜ê²Œ í‘œì‹œ
                    } else {
                        intensity = 0.5; // ğŸš© [ìˆ˜ì •] ë‚˜ë¨¸ì§€ êµ­ê°€ëŠ” ì•½ê°„ ì•½í•˜ê²Œ í‘œì‹œ
                    }
                }
                newHeatmapData[countryId].push([castle.lat, castle.lng, intensity]); 
            });
        }

        // ğŸš© [ì¶”ê°€] íˆíŠ¸ë§µ ë ˆì´ì–´ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
        const activeCountryIds = new Set(Object.keys(newHeatmapData));
        const existingCountryIds = new Set(Object.keys(heatmapLayers));

        for (const countryId of activeCountryIds) {
            const points = newHeatmapData[countryId];
            const countryInfo = getCountryInfoById(countryId);

            if (countryInfo && countryInfo.color && points.length > 0) {
                if (heatmapLayers[countryId]) {
                    heatmapLayers[countryId].setLatLngs(points);
                } else {
                    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¤Œ ë ˆë²¨ì— ë”°ë¼ ë°˜ê²½ì„ ë™ì ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
                    // ì¤Œ ë ˆë²¨ 5ë¥¼ ê¸°ì¤€ìœ¼ë¡œ 80px ë°˜ê²½ì„ ì„¤ì •í•˜ê³ , ì¤Œ ë ˆë²¨ì´ 1ì”© ë³€ê²½ë  ë•Œë§ˆë‹¤ ë°˜ê²½ì„ 2ë°°ì”© ì¡°ì ˆí•©ë‹ˆë‹¤.
                    const currentZoom = map.getZoom(); // ğŸš© [ìˆ˜ì •] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ë°˜ê²½ ê³„ì‚°
                    const radius = 50 * Math.pow(2, currentZoom - 5);
                    const blur = 0; // ì•½ê°„ì˜ ë¸”ëŸ¬
                    // gradientë¥¼ ë” ë¶€ë“œëŸ½ê²Œ, ì§„í•˜ì§€ë§Œ ê³¼í•˜ì§€ ì•Šê²Œ
                    const gradient = {
                        0.2: countryInfo.color || 'grey',
                        0.5: countryInfo.color || 'grey',
                        0.8: countryInfo.color || 'grey',
                        1.0: countryInfo.color || 'grey'
                    };
                    const heatLayer = L.heatLayer(points, {
                        radius: radius,
                        blur: blur,
                        max: 0.25, // ê¸°ì¡´ë³´ë‹¤ ì•½ê°„ ë” ì§„í•˜ê²Œ
                        minOpacity: 0.4, // ìµœì†Œ ë¶ˆíˆ¬ëª…ë„
                        gradient: gradient,
                        opacity: 0.7 // ì „ì²´ ë¶ˆíˆ¬ëª…ë„ëŠ” 0.7ë¡œ (ê³¼í•˜ì§€ ì•Šê²Œ)
                    });
                    heatmapLayers[countryId] = heatLayer;
                }
                // ë ˆì´ì–´ê°€ ì§€ë„ì— ì—†ìœ¼ë©´ ì¶”ê°€í•©ë‹ˆë‹¤.
                if (!map.hasLayer(heatmapLayers[countryId])) {
                    heatmapLayers[countryId].addTo(map);
                }
            } else if (heatmapLayers[countryId]) {
                map.removeLayer(heatmapLayers[countryId]);
                delete heatmapLayers[countryId];
            }
        }

        for (const countryId of existingCountryIds) {
            if (!activeCountryIds.has(countryId)) {
                if (heatmapLayers[countryId]) {
                    map.removeLayer(heatmapLayers[countryId]);
                    delete heatmapLayers[countryId];
                }
            }
        }

        if (!layerVisibility.territory) {
            for (const countryId in heatmapLayers) {
                map.removeLayer(heatmapLayers[countryId]);
            }
            heatmapLayers = {};
        }

        castleLayerGroup.clearLayers(); // ë§ˆì»¤ ë ˆì´ì–´ëŠ” ê¸°ì¡´ì²˜ëŸ¼ í´ë¦¬ì–´ í›„ ë‹¤ì‹œ ì¶”ê°€
        markers = [];
        if (!Array.isArray(castles) || castles.length === 0) return;
        let marker;
        
        castleLayerGroup.clearLayers();
        castles.forEach(castle => {
            const baseCountryId = castle.country_id || castle.countryId || (Array.isArray(castle.history) && castle.history.length > 0 ? castle.history[0]?.country_id : null);

            // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„°ë§ ë¡œì§
            if (selectedCountryId !== 'all' && baseCountryId && baseCountryId !== selectedCountryId) {
                return; // ì„ íƒëœ êµ­ê°€ì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì´ ë§ˆì»¤ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
            }
            
            // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„°ë§ ë¡œì§
            if (selectedEthnicity !== 'all') {
                const countryInfo = getCountryInfoById(baseCountryId);
                if (countryInfo && countryInfo.ethnicity !== selectedEthnicity) {
                    return; // ì„ íƒëœ ë¯¼ì¡±ê³¼ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì´ ë§ˆì»¤ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
                }
            }
            
            let popupHtml; 
            if (typeof castle.lat !== "number" || isNaN(castle.lat) || typeof castle.lng !== "number" || isNaN(castle.lng)) return;
            
        // ğŸš¨ [ìˆ˜ì • 1] country, countryId ë³€ìˆ˜ë¥¼ ë£¨í”„ ì‹œì‘ ë¶€ë¶„ì—ì„œ ì„ ì–¸í•˜ì—¬ ì¶©ëŒ ë°©ì§€        
        const currentTotalMonths = yearMonthToTotalMonths(year, month);
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] í˜„ì¬ ì‹œê°„ì— ë§ëŠ” ì—­ì‚¬ ê¸°ë¡ ì°¾ê¸°
        const activeHistoryInfo = getActiveHistoryInfo(castle.history, currentTotalMonths);

        // ğŸš© [ìˆ˜ì •] ìœ íš¨í•œ ì—­ì‚¬ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì´ ì„±ì„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
        if (!activeHistoryInfo) return;

        const { record: activeHistoryRecord, startYear: recordStartYear, startMonth: recordStartMonth, endYear: recordEndYear, endMonth: recordEndMonth } = activeHistoryInfo;

    const castleName = activeHistoryRecord.name || castle.name;
    const countryId = activeHistoryRecord.country_id || castle.country_id || castle.countryId;
        const countryInfo = getCountryInfoById(countryId);
        const countryName = countryInfo ? countryInfo.name : 'ì•Œ ìˆ˜ ì—†ìŒ';
        const dotColor = countryInfo ? countryInfo.color : 'white';

        const isWithinDuration = true; // activeHistoryRecordê°€ ìˆìœ¼ë©´ í•­ìƒ ìœ íš¨ ê¸°ê°„ ë‚´ì— ìˆìŒ
        const builtText = `${recordStartYear}ë…„ ${recordStartMonth}ì›”`;
        const destroyedText = recordEndYear === null ? 'í˜„ì¬' : `${recordEndYear}ë…„ ${recordEndMonth}ì›”`;
        
        const king = getKingByYear(countryName, year, month); // â¬…ï¸ king ì¡°íšŒëŠ” countryName ì‚¬ìš©

            // ğŸš© 0. ì§€ì—­ëª…/í…ìŠ¤íŠ¸ ë¼ë²¨ ë§ˆì»¤ (NEW)
            if (castle.is_label) {
                if (!layerVisibility.label) return;
                if (!isWithinDuration) return;                

                // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
                if (castle.custom_icon) {
                    const iconWidth = castle.icon_width || 32;
                    const iconHeight = castle.icon_height || 32;
                    const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                    const labelIcon = L.divIcon({
                        className: 'custom-icon-marker',
                        html: customIconHtml,
                        iconSize: [iconWidth, iconHeight],
                        iconAnchor: [iconWidth / 2, 0],  // ğŸš© [ìˆ˜ì •] í•€ ì¤‘ì•™ ë°”ë¡œ í•˜ë‹¨ìœ¼ë¡œ ìœ„ì¹˜ ì¡°ì •
                        pane: 'labelPane'
                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: labelIcon, pane: 'labelPane' });
                } else {
                    // ğŸš© [ì¶”ê°€] ì €ì¥ëœ í¬ê¸°ì— ë”°ë¼ í°íŠ¸ í¬ê¸° ê²°ì •
                    let fontSize = '15px'; // ê¸°ë³¸ 'ì¤‘'
                    switch (castle.label_size) {
                        case 'large':
                            fontSize = '26px';
                            break;
                        case 'small':
                            fontSize = '10px';
                            break;
                    }
                    const labelIcon = L.divIcon({
                        // ğŸš© [ìˆ˜ì •] pane: 'labelPane'ì„ ì§€ì •í•˜ì—¬ í•­ìƒ ìµœìƒìœ„ì— ë³´ì´ë„ë¡ í•¨
                        className: 'label-text-marker', 
                        html: `<div style="
                            font-size: ${fontSize}; 
                            font-weight: bold; 
                            color: ${castle.label_color || '#FFFFFF'}; 
                            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
                            white-space: nowrap;
                            text-align: center;
                        ">${castleName}</div>`,
                        iconSize: [150, 40],
                        iconAnchor: [75, 0],  // ğŸš© [ìˆ˜ì •] í•€ ì¤‘ì•™ ë°”ë¡œ í•˜ë‹¨ìœ¼ë¡œ ìœ„ì¹˜ ì¡°ì •
                        pane: 'labelPane'
                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: labelIcon, pane: 'labelPane' });
                }
                
                const editorInfoHtml = castle.lastModifiedBy 
                    ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}</small>` 
                    : (castle.createdBy ? `<br><small>ìƒì„±ì: ${castle.createdBy}</small>` : '');
                
                popupHtml = `<b>ì§€ì—­ëª…: ${castleName}</b><br>ê¸°ê°„: ${builtText} ~ ${destroyedText}<br>ì„¤ëª…: ${castle.desc ?? ''}${editorInfoHtml}`;
                
              marker.on('click', (e) => { 
                map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                if (editMode) openCastleForm(castle._id); 
              });
              markers.push(marker);
               marker.addTo(castleLayerGroup);
              return; // ğŸš© [ë³µì›] ë‹¤ë¥¸ ë§ˆì»¤ íƒ€ì…ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ return ì¶”ê°€
            } 
            // ğŸš© 1. ìì—° ì§€ë¬¼ ë§ˆì»¤ (NEW)
            if (castle.is_natural_feature) { 
                if (!layerVisibility.natural) return;
                if (!isWithinDuration) return;

                // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
                if (castle.custom_icon) {
                    const iconWidth = castle.icon_width || 32;
                    const iconHeight = castle.icon_height || 32;
                    const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                    const featureIcon = L.divIcon({
                        className: 'custom-icon-marker',
                        html: customIconHtml,
                        iconSize: [iconWidth, iconHeight],
                        iconAnchor: [iconWidth / 2, iconHeight],
                        popupAnchor: [0, -iconHeight]
                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: featureIcon });
                } else {
                    const featureType = castle.natural_feature_type || 'other';
                    let iconInfo = getNaturalFeatureIcon(featureType);
                    if (!iconInfo) {
                        iconInfo = getNaturalFeatureIcon('other');
                    }
                    const iconClass = iconInfo?.className || 'feature-other';
                    const iconSymbol = iconInfo?.symbol || 'â–';
                    
                    const featureIcon = L.divIcon({
                        className: `natural-feature-marker ${iconClass}`,
                            html: `<div>${iconSymbol}</div><div class="feature-name">${castleName}</div>`,
                            iconSize: [60, 40],
                            iconAnchor: [30, 40],
                            popupAnchor: [6, -30] // ğŸš© [ì¶”ê°€] íŒì—… ìœ„ì¹˜ë¥¼ ì•„ì´ì½˜ ìƒë‹¨ìœ¼ë¡œ ì¡°ì •
                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: featureIcon });
                }
                
                const editorInfoHtml = castle.lastModifiedBy 
                    ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}</small>` 
                    : (castle.createdBy ? `<br><small>ìƒì„±ì: ${castle.createdBy}</small>` : '');
                
                // ğŸš© [ìˆ˜ì •] íŒì—… HTMLì— ì‚¬ì§„ URLì„ í¬í•¨í•˜ë„ë¡ ì¶”ê°€í•©ë‹ˆë‹¤.
                popupHtml = `
                    ${castleName}</b><br>
                    ${castle.desc ?? ''}
                    ${castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ""}
                    ${editorInfoHtml}
                `;
                                
                marker.bindPopup(popupHtml);
                // ğŸš© [ìˆ˜ì •] ë§ˆìš°ìŠ¤ ì˜¤ë²„ íŒì—…ì„ ì œê±°í•˜ê³ , í´ë¦­ ì‹œì—ë§Œ íŒì—…ì´ ë‚˜íƒ€ë‚˜ë„ë¡ ìˆ˜ì •
                // Use a normal function so `this` is bound to the marker instance
                marker.on('click', function (e) { 
                    // `this` is the marker that was clicked; avoid referencing outer `marker` variable
                    if (this && typeof this.openPopup === 'function') this.openPopup(); // íŒì—… ì—´ê¸°
                    map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                    if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) openCastleForm(castle._id); 
                });
                markers.push(marker);
                 marker.addTo(castleLayerGroup);
                return; // ğŸš© [ë³µì›] ë‹¤ë¥¸ ë§ˆì»¤ íƒ€ì…ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ return ì¶”ê°€
            }

            // ğŸš© [ì œê±°] ë…ë¦½ëœ ì „ì¥ ë§ˆì»¤ íƒ€ì…ì€ ì´ì œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ì—­ì‚¬ ë ˆì½”ë“œì˜ is_battle í”Œë˜ê·¸ ì‚¬ìš©)

            // ğŸš© 2. êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            if (castle.is_military_flag) {
                if (!layerVisibility.military) return;
                // ... ê¸°ì¡´ êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤ ë Œë”ë§ ë¡œì§ ìœ ì§€ ...
                // ğŸš© [ìˆ˜ì •] isWithinDuration ì²´í¬
                if (!isWithinDuration) return; 
                
                let markerLat = castle.lat;
                let markerLng = castle.lng;
                let shouldDisplay = true; // isWithinDurationì´ trueì´ë¯€ë¡œ ê¸°ë³¸ í‘œì‹œ

                if (Array.isArray(castle.path_data) && castle.path_data.length >= 2) {
                    // ê²½ë¡œê°€ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´, ê²½ë¡œ ë³´ê°„ ë¡œì§ì„ ë”°ë¦„
                    const position = getMilitaryPosition(castle.path_data, currentTotalMonths);
                    if (position) {
                        markerLat = position.lat;
                        markerLng = position.lng;
                        // shouldDisplayëŠ” ì´ë¯¸ true.
                    } else {
                        shouldDisplay = false; // ê²½ë¡œ ë²”ìœ„ ë°–ì´ë©´ ë¯¸í‘œì‹œ
                    }
                } 
                // else: ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì •ì  ìœ„ì¹˜(castle.lat/lng) ì‚¬ìš©

                if (!shouldDisplay) return;

                // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
                if (castle.custom_icon) {
                    const iconWidth = castle.icon_width || 32;
                    const iconHeight = castle.icon_height || 32;
                    const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                    const flagIcon = L.divIcon({
                        className: 'custom-icon-marker',
                        html: customIconHtml,
                        iconSize: [iconWidth, iconHeight],
                        iconAnchor: [iconWidth / 2, iconHeight],
                        popupAnchor: [0, -iconHeight]
                    });
                    marker = L.marker([markerLat, markerLng], { icon: flagIcon });
                    
                    const flagHtml = countryInfo.flag ? `<img src="${countryInfo.flag}" class="country-flag-img" style="width: 20px; height: 13px; border: 1px solid #ccc; vertical-align: middle; margin-right: 5px;">` : '';
                    const descriptionHtml = castle.desc ? `<br>ì„¤ëª…: ${castle.desc}` : '';
                    const metaInfo = [];
                    if (castle.createdBy) metaInfo.push(`ìƒì„±ì: ${castle.createdBy}`);
                    if (castle.lastModifiedBy) metaInfo.push(`ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}`);
                    const editorInfoHtml = metaInfo.length ? `<br><small>${metaInfo.join('<br>')}</small>` : '';
                    
                    popupHtml = `
                        ${flagHtml}<b>${countryName}</b>
                        ${countryInfo.ethnicity ? `<br>ë¯¼ì¡±: ${countryInfo.ethnicity}` : ''}<br>
                        ${castle.general_name ? `ì¥ìˆ˜: ${castle.general_name}<br>` : ''}
                        ${castle.troop_count ? `ë³‘ë ¥: ${Number(castle.troop_count).toLocaleString()}<br>` : ''}
                        ${castle.general_photo ? `<br><img src="${castle.general_photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ''}
                        ${descriptionHtml}${editorInfoHtml}
                    `;
                    
                    marker.bindPopup(popupHtml);
                    marker.on('mouseover', function (e) { this.openPopup(); });
                    marker.on('mouseout', function (e) { this.closePopup(); });
                    marker.on('click', (e) => { 
                        map.flyTo(e.latlng, 10);
                        if (editMode) openCastleForm(castle._id); 
                    });
                    markers.push(marker);
                    marker.addTo(castleLayerGroup);
                    return;
                }

                const general = castle.general_name || 'ì¥ìˆ˜ ë¯¸ìƒ';
                const troops = castle.troop_count ? `${Number(castle.troop_count).toLocaleString()}` : 'ë³‘ë ¥ ë¯¸ìƒ';
                const flagColor = countryInfo.color || "white";  
                const generalPhotoUrl = castle.general_photo || ''; 

                // ğŸš© [ìˆ˜ì •] ì¥ìˆ˜ ì‚¬ì§„ ìœ ë¬´ì— ë”°ë¼ ì•„ì´ì½˜ ë‚´ìš©ì„ ë‹¤ë¥´ê²Œ êµ¬ì„±í•©ë‹ˆë‹¤.
                let iconContent;
                if (generalPhotoUrl) {
                    // ì‚¬ì§„ì´ ìˆì„ ê²½ìš°: ì‚¬ì§„ê³¼ í…ìŠ¤íŠ¸ë¥¼ ì¤‘ì•™ ì •ë ¬
                    iconContent = `
                        <div style="display: flex; flex-direction: column; align-items: center; text-align: center; gap: 2px;">
                            <div class="military-flag-details">
                                <span style="color:white">${troops}</span>
                            </div>
                            <img src="${generalPhotoUrl}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 3px solid ${flagColor};">
                            <div class="military-flag-details">
                                <span style="color:white">${general}</span>
                            </div>
                        </div>`;
                } else {
                    // ì‚¬ì§„ì´ ì—†ì„ ê²½ìš°: ê¸°ì¡´ ê¹ƒë°œ ì•„ì´ì½˜ ì‚¬ìš©
                    iconContent = `
                        <div class="flag-icon-container">
                            <div class="flag-icon-symbol" style="color:${flagColor};">âš‘</div>
                            <div class="military-flag-details" style="color:${flagColor}; font-size: 10px;">${countryName} ${general}<br>${troops}</div>
                        </div>`;
                }

                const flagIcon = L.divIcon({
                    className: 'custom-flag-marker', 
                    html: `<div style="display: flex; justify-content: center; align-items: center;">${iconContent}</div>`, 
                    iconSize: [70, 60],
                    iconAnchor: [35, 60],
                    popupAnchor:  [0, -60] // ğŸš© [ìˆ˜ì •] íŒì—… ìœ„ì¹˜ë¥¼ ì•„ì´ì½˜ ìƒë‹¨ìœ¼ë¡œ ì¡°ì •
                });
                
                marker = L.marker([markerLat, markerLng], { icon: flagIcon }); 
                
                const flagHtml = countryInfo.flag ? `<img src="${countryInfo.flag}" class="country-flag-img" style="width: 20px; height: 13px; border: 1px solid #ccc; vertical-align: middle; margin-right: 5px;">` : '';

                const descriptionHtml = castle.desc ? `<br>ì„¤ëª…: ${castle.desc}` : '';
                const metaInfo = [];
                if (castle.createdBy) metaInfo.push(`ìƒì„±ì: ${castle.createdBy}`);
                if (castle.lastModifiedBy) metaInfo.push(`ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}`);
                const editorInfoHtml = metaInfo.length ? `<br><small>${metaInfo.join('<br>')}</small>` : '';

                popupHtml = `
                    ${flagHtml}<b>${countryName}</b>
                    ${countryInfo.ethnicity ? `<br>ë¯¼ì¡±: ${countryInfo.ethnicity}` : ''}<br>
                    ì¥ìˆ˜: ${general} <br> 
                    ë³‘ë ¥: ${troops} <br> 
                    ${generalPhotoUrl ? `<br><img src="${generalPhotoUrl}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ''}
                    ${descriptionHtml}${editorInfoHtml}
                `;
                
                marker.bindPopup(popupHtml);
                                // íŒì—… ì´ë²¤íŠ¸ ì¶”ê°€
                marker.on('mouseover', function (e) { this.openPopup(); });
                marker.on('mouseout', function (e) { this.closePopup(); });
                marker.on('click', (e) => { 
                    map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                    if (editMode) openCastleForm(castle._id); 
                });
                markers.push(marker);
                 marker.addTo(castleLayerGroup);
                return; // ğŸš© [ë³µì›] êµ°ëŒ€ ë§ˆì»¤ê°€ ì¼ë°˜ ì„± ë§ˆì»¤ë¡œ ë®ì–´ì”Œì›Œì§€ëŠ” ê²ƒì„ ë°©ì§€
            }


            // 4. ì „ì¥ ë§ˆì»¤ (ë…ë¦½ íƒ€ì… ë˜ëŠ” ì—­ì‚¬ ê¸°ë¡ì˜ ì „ì¥ ì²´í¬ë°•ìŠ¤)
        // ğŸš© ì „ì¥ì€ ë‘ ê°€ì§€ í˜•íƒœë¡œ ì¡´ì¬: 1) castle.is_battle=true (ë…ë¦½ ë§ˆì»¤), 2) activeHistoryRecord.is_battle=true (ì—­ì‚¬ ê¸°ë¡ì˜ ì²´í¬ë°•ìŠ¤)
        // ğŸš© ì „ì¥ì€ ì„±/ë„ì‹œ ë ˆì´ì–´ì— í¬í•¨ë˜ì–´ í‘œì‹œë¨ (ë³„ë„ í† ê¸€ ì—†ìŒ)
        const isBattleMarker = castle.is_battle || activeHistoryRecord?.is_battle;
        if (isBattleMarker && layerVisibility.city) {
            console.log('ğŸ’¥ ì „ì¥ ë§ˆì»¤ ë Œë”ë§:', castleName, 'castle.is_battle:', castle.is_battle, 'history.is_battle:', activeHistoryRecord?.is_battle);
            
            // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
            if (castle.custom_icon) {
                const iconWidth = castle.icon_width || 32;
                const iconHeight = castle.icon_height || 32;
                const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                const battleIcon = L.divIcon({
                    className: 'custom-icon-marker',
                    html: customIconHtml,
                    iconSize: [iconWidth, iconHeight],
                    iconAnchor: [iconWidth / 2, iconHeight],
                    popupAnchor: [0, -iconHeight]
                });
                marker = L.marker([castle.lat, castle.lng], { icon: battleIcon });
            } else {
                const battleIcon = L.divIcon({
                    className: 'battle-marker',
                    html: `<div style="line-height: 0.8;">ğŸ’¥</div><div class="battle-marker-text">${castleName}</div>`,
                    iconSize: [80, 40],
                    iconAnchor: [40, 30],
                    popupAnchor: [6, -25]
                });
                marker = L.marker([castle.lat, castle.lng], { icon: battleIcon });
            }
            
            const editorInfoHtml = castle.lastModifiedBy 
                ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}</small>` 
                : (castle.createdBy ? `<br><small>ìƒì„±ì: ${castle.createdBy}</small>` : '');
            
            popupHtml = `
                <b>ì „ì¥: ${castleName}</b><br>
                ê¸°ê°„: ${builtText} ~ ${destroyedText}<br>
                ì„¤ëª…: ${castle.desc ?? ''}
                ${castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ""}
                ${editorInfoHtml}
            `;
            
            marker.bindPopup(popupHtml);
            marker.on('mouseover', function (e) { this.openPopup(); });
            marker.on('mouseout', function (e) { this.closePopup(); });
            marker.on('click', (e) => { 
                map.flyTo(e.latlng, 10);
                if (editMode) openCastleForm(castle._id); 
            });
            markers.push(marker);
            marker.addTo(castleLayerGroup);
            return; // ì „ì¥ì´ë©´ ë” ì´ìƒ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
        }
        
        // 5. ì¼ë°˜ ì„±/ë„ì‹œ ë§ˆì»¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        if (!layerVisibility.city) return;
        if (!isWithinDuration) return;
        
        const currentCountry = countryInfo; // â¬…ï¸ ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜í•œ countryInfo ì‚¬ìš©
        if (!currentCountry) return;
        
        // ğŸš© êµ­ê°€ ì¡´ì† ê¸°ê°„ ì²´í¬
        const countryStartCombined = yearMonthToTotalMonths(currentCountry.start, currentCountry.start_month);
        const countryEndCombined = (currentCountry.end === null || isNaN(currentCountry.end)) ? Infinity : yearMonthToTotalMonths(currentCountry.end, currentCountry.end_month); 
        
        if (!(countryStartCombined <= currentTotalMonths && countryEndCombined >= currentTotalMonths)) return; 

        //const king = getKingByYear(countryName, year, month); // âœ… ìˆ˜ì •: countryName ì‚¬ìš©
     
        //    const builtText = `${castleBuiltYear}ë…„ ${castle.built_month || 1}ì›”`;
        //    const destroyedText = castle.destroyed === null ? 'í˜„ì¬' : `${castle.destroyed}ë…„ ${castle.destroyed_month || 12}ì›”`;
            
            let kingHtml = king ? `<br><b>ì™•:</b> ${king.name} (${king.start}ë…„ ${king.start_month||1}ì›” ~ ${king.end === null ? 'í˜„ì¬' : `${king.end}ë…„ ${king.end_month||1}ì›”`})` : "";
           // ğŸš© [ìˆ˜ì •] êµ­ê¸° ì´ë¯¸ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜ ì¶”ê°€
        const flagHtml = currentCountry.flag ?
            `<img src="${currentCountry.flag}" class="country-flag-img" style="width: 20px; height: 13px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;">` : '';
        const countryEthnicity = currentCountry.ethnicity ? `<br>ë¯¼ì¡±: ${currentCountry.ethnicity}` : '';
        const editorInfoHtml = castle.lastModifiedBy 
            ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}</small>` 
            : (castle.createdBy ? `<br><small>ìƒì„±ì: ${castle.createdBy}</small>` : '');
        
        popupHtml = ` 
                <b>${castleName}</b>
                <br>${flagHtml} ${countryName}${countryEthnicity}<br>
                ì¡´ì†: ${builtText} ~ ${destroyedText}` 
                + (castle.desc ? `<br><span>${castle.desc}</span>` : "") 
                + (castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : "") 
                + kingHtml
                + editorInfoHtml;


            // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì¼ë°˜/ìˆ˜ë„ êµ¬ë¶„ ì—†ì´ ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ì‚¬ìš©
            if (castle.custom_icon) {
                const iconWidth = castle.icon_width || 32;
                const iconHeight = castle.icon_height || 32;
                const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                const customIcon = L.divIcon({
                    className: 'custom-icon-marker',
                    html: customIconHtml,
                    iconSize: [iconWidth, iconHeight],
                    iconAnchor: [iconWidth / 2, iconHeight],
                    popupAnchor: [0, -iconHeight]
                });
                marker = L.marker([castle.lat, castle.lng], { icon: customIcon, zIndexOffset: activeHistoryRecord.is_capital ? 1000 : 0 });
            } else if (currentCountry.flag && !activeHistoryRecord.is_capital) { // ğŸš© [ìˆ˜ì •] activeHistoryRecord ì‚¬ìš©
              // ... ê¸°ì¡´ ê¹ƒë°œ + ì´ë¦„ ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
          // ğŸš© [ìˆ˜ì •] ì´ë¦„í‘œ ë°°ê²½ ì´ë¯¸ì§€ ì ìš©
          const flagAndNameIconHtml = `
            <div style="display: flex; align-items: center; gap: 3px; transform: scale(var(--marker-scale, 1));">
              <img src="${currentCountry.flag}" class="country-flag-img" style="width: 18px; height: 12px; border: 1px solid #fff;">
              <span class="city-name" style="color:${currentCountry.color || 'white'}; font-weight: bold; font-size: 10px; white-space: nowrap; text-shadow: -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000, 0px 0px 3px #000, 0px 0px 5px #000;">${castleName}</span>
            </div>
              `;
              const customIcon = L.divIcon({
                  className: 'custom-flag-name-marker', 
                  html: flagAndNameIconHtml,
                  iconAnchor: [10, -5]
              });
              marker = L.marker([castle.lat, castle.lng], { icon: customIcon });
            } else if (activeHistoryRecord.is_capital) { // ğŸš© [ì œê±°] ì „ì¥ ì²´í¬ëŠ” ì´ë¯¸ ìœ„ì—ì„œ(êµ­ê°€ ì²´í¬ ì „ì—) ì²˜ë¦¬ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìˆ˜ë„/ì¼ë°˜ ì„±ë§Œ ì²˜ë¦¬
              // ... ê¸°ì¡´ ì™•ì„± ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
              if (currentCountry.flag) {
            const capitalWithFlagIconHtml = `<div class="capital-marker" style="display: flex; flex-direction: column; align-items: center;">
                <img src="${currentCountry.flag}" class="country-flag-img" style="width: 30px; height: 20px; border: 1px solid #fff; margin-bottom: 5px;">
                <span class="city-name">${currentCountry.name} ìˆ˜ë„<br>${castleName}</span>
            </div>`;
                const customIcon = L.divIcon({
                  className: 'custom-capital-flag-marker',
                  html: capitalWithFlagIconHtml,
                  iconAnchor: [6, -2] 
                });
                marker = L.marker([castle.lat, castle.lng], { icon: customIcon, zIndexOffset: 1000 });
              } else { 
            const capitalIcon = L.divIcon({
              className: 'capital-marker',
              html: `
                <span style="color:${currentCountry.color || 'white'};">â–£</span><span class="city-name">${currentCountry.name} ìˆ˜ë„<br>${castleName}</span>
                  `,
                  iconSize: [50, 50],
                  iconAnchor: [25, 4]
                });
                marker = L.marker([castle.lat, castle.lng], { icon: capitalIcon, zIndexOffset: 1000 });
              }
            } else { 
              // ... ê¸°ì¡´ ì¼ë°˜ ì„±/ë„ì‹œ ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
          // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¼ë°˜ì„± ë§ˆì»¤ë¥¼ ì›(dot)ì—ì„œ ì—­ì‚¼ê°í˜•(â–¼)ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
          const dotColor = currentCountry.color || 'white'; 
              const markerHtml = `<div style="position: relative; display: flex; flex-direction: column; align-items: center; transform: scale(var(--marker-scale, 1));">
                                    <div style="width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 10px solid ${dotColor}; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.8));"></div><div class="city-marker-text" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color:${dotColor}; font-weight: bold; font-size: 10px; white-space: nowrap; text-shadow: -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000, 0px 0px 3px #000, 0px 0px 5px #000;">${castleName}</div>
                                  </div>`;
              const customIcon = L.divIcon({
                className: 'custom-city-marker',
                html: markerHtml,
                iconAnchor: [6, 6],
                popupAnchor: [0.5, -5]
              });
              marker = L.marker([castle.lat, castle.lng], { icon: customIcon });
            }
        
            if (marker) {
              
              
              marker.bindPopup(popupHtml);
              // [ì¶”ê°€] ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ íŒì—… ì—´ê¸°
              marker.on('mouseover', function (e) {
                this.openPopup();
              });
              // [ì¶”ê°€] ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ íŒì—… ë‹«ê¸°
              marker.on('mouseout', function (e) {
                this.closePopup();
              });
              
              marker.on('click', (e) => { 
                map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                if (editMode) openCastleForm(castle._id); 
              });
              markers.push(marker);
              marker.addTo(castleLayerGroup);
              marker = null; 
            }
        });

    }

    window.findPhantomTerritories = function(options = {}) {
        const { highlight = false } = options;
        const sources = Object.values(heatmapSourceDebug || {});
        if (!sources.length) {
            console.log('%cê°•ì—­ íˆíŠ¸ë§µì— ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ê°•ì—­ ë ˆì´ì–´ê°€ êº¼ì ¸ ìˆê±°ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ìƒíƒœ)', 'color: #999');
            return [];
        }

        const phantomEntries = sources.filter(entry => {
            if (!entry.contributesToHeatmap) return false;
            if (!entry.matchesSelectedCountry) return true;
            if (!entry.layerVisible) return true;
            if ((entry.castleType === 'city' || entry.castleType === 'label') && !entry.countryActive) return true;
            if (entry.countryInfoMissing) return true;
            return false;
        });

        if (!phantomEntries.length) {
            console.log('%cê°•ì—­ë§Œ í‘œì‹œë˜ê³  ê°ì²´ê°€ ì—†ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'color: #4caf50');
        } else {
            console.table(phantomEntries.map(entry => ({
                ì´ë¦„: entry.name,
                ìœ í˜•: entry.castleType,
                êµ­ê°€: entry.countryName,
                ìœ„ë„: entry.lat,
                ê²½ë„: entry.lng,
                ì‚¬ìœ : getPhantomReason(entry)
            })));
        }

        if (highlight && phantomEntries.length) {
            if (!phantomDebugLayerGroup) {
                phantomDebugLayerGroup = L.layerGroup().addTo(map);
            }
            phantomDebugLayerGroup.clearLayers();
            phantomEntries.forEach(entry => {
                const circle = L.circleMarker([entry.lat, entry.lng], {
                    radius: 14,
                    color: '#ff2fbf',
                    weight: 2,
                    fillColor: '#ff2fbf',
                    fillOpacity: 0.45,
                    pane: 'markerPane'
                }).bindTooltip(`${entry.name} (${entry.countryName})\n${getPhantomReason(entry)}`, {
                    direction: 'top',
                    sticky: true
                });
                phantomDebugLayerGroup.addLayer(circle);
            });

            if (phantomEntries.length === 1) {
                map.flyTo([phantomEntries[0].lat, phantomEntries[0].lng], Math.max(map.getZoom(), 7));
            } else {
                const bounds = L.latLngBounds(phantomEntries.map(e => [e.lat, e.lng]));
                if (bounds.isValid()) {
                    map.fitBounds(bounds.pad(0.35));
                }
            }
        }

        return phantomEntries;
    };

    window.clearPhantomHighlights = function() {
        if (phantomDebugLayerGroup) {
            phantomDebugLayerGroup.clearLayers();
        }
    };

function getCountryInfoById(id) {
    // ğŸš© [í•„ìˆ˜ í™•ì¸] idê°€ ObjectId ê°ì²´ì¼ ìˆ˜ë„, ë¬¸ìì—´ì¼ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ, toString()ìœ¼ë¡œ ë¹„êµ
    if (!id) return null;
    return countries.find(c => c._id === id || c._id.toString() === id);
}
    // --- 5. ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™” ---
    function updateDrawings() {
        drawnItems.clearLayers();
    }
    async function fetchData(endpoint) {
      try {
        const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (!response.ok) {
          throw new Error(`${endpoint} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
        }
        return await response.json();
      } catch (error) {
        console.error(error);
        return []; 
      }
    }
    
        // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateCitySelectForEdit() {
        const select = citySelectForEdit;
        select.innerHTML = '<option value="">-- ë„ì‹œ/ì„± ì„ íƒ --</option>'; // ì´ˆê¸°í™”
        // êµ°ëŒ€, ìì—°, ì§€ëª… íƒ€ì…ì´ ì•„ë‹Œ ì„±/ë„ì‹œë§Œ ëª©ë¡ì— ì¶”ê°€
        const filteredCastles = castles.filter(c => !c.is_military_flag && !c.is_natural_feature && !c.is_label)
                                       .sort((a, b) => a.name.localeCompare(b.name, 'ko'));
        filteredCastles.forEach(castle => {
            select.innerHTML += `<option value="${castle._id}">${castle.name} (${getCountryInfoById(castle.country_id)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'})</option>`;
        });
    }

    async function initialize() {
      console.log("ë°ì´í„° ì´ˆê¸°í™” ì¤‘...");

      // ğŸš© Promise.allì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œí•˜ê³ , ëª¨ë‘ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
      const [castlesData, historyData, countriesData, eventsData, kingsDataResult, drawingsData] = await Promise.all([
          fetchData('castle'),
          fetchData('history'),
          fetchData('countries'),
          fetchData('events'),
          fetchData('kings'),
          fetchData('drawings')
      ]);

      // ğŸš© Promise.allë¡œ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹í•©ë‹ˆë‹¤.
      // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê¸°ì¡´ ì„± ê°ì²´ì— history ë°°ì—´ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆì„ ê²½ìš°, ê¸°ë³¸ history ê¸°ë¡ì„ ìƒì„±í•˜ì—¬ í˜¸í™˜ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤.
      castles = castlesData.map(castle => {
          let processedHistory;
          const hasHistory = castle.history && Array.isArray(castle.history) && castle.history.length > 0;

          if (hasHistory) {
              // history ë°°ì—´ì´ ìˆì–´ë„, ê° ê¸°ë¡ì˜ í•„ìˆ˜ í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ìµœìƒìœ„ í•„ë“œë¡œ ì±„ì›ë‹ˆë‹¤.
              // Use nullish checks and ensure numeric types for years/months
              processedHistory = castle.history.map(h => {
                  const parsedStartYear = (h.start_year !== undefined && h.start_year !== null && h.start_year !== '') ? parseInt(h.start_year) : (castle.built_year !== undefined && castle.built_year !== null ? parseInt(castle.built_year) : -4000);
                  const parsedStartMonth = (h.start_month !== undefined && h.start_month !== null && h.start_month !== '') ? parseInt(h.start_month) : (castle.built_month !== undefined && castle.built_month !== null ? parseInt(castle.built_month) : 1);
                  const parsedEndYear = (h.end_year !== undefined && h.end_year !== null && h.end_year !== '') ? parseInt(h.end_year) : null;
                  const parsedEndMonth = (h.end_month !== undefined && h.end_month !== null && h.end_month !== '') ? parseInt(h.end_month) : (castle.destroyed_month !== undefined && castle.destroyed_month !== null ? parseInt(castle.destroyed_month) : 12);

                  // If country_id was provided as a name by mistake, try to resolve to id
                  let resolvedCountryId = h.country_id || castle.country_id || '';
                  if (resolvedCountryId && typeof resolvedCountryId !== 'string') resolvedCountryId = resolvedCountryId.toString();
                  if (!resolvedCountryId && h.country) {
                      // Some legacy records may have `country` as name; try to resolve
                      const match = countries.find(c => c.name === h.country);
                      if (match) resolvedCountryId = match._id;
                  }

                  return {
                      name: h.name ?? castle.name ?? '',
                      country_id: resolvedCountryId || '',
                      start_year: parsedStartYear,
                      start_month: parsedStartMonth,
                      end_year: parsedEndYear,
                      end_month: parsedEndMonth,
                      is_capital: h.is_capital !== undefined ? !!h.is_capital : !!castle.is_capital,
                      is_battle: h.is_battle !== undefined ? !!h.is_battle : false
                  };
              });
          } else {
              // Create a default history entry using existing fields
              processedHistory = [{
                  name: castle.name || '',
                  country_id: castle.country_id || '',
                  start_year: castle.built_year || -4000,
                  start_month: castle.built_month || 1,
                  end_year: castle.destroyed_year,
                  end_month: castle.destroyed_month || 12,
                  is_capital: castle.is_capital || false,
                  is_battle: castle.is_battle || false
              }];
          }

          // If castle.is_capital is true, but no history record is marked as capital, mark the first one.
          if (castle.is_capital && !processedHistory.some(h => h.is_capital)) {
              if (processedHistory.length > 0) {
                  processedHistory[0].is_capital = true;
              }
          }

          return { ...castle, history: processedHistory };
      });
      history = historyData;
      countries = countriesData;
      events = eventsData;
      const kingsData = kingsDataResult; // kingsDataëŠ” ì•„ë˜ì—ì„œ ë³„ë„ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ kingsDataResultë¡œ ë°›ìŠµë‹ˆë‹¤.
      drawings = drawingsData;

      // ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ê³¼ ì´ë²¤íŠ¸ë¥¼ í•©ì³ì„œ ì‹œê°„ ëª©ë¡ ìƒì„±
      const historyTimes = historyData.map(h => yearMonthToTotalMonths(h.year, h.month || 1));
      const eventTimes = eventsData.map(e => yearMonthToTotalMonths(e.year, e.month || 1));
      // Setì„ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µëœ ì‹œê°„ì„ ì œê±°í•˜ê³ , ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
      historyEventTimes = [...new Set([...historyTimes, ...eventTimes])].sort((a, b) => a - b);

      // ğŸš© [ìˆ˜ì •] ì´ì „/ë‹¤ìŒ ì—­ì‚¬ ì´ë™ í•¨ìˆ˜ë¡œ ì¶”ì¶œ
      const gotoPrevHistory = () => {
          const year = parseInt(yearInput.value);
          const month = parseInt(monthInput.value);
          const currentTotalMonths = yearMonthToTotalMonths(year, month);
          
          // í˜„ì¬ ì‹œì ë³´ë‹¤ ì´ì „ì˜ ê¸°ë¡ë“¤ ì¤‘ ê°€ì¥ ë‚˜ì¤‘ì˜ ì‹œê°„ì„ ì°¾ìŠµë‹ˆë‹¤.
          const prevTime = historyEventTimes.filter(t => t < currentTotalMonths).pop();

          if (prevTime !== undefined) {
              const { year: targetYear, month: targetMonth } = totalMonthsToYearMonth(prevTime);
              updateTime(targetYear, targetMonth);
          }
      };

      const gotoNextHistory = () => {
          const year = parseInt(yearInput.value);
          const month = parseInt(monthInput.value);
          const currentTotalMonths = yearMonthToTotalMonths(year, month);

          // í˜„ì¬ ì‹œì ë³´ë‹¤ ì´í›„ì˜ ê¸°ë¡ë“¤ ì¤‘ ê°€ì¥ ì²˜ìŒì˜ ì‹œê°„ì„ ì°¾ìŠµë‹ˆë‹¤.
          const nextTime = historyEventTimes.find(t => t > currentTotalMonths);

          if (nextTime !== undefined) {
              const { year: targetYear, month: targetMonth } = totalMonthsToYearMonth(nextTime);
              updateTime(targetYear, targetMonth);
          }
      };

      const openHistoryForm = () => {
          editingHistoryKey = null;
          closeAllFormsExcept('historyForm');
          document.getElementById('historyForm').style.display = 'block';
          document.getElementById('addHistoryForm').reset();
          document.getElementById('deleteHistoryBtn').style.display = 'none';
          document.getElementById('historyYear').value = yearInput.value;
          document.getElementById('historyMonth').value = monthInput.value;
          document.getElementById('saveHistoryBtn').textContent = 'ì €ì¥';
      };

      // ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ ì´ì „/ë‹¤ìŒ/ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
      const mapPrevHistoryBtn = document.getElementById('map-prev-history-btn');
      const mapNextHistoryBtn = document.getElementById('map-next-history-btn');
      const mapOpenHistoryFormBtn = document.getElementById('map-open-history-form-btn');
      const mapHistoryToggleBtn = document.getElementById('map-history-toggle-btn');
      
      if (mapPrevHistoryBtn) {
          mapPrevHistoryBtn.addEventListener('click', gotoPrevHistory);
      }
      
      if (mapNextHistoryBtn) {
          mapNextHistoryBtn.addEventListener('click', gotoNextHistory);
      }
      
      if (mapOpenHistoryFormBtn) {
          mapOpenHistoryFormBtn.addEventListener('click', openHistoryForm);
      }
      
      // ğŸš© [ì¶”ê°€] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ê´€ë ¨ ê¸°ëŠ¥
      const mapHistoryPanel = document.getElementById('map-history-panel');
      const mapHistoryResizer = document.getElementById('map-history-resizer');
      
      // íŒ¨ë„ì˜ ì›ë˜ ë„ˆë¹„ë¥¼ ì €ì¥í•  ë³€ìˆ˜ (ì „ì—­ìœ¼ë¡œ ì„ ì–¸í•˜ì—¬ í† ê¸€ê³¼ ë¦¬ì‚¬ì´ì €ì—ì„œ ê³µìœ )
      let savedPanelWidth = 320; // ê¸°ë³¸ê°’
      
      // ğŸš© [ì¶”ê°€] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ í† ê¸€ ê¸°ëŠ¥
      if (mapHistoryToggleBtn) {
          // ğŸš© [ì¶”ê°€] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ì˜ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì§€ë„ë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë°©ì§€ (ë¦¬ì‚¬ì´ì € ì œì™¸)
          if (mapHistoryPanel) {
              // mousedownì€ ë¦¬ì‚¬ì´ì €ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œì™¸
              // ëŒ€ì‹  ë‹¤ë¥¸ ìš”ì†Œë“¤ë§Œ ì´ë²¤íŠ¸ ì°¨ë‹¨
              mapHistoryPanel.addEventListener('click', (e) => {
                  // ë¦¬ì‚¬ì´ì €ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì „íŒŒ ì°¨ë‹¨
                  if (e.target.id !== 'map-history-resizer') {
                      e.stopPropagation();
                  }
              });
              mapHistoryPanel.addEventListener('dblclick', (e) => {
                  // ë¦¬ì‚¬ì´ì €ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì „íŒŒ ì°¨ë‹¨
                  if (e.target.id !== 'map-history-resizer') {
                      e.stopPropagation();
                  }
              });
              
              // ğŸš© [ì¶”ê°€] ë§ˆìš°ìŠ¤ íœ  ìŠ¤í¬ë¡¤ ì‹œ ì§€ë„ì— ì˜í–¥ ì—†ë„ë¡ ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
              mapHistoryPanel.addEventListener('wheel', (e) => {
                  e.stopPropagation();
              }, { passive: true });
          }
          
          // ğŸš© [ì¶”ê°€] ì´ˆê¸° ìƒíƒœ ì„¤ì •: PCëŠ” í¼ì³ì§„ ìƒíƒœ, ëª¨ë°”ì¼ì€ ì ‘íŒ ìƒíƒœ
          const isMobile = document.body.classList.contains('force-mobile');
          
          if (!isMobile) {
              // PC í™”ë©´: ê¸°ë³¸ì ìœ¼ë¡œ í¼ì³ì§„ ìƒíƒœ
              mapHistoryPanel.classList.add('expanded');
              mapHistoryToggleBtn.innerHTML = 'â—†';
              mapHistoryToggleBtn.title = 'íŒ¨ë„ ì ‘ê¸°';
          } else {
              // ëª¨ë°”ì¼: ê¸°ë³¸ì ìœ¼ë¡œ ì ‘íŒ ìƒíƒœ
              mapHistoryPanel.classList.remove('expanded');
              mapHistoryToggleBtn.innerHTML = 'â—†';
              mapHistoryToggleBtn.title = 'íŒ¨ë„ í¼ì¹˜ê¸°';
          }
          
          mapHistoryToggleBtn.addEventListener('click', (e) => {
              console.log('Toggle button clicked'); // ë””ë²„ê¹…ìš©
              e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
              
              // expanded í´ë˜ìŠ¤ í† ê¸€
              const isExpanded = mapHistoryPanel.classList.contains('expanded');
              
              if (isExpanded) {
                  // ì¶•ì†Œ - í˜„ì¬ ë„ˆë¹„ë¥¼ ì €ì¥í•˜ê³  ìµœì†Œ í¬ê¸°ë¡œ
                  savedPanelWidth = mapHistoryPanel.offsetWidth;
                  mapHistoryPanel.classList.remove('expanded');
                  mapHistoryPanel.style.setProperty('width', '32px', 'important'); // ìµœì†Œ í¬ê¸°
                  mapHistoryToggleBtn.innerHTML = 'â—†';
                  mapHistoryToggleBtn.title = 'íŒ¨ë„ í¼ì¹˜ê¸°';
              } else {
                  // í¼ì¹˜ê¸° - ì €ì¥ëœ ë„ˆë¹„ë¡œ ë³µì›
                  mapHistoryPanel.classList.add('expanded');
                  mapHistoryPanel.style.setProperty('width', `${savedPanelWidth}px`, 'important');
                  mapHistoryToggleBtn.innerHTML = 'â—†';
                  mapHistoryToggleBtn.title = 'íŒ¨ë„ ì ‘ê¸°';
              }
          });
      }

      // ğŸš© [ì¶”ê°€] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥
      if (mapHistoryPanel && mapHistoryResizer) {
          let isResizing = false;
          let startX = 0;
          let startWidth = 0;
          
          // ë¦¬ì‚¬ì´ì €ì— ì§ì ‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          mapHistoryResizer.addEventListener('mousedown', (e) => {
              console.log('Resizer mousedown'); // ë””ë²„ê¹…ìš©
              isResizing = true;
              startX = e.clientX;
              startWidth = mapHistoryPanel.offsetWidth;
              
              // ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
              e.preventDefault();
              e.stopPropagation(); // ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
              document.body.style.cursor = 'ew-resize';
              document.body.style.userSelect = 'none';
          }, true); // capture phaseì—ì„œ ì´ë²¤íŠ¸ ì¡ê¸°
          
          document.addEventListener('mousemove', (e) => {
              if (!isResizing) return;
              
              e.preventDefault();
              
              // ì™¼ìª½ìœ¼ë¡œ ë“œë˜ê·¸í•˜ë©´ ë„ˆë¹„ ì¦ê°€, ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë“œë˜ê·¸í•˜ë©´ ë„ˆë¹„ ê°ì†Œ
              const deltaX = startX - e.clientX;
              const newWidth = Math.max(200, Math.min(800, startWidth + deltaX));
              
              // width ì§ì ‘ ì„¤ì • (CSS í´ë˜ìŠ¤ ì˜¤ë²„ë¼ì´ë“œ)
              mapHistoryPanel.style.setProperty('width', `${newWidth}px`, 'important');
          });
          
          document.addEventListener('mouseup', () => {
              if (isResizing) {
                  console.log('Resizing ended'); // ë””ë²„ê¹…ìš©
                  isResizing = false;
                  document.body.style.cursor = '';
                  document.body.style.userSelect = '';
                  
                  // ë¦¬ì‚¬ì´ì§•ì´ ëë‚¬ì„ ë•Œ í˜„ì¬ ë„ˆë¹„ë¥¼ ì €ì¥ (ê°ì¶”ê¸°/í¼ì¹˜ê¸° ì‹œ ë³µì›ìš©)
                  if (mapHistoryPanel.classList.contains('expanded')) {
                      savedPanelWidth = mapHistoryPanel.offsetWidth;
                      console.log('Saved panel width:', savedPanelWidth); // ë””ë²„ê¹…ìš©
                  }
              }
          });
      }

      // ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ ë³€ê²½ ì‹œ ë§ˆì»¤ í¬ê¸° ì¡°ì ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      map.on('zoomend', () => {
          const zoom = map.getZoom();
          let scale = 1.0;

          // ì¤Œ ë ˆë²¨ì— ë”°ë¼ scale ê°’ ê²°ì • (100km ì§€ì ì—ì„œ í°íŠ¸ 2 ì •ë„ í‚¤ì›€)
          if (zoom <= 4) scale = 0.5;
          else if (zoom === 5) scale = 0.7;
          else if (zoom === 6) scale = 0.9;  // 100km ì§€ì  - í°íŠ¸ í¬ê²Œ
          else if (zoom === 7) scale = 1.1;  // 100km ì§€ì  - í°íŠ¸ í¬ê²Œ
          else if (zoom === 8) scale = 1.0;
          else if (zoom >= 9) scale = 1.2;

          // map ì»¨í…Œì´ë„ˆì— CSS ë³€ìˆ˜(--marker-scale) ì„¤ì •
          const mapContainer = map.getContainer();
          mapContainer.style.setProperty('--marker-scale', scale);
      });

      // ì´ˆê¸° ë¡œë“œ ì‹œ ë§ˆì»¤ í¬ê¸° ì„¤ì •
      map.fire('zoomend');

      // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      if (countryFilterSelect) {
          countryFilterSelect.onchange = (e) => {
              selectedCountryId = e.target.value;
              // ğŸš© [ì¶”ê°€] í•„í„° í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš©
              if (selectedCountryId && selectedCountryId !== 'all') {
                  countryFilterSelect.classList.add('filter-active');
              } else {
                  countryFilterSelect.classList.remove('filter-active');
              }
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
              // êµ­ê°€ í•„í„° ë³€ê²½ ì‹œ ì™• ëª©ë¡ë„ ì—…ë°ì´íŠ¸í•˜ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤.
              updateKingLabel(year, month);
              // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„° ë³€ê²½ ì‹œ ì—°ëŒ€í‘œë„ ë‹¤ì‹œ ê·¸ë¦¬ë„ë¡ í˜¸ì¶œ
              createDynastyTimeline();
          };
      }
            // ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ ë³€ê²½ ì‹œ ê°•ì—­(íˆíŠ¸ë§µ)ì„ ë‹¤ì‹œ ê·¸ë¦¬ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      // ğŸš© [ìˆ˜ì •] ë¶ˆí•„ìš”í•œ updateMap í˜¸ì¶œì„ ì œê±°í•˜ì—¬ ì´ë²¤íŠ¸ ì¶©ëŒ ë° ë©ˆì¶¤ í˜„ìƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
      map.on('zoomend', function() {
          const currentZoom = map.getZoom();
          const radius = 80 * Math.pow(2, currentZoom - 5); // ğŸš© [ìˆ˜ì •] ë°˜ê²½ì„ 80ìœ¼ë¡œ ìƒí–¥ ì¡°ì •
          const blur = 0; // ë¸”ëŸ¬ íš¨ê³¼ ì œê±°
          // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¤Œ ë ˆë²¨ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ëª¨ë“  íˆíŠ¸ë§µ ë ˆì´ì–´ì˜ ë°˜ê²½ê³¼ ë¸”ëŸ¬ë¥¼ ë‹¤ì‹œ ì„¤ì •í•©ë‹ˆë‹¤.
          for (const countryId in heatmapLayers) {
              if (!Object.prototype.hasOwnProperty.call(heatmapLayers, countryId)) continue;
              const layer = heatmapLayers[countryId];
              if (!layer || !map.hasLayer(layer)) continue;
              layer.setOptions({ radius, blur });
          }
          const { year, month } = getCurrentYearMonth(); // ğŸš© [ì¶”ê°€] ì™• ëª©ë¡ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
          updateKingLabel(year, month); // ğŸš© [ì¶”ê°€] ì™• ëª©ë¡ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
      });
      
      // ğŸš© [ì¶”ê°€] ì†ë„ ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
      playbackSpeedSlider.oninput = () => {
          speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
          // ì¬ìƒ ì¤‘ì´ë¼ë©´ ì†ë„ë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë©ˆì·„ë‹¤ê°€ ë‹¤ì‹œ ì‹œì‘)
          if (playInterval) {
              stopPlayback();
              startPlayback();
          }
      };

      countryColors = {};
      countries.forEach(c => { countryColors[c.name] = c.color; });
      countries.sort((a, b) => { return a.name.localeCompare(b.name, 'ko'); });
      
    kings = {}; 
    if (Array.isArray(kingsData)) {
      kingsData.forEach(item => {
        // ğŸš© ìˆ˜ì •: MongoDB kings ì»¬ë ‰ì…˜ì˜ country_idë¥¼ í‚¤ë¡œ ì‚¬ìš©
        if (item.country_id && Array.isArray(item.kings)) {
             kings[item.country_id] = item.kings; // <- Use country_id as the key
        }
      });
    }

      // ğŸš© [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ê¸°ëŠ¥ í™œì„±í™”
      const logoutBtnHeader = document.getElementById('logoutBtnHeader');
      logoutBtnHeader.addEventListener('click', () => {
          if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              // ğŸš© [ìˆ˜ì •] ë‘ ì €ì¥ì†Œì˜ í† í°ì„ ëª¨ë‘ ì‚­ì œ
              localStorage.removeItem('token');
              sessionStorage.removeItem('token');
              localStorage.removeItem('token');
              window.location.href = 'login.html';
          }
      });

      // ğŸš© [ìˆ˜ì •] ê³ ëŒ€ ì§€ë„ ë²„íŠ¼ ë™ì  ìƒì„± ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      const mapButtonContainer = document.getElementById('ancient-map-button-container');
      mapButtonContainer.innerHTML = ''; // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
      ancientMaps.forEach(mapInfo => {
          const button = document.createElement('button');
          button.id = mapInfo.id;
          button.className = 'primary';
          button.textContent = mapInfo.name;
          // ğŸš© [ì¶”ê°€] ë²„íŠ¼ í¬ê¸°ë¥¼ ì ˆë°˜ìœ¼ë¡œ ì¤„ì„
          button.style.cssText = 'padding: 3px 6px; font-size: 10px; white-space: nowrap;';
          
          button.addEventListener('click', () => {
              const newTab = window.open();
              newTab.document.write(`
                  <!DOCTYPE html>
                  <html lang="ko"><head><meta charset="UTF-8"><title>${mapInfo.name}</title>
                  <style>
                      body { margin: 0; background-color: #111; text-align: center; }
                      img { max-width: 100%; height: auto; cursor: zoom-in; transition: max-width 0.2s ease-in-out; }
                      img.zoomed { max-width: none; cursor: zoom-out; }
                  </style></head>
                  <body><img src="${mapInfo.url}" alt="${mapInfo.name}" onclick="this.classList.toggle('zoomed')"></body>
                  </html>
              `);
              newTab.document.close();
          });
          mapButtonContainer.appendChild(button);
      });

      updateCountrySelect();
      populateCountryFilter(); // ğŸš© [ìˆ˜ì •] í•¨ìˆ˜ ì´ë¦„ ë³€ê²½ì— ë”°ë¥¸ í˜¸ì¶œ ìˆ˜ì •
      populateKingCountrySelect(); // ğŸš© [ìˆ˜ì •] í•¨ìˆ˜ ì´ë¦„ ë³€ê²½ì— ë”°ë¥¸ í˜¸ì¶œ ìˆ˜ì •
      populateCitySelectForEdit(); // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
      createSliderTicks();
      const initialTotalMonths = parseInt(combinedSlider.value);
      const { year: initialYear, month: initialMonth } = totalMonthsToYearMonth(initialTotalMonths);
      updateTime(initialYear, initialMonth); // updateTimeìœ¼ë¡œ ì´ˆê¸°í™”
      console.log("ì´ˆê¸°í™” ì™„ë£Œ.");
      
      // ğŸš© [ì¶”ê°€] ë””ë²„ê¹… í•¨ìˆ˜: í‘œì‹œë˜ì§€ ì•ŠëŠ” ë„ì‹œ ì°¾ê¸°
      window.findHiddenCastles = function(year = 2000, month = 1) {
          const currentTotalMonths = yearMonthToTotalMonths(year, month);
          const hiddenCastles = [];
          
          castles.forEach(castle => {
              if (!castle.name || castle.is_military_flag || castle.is_natural_feature || castle.is_label) return;
              
              const activeHistoryInfo = getActiveHistoryInfo(castle.history, currentTotalMonths);
              const activeHistoryRecord = activeHistoryInfo?.record;
              
              // ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠëŠ” ë„ì‹œë¥¼ ìˆ˜ì§‘
              const issues = [];
              
              if (!activeHistoryRecord) {
                  issues.push('í˜„ì¬ ì‹œê°„ì— ë§ëŠ” íˆìŠ¤í† ë¦¬ê°€ ì—†ìŒ');
              } else {
                  if (!activeHistoryRecord.country_id) {
                      issues.push('íˆìŠ¤í† ë¦¬ì˜ country_idê°€ ì—†ìŒ');
                  }
              }
              
              if (typeof castle.lat !== "number" || typeof castle.lng !== "number") {
                  issues.push(`ì¢Œí‘œ ë¬¸ì œ (lat: ${castle.lat}, lng: ${castle.lng})`);
              }
              
              if (issues.length > 0) {
                  hiddenCastles.push({
                      name: castle.name,
                      _id: castle._id,
                      lat: castle.lat,
                      lng: castle.lng,
                      country_id: castle.country_id,
                      history_count: castle.history?.length || 0,
                      history: castle.history,
                      issues: issues
                  });
              }
          });
          
          console.log(`========== ${year}ë…„ ${month}ì›” ê¸°ì¤€ ==========`);
          console.log(`ì´ ë„ì‹œ: ${castles.filter(c => !c.is_military_flag && !c.is_natural_feature && !c.is_label).length}`);
          console.log(`í‘œì‹œë˜ì§€ ì•ŠëŠ” ë„ì‹œ: ${hiddenCastles.length}`);
          console.table(hiddenCastles.map(c => ({
              'ë„ì‹œëª…': c.name,
              'íˆìŠ¤í† ë¦¬ ìˆ˜': c.history_count,
              'ë¬¸ì œì ': c.issues.join(', ')
          })));
          console.log('ìì„¸íˆ ë³´ê¸°:', hiddenCastles);
          
          return hiddenCastles;
      };
      
      // ğŸš© [ì¶”ê°€] íŠ¹ì • ë„ì‹œ ìƒì„¸ ë¶„ì„ í•¨ìˆ˜
      window.analyzeCastle = function(castleName) {
          const castle = castles.find(c => c.name === castleName);
          if (!castle) {
              console.log(`"${castleName}"ë¼ëŠ” ë„ì‹œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
              return null;
          }
          
          console.log(`\n========== "${castleName}" ìƒì„¸ ì •ë³´ ==========`);
          console.log(`ID: ${castle._id}`);
          console.log(`ê¸°ë³¸ êµ­ê°€ ID: ${castle.country_id}`);
          console.log(`ì¢Œí‘œ: (${castle.lat}, ${castle.lng})`);
          console.log(`\níˆìŠ¤í† ë¦¬ ëª©ë¡:`);
          
          if (castle.history && castle.history.length > 0) {
              sortHistoryByStart(castle.history).forEach((h, index) => {
                  console.log(`  [${index + 1}] ${h.start_year}ë…„ ${h.start_month}ì›” ~ ${h.end_year ? h.end_year + 'ë…„ ' + (h.end_month || 12) + 'ì›”' : 'í˜„ì¬'}`);
                  console.log(`       êµ­ê°€: ${h.country_id}`);
                  console.log(`       ì´ë¦„: ${h.name}`);
              });
          } else {
              console.log('  (íˆìŠ¤í† ë¦¬ ì—†ìŒ)');
          }
          
          return castle;
      };
      
      // ğŸš© [ì¶”ê°€] ì™„ì „íˆ í‘œì‹œê°€ ëˆ„ë½ë˜ëŠ” ì„±ì„ ì°¾ëŠ” í•¨ìˆ˜
      window.findCompletelyHiddenCastles = function() {
          const completelyHidden = [];
          
          castles.forEach(castle => {
              if (!castle.name || castle.is_military_flag || castle.is_natural_feature || castle.is_label) return;
              
              // ì´ ì„±ì´ ì–´ë–¤ ì‹œì ì—ì„œë„ í‘œì‹œë  ìˆ˜ ì—†ëŠ”ì§€ í™•ì¸
              const canBeDisplayed = castle.history && castle.history.length > 0 && castle.history.some(h => h.country_id);
              
              if (!canBeDisplayed) {
                  completelyHidden.push({
                      name: castle.name,
                      _id: castle._id,
                      lat: castle.lat,
                      lng: castle.lng,
                      country_id: castle.country_id,
                      history_count: castle.history?.length || 0,
                      has_valid_history: castle.history && castle.history.length > 0,
                      has_country_id: castle.history && castle.history.some(h => h.country_id),
                      reason: !castle.history || castle.history.length === 0 
                          ? 'íˆìŠ¤í† ë¦¬ ë ˆì½”ë“œê°€ ì—†ìŒ' 
                          : 'ëª¨ë“  íˆìŠ¤í† ë¦¬ì— country_idê°€ ì—†ìŒ'
                  });
              }
          });
          
          console.log(`\n========== ì™„ì „íˆ í‘œì‹œë˜ì§€ ì•ŠëŠ” ì„± ==========`);
          console.log(`ì´ ì„±: ${castles.filter(c => !c.is_military_flag && !c.is_natural_feature && !c.is_label).length}`);
          console.log(`ì™„ì „íˆ í‘œì‹œ ëˆ„ë½: ${completelyHidden.length}`);
          
          if (completelyHidden.length > 0) {
              console.table(completelyHidden.map(c => ({
                  'ì„±ëª…': c.name,
                  'íˆìŠ¤í† ë¦¬ìˆ˜': c.history_count,
                  'ì´ìœ ': c.reason
              })));
              console.log('ìì„¸í•œ ì •ë³´:', completelyHidden);
          } else {
              console.log('âœ“ ì™„ì „íˆ í‘œì‹œ ëˆ„ë½ë˜ëŠ” ì„±ì´ ì—†ìŠµë‹ˆë‹¤!');
          }
          
          return completelyHidden;
      };
      
      // ğŸš© [ì¶”ê°€] ëª¨ë“  ì„±ì˜ ìƒíƒœë¥¼ ì¢…í•©ì ìœ¼ë¡œ ê²€ì‚¬í•˜ëŠ” í•¨ìˆ˜
      window.auditAllCastles = function() {
          const audit = {
              ì´ì„±: 0,
              ì •ìƒí‘œì‹œ: 0,
              ì‹œê°„ë³„í‘œì‹œ: 0,
              ì™„ì „ëˆ„ë½: 0,
              ì¢Œí‘œëˆ„ë½: 0,
              details: []
          };
          
          castles.forEach(castle => {
              if (castle.is_military_flag || castle.is_natural_feature || castle.is_label) return;
              
              audit.ì´ì„±++;
              
              const issues = [];
              
              // ì¢Œí‘œ í™•ì¸
              if (typeof castle.lat !== "number" || typeof castle.lng !== "number") {
                  audit.ì¢Œí‘œëˆ„ë½++;
                  issues.push('ì¢Œí‘œ ëˆ„ë½');
              }
              
              // íˆìŠ¤í† ë¦¬ í™•ì¸
              const hasValidHistory = castle.history && castle.history.length > 0 && castle.history.some(h => h.country_id);
              
              if (!hasValidHistory) {
                  audit.ì™„ì „ëˆ„ë½++;
                  issues.push(
                      !castle.history || castle.history.length === 0 
                          ? 'íˆìŠ¤í† ë¦¬ ì—†ìŒ' 
                          : 'country_id ì—†ìŒ'
                  );
              } else {
                  // íˆìŠ¤í† ë¦¬ê°€ ìˆì§€ë§Œ ì‹œê°„ì— ë”°ë¼ í‘œì‹œê°€ ë˜ê¸°ë„ ì•ˆ ë˜ê¸°ë„ í•¨
                  const allTimeRangesValid = castle.history.every(h => {
                      const startYear = (h.start_year !== undefined && h.start_year !== null && h.start_year !== '') ? parseInt(h.start_year) : -4000;
                      const endYear = (h.end_year !== undefined && h.end_year !== null && h.end_year !== '') ? parseInt(h.end_year) : null;
                      return startYear !== undefined && startYear !== null;
                  });
                  
                  if (allTimeRangesValid) {
                      audit.ì •ìƒí‘œì‹œ++;
                  } else {
                      audit.ì‹œê°„ë³„í‘œì‹œ++;
                      issues.push('ì¼ë¶€ íˆìŠ¤í† ë¦¬ì˜ ì‹œê°„ ë°ì´í„° ë¶ˆì™„ì „');
                  }
              }
              
              if (issues.length > 0) {
                  audit.details.push({
                      name: castle.name,
                      issues: issues.join(', ')
                  });
              }
          });
          
          console.log(`\n========== ì„± ë°ì´í„° ê°ì‚¬ ë³´ê³ ì„œ ==========`);
          console.log(`ì´ ì„±: ${audit.ì´ì„±}`);
          console.log(`âœ“ ì •ìƒ í‘œì‹œ: ${audit.ì •ìƒí‘œì‹œ}`);
          console.log(`âš  ì‹œê°„ë³„ í‘œì‹œ: ${audit.ì‹œê°„ë³„í‘œì‹œ}`);
          console.log(`âœ— ì™„ì „ ëˆ„ë½: ${audit.ì™„ì „ëˆ„ë½}`);
          console.log(`âœ— ì¢Œí‘œ ëˆ„ë½: ${audit.ì¢Œí‘œëˆ„ë½}`);
          console.log(`\në¬¸ì œê°€ ìˆëŠ” ì„±:`);
          
          if (audit.details.length > 0) {
              console.table(audit.details);
          } else {
              console.log('âœ“ ëª¨ë“  ì„±ì´ ì •ìƒì…ë‹ˆë‹¤!');
          }
          
          return audit;
      };
    }
        // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateCitySelectForEdit() {
        const select = citySelectForEdit;
        select.innerHTML = '<option value="">-- ë„ì‹œ/ì„± ì„ íƒ --</option>'; // ì´ˆê¸°í™”
        // êµ°ëŒ€, ìì—°, ì§€ëª… íƒ€ì…ì´ ì•„ë‹Œ ì„±/ë„ì‹œë§Œ ëª©ë¡ì— ì¶”ê°€
        const filteredCastles = castles.filter(c => !c.is_military_flag && !c.is_natural_feature && !c.is_label)
                                       .sort((a, b) => a.name.localeCompare(b.name, 'ko'));
        filteredCastles.forEach(castle => {
            select.innerHTML += `<option value="${castle._id}">${castle.name} (${getCountryInfoById(castle.country_id)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'})</option>`;
        });
    }

        // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” ëˆˆê¸ˆì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    function createSliderTicks() {
        const timelineContent = document.getElementById('timeline-content');
        const existingTicks = timelineContent ? timelineContent.querySelector('.slider-ticks-container') : null;
        if (existingTicks) existingTicks.remove(); // ê¸°ì¡´ ëˆˆê¸ˆ ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ ë¨¼ì € ì œê±°í•©ë‹ˆë‹¤.

        // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì—°ëŒ€í‘œê°€ ë¹„í™œì„±í™” ìƒíƒœì´ë©´ ëˆˆê¸ˆì„ ìƒì„±í•˜ì§€ ì•Šê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
        if (!layerVisibility.timeline || !timelineContent) {
            return;
        }

        const ticksContainer = document.createElement('div');
        // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ìœ„ì— í‘œì‹œë˜ë„ë¡ ìŠ¤íƒ€ì¼ ë³€ê²½
        ticksContainer.className = 'slider-ticks-container';
        ticksContainer.style.cssText = "width: 100%; height: 30px; display: flex; font-size: 0.85em; color: #f5e9d2; position: absolute; top: -32px; left: 0; z-index: 1000; pointer-events: none;";

        const sliderMin = parseInt(combinedSlider.min);
        const totalSliderMonths = parseInt(combinedSlider.max) - sliderMin;

        for (let year = -2500; year <= 2500; year += 500) {
            const tickMonths = yearMonthToTotalMonths(year, 1);
            const positionPercent = ((tickMonths - sliderMin) / totalSliderMonths) * 100;

            const tick = document.createElement('div');
            tick.style.cssText = `position: absolute; left: ${positionPercent}%; transform: translateX(-50%); text-align: center;`;
            tick.innerHTML = `<span style="border-left: 2px solid #f5e9d2; padding-left: 4px; height: 28px; display: inline-block; line-height: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,1); font-weight: bold;">${year}</span>`;
            ticksContainer.appendChild(tick);
        }

        timelineContent.appendChild(ticksContainer);
    }
    
    // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„°ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ (ì´ˆê¸°í™” ì‹œ í•œ ë²ˆë§Œ í˜¸ì¶œ)
    function createEthnicityFilters() {
        // ğŸš© [ìˆ˜ì •] ì´ë¯¸ í•„í„°ê°€ ì¡´ì¬í•˜ë©´ ë‹¤ì‹œ ìƒì„±í•˜ì§€ ì•ŠìŒ
        if (document.getElementById('mapEthnicityFilterSelect')) {
            return;
        }
        
        const ethnicityFilterContainer = document.getElementById('ethnicityFilterContainer');
        const mapEthnicityContainer = document.getElementById('mapEthnicityContainer');
        // ğŸš© [ìˆ˜ì •] ëª¨ë“  êµ­ê°€ì˜ ë¯¼ì¡±ì„ í¬í•¨ (ì£¼ìš” ì™•ì¡° í¬í•¨)
        const ethnicities = [...new Set(countries.filter(c => c.ethnicity).map(c => c.ethnicity))].sort();
        
        // ğŸš© [ìˆ˜ì •] ìƒë‹¨ ë¯¼ì¡± í•„í„° (controls-wrapperê°€ ì œê±°ë˜ì–´ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        if (ethnicityFilterContainer) {
            let selectElement = document.createElement('select');
            selectElement.id = 'ethnicityFilterSelect';
            selectElement.style.cssText = 'padding: 5px 4px; border-radius: 4px; border: 1px solid #5d7185; font-size: 13px; width: 120px; height: 100%; box-sizing: border-box;';
            selectElement.innerHTML = '<option value="all">-- ëª¨ë“  ë¯¼ì¡± --</option>';
            ethnicities.forEach(ethnicity => {
                selectElement.innerHTML += `<option value="${ethnicity}">${ethnicity}</option>`;
            });
            ethnicityFilterContainer.innerHTML = '';
            ethnicityFilterContainer.appendChild(selectElement);
            selectElement.addEventListener('change', () => {
                // ì§€ë„ ë¯¼ì¡± í•„í„°ë„ ë™ê¸°í™”
                const mapEthnicitySelect = document.getElementById('mapEthnicityFilterSelect');
                if (mapEthnicitySelect) {
                    mapEthnicitySelect.value = selectElement.value;
                    // ğŸš© [ì¶”ê°€] ì§€ë„ í•„í„° ìŠ¤íƒ€ì¼ë„ ë™ê¸°í™”
                    if (selectElement.value && selectElement.value !== 'all') {
                        mapEthnicitySelect.classList.add('filter-active');
                    } else {
                        mapEthnicitySelect.classList.remove('filter-active');
                    }
                }
                // ğŸš© [ì¶”ê°€] ì„ íƒëœ ë¯¼ì¡± ê°’ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                selectedEthnicity = selectElement.value;
                // ğŸš© [ì¶”ê°€] í•„í„° í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš©
                if (selectedEthnicity && selectedEthnicity !== 'all') {
                    selectElement.classList.add('filter-active');
                } else {
                    selectElement.classList.remove('filter-active');
                }
                
                // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„° ì„ íƒ ì‹œ í•´ë‹¹ ë¯¼ì¡±ì˜ ì²« ë²ˆì§¸ êµ­ê°€ë¡œ ì—°ë„ ì í”„
                if (selectedEthnicity && selectedEthnicity !== 'all') {
                    const filteredCountries = countries.filter(c => c.ethnicity === selectedEthnicity && c.start !== null).sort((a, b) => a.start - b.start);
                    if (filteredCountries.length > 0) {
                        const firstCountry = filteredCountries[0];
                        updateTime(firstCountry.start, firstCountry.start_month || 1);
                    }
                }
                
                // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ê°±ì‹ 
                createDynastyTimeline();
                // ğŸš© [ì¶”ê°€] ì§€ë„ ê°±ì‹  (ì„±/ë„ì‹œ í•„í„°ë§)
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
            });
        }
        
        // ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ë¶€ ë¯¼ì¡± í•„í„° ìƒì„±
        if (mapEthnicityContainer) {
            let mapEthnicitySelect = document.createElement('select');
            mapEthnicitySelect.id = 'mapEthnicityFilterSelect';
            mapEthnicitySelect.style.cssText = 'padding: 4px 6px; border-radius: 4px; border: 1px solid #5d7185; font-size: 11px; min-width: 110px;';
            mapEthnicitySelect.innerHTML = '<option value="all">-- ëª¨ë“  ë¯¼ì¡± --</option>';
            ethnicities.forEach(ethnicity => {
                mapEthnicitySelect.innerHTML += `<option value="${ethnicity}">${ethnicity}</option>`;
            });
            mapEthnicityContainer.innerHTML = '';
            mapEthnicityContainer.appendChild(mapEthnicitySelect);
            mapEthnicitySelect.addEventListener('change', () => {
                // ìƒë‹¨ ë¯¼ì¡± í•„í„°ë„ ë™ê¸°í™” (ì¡´ì¬í•˜ëŠ” ê²½ìš°ë§Œ)
                const ethnicityFilterSelect = document.getElementById('ethnicityFilterSelect');
                if (ethnicityFilterSelect) {
                    ethnicityFilterSelect.value = mapEthnicitySelect.value;
                    // ğŸš© [ì¶”ê°€] ìƒë‹¨ í•„í„° ìŠ¤íƒ€ì¼ë„ ë™ê¸°í™”
                    if (mapEthnicitySelect.value && mapEthnicitySelect.value !== 'all') {
                        ethnicityFilterSelect.classList.add('filter-active');
                    } else {
                        ethnicityFilterSelect.classList.remove('filter-active');
                    }
                }
                // ğŸš© [ì¶”ê°€] ì„ íƒëœ ë¯¼ì¡± ê°’ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                selectedEthnicity = mapEthnicitySelect.value;
                // ğŸš© [ì¶”ê°€] í•„í„° í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš©
                if (selectedEthnicity && selectedEthnicity !== 'all') {
                    mapEthnicitySelect.classList.add('filter-active');
                } else {
                    mapEthnicitySelect.classList.remove('filter-active');
                }
                
                // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„° ì„ íƒ ì‹œ í•´ë‹¹ ë¯¼ì¡±ì˜ ì²« ë²ˆì§¸ êµ­ê°€ë¡œ ì—°ë„ ì í”„
                if (selectedEthnicity && selectedEthnicity !== 'all') {
                    const filteredCountries = countries.filter(c => c.ethnicity === selectedEthnicity && c.start !== null).sort((a, b) => a.start - b.start);
                    if (filteredCountries.length > 0) {
                        const firstCountry = filteredCountries[0];
                        updateTime(firstCountry.start, firstCountry.start_month || 1);
                    }
                }
                
                // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ê°±ì‹ 
                createDynastyTimeline();
                // ğŸš© [ì¶”ê°€] ì§€ë„ ê°±ì‹  (ì„±/ë„ì‹œ í•„í„°ë§)
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
            });
        }
    }
    // ğŸš© [ìˆ˜ì •] ì£¼ìš” êµ­ê°€ì™€ ë‚˜ë¨¸ì§€ êµ­ê°€ë¥¼ ë¶„ë¦¬í•˜ì—¬ ë Œë”ë§í•˜ë„ë¡ ë¡œì§ ìˆ˜ì •
    function createDynastyTimeline() {
        const timelineContainer = document.getElementById('timeline-container');
        const timelineContent = document.getElementById('timeline-content');
        if (!timelineContainer || !timelineContent || countries.length === 0) return;
    
        // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ê°€ì‹œì„± ìƒíƒœì— ë”°ë¼ ì»¨í…Œì´ë„ˆë¥¼ ë¹„ìš°ê±°ë‚˜ ìˆ¨ê¹ë‹ˆë‹¤.
        if (!layerVisibility.timeline) {
            timelineContainer.style.display = 'none';
            return;
        }
        timelineContainer.style.display = 'block';
        timelineContent.innerHTML = ''; // ì»¨í…ì¸  ì´ˆê¸°í™”
        
        // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„°ê°€ ì—†ìœ¼ë©´ ìƒì„±
        createEthnicityFilters();

        // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„°ì˜ í˜„ì¬ ê°’ì„ ì „ì—­ ë³€ìˆ˜ì™€ ë™ê¸°í™”
        const mapEthnicitySelect = document.getElementById('mapEthnicityFilterSelect');
        if (mapEthnicitySelect && mapEthnicitySelect.value) {
            selectedEthnicity = mapEthnicitySelect.value;
        } else if (!selectedEthnicity) {
            selectedEthnicity = 'all';
        }

        // ğŸš© [ìˆ˜ì •] êµ­ê°€ í•„í„°ê°€ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³ , ê·¸ì— ë”°ë¼ êµ­ê°€ ëª©ë¡ì„ í•„í„°ë§í•©ë‹ˆë‹¤.
        let countriesToDisplay = countries.filter(c => c.start !== null);
        if (selectedCountryId !== 'all') {
            countriesToDisplay = countriesToDisplay.filter(c => c._id === selectedCountryId);
        }

        const validCountries = countriesToDisplay;
        if (validCountries.length === 0) return;
    
        // ìŠ¬ë¼ì´ë”ì˜ min/max ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ê¸°ê°„ ê³„ì‚°
        const sliderMin = parseInt(combinedSlider.min);
        const sliderMax = parseInt(combinedSlider.max);
        const totalSliderMonths = sliderMax - sliderMin;
    
        // ğŸš© [ìˆ˜ì •] ë¯¼ì¡± í•„í„°ë§ ë¡œì§ ì ìš© (ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©)
        let allCountries = validCountries;
        if (selectedEthnicity && selectedEthnicity !== 'all') {
            allCountries = allCountries.filter(country =>
                country.ethnicity === selectedEthnicity
            );
        }


    
        const processCountries = (countriesToProcess) => {
            const koreanLanes = []; // í•œêµ­ ë¯¼ì¡±ìš© ë ˆì¸
            const otherLanes = [];  // ë‹¤ë¥¸ ë¯¼ì¡±ìš© ë ˆì¸
            let maxLaneIndex = 0;
            
            // í•œêµ­ ë¯¼ì¡± ë¦¬ìŠ¤íŠ¸
            const koreanEthnicities = ['í•œêµ­', 'ê³ ì¡°ì„ ', 'ë¶€ì—¬', 'ê³ êµ¬ë ¤', 'ë°±ì œ', 'ì‹ ë¼', 'ê°€ì•¼', 'ë°œí•´', 'ê³ ë ¤', 'ì¡°ì„ '];
            
            // ğŸš© [ìˆ˜ì •] êµ­ê°€ë“¤ì„ í•œêµ­ ë¯¼ì¡±ê³¼ ë‹¤ë¥¸ ë¯¼ì¡±ìœ¼ë¡œ ë¶„ë¦¬í•˜ê³  ì‹œì‘ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
            const koreanCountries = countriesToProcess
                .filter(c => koreanEthnicities.includes(c.ethnicity))
                .sort((a, b) => a.start - b.start);
            const otherCountries = countriesToProcess
                .filter(c => !koreanEthnicities.includes(c.ethnicity))
                .sort((a, b) => a.start - b.start);
            
            // êµ­ê°€ë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
            const renderCountry = (country, lanes, laneOffset = 0) => {
                const startMonths = yearMonthToTotalMonths(country.start, country.start_month || 1);
                const endYear = country.end === null || isNaN(country.end) ? totalMonthsToYearMonth(sliderMax).year : country.end;
                const endMonths = yearMonthToTotalMonths(endYear, country.end_month || 12);
    
                if (isNaN(startMonths) || isNaN(endMonths)) return;
    
                const leftPercent = ((startMonths - sliderMin) / totalSliderMonths) * 100;
                const widthPercent = ((endMonths - startMonths) / totalSliderMonths) * 100;
                
                // ëª¨ë“  êµ­ê°€ë¥¼ ê²¹ì¹˜ì§€ ì•Šê²Œ ë°°ì¹˜
                let laneIndex = lanes.findIndex(laneEndTime => laneEndTime <= startMonths);
                if (laneIndex === -1) {
                    laneIndex = lanes.length;
                }
                lanes[laneIndex] = endMonths;
                
                // offset ì ìš©
                const finalLaneIndex = laneIndex + laneOffset;
    
                const bar = document.createElement('div');
                bar.className = 'timeline-bar';
                // is_main_dynastyì— ë”°ë¼ ìŠ¤íƒ€ì¼ êµ¬ë¶„
                bar.classList.add(country.is_main_dynasty ? 'main-dynasty' : 'minor-dynasty');
                bar.style.left = `${leftPercent}%`;
                bar.style.width = `${widthPercent}%`;
                bar.style.top = `${finalLaneIndex * 10}px`; // 10px ê°„ê²©ìœ¼ë¡œ ë°°ì¹˜
                bar.style.backgroundColor = country.color || '#7f8c8d';
    
                // ğŸš© [ìˆ˜ì •] êµ­ê°€ëª…ì— ë¯¼ì¡± ì •ë³´ ì¶”ê°€
                bar.textContent = country.ethnicity ? `${country.name} (${country.ethnicity})` : country.name;
                const endYearText = country.end ? `${country.end}ë…„` : 'í˜„ì¬';
                bar.title = `${country.name}${country.ethnicity ? ` (${country.ethnicity})` : ''} (${country.start}ë…„ ~ ${endYearText})`;

                // ğŸš© [ì¶”ê°€] í´ë¦­ ì‹œ ì‹œê°„ ì´ë™ì„ ìœ„í•´ ë°ì´í„° ì†ì„± ì¶”ê°€
                bar.dataset.startYear = country.start;
                bar.dataset.startMonth = country.start_month || 1;
                bar.dataset.countryId = country._id; // ğŸš© [ì¶”ê°€] ìˆ˜ë„ í´ë¡œì¦ˆì—…ì„ ìœ„í•´ êµ­ê°€ ID ì¶”ê°€
    
                timelineContent.appendChild(bar);
                maxLaneIndex = Math.max(maxLaneIndex, finalLaneIndex);
            };
            
            // ğŸš© [ìˆ˜ì •] í•œêµ­ ë¯¼ì¡± êµ­ê°€ë“¤ì„ ë¨¼ì € ë Œë”ë§ (ìƒë‹¨ ë°°ì¹˜)
            koreanCountries.forEach(country => renderCountry(country, koreanLanes, 0));
            
            // ğŸš© [ìˆ˜ì •] ë‹¤ë¥¸ ë¯¼ì¡± êµ­ê°€ë“¤ì„ ë‚˜ì¤‘ì— ë Œë”ë§ (í•˜ë‹¨ ë°°ì¹˜)
            const koreanLaneCount = koreanLanes.length;
            otherCountries.forEach(country => renderCountry(country, otherLanes, koreanLaneCount));
            
            return maxLaneIndex + 1;
        };
    
        // ëª¨ë“  êµ­ê°€ë¥¼ í•¨ê»˜ ì²˜ë¦¬í•˜ì—¬ ê²¹ì¹˜ì§€ ì•Šê²Œ ë°°ì¹˜
        const finalLaneCount = processCountries(allCountries);
    
        // ì»¨í…Œì´ë„ˆ ë†’ì´ ìë™ ì¡°ì ˆ (ìµœì†Œ ë†’ì´ í™•ë³´í•˜ì—¬ ì˜ë¦¼ ë°©ì§€)
        const calculatedHeight = finalLaneCount * 10 + 20; // lane ë†’ì´ + ì—¬ìœ  ê³µê°„
        const minHeight = Math.max(calculatedHeight, 80); // ìµœì†Œ 80px
        timelineContent.style.height = `${minHeight}px`;
        
        // timeline-container ë†’ì´ë„ ìë™ ì¡°ì ˆ
        timelineContainer.style.height = `${minHeight}px`;
        
        // ğŸš© [ì¶”ê°€] ì—°ë„ tick ìƒì„±
        createSliderTicks();
        
        // ğŸš© [ì¶”ê°€] í˜„ì¬ ì‹œì ì„ ì¤‘ì•™ì— ë°°ì¹˜í•˜ëŠ” í•¨ìˆ˜ (ì•½ê°„ ì§€ì—°ì‹œì¼œ DOM ì—…ë°ì´íŠ¸ í›„ ì‹¤í–‰)
        setTimeout(() => {
            updateTimelineScroll(true); // ì´ˆê¸° ë¡œë“œì‹œ transition ì—†ì´ ì¦‰ì‹œ ì´ë™
        }, 100);
    }
    
    // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ìŠ¤í¬ë¡¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateTimelineScroll(skipTransition = false) {
        const timelineContainer = document.getElementById('timeline-container');
        const timelineContent = document.getElementById('timeline-content');
        if (!timelineContainer || !timelineContent || !layerVisibility.timeline) return;
        
        const sliderMin = parseInt(combinedSlider.min);
        const sliderMax = parseInt(combinedSlider.max);
        const totalSliderMonths = sliderMax - sliderMin;
        const currentValue = parseInt(combinedSlider.value);
        
        // í˜„ì¬ ì‹œì ì˜ í¼ì„¼íŠ¸ ê³„ì‚°
        const currentPercent = ((currentValue - sliderMin) / totalSliderMonths);
        
        // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ì™€ ì»¨í…ì¸  ë„ˆë¹„
        const containerWidth = timelineContainer.offsetWidth;
        const contentWidth = timelineContent.offsetWidth;
        
        // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ offset ê³„ì‚°
        const offset = (containerWidth / 2) - (contentWidth * currentPercent);
        
        // transition ì œì–´ - ë” ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜
        if (skipTransition) {
            timelineContent.style.transition = 'none';
        } else {
            timelineContent.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        }
        
        // transformìœ¼ë¡œ ì´ë™
        timelineContent.style.transform = `translateX(${offset}px)`;
        
        // skipTransitionì´ì—ˆë‹¤ë©´ ë‹¤ìŒ í”„ë ˆì„ì— transition ë³µì›
        if (skipTransition) {
            requestAnimationFrame(() => {
                timelineContent.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            });
        }
    }
    
    // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë“œë˜ê·¸ ê¸°ëŠ¥ êµ¬í˜„
    function initTimelineDrag() {
        const timelineContainer = document.getElementById('timeline-container');
        const timelineContent = document.getElementById('timeline-content');
        if (!timelineContainer || !timelineContent) return;
        
        let isDragging = false;
        let hasDragged = false; // ğŸš© [ì¶”ê°€] ì‹¤ì œë¡œ ë“œë˜ê·¸ê°€ ë°œìƒí–ˆëŠ”ì§€ ì¶”ì 
        let startX = 0;
        let startSliderValue = 0;
        
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        timelineContainer.addEventListener('mousedown', (e) => {
            isDragging = true;
            hasDragged = false; // ğŸš© [ì¶”ê°€] ì´ˆê¸°í™”
            startX = e.clientX;
            startSliderValue = parseInt(combinedSlider.value);
            timelineContainer.style.cursor = 'grabbing';
            timelineContent.style.transition = 'none'; // ë“œë˜ê·¸ ì¤‘ì—ëŠ” transition ì œê±°
            e.preventDefault();
            e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            e.preventDefault();
            e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            
            const deltaX = e.clientX - startX;
            
            // ğŸš© [ì¶”ê°€] 5px ì´ìƒ ì´ë™í•˜ë©´ ë“œë˜ê·¸ë¡œ ê°„ì£¼
            if (Math.abs(deltaX) > 5) {
                hasDragged = true;
            }
            
            const containerWidth = timelineContainer.offsetWidth;
            const contentWidth = timelineContent.offsetWidth;
            
            // í”½ì…€ ì´ë™ì„ ìŠ¬ë¼ì´ë” ê°’ìœ¼ë¡œ ë³€í™˜
            const sliderMin = parseInt(combinedSlider.min);
            const sliderMax = parseInt(combinedSlider.max);
            const totalSliderMonths = sliderMax - sliderMin;
            
            const deltaMonths = -deltaX * (totalSliderMonths / contentWidth);
            const newValue = Math.max(sliderMin, Math.min(sliderMax, startSliderValue + deltaMonths));
            
            combinedSlider.value = Math.round(newValue);
            const { year, month } = totalMonthsToYearMonth(Math.round(newValue));
            updateTime(year, month);
            updateTimelineScroll(true); // transition ì—†ì´ ì—…ë°ì´íŠ¸
        });
        
        document.addEventListener('mouseup', (e) => {
            if (isDragging) {
                isDragging = false;
                timelineContainer.style.cursor = 'grab';
                timelineContent.style.transition = 'transform 0.3s ease';
                e.preventDefault();
                e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                
                // ğŸš© [ì¶”ê°€] ë“œë˜ê·¸ê°€ ë°œìƒí•œ ê²½ìš° ì ì‹œ í›„ hasDraggedë¥¼ ë¦¬ì…‹
                if (hasDragged) {
                    setTimeout(() => {
                        hasDragged = false;
                    }, 100);
                }
            }
        });
        
        // í„°ì¹˜ ì´ë²¤íŠ¸
        timelineContainer.addEventListener('touchstart', (e) => {
            isDragging = true;
            hasDragged = false; // ğŸš© [ì¶”ê°€] ì´ˆê¸°í™”
            startX = e.touches[0].clientX;
            startSliderValue = parseInt(combinedSlider.value);
            timelineContent.style.transition = 'none';
            e.preventDefault();
            e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
        }, { passive: false });
        
        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            e.preventDefault();
            e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            
            const deltaX = e.touches[0].clientX - startX;
            
            // ğŸš© [ì¶”ê°€] 5px ì´ìƒ ì´ë™í•˜ë©´ ë“œë˜ê·¸ë¡œ ê°„ì£¼
            if (Math.abs(deltaX) > 5) {
                hasDragged = true;
            }
            
            const containerWidth = timelineContainer.offsetWidth;
            const contentWidth = timelineContent.offsetWidth;
            
            const sliderMin = parseInt(combinedSlider.min);
            const sliderMax = parseInt(combinedSlider.max);
            const totalSliderMonths = sliderMax - sliderMin;
            
            const deltaMonths = -deltaX * (totalSliderMonths / contentWidth);
            const newValue = Math.max(sliderMin, Math.min(sliderMax, startSliderValue + deltaMonths));
            
            combinedSlider.value = Math.round(newValue);
            const { year, month } = totalMonthsToYearMonth(Math.round(newValue));
            updateTime(year, month);
            updateTimelineScroll(true);
        }, { passive: false });
        
        document.addEventListener('touchend', (e) => {
            if (isDragging) {
                isDragging = false;
                timelineContent.style.transition = 'transform 0.3s ease';
                e.preventDefault();
                e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                
                // ğŸš© [ì¶”ê°€] ë“œë˜ê·¸ê°€ ë°œìƒí•œ ê²½ìš° ì ì‹œ í›„ hasDraggedë¥¼ ë¦¬ì…‹
                if (hasDragged) {
                    setTimeout(() => {
                        hasDragged = false;
                    }, 100);
                }
            }
        }, { passive: false });
        
        // ğŸš© [ì¶”ê°€] hasDragged ìƒíƒœë¥¼ ì™¸ë¶€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•¨ìˆ˜ ë°˜í™˜
        return () => hasDragged;
    }


    // --- 6. UI ì—…ë°ì´íŠ¸ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    // ğŸš© [ìˆ˜ì •] updateUI í•¨ìˆ˜: yearì™€ month ê°’ì„ ì§ì ‘ ì‚¬ìš© (ìŒìˆ˜ ì›” ë°©ì§€)
    function updateUI(year, month) {
      const yearText = (year < 1 ? ' ê¸°ì›ì „ ' : ' ì„œê¸° ') + (year < 1 ? Math.abs(year - 1) : year);
      const monthText = month;
      const ganjiText = getGanji(year, month);
      timeLabelDisplay.innerHTML = `ì—°ë„: ${yearText}ë…„ ${monthText}ì›” ${ganjiText}`;
      
      // ğŸš© [ì¶”ê°€] ê°œë³„ ë¼ë²¨ ìš”ì†Œë“¤ì„ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ì—¬ ì…ë ¥ì°½ê³¼ ë™ê¸°í™”
      if (yearLabel) yearLabel.textContent = (year < 1 ? Math.abs(year - 1) : year);
      if (monthLabel) monthLabel.textContent = month;
      if (ganjiLabel) ganjiLabel.textContent = ganjiText;
      
      updateHistoryPanel(year);
      updateKingLabel(year, month);
    }


    // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„° ë“œë¡­ë‹¤ìš´ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateCountryFilter() {
        // ğŸš© [ìˆ˜ì •] countryFilterSelectì™€ mapCountryFilterê°€ ê°™ì€ ìš”ì†Œë¥¼ ê°€ë¦¬í‚¤ë¯€ë¡œ í•œ ë²ˆë§Œ ì—…ë°ì´íŠ¸
        const filterElement = countryFilterSelect || mapCountryFilter;
        if (!filterElement) return;
        
        filterElement.innerHTML = '<option value="all">-- ì „ì²´ --</option>';
        
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country._id;
            option.textContent = country.name; // êµ­ê°€ëª…ë§Œ í‘œì‹œ
            filterElement.appendChild(option);
        });
    }

    function getCurrentYearMonth() {
        const year = parseInt(yearInput.value);
        const month = parseInt(monthInput.value);
        return { year, month };
    }

    // ğŸš© [ìˆ˜ì •] ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶„ë¦¬ (ì„±ëŠ¥ ìµœì í™”)
    combinedSlider.addEventListener('input', () => {
      const totalMonths = parseInt(combinedSlider.value);
      const { year, month } = totalMonthsToYearMonth(totalMonths);
      updateTime(year, month);
      updateTimelineScroll(); // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” ë³€ê²½ ì‹œ ì—°ëŒ€í‘œ ìŠ¤í¬ë¡¤ ì—…ë°ì´íŠ¸
    });
    
    // ğŸš© [ì œê±°] 'input' ì´ë²¤íŠ¸ì—ì„œ ëª¨ë“  ì—…ë°ì´íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë¯€ë¡œ 'change' ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì œê±°í•©ë‹ˆë‹¤.
    // combinedSlider.addEventListener('change', ...);

    // ğŸš© [ì¶”ê°€] ì‚¬ìš©ìê°€ ì—°ë„ ì…ë ¥ì°½ì„ ë¹„ìš°ê³  í¬ì»¤ìŠ¤ë¥¼ ìƒì—ˆì„ ë•Œì˜ ì²˜ë¦¬
    yearInput.addEventListener('input', (e) => {
        const value = e.target.value;
        if (value !== '' && value !== '-') {
            updateTime(parseInt(value) || 0, parseInt(monthInput.value) || 1);
        }
    });

    // ğŸš© [ì¶”ê°€] ì—°ë„ ì…ë ¥ì°½ì˜ ìŠ¤í”¼ë„ˆ ë²„íŠ¼ í´ë¦­ ì‹œ ì›” ìë™ ë³€ê²½
    yearInput.addEventListener('input', (e) => {
        const year = parseInt(e.target.value) || 0;
        const month = parseInt(monthInput.value) || 1;
        // ì‚¬ìš©ìê°€ ì§ì ‘ íƒ€ì´í•‘í•˜ëŠ” ê²½ìš°ëŠ” ì œì™¸í•˜ê³ , ìŠ¤í”¼ë„ˆ ë²„íŠ¼ í´ë¦­ ë“±ìœ¼ë¡œ ê°’ì´ ë³€ê²½ë  ë•Œë§Œ updateTime í˜¸ì¶œ
        if (e.inputType !== 'insertText' && e.inputType !== 'deleteContentBackward') {
            updateTime(year, month);
        }
    });
    // ğŸš© [ìˆ˜ì •] ì›” ì…ë ¥ì°½ ë³€ê²½ ì‹œ ì—°ë„ ìë™ ì¦ê° ê¸°ëŠ¥ ê°œì„ 
    monthInput.addEventListener('input', () => {
        const year = parseInt(yearInput.value) || 0;
        const month = parseInt(monthInput.value) || 1;
        updateTime(year, month);
    });

    // ğŸš© [ì¶”ê°€] ì—°ë„ í† ê¸€ë°” ì „ì²´ ì˜ì—­ì˜ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì§€ë„ë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë°©ì§€
    const timeControlsMap = document.getElementById('time-controls-map');
    if (timeControlsMap) {
        timeControlsMap.addEventListener('mousedown', (e) => {
            e.stopPropagation();
        });
        timeControlsMap.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        timeControlsMap.addEventListener('dblclick', (e) => {
            e.stopPropagation();
        });
    }
    
    // ğŸš© [ì¶”ê°€] ì—°ë„/ì›” ì…ë ¥ì°½ì˜ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì§€ë„ë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë°©ì§€
    yearInput.addEventListener('mousedown', (e) => {
        e.stopPropagation();
    });
    yearInput.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    monthInput.addEventListener('mousedown', (e) => {
        e.stopPropagation();
    });
    monthInput.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    function updateTime(year, month) {
        yearInput.value = year;
        monthInput.value = month;

        const totalMonths = yearMonthToTotalMonths(year, month);
        const sliderMin = parseInt(combinedSlider.min);
        const sliderMax = parseInt(combinedSlider.max);
        if (totalMonths >= sliderMin && totalMonths <= sliderMax) {
            combinedSlider.value = totalMonths;
        } 
        
        updateMap(year, month);
        updateUI(year, month);
        checkAndDisplayEvent(year, month);
        updateTimelineScroll(); // ğŸš© [ì¶”ê°€] ì—°ë„ ë³€ê²½ ì‹œ ì—°ëŒ€í‘œë„ í•¨ê»˜ ì´ë™
    }

    // ğŸš© [ìˆ˜ì •] ì›” ì…ë ¥ í•„ë“œì—ì„œ í™”ì‚´í‘œ í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì—°ë„ ë³€ê²½ ë¡œì§ ì¶©ëŒ í•´ê²°
    monthInput.addEventListener('keydown', (e) => {
        let keydownYear = parseInt(yearInput.value) || 0;
        const currentMonth = parseInt(monthInput.value) || 1;

        if (e.key === 'ArrowDown' && currentMonth === 1) {
            e.preventDefault(); // ê¸°ë³¸ ë™ì‘(ê°’ì´ 0ì´ ë˜ëŠ” ê²ƒ)ì„ ë§‰ìŒ
            updateTime(keydownYear - 1, 12);
        } else if (e.key === 'ArrowUp' && currentMonth === 12) {
            e.preventDefault(); // ê¸°ë³¸ ë™ì‘(ê°’ì´ 13ì´ ë˜ëŠ” ê²ƒ)ì„ ë§‰ìŒ
            updateTime(keydownYear + 1, 1);
        }
    });
    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¬ìƒ ì œì–´ ë¡œì§: BC/AD ì „í™˜ ë° ì›” í‘œì‹œ ë¬¸ì œ í•´ê²°
    let playInterval = null;
    
 function startPlayback() {
        if (playInterval) return; 

        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline';

        const monthsPerSecond = parseInt(playbackSpeedSlider.value) || 12;
        const intervalDuration = 1000 / monthsPerSecond; 

        playInterval = setInterval(() => {
            let totalMonths = parseInt(combinedSlider.value);
            
            // 1. ì´ ì›”ìˆ˜ë¥¼ 1 ì¦ê°€
            totalMonths++;
            
            // 2. ìŠ¬ë¼ì´ë” ìµœëŒ€ê°’ì„ ì´ˆê³¼í•˜ë©´ ì •ì§€
            if (totalMonths > parseInt(combinedSlider.max)) {
                stopPlayback();
                return;
            }
            
            // 3. ìƒˆë¡œìš´ ì—°/ì›” ê³„ì‚°
            const { year, month } = totalMonthsToYearMonth(totalMonths);
            
            // 4. UI ì—…ë°ì´íŠ¸
            combinedSlider.value = totalMonths;
            
            yearInput.value = year;
            monthInput.value = month;

            // ğŸš© [ìˆ˜ì •] ì¬ìƒ ì¤‘ì—ëŠ” updateTime í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ëª¨ë“  UIì™€ ì§€ë„ë¥¼ ì¼ê´€ì„± ìˆê²Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            updateTime(year, month);
            /*
            updateMap(year, month);
            updateUI(year, month);
            checkAndDisplayEvent(year, month);
            */
        }, intervalDuration); 
    }

    function stopPlayback() {
        clearInterval(playInterval);
        playInterval = null;
        playBtn.style.display = 'inline';
        pauseBtn.style.display = 'none';
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜ ë§¨ ë§ˆì§€ë§‰ì— ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    const originalInitialize = initialize;
    initialize = async () => {
        await originalInitialize();
        
        // ğŸš© [ì¶”ê°€] ì¬ìƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        playBtn.addEventListener('click', startPlayback);
        pauseBtn.addEventListener('click', stopPlayback);
        
        // ì†ë„ ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        playbackSpeedSlider.addEventListener('input', () => {
            speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
            if (playInterval) {
                stopPlayback();
                startPlayback(); // ì¦‰ì‹œ ìƒˆ ì†ë„ë¡œ ë‹¤ì‹œ ì‹œì‘
            }
        });
        
        // ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ ìë™ ì •ì§€
        combinedSlider.addEventListener('mousedown', stopPlayback);
        combinedSlider.addEventListener('touchstart', stopPlayback);
        
        // ì´ˆê¸° ì†ë„ ë””ìŠ¤í”Œë ˆì´ ì„¤ì •
        speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
    };
    
    // --- 7. ì—­ì‚¬ ê¸°ë¡ íŒ¨ë„ ì—…ë°ì´íŠ¸ ---
    function updateHistoryPanel(year) {
      const filteredRecords = history.filter(h => h.year === year);
      
      // const historyYearTitle = document.getElementById('historyYearTitle'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
      let titleText = `${year <= 0 ? ' ê¸°ì›ì „' : ' ì„œê¸°'} ${Math.abs(year)}ë…„ ì—­ì‚¬ ê¸°ë¡`;
      
      const firstKoreanRecord = filteredRecords.find(r => r.records?.korean?.content);
      if (firstKoreanRecord && firstKoreanRecord.event_name) {
        titleText += ` - ${firstKoreanRecord.event_name}`;
      }
      // historyYearTitle.textContent = titleText; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°

      // ğŸš© [ì œê±°] ì˜¤ë¥¸ìª½ íŒ¨ë„ ìš”ì†Œë“¤ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
      // const koreanContainer = document.getElementById('koreanRecords');
      // const foreignContainer = document.getElementById('foreignRecords');
      // const trueHistoryContainer = document.getElementById('trueHistoryRecords');

      // ğŸš© [ì¶”ê°€] ìƒì„±ì/ìˆ˜ì •ì ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” HTMLì„ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
      const createEditorInfoHtml = (record) => {
          const editorInfo = record.lastModifiedBy 
              ? `ë§ˆì§€ë§‰ ìˆ˜ì •: ${record.lastModifiedBy}` 
              : (record.createdBy ? `ìƒì„±ì: ${record.createdBy}` : '');
          
          return editorInfo 
              ? `<small style="float: right; color: #555; font-size: 10px;">${editorInfo}</small>` 
              : '';
      };

      // ğŸš© [ì œê±°] ì˜¤ë¥¸ìª½ íŒ¨ë„ìš© ì»¨í…ì¸  ìƒì„± ì½”ë“œ
      // const koreanContent = filteredRecords.filter(r => r.records?.korean?.content).map(r => `<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.korean.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.korean.source}</span><br>` : ''}${r.records.korean.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';
      // const foreignContent = filteredRecords.filter(r => r.records?.foreign?.content).map(r => `<div class="record-item foreign"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.foreign.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.foreign.source}</span><br>` : ''}${r.records.foreign.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';
      
      // koreanContainer.innerHTML = koreanContent;
      // foreignContainer.innerHTML = foreignContent;
      // trueHistoryContainer.innerHTML = filteredRecords.filter(r => r.records?.true_history?.content).map(r => `<div class="record-item true_history"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.true_history.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';
      
      // ğŸš© [ìˆ˜ì •] ëª¨ë“  ì—­ì‚¬ê¸°ë¡ì„ í†µí•©í•˜ì—¬ í‘œì‹œ (êµ¬ë¶„ ì—†ì´)
      const allRecordsContent = filteredRecords.flatMap(r => {
          const recordItems = [];
          if (r.records?.korean?.content) {
              recordItems.push(`<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.korean.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.korean.source}</span><br>` : ''}${r.records.korean.content.trim()}</div>`);
          }
          if (r.records?.foreign?.content) {
              recordItems.push(`<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.foreign.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.foreign.source}</span><br>` : ''}${r.records.foreign.content.trim()}</div>`);
          }
          if (r.records?.true_history?.content) {
              recordItems.push(`<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.true_history.content.trim()}</div>`);
          }
          return recordItems;
      }).join('') || 'ê¸°ë¡ ì—†ìŒ';
      
      // ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ ì—­ì‚¬ ê¸°ë¡ íŒ¨ë„ ì—…ë°ì´íŠ¸
      const mapHistoryYearTitle = document.getElementById('map-history-year-title');
      const mapAllRecordsContent = document.getElementById('map-all-records-content');
      if (mapHistoryYearTitle) mapHistoryYearTitle.textContent = titleText;
      if (mapAllRecordsContent) mapAllRecordsContent.innerHTML = allRecordsContent;

      
      // ğŸš© [ìˆ˜ì •] ê´€ë¦¬ìì´ê³  í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ 'ê¸°ë¡ ì¶”ê°€' ë²„íŠ¼ í‘œì‹œ - ì§€ë„ ë‚´ íŒ¨ë„ë§Œ ì‚¬ìš©
      // openHistoryFormBtn.style.display = (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) ? 'inline-block' : 'none'; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
      const mapOpenHistoryFormBtn = document.getElementById('map-open-history-form-btn');
      if (mapOpenHistoryFormBtn) {
          mapOpenHistoryFormBtn.style.display = (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) ? 'inline-block' : 'none';
      } 
    }


    // --- 8. ì„±/êµ°ëŒ€ í¼ ê´€ë¦¬ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    
    // ğŸš© [ìˆ˜ì •] ê²½ë¡œ ì§€ì  ì¶”ê°€ í•¨ìˆ˜ (í˜„ì¬ ë§ˆì»¤ ìœ„ì¹˜ ìë™ ì…ë ¥)
    window.addPathPoint = function(point = {}) {
        const list = pathDataList;
        
        // í˜„ì¬ ìŠ¬ë¼ì´ë”ì˜ ì—°ë„ì™€ ì›”ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ê°€ì ¸ì˜´
        const defaultYear = yearInput.value;
        const defaultMonth = monthInput.value;
        
        // í¸ì§‘ ë§ˆì»¤ê°€ ìˆëŠ” ê²½ìš° ìœ„ë„/ê²½ë„ë¥¼ ê°€ì ¸ì˜´
        let defaultLat = '';
        let defaultLng = '';
        if (editMarker) {
            const latlng = editMarker.getLatLng();
            defaultLat = latlng.lat.toFixed(6);
            defaultLng = latlng.lng.toFixed(6);
        }

        const row = document.createElement('div');
        row.className = 'path-point-row';
        
        row.innerHTML = `
            <input type="number" class="path-year path-time-input" placeholder="ì—°ë„" value="${point.target_year || defaultYear}" required>
            <input type="number" class="path-month path-time-input" placeholder="ì›”" min="1" max="12" value="${point.target_month || defaultMonth}" required>
            <input type="number" step="any" class="path-lat" placeholder="ìœ„ë„" value="${point.lat || defaultLat}" required>
            <input type="number" step="any" class="path-lng" placeholder="ê²½ë„" value="${point.lng || defaultLng}" required>
            <button type="button" onclick="removePathPoint(this)">X</button>
        `;
        list.appendChild(row);
    }
    
    // ğŸš© [ì¶”ê°€] ê²½ë¡œ ì§€ì  ì œê±° í•¨ìˆ˜ (ë™ì¼)
    window.removePathPoint = function(button) {
        button.closest('.path-point-row').remove();
    }

    // ğŸš© [ì¶”ê°€] í¼ì—ì„œ ê²½ë¡œ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ (ë™ì¼)
    function collectPathData() {
        const pathPoints = document.querySelectorAll('#pathDataList .path-point-row');
        const pathData = [];
        pathPoints.forEach(row => {
            pathData.push({
                target_year: parseInt(row.querySelector('.path-year').value) || null,
                target_month: parseInt(row.querySelector('.path-month').value) || 1,
                lat: parseFloat(row.querySelector('.path-lat').value) || null,
                lng: parseFloat(row.querySelector('.path-lng').value) || null,
            });
        });
        return pathData.filter(p => p.target_year !== null && p.lat !== null && p.lng !== null);
    }
    cancelCitySelectionBtn.addEventListener('click', () => {
        editCitySelectionForm.style.display = 'none';
    });
    editSelectedCityBtn.addEventListener('click', () => {
        const selectedCityId = citySelectForEdit.value;
        if (selectedCityId) { editCitySelectionForm.style.display = 'none'; openCastleForm(selectedCityId); } else { alert('í¸ì§‘í•  ë„ì‹œ/ì„±ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); }
    });

    
    // ì§€ë„ í´ë¦­ ì‹œ ì„± ì¶”ê°€ í¼ ì—´ê¸° (í¸ì§‘ ëª¨ë“œì—ì„œë§Œ)
    map.on('click', (e) => {
      // ğŸš© [ìˆ˜ì •] í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•ŒëŠ” ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ
      if (!editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return;
      
      // ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ëŠ” ì¤‘ì¼ ë•ŒëŠ” í¼ì„ ì—´ì§€ ì•Šê³  ì¢…ë£Œ
      if (isDrawing) return;

      // ğŸš© [ìˆ˜ì •] ì§€ë„ í´ë¦­ ì‹œ ë°”ë¡œ í¼ì„ ì—´ì§€ ì•Šê³ , ìš°í´ë¦­ ë©”ë‰´ë¥¼ í†µí•´ ì—´ë„ë¡ ë³€ê²½ (ì•„ë˜ contextmenu ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì°¸ì¡°)
      // ì´ í•¸ë“¤ëŸ¬ëŠ” ì´ì œ ë¹„ì–´ìˆì–´ë„ ë˜ì§€ë§Œ, í–¥í›„ ë‹¤ë¥¸ í´ë¦­ ê¸°ë°˜ ê¸°ëŠ¥ì„ ìœ„í•´ ë‚¨ê²¨ë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    });

    // ğŸš© [ì¶”ê°€] ì§€ë„ì—ì„œ ìš°í´ë¦­ ì‹œ ì¢Œí‘œ ë³µì‚¬ íŒì—… í‘œì‹œ
    map.on('contextmenu', (e) => {
      const latlng = e.latlng;
      const textToCopy = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
      
      // ğŸš© [ìˆ˜ì •] íŒì—… ì»¨í…ì¸ ë¥¼ flexboxë¡œ ì„¤ì •í•˜ì—¬ ë‚´ë¶€ ìš”ì†Œë“¤ì„ ì„¸ë¡œë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
      const popupContent = document.createElement('div');
      popupContent.style.display = 'flex';
      popupContent.style.flexDirection = 'column';
      popupContent.style.gap = '8px'; // ë²„íŠ¼ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ì˜ ê°„ê²©
      popupContent.innerHTML = `<span>${textToCopy}</span>`;
      
      const copyButton = document.createElement('button');
      copyButton.innerText = 'ì¢Œí‘œ ë³µì‚¬';
      copyButton.className = 'primary'; // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
      copyButton.onclick = () => {
        navigator.clipboard.writeText(textToCopy).then(() => {
          map.closePopup();
        }).catch(err => {
          console.error('ì¢Œí‘œ ë³µì‚¬ ì‹¤íŒ¨:', err);
          alert('ì¢Œí‘œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
      };

      const addCastleButton = document.createElement('button');
      addCastleButton.innerText = 'ì—¬ê¸°ì— ìƒˆ ì˜¤ë¸Œì íŠ¸ ë§Œë“¤ê¸°';
      addCastleButton.className = 'primary';
      addCastleButton.onclick = () => {
      map.closePopup();
      // ğŸš© [ì¶”ê°€] ì„± ì¶”ê°€ í¼ì„ ì—¬ëŠ” ë¡œì§
      editingCastleKey = null;
      closeAllFormsExcept('castleForm');
      openForm('castleForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
      addCastleForm.reset();
      document.getElementById('deleteCastle').style.display = 'none';
      
      // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('customIcon').value = '';
      document.getElementById('iconWidth').value = '';
      document.getElementById('iconHeight').value = '';
      
      document.getElementById('castleLat').value = e.latlng.lat.toFixed(6);
      document.getElementById('castleLng').value = e.latlng.lng.toFixed(6);
      
      const currentYear = parseInt(yearInput.value);
      const currentMonth = parseInt(monthInput.value);
      // document.getElementById('castleBuilt').value = currentYear;
      // document.getElementById('castleBuiltMonth').value = currentMonth;
      
      document.getElementById('pathDataList').innerHTML = ''; // ê²½ë¡œ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      // ğŸš© [ì¶”ê°€] í¼ ì—´ ë•Œ êµ­ê°€ í•„ë“œë¥¼ ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ì„¤ì •
      // document.getElementById('castleCountry').value = ''; 
      // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” ë° ê¸°ë³¸ í•­ëª© ì¶”ê°€
      document.getElementById('castleHistoryList').innerHTML = '';
      addCastleHistoryRow({
          name: '',
          country_id: '',
          start_year: currentYear,
          start_month: currentMonth,
          end_year: '',
          end_month: 12
      });

      // const defaultCountryName = document.getElementById('castleCountry').value;
      // const defaultCountry = getCountryInfoById(defaultCountryName);
      // if (defaultCountry) {
      //   document.getElementById('castleDestroyed').value = defaultCountry.end || '';
      //   document.getElementById('castleDestroyedMonth').value = defaultCountry.end_month || 12;
      // }
      
      if (editMarker) map.removeLayer(editMarker);
      editMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
      editMarker.on('dragend', (event) => {
        const marker = event.target;
        const position = marker.getLatLng();
        document.getElementById('castleLat').value = position.lat.toFixed(6);
        document.getElementById('castleLng').value = position.lng.toFixed(6);
      });
      editMarker.bindPopup('ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •').openPopup();
      
      // ğŸš© ìì—° ì§€ë¬¼/êµ°ëŒ€ í”Œë˜ê·¸ ë¯¸ì²´í¬ ìƒíƒœë¡œ ê´€ë ¨ ì„¹ì…˜ ìˆ¨ê¹€
      pathDataSection.style.display = 'none';
      militaryFlagDetails.style.display = 'none';
      
      naturalFeatureDetails.style.display = 'none';

      // ğŸš© ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° 'ì¼ë°˜'ìœ¼ë¡œ ì´ˆê¸°í™”
      setActiveMarkerType('normal');
      };

      popupContent.appendChild(copyButton);
      // ğŸš© [ì¶”ê°€] í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ 'ì„± ì¶”ê°€' ë²„íŠ¼ì„ íŒì—…ì— í‘œì‹œ
      if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) {
        popupContent.appendChild(addCastleButton);
      }

      L.popup()
        .setLatLng(latlng)
        .setContent(popupContent)
        .openOn(map);
    });

    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    markerTypeSelector.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const type = e.target.dataset.type;
            setActiveMarkerType(type);
        }
    });


    /** ì„± í¸ì§‘ í¼ ì—´ê¸° (ë§ˆì»¤ í´ë¦­ ì‹œ í˜¸ì¶œ) */
    window.openCastleForm = function(id) {
        if (!editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return; 
        const castle = castles.find(c => c._id === id);
        map.closePopup();
        if (!castle) return alert("ì„± ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    try { console.info('DEBUG: opening castle form for', id, castle); } catch (e) {}
        const countryInfo = getCountryInfoById(castle.country_id); 

        editingCastleKey = id;
        closeAllFormsExcept('castleForm');
        openForm('castleForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
        document.getElementById('cloneCastle').style.display = 'inline-block'; // ğŸš© [ì¶”ê°€] í¸ì§‘ ì‹œ ë³µì œ ë²„íŠ¼ í‘œì‹œ
        document.getElementById('deleteCastle').style.display = 'inline-block';
        
        // ğŸš© [ìˆ˜ì •] ìƒë‹¨ ëŒ€í‘œ ì´ë¦„ í•„ë“œë§Œ ì±„ì›ë‹ˆë‹¤.
        document.getElementById('castleName').value = castle.name; // ë©”ì¸ ì´ë¦„
        
        document.getElementById('castleLat').value = castle.lat;
        document.getElementById('castleLng').value = castle.lng;
        document.getElementById('castleDesc').value = castle.desc ?? '';
        document.getElementById('castlePhoto').value = castle.photo ?? '';
        // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ í•„ë“œ ë¡œë“œ
        document.getElementById('customIcon').value = castle.custom_icon ?? '';
        document.getElementById('iconWidth').value = castle.icon_width ?? '';
        document.getElementById('iconHeight').value = castle.icon_height ?? '';
        // ğŸš© [ì¶”ê°€] êµ­ê°€ê°€ ìˆì„ ê²½ìš°, ê¸°ë³¸ íŒŒê´´ ì—°ë„ ì„¤ì •ì„ ìœ„í•œ ê°’ ì €ì¥
        if (countryInfo) {
        }

        // ğŸš© [ìˆ˜ì •] ì²´í¬ë°•ìŠ¤ ëŒ€ì‹  ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
        let currentType = 'normal';
        if (castle.is_battle) {
            currentType = 'battle';
        } else if (castle.is_natural_feature) {
            currentType = 'natural';
        } else if (castle.is_military_flag) {
            currentType = 'military';
        } else if (castle.is_label) {
            currentType = 'label';
        }
        document.getElementById('labelSize').value = castle.label_size || 'medium'; // ğŸš© [ì¶”ê°€] ê¸€ì í¬ê¸° ë¡œë“œ
        setActiveMarkerType(currentType);

        // ğŸš© [ì¶”ê°€] ìì—° ë˜ëŠ” ì§€ëª… íƒ€ì…ì¼ ê²½ìš° êµ­ê°€ í•„ë“œë¥¼ 'ìì—°ì§€ë¬¼'ë¡œ ì„¤ì •
        if (currentType === 'label') {
            document.getElementById('labelColor').value = castle.label_color || '#FFFFFF';
        }

        // ğŸš© [ìˆ˜ì •] íƒ€ì…ì— ë”°ë¼ ë‹¨ì¼ ê¸°ê°„ í•„ë“œ ì±„ìš°ê¸°
        if (['natural', 'label'].includes(currentType)) {
            document.getElementById('simpleStartYear').value = castle.built_year || '';
            document.getElementById('simpleStartMonth').value = castle.built_month || '';
            document.getElementById('simpleEndYear').value = castle.destroyed_year || '';
            document.getElementById('simpleEndMonth').value = castle.destroyed_month || '';
        }

        // ğŸš© [ìˆ˜ì •] íƒ€ì…ì— ë”°ë¼ ì—­ì‚¬ ê¸°ë¡ ë˜ëŠ” ë‹¨ì¼ ê¸°ê°„ í•„ë“œ ì±„ìš°ê¸°
        if (currentType === 'normal' || currentType === 'battle') { // ğŸš© [ìˆ˜ì •] ì „ì¥ íƒ€ì…ë„ ì—­ì‚¬ ê¸°ë¡ ì‚¬ìš©
            // ì„±/ì™•ì„±/ì „ì¥: ë³µì¡í•œ ì—­ì‚¬ ê¸°ë¡
            const historyListContainer = document.getElementById('castleHistoryList'); 
            historyListContainer.innerHTML = ''; // ì´ˆê¸°í™” 

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ castle.historyê°€ ë¹„ì–´ìˆê±°ë‚˜ ì—†ì„ ê²½ìš°,
            // ìµœìƒìœ„ í•„ë“œ(name, country_id ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ ì—­ì‚¬ ê¸°ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤.
            const baseHistory = (castle.history && castle.history.length > 0)
                ? castle.history
                : [{
                    name: castle.name, country_id: castle.country_id,
                    start_year: castle.built_year, start_month: castle.built_month, end_year: castle.destroyed_year, end_month: castle.destroyed_month, is_capital: castle.is_capital, is_battle: castle.is_battle
                }];

            sortHistoryByStart(baseHistory).forEach(h => {
                addCastleHistoryRow(h);
            });
        } else {
            // ê·¸ ì™¸ íƒ€ì…: ë‹¨ìˆœ ê¸°ê°„ 
            document.getElementById('simpleStartYear').value = castle.built_year || castle.start_year || '';
            document.getElementById('simpleStartMonth').value = castle.built_month || '';
            document.getElementById('simpleEndYear').value = castle.destroyed_year || '';
            document.getElementById('simpleEndMonth').value = castle.destroyed_month || '';

            // êµ°ëŒ€ íƒ€ì… ê´€ë ¨ í•„ë“œ
            if (currentType === 'military') {
                // ğŸš© [ìˆ˜ì •] ìë™ ì™„ì„± input í•„ë“œì— ê°’ ì±„ìš°ê¸°
                militaryCountryId.value = castle.country_id || '';
                militaryCountryNameInput.value = castle.country_id ? getCountryInfoById(castle.country_id)?.name || '' : '';
                generalNameInput.value = castle.general_name || '';
                troopCountInput.value = castle.troop_count || '';
                generalPhotoInput.value = castle.general_photo || '';
                document.getElementById('pathDataList').innerHTML = '';
                if (Array.isArray(castle.path_data)) {
                    castle.path_data.forEach(point => addPathPoint(point));
                }
            } else if (currentType === 'natural') {
                const naturalTypeFromData = castle.natural_feature_type || 'mountain';
                const hasOption = Array.from(naturalFeatureType.options).some(opt => opt.value === naturalTypeFromData);
                naturalFeatureType.value = hasOption ? naturalTypeFromData : 'mountain';
            }
        }
        
        if (editMarker) map.removeLayer(editMarker);
        editMarker = L.marker([castle.lat, castle.lng], { draggable: true }).addTo(map);
        editMarker.on('dragend', (event) => {
            const marker = event.target;
            const position = marker.getLatLng();
            document.getElementById('castleLat').value = position.lat.toFixed(6);
            document.getElementById('castleLng').value = position.lng.toFixed(6);
        });
        // ğŸš© [ìˆ˜ì •] editMarkerê°€ ìœ íš¨í•  ë•Œë§Œ íŒì—…ì„ ì—´ë„ë¡ ìˆ˜ì •
        if (editMarker) {
            editMarker.bindPopup('ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •').openPopup();
        }

        map.setView([castle.lat, castle.lng], map.getZoom());
    };
    
    // êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ê±´ì„¤/íŒŒê´´ ì—°ë„ ìë™ ì±„ìš°ê¸°
    /*
    castleCountrySelect.addEventListener('change', (e) => {
        const selectedCountryId = e.target.value;
        const selectedCountry = getCountryInfoById(selectedCountryId);

        if (selectedCountry) {
            document.getElementById('castleBuilt').value = selectedCountry.start;
            document.getElementById('castleBuiltMonth').value = selectedCountry.start_month || 1;
            document.getElementById('castleDestroyed').value = selectedCountry.end || '';
            document.getElementById('castleDestroyedMonth').value = selectedCountry.end_month || 12;
        } else {
            document.getElementById('castleBuilt').value = yearInput.value;
            document.getElementById('castleDestroyed').value = '';
            document.getElementById('castleDestroyedMonth').value = 12;
        }
    });
    */
    
    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ë²„íŠ¼ ìƒíƒœë¥¼ ì„¤ì •í•˜ê³  ê´€ë ¨ UIë¥¼ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
    function setActiveMarkerType(type) {
        // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
        markerTypeSelector.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
        });
        // ì„ íƒëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
        const activeButton = markerTypeSelector.querySelector(`button[data-type="${type}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }

        // ğŸš© [í•µì‹¬ ìˆ˜ì •] íƒ€ì…ì— ë”°ë¼ UI ìš”ì†Œë“¤ì˜ ê°€ì‹œì„±ì„ ì œì–´í•©ë‹ˆë‹¤.
        const isCastle = (type === 'normal'); // ğŸš© [ìˆ˜ì •] 'capital' íƒ€ì… ì¡°ê±´ ì œê±°
        const isBattle = (type === 'battle'); // ğŸš© [ì¶”ê°€] ì „ì¥ íƒ€ì…
        const isMilitary = (type === 'military');
        const isNatural = (type === 'natural');
        const isLabel = (type === 'label');

        // ì´ë¦„ í•„ë“œ: êµ°ëŒ€ íƒ€ì…ì€ 'ì¥ìˆ˜ ì´ë¦„'ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ìˆ¨ê¹€
        const castleNameInput = document.getElementById('castleName');
        castleNameInput.closest('.form-row').style.display = isMilitary ? 'none' : 'flex';
        // êµ°ëŒ€ íƒ€ì…ì´ë©´ required ì œê±°, ì•„ë‹ˆë©´ required ì¶”ê°€
        if (isMilitary) {
            castleNameInput.removeAttribute('required');
        } else {
            castleNameInput.setAttribute('required', 'required');
        }

        // ë³µì¡í•œ ì—­ì‚¬ ê¸°ë¡ ì„¹ì…˜
        castleHistorySection.style.display = (isCastle || isBattle) ? 'block' : 'none';
        
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] íˆìŠ¤í† ë¦¬ ì„¹ì…˜ì´ ìˆ¨ê²¨ì§ˆ ë•Œ required ì†ì„± ì œê±°
        const historyInputs = castleHistorySection.querySelectorAll('input[required]');
        historyInputs.forEach(input => {
            if (!isCastle && !isBattle) {
                input.removeAttribute('required');
            }
        });

        // ë‹¨ìˆœ ê¸°ê°„ ì„¤ì • ì„¹ì…˜
        simpleDateSection.style.display = (isCastle || isBattle) ? 'none' : 'block';
        document.getElementById('simpleStartMonth').style.display = (isNatural || isLabel) ? 'none' : 'inline-block';
        document.getElementById('simpleEndMonth').style.display = (isNatural || isLabel) ? 'none' : 'inline-block';

        // ğŸš© [ìˆ˜ì •] ì„¤ëª… ë° ì‚¬ì§„ í•„ë“œ ê°€ì‹œì„± ë¡œì§ ë³µì›
        castleDescRow.style.display = (isCastle || isMilitary || isLabel || isBattle) ? 'flex' : 'none';
        castlePhotoRow.style.display = (isCastle || isLabel || isBattle) ? 'flex' : 'none';

        // êµ°ëŒ€ ì „ìš© í•„ë“œ
        militaryFlagDetails.style.display = isMilitary ? 'block' : 'none';
        pathDataSection.style.display = isMilitary ? 'block' : 'none';

        // ğŸš© [ìˆ˜ì •] êµ°ëŒ€ íƒ€ì…ì¼ ë•Œë§Œ ì†Œì† êµ­ê°€ ì…ë ¥ í•„ë“œë¥¼ í•„ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        document.getElementById('militaryCountryNameInput').required = isMilitary;


        // ìì—° ì „ìš© í•„ë“œ
        naturalFeatureDetails.style.display = isNatural ? 'flex' : 'none';

        // ì§€ëª… ì „ìš© í•„ë“œ
        document.getElementById('labelColorRow').style.display = isLabel ? 'flex' : 'none';
        document.getElementById('labelSizeRow').style.display = isLabel ? 'flex' : 'none';
    }
    
    // ğŸš© [ì¶”ê°€] ì„± í¸ì§‘ í¼ì— ì—­ì‚¬ ê¸°ë¡ í–‰ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addCastleHistoryRow(history = {}) {
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] ìƒˆ ê¸°ë¡ ì¶”ê°€ ì‹œ, ì´ì „ ê¸°ë¡ì˜ ì¢…ë£Œì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì‹œì‘ì¼ì„ ì„¤ì •í•˜ê³ , ìƒë‹¨ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        if (Object.keys(history).length === 0) { // ìƒˆ ê¸°ë¡ ì¶”ê°€ ì‹œì—ë§Œ (í¸ì§‘ ì‹œì—ëŠ” ì‹¤í–‰ ì•ˆ í•¨)
            const historyRows = document.querySelectorAll('#castleHistoryList .history-record-row');
            
            // ìƒë‹¨ í•„ë“œì˜ ì´ë¦„ì„ ê°€ì ¸ì™€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            history.name = document.getElementById('castleName').value;

            // ğŸš© [ìˆ˜ì •] ìƒˆ ê¸°ë¡ ì¶”ê°€ ì‹œ, ì´ì „ ê¸°ë¡ì˜ ì¢…ë£Œ ì—°ë„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘ ì—°ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
            if (historyRows.length > 0) {
                const lastRow = historyRows[historyRows.length - 1];
                const prevEndYear = parseInt(lastRow.querySelector('input.history-end-year').value || '');
                const prevEndMonth = parseInt(lastRow.querySelector('input.history-end-month').value || '');

                if (!isNaN(prevEndYear) && !isNaN(prevEndMonth)) {
                    history.start_year = (prevEndMonth === 12) ? prevEndYear + 1 : prevEndYear;
                    history.start_month = (prevEndMonth === 12) ? 1 : prevEndMonth + 1;
                }
            } else {
                // ğŸš© [ì¶”ê°€] ì´ì „ ê¸°ë¡ì´ ì—†ì„ ê²½ìš°, í˜„ì¬ ìŠ¬ë¼ì´ë”ì˜ ì—°ì›”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                history.start_year = parseInt(yearInput.value);
                history.start_month = parseInt(monthInput.value);
            }

            // ğŸš© [ì¶”ê°€] ìƒˆ ê¸°ë¡ ì¶”ê°€ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
            history.country_id = '';
            history.end_year = ''; // ë¹ˆ ê°’ìœ¼ë¡œ ì‹œì‘
            history.end_month = 12; // ğŸš© [ìˆ˜ì •] ì¢…ë£Œ ì›” ê¸°ë³¸ê°’ì„ 12ì›”ë¡œ ì„¤ì •
            history.is_capital = false; // ê¸°ë³¸ì ìœ¼ë¡œ ìˆ˜ë„ ì•„ë‹˜
        }

        const container = document.getElementById('castleHistoryList');
        const row = document.createElement('div');
        row.className = 'history-record-row'; 
        row.style.width = '100%'; 

        // ğŸš© [ìˆ˜ì •] êµ­ê°€ëª…ê³¼ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const countryName = history.country_id ? getCountryInfoById(history.country_id)?.name || '' : '';

        // ğŸš© [ìˆ˜ì •] í•œ ì¤„ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½
        // ğŸš© [ìˆ˜ì •] ê° ì…ë ¥ í•„ë“œ ìœ„ì— ë ˆì´ë¸” ì¶”ê°€
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] êµ­ê°€ ì„ íƒì„ <select>ì—ì„œ ìë™ ì™„ì„± <input>ìœ¼ë¡œ ë³€ê²½
        row.innerHTML = `
            <div class="history-field-container history-name"><label>ì´ë¦„</label><input type="text" class="history-name" name="history-name" placeholder="ì´ë¦„" value="${history.name || ''}" required></div>
            <div class="history-field-container history-country" style="position: relative;"><label>êµ­ê°€</label><input type="text" class="history-country-name" placeholder="êµ­ê°€ëª… ì…ë ¥..." autocomplete="off" value="${countryName}"><input type="hidden" class="history-country-id" value="${history.country_id || ''}"><div class="autocomplete-results"></div></div>
            <div class="history-field-container history-start-year"><label>ì‹œì‘ì—°ë„</label><input type="number" class="history-start-year" name="history-start-year" placeholder="ì‹œì‘" value="${history.start_year ?? ''}" required></div>
            <div class="history-field-container history-start-month"><label>ì›”</label><input type="number" class="history-start-month" name="history-start-month" placeholder="ì›”" min="1" max="12" value="${history.start_month || 1}" required></div>
            <span style="align-self: flex-end;">~</span>
            <div class="history-field-container history-end-year"><label>ì¢…ë£Œì—°ë„</label><input type="number" class="history-end-year" placeholder="ì¢…ë£Œ" value="${history.end_year ?? ''}"></div>
            <div class="history-field-container history-end-month"><label>ì›”</label><input type="number" class="history-end-month" placeholder="ì›”" min="1" max="12" value="${history.end_month ?? 12}"></div>
            <div class="history-field-container" style="align-self: flex-end;"><label style="margin-bottom: 8px;">ìˆ˜ë„</label><input type="checkbox" class="history-is-capital" ${history.is_capital ? 'checked' : ''}></div>
            <div class="history-field-container" style="align-self: flex-end;"><label style="margin-bottom: 8px;">ì „ì¥</label><input type="checkbox" class="history-is-battle" ${history.is_battle ? 'checked' : ''}></div>
            <button type="button" onclick="this.parentElement.remove()">X</button>
        `;
                // í¼ ì œì¶œ ì‹œ required ì—ëŸ¬ ë°©ì§€: ë¹ˆ ê°’ì´ë©´ required ì œê±° ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì •
                setTimeout(() => {
                    const startYearInput = row.querySelector('input.history-start-year');
                    if (startYearInput && (startYearInput.value === '' || startYearInput.value == null)) {
                        startYearInput.required = false;
                    }
                }, 0);
                container.appendChild(row);
    }
    // ğŸš© [ì¶”ê°€] 'ì—­ì‚¬ ê¸°ë¡ ì¶”ê°€' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('addCastleHistoryBtn').addEventListener('click', () => addCastleHistoryRow());


    // ì„± í¼ ì œì¶œ (ì €ì¥/ì—…ë°ì´íŠ¸)
    addCastleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // ğŸš© [í•µì‹¬ ìˆ˜ì •] ìˆ¨ê²¨ì§„ í•„ë“œì˜ required ì†ì„±ì„ ì„ì‹œë¡œ ì œê±°í•˜ì—¬ HTML5 ê²€ì¦ ìš°íšŒ
      const historyRows = document.querySelectorAll('#castleHistoryList .history-record-row');
      historyRows.forEach(row => {
          const nameInput = row.querySelector('input.history-name');
          const startYearInput = row.querySelector('input.history-start-year');
          if (nameInput) nameInput.removeAttribute('required');
          if (startYearInput) startYearInput.removeAttribute('required');
      });
      
      const isUpdate = editingCastleKey !== null;
      const url = isUpdate ? `${API_BASE_URL}/castle/${editingCastleKey}` : `${API_BASE_URL}/castle`;
      const method = isUpdate ? 'PUT' : 'POST';

      const selectedType = markerTypeSelector.querySelector('button.active')?.dataset.type || 'normal'; // ğŸš© [ìˆ˜ì •] 'capital' íƒ€ì… ì¡°ê±´ ì œê±°
// ğŸš© [í•„ìˆ˜ ìˆ˜ì •]: country í•„ë“œë¥¼ ì‚­ì œí•˜ê³  country_idë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
      // ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.

      const data = {
        name: document.getElementById('castleName').value,
        lat: parseFloat(document.getElementById('castleLat').value),
        lng: parseFloat(document.getElementById('castleLng').value),
        photo: document.getElementById('castlePhoto').value || null,
        desc: document.getElementById('castleDesc').value,
        is_capital: false, // ğŸš© [ìˆ˜ì •] ìµœìƒìœ„ is_capitalì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        is_battle: selectedType === 'battle',
        is_military_flag: selectedType === 'military',
        is_natural_feature: selectedType === 'natural',
        is_label: selectedType === 'label',
        label_color: document.getElementById('labelColor').value,
        label_size: document.getElementById('labelSize').value,
        natural_feature_type: selectedType === 'natural' ? document.getElementById('naturalFeatureType').value : null,
        custom_icon: document.getElementById('customIcon').value || null, // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜
        icon_width: document.getElementById('iconWidth').value ? parseInt(document.getElementById('iconWidth').value) : null, // ğŸš© [ì¶”ê°€] ì•„ì´ì½˜ ë„ˆë¹„
        icon_height: document.getElementById('iconHeight').value ? parseInt(document.getElementById('iconHeight').value) : null, // ğŸš© [ì¶”ê°€] ì•„ì´ì½˜ ë†’ì´
      };

      if (selectedType === 'normal' || selectedType === 'battle') { // ğŸš© [ìˆ˜ì •] ì „ì¥ íƒ€ì…ë„ ì—­ì‚¬ ê¸°ë¡ ì‚¬ìš©
          const historyRows = document.querySelectorAll('#castleHistoryList .history-record-row');
          const historyData = Array.from(historyRows).map(row => {
              const nameVal = row.querySelector('input.history-name').value;
              // Prefer hidden country id; if missing, attempt lookup by typed country name
              let countryIdVal = row.querySelector('input.history-country-id').value;
              if (!countryIdVal) {
                  const typedName = row.querySelector('input.history-country-name').value?.trim();
                  if (typedName) {
                      const matched = countries.find(c => c.name.toLowerCase() === typedName.toLowerCase());
                      if (matched) countryIdVal = matched._id;
                  }
              }

              const rawStartYear = row.querySelector('input.history-start-year').value;
              const rawStartMonth = row.querySelector('input.history-start-month').value;
              const rawEndYear = row.querySelector('input.history-end-year').value;
              const rawEndMonth = row.querySelector('input.history-end-month').value;

              const isBattleChecked = row.querySelector('input.history-is-battle')?.checked || false;
              console.log('ğŸ” ì „ì¥ ì²´í¬ë°•ìŠ¤ ìƒíƒœ:', isBattleChecked, 'for', nameVal);
              
              return {
                  name: nameVal,
                  country_id: countryIdVal || '', // keep empty string if not found
                  start_year: rawStartYear !== '' ? parseInt(rawStartYear) : null,
                  start_month: rawStartMonth !== '' ? parseInt(rawStartMonth) : 1,
                  end_year: rawEndYear !== '' ? parseInt(rawEndYear) : null,
                  end_month: rawEndMonth !== '' ? parseInt(rawEndMonth) : 12,
                  is_capital: row.querySelector('input.history-is-capital').checked,
                  is_battle: isBattleChecked
              };
          });

          data.history = historyData;
          // í˜¸í™˜ì„±ì„ ìœ„í•´ ì²« ë²ˆì§¸ ê¸°ë¡ì„ ëŒ€í‘œê°’ìœ¼ë¡œ ì €ì¥
          data.country_id = historyData[0]?.country_id;
          data.built_year = historyData[0]?.start_year;
          data.built_month = historyData[0]?.start_month;
          data.destroyed_year = historyData[0]?.end_year;
          data.destroyed_month = historyData[0]?.end_month;
      } else {
          // ë‹¨ìˆœ ê¸°ê°„ íƒ€ì…
          data.history = []; // ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
          data.built_year = document.getElementById('simpleStartYear').value ? parseInt(document.getElementById('simpleStartYear').value) : null;
          data.built_month = document.getElementById('simpleStartMonth').value ? parseInt(document.getElementById('simpleStartMonth').value) : null;
          data.destroyed_year = document.getElementById('simpleEndYear').value ? parseInt(document.getElementById('simpleEndYear').value) : null;
          data.destroyed_month = document.getElementById('simpleEndMonth').value ? parseInt(document.getElementById('simpleEndMonth').value) : null;
      }

      // ğŸš© [ì¶”ê°€] ìƒì„±ì ë° ìˆ˜ì •ì ì •ë³´ ì¶”ê°€
      if (isUpdate) {
        data.lastModifiedBy = currentUser.username;
      } else {
        data.createdBy = currentUser.username;
      }

      if (data.is_military_flag) {
        data.country_id = militaryCountryId.value; // ğŸš© [ìˆ˜ì •] hidden inputì—ì„œ êµ­ê°€ ID ì €ì¥
        data.name = generalNameInput.value; // êµ°ëŒ€ íƒ€ì…ì€ ì¥ìˆ˜ ì´ë¦„ì„ ë©”ì¸ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
        // ğŸš© ìˆ˜ì •: generalNameInput, troopCountInput, generalPhotoInput ì‚¬ìš©
        data.general_name = generalNameInput.value;
        data.troop_count = parseInt(troopCountInput.value) || 0;
        data.general_photo = generalPhotoInput.value || null; // ë§µí•‘ ë³€ìˆ˜ ì‚¬ìš©
        
        // ğŸš© ê²½ë¡œ ë°ì´í„° ì¶”ê°€
        data.path_data = collectPathData();
      } else {
        data.path_data = [];
      }
      
      if (!data.name || data.lat === undefined || data.lng === undefined) {
          return alert("ì˜¤ë¸Œì íŠ¸ì˜ ì´ë¦„, ìœ„ë„, ê²½ë„ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
      }
      if (data.is_military_flag && !data.country_id) {
          return alert("êµ°ëŒ€ì˜ ì†Œì† êµ­ê°€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
      }
      if (data.is_military_flag && data.path_data.length < 2) {
          alert("ê²½ë¡œ ì§€ì  2ê°œ ë¯¸ë§Œìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ì§€ë„ì—ì„œ êµ°ëŒ€ëŠ” ì´ë™í•˜ì§€ ì•Šê³  ì •ì  ìœ„ì¹˜ì— í‘œì‹œë©ë‹ˆë‹¤.");
      }
      try {
          const response = await fetch(url, {
              method: method,
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(data)
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
          }

          document.getElementById('castleForm').style.display = 'none';
          if (editMarker && map.hasLayer(editMarker) && editMarker.getPopup()) {
              editMarker.closePopup();
          }
          if (editMarker) {
              map.removeLayer(editMarker);
              editMarker = null;
          }
          
          // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì „ì²´ ê°±ì‹  ëŒ€ì‹ , ìƒì„±ëœ ì˜¤ë¸Œì íŠ¸ë§Œ ì§€ë„ì— ì¶”ê°€í•©ë‹ˆë‹¤.
          if (isUpdate) {
              // ìˆ˜ì •ì˜ ê²½ìš°, ë°ì´í„° ì •í•©ì„±ì„ ìœ„í•´ ì „ì²´ ê°±ì‹ 
              initialize();
          } else {
              // ì¶”ê°€ì˜ ê²½ìš°, ì „ì²´ ê°±ì‹  ì—†ì´ ìƒˆ ë°ì´í„°ë§Œ ë°˜ì˜
              const newCastle = await response.json();
              data._id = newCastle.id; // ì„œë²„ì—ì„œ ë°›ì€ IDë¥¼ ë°ì´í„°ì— ì¶”ê°€

              // Normalize the newly created castle's history so it matches the initialized format
              const normalizeHistoryEntry = (h, parent) => {
                  const resolvedCountryId = h.country_id || '';
                  const parsedStartYear = (h.start_year !== undefined && h.start_year !== null && h.start_year !== '') ? parseInt(h.start_year) : (parent?.built_year !== undefined && parent?.built_year !== null ? parseInt(parent.built_year) : -4000);
                  const parsedStartMonth = (h.start_month !== undefined && h.start_month !== null && h.start_month !== '') ? parseInt(h.start_month) : (parent?.built_month !== undefined && parent?.built_month !== null ? parseInt(parent.built_month) : 1);
                  const parsedEndYear = (h.end_year !== undefined && h.end_year !== null && h.end_year !== '') ? parseInt(h.end_year) : null;
                  const parsedEndMonth = (h.end_month !== undefined && h.end_month !== null && h.end_month !== '') ? parseInt(h.end_month) : (parent?.destroyed_month !== undefined && parent?.destroyed_month !== null ? parseInt(parent.destroyed_month) : 12);
                  return {
                      name: (h.name !== undefined && h.name !== null) ? h.name : (parent?.name || ''),
                      country_id: resolvedCountryId || '',
                      start_year: parsedStartYear,
                      start_month: parsedStartMonth,
                      end_year: parsedEndYear,
                      end_month: parsedEndMonth,
                      is_capital: !!h.is_capital
                  };
              };

              let normalizedHistory = [];
              if (Array.isArray(data.history) && data.history.length > 0) {
                  normalizedHistory = data.history.map(h => normalizeHistoryEntry(h, data));
              } else {
                  normalizedHistory = [normalizeHistoryEntry({
                      name: data.name,
                      country_id: data.country_id,
                      start_year: data.built_year,
                      start_month: data.built_month,
                      end_year: data.destroyed_year,
                      end_month: data.destroyed_month,
                      is_capital: data.is_capital
                  }, data)];
              }

              data.history = normalizedHistory;
              // Debug: log normalized history for newly created castle (visible in browser console)
              try { console.info('DEBUG: normalizedHistory for new castle', data._id, data.history); } catch (e) {}

              // Ensure top-level built/destroyed fallback values are numeric/null where applicable
              data.built_year = data.history[0]?.start_year ?? data.built_year ?? null;
              data.built_month = data.history[0]?.start_month ?? data.built_month ?? null;
              data.destroyed_year = data.history[0]?.end_year ?? data.destroyed_year ?? null;
              data.destroyed_month = data.history[0]?.end_month ?? data.destroyed_month ?? null;

              console.info('DEBUG: pushing new castle to local cache', data._id, data);
              castles.push(data); // ì „ì—­ ë°ì´í„°ì— ìƒˆ ì„± ì¶”ê°€
              
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month); // ì§€ë„ë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
              populateCitySelectForEdit(); // í¸ì§‘ìš© ë„ì‹œ ì„ íƒ ëª©ë¡ ê°±ì‹ 
          }
      } catch (error) {
        console.error("Castle ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
        alert(`Castle ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
      }
    });

    // ì„± í¼ ì·¨ì†Œ
    cancelCastle.addEventListener('click', () => {
      document.getElementById('castleForm').style.display = 'none';
      // ğŸš© [ì¶”ê°€] ë§ˆì»¤ì˜ íŒì—…ì„ ëª…ì‹œì ìœ¼ë¡œ ë‹«ì€ í›„ ë ˆì´ì–´ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
      if (editMarker && map.hasLayer(editMarker) && editMarker.getPopup()) {
          editMarker.closePopup();
      }
      if (editMarker) {
        map.removeLayer(editMarker);
        editMarker = null;
      }
    });

    // ì„± ì‚­ì œ
    deleteCastle.addEventListener('click', async () => {
        if (!editingCastleKey) return;

        if (!confirm('ì •ë§ë¡œ ì´ ì„±/ì „ì¥ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/castle/${editingCastleKey}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}` // ğŸš© [ìˆ˜ì •] ì‚­ì œ ìš”ì²­ì—ë„ í† í° ì¶”ê°€
                }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì„± ì‚­ì œ ì„±ê³µ í›„, ì„ì‹œ í¸ì§‘ ë§ˆì»¤ì™€ íŒì—…ì„ ì œê±°í•©ë‹ˆë‹¤.
            if (editMarker && map.hasLayer(editMarker) && editMarker.getPopup()) {
                editMarker.closePopup();
            }
            if (editMarker) {
                map.removeLayer(editMarker);
                editMarker = null;
            }
            document.getElementById('castleForm').style.display = 'none';
            initialize();
        } catch (error) {
            console.error("Castle ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Castle ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    // ğŸš© [ì¶”ê°€] ì„±/ì§€ë¬¼ ë³µì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('cloneCastle').addEventListener('click', () => {
        if (!editingCastleKey) return;

        const originalCastleName = document.getElementById('castleName').value;
        
        // ë³µì œ ëª¨ë“œë¡œ ì „í™˜
        editingCastleKey = null; // ìƒˆ í•­ëª©ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•´ í‚¤ë¥¼ nullë¡œ ì„¤ì •

        // UI ì—…ë°ì´íŠ¸
        document.querySelector('#castleForm h3').textContent = `'${originalCastleName}' ë³µì œí•˜ì—¬ ì •ë³´ ì¶”ê°€`;
        document.getElementById('deleteCastle').style.display = 'none';
        document.getElementById('cloneCastle').style.display = 'none';
        document.querySelector('#addCastleForm button[type="submit"]').textContent = 'ì¶”ê°€';

        // ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ í–‰ ì¶”ê°€ ì œê±° - ê¸°ì¡´ ë°ì´í„°ë§Œ ìœ ì§€
        alert(`'${originalCastleName}'ì˜ ë³µì œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  'ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
    });

    /** êµ­ê°€ ëª©ë¡ì„ ì„±/ìœ„ì¹˜ í¼ì˜ <select>ì— ì—…ë°ì´íŠ¸ */
    function updateCountrySelect() {
      // ì´ í•¨ìˆ˜ëŠ” ì´ì œ addCastleHistoryRow ë‚´ë¶€ì—ì„œ ë™ì ìœ¼ë¡œ í˜¸ì¶œë˜ë¯€ë¡œ, ì „ì—­ ì—…ë°ì´íŠ¸ëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤.
    }

    // ì§€ë„ ê²€ìƒ‰ ê¸°ëŠ¥ (ì´ë™ë§Œ)
    if (searchBtn) {
        searchBtn.addEventListener('click', async () => {
        const query = searchInput.value.trim().toLowerCase();
    if (!query) return;

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê²€ìƒ‰ ë¡œì§ ë³€ê²½: ì§€ì—­ëª…ê³¼ ì—­ì‚¬ ê¸°ë¡ì„ ëª¨ë‘ ê²€ìƒ‰
    if (query !== lastSearchQuery) {
        // ìƒˆë¡œìš´ ê²€ìƒ‰ì–´ì¼ ê²½ìš°
        // ğŸš© [ìˆ˜ì •] ëª¨ë“  ê°ì²´(ì„±, êµ°ëŒ€, ìì—°ì§€ë¬¼ ë“±)ì˜ ì´ë¦„ê³¼ ì¥ìˆ˜ ì´ë¦„ê¹Œì§€ ê²€ìƒ‰í•˜ë„ë¡ í•„í„°ë§ ì¡°ê±´ í™•ì¥
        const matchingCastles = castles
            .filter(c => 
                (c.name && c.name.toLowerCase().includes(query)) ||
                (c.general_name && c.general_name.toLowerCase().includes(query))
            )
            .map(c => ({ type: 'castle', data: c, year: c.built_year || c.built || 0 }));

        const matchingHistory = history
            .filter(h =>
                (h.event_name && h.event_name.toLowerCase().includes(query)) ||
                (h.records?.korean?.content && h.records.korean.content.toLowerCase().includes(query)) ||
                (h.records?.foreign?.content && h.records.foreign.content.toLowerCase().includes(query)) ||
                (h.records?.true_history?.content && h.records.true_history.content.toLowerCase().includes(query))
            )
            .map(h => ({ type: 'history', data: h, year: h.year }));

        // ğŸš© [ì¶”ê°€] ê·¸ë ¤ì§„ ì§€í˜•/ì§€ë¬¼(ê°•, ì„±ê³½ ë“±)ì˜ ì´ë¦„ë„ ê²€ìƒ‰ ëŒ€ìƒì— í¬í•¨
        const matchingDrawings = drawings
            .filter(d => d.name && d.name.toLowerCase().includes(query))
            .map(d => ({ type: 'drawing', data: d, year: d.start_year || 0 }));

        const combinedResults = [...matchingCastles, ...matchingHistory, ...matchingDrawings];

        if (combinedResults.length === 0) {
            alert(`"${query}"ì— í•´ë‹¹í•˜ëŠ” ì§€ì—­, ì¸ë¬¼, ì§€í˜• ë˜ëŠ” ì—­ì‚¬ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            lastSearchQuery = '';
            lastSearchResults = [];
            lastSearchIndex = -1;
            return;
        }

        // ê²°ê³¼ë¥¼ ì—°ë„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì €ì¥
        lastSearchResults = combinedResults.sort((a, b) => a.year - b.year);
        lastSearchQuery = query;
        lastSearchIndex = 0;
    } else {
        // ë™ì¼í•œ ê²€ìƒ‰ì–´ì¼ ê²½ìš°, ë‹¤ìŒ ê²°ê³¼ë¡œ ì¸ë±ìŠ¤ ì´ë™
        if (lastSearchResults.length === 0) return; // ì´ì „ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
        lastSearchIndex = (lastSearchIndex + 1) % lastSearchResults.length;
    }

    // í˜„ì¬ ì¸ë±ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ê²°ê³¼ë¡œ ì§€ë„ ë° ì‹œê°„ ì—…ë°ì´íŠ¸
    const currentResult = lastSearchResults[lastSearchIndex];
    
    if (currentResult.type === 'castle') {
        const castle = currentResult.data;
        const year = castle.built_year || castle.built;
        const month = castle.built_month || 1;
        if (year) updateTime(year, month);
        map.flyTo([castle.lat, castle.lng], 10);
    } else if (currentResult.type === 'history') {
        const historyItem = currentResult.data;
        const year = historyItem.year;
        const month = historyItem.month || 1;
        if (year) updateTime(year, month);
        // ì—­ì‚¬ ê¸°ë¡ì€ íŠ¹ì • ì¢Œí‘œê°€ ì—†ìœ¼ë¯€ë¡œ ì§€ë„ ì´ë™ì€ í•˜ì§€ ì•ŠìŒ
    } else if (currentResult.type === 'drawing') {
        const drawing = currentResult.data;
        const year = drawing.start_year;
        if (year) updateTime(year, 1); // ì›”ì€ 1ì›”ë¡œ ê³ ì •

        // GeoJSON ë°ì´í„°ì˜ ì¤‘ì‹¬ì ì„ ê³„ì‚°í•˜ì—¬ ì´ë™
        const tempLayer = L.geoJSON(drawing.geojson);
        const bounds = tempLayer.getBounds();
        if (bounds.isValid()) {
            map.flyTo(bounds.getCenter(), 8);
        }
    }
        }); // ğŸš© [ìˆ˜ì •] searchBtn.addEventListener ì¢…ë£Œ
    } // ğŸš© [ìˆ˜ì •] searchBtn ì¡´ì¬ ì—¬ë¶€ ì²´í¬ ì¢…ë£Œ
    
    // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ì°½ì—ì„œ ì—”í„° í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
    if (searchInput && searchBtn) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // í¼ ì œì¶œ ë“± ê¸°ë³¸ ë™ì‘ ë°©ì§€
                searchBtn.click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
            }
        });
    }

    // ğŸš© [ì¶”ê°€] ë©”ì¸ ê²€ìƒ‰ì°½ ìë™ ì™„ì„± ê¸°ëŠ¥
    const mainSearchResults = document.getElementById('mapSearchResults'); // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ ê²°ê³¼

    if (searchInput) {
        searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim().toLowerCase();
        mainSearchResults.innerHTML = '';

        if (query.length === 0) {
            mainSearchResults.style.display = 'none';
            return;
        }

        // ê²€ìƒ‰ ë¡œì§ (ê¸°ì¡´ searchBtn í´ë¦­ ì´ë²¤íŠ¸ì™€ ìœ ì‚¬)
        const matchingCastles = castles
            .filter(c => (c.name && c.name.toLowerCase().includes(query)) || (c.general_name && c.general_name.toLowerCase().includes(query)))
            .map(c => ({ type: 'castle', text: `[ì„±/ë„ì‹œ] ${c.name} (${c.built_year || c.built || 0}ë…„)`, data: c }));

        const matchingHistory = history
            .filter(h => (h.event_name && h.event_name.toLowerCase().includes(query)) || (h.records?.korean?.content && h.records.korean.content.toLowerCase().includes(query)) || (h.records?.foreign?.content && h.records.foreign.content.toLowerCase().includes(query)) || (h.records?.true_history?.content && h.records.true_history.content.toLowerCase().includes(query)))
            .map(h => ({ type: 'history', text: `[ì—­ì‚¬] ${h.event_name} (${h.year}ë…„)`, data: h }));

        const matchingDrawings = drawings
            .filter(d => d.name && d.name.toLowerCase().includes(query))
            .map(d => ({ type: 'drawing', text: `[ì§€í˜•] ${d.name} (${d.start_year || 0}ë…„)`, data: d }));

        const combinedResults = [...matchingCastles, ...matchingHistory, ...matchingDrawings]
            .sort((a, b) => (a.data.year || a.data.built_year || a.data.start_year || 0) - (b.data.year || b.data.built_year || b.data.start_year || 0));

        if (combinedResults.length === 0) {
            mainSearchResults.style.display = 'none';
            return;
        }

        combinedResults.forEach(result => {
            const div = document.createElement('div');
            div.textContent = result.text;
            div.style.padding = '10px 12px';
            div.style.cursor = 'pointer';
            div.style.fontSize = '14px';
            div.style.borderBottom = '1px solid #5d7185';
            div.onmouseover = () => div.style.backgroundColor = '#5d7185';
            div.onmouseout = () => div.style.backgroundColor = '';
            div.onclick = () => {
                // í•­ëª© í´ë¦­ ì‹œ ë™ì‘ (ê¸°ì¡´ searchBtn ë¡œì§ê³¼ ë™ì¼)
                if (result.type === 'castle') {
                    const castle = result.data;
                    const year = castle.built_year || castle.built;
                    const month = castle.built_month || 1;
                    if (year) updateTime(year, month);
                    map.flyTo([castle.lat, castle.lng], 10);
                } else if (result.type === 'history') {
                    const historyItem = result.data;
                    if (historyItem.year) updateTime(historyItem.year, historyItem.month || 1);
                } else if (result.type === 'drawing') {
                    const drawing = result.data;
                    if (drawing.start_year) updateTime(drawing.start_year, 1);
                    const tempLayer = L.geoJSON(drawing.geojson);
                    const bounds = tempLayer.getBounds();
                    if (bounds.isValid()) map.flyTo(bounds.getCenter(), 8);
                }
                searchInput.value = '';
                mainSearchResults.style.display = 'none';
            };
            mainSearchResults.appendChild(div);
        });

        mainSearchResults.style.display = 'block';
    });
    } // ğŸš© [ìˆ˜ì •] searchInput ì¡´ì¬ ì—¬ë¶€ ì²´í¬ ì¢…ë£Œ

    // ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ í•„í„° ê¸°ëŠ¥ ì—°ë™
    const mapSearchInput = document.getElementById('mapSearchInput');
    const mapSearchBtn = document.getElementById('mapSearchBtn');
    const mapCountryFilter = document.getElementById('mapCountryFilter');
    const mapSearchResults = document.getElementById('mapSearchResults');
    
    // ì§€ë„ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ê¸°ì¡´ searchBtnê³¼ ë™ì¼í•œ ë™ì‘
    if (mapSearchBtn) {
        mapSearchBtn.addEventListener('click', () => {
            searchInput.value = mapSearchInput.value;
            searchBtn.click();
        });
    }
    
    // ì§€ë„ ê²€ìƒ‰ ì…ë ¥ì°½ì—ì„œ ì—”í„° í‚¤ ì…ë ¥ ì‹œ
    if (mapSearchInput) {
        mapSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchInput.value = mapSearchInput.value;
                searchBtn.click();
            }
        });
        
        // ìë™ì™„ì„± ê¸°ëŠ¥
        mapSearchInput.addEventListener('input', () => {
            const query = mapSearchInput.value.trim().toLowerCase();
            mapSearchResults.innerHTML = '';
            
            if (query.length === 0) {
                mapSearchResults.style.display = 'none';
                return;
            }
            
            const matchingCastles = castles
                .filter(c => 
                    (c.name && c.name.toLowerCase().includes(query)) ||
                    (c.general_name && c.general_name.toLowerCase().includes(query))
                )
                .slice(0, 5);
            
            const matchingHistory = history
                .filter(h => h.event_name && h.event_name.toLowerCase().includes(query))
                .slice(0, 5);
            
            const matchingDrawings = drawings
                .filter(d => d.name && d.name.toLowerCase().includes(query))
                .slice(0, 3);
            
            const allResults = [...matchingCastles, ...matchingHistory, ...matchingDrawings];
            
            if (allResults.length === 0) {
                mapSearchResults.style.display = 'none';
                return;
            }
            
            allResults.forEach(item => {
                const div = document.createElement('div');
                div.style.padding = '8px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #5d7185';
                
                if (item.name) {
                    div.textContent = `${item.name} (${item.built_year || item.start_year || '?'}ë…„)`;
                } else if (item.event_name) {
                    div.textContent = `${item.event_name} (${item.year}ë…„)`;
                }
                
                div.addEventListener('mouseenter', () => div.style.backgroundColor = '#2c3e50');
                div.addEventListener('mouseleave', () => div.style.backgroundColor = 'transparent');
                
                div.onclick = () => {
                    mapSearchInput.value = item.name || item.event_name;
                    searchInput.value = mapSearchInput.value;
                    searchBtn.click();
                    mapSearchResults.style.display = 'none';
                };
                
                mapSearchResults.appendChild(div);
            });
            
            mapSearchResults.style.display = 'block';
        });
    }
    
    // ğŸš© [ì œê±°] mapCountryFilterì™€ countryFilterSelectëŠ” ê°™ì€ DOM ìš”ì†Œë¥¼ ê°€ë¦¬í‚¤ë¯€ë¡œ ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    // (line 4200ì—ì„œ countryFilterSelect.onchangeë¡œ ì´ë¯¸ ì²˜ë¦¬ë¨)

    // --- 9. êµ­ê°€ í¸ì§‘ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    
    function updateCountrySelectForEdit() {
        const select = countrySelectForEdit;
        // ğŸš© [ìˆ˜ì •] êµ­ê°€ ëª©ë¡ì— ë¯¼ì¡± ì •ë³´ í‘œì‹œ
        select.innerHTML = '<option value="">--- ê¸°ì¡´ êµ­ê°€ ì„ íƒ ---</option>' +
            countries.map(c => `<option value="${c.name}">${c.name}${c.ethnicity ? ` (${c.ethnicity})` : ''}</option>`).join('');
    }

    countrySelectForEdit.addEventListener('change', () => {
        const name = countrySelectForEdit.value;
        if (!name) {
            document.getElementById('editCountryForm').reset();
            document.getElementById('countryOriginalName').value = '';
            document.getElementById('deleteCountryBtn').style.display = 'none';
            document.getElementById('saveCountryBtn').textContent = 'ì €ì¥';
            return;
        }
        
        const country = getCountryInfo(name);
        if (!country) return;

        document.getElementById('countryOriginalName').value = country.name;
        document.getElementById('countryName').value = country.name;
        document.getElementById('countryStart').value = country.start;
        document.getElementById('countryStartMonth').value = country.start_month || 1;
        document.getElementById('countryEnd').value = country.end;
        document.getElementById('countryEndMonth').value = country.end_month || 12;
        document.getElementById('countryColor').value = country.color || '#ffffff'; // ğŸš© [ìˆ˜ì •] country.colorê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’(#ffffff)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        document.getElementById('countryFlag').value = country.flag || '';
        document.getElementById('countryEthnicity').value = country.ethnicity || '';
        document.getElementById('isMainDynasty').checked = country.is_main_dynasty || false;

        document.getElementById('deleteCountryBtn').style.display = 'inline-block';
        document.getElementById('saveCountryBtn').textContent = 'ì €ì¥';
    });
    
    // ğŸš© [ìˆ˜ì •] êµ­ê°€ í¸ì§‘ í¼ ë‚´ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ìë™ ì™„ì„± ë°©ì‹ìœ¼ë¡œ ë³€ê²½
    const countrySearchInputForEdit = document.getElementById('countrySearchForEdit');
    const countrySearchResults = document.getElementById('countrySearchResults');

    countrySearchInputForEdit.addEventListener('input', () => {
        const searchTerm = countrySearchInputForEdit.value.toLowerCase();
        countrySearchResults.innerHTML = '';
        if (searchTerm.length === 0) {
            countrySearchResults.style.display = 'none';
            return;
        }

        const filteredCountries = countries.filter(c => 
            c.name.toLowerCase().includes(searchTerm) || 
            (c.ethnicity && c.ethnicity.toLowerCase().includes(searchTerm))
        );

        filteredCountries.forEach(country => {
            const div = document.createElement('div');
            div.textContent = `${country.name}${country.ethnicity ? ` (${country.ethnicity})` : ''}`;
            div.style.padding = '8px';
            div.style.cursor = 'pointer';
            div.onmouseover = () => div.style.backgroundColor = '#5d7185';
            div.onmouseout = () => div.style.backgroundColor = '';
            div.onclick = () => {
                countrySearchInputForEdit.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                countrySelectForEdit.value = country.name; // select íƒœê·¸ ê°’ ë³€ê²½
                countrySelectForEdit.dispatchEvent(new Event('change')); // change ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
                countrySearchResults.style.display = 'none'; // ê²°ê³¼ ëª©ë¡ ìˆ¨ê¸°ê¸°
            };
            countrySearchResults.appendChild(div);
        });
        countrySearchResults.style.display = filteredCountries.length > 0 ? 'block' : 'none';
    });

    document.getElementById('editCountryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const originalName = document.getElementById('countryOriginalName').value;
        const newName = document.getElementById('countryName').value;
        const isUpdate = !!originalName;
        
        const data = {
            name: newName,
            start: parseInt(document.getElementById('countryStart').value),
            start_month: parseInt(document.getElementById('countryStartMonth').value) || 1,
            end: document.getElementById('countryEnd').value ? parseInt(document.getElementById('countryEnd').value) : null,
            end_month: parseInt(document.getElementById('countryEndMonth').value) || 12,
            color: document.getElementById('countryColor').value,
            flag: document.getElementById('countryFlag').value || null,
            ethnicity: document.getElementById('countryEthnicity').value || null,
            is_main_dynasty: document.getElementById('isMainDynasty').checked
        };
        
        if (!data.name || isNaN(data.start) || !data.color) {
            return alert("êµ­ê°€ ì´ë¦„, ì‹œì‘ ì—°ë„, ìƒ‰ìƒì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        try {
            let url = `${API_BASE_URL}/countries`;
            let method = 'POST';

            if (isUpdate) {
                url = `${API_BASE_URL}/countries/${encodeURIComponent(originalName)}`; 
                method = 'PUT';
            }
            
            const response = await fetch(url, {
                method: method,
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // ğŸš© [ìˆ˜ì •] ì¸ì¦ í† í° ì¶”ê°€
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            alert(isUpdate ? "êµ­ê°€ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ìƒˆ êµ­ê°€ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // 1. ë°ì´í„°ë² ì´ìŠ¤ ê°±ì‹  (ì „ì²´ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ)
            await initialize();

            // 2. í¼ í•„ë“œë¥¼ ë¨¼ì € ë¦¬ì…‹í•©ë‹ˆë‹¤.
            document.getElementById('editCountryForm').reset();
            document.getElementById('countryOriginalName').value = '';
            document.getElementById('deleteCountryBtn').style.display = 'none';
            document.getElementById('saveCountryBtn').textContent = 'ì €ì¥/ì¶”ê°€';
            document.getElementById('countryColor').value = '#ffffff'; // ìƒ‰ìƒ ê¸°ë³¸ê°’
            document.getElementById('countrySearchForEdit').value = ''; // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”

            // 3. ğŸš© [í•µì‹¬ ìˆ˜ì •] ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ëœ í›„ì—, ìˆ˜ì •í–ˆë˜ êµ­ê°€ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì¤ë‹ˆë‹¤.
            // ì´ë ‡ê²Œ í•˜ë©´ initialize()ì— ì˜í•´ ë“œë¡­ë‹¤ìš´ì´ ì¬ìƒì„±ëœ í›„ì—ë„ ì„ íƒì´ ìœ ì§€ë©ë‹ˆë‹¤.
            document.getElementById('countrySelectForEdit').value = newName;

        } catch (error) {
            console.error("Country ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Country ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    document.getElementById('deleteCountryBtn').addEventListener('click', async () => {
        const originalName = document.getElementById('countryOriginalName').value;
        if (!originalName || !confirm('ì •ë§ë¡œ ì´ êµ­ê°€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ë‹¹ êµ­ê°€ì˜ ëª¨ë“  ì„±/ì „ì¥ ì •ë³´ëŠ” ìœ ì§€ë˜ì§€ë§Œ êµ­ê°€ ì •ë³´ê°€ ì—†ì–´ì§‘ë‹ˆë‹¤.')) return;
        try {
            const response = await fetch(`${API_BASE_URL}/countries/${originalName}`, { 
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            document.getElementById('countryForm').style.display = 'none';
            initialize();
        } catch (error) {
            console.error("Country ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Country ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    document.getElementById('cancelCountryBtn').addEventListener('click', () => {
        document.getElementById('countryForm').style.display = 'none';
    });

    // --- 10. ì´ë²¤íŠ¸ í¸ì§‘ í¼ ê´€ë¦¬ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function populateEventSelect() {
        const select = document.getElementById('eventSelect');
        // ğŸš© [ìˆ˜ì •] ì—°ë„ ìˆœìœ¼ë¡œ ì •ë ¬
        events.sort((a, b) => a.year - b.year || a.month - b.month);
        select.innerHTML = '<option value="">--- ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ---</option>' +
            events.map(event => `<option value="${event._id}">${event.year}ë…„: ${event.text}</option>`).join('');
    }

    document.getElementById('eventSelect').addEventListener('change', (e) => {
        const eventId = e.target.value;
        const form = document.getElementById('editEventForm');
        const deleteBtn = document.getElementById('deleteEventBtn');
        const saveBtn = document.getElementById('saveEventBtn');

        if (!eventId) {
            form.reset();
            document.getElementById('eventMongoId').value = '';
            deleteBtn.style.display = 'none';
            saveBtn.textContent = 'ì €ì¥/ì¶”ê°€';
            return;
        }

        const event = events.find(ev => ev._id === eventId);
        if (event) {
            document.getElementById('eventMongoId').value = event._id;
            document.getElementById('eventYear').value = event.year;
            document.getElementById('eventMonth').value = event.month || 1;
            document.getElementById('eventText').value = event.text;
            document.getElementById('eventPhoto').value = event.photo || ''; // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL í•„ë“œ ì±„ìš°ê¸°
            deleteBtn.style.display = 'inline-block';
            saveBtn.textContent = 'ì €ì¥';
        }
    });

    document.getElementById('editEventForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const eventId = document.getElementById('eventMongoId').value;
        const isUpdate = !!eventId;
        const url = isUpdate ? `${API_BASE_URL}/events/${eventId}` : `${API_BASE_URL}/events`;
        const method = isUpdate ? 'PUT' : 'POST';

        const data = {
            year: parseInt(document.getElementById('eventYear').value),
            month: parseInt(document.getElementById('eventMonth').value) || 1,
            text: document.getElementById('eventText').value,
            photo: document.getElementById('eventPhoto').value || null, // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL ë°ì´í„° ìˆ˜ì§‘
        };

        if (isNaN(data.year) || !data.text) {
            return alert("ì—°ë„ì™€ ì´ë²¤íŠ¸ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        }

        try {
            const response = await fetch(url, { 
                method: method, 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                body: JSON.stringify(data) 
            });
            if (!response.ok) throw new Error('ì´ë²¤íŠ¸ ì €ì¥ ì‹¤íŒ¨');
            document.getElementById('eventForm').style.display = 'none';
            initialize();
        } catch (error) { alert(error.message); }
    });

    document.getElementById('deleteEventBtn').addEventListener('click', async () => {
        const eventId = document.getElementById('eventMongoId').value;
        if (!eventId || !confirm('ì´ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try { 
            const response = await fetch(`${API_BASE_URL}/events/${eventId}`, { 
                method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } 
            });
            if (!response.ok) throw new Error('ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨');
            document.getElementById('eventForm').style.display = 'none';
            initialize();
        } catch (error) { alert(error.message); }
    });

    document.getElementById('cancelEventBtn').addEventListener('click', () => { document.getElementById('eventForm').style.display = 'none'; });

    // --- 10. ì™• í¸ì§‘ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)

    // ğŸš© [ìˆ˜ì •] ì™• í¸ì§‘ í¼ì˜ êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateKingCountrySelect() {
        const select = document.getElementById('kingCountrySelect');
        if (!select) return;
        select.innerHTML = '<option value="">-- ëª©ë¡ì—ì„œ ì„ íƒ --</option>' + 
            countries.map(c => `<option value="${c._id}">${c.name}${c.ethnicity ? ` (${c.ethnicity})` : ''}</option>`).join('');
    }

    // ğŸš© [ì¶”ê°€] êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ, ì…ë ¥ì°½ê³¼ IDë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('kingCountrySelect').addEventListener('change', (e) => {
        const countryId = e.target.value;
        const country = getCountryInfoById(countryId);
        
        document.getElementById('kingCountryId').value = countryId;
        document.getElementById('kingCountryNameInput').value = country ? country.name : '';
        
        if (countryId) {
            loadKingsForCountry();
        }
    });
    
    // ğŸš© [ìˆ˜ì •] ì™• í¸ì§‘ í¼ì˜ êµ­ê°€ ê²€ìƒ‰ ìë™ ì™„ì„± ê¸°ëŠ¥ (ë“œë¡­ë‹¤ìš´ê³¼ ì—°ë™)
    const kingCountryNameInput = document.getElementById('kingCountryNameInput');
    const kingCountryResults = document.getElementById('kingCountryResults');
    const kingCountryIdInput = document.getElementById('kingCountryId');

    kingCountryNameInput.addEventListener('input', () => {
        const searchTerm = kingCountryNameInput.value.toLowerCase();
        kingCountryResults.innerHTML = '';
        if (searchTerm.length === 0) {
            kingCountryResults.style.display = 'none';
            return;
        }

        const filteredCountries = countries.filter(c => c.name.toLowerCase().includes(searchTerm));
        
        filteredCountries.forEach(country => {
            const div = document.createElement('div');
            div.textContent = `${country.name}${country.ethnicity ? ` (${country.ethnicity})` : ''}`;
            div.style.padding = '8px';
            div.style.cursor = 'pointer';
            div.onmouseover = () => div.style.backgroundColor = '#5d7185';
            div.onmouseout = () => div.style.backgroundColor = '';
            div.onclick = () => {
                kingCountryNameInput.value = country.name;
                kingCountryIdInput.value = country._id;
                document.getElementById('kingCountrySelect').value = country._id; // ğŸš© [ì¶”ê°€] ë“œë¡­ë‹¤ìš´ë„ í•¨ê»˜ ë³€ê²½
                kingCountryResults.style.display = 'none';
                loadKingsForCountry(); // êµ­ê°€ê°€ ì„ íƒë˜ì—ˆìœ¼ë¯€ë¡œ ì™• ëª©ë¡ì„ ë¡œë“œí•©ë‹ˆë‹¤.
            };
            kingCountryResults.appendChild(div);
        });

        kingCountryResults.style.display = filteredCountries.length > 0 ? 'block' : 'none';
    });

    // ì…ë ¥ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ëª©ë¡ ìˆ¨ê¸°ê¸°
    document.addEventListener('click', (e) => {
        if (e.target !== kingCountryNameInput && e.target !== kingCountryResults) {
            kingCountryResults.style.display = 'none';
        }
    });

    function loadKingsForCountry(resetForm = false) {
        // ğŸš© [ìˆ˜ì •] ìˆ¨ê²¨ì§„ inputì—ì„œ countryIdë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const countryId = kingCountryIdInput.value;
        const kingKey = countryId;
        const kingList = kings[kingKey] || [];
        
        const select = kingSelect;
        select.innerHTML = '<option value="">--- ìƒˆ ì™• ì¶”ê°€ ---</option>' + 
                          kingList.map((k, index) => {
                              const startMonth = k.start_month || 1;
                              const endMonth = k.end_month || 1;
                              const endYearText = k.end === null ? 'í˜„ì¬' : `${k.end}ë…„ ${endMonth}ì›”`;
                              
                              return `<option value="${index}" 
                                        data-start="${k.start}" 
                                        data-end="${k.end}"
                                        data-start-month="${startMonth}"
                                        data-end-month="${endMonth}"
                                        data-id="${k._id ? k._id.toString() : ''}"
                                >${k.name} (${k.start}ë…„ ${startMonth}ì›” ~ ${endYearText})</option>`;
                          }).join('');
        if (resetForm) {
            document.getElementById('kingName').value = '';
            document.getElementById('kingStart').value = '';
            document.getElementById('kingStartMonth').value = 1;
            document.getElementById('kingEnd').value = '';
            document.getElementById('kingEndMonth').value = 12;
            document.getElementById('kingOriginalKey').value = '';
            document.getElementById('kingOriginalIndex').value = '';
            document.getElementById('deleteKingBtn').style.display = 'none';
            document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
        }
    }

kingSelect.addEventListener('change', () => {
    const index = kingSelect.value;
    // ğŸš© [ìˆ˜ì •] ìˆ¨ê²¨ì§„ inputì—ì„œ countryIdë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const countryId = kingCountryIdInput.value;
    const kingList = kings[countryId] || []; // â¬…ï¸ ì˜¬ë°”ë¥¸ ì¡°íšŒ
    const kingMongoIdField = document.getElementById('kingMongoId'); 
        
        if (index === "") {
            document.getElementById('editKingForm').reset();
            document.getElementById('kingName').value = '';
            document.getElementById('kingStartMonth').value = 1;
            document.getElementById('kingEndMonth').value = 1;
            document.getElementById('kingOriginalKey').value = '';
            document.getElementById('kingOriginalIndex').value = '';
            document.getElementById('deleteKingBtn').style.display = 'none';
            document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
            kingMongoIdField.value = ''; 

            return;
        }

        const king = kingList[parseInt(index)];
        if (!king) return;
        kingMongoIdField.value = king._id ? king._id.toString() : ''; 
        
        
        document.getElementById('kingName').value = king.name;
        document.getElementById('kingStart').value = king.start;
        document.getElementById('kingStartMonth').value = king.start_month || 1;
        document.getElementById('kingEnd').value = king.end || '';
        document.getElementById('kingEndMonth').value = king.end_month || 12;
        document.getElementById('kingOriginalKey').value = countryId;
        document.getElementById('kingOriginalIndex').value = index;
        document.getElementById('deleteKingBtn').style.display = 'inline-block';
        document.getElementById('saveKingBtn').textContent = 'ì €ì¥';
    });



    // ì™• í¼ ì œì¶œ (ì¶”ê°€/ìˆ˜ì •)
    document.getElementById('editKingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const kingMongoId = document.getElementById('kingMongoId').value; 
        const isUpdate = kingMongoId !== '';
        
        // ğŸš© [ìˆ˜ì •] ìˆ¨ê²¨ì§„ inputì—ì„œ countryIdë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const countryId = document.getElementById('kingCountryId').value;

        const newKingData = {
            countryId: countryId, // ğŸš¨ countryIdë¥¼ ì „ì†¡
            name: document.getElementById('kingName').value,
            start: parseInt(document.getElementById('kingStart').value),
            start_month: parseInt(document.getElementById('kingStartMonth').value) || 1,
            end: parseInt(document.getElementById('kingEnd').value) || null,
            end_month: parseInt(document.getElementById('kingEndMonth').value) || 12,
        };

        // ğŸš© [ìˆ˜ì •] ì—…ë°ì´íŠ¸ ì‹œì—ëŠ” ì™•ì˜ _idë¥¼ ë°ì´í„°ì— í¬í•¨ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.
        if (isUpdate) {
            newKingData._id = kingMongoId;
        }
        
        if (!newKingData.name || isNaN(newKingData.start)) {
            return alert("ì™• ì´ë¦„ê³¼ ì‹œì‘ ì—°ë„ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        let method = isUpdate ? 'PUT' : 'POST';
        let url = isUpdate ? `${API_BASE_URL}/kings/${kingMongoId}` : `${API_BASE_URL}/kings`; 

        try {
            const response = await fetch(url, {
                method: method, 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(newKingData)
            });

            if (!response.ok) {
                const errorData = await response.json(); 
                throw new Error(`${response.status}: ${errorData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
            
            if (!isUpdate) { // ì¶”ê°€(POST) ì„±ê³µ ì‹œì—ë§Œ ì—°ì† ì¶”ê°€ ëª¨ë“œ ì‘ë™
                
                // 1. ë°ì´í„°ë² ì´ìŠ¤ ê°±ì‹  ë° UI ì—…ë°ì´íŠ¸
                await initialize();
                
                // 2. êµ­ê°€ëª…ê³¼ êµ­ê°€ IDëŠ” ìœ ì§€
                document.getElementById('kingCountryId').value = countryId; 
                
                // 3. í¼ í•„ë“œ ë¦¬ì…‹
                document.getElementById('editKingForm').reset();

                // ğŸš© [ì¶”ê°€] í¼ ë¦¬ì…‹ í›„, ìœ ì§€í•´ì•¼ í•  êµ­ê°€ëª…ê³¼ ë“œë¡­ë‹¤ìš´ ì„ íƒ ìƒíƒœë¥¼ ë³µì›í•©ë‹ˆë‹¤.
                const preservedCountry = getCountryInfoById(countryId);
                if (preservedCountry) {
                    document.getElementById('kingCountryNameInput').value = preservedCountry.name;
                    document.getElementById('kingCountrySelect').value = countryId;
                }
                
                // 4. ë¦¬ì…‹ í›„, ì´ˆê¸°ê°’ê³¼ ë²„íŠ¼ ìƒíƒœ ì¬ì„¤ì •
                document.getElementById('kingSelect').value = ''; // 'ìƒˆ ì™• ì¶”ê°€' ì„ íƒ
                document.getElementById('kingStartMonth').value = 1;
                document.getElementById('kingEndMonth').value = 12;
                document.getElementById('deleteKingBtn').style.display = 'none';
                document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
                document.getElementById('kingMongoId').value = '';
                
                // 5. í˜„ì¬ êµ­ê°€ì˜ ì™• ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
                loadKingsForCountry(false); // ë¦¬ì…‹í•˜ì§€ ì•ŠìŒ (í¼ì€ ì´ë¯¸ ë¦¬ì…‹ë¨)

            //    alert("ì™• ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ê°™ì€ êµ­ê°€ì— ì—°ì† ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

            } else { // ìˆ˜ì •(PUT) ì„±ê³µ ì‹œ
                // 1. ë°ì´í„°ë² ì´ìŠ¤ ê°±ì‹  (ì „ì²´ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ)
                await initialize();

                // 2. êµ­ê°€ ì„ íƒ ìœ ì§€
                document.getElementById('kingCountryId').value = countryId;

                // 3. í¼ í•„ë“œ ë¦¬ì…‹
                document.getElementById('editKingForm').reset();
                document.getElementById('kingSelect').value = ''; // 'ìƒˆ ì™• ì¶”ê°€' ì„ íƒ
                document.getElementById('kingStartMonth').value = 1;
                document.getElementById('kingEndMonth').value = 12;
                document.getElementById('deleteKingBtn').style.display = 'none';
                document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
                document.getElementById('kingMongoId').value = ''; // ğŸš© [í•µì‹¬ ìˆ˜ì •] ìˆ˜ì • ì™„ë£Œ í›„, ë‹¤ìŒ ì‘ì—…ì„ ìœ„í•´ ì™• IDë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.

                // 4. í˜„ì¬ êµ­ê°€ì˜ ì™• ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
                loadKingsForCountry(false);
                alert("ì™• ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ì†í•´ì„œ ì‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }

        } catch (error) {
            console.error("King ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`King ì •ë³´ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    // ì™• í¼ ì‚­ì œ (DELETE ìš”ì²­)
    document.getElementById('deleteKingBtn').addEventListener('click', async () => {
        const kingMongoId = document.getElementById('kingMongoId').value; 
        
        if (!kingMongoId || !confirm('ì •ë§ë¡œ ì´ ì™•ì˜ ì¬ìœ„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/kings/${kingMongoId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`${response.status}: ${errorData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }

            document.getElementById('kingForm').style.display = 'none';
            initialize(); 
        } catch (error) {
            console.error("King ì •ë³´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`King ì •ë³´ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    });


    // ğŸ‘‘ ì™• í¸ì§‘ ëª¨ë“œì—ì„œ í˜¸ì¶œ: URL IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì™• ì •ë³´ í¼ì— ì±„ìš°ê¸°
    window.editKing = (kingsId) => {
        document.getElementById('kingMongoId').value = kingsId; 
        document.getElementById('deleteKingBtn').style.display = 'inline';
        document.getElementById('saveKingBtn').textContent = 'ì €ì¥';


    if (!kingsId) return alert('í¸ì§‘í•  ì™•ì˜ IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');

    let targetKing = null;
    let countryId = null; 

    outer: for (const key in kings) {
        if (kings.hasOwnProperty(key)) {
            const index = kings[key].findIndex(k => k._id && k._id.toString() === kingsId);
            if (index !== -1) {
                targetKing = kings[key][index];
                countryId = key; // ğŸš© keyëŠ” ì´ì œ countryIdì…ë‹ˆë‹¤.
                break outer;
            }
        }
    }

    if (!targetKing) {
        console.error("IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", kingsId);
        return alert('í•´ë‹¹ IDë¥¼ ê°€ì§„ ì™• ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„° ë¶ˆì¼ì¹˜)');
    }
    // ğŸš¨ [í•µì‹¬ ìˆ˜ì •] countryIdë¥¼ <select>ì— ì„¤ì •í•˜ì—¬ loadKingsForCountryê°€ ì‘ë™í•˜ë„ë¡ í•¨
    kingCountryIdInput.value = countryId;
    kingCountryNameInput.value = getCountryInfoById(countryId)?.name || '';
    document.getElementById('kingCountrySelect').value = countryId; // ğŸš© [ì¶”ê°€] ë“œë¡­ë‹¤ìš´ë„ í•¨ê»˜ ë³€ê²½
    // ğŸš© [ì¶”ê°€] êµ­ê°€ë¥¼ ì„ íƒí–ˆìœ¼ë¯€ë¡œ, í•´ë‹¹ êµ­ê°€ì˜ ì™• ëª©ë¡ì„ ë¡œë“œí•˜ì—¬ <select>ì— ì±„ì›ë‹ˆë‹¤.
    loadKingsForCountry(false); // falseë¡œ ì„¤ì •í•˜ì—¬ í˜„ì¬ í¼ ê°’(countryId)ì„ ìœ ì§€

    // ğŸš© [ì¶”ê°€] ë¡œë“œëœ ëª©ë¡ì—ì„œ í˜„ì¬ ì™•ì„ ì°¾ì•„ì„œ kingSelectë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    const kingList = kings[countryId];
    const targetIndex = kingList.findIndex(k => k._id && k._id.toString() === kingsId);
    document.getElementById('kingSelect').value = targetIndex.toString(); // <select> ê°’ì„ í•´ë‹¹ indexë¡œ ë³€ê²½

        
        document.getElementById('kingName').value = targetKing.name || '';
        document.getElementById('kingStart').value = targetKing.start || '';
        document.getElementById('kingStartMonth').value = targetKing.start_month || 1;
        document.getElementById('kingEnd').value = targetKing.end || '';
        document.getElementById('kingEndMonth').value = targetKing.end_month || 12;
        
        document.getElementById('kingForm').style.display = 'block';
    }; 

    document.getElementById('cancelKingBtn').addEventListener('click', () => {
        document.getElementById('kingForm').style.display = 'none';
    }); 
    
    document.getElementById('editDrawingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const drawingId = document.getElementById('drawingMongoId').value;
        const isUpdate = !!drawingId;
        const url = isUpdate ? `${API_BASE_URL}/drawings/${drawingId}` : `${API_BASE_URL}/drawings`;
        const method = isUpdate ? 'PUT' : 'POST';

        const data = {
            name: document.getElementById('drawingName').value,
            type: document.getElementById('drawingType').value,
            start_year: parseInt(document.getElementById('drawingStartYear').value),
            end_year: document.getElementById('drawingEndYear').value ? parseInt(document.getElementById('drawingEndYear').value) : null,
            geojson: JSON.parse(document.getElementById('drawingGeoJson').value)
        };

        if (!data.name || isNaN(data.start_year)) {
            return alert("ì´ë¦„ê³¼ ì‹œì‘ ì—°ë„ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        }

        try {
            const response = await fetch(url, { 
                method, 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                body: JSON.stringify(data) 
            });
            if (!response.ok) throw new Error('ê·¸ë¦¬ê¸° ì •ë³´ ì €ì¥ ì‹¤íŒ¨');
            document.getElementById('drawingForm').style.display = 'none';
            initialize();
        } catch (error) { alert(error.message); }
    });

    document.getElementById('cancelDrawingBtn').addEventListener('click', () => { document.getElementById('drawingForm').style.display = 'none'; });

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê·¸ë¦¬ê¸° í¼ì˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    document.getElementById('deleteDrawingBtn').addEventListener('click', async () => {
        const drawingId = document.getElementById('drawingMongoId').value;
        if (!drawingId || !confirm('ì •ë§ë¡œ ì´ ë„í˜•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/drawings/${drawingId}`, { 
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
            document.getElementById('drawingForm').style.display = 'none';
            initialize(); // ì „ì²´ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        } catch (error) {
            alert(error.message);
        }
    });

    // --- 11. ê·¸ë¦¬ê¸° í¼ ê´€ë¦¬ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function openDrawingForm(geojson, drawingData = null) {
        closeAllFormsExcept('drawingForm');
        const form = document.getElementById('drawingForm');
        form.style.display = 'block';
        
        // ğŸš© [ì¶”ê°€] ìœ„ì¹˜ ê°•ì œ ì„¤ì • - ì¢Œì¸¡ í•˜ë‹¨
        form.style.position = 'absolute';
        form.style.bottom = '10px';
        form.style.left = '10px';
        form.style.right = 'auto';
        form.style.top = 'auto';
        form.style.transform = 'none';
        
        // ğŸš© [ë””ë²„ê·¸] ì½˜ì†”ì— ìœ„ì¹˜ ì •ë³´ ì¶œë ¥
        console.log('drawingForm ìœ„ì¹˜ ì„¤ì •:', {
            position: form.style.position,
            bottom: form.style.bottom,
            left: form.style.left,
            right: form.style.right,
            top: form.style.top,
            computed: window.getComputedStyle(form).position,
            computedBottom: window.getComputedStyle(form).bottom,
            computedLeft: window.getComputedStyle(form).left
        });
        
        document.getElementById('editDrawingForm').reset();

        document.getElementById('drawingGeoJson').value = JSON.stringify(geojson);

        if (drawingData) { // í¸ì§‘ ëª¨ë“œ
            document.getElementById('drawingMongoId').value = drawingData._id;
            document.getElementById('drawingName').value = drawingData.name;
            document.getElementById('drawingType').value = drawingData.type;
            document.getElementById('drawingStartYear').value = drawingData.start_year;
            document.getElementById('drawingEndYear').value = drawingData.end_year || '';
            document.getElementById('deleteDrawingBtn').style.display = 'inline-block';
            document.getElementById('saveDrawingBtn').textContent = 'ì €ì¥';
        } else { // ì¶”ê°€ ëª¨ë“œ
            document.getElementById('drawingMongoId').value = '';
            document.getElementById('drawingStartYear').value = yearInput.value; // í˜„ì¬ ì—°ë„ ê¸°ë³¸ê°’
            document.getElementById('deleteDrawingBtn').style.display = 'none';
            document.getElementById('saveDrawingBtn').textContent = 'ì €ì¥';
        }
    };
    // --- 12. ì‚¬ì„œ ê¸°ë¡ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    
    // openHistoryFormBtn ì´ë²¤íŠ¸ëŠ” ì´ë¯¸ openHistoryForm í•¨ìˆ˜ë¡œ ì²˜ë¦¬ë¨ (ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°)
    // openHistoryFormBtn.addEventListener('click', () => {
    //     editingHistoryKey = null; // ì´ ë²„íŠ¼ ìì²´ê°€ ê´€ë¦¬ìì—ê²Œë§Œ ë³´ì´ë¯€ë¡œ ë‚´ë¶€ ê¶Œí•œ ì²´í¬ëŠ” ë¶ˆí•„ìš”
    //     closeAllFormsExcept('historyForm');
    //     document.getElementById('historyForm').style.display = 'block';
    //     document.getElementById('addHistoryForm').reset();
    //     document.getElementById('deleteHistoryBtn').style.display = 'none'; // ğŸš© [ì¶”ê°€] ì¶”ê°€ ëª¨ë“œì—ì„œëŠ” ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
        
    //     document.getElementById('historyYear').value = yearInput.value;
    //     document.getElementById('historyMonth').value = monthInput.value;
    //     document.getElementById('saveHistoryBtn').textContent = 'ì €ì¥';
    // });

    document.getElementById('cancelHistoryBtn').addEventListener('click', () => {
        document.getElementById('historyForm').style.display = 'none';
    });
    
    // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('deleteHistoryBtn').addEventListener('click', async () => {
        if (!editingHistoryKey) return;
        if (!confirm('ì •ë§ë¡œ ì´ ì—­ì‚¬ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/history/${editingHistoryKey}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) throw new Error('ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

            document.getElementById('historyForm').style.display = 'none';
            initialize(); // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        } catch (error) {
            alert(error.message);
        }
    });

    document.getElementById('addHistoryForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const isUpdate = editingHistoryKey !== null;
        const url = isUpdate ? `${API_BASE_URL}/history/${editingHistoryKey}` : `${API_BASE_URL}/history`;
        const method = isUpdate ? 'PUT' : 'POST';
        
        const data = {
            year: parseInt(document.getElementById('historyYear').value),
            month: parseInt(document.getElementById('historyMonth').value) || 1,
            event_name: document.getElementById('historyEvent').value,
            create_event: document.getElementById('createEvent').checked, // ğŸš© [ìˆ˜ì •] create_event í”Œë˜ê·¸ë¥¼ history ë°ì´í„°ì— í¬í•¨
            photo: document.getElementById('historyPhoto').value || null, // ğŸš© [ì¶”ê°€] ì‚¬ì§„ ë°ì´í„° ìˆ˜ì§‘
            records: {
                korean: {
                    source: document.getElementById('koreanSource').value,
                    content: document.getElementById('koreanContent').value
                },
                foreign: {
                    source: document.getElementById('foreignSource').value,
                    content: document.getElementById('foreignContent').value
                },
                true_history: {
                    content: document.getElementById('trueHistoryContent').value
                }
            }
        };
        const createEvent = document.getElementById('createEvent').checked; // ğŸš© [ì¶”ê°€] ì²´í¬ë°•ìŠ¤ ê°’ í™•ì¸

        if (isNaN(data.year) || !data.event_name) {
            return alert("ì—°ë„ì™€ ì´ë²¤íŠ¸ëª…ì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        try {
            const response = await fetch(url, {
                method: method, 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            // --- ğŸš© [í•µì‹¬ ì¶”ê°€] ì´ë²¤íŠ¸ ë°ì´í„° ë™ê¸°í™” ë¡œì§ ---
            let historyId;
            if (isUpdate) {
                historyId = editingHistoryKey; // ì—…ë°ì´íŠ¸ ì‹œì—ëŠ” ê¸°ì¡´ ID ì‚¬ìš©
                await response.json(); // ì‘ë‹µì„ ì½ì–´ ë²„í¼ë¥¼ ë¹„ì›ë‹ˆë‹¤.
            } else {
                const savedHistoryResponse = await response.json(); // POST ì‘ë‹µì—ì„œ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                historyId = savedHistoryResponse.id;
            }
            const linkedEvent = events.find(e => e.history_id === historyId);

            if (createEvent) {
                // ì²´í¬ë°•ìŠ¤ í™œì„±í™”: ì´ë²¤íŠ¸ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
                const eventData = {
                    year: data.year,
                    month: data.month,
                    text: data.event_name,
                    photo: data.photo,
                    history_id: historyId // ì‚¬ì„œ ê¸°ë¡ ID ì—°ê²°
                };

                const eventMethod = linkedEvent ? 'PUT' : 'POST';
                const eventUrl = linkedEvent ? `${API_BASE_URL}/events/${linkedEvent._id}` : `${API_BASE_URL}/events`;

                const eventResponse = await fetch(eventUrl, {
                    method: eventMethod,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },                    
                    body: JSON.stringify(eventData)
                });
                if (!eventResponse.ok) throw new Error('ì—°ë™ ì´ë²¤íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

            } else if (linkedEvent) {
                // ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”: ì—°ê²°ëœ ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
                const eventResponse = await fetch(`${API_BASE_URL}/events/${linkedEvent._id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!eventResponse.ok) throw new Error('ì—°ë™ ì´ë²¤íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            // --- ì´ë²¤íŠ¸ ë™ê¸°í™” ë¡œì§ ë ---


            document.getElementById('historyForm').style.display = "none";
            initialize(); 
        } catch (error) {
            console.error("History ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`History ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });
    
    window.editHistory = function(key) {
        const record = history.find(h => h._id === key); 
        if (!record || !editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return; // ğŸš© [ìˆ˜ì •] ê¶Œí•œ ì²´í¬
        if (!record) return alert("ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        editingHistoryKey = key;
        closeAllFormsExcept('historyForm');
        document.getElementById('historyForm').style.display = "block";
        document.getElementById('deleteHistoryBtn').style.display = 'inline-block'; // ğŸš© [ì¶”ê°€] í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        
        document.getElementById('historyKey').value = key;
        document.getElementById('historyMonth').value = record.month;
        document.getElementById('historyYear').value = record.year;
        document.getElementById('historyEvent').value = record.event_name;
        document.getElementById('historyPhoto').value = record.photo ?? ''; // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL ì±„ìš°ê¸°

        // ğŸš© [ìˆ˜ì •] ì—°ê²°ëœ ì´ë²¤íŠ¸ ì¡´ì¬ ì—¬ë¶€ê°€ ì•„ë‹Œ, history ë°ì´í„°ì— ì €ì¥ëœ create_event í”Œë˜ê·¸ ê°’ìœ¼ë¡œ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // const linkedEvent = events.find(e => e.history_id === key);
        document.getElementById('createEvent').checked = record.create_event || false;

        
        document.getElementById('koreanSource').value = record.records?.korean?.source ?? '';
        document.getElementById('koreanContent').value = record.records?.korean?.content ?? '';
        
        document.getElementById('foreignSource').value = record.records?.foreign?.source ?? '';
        document.getElementById('foreignContent').value = record.records?.foreign?.content ?? '';
        
        document.getElementById('trueHistoryContent').value = record.records?.true_history?.content ?? '';
        document.getElementById('saveHistoryBtn').textContent = 'ì €ì¥';
    }

    // --- 13. ì˜¤ë¥¸ìª½ íŒ¨ë„ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function initializeResizer() { 
        const resizer = document.getElementById('resizer'); 
        const leftPanel = document.getElementById('leftColumn'); 
        const rightPanel = document.getElementById('rightPanel'); 
 
        let isResizing = false; 
 
        resizer.addEventListener('mousedown', (e) => { 
            isResizing = true; 
            document.body.style.userSelect = 'none'; 
            document.body.style.cursor = 'col-resize'; 
 
            document.addEventListener('mousemove', handleMouseMove); 
            document.addEventListener('mouseup', stopResizing); 
        }); 
 
        function handleMouseMove(e) { 
            if (!isResizing) return; 
 
            const containerRect = document.getElementById('mainContainer').getBoundingClientRect(); 
            const totalWidth = containerRect.width; 
            const leftWidth = e.clientX - containerRect.left - resizer.offsetWidth / 2; 
            const rightWidth = totalWidth - leftWidth - resizer.offsetWidth; 
 
            leftPanel.style.flexBasis = `${leftWidth}px`; 
            rightPanel.style.flexBasis = `${rightWidth}px`; 
 
            map.invalidateSize(false); 
        } 
 
        function stopResizing() { 
            isResizing = false; 
            document.body.style.userSelect = ''; 
            document.body.style.cursor = ''; 
            document.removeEventListener('mousemove', handleMouseMove); 
            document.removeEventListener('mouseup', stopResizing); 
            map.invalidateSize(); 
        } 
    } 

    // --- 14. ì˜¤ë¥¸ìª½ íŒ¨ë„ ë‚´ë¶€ ìˆ˜ì§ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function initializeVerticalResizer() {
        const resizer = document.getElementById('vertical-resizer');
        const kingPanel = document.getElementById('kingPanel');
        const historyPanel = document.getElementById('historyPanel');
        const rightPanelContainer = document.getElementById('rightPanel');

        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            // ê°€ë¡œ ë¦¬ì‚¬ì´ì €ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ body ìŠ¤íƒ€ì¼ì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ
            // ëŒ€ì‹ , rightPanel ë‚´ì—ì„œë§Œ ì»¤ì„œ ëª¨ì–‘ì„ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            rightPanelContainer.style.cursor = 'row-resize';

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', stopResizing);
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            const rightPanelRect = rightPanelContainer.getBoundingClientRect();
            const kingPanelHeight = e.clientY - rightPanelRect.top;
            
            // ìµœì†Œ/ìµœëŒ€ ë†’ì´ ì œí•œ (ì„ íƒ ì‚¬í•­)
            const minHeight = 50; // ìµœì†Œ 50px
            const maxHeight = rightPanelRect.height - 100; // ìµœëŒ€ ë†’ì´ ì œí•œ

            if (kingPanelHeight > minHeight && kingPanelHeight < maxHeight) {
                kingPanel.style.flexBasis = `${kingPanelHeight}px`;
            }
        }

        function stopResizing() {
            isResizing = false;
            rightPanelContainer.style.cursor = '';
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', stopResizing);
        }
    }

    // --- 15. í¼ ì´ë™(ë“œë˜ê·¸) ê¸°ëŠ¥ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function makeFormsDraggable() {
        const formIds = ['castleForm', 'historyForm', 'countryForm', 'kingForm', 'eventForm', 'drawingForm', 'editCitySelectionForm']; // ğŸš© [ì¶”ê°€] editCitySelectionForm í¬í•¨

        formIds.forEach(id => {
            const form = document.getElementById(id);
            const header = form.querySelector('h3');

            if (!header) return;

            let isDragging = false;
            let offsetX, offsetY;

            header.addEventListener('mousedown', (e) => {
                // í¼ ë‚´ë¶€ì˜ ë‹¤ë¥¸ ìš”ì†Œ(input, select ë“±)ì—ì„œ ì‹œì‘ëœ mousedownì€ ë¬´ì‹œ
                if (e.target !== header) return;

                isDragging = true;
                offsetX = e.clientX - form.offsetLeft;
                offsetY = e.clientY - form.offsetTop;

                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;
                
                let newLeft = e.clientX - offsetX;
                let newTop = e.clientY - offsetY;

                form.style.left = `${newLeft}px`;
                form.style.top = `${newTop}px`;
            }

            function onMouseUp() {
                isDragging = false;
                document.body.style.userSelect = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        });
    }

    // ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì € ê¸°ëŠ¥ ì´ˆê¸°í™”
    // initializeResizer(); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°ë¡œ ë¹„í™œì„±í™”
    // initializeVerticalResizer(); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°ë¡œ ë¹„í™œì„±í™”
    makeFormsDraggable();

    // ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ ì´ˆê¸°í™” - ì œê±°ë¨
    // function initializeRightPanelToggle() {
    //     const toggleBtn = document.getElementById('rightPanelToggleBtn'); // ë²„íŠ¼
    //     const rightPanel = document.getElementById('rightPanel');
    //     const resizer = document.getElementById('resizer');

    //     toggleBtn.addEventListener('click', () => {
    //         // ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†±ì—ì„œ ë‹¤ë¥¸ í´ë˜ìŠ¤ë¥¼ í† ê¸€í•˜ë„ë¡ ë³€ê²½
    //         if (window.innerWidth <= 967) {
    //             const isVisible = rightPanel.classList.toggle('visible');
    //             toggleBtn.innerHTML = isVisible ? 'âœ•' : 'ğŸ“œ'; // ğŸš© [ìˆ˜ì •] ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
    //         } else {
    //             // ë°ìŠ¤í¬í†±ì—ì„œëŠ” flex-basisë¥¼ ì´ìš©í•œ ê¸°ì¡´ ë°©ì‹ ìœ ì§€ (í´ë˜ìŠ¤ëª… ë³€ê²½)
    //             const isCollapsed = rightPanel.classList.toggle('collapsed');
    //             resizer.classList.toggle('hidden', isCollapsed);
    //             toggleBtn.textContent = isCollapsed ? 'í¼ì¹˜ê¸°' : 'íŒ¨ë„ ì ‘ê¸°';
    //         }
    //     });
    // }    
    
    // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰)
    function initializeDrawControl() {
        // ì‚¬ìš©ì ê¶Œí•œì— ë”°ë¼ ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ì„ ì§€ë„ì— ì¶”ê°€
        const user = parseJwt(token);
        if (user && (user.role === 'admin' || user.role === 'superuser')) {
            if (drawControl) map.removeControl(drawControl); // ì¤‘ë³µ ë°©ì§€
            drawControl = new L.Control.Draw({
                edit: false, // ë„í˜• í´ë¦­ìœ¼ë¡œë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥
                draw: { 
                    polygon: true, 
                    polyline: true, 
                    rectangle: true, 
                    circle: true, 
                    marker: true, 
                    circlemarker: false 
                }
            });
            map.addControl(drawControl);

            // ê·¸ë¦¬ê¸° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë°”ì¸ë”©
            map.on(L.Draw.Event.CREATED, function (e) {
                const layer = e.layer;
                const geojson = layer.toGeoJSON();
                openDrawingForm(geojson);
            });
            map.on('draw:drawstart', () => { isDrawing = true; });
            map.on('draw:drawstop', () => { isDrawing = false; });
        }
    }

    // ğŸš© [ì¶”ê°€] PC ë²„ì „ ìƒë‹¨ íŒ¨ë„ í† ê¸€ ê¸°ëŠ¥ ì´ˆê¸°í™”
    function initializeTopPanelToggle() {
        const toggleBtn = document.getElementById('pcTopPanelToggleBtn');
        const body = document.body;
        const controlsWrapper = document.getElementById('controls-wrapper');
        const timelineContainer = document.getElementById('timeline-container');
        let isControlsHidden = false;

        toggleBtn.addEventListener('click', () => {
            if (window.innerWidth <= 967) {
                // ëª¨ë°”ì¼: ìƒë‹¨ ë©”ë‰´ëŠ” í•­ìƒ í‘œì‹œë˜ë¯€ë¡œ í† ê¸€í•˜ì§€ ì•ŠìŒ
                // ì˜¤ë¥¸ìª½ íŒ¨ë„ë§Œ í† ê¸€
                const rightPanel = document.getElementById('rightPanel');
                if (rightPanel) {
                    rightPanel.classList.toggle('visible');
                    document.body.classList.toggle('controls-visible', rightPanel.classList.contains('visible'));
                }
            } else {
                // PC ë™ì‘
                isControlsHidden = !isControlsHidden;

                // ğŸš© [ìˆ˜ì •] ì „ì²´ íŒ¨ë„ì„ ìˆ¨ê¸°ëŠ” ëŒ€ì‹ , íŠ¹ì • ë¶€ë¶„ë§Œ ìˆ¨ê¸°ë„ë¡ ë³€ê²½
                const slider = document.getElementById('combinedSlider');
                const sliderTicks = controlsWrapper.querySelector('.slider-ticks-container'); // ëˆˆê¸ˆ ì»¨í…Œì´ë„ˆ

                if (slider) slider.style.display = isControlsHidden ? 'none' : 'block';
                if (sliderTicks) sliderTicks.style.display = isControlsHidden ? 'none' : 'flex'; // ëˆˆê¸ˆì€ flexë¡œ ë³µì›
                if (timelineContainer) timelineContainer.style.display = isControlsHidden ? 'none' : 'block';

                // ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                toggleBtn.classList.toggle('active', !isControlsHidden);
            }
            map.invalidateSize(); // ì§€ë„ í¬ê¸° ì¬ê³„ì‚°ì€ í•­ìƒ ìˆ˜í–‰
            if (!isControlsHidden) {
                // ğŸš© [ìˆ˜ì •] íŒ¨ë„ì´ ë‹¤ì‹œ ë‚˜íƒ€ë‚  ë•Œ, ì—°ëŒ€í‘œì˜ ìœ„ì¹˜ë¥¼ ì¬ì¡°ì •í•˜ê³  ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
                createDynastyTimeline(); 
            }
        });
    }


    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¤‘ë³µ ì„ ì–¸ëœ DOMContentLoaded ë¦¬ìŠ¤ë„ˆë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•˜ê³ , ëˆ„ë½ëœ ë ˆì´ì–´ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    document.addEventListener('DOMContentLoaded', async () => {
        // ğŸš© [ì¶”ê°€] drawingForm ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© - ì¢Œì¸¡ í•˜ë‹¨
        const drawingForm = document.getElementById('drawingForm');
        if (drawingForm) {
            drawingForm.style.position = 'absolute';
            drawingForm.style.bottom = '10px';
            drawingForm.style.left = '10px';
            drawingForm.style.right = 'auto';
            drawingForm.style.top = 'auto';
            drawingForm.style.transform = 'none';
        }
        
        await initialize();
        // initializeRightPanelToggle(); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°ë¡œ ë¹„í™œì„±í™”
        initializeTopPanelToggle(); // ğŸš© [ì¶”ê°€] PC ë²„ì „ ìƒë‹¨ íŒ¨ë„ í† ê¸€ ì´ˆê¸°í™”

        createDynastyTimeline(); // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ (ë‚´ë¶€ì—ì„œ tickë„ ìƒì„±)
        const checkTimelineDragged = initTimelineDrag(); // ğŸš© [ìˆ˜ì •] ë“œë˜ê·¸ ìƒíƒœ ì²´í¬ í•¨ìˆ˜ë¥¼ ì €ì¥
    // initializeDrawControl(); // ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ì€ í¸ì§‘ëª¨ë“œì—ì„œë§Œ í™œì„±í™”

        // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ê°ì§€ ë° ì´ˆê¸° ì„¤ì •
        const isMobileDevice = window.innerWidth <= 967 || window.innerHeight > window.innerWidth;
        if (isMobileDevice) {
            document.body.classList.add('force-mobile');
            
            // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ì´ˆê¸° ì¶•ì†Œ ìƒíƒœë¡œ ì„¤ì •
            const mapHistoryPanel = document.getElementById('map-history-panel');
            if (mapHistoryPanel) {
                mapHistoryPanel.classList.remove('expanded');
            }
        }

        // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ìš© íŒ¨ë„ í† ê¸€ ë° ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì´ˆê¸°í™”
        // ğŸš© [ì¶”ê°€] êµ°ëŒ€ í¼ì˜ êµ­ê°€ ëª©ë¡ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        const countryOptions = countries.map(c => `<option value="${c._id}">${c.name}${c.ethnicity ? ` (${c.ethnicity})` : ''}</option>`).join('');
        if (militaryCountrySelect) {
            militaryCountrySelect.innerHTML = `<option value="">-- ëª©ë¡ì—ì„œ ì„ íƒ --</option>${countryOptions}`;
        }


        // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ì˜ êµ­ê°€ ì…ë ¥ í•„ë“œì— ëŒ€í•œ ìë™ ì™„ì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„)
        document.getElementById('castleHistoryList').addEventListener('input', (e) => {
            if (e.target.classList.contains('history-country-name')) {
                const input = e.target;
                const resultsContainer = input.nextElementSibling.nextElementSibling; // input -> hidden input -> results div
                const query = input.value.toLowerCase();
                resultsContainer.innerHTML = '';

                if (query.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }

                const filteredCountries = countries.filter(c => c.name.toLowerCase().includes(query));

                filteredCountries.forEach(country => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = country.name;
                    item.onclick = () => {
                        input.value = country.name;
                        input.nextElementSibling.value = country._id; // hidden inputì— ID ì €ì¥
                        resultsContainer.style.display = 'none';

                        // ğŸš© [ìˆ˜ì •] êµ­ê°€ ì„ íƒ ì‹œ, í•´ë‹¹ êµ­ê°€ì˜ ì‹œì‘/ë©¸ë§ ì—°ë„ì™€ ì›”ì„ ìë™ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.
                        const row = input.closest('.history-record-row');
                        const startYearInput = row.querySelector('input.history-start-year');
                        const startMonthInput = row.querySelector('input.history-start-month');
                        const endYearInput = row.querySelector('input.history-end-year');
                        const endMonthInput = row.querySelector('input.history-end-month');
                        if (startYearInput && country.start) {
                            startYearInput.value = country.start;
                        }
                        if (startMonthInput && country.start_month) {
                            startMonthInput.value = country.start_month;
                        }
                        if (endYearInput && country.end) {
                            endYearInput.value = country.end;
                        }
                        if (endMonthInput && country.end_month) {
                            endMonthInput.value = country.end_month;
                        }
                    };
                    resultsContainer.appendChild(item);
                });

                resultsContainer.style.display = filteredCountries.length > 0 ? 'block' : 'none';
            }
        });

        // ğŸš© [ì¶”ê°€] ìë™ ì™„ì„± ê²°ê³¼ ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ì°½ ìˆ¨ê¸°ê¸°
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.history-country')) {
                document.querySelectorAll('.autocomplete-results').forEach(el => el.style.display = 'none');
            }
        });

        // ğŸš© [ì¶”ê°€] êµ°ëŒ€ í¼ì˜ êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        militaryCountrySelect.addEventListener('change', (e) => {
            const countryId = e.target.value;
            const country = getCountryInfoById(countryId);
            
            if (country) {
                militaryCountryNameInput.value = country.name;
                militaryCountryId.value = country._id;
            } else {
                militaryCountryNameInput.value = '';
                militaryCountryId.value = '';
            }
        });

        // ğŸš© [ì¶”ê°€] êµ°ëŒ€ í¼ì˜ ì†Œì† êµ­ê°€ ì…ë ¥ í•„ë“œì— ëŒ€í•œ ìë™ ì™„ì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const militaryCountryResults = document.getElementById('militaryCountryResults');
        const militaryCountryId = document.getElementById('militaryCountryId');

        militaryCountryNameInput.addEventListener('input', (e) => {
            const input = e.target;
            const resultsContainer = militaryCountryResults;
            const query = input.value.toLowerCase();
            resultsContainer.innerHTML = '';

            if (query.length === 0) {
                resultsContainer.style.display = 'none';
                militaryCountryId.value = ''; // ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ IDë„ ì´ˆê¸°í™”
                return;
            }

            const filteredCountries = countries.filter(c => c.name.toLowerCase().includes(query));

            filteredCountries.forEach(country => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = country.name;
                item.onclick = () => {
                    input.value = country.name;
                    militaryCountryId.value = country._id; // hidden inputì— ID ì €ì¥
                    militaryCountrySelect.value = country._id; // ë“œë¡­ë‹¤ìš´ë„ ë™ê¸°í™”
                    resultsContainer.style.display = 'none';
                };
                resultsContainer.appendChild(item);
            });

            resultsContainer.style.display = filteredCountries.length > 0 ? 'block' : 'none';
        });

        // ğŸš© [ì¶”ê°€] êµ°ëŒ€ í¼ ìë™ ì™„ì„± ê²°ê³¼ ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ì°½ ìˆ¨ê¸°ê¸°
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#militaryFlagDetails .form-row > div')) { // í•´ë‹¹ form-row ë‚´ë¶€ì˜ flex ì»¨í…Œì´ë„ˆ ì™¸ë¶€ í´ë¦­ ì‹œ
                militaryCountryResults.style.display = 'none';
            }
        });


        const controlsWrapper = document.getElementById('controls-wrapper');
        // const rightPanel = document.getElementById('rightPanel'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
        const mapElement = document.getElementById('map');

        // ğŸš© [ìˆ˜ì •] ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°ë¡œ ì¸í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”
        // mapElement.addEventListener('click', () => {
        //     // ê²€ìƒ‰ì°½ì— í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ ë‹«ì§€ ì•ŠìŒ (ëª¨ë°”ì¼ ê²€ìƒ‰ UX ê°œì„ )
        //     const searchInput = document.getElementById('mapSearchInput');
        //     if (document.activeElement === searchInput) return;
        //     // ëª¨ë°”ì¼ì—ì„œëŠ” ìš°ì¸¡ íŒ¨ë„ë§Œ ë‹«ìŒ
        //     if (window.innerWidth <= 967) {
        //         rightPanel.classList.remove('visible');
        //     } else {
        //         const controlsWrapper = document.getElementById('controls-wrapper');
        //         if (controlsWrapper) {
        //             controlsWrapper.classList.remove('visible');
        //         }
        //         rightPanel.classList.remove('visible');
        //     }
        //     document.body.classList.remove('controls-visible');
        // });

        // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„(ìŠ¬ë¼ì´ë”©) ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
        // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ì‹œ controls-wrapper í•­ìƒ ë³´ì´ê²Œ
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('focus', () => {
                controlsWrapper.classList.add('visible');
                document.body.classList.add('controls-visible');
            });
        }
        // ì´ì œ íŒ¨ë„ì€ ë²„íŠ¼ìœ¼ë¡œë§Œ ì—´ê³  ë‹«ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

        // ğŸš© [ì¶”ê°€] ì¬ìƒ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ì„ ì´ê³³ìœ¼ë¡œ í†µí•©í•©ë‹ˆë‹¤.
        playBtn.addEventListener('click', startPlayback);
        pauseBtn.addEventListener('click', stopPlayback);

        playbackSpeedSlider.oninput = () => {
            speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
            if (playInterval) {
                stopPlayback();
                startPlayback(); // ì¦‰ì‹œ ìƒˆ ì†ë„ë¡œ ë‹¤ì‹œ ì‹œì‘
            }
        };
        speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`; // ì´ˆê¸° í‘œì‹œ

        combinedSlider.addEventListener('mousedown', stopPlayback);
        combinedSlider.addEventListener('touchstart', stopPlayback);

        // ğŸš© [ìˆ˜ì •] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ì‹œ ì¶”ê°€í•©ë‹ˆë‹¤.
        layerToggles.addEventListener('click', (e) => {
            if (e.target.classList.contains('layer-toggle-btn')) {
                const button = e.target;
                const layerType = button.dataset.layer;
                
                button.classList.toggle('active');
                layerVisibility[layerType] = button.classList.contains('active');
                
                // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ í† ê¸€ ì‹œì—ëŠ” createDynastyTimelineë§Œ í˜¸ì¶œ
                if (layerType === 'timeline') {
                    const slider = document.getElementById('combinedSlider');
                    const sliderTicks = document.querySelector('.slider-ticks-container');
                    const timelineContainer = document.getElementById('timeline-container');

                    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì—°ëŒ€í‘œ ê°€ì‹œì„± ìƒíƒœì— ë”°ë¼ ê´€ë ¨ UI ìš”ì†Œë“¤ì„ ëª¨ë‘ ì œì–´í•©ë‹ˆë‹¤.
                    if (slider) slider.style.display = layerVisibility.timeline ? 'block' : 'none';
                    if (timelineContainer) {
                        if (layerVisibility.timeline) {
                            // ì—°ëŒ€í‘œë¥¼ ë‹¤ì‹œ ê·¸ë¦´ ë•Œ ì´ˆê¸° ìƒíƒœì™€ ë™ì¼í•˜ê²Œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë„ ì—…ë°ì´íŠ¸
                            createDynastyTimeline(); // createDynastyTimeline ë‚´ë¶€ì—ì„œ updateTimelineScroll() í˜¸ì¶œë¨
                            // ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆ (createDynastyTimelineì—ì„œ ì´ë¯¸ ì„¤ì •ë˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì¬ì„¤ì •)
                            const timelineContent = document.getElementById('timeline-content');
                            if (timelineContent) {
                                timelineContainer.style.height = timelineContent.style.height;
                            }
                        } else {
                            // ì—°ëŒ€í‘œë¥¼ ëŒ ë•Œë§Œ ë†’ì´ë¥¼ 0ìœ¼ë¡œ
                            timelineContainer.style.height = '0px';
                        }
                        // marginTopì€ ì œê±°í•˜ì—¬ ì—°ë„ ì»¨íŠ¸ë¡¤ë°” ì•„ë˜ì— ìœ„ì¹˜í•˜ë„ë¡ í•¨
                        timelineContainer.style.marginTop = '0px';
                    }
                    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ëˆˆê¸ˆ ìˆ¨ê¹€ ì²˜ë¦¬ë¥¼ ê°€ì¥ ë§ˆì§€ë§‰ì— ì‹¤í–‰í•˜ì—¬ ë‹¤ë¥¸ UI ë³€ê²½ìœ¼ë¡œ ì¸í•œ ê°„ì„­ì„ ë°©ì§€í•©ë‹ˆë‹¤.
                    if (sliderTicks) sliderTicks.style.display = layerVisibility.timeline ? 'flex' : 'none';
                } else {
                    const { year, month } = getCurrentYearMonth();
                    updateMap(year, month);
                }
            }
        });

        // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë§‰ëŒ€ í´ë¦­ ì‹œ í•´ë‹¹ êµ­ê°€ì˜ ì‹œì‘ ì—°ë„ë¡œ ì´ë™
        const timelineContainer = document.getElementById('timeline-container');
        timelineContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('timeline-bar')) {
                // ğŸš© [ì¶”ê°€] ë“œë˜ê·¸ ì¤‘ì´ì—ˆë‹¤ë©´ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
                if (typeof checkTimelineDragged === 'function' && checkTimelineDragged()) {
                    return;
                }
                
                const bar = e.target;
                const startYear = parseInt(bar.dataset.startYear);
                const startMonth = parseInt(bar.dataset.startMonth);
                const countryId = bar.dataset.countryId;

                // 1. ì‹œê°„ ì´ë™
                updateTime(startYear, startMonth);

                // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œë„ í•´ë‹¹ ì‹œì ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                updateTimelineScroll();

                // 2. ğŸš© [ì¶”ê°€] í•´ë‹¹ êµ­ê°€ì˜ ìˆ˜ë„ë¥¼ ì°¾ì•„ í´ë¡œì¦ˆì—…
                if (countryId) {
                    const startTime = yearMonthToTotalMonths(startYear, startMonth);
                    // í•´ë‹¹ êµ­ê°€ì˜ ì‹œì‘ ì‹œì ì— ìœ íš¨í•œ ìˆ˜ë„ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                    const capital = castles.find(c => c.country_id === countryId && c.is_capital && yearMonthToTotalMonths(c.built_year, c.built_month || 1) <= startTime && (c.destroyed === null || yearMonthToTotalMonths(c.destroyed, c.destroyed_month || 12) >= startTime));
                    
                    if (capital) {
                        map.flyTo([capital.lat, capital.lng], 10);
                    }
                }
            }
        });

        // ğŸš© [ì¶”ê°€] í¸ì§‘ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const mainEditBtn = document.getElementById('mainEditBtn');
        const editDropdownMenu = document.getElementById('edit-dropdown-menu');
        const exitEditBtnDropdown = document.getElementById('exitEditBtnDropdown');
        const editDropdownContainer = document.getElementById('edit-dropdown-container');

        function setEditModeState(newState) {
            const privileged = currentUser?.role === 'superuser' || currentUser?.role === 'admin';
            editMode = privileged ? !!newState : false;
            // ğŸš© [ìˆ˜ì •] localStorage ì €ì¥ ì œê±° - ë¡œê·¸ì¸ ì‹œ í•­ìƒ ì¼ë°˜ ë·° ëª¨ë“œë¡œ ì‹œì‘
            if (editDropdownContainer) {
                editDropdownContainer.style.display = privileged ? 'inline-block' : 'none';
            }
            if (exitEditBtnDropdown) {
                exitEditBtnDropdown.style.display = editMode ? 'block' : 'none';
            }
            // openHistoryFormBtn.style.display = (editMode && privileged) ? 'inline-block' : 'none'; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
            
            // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ ì—­ì‚¬ ê¸°ë¡ ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ ì œì–´
            const mapOpenHistoryFormBtn = document.getElementById('map-open-history-form-btn');
            if (mapOpenHistoryFormBtn) {
                mapOpenHistoryFormBtn.style.display = (editMode && privileged) ? 'inline-block' : 'none';
            }

            if (editMode && privileged) {
                if (typeof initializeDrawControl === 'function') {
                    initializeDrawControl();
                }
            } else {
                if (typeof drawControl !== 'undefined' && drawControl) {
                    map.removeControl(drawControl);
                }
            }

            if (!editMode && editDropdownMenu) {
                editDropdownMenu.classList.remove('show');
            }

            if (typeof currentYear !== 'undefined') {
                updateHistoryPanel(currentYear);
            }
        }

        mainEditBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            if (!editMode) {
                setEditModeState(true);
            }
            editDropdownMenu.classList.toggle('show');
        });

        // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('cityEditBtnDropdown').addEventListener('click', () => {
            closeAllFormsExcept('editCitySelectionForm');
            openForm('editCitySelectionForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
            const searchInput = document.getElementById('editCitySelectionForm').querySelector('#citySearchForEdit');
            if (searchInput) searchInput.value = '';
            populateCitySelectForEdit();
            editDropdownMenu.classList.remove('show');
        });

        document.getElementById('countryEditBtnDropdown').addEventListener('click', () => {
            closeAllFormsExcept('countryForm');
            openForm('countryForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
            updateCountrySelectForEdit();
            document.getElementById('editCountryForm').reset();
            document.getElementById('countryOriginalName').value = '';
            document.getElementById('deleteCountryBtn').style.display = 'none';
            document.getElementById('saveCountryBtn').textContent = 'ì €ì¥/ì¶”ê°€';
            document.getElementById('countryColor').value = '#ffffff';
            const searchInput = document.getElementById('countryForm').querySelector('#countrySearchForEdit');
            if (searchInput) searchInput.value = '';
            editDropdownMenu.classList.remove('show');
        });

        document.getElementById('kingEditBtnDropdown').addEventListener('click', () => {
            closeAllFormsExcept('kingForm');
            openForm('kingForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
            document.getElementById('editKingForm').reset();
            document.getElementById('deleteKingBtn').style.display = 'none';
            document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
            // ğŸš© [ì¶”ê°€] í¼ì„ ì—´ ë•Œ êµ­ê°€ ê´€ë ¨ í•„ë“œë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
            document.getElementById('kingCountryId').value = '';
            document.getElementById('kingCountryNameInput').value = '';
            document.getElementById('kingCountrySelect').value = '';
            document.getElementById('kingSelect').innerHTML = '<option value="">--- ìƒˆ ì™• ì¶”ê°€ ---</option>';

            loadKingsForCountry(true);
            editDropdownMenu.classList.remove('show');
        });

        document.getElementById('eventEditBtnDropdown').addEventListener('click', () => {
            closeAllFormsExcept('eventForm');
            openForm('eventForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
            document.getElementById('editEventForm').reset();
            document.getElementById('deleteEventBtn').style.display = 'none';
            document.getElementById('saveEventBtn').textContent = 'ì €ì¥/ì¶”ê°€';
            populateEventSelect();
            editDropdownMenu.classList.remove('show');
        });

        if (exitEditBtnDropdown) {
            exitEditBtnDropdown.addEventListener('click', () => {
                setEditModeState(false);
                editDropdownMenu.classList.remove('show');
            });
        }

        // ğŸš© [ìˆ˜ì •] ì‚¬ìš©ì ì •ë³´ ê¸°ë°˜ UI ì„¤ì •
        currentUser = parseJwt(token);
        const adminLink = document.getElementById('adminLink');
        if (currentUser) {
            document.getElementById('usernameDisplay').textContent = `${currentUser.username}ë‹˜`;
            document.getElementById('accountLink').style.display = 'inline-block';
            const isPrivileged = currentUser.role === 'admin' || currentUser.role === 'superuser';
            if (adminLink) {
                adminLink.style.display = currentUser.role === 'admin' ? 'inline-block' : 'none';
            }
            // ğŸš© [ìˆ˜ì •] ë¡œê·¸ì¸ ì‹œ í•­ìƒ ì¼ë°˜ ë·° ëª¨ë“œë¡œ ì‹œì‘ (í¸ì§‘ëª¨ë“œ ìë™ í™œì„±í™” ì œê±°)
            setEditModeState(false);
            if (isPrivileged && editDropdownContainer) {
                editDropdownContainer.style.display = 'inline-block';
            }
        } else {
            if (adminLink) adminLink.style.display = 'none';
            setEditModeState(false);
        }

        // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± í¸ì§‘ í¼ ë‚´ ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById('citySearchInputForEdit').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const select = document.getElementById('citySelectForEdit');
            
            for (let i = 0; i < select.options.length; i++) {
                const option = select.options[i];
                const optionText = option.textContent.toLowerCase();
                
                // '-- ë„ì‹œ/ì„± ì„ íƒ --' ì˜µì…˜ì€ í•­ìƒ ë³´ì´ë„ë¡ í•¨
                if (option.value === "") {
                    option.style.display = '';
                    continue;
                }
                
                option.style.display = optionText.includes(searchTerm) ? '' : 'none';
            }
        });

        // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± í¸ì§‘ í¼ì˜ ìë™ ì™„ì„± ê²€ìƒ‰ ê¸°ëŠ¥
        const citySearchInputForEdit = document.getElementById('citySearchInputForEdit');
        const citySearchResults = document.getElementById('citySearchResults');
        const citySelectForEdit = document.getElementById('citySelectForEdit');

        citySearchInputForEdit.addEventListener('input', () => {
            const searchTerm = citySearchInputForEdit.value.toLowerCase();
            citySearchResults.innerHTML = '';
            if (searchTerm.length === 0) {
                citySearchResults.style.display = 'none';
                return;
            }

            // êµ°ëŒ€, ìì—°, ì§€ëª… íƒ€ì…ì´ ì•„ë‹Œ ì„±/ë„ì‹œë§Œ í•„í„°ë§
            const filteredCastles = castles.filter(c => 
                !c.is_military_flag && 
                !c.is_natural_feature && 
                !c.is_label &&
                c.name.toLowerCase().includes(searchTerm)
            );

            filteredCastles.forEach(castle => {
                const div = document.createElement('div');
                const countryName = getCountryInfoById(castle.country_id)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                div.textContent = `${castle.name} (${countryName})`;
                div.style.padding = '8px';
                div.style.cursor = 'pointer';
                div.onmouseover = () => div.style.backgroundColor = '#5d7185';
                div.onmouseout = () => div.style.backgroundColor = '';
                div.onclick = () => {
                    citySearchInputForEdit.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                    citySelectForEdit.value = castle._id; // select íƒœê·¸ ê°’ ë³€ê²½
                    citySearchResults.style.display = 'none'; // ê²°ê³¼ ëª©ë¡ ìˆ¨ê¸°ê¸°
                };
                citySearchResults.appendChild(div);
            });

            citySearchResults.style.display = filteredCastles.length > 0 ? 'block' : 'none';
        });


        // ğŸš© [ì¶”ê°€] ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
        window.addEventListener('click', (e) => {
            if (mainEditBtn && !mainEditBtn.contains(e.target) && editDropdownMenu && !editDropdownMenu.contains(e.target)) {
                editDropdownMenu.classList.remove('show');
            }
            // ğŸš© [ì¶”ê°€] ë©”ì¸ ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            if (searchInput && !searchInput.contains(e.target) && mainSearchResults && !mainSearchResults.contains(e.target)) {
                mainSearchResults.style.display = 'none';
            }
            // ğŸš© [ì¶”ê°€] êµ­ê°€ í¸ì§‘ ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            if (countrySearchInputForEdit && !countrySearchInputForEdit.contains(e.target) && countrySearchResults && !countrySearchResults.contains(e.target)) {
                countrySearchResults.style.display = 'none';
            }
        });

        // ğŸš© [ì¶”ê°€] ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const satelliteBtn = document.getElementById('satellite-tile-btn');
        const normalBtn = document.getElementById('normal-tile-btn');

        const switchTileLayer = (newLayerKey, clickedBtn) => {
            if (currentTileLayer !== tileLayers[newLayerKey]) {
                map.removeLayer(currentTileLayer);
                currentTileLayer = tileLayers[newLayerKey];
                map.addLayer(currentTileLayer);

                satelliteBtn.classList.remove('active');
                normalBtn.classList.remove('active');
                clickedBtn.classList.add('active');
            }
        };

        satelliteBtn.addEventListener('click', () => switchTileLayer('ìœ„ì„±', satelliteBtn));
        normalBtn.addEventListener('click', () => switchTileLayer('ì¼ë°˜', normalBtn));

    });
  </script>

</body>
</html>
  </script>

</body>
</html>