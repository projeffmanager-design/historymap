<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê³ ë ¤ë§Œë¦¬ì§€ë„ (é«˜éº—è¬é‡Œåœ°åœ–)</title>
  <!-- ğŸš© [ìˆ˜ì •] ë¡œì»¬ íŒŒë¹„ì½˜ íŒŒì¼ì„ ì‚¬ìš©í•˜ë„ë¡ ê²½ë¡œ ë³€ê²½ -->
  <link rel="icon" href="/favicon.ico">
  <!-- ğŸš© [ì¶”ê°€] Google Fonts (Noto Serif KR) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- ğŸš© [ìˆ˜ì •] Nanum Brush Script ê¸€ê¼´ ì¶”ê°€ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Yeon+Sung&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- ğŸš© [ì¶”ê°€] Leaflet.draw í”ŒëŸ¬ê·¸ì¸ -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath/leaflet.textpath.min.js"></script>
  <!-- ğŸš© [ì¶”ê°€] Leaflet.PolylineDecorator í”ŒëŸ¬ê·¸ì¸ (í™”ì‚´í‘œìš©) -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <style>
    /* ------------------- 1. ì „ì²´ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ CSS ------------------- */
    /* ğŸš© [ì¶”ê°€] ë·°í¬íŠ¸ ì „ì²´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ html, body ë†’ì´ ì„¤ì • */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
    body {
        background-color: #19191b; 
        background-image: url('https://i.pinimg.com/1200x/ea/ff/c5/eaffc5798174bca27342dc968d58a61a.jpg'); 
        background-size: cover;
        background-position: center;
        background-attachment: fixed; 
        color: #dbdbdb; 
        font-family: Arial, sans-serif;
        font-size:medium;
        display: flex; /* ğŸš© [ì¶”ê°€] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
        flex-direction: column; /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ì •ë ¬ */
    }
    /* ğŸš© [ìˆ˜ì •] mainContainerê°€ bodyì˜ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ flex-grow: 1 ì„¤ì •í•˜ê³ , ë‚´ë¶€ ìš”ì†Œ ê°„ ê°„ê²© ì¶”ê°€ */
    #mainContainer {
        display: flex;
        width: 100%;
        flex-grow: 1;
        padding: 0 10px 10px; /* ğŸš© [ìˆ˜ì •] ìƒë‹¨ ì—¬ë°± ì œê±°, ì¢Œìš°/í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
        box-sizing: border-box; /* ğŸš© [ì¶”ê°€] íŒ¨ë”©ì„ ë„ˆë¹„/ë†’ì´ì— í¬í•¨ */
        min-height: 0; /* ğŸš© [ì¶”ê°€] flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    #map { 
        height: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        position: relative; /* ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ì˜ ê¸°ì¤€ì ìœ¼ë¡œ ì„¤ì • */
      //  .leaflet-tile { filter: brightness(0.7);}
    }
    /* ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì € í•¸ë“¤ ìŠ¤íƒ€ì¼ */
    #resizer {
        width: 5px; /* ğŸš© [ìˆ˜ì •] ë„ˆë¹„ë¥¼ ëŠ˜ë ¤ ì¡ê¸° ì‰½ê²Œ ë§Œë“¦ */
        cursor: col-resize;
        background-color: #5d7185; /* ğŸš© [ìˆ˜ì •] ê¸°ë³¸ ìƒ‰ìƒ ë³€ê²½ */
        flex-shrink: 0; /* ë¦¬ì‚¬ì´ì € ë„ˆë¹„ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
        transition: background-color 0.2s; /* ğŸš© [ì¶”ê°€] í˜¸ë²„ íš¨ê³¼ë¥¼ ìœ„í•œ ì „í™˜ */
    }
    #resizer:hover {
        background-color: #00aaff; /* ğŸš© [ì¶”ê°€] ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ìƒ‰ìƒ ë³€ê²½ */
    }
    /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ë¦¬ì‚¬ì´ì € í•¸ë“¤ ìŠ¤íƒ€ì¼ */
    #vertical-resizer {
        height: 1px;
        cursor: row-resize;
        background-color: #ffffff;
        flex-shrink: 0; /* ë¦¬ì‚¬ì´ì € ë†’ì´ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
    }
    #rightPanel {
        /* ğŸš© [ìˆ˜ì •] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ë‚´ë¶€ ìš”ì†Œ ì œì–´ */
        display: flex;
        flex-direction: column;
        width: 30%;
        transition: all 0.3s ease-in-out; /* ğŸš© [ì¶”ê°€] ì ‘ê³  í´ì§ˆ ë•Œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        position: relative; /* ğŸš© [ì¶”ê°€] í† ê¸€ ë²„íŠ¼ì˜ ìœ„ì¹˜ ê¸°ì¤€ì  */
        border-top: 3px solid #00aaff; 
        /* ğŸš© [í•µì‹¬ ìˆ˜ì •] ì˜¤ë¥¸ìª½ íŒ¨ë„ì— ë°°ê²½ ì´ë¯¸ì§€ ë° ê°€ë…ì„±ì„ ìœ„í•œ ì˜¤ë²„ë ˆì´ ì¶”ê°€ */
        background-image: url('https://i.namu.wiki/i/VnqWqBvjxcHxswDWPKyIinchC7ZIdLK1N5LfaklC7gnTyzvTRTlekzY8Ln249BOp5cWCv2QbtwSnjZ1OYDq8yQ.webp');
        background-size: cover;
        background-position: center;
        background-color: rgba(0, 0, 0, 0.5); /* ì–´ë‘ìš´ ì˜¤ë²„ë ˆì´ */
        background-blend-mode: multiply; /* ì´ë¯¸ì§€ë¥¼ ì–´ë‘¡ê²Œ ë§Œë“¦ */
    }
    /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #rightPanelToggleBtn {
        position: absolute;
        top: 10px;
        left: -28px; /* íŒ¨ë„ ì™¼ìª½ì— ë¶™ë„ë¡ ìœ„ì¹˜ ì¡°ì • */
        z-index: 999;
        padding: 10px 5px;
        writing-mode: vertical-rl; /* í…ìŠ¤íŠ¸ë¥¼ ì„¸ë¡œë¡œ í‘œì‹œ */
        border-radius: 5px 0 0 5px;
        border-right: none;
        font-size: 12px;
        line-height: 1;
    }
    /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ì´ ì ‘í˜”ì„ ë•Œì˜ ìŠ¤íƒ€ì¼ */
    #rightPanel.collapsed {
        width: 0 !important; /* ğŸš© [ìˆ˜ì •] ë„ˆë¹„ë¥¼ 0ìœ¼ë¡œ ë§Œë“¤ì–´ ì ‘ê¸° */
        min-width: 0 !important; /* ğŸš© [ì¶”ê°€] ìµœì†Œ ë„ˆë¹„ ì œí•œ í•´ì œ */
        flex-basis: 0 !important;
        padding: 0 !important;
        overflow: hidden; /* ğŸš© [ì¶”ê°€] ë‚´ìš© ìˆ¨ê¸°ê¸° */
    }
    /* ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì €ë„ í•¨ê»˜ ìˆ¨ê¹€ ì²˜ë¦¬ */
    #resizer.hidden {
        display: none; /* ë¦¬ì‚¬ì´ì €ëŠ” ì™„ì „íˆ ìˆ¨ê¹€ */
    }
    #kingPanel {
        display: flex; /* ğŸš© [ì¶”ê°€] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
        flex-direction: column; /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ì •ë ¬ */
        flex-shrink: 0; /* ğŸš© [ì¶”ê°€] íŒ¨ë„ ë†’ì´ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
        padding-bottom: 10px; /* ğŸš© [ìˆ˜ì •] í•˜ë‹¨ ì—¬ë°± ì¡°ì • */
        border-bottom: 1px solid #5d7185;
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    /* ğŸš© [ì¶”ê°€] ì™• ëª©ë¡ ë‚´ìš© ì˜ì—­ ìŠ¤í¬ë¡¤ ì ìš© */
    #kingPanel .slider-label {
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ë°” í‘œì‹œ */
    }
    #historyPanel {
        display: flex; /* ğŸš© [ìˆ˜ì •] ë‚´ë¶€ ìš”ì†Œë¥¼ flexë¡œ ì œì–´ */
        flex-direction: column;
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        padding-top: 15px;
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    /* ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ ë‚´ìš© ì˜ì—­ ìŠ¤í¬ë¡¤ ì ìš© */
    #historyRecords {
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ë°” í‘œì‹œ */
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
        padding-right: 5px; /* ìŠ¤í¬ë¡¤ë°”ì™€ì˜ ê°„ê²© í™•ë³´ */
    }
    /* ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
    #dynastyTimelinePanel {
        padding-top: 15px;
        border-top: 1px solid #5d7185;
        margin-top: 15px;
    }
    #dynastyTimelinePanel h3 {
        margin-top: 0;
        margin-bottom: 10px;
    }
    /* ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì»¨í…Œì´ë„ˆë¥¼ ìŠ¬ë¼ì´ë”ì™€ ê²¹ì¹˜ë„ë¡ position: relative ì„¤ì • */
    #timeline-container {
        position: relative;
        width: 100%;
        height: auto; /* ğŸš© [ìˆ˜ì •] ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ë„ë¡ ë³€ê²½ */
        margin-top: -38px; /* ğŸš© [ìˆ˜ì •] ìŠ¬ë¼ì´ë” ìƒë‹¨ì— ë§ì¶”ê¸° ìœ„í•´ ë§ˆì§„ ì¡°ì • */
        box-sizing: border-box;
        /* ğŸš© [ìˆ˜ì •] ìŠ¬ë¼ì´ë” ì¡°ì‘ì€ í—ˆìš©í•˜ë˜, ë‚´ë¶€ ë§‰ëŒ€ë“¤ì˜ í´ë¦­ì„ ê°ì§€í•˜ê¸° ìœ„í•´ autoë¡œ ë³€ê²½ */
        pointer-events: auto; 
    }
    /* ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar {
        position: absolute;
        height: 10px;
        border-radius: 0px;
        cursor: pointer;
        pointer-events: auto; /* ğŸš© [ìˆ˜ì •] í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ ë°›ë„ë¡ autoë¡œ ë³€ê²½ */
        transition: filter 0.2s;
        color: white;
        font-size: 9px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        text-align: left; /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ë¥¼ ì™¼ìª½ ì •ë ¬í•©ë‹ˆë‹¤. */
        line-height: 10px; /* í…ìŠ¤íŠ¸ê°€ ë§‰ëŒ€ ì•ˆì— ì˜¤ë„ë¡ ì¡°ì • */
        padding-left: 5px; /* ğŸš© [ì¶”ê°€] ì™¼ìª½ì— ì—¬ë°±ì„ ì¤ë‹ˆë‹¤. */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .timeline-bar:hover {
        filter: none; /* ğŸš© [ìˆ˜ì •] ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë°ê¸° íš¨ê³¼ë¥¼ ì œê±°í•˜ì—¬ íˆ¬ëª…ë„ ê´€ë ¨ í˜¼ë€ì„ ë°©ì§€í•©ë‹ˆë‹¤. */
        transform: scaleY(1.5);
    }
    /* ğŸš© [ì¶”ê°€] ì£¼ìš” ì™•ì¡° ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar.main-dynasty {
        height: 10px; /* ë” êµµê²Œ í‘œì‹œ */
        z-index: 10; /* ë‹¤ë¥¸ ë§‰ëŒ€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        line-height: 10px; /* í…ìŠ¤íŠ¸ ì„¸ë¡œ ì •ë ¬ */
    }
    /* ğŸš© [ì¶”ê°€] ë‚˜ë¨¸ì§€ êµ­ê°€ ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar.minor-dynasty {
        height: 8px; /* ì£¼ìš” ì™•ì¡°ë³´ë‹¤ ì•½ê°„ ì–‡ê²Œ */
        z-index: 5; /* ì£¼ìš” ì™•ì¡°ë³´ë‹¤ ì•„ë˜ì— ì˜¤ë„ë¡ ì„¤ì • */
        opacity: 0.7; /* ì•½ê°„ íˆ¬ëª…í•˜ê²Œ */
    }
    /* ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ì„ íˆ¬ëª…í•˜ê²Œ ë§Œë“¤ì–´ ì—°ëŒ€í‘œê°€ ë³´ì´ë„ë¡ ìˆ˜ì • */
    #combinedSlider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        background: transparent; /* íŠ¸ë™ ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
        outline: none;
        margin-left: 8px; /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    }

    /* Chrome, Safari, Opera, Edge */
    #combinedSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 5px; /* ğŸš© [ìˆ˜ì •] í•¸ë“¤ ë„ˆë¹„ë¥¼ ì¤„ì—¬ ìˆ˜ì§ì„ ì²˜ëŸ¼ ë³´ì´ê²Œ í•¨ */
        height: 50px; /* ğŸš© [ìˆ˜ì •] í•¸ë“¤ ë†’ì´ë¥¼ ëŠ˜ë ¤ ì—°ëŒ€í‘œë¥¼ ì»¤ë²„í•˜ë„ë¡ í•¨ */
        background: rgba(0, 170, 255, 0.7); /* ğŸš© [ìˆ˜ì •] í•¸ë“¤ ìƒ‰ìƒì„ ë°˜íˆ¬ëª…í•˜ê²Œ ë³€ê²½ */
        border: 1px solid #fff;
        border-radius: 0px;
        cursor: pointer;
        margin-top: 0px; /* ğŸš© [ìˆ˜ì •] í•¸ë“¤ì´ íŠ¸ë™ ì¤‘ì•™ì— ì˜¤ë„ë¡ ì¡°ì • */
        position: relative;
        z-index: 20; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
    }

    /* Firefox */
    #combinedSlider::-moz-range-thumb {
        width: 8px;
        height: 40px;
        background: rgba(0, 170, 255, 0.7);
        border: 1px solid #fff;
        border-radius: 4px;
        cursor: pointer;
    }
    #combinedSlider::-moz-range-track { background: transparent; }

    /* ------------------- 2. ë§ˆì»¤ ë””ìì¸ CSS ------------------- */
    
    /* ì „ì¥ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .battle-marker {
        font-size: 36px; /* ì „ì¥ ì•„ì´ì½˜ í¬ê¸° í‚¤ì›€ */
        color: #ffffff; /* ë¶‰ì€ìƒ‰ */ /* ì „ì¥ ë§ˆì»¤ ìƒ‰ìƒ */
        font-weight: bold;
        background-color: transparent; /* ë°°ê²½ íˆ¬ëª…í•˜ê²Œ ë³€ê²½ */
        padding: 2px 5px; /* íŒ¨ë”© ì¶”ê°€ */
        text-shadow: 1px 1px 2px #000;
        text-align: center;
    }
    
/* ------------------- ì™•ì„± ë§ˆì»¤ CSS ì¶”ê°€ ------------------- */
    .capital-marker {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 20px; /* ì™•ê´€ í¬ê¸° */
        color: gold; /* í™©ê¸ˆìƒ‰ */
        font-weight: bold;
        text-shadow: 1px 1px 2px #000;
        line-height: 1;
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));
    }
    /* ğŸš© [ìˆ˜ì •] ì™•ì„± ë° ì¼ë°˜ì„± ì´ë¦„í‘œ ë°°ê²½ ì´ë¯¸ì§€ ë° ìŠ¤íƒ€ì¼ ì ìš© */
    .capital-marker .city-name {
        font-size: 10px;
        color: #ffffff; /* ë°ì€ í…ìŠ¤íŠ¸ */
        background-image: url('https://github.com/projeffmanager-design/img/blob/main/%E1%84%89%E1%85%A5%E1%86%AB.png?raw=true');
        background-size: 100% 100%;
        background-repeat: no-repeat;
        padding: 4px 12px; /* ğŸš© ìˆ˜ì •: íŒ¨ë”© ì¡°ì • */
        border-radius: 5px;
        display: inline-block; /* ğŸš© ìˆ˜ì •: ë„ˆë¹„ê°€ ë‚´ìš©ì— ë§ê²Œ ì¡°ì ˆë˜ë„ë¡ ë³€ê²½ */
        white-space: nowrap; /* ğŸš© ìˆ˜ì •: í…ìŠ¤íŠ¸ê°€ í•œ ì¤„ë¡œ í‘œì‹œë˜ë„ë¡ ì„¤ì • */
        margin-top: -3px; /* ğŸš© ìˆ˜ì •: ì™•ê´€ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²©ì„ ë” ì¢í˜ */
        text-align: center; /* ğŸš© [ì¶”ê°€] ì´ë¦„í‘œ ë‚´ë¶€ í…ìŠ¤íŠ¸ë¥¼ ì¤‘ì•™ ì •ë ¬í•©ë‹ˆë‹¤. */
        text-shadow: 1px 1px 2px black; /* ğŸš© ì¶”ê°€: í…ìŠ¤íŠ¸ ê°€ë…ì„±ì„ ìœ„í•œ ê·¸ë¦¼ì */
        transform: scale(var(--marker-scale, 1));
    }

    /* ğŸš© [ì¶”ê°€] êµ­ê¸° ì´ë¯¸ì§€ í†¤ ë‹¤ìš´ */
    .country-flag-img {
        filter: saturate(60%) brightness(90%) drop-shadow(2px 2px 3px rgba(0,0,0,0.7));
    }

    /* ì¥ìˆ˜/ë³‘ë ¥ ì •ë³´: ë°°ê²½ìƒ‰ ìœ ì§€ */
    .military-flag-details {
        background-color: transparent;
        padding: 1px 3px;
        border-radius: 3px;
        display: inline-block;
        white-space: nowrap; 
        text-align: center; 
        color: white;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
    }
        .flag-icon-container {
        /* ì‚¬ìš©ì ì§€ì • ê³ ì • í¬ê¸° ìœ ì§€ */
        display: flex; /* Flexbox í™œì„±í™” */
        flex-direction: column; /* ìˆ˜ì§ ì •ë ¬ (ê¹ƒë°œ ìœ„, í…ìŠ¤íŠ¸ ì•„ë˜) */
        align-items: center; /* ë‚´ë¶€ ì•„ì´í…œ ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
        text-align: center;
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));

        /* ì „ì²´ ë§ˆì»¤ í¬ê¸° ë° ìœ„ì¹˜ ì¡°ì • (êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤) */
        width: 30px; 
        height: 30px; /* í¬ê¸° ì¡°ì • */
        
        line-height: 1; 
        font-weight: bold;
        color: #ecf0f1; 
        text-shadow: 1px 1px 1px #000; /* í…ìŠ¤íŠ¸ ê·¸ë¦¼ì ì¶”ê°€ */
        font-size: 15px; /* ê¹ƒë°œ ê¸°í˜¸ í¬ê¸° */
    }
    /* ê¹ƒë°œ ê¸°í˜¸ (âš‘) ìŠ¤íƒ€ì¼ */
    .flag-icon-symbol {
        font-size: 20px; /* ê¹ƒë°œ ê¸°í˜¸ í¬ê¸°ë¥¼ ì¢€ ë” í‚¤ì›ë‹ˆë‹¤. */
        line-height: 1;
        height: 30px; /* í…ìŠ¤íŠ¸ì™€ì˜ ë¶„ë¦¬ë¥¼ ìœ„í•´ ë†’ì´ ê³ ì • */
        margin-bottom: 2px;
    }

    /* ------------------- ì§€ì—­ëª… í…ìŠ¤íŠ¸ ë§ˆì»¤ CSS ì¶”ê°€ ------------------- */
    .location-label-marker {
        /* ê¸€ê¼´ ì„¤ì • */
        font-size: 15px; /* í° ê¸€ì”¨ í¬ê¸° */
        font-weight: bold;
        color: #ffffff; /* ë°ì€ ë…¸ë€ìƒ‰ ê³„ì—´ */
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000; /* ğŸš© [ìˆ˜ì •] ì§„í•œ ê¸€ì ì™¸ê³½ì„  íš¨ê³¼ */
        
        /* ë°°ê²½ ì„¤ì • (ê²¹ì¹¨ ë°©ì§€ ë° ê°€ë…ì„± í™•ë³´) */
        background-color: rgba(44, 62, 80, 0); /* ì§™ì€ ë°°ê²½ì— íˆ¬ëª…ë„ ì ìš© */
        border-radius: 5px;
        padding: 5px 10px;
        white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        line-height: 1.2;
        text-align: center;
        /* ë§ˆì»¤ê°€ ë‹¤ë¥¸ ë§ˆì»¤ë‚˜ íŒì—… ìœ„ì— ì˜¤ë„ë¡ z-index ì„¤ì • */
        z-index: 900; 
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));
    }

    /* ------------------- 3. í¼ ë° íŒ¨ë„ ë””ìì¸ CSS ------------------- */
    /* ğŸš© [ìˆ˜ì •] í¼ íŒ¨ë„ ìŠ¤íƒ€ì¼ ê°œì„  */
    /* ğŸš© [ìˆ˜ì •] í¼ ì´ë™ì„ ìœ„í•´ left, transform ì†ì„± ì œê±° */
    #castleForm, #historyForm, #countryForm, #kingForm, #eventForm, #drawingForm {
      position: absolute; top: 100px;
      background: #2c3e50; color: #ecf0f1; border: 1px solid #5d7185;
      padding: 20px; 
      z-index: 1000; 
      border-radius: 8px;
      width: 450px;
      left: calc(50% - 225px); /* (100% - 450px) / 2 */
      /* ğŸš© [ì¶”ê°€] í¼ì´ ë„ˆë¬´ ê¸¸ì–´ì§ˆ ê²½ìš° ìŠ¤í¬ë¡¤ì´ ìƒê¸°ë„ë¡ max-height ì„¤ì • */
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5); max-width: 90%; min-width: 350px;
    }
    #castleForm, #historyForm, #countryForm, #kingForm, #eventForm, #drawingForm { display: none; }

    /* ğŸš© [ì¶”ê°€] í¼ ì œëª© ìŠ¤íƒ€ì¼ */
    #castleForm h3, #historyForm h3, #countryForm h3, #kingForm h3, #eventForm h3, #drawingForm h3 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #5d7185;
        color: #d8c8ff;
        font-size: 1.2em;
        cursor: move; /* ğŸš© [ì¶”ê°€] ë“œë˜ê·¸ ê°€ëŠ¥í•¨ì„ ë‚˜íƒ€ë‚´ëŠ” ì»¤ì„œ */
    }
    
    /* ì‚¬ì„œ ê¸°ë¡ ì¹¼ëŸ¼ ìŠ¤íƒ€ì¼ */
    .record-column { 
        border: 1px solid #ffffff00; border-radius: 4px; background: #3e526800; 
        font-size: 12px; /* ğŸš© [ì¶”ê°€] 'ê¸°ë¡ ì—†ìŒ' í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
        padding: 1px; /* ğŸš© [ì¶”ê°€] ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
    }
    .record-column h2 { border-bottom: 1px solid #000000; }
    .record-item {
        /* ğŸš© [ìˆ˜ì •] ë°°ê²½ ì´ë¯¸ì§€ ë° ê´€ë ¨ ìŠ¤íƒ€ì¼ ì ìš© */
        background-image: url('https://img.freepik.com/free-photo/vintage-grungy-textured-paper-background_53876-103932.jpg?semt=ais_hybrid&w=740&q=80');
        background-size: cover;
        color: #000000; /* ì–´ë‘ìš´ ê¸€ììƒ‰ */
        border: 1px solid #7c481c; /* í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½ */
        border-radius: 4px;
        padding: 10px; /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
        margin-bottom: 5px; /* ğŸš© [ìˆ˜ì •] ì•„ì´í…œ ê°„ ê°„ê²© ì¡°ì • */
        font-size: 12px; /* ğŸš© [ìˆ˜ì •] ê¸€ì”¨ í¬ê¸° 10pxë¡œ ì¡°ì • */
        white-space: pre-wrap;
        line-height: 1.5; /* ğŸš© [ì¶”ê°€] ì „ì²´ì ì¸ ì¤„ ê°„ê²© ì„¤ì • */
        font-family: 'Noto Serif KR', serif; /* íŒì—…ê³¼ ë™ì¼í•œ í°íŠ¸ ì ìš© */
    }
    .record-item.foreign { 
        /* ğŸš© [ìˆ˜ì •] foreign ê¸°ë¡ë„ ë™ì¼í•œ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ë„ë¡ ë°°ê²½ìƒ‰ ì œê±° */
        border: 1px solid #8c7b6c; border-radius: 4px; 
        font-size: 12px; /* ğŸš© [ì¶”ê°€] 'ê¸°ë¡ ì—†ìŒ' í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
    } 
    .record-item.true_history { border-left: 3px solid #2ecc71; } 
    


    /* ğŸš© [ìˆ˜ì •] í¼ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ê°œì„  (ë‹¤í¬ í…Œë§ˆ ì ìš©) */
    #castleForm input, #historyForm input, #countryForm input, #kingForm input, #eventForm input, #drawingForm input,
    #castleForm select, #historyForm select, #countryForm select, #kingForm select, #eventForm select, #drawingForm select, #castleForm textarea,
    #historyForm textarea {
        margin: 4px 0; 
        padding: 8px; 
        width: 100%; 
        box-sizing: border-box; 
        background-color: #1c2833;
        color: #ecf0f1;
        border: 1px solid #5d7185;
        border-radius: 4px;
    }
    #castleForm input:focus, #historyForm input:focus, #countryForm input:focus, #kingForm input:focus, #eventForm input:focus, #drawingForm input:focus,
    #castleForm select:focus, #historyForm select:focus, #countryForm select:focus, #kingForm select:focus, #eventForm select:focus, #drawingForm select:focus, #castleForm textarea:focus,
    #historyForm textarea:focus {
        outline: none;
        border-color: #00aaff;
        box-shadow: 0 0 5px rgba(0, 170, 255, 0.5);
    }
    .record-item button {
        float: right; margin-left: 10px; background-color: #be0000; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer;
    }

    /* ê²½ë¡œ ë°ì´í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .path-point-row {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
      align-items: center;
      padding: 5px;
      border: 1px solid #5d7185;
      border-radius: 3px;
    }
    .path-point-row input {
      flex-grow: 1;
      width: auto; /* flex-grow ë•Œë¬¸ì— width: 100% ë¬´ì‹œ */
      min-width: 0;
    }
    .path-point-row .path-time-input {
      width: 50px;
    }
    .path-point-row button {
      width: 30px;
      padding: 5px;
      margin: 0;
      background-color: #e74c3c;
    }
    #pathDataSection h4 {
      white-space: nowrap; /* ì œëª© ì¤„ë°”ê¿ˆ ë°©ì§€ */
    }

    /* ğŸš© [ì¶”ê°€] í¼ ë ˆì´ì•„ì›ƒ ê°œì„  */
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 10px;
    }
    .form-row label {
      width: 100px; /* ë ˆì´ë¸” ë„ˆë¹„ ê³ ì • */
      flex-shrink: 0; /* ë ˆì´ë¸” ë„ˆë¹„ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
      text-align: right;
      padding-right: 5px;
    }
    .form-row input, .form-row select, .form-row textarea, .form-row .input-group {
      flex-grow: 1; /* ì…ë ¥ í•„ë“œê°€ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
    }
    .input-group {
      display: flex;
      gap: 5px;
    }
    /* ì¬ìƒ/ì •ì§€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
    .playback-button-container {
        position: relative;
        width: auto; /* ğŸš© [ìˆ˜ì •] ë„ˆë¹„ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ë„ë¡ ë³€ê²½ */
        height: auto; /* ğŸš© [ìˆ˜ì •] ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ë„ë¡ ë³€ê²½ */
        align-self: center; /* flex ì•„ì´í…œ ìŠ¤ìŠ¤ë¡œ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
    }

    /* ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒ ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
    .marker-type-selector {
      display: flex;
      border: 1px solid #5d7185;
      border-radius: 5px;
      overflow: hidden;
    }
    /* ğŸš© [í•µì‹¬ ìˆ˜ì •] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ì´ ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ë„ë¡ ìˆ˜ì • */
    .marker-type-selector button {
      flex-grow: 1;
      /* ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ìœ¼ë¯€ë¡œ ì•„ë˜ ì†ì„±ë“¤ì€ ì œê±° ë˜ëŠ” ìˆ˜ì •ë©ë‹ˆë‹¤. */
      /* all: unset; */
      /* text-align: center; */
      /* padding: 6px 5px; */
      /* cursor: pointer; */
      transition: all 0.2s ease; /* ğŸš© [ìˆ˜ì •] ê¸°ë³¸ ë²„íŠ¼ê³¼ ë™ì¼í•œ ì „í™˜ íš¨ê³¼ ì ìš© */
      opacity: 0.5; /* ë¹„í™œì„± ìƒíƒœì¼ ë•Œ ë°˜íˆ¬ëª… ì²˜ë¦¬ */
      border-radius: 0; /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ ê·¸ë£¹ì˜ ì¤‘ê°„ ë²„íŠ¼ë“¤ì€ ê°ì§„ ëª¨ì„œë¦¬ë¡œ */
      border-right: none; /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ ì œê±°í•˜ì—¬ ë²„íŠ¼ë“¤ì´ ë¶™ì–´ë³´ì´ê²Œ í•¨ */
    }
    .marker-type-selector button.active {
      background-color: #008cff; /* ğŸš© [ìˆ˜ì •] í™œì„± ìƒ‰ìƒì„ ë‹¤ë¥¸ ë²„íŠ¼ê³¼ í†µì¼ */
      opacity: 1; /* í™œì„± ìƒíƒœì¼ ë•Œ ì™„ì „ ë¶ˆíˆ¬ëª… */
      font-weight: bold;
    }
    .marker-type-selector button:hover:not(.active) {
      background-color: #36434f; /* ğŸš© [ìˆ˜ì •] í˜¸ë²„ ìƒ‰ìƒì„ ë‹¤ë¥¸ ë²„íŠ¼ê³¼ í†µì¼ */
      opacity: 0.8; /* ğŸš© [ì¶”ê°€] ë¹„í™œì„± ë²„íŠ¼ í˜¸ë²„ ì‹œ ì•½ê°„ ë” ì§„í•˜ê²Œ */
    }

    /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µí•© ë° ì—­í• ë³„ í´ë˜ìŠ¤ ì •ì˜ */
    button, .button-style, input[type="button"], input[type="submit"] {
        all: unset; /* ëª¨ë“  ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        display: inline-block;
        box-sizing: border-box;
        background-color: #3e4a56; /* ë” ì–´ë‘ìš´ ê¸°ë³¸ ë°°ê²½ìƒ‰ */
        color: #f0f0f0; /* ğŸš© [ìˆ˜ì •] ë” ë°ì€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        border: 1px solid #5d7185; /* ğŸš© [ìˆ˜ì •] í…Œë‘ë¦¬ ìƒ‰ìƒ ë°ê²Œ ì¡°ì • */
        padding: 5px 5px; /* ğŸš© [ìˆ˜ì •] íŒ¨ë”© ì¡°ì • */
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease; /* ğŸš© [ìˆ˜ì •] ëª¨ë“  ì†ì„±ì— ì „í™˜ íš¨ê³¼ ì ìš© */
        font-size: 12px; /* ğŸš© [ìˆ˜ì •] í°íŠ¸ í¬ê¸° ì¡°ì • */
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* ğŸš© [ì¶”ê°€] í…ìŠ¤íŠ¸ ê·¸ë¦¼ìë¡œ ê°€ë…ì„± í–¥ìƒ */
        text-align: center;
        line-height: 1.2;
    }

    button:hover, .button-style:hover, input[type="button"]:hover, input[type="submit"]:hover {
        background-color: #36434f; /* ì–´ë‘ìš´ í˜¸ë²„ ìƒ‰ìƒ */
        border-color: #5d7185;
    }

    button.primary, button.active, .button-style.active, button:active, input[type="submit"] {
        background-color: #008cff; /* ğŸš© [ìˆ˜ì •] í™œì„±/ì£¼ìš” ìƒ‰ìƒì„ ë” ë°ì€ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        border-color: #008cff;
    }

    button.primary:hover, input[type="submit"]:hover {
        background-color: #006bb3; /* ğŸš© [ìˆ˜ì •] primary ë²„íŠ¼ í˜¸ë²„ ì‹œ ë” ì–´ë‘ìš´ íŒŒë€ìƒ‰ */
        border-color: #006bb3;
    }

    button.danger {
        background-color: #c0392b; /* í†¤ ë‹¤ìš´ëœ ìœ„í—˜ ìƒ‰ìƒ */
        border-color: #c0392b;
    }
    button.danger:hover {
        background-color: #e74c3c;
    }

        /* ìì—° ì§€ë¬¼ ë§ˆì»¤ ìŠ¤íƒ€ì¼ (NEW) */
    .natural-feature-marker {
        font-size: 20px; /* ì•„ì´ì½˜ í¬ê¸° */
        font-weight: bold;
        text-shadow: 1px 1px 2px #000;
        text-align: center;
        line-height: 1.2;
        padding: 5px;
        border-radius: 50%;
    }
    /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
    .natural-feature-marker { transform: scale(var(--marker-scale, 1)); }
    .natural-feature-marker .feature-name {
        font-size: 11px;
        color: #ecf0f1; 
        background: rgba(54, 77, 99, 0.7);
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
        white-space: nowrap; 
        margin-top: 2px;
    }
    /* íŠ¹ì • íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ */
    .feature-mountain { color: #2ecc71; background-color: transparent; } /* ì‚°/ìˆ² */
    .feature-sea { color: #3498db; background-color: transparent; } /* ë°”ë‹¤/í˜¸ìˆ˜ */
    .feature-river { color: #1abc9c; background-color: transparent; } /* ê°•/ë‚´ë¥™ */
    .feature-mudflat { color: #f1c40f; background-color: transparent; } /* ë»˜/ëŠª */

    /* ğŸš© [ì¶”ê°€] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #layer-toggles .layer-toggle-btn {
        padding: 6px 8px; /* ğŸš© [ìˆ˜ì •] ë‹¤ë¥¸ ë²„íŠ¼ê³¼ ë†’ì´ ë§ì¶¤ (ì¶•ì†Œ) */
        font-size: 11px;
    }

    /* ğŸš© [ì¶”ê°€] í¸ì§‘ ë²„íŠ¼ ê¸€ì í¬ê¸°ë¥¼ ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ê³¼ ë§ì¶¤ */
    #edit-controls button {
        font-size: 11px;
    }

    /* í¼ ë‚´ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #castleForm .form-actions button, #historyForm .form-actions button, 
    #countryForm .form-actions button, #kingForm .form-actions button,
    #eventForm .form-actions button, #drawingForm .form-actions button {
        width: 80px;
    }

    /* ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ìŠ¤íƒ€ì¼: ì„±ê³½ ë°°ê²½/ì „ê²½ ìŠ¤íƒ€ì¼ */
    .wall-background, .wall-foreground {
        /* í´ë¦­ ì´ë²¤íŠ¸ê°€ ì „ê²½ ë ˆì´ì–´ì—ë§Œ ë°œìƒí•˜ë„ë¡ ì„¤ì • */
        pointer-events: none;
    }
    .wall-foreground { pointer-events: auto; }

    /* ì™• ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .king-item {
        font-size: 12px; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
        line-height: 1.5;
        margin-bottom: 4px;
    }

    /* ğŸš© [ì¶”ê°€] ê²€ìƒ‰ì°½ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #searchInput {
        display: flex;
        align-items: center;
        all: unset;
        box-sizing: border-box;
        padding: 6px 10px; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ê³¼ ë†’ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ íŒ¨ë”© ì¡°ì • */
        border: 1px solid #4e5d6c;
        border-radius: 4px 0 0 4px; /* ì™¼ìª½ë§Œ ë‘¥ê¸€ê²Œ */
        background-color: #f0f0f0;
        color: black;
        font-size: 12px;
        line-height: 1.2;
        width: 180px; /* ğŸš© [ìˆ˜ì •] ê²€ìƒ‰ì°½ ë„ˆë¹„ í™•ëŒ€ */
    }

    /* ------------------- 4. ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ CSS (NEW) ------------------- */
    /* í™”ë©´ ë„ˆë¹„ê°€ 1200px ì´í•˜ì¼ ë•Œ ì ìš© */
    @media (max-width: 1200px) {
        #top-controls-container {
            flex-direction: column; /* ìˆ˜ì§ìœ¼ë¡œ ìŒ“ê¸° */
            align-items: flex-start; /* ì™¼ìª½ ì •ë ¬ */
            gap: 15px;
        }
        .time-controls, .right-controls {
            width: 100%; /* ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
            flex-wrap: wrap; /* ë‚´ë¶€ ìš”ì†Œë“¤ì´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ì–´ê°€ë„ë¡ ì„¤ì • */
            justify-content: flex-start; /* ì™¼ìª½ë¶€í„° ì •ë ¬ */
            gap: 10px; /* ìš”ì†Œ ê°„ ê°„ê²© ì¶”ê°€ */
        }
        .right-controls {
            justify-content: flex-end; /* ì˜¤ë¥¸ìª½ ì»¨íŠ¸ë¡¤ì€ ì˜¤ë¥¸ìª½ ì •ë ¬ ìœ ì§€ */
        }
    }

    /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¼ í¬ê¸°ê°€ ì¡°ì ˆë  ë§ˆì»¤ë“¤ì˜ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .custom-city-marker, .custom-flag-name-marker, .custom-capital-flag-marker, .battle-marker {
        transform: scale(var(--marker-scale, 1.0));
    }

    /* ğŸš© [ì¶”ê°€] ê³ ëŒ€ ì§€ë„ ë³´ê¸° ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #ancient-map-button-container {
        display: flex; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ì„ ê°€ë¡œë¡œ ë‚˜ì—´í•˜ê¸° ìœ„í•´ flex ì‚¬ìš© */
        gap: 8px; /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        margin-top: auto; /* ğŸš© [ìˆ˜ì •] ìƒë‹¨ ì—¬ë°±ì„ ìë™ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë§¨ ì•„ë˜ë¡œ ë°€ì–´ëƒ„ */
        padding-top: 15px; /* ğŸš© [ì¶”ê°€] ìœ„ìª½ ì½˜í…ì¸ ì™€ì˜ ê°„ê²© í™•ë³´ */
        justify-content: left; /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ë“¤ì„ ì¤‘ì•™ì— ì •ë ¬ */
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] íŒì—… ìŠ¤íƒ€ì¼ -->
  <style>
    .leaflet-popup-content-wrapper {
        background-image: url('https://img.freepik.com/free-photo/vintage-grungy-textured-paper-background_53876-103932.jpg?semt=ais_hybrid&w=740&q=80');
        background-size: cover;
        background-repeat: no-repeat;
        color: #333; /* ì–´ë‘ìš´ ê¸€ììƒ‰ìœ¼ë¡œ ê°€ë…ì„± í™•ë³´ */
        border-radius: 5px;
        box-shadow: 0 3px 14px rgba(0,0,0,0.4);
    }
    .leaflet-popup-content {
        font-family: 'Noto Serif KR', serif; /* íŒì—… í°íŠ¸ ë³€ê²½ */
        margin: 13px 19px;
        line-height: 1.5;
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ë³€ê²½ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ -->
  <style>
    .leaflet-control-layers-selector {
        background: rgba(44, 62, 80, 0.7);
        border-radius: 5px;
        padding: 5px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] í—¤ë” ì»¨í…Œì´ë„ˆ ë° ë¡œê·¸ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ -->
  <style>
    #header-container {
        position: relative;
        text-align: center;
        padding: 10px 50px;
    }
    #top-right-auth {
        position: absolute;
        top: 15px;
        right: 20px;
        /* ğŸš© [ì¶”ê°€] ë‚´ë¶€ ìš”ì†Œë“¤ì„ ì •ë ¬í•˜ê¸° ìœ„í•´ flexbox ì‚¬ìš© */
        display: flex;
        align-items: center;
        gap: 5px; /* ğŸš© [ìˆ˜ì •] ìš”ì†Œ ê°„ ê°„ê²© ì¶•ì†Œ */
    }
    #top-left-icons {
        position: absolute;
        top: 15px;
        left: 20px;
        display: flex; /* ì•„ì´ì½˜ë“¤ì„ ê°€ë¡œë¡œ ë‚˜ì—´ */
        gap: 5px;     /* ì•„ì´ì½˜ ì‚¬ì´ì˜ ê°„ê²© */
    }
        /* ğŸš© [ì¶”ê°€] ì»¨íŠ¸ë¡¤ íŒ¨ë„ ì „ì²´ ê¸€ê¼´ í†µì¼ */
    #controls-wrapper {
        font-family: Arial, sans-serif;
        font-weight: 700;
    }

    /* ğŸš© [ì¶”ê°€] í•œì ì œëª©ì„ ìœ„í•œ ë¶“ê¸€ì”¨ í°íŠ¸ ìŠ¤íƒ€ì¼ */
    .hanja-title {
        font-family: 'Yeon Sung', cursive;
        font-weight: 400;
        font-size: 0.9em; /* í•œê¸€ê³¼ì˜ ì¡°í™”ë¥¼ ìœ„í•´ í¬ê¸° ë¯¸ì„¸ ì¡°ì • */
    }
  </style>
  <!-- ğŸš© [ì¶”ê°€] ì—°ë„ë³„ ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ -->
  <style>
    #event-overlay {
        position: absolute;
        top: 50%;
        left: 50%; /* ğŸš© [ìˆ˜ì •] leftColumn ë‚´ë¶€ì—ì„œ ì¤‘ì•™ ì •ë ¬ */
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 1);
        color: #e5ff00;
        padding: 20px 40px;
        border-radius: 12px;
        z-index: 1001; /* í¼ë³´ë‹¤ ìœ„ì—, ì§€ë„ë³´ë‹¤ ìœ„ì— */
        font-size: 2.5em;
        /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ í‘œì‹œí•˜ê¸° ìœ„í•´ flexbox ì‚¬ìš© */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;

        font-weight: bold;
        text-shadow: 2px 2px 5px #000;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none; /* ì˜¤ë²„ë ˆì´ê°€ ì§€ë„ í´ë¦­ì„ ë§‰ì§€ ì•Šë„ë¡ ì„¤ì • */
        white-space: nowrap;
        border: 0px solid rgba(255, 255, 255, 0.5);
    }
    #event-overlay.visible { opacity: 1; }
    /* ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    #event-overlay-image {
        max-width: 40vw;
        max-height: 25vh;
        border-radius: 8px;
        object-fit: contain;
    }
  </style>
</head>
<body>
  <!-- ğŸš© [ìˆ˜ì •] í—¤ë” ì»¨í…Œì´ë„ˆë¥¼ body ìµœìƒë‹¨ìœ¼ë¡œ ì´ë™ -->
  <div id="header-container">
    <div id="top-left-icons">
      <a href="https://www.youtube.com/@booksbogo" target="_blank" rel="noopener noreferrer" title="ì±…ë³´ê³ "><img style="width: 26px; height: 26px; border-radius: 50%;" src="https://yt3.googleusercontent.com/ZiZJsEzG5LkM6UItGT5mrhygyGxYWsj8OmpLYeVnMNAbtD3D7KWtGX3NsjhMMFbMFUyZ-tY-Pg=s160-c-k-c0x00ffffff-no-rj"></a>
      <a href="https://www.youtube.com/@three.empires" target="_blank" rel="noopener noreferrer" title="ì°ì‚¼êµ­ì‚¬"><img style="width: 26px; height: 26px; border-radius: 50%;" src="https://yt3.googleusercontent.com/adIg0ayz8Thp44XkOP7Wscn4cebPYCNhr2I_ZVuMEGPMdfXRZZTRI-qBiCh68BpHZa_ZmcH9YZ8=s160-c-k-c0x00ffffff-no-rj"></a>
    </div>
    <h1 style="font-family: 'Noto Serif KR', serif; font-size: 2.2em; margin: 0; display: inline-block; color: #f5e9d2; text-shadow: 2px 2px 4px #000;">ê³ ë ¤ë§Œë¦¬ì§€ë„ <span class="hanja-title">(é«˜éº—è¬é‡Œåœ°åœ–)</span></h1>
    <div id="top-right-auth">
        <span id="usernameDisplay" style="margin-right: 15px; font-weight: bold;"></span>
        <a id="adminLink" href="admin.html" class="button-style" style="display: none; margin-right: 8px;">íšŒì› ê´€ë¦¬</a>
        <button id="logoutBtnHeader" class="danger">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    
  </div>

  <!-- ğŸš© [ìˆ˜ì •] ì»¨íŠ¸ë¡¤ëŸ¬ë“¤ì„ ë³„ë„ì˜ wrapperë¡œ ë¶„ë¦¬ -->
  <div id="controls-wrapper" style="padding: 10px; box-sizing: border-box;">
      <div class="slider-container" style="text-align:left; margin-bottom:4px; width: 100%;">

        <div id="top-controls-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
            <!-- ğŸš© [ìˆ˜ì •] ì™¼ìª½ ì»¨íŠ¸ë¡¤ ê·¸ë£¹ (ì‹œê°„ ë° ì†ë„) -->
            <div class="time-controls" style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
                <!-- ğŸš© [ìˆ˜ì •] min-widthë¥¼ widthë¡œ ë³€ê²½í•˜ì—¬ ê³ ì • ë„ˆë¹„ í™•ë³´ -->
                <span id="timeLabelDisplay" style="width: 220px; white-space: nowrap; text-align: left;">
                    ì—°ë„: <span id="yearLabel"></span>ë…„ <span id="monthLabel"></span>ì›” <span id="ganjiLabel"></span>
                </span>
                <input type="number" id="yearInput" min="-2333" max="2030" step="1" value="400" style="width:70px !important;">
                <input type="number" id="monthInput" min="1" max="12" step="1" value="1" style="width:45px !important;">
                <div class="playback-button-container">
                    <button id="playBtn" class="primary">ì¬ìƒ</button>
                    <button id="pauseBtn" class="danger" style="display: none;">ì •ì§€</button>
                </div>
                <label for="playbackSpeedSlider" style="font-weight: normal;">ì†ë„:</label>
                <input type="range" id="playbackSpeedSlider" min="1" max="60" value="12" style="width: 80px; vertical-align: middle;">
                <span id="speedDisplay" style="vertical-align: middle; width: 50px;">12ì›”/ì´ˆ</span>
            </div>

            <!-- ğŸš© [ìˆ˜ì •] ì˜¤ë¥¸ìª½ ì»¨íŠ¸ë¡¤ ê·¸ë£¹ (í•„í„° ë° ê²€ìƒ‰) -->
            <div class="right-controls" style="display: flex; align-items: center; justify-content: flex-end; gap: 10px; flex-wrap: wrap;">
                <!-- ğŸš© [ì´ë™] ê´€ë¦¬ììš© í¸ì§‘ ë²„íŠ¼ë“¤ì„ ì´ê³³ìœ¼ë¡œ ì´ë™ -->
                <div id="edit-controls" style="display: flex; gap: 5px; flex-shrink: 0;">
                    <button id="cityEditBtn" style="display:none;">ë„ì‹œ/ì„± í¸ì§‘</button>
                    <button id="countryEditBtn" style="display:none;">êµ­ê°€ í¸ì§‘</button>
                    <button id="kingEditBtn" style="display:none;">ì™• í¸ì§‘</button>
                    <button id="eventEditBtn" style="display:none;">ì´ë²¤íŠ¸ í¸ì§‘</button>
                </div>
                <div id="layer-toggles" class="marker-type-selector" style="flex-shrink: 0;">
                    <button type="button" class="layer-toggle-btn active" data-layer="city">ì„±/ë„ì‹œ</button> <!-- ğŸš© [ìˆ˜ì •] ì§€ëª…, ìì—° í† ê¸€ ê¸°ë³¸ ë¹„í™œì„±í™” -->
                    <button type="button" class="layer-toggle-btn" data-layer="label">ì§€ëª…</button> <!-- ğŸš© [ìˆ˜ì •] ì§€ëª…, ìì—° í† ê¸€ ê¸°ë³¸ ë¹„í™œì„±í™” -->
                    <button type="button" class="layer-toggle-btn active" data-layer="battle">ì „ì¥</button> <!-- ğŸš© [ìˆ˜ì •] ì§€ëª…, ìì—° í† ê¸€ ê¸°ë³¸ ë¹„í™œì„±í™” -->
                    <button type="button" class="layer-toggle-btn active" data-layer="military">êµ°ëŒ€</button> <!-- ğŸš© [ìˆ˜ì •] ì§€ëª…, ìì—° í† ê¸€ ê¸°ë³¸ ë¹„í™œì„±í™” -->
                    <button type="button" class="layer-toggle-btn" data-layer="natural">ìì—°</button> <!-- ğŸš© [ìˆ˜ì •] ì§€ëª…, ìì—° í† ê¸€ ê¸°ë³¸ ë¹„í™œì„±í™” -->
                    <button type="button" class="layer-toggle-btn active" data-layer="event">ì´ë²¤íŠ¸</button>
                    <button type="button" class="layer-toggle-btn" data-layer="territory">ê°•ì—­</button>
                </div>
                <div id="country-filter-container" style="flex-shrink: 0;">
                    <select id="countryFilterSelect" style="padding: 5px; border-radius: 4px; border: 1px solid #5d7185; font-size: 12px;">
                        <option value="all">-- ì „ì²´ êµ­ê°€ --</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center;">
                    <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ê¸°ë¡, ì§€ëª…)"/>
                    <button id="searchBtn" class="primary" style="border-radius: 0 4px 4px 0; border-left: none;">ê²€ìƒ‰</button>
                </div>
            </div>
        </div>
        <input type="range" id="combinedSlider" min="-28008" max="24359" step="1" value="4800" style="margin-bottom: 5px;">
      </div>
      <div id="timeline-container"></div>
  </div>

  <div id="contentContainer" style="display: flex; flex-grow: 1; min-height: 0; padding: 0 10px 10px;">
    <div id="leftColumn" style="display: flex; flex-direction: column; flex-basis: 70%; flex-grow: 1; flex-shrink: 1;">
      <div id="map" style="width: 100%; height: 100%; min-height: 0;">
        <!-- ğŸš© [ìˆ˜ì •] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ë¥¼ map div ì•ˆìœ¼ë¡œ ì´ë™ -->
        <div id="event-overlay">
            <img id="event-overlay-image" src="" style="display: none;">
            <span id="event-overlay-text"></span>
        </div>
      </div>
    </div>

    <!-- ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ í¬ê¸° ì¡°ì ˆì„ ìœ„í•œ ë¦¬ì‚¬ì´ì € í•¸ë“¤ -->
    <div id="resizer"></div>

    <div id="rightPanel" style="padding: 15px; flex-basis: 30%; flex-grow: 1; flex-shrink: 1;">
        <!-- ğŸš© [ìˆ˜ì •] kingPanelì˜ heightë¥¼ flex-basisë¡œ ë³€ê²½ -->
        <div id="kingPanel" style="flex-basis: 30%;">
            <h3 style="margin-top:0;">êµ­ê°€ë³„ ì™• ëª©ë¡</h3>
            <div class="slider-label" style="text-align:left;">
                <span id="kingList">í•´ë‹¹ ì—°ë„ ì™• ì •ë³´ ì—†ìŒ</span>
            </div>
        </div>
        <!-- ğŸš© [ì¶”ê°€] ì™• ëª©ë¡ê³¼ ì—­ì‚¬ ê¸°ë¡ íŒ¨ë„ ì‚¬ì´ì˜ ìˆ˜ì§ ë¦¬ì‚¬ì´ì € -->
        <div id="vertical-resizer"></div>

        <div id="historyPanel" style="display: flex; flex-direction: column;">
            <h3 style="margin-top: 0; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start;">
                <span id="historyYearTitle"></span>
                <div style="display: flex; align-items: flex-start; gap: 5px; flex-shrink: 0;">
                    <button id="addHistoryBtn" class="primary" style="display: none;">ì¶”ê°€</button>
                    <button id="prevHistoryBtn" title="ì´ì „ ê¸°ë¡">â—€</button>
                    <button id="nextHistoryBtn" title="ë‹¤ìŒ ê¸°ë¡">â–¶</button>
                    
                </div>
            </h3>
            <div id="historyRecords">
                <div class="record-column">
                    <h3>ìš°ë¦¬ ì—­ì‚¬ ê¸°ë¡</h3>
                    <div id="koreanRecords">ê¸°ë¡ ì—†ìŒ</div>
                </div><br>
                <div class="record-column">
                    <h3>ì¡êµ­ ì—­ì‚¬ ê¸°ë¡</h3>
                    <div id="foreignRecords">ê¸°ë¡ ì—†ìŒ</div>
                </div><br>
                <div class="record-column true_history">
                    <h3>ì§„ì§œ ì—­ì‚¬ (ì²œë¬¸/ì§€ë¦¬ ê¸°ë°˜ ì—°êµ¬)</h3>
                    <div id="trueHistoryRecords">ê¸°ë¡ ì—†ìŒ</div>
                </div>
            </div>
        </div>
        <!-- ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ì»¨í…Œì´ë„ˆë¥¼ rightPanelì˜ ìì‹ìœ¼ë¡œ ì´ë™ -->
        <div id="ancient-map-button-container">
        </div>
    </div>
    <!-- ğŸš© [ì´ë™] í† ê¸€ ë²„íŠ¼ì„ mainContainer ë°”ë¡œ ì•„ë˜ë¡œ ì´ë™í•˜ì—¬ íŒ¨ë„ì´ ìˆ¨ê²¨ì ¸ë„ ë³´ì´ë„ë¡ í•¨ -->
    <button id="rightPanelToggleBtn" title="íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°">íŒ¨ë„ ì ‘ê¸°</button>
  </div>
  <div id="castleForm">
        <h3>ìƒˆë¡œìš´ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€/í¸ì§‘</h3> <form id="addCastleForm">
      <input type="hidden" id="castleKey">
      <div class="form-row">
        <label>ë§ˆì»¤ íƒ€ì…:</label>
        <div id="markerTypeSelector" class="marker-type-selector">
            <button type="button" data-type="normal" class="active">ì¼ë°˜</button>
            <button type="button" data-type="capital">ì™•ì„±</button>
            <button type="button" data-type="battle">ì „ì¥</button>
            <button type="button" data-type="military">êµ°ëŒ€</button>
            <button type="button" data-type="natural">ìì—°</button>
            <button type="button" data-type="label">ì§€ëª…</button> 
        </div>
      </div>
      <div class="form-row">
        <label for="castleName">ì´ë¦„:</label>
        <input type="text" id="castleName" required>
      </div>
      <div class="form-row" id="labelColorRow" style="display:none;">
        <label for="labelColor">ê¸€ì ìƒ‰ìƒ:</label>
        <input type="color" id="labelColor" value="#FFFFFF" style="height: 30px; padding: 2px;">
      </div>
      <div class="form-row">
        <label for="castleCountry">êµ­ê°€:</label>
        <select id="castleCountry">
             <option value="">-- êµ­ê°€ ì„ íƒ --</option> 
        </select>
      </div>
      <div class="form-row">
        <label for="castleBuilt">ê±´ì„¤/ì‹œì‘ì—°ë„:</label> <div class="input-group">
          <input type="number" id="castleBuilt" required> 
          <input type="number" id="castleBuiltMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
        </div>
      </div>
      <div class="form-row">
        <label for="castleDestroyed">íŒŒê´´/ì¢…ë£Œì—°ë„:</label> <div class="input-group">
          <input type="number" id="castleDestroyed">
          <input type="number" id="castleDestroyedMonth" min="1" max="12" value="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
        </div>
      </div>
      <div class="form-row">
        <label>ìœ„ë„/ê²½ë„:</label>
        <div class="input-group">
          <input type="number" id="castleLat" step="any" required placeholder="ìœ„ë„">
          <input type="number" id="castleLng" step="any" required placeholder="ê²½ë„">
        </div>
      </div>
      <div class="form-row">
        <label for="castleDesc">ì„¤ëª…:</label>
        <textarea id="castleDesc" rows="3"></textarea>
      </div>
      <div class="form-row">
        <label for="castlePhoto">ì‚¬ì§„ URL:</label>
        <input type="text" id="castlePhoto" placeholder="ì„ íƒ ì‚¬í•­">
      </div>
      

         <hr style="margin: 15px 0;">
      <div class="form-row" id="naturalFeatureDetails" style="display:none;">
        <label for="naturalFeatureType">ì§€ë¬¼ ì¢…ë¥˜:</label>
        <select id="naturalFeatureType">
            <option value="mountain">ì‚°/ìˆ²</option>
            <option value="sea">ë°”ë‹¤/í˜¸ìˆ˜</option>
            <option value="river">ê°•/ë‚´ë¥™</option>
            <option value="mudflat">ë»˜/ëŠª</option>
            <option value="horse">ë§</option>
            <option value="buffalo">ë¬¼ì†Œ</option>
            <option value="mongky">ì›ìˆ­ì´</option>
            <option value="camel">ë‚™íƒ€</option>
        </select>
      </div>
     <div id="militaryFlagDetails" style="display:none; border-top: 0px solid #ccc; padding-top: 5px; margin-top: 10px;">
    <div class="form-row">
        <label for="generalName">ì¥ìˆ˜ ì´ë¦„:</label>
        <input type="text" id="generalName" placeholder="ì¥ìˆ˜ ì´ë¦„">
    </div>
    <div class="form-row">
        <label for="troopCount">ë³‘ë ¥ (ëª…):</label>
        <input type="number" id="troopCount" placeholder="ìˆ«ìë§Œ">
    </div>
    <div class="form-row">
        <label for="generalPhoto">ì¥ìˆ˜ ì‚¬ì§„ URL:</label>
        <input type="text" id="generalPhoto" placeholder="ì„ íƒ ì‚¬í•­">
    </div>
</div>
<div id="pathDataSection" style="display:none; border: 1px solid #00aaff; padding: 10px; margin-top: 10px; border-radius: 4px;">
                <h4>âš”ï¸ êµ°ëŒ€ ì´ë™ ê²½ë¡œ (Path Data)</h4>
                <div id="pathDataList"></div>
                <button type="button" onclick="addPathPoint()" style="margin-top: 5px;">ê²½ë¡œ ì§€ì  ì¶”ê°€</button>
            </div>

      <br>
      <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
        <!-- ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ìˆœì„œ ë³€ê²½ ë° ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì ìš© -->
        <button type="button" id="cloneCastle" class="primary" style="display:none;">ë³µì œ</button> <!-- ğŸš© [ìˆ˜ì •] ë³µì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì ìš© -->
        <button type="button" id="deleteCastle" class="danger" style="display:none;">ì‚­ì œ</button>
        <button type="button" id="cancelCastle">ì·¨ì†Œ</button>
        <button type="submit" class="primary">ì €ì¥</button> <!-- ğŸš© [ìˆ˜ì •] ID ì¶”ê°€ -->
      </div>
    </form>
  </div>

  <!-- ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± í¸ì§‘ ì„ íƒ í¼ -->
  <div id="editCitySelectionForm" style="display: none; position: absolute; top: 100px; left: calc(50% - 225px); background: #2c3e50; color: #ecf0f1; border: 1px solid #5d7185; padding: 20px; z-index: 1000; border-radius: 8px; width: 450px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); max-width: 90%; min-width: 350px;">
      <h3>í¸ì§‘í•  ë„ì‹œ/ì„± ì„ íƒ</h3>
      <div class="form-row">
          <label for="citySelectForEdit">ë„ì‹œ/ì„±:</label>
          <select id="citySelectForEdit" style="flex-grow: 1;">
              <option value="">-- ë„ì‹œ/ì„± ì„ íƒ --</option>
          </select>
      </div>
      <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelCitySelectionBtn">ì·¨ì†Œ</button>
          <button type="button" id="editSelectedCityBtn" class="primary">í¸ì§‘</button>
      </div>
  </div>
  <div id="historyForm">
      <h3>ì‚¬ì„œ ê¸°ë¡ í¸ì§‘/ì¶”ê°€</h3>
      <form id="addHistoryForm">
          <input type="hidden" id="historyKey"> 
          <div class="form-row">
            <label for="historyYear">ì—°ë„:</label>
            <div class="input-group">
              <input type="number" id="historyYear" required>
              <input type="number" id="historyMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
          </div>
          <div class="form-row">
            <label for="historyEvent">ì´ë²¤íŠ¸ëª…:</label>
            <input type="text" id="historyEvent" required>
          </div>
          <div class="form-row">
            <label for="historyPhoto">ì‚¬ì§„ URL:</label>
            <input type="text" id="historyPhoto" placeholder="ì„ íƒ ì‚¬í•­">
          </div>
          <div class="form-row">
            <label for="createEvent">ì´ë²¤íŠ¸ ë°œìƒ:</label>
            <input type="checkbox" id="createEvent" style="width: auto; justify-self: start;">
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**1. ìš°ë¦¬ ì—­ì‚¬ì„œ**</h4>
          <div class="form-row">
            <label for="koreanSource">ì¶œì „:</label>
            <input type="text" id="koreanSource" placeholder="ì˜ˆ: ì‚¼êµ­ì‚¬ê¸°">
          </div>
          <div class="form-row">
            <label for="koreanContent">ë‚´ìš©:</label>
            <textarea id="koreanContent" rows="3"></textarea>
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**2. ì¡êµ­ ì—­ì‚¬ì„œ**</h4>
          <div class="form-row">
            <label for="foreignSource">ì¶œì „:</label>
            <input type="text" id="foreignSource" placeholder="ì˜ˆ: êµ¬ë‹¹ì„œ">
          </div>
          <div class="form-row">
            <label for="foreignContent">ë‚´ìš©:</label>
            <textarea id="foreignContent" rows="3"></textarea>
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**3. ì§„ì§œ ì—­ì‚¬ (ì²œë¬¸/ì§€ë¦¬ ê¸°ë°˜ ì—°êµ¬)**</h4>
          <div class="form-row">
            <label for="trueHistoryContent">ë‚´ìš©:</label>
            <textarea id="trueHistoryContent" rows="3"></textarea>
          </div>
          <div class="form-actions" style="text-align: right; margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" id="cancelHistoryBtn">ì·¨ì†Œ</button>
            <button type="button" id="deleteHistoryBtn" class="danger" style="display: none;">ì‚­ì œ</button>
            <button type="submit" id="saveHistoryBtn" class="primary">ì €ì¥</button>
          </div>
      </form>
  </div>

  <div id="countryForm">
    <h3>êµ­ê°€ ì •ë³´ í¸ì§‘</h3>
    <div class="form-row" style="margin-bottom: 15px;">
        <label for="countrySelectForEdit">ê¸°ì¡´ êµ­ê°€:</label>
        <select id="countrySelectForEdit" style="flex-grow: 1;"></select>
    </div>
    <form id="editCountryForm">
        <input type="hidden" id="countryOriginalName">
        <div class="form-row">
            <label for="countryName">êµ­ê°€ ì´ë¦„:</label>
            <input type="text" id="countryName" required>
        </div>
        <div class="form-row">
            <label for="countryStart">ì‹œì‘ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="countryStart" required value="-2333">
                <input type="number" id="countryStartMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="countryEnd">ì¢…ë£Œ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="countryEnd">
                <input type="number" id="countryEndMonth" min="1" max="12" value="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="countryColor">ë§ˆì»¤ ìƒ‰ìƒ:</label>
            <input type="color" id="countryColor" required style="width: 100%; padding: 0;">
        </div>
        <div class="form-row">
            <label for="countryFlag">í”Œë˜ê·¸ URL:</label>
            <input type="text" id="countryFlag" placeholder="ì„ íƒ ì‚¬í•­">
        </div>
        <div class="form-row">
            <label for="countryEthnicity">ë¯¼ì¡±:</label>
            <input type="text" id="countryEthnicity" placeholder="ì˜ˆ: ê³ êµ¬ë ¤ì¡±">
        </div>
        <div class="form-row">
            <label for="isMainDynasty">ìš°ë¦¬ ë¯¼ì¡±:</label>
            <input type="checkbox" id="isMainDynasty" style="width: auto; justify-self: start;">
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelCountryBtn">ì·¨ì†Œ</button>
          <button type="button" id="deleteCountryBtn" class="danger">ì‚­ì œ</button>
          <button type="submit" id="saveCountryBtn" class="primary">ì €ì¥/ì¶”ê°€</button>
        </div>
    </form>
  </div>
  
  <div id="kingForm">
    <h3>ì™• ì •ë³´ í¸ì§‘</h3>
    <form id="editKingForm">
        <input type="hidden" id="kingMongoId" name="kingMongoId">
        <input type="hidden" id="kingOriginalKey">
        <input type="hidden" id="kingOriginalIndex">
        <div class="form-row">
            <label for="kingCountryName">êµ­ê°€:</label>
            <select id="kingCountryName"></select>
        </div>
        <div class="form-row">
            <label for="kingSelect">ì™• ì„ íƒ/ì¶”ê°€:</label>
            <select id="kingSelect">
                <option value="">ìƒˆ ì™• ì¶”ê°€</option>
            </select>
        </div>
        <div class="form-row">
            <label for="kingName">ì™• ì´ë¦„:</label>
            <input type="text" id="kingName" required>
        </div>
        <div class="form-row">
            <label for="kingStart">ì‹œì‘ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="kingStart" required>
                <input type="number" id="kingStartMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="kingEnd">ì¢…ë£Œ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="kingEnd">
                <input type="number" id="kingEndMonth" min="1" max="12" value="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelKingBtn">ì·¨ì†Œ</button>
          <button type="button" id="deleteKingBtn" class="danger" style="display:none;">ì‚­ì œ</button>
          <button type="submit" id="saveKingBtn" class="primary">ì¶”ê°€</button>
        </div>
    </form>
  </div>

  <!-- ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ í¸ì§‘ í¼ -->
  <div id="eventForm" style="display: none;">
    <h3>ì—°ë„ë³„ ì´ë²¤íŠ¸ í¸ì§‘</h3> <!-- ğŸš© [ìˆ˜ì •] í¼ êµ¬ì¡°ë¥¼ ë‹¤ë¥¸ í¼ê³¼ í†µì¼ -->
    <form id="editEventForm">
        <input type="hidden" id="eventMongoId">
        <div class="form-row" style="margin-bottom: 15px;">
            <label for="eventSelect">ê¸°ì¡´ ì´ë²¤íŠ¸:</label>
            <select id="eventSelect" style="flex-grow: 1;"></select>
        </div>
        <div class="form-row">
            <label for="eventYear">ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="eventYear" required>
                <input type="number" id="eventMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="eventText">ì´ë²¤íŠ¸ ë‚´ìš©:</label>
            <input type="text" id="eventText" required>
        </div>
        <div class="form-row">
            <label for="eventPhoto">ì‚¬ì§„ URL:</label>
            <input type="text" id="eventPhoto" placeholder="ì„ íƒ ì‚¬í•­">
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;"> <!-- ğŸš© [ìˆ˜ì •] form-actions í´ë˜ìŠ¤ ì ìš© -->
            <button type="button" id="cancelEventBtn">ì·¨ì†Œ</button>
            <button type="button" id="deleteEventBtn" class="danger" style="display:none;">ì‚­ì œ</button>
            <button type="submit" id="saveEventBtn" class="primary">ì €ì¥/ì¶”ê°€</button>
        </div>
    </form>
  </div>
  
  <!-- ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸°(ê°•, ì„±ê³½ ë“±) í¸ì§‘ í¼ -->
  <div id="drawingForm" style="display: none;">
    <h3>ì§€í˜•/ì§€ë¬¼ ê·¸ë¦¬ê¸°</h3>
    <form id="editDrawingForm">
        <input type="hidden" id="drawingMongoId">
        <input type="hidden" id="drawingGeoJson">
        <div class="form-row">
            <label for="drawingName">ì´ë¦„:</label>
            <input type="text" id="drawingName" required>
        </div>
        <div class="form-row">
            <label for="drawingType">ìœ í˜•:</label>
            <select id="drawingType">
                <option value="river">ê°•</option>
                <option value="wall">ì„±ê³½</option>
                <option value="arrow">í™”ì‚´í‘œ</option> <!-- ğŸš© [ì¶”ê°€] í™”ì‚´í‘œ ìœ í˜• -->
                <option value="mountain">ì‚°ë§¥</option>
        //        <option value="other">ê¸°íƒ€</option>
            </select>
        </div>
        <div class="form-row">
            <label for="drawingStartYear">ì‹œì‘ ì—°ë„:</label>
            <input type="number" id="drawingStartYear" required>
        </div>
        <div class="form-row">
            <label for="drawingEndYear">ì¢…ë£Œ ì—°ë„:</label>
            <input type="number" id="drawingEndYear" placeholder="ì—†ìœ¼ë©´ ë¹„ì›Œë‘ì„¸ìš”">
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" id="cancelDrawingBtn">ì·¨ì†Œ</button>
            <button type="button" id="deleteDrawingBtn" class="danger" style="display:none;">ì‚­ì œ</button>
            <button type="submit" id="saveDrawingBtn" class="primary">ì €ì¥</button>
        </div>
    </form>
  </div>

<script>
    
    // ğŸš© [ì¶”ê°€] JWT í† í°ì„ ë””ì½”ë”©í•˜ì—¬ payloadë¥¼ ì–»ëŠ” í•¨ìˆ˜
    function parseJwt(token) {
        try {
            // í† í°ì˜ payload ë¶€ë¶„ì„ ì¶”ì¶œ (ë‘ ë²ˆì§¸ ë¶€ë¶„)
            const base64Url = token.split('.')[1];
            // Base64Urlì„ ì¼ë°˜ Base64ë¡œ ë³€í™˜
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            // Base64 ë””ì½”ë”© í›„ UTF-8 ë¬¸ìì—´ë¡œ ë³€í™˜
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null; // ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
        }
    }
    // ğŸš© [ìˆ˜ì •] localStorage ë˜ëŠ” sessionStorageì—ì„œ í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
    }


    // ----------------------------------------------------
    // âš™ï¸ ì„¤ì •
    // ----------------------------------------------------
    // ğŸš© [ìˆ˜ì •] ê³ ëŒ€ ì§€ë„ ì •ë³´ë¥¼ ë°°ì—´ë¡œ ê´€ë¦¬ (ì¶”ê°€/ìˆ˜ì • ìš©ì´)
    const ancientMaps = [
        { 
            id: 'daecheongBtn', 
            name: 'ëŒ€ì²­ê´‘ì—¬ë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/1.%20%E1%84%83%E1%85%A2%E1%84%8E%E1%85%A5%E1%86%BC%E1%84%80%E1%85%AA%E1%86%BC%E1%84%8B%E1%85%A7%E1%84%83%E1%85%A9.JPG?raw=true' 
        },
        { 
            id: 'cheonhaBtn', 
            name: 'ì²œí•˜ê³ ê¸ˆëŒ€ì´í¸ëŒë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/3%20%E1%84%8E%E1%85%A5%E1%86%AB%E1%84%92%E1%85%A1%E1%84%80%E1%85%A9%E1%84%80%E1%85%B3%E1%86%B7%E1%84%83%E1%85%A2%E1%84%8E%E1%85%A9%E1%86%BC%E1%84%91%E1%85%A7%E1%86%AB%E1%84%85%E1%85%A1%E1%86%B7%E1%84%83%E1%85%A9%20%E1%84%92%E1%85%A1%E1%86%AB%E1%84%80%E1%85%B3%E1%86%AF%E1%84%91%E1%85%A1%E1%86%AB(%E1%84%8E%E1%85%A2%E1%86%A8%E1%84%87%E1%85%A9%E1%84%80%E1%85%A9%E1%84%87%E1%85%A5%E1%86%AB%E1%84%8B%E1%85%A7%E1%86%A8).JPG?raw=true' 
        },
        {   id: 'honilBtn', 
            name: 'í˜¼ì¼ê°•ë¦¬ì—­ëŒ€êµ­ë„ì§€ë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/4%20%E1%84%87%E1%85%A9%E1%84%80%E1%85%B3%E1%86%B8%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%92%E1%85%A9%E1%86%AB%E1%84%8B%E1%85%B5%E1%86%AF%E1%84%80%E1%85%A1%E1%86%BC%E1%84%85%E1%85%B5%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%83%E1%85%A2%E1%84%80%E1%85%AE%E1%86%A8%E1%84%83%E1%85%A9%E1%84%8C%E1%85%B5%E1%84%83%E1%85%A9%20(%E1%84%8E%E1%85%A2%E1%86%A8%E1%84%87%E1%85%A9%E1%84%80%E1%85%A9%20%E1%84%92%E1%85%A1%E1%86%AB%E1%84%80%E1%85%B3%E1%86%AF%E1%84%87%E1%85%A5%E1%86%AB%E1%84%8B%E1%85%A7%E1%86%A8).JPG?raw=true' 
        }
    ];

    const API_BASE_URL = '/api'; // ğŸ’¡ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½
    let isLoggedIn = true; // ì´ í˜ì´ì§€ëŠ” í•­ìƒ ë¡œê·¸ì¸ëœ ìƒíƒœì…ë‹ˆë‹¤.
    // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
    let countries = [];
    let currentUser = null; // ğŸš© [ì¶”ê°€] í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì €ì¥
    let countryColors = {};
    let castles = [];
    let history = [];
    let kings = {}; // { countryKey: [ {name, start, end}, ... ] }
    let events = []; // ğŸš© [ì¶”ê°€] ì—°ë„ë³„ ì´ë²¤íŠ¸ ë°ì´í„° ì €ì¥ì†Œ
    let historyEventTimes = []; // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ì˜ ì—°/ì›” ëª©ë¡
    let historyYears = []; // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ì´ ìˆëŠ” ì—°ë„ ëª©ë¡
    let drawings = []; // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ë°ì´í„° ì €ì¥ì†Œ
    let markers = [];
    let heatmapLayers = {}; // êµ­ê°€ë³„ íˆíŠ¸ë§µ ë ˆì´ì–´ ì €ì¥ 

    // UI ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ (isLoggedIn ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸°í™”)
    let editMode = isLoggedIn; // ğŸš© [ìˆ˜ì •] ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì´ˆê¸° í¸ì§‘ ëª¨ë“œ ì„¤ì •
    let editingCastleKey = null;
    let editingHistoryKey = null;
    let editMarker = null; // ë“œë˜ê·¸ ê°€ëŠ¥í•œ í¸ì§‘ìš© ë§ˆì»¤
    let mouseOutTimer = null; // íŒì—… ë‹«ê¸° ì§€ì—° íƒ€ì´ë¨¸
    let eventDisplayTimeout = null; // ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ì‚¬ë¼ì§ íƒ€ì´ë¨¸
    let lastCheckedEventTime = { year: null, month: null }; // ğŸš© [ìˆ˜ì •] ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•œ ì—°/ì›”ì„ ì¶”ì 
    let activePopupMarker = null; // í˜„ì¬ íŒì—…ì´ ì—´ë¦° ë§ˆì»¤ë¥¼ ì¶”ì 
    
    // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ê´€ë ¨ ë³€ìˆ˜
    let drawnItems = new L.FeatureGroup();
    let drawControl;
    let isDrawing = false; // ğŸš© [ì¶”ê°€] í˜„ì¬ ë„í˜•ì„ ê·¸ë¦¬ê³  ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” ìƒíƒœ ë³€ìˆ˜
    
    // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ ìƒíƒœ ì €ì¥ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
    let lastSearchQuery = '';
    let lastSearchResults = [];
    let lastSearchIndex = -1;
    let tileLayerControl = null; // ğŸš© [ì¶”ê°€] íƒ€ì¼ ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜

    // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„° ìƒíƒœ
    let selectedCountryId = 'all';

    // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ê°€ì‹œì„± ìƒíƒœ
    let layerVisibility = {
        city: true,       // ì„±/ë„ì‹œ
        label: false,      // ì§€ëª…
        military: true,   // êµ°ëŒ€
        battle: true,     // ì „ì¥
        natural: false,    // ìì—°
        territory: false,
        event: true       // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ë ˆì´ì–´ ê°€ì‹œì„±
    };

    // --- 2. DOM ìš”ì†Œ ë§µí•‘ ---
    // ğŸš© [ìˆ˜ì •] ì§€ë„ê°€ ì‘ì•„ì¡Œì„ ë•Œ í° ë°”íƒ•ì´ ë³´ì´ì§€ ì•Šë„ë¡ maxBoundsì™€ minZoom ì˜µì…˜ì„ ì¶”ê°€
    const map = L.map('map', {
        center: [36, 120],
        zoom: 5,
        minZoom: 4, // ì§€ë„ë¥¼ ë„ˆë¬´ ì‘ê²Œ ì¶•ì†Œí•˜ëŠ” ê²ƒì„ ë°©ì§€
        worldCopyJump: true // ğŸš© [ì¶”ê°€] ì§€ë„ ì¢Œìš° ë¡¤ë§(ì—°ì† ìŠ¤í¬ë¡¤) ê¸°ëŠ¥ í™œì„±í™”
    });
    // ğŸš© [ìˆ˜ì •] ìœ„ì„± ì§€ë„ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •í•˜ê³ , í† ê¸€ ìˆœì„œ ë³€ê²½
    const tileLayers = {
        'ìœ„ì„±': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 }),
   //     'ë‹¤í¬': L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', { maxZoom: 20 }),
        'ì¼ë°˜': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 })
    };
    let currentTileLayer = tileLayers['ìœ„ì„±']; // ê¸°ë³¸ ë ˆì´ì–´
    currentTileLayer.addTo(map);

    // ğŸš© [ì¶”ê°€] ì§€ë„ ì™¼ìª½ ì•„ë˜ì— ì¶•ì²™ ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    L.control.scale({ imperial: false }).addTo(map); // ë¯¸í„°ë²•(metric)ë§Œ í‘œì‹œ

    // ğŸš© [ìˆ˜ì •] ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•˜ê³  ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •
    function createTileLayerControl() {
        const TileLayerControl = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control-layers-selector');
                
                // ğŸš© [ì¶”ê°€] ì»¨íŠ¸ë¡¤ ìœ„ì—ì„œ ë°œìƒí•˜ëŠ” í´ë¦­ ì´ë²¤íŠ¸ê°€ ì§€ë„ë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë§‰ìŠµë‹ˆë‹¤.
                L.DomEvent.disableClickPropagation(container);
                
                Object.keys(tileLayers).forEach(name => {
                    const button = document.createElement('button');
                    button.textContent = name;
                    button.className = (tileLayers[name] === currentTileLayer) ? 'active' : '';
                    
                    button.onclick = () => {
                        if (currentTileLayer !== tileLayers[name]) {
                            map.removeLayer(currentTileLayer);
                            currentTileLayer = tileLayers[name];
                            map.addLayer(currentTileLayer);
                            
                            // ëª¨ë“  ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±° í›„ í˜„ì¬ ë²„íŠ¼ì—ë§Œ ì¶”ê°€
                            container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                        }
                    };
                    container.appendChild(button);
                });
                
                return container;
            }
        });
        
        return new TileLayerControl({ position: 'topright' });
    }
    // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ë ˆì´ì–´ë¥¼ ìœ„í•œ ì „ìš© Pane ìƒì„±
    // zIndexë¥¼ ë†’ê²Œ ì„¤ì •í•˜ì—¬ ë‹¤ë¥¸ ë ˆì´ì–´(ë§ˆì»¤, íˆíŠ¸ë§µ ë“±)ë³´ë‹¤ í•­ìƒ ìœ„ì— ìˆë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.
    map.createPane('drawingPane');
    map.getPane('drawingPane').style.zIndex = 650;

    let castleLayerGroup = L.layerGroup().addTo(map); 
    map.addLayer(drawnItems); // ğŸš© [ì¶”ê°€] ê·¸ë¦° ë„í˜•ì„ ë‹´ì„ ë ˆì´ì–´ ê·¸ë£¹ ì¶”ê°€
    const combinedSlider = document.getElementById('combinedSlider'); // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” DOM ìš”ì†Œ
    const yearLabel = document.getElementById('yearLabel');
    const ganjiLabel = document.getElementById('ganjiLabel');
    const monthLabel = document.getElementById('monthLabel'); 
    const yearInput = document.getElementById('yearInput');
    const sliderTicks = document.getElementById('sliderTicks');
    const editBtn = document.getElementById('editBtn'); 
    const loginLogoutBtn = document.getElementById('loginLogoutBtn'); // ğŸš© [ì¶”ê°€] ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    const castleForm = document.getElementById('castleForm');
    const addCastleForm = document.getElementById('addCastleForm');
    const cancelCastle = document.getElementById('cancelCastle');
    const deleteCastle = document.getElementById('deleteCastle');
    const castleCountrySelect = document.getElementById('castleCountry');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const addHistoryBtn = document.getElementById('addHistoryBtn');
    const countryEditBtn = document.getElementById('countryEditBtn');
    const kingEditBtn = document.getElementById('kingEditBtn');
    const eventEditBtn = document.getElementById('eventEditBtn'); // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ í¸ì§‘ ë²„íŠ¼
    const countrySelectForEdit = document.getElementById('countrySelectForEdit');
    const prevHistoryBtn = document.getElementById('prevHistoryBtn'); // ğŸš© [ì¶”ê°€] ì´ì „ ì—­ì‚¬ ë²„íŠ¼
    const nextHistoryBtn = document.getElementById('nextHistoryBtn'); // ğŸš© [ì¶”ê°€] ë‹¤ìŒ ì—­ì‚¬ ë²„íŠ¼
    const kingCountrySelectForForm = document.getElementById('kingCountryName');
    const kingSelect = document.getElementById('kingSelect');
    
    // ì„±/ìœ„ì¹˜ í¼ ë‚´ ì²´í¬ë°•ìŠ¤ ë° ìƒì„¸ ì •ë³´
    const layerToggles = document.getElementById('layer-toggles');
    const countryFilterSelect = document.getElementById('countryFilterSelect');
    const militaryFlagDetails = document.getElementById('militaryFlagDetails');
    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° DOM ìš”ì†Œ
    const markerTypeSelector = document.getElementById('markerTypeSelector');

// ğŸš© ìˆ˜ì •: ìƒˆë¡œ ì¶”ê°€ëœ êµ°ëŒ€ ê´€ë ¨ ì…ë ¥ í•„ë“œ ë§µí•‘
const generalNameInput = document.getElementById('generalName');
const troopCountInput = document.getElementById('troopCount');
const generalPhotoInput = document.getElementById('generalPhoto'); // 1ë‹¨ê³„ì—ì„œ ì¶”ê°€í•œ í•„ë“œ


    const pathDataSection = document.getElementById('pathDataSection'); 
    const pathDataList = document.getElementById('pathDataList'); 
    
    // ğŸš© [ì¶”ê°€] ì¬ìƒ ê´€ë ¨ DOM ìš”ì†Œ ë§µí•‘
    const timeLabelDisplay = document.getElementById('timeLabelDisplay'); 
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const playbackSpeedSlider = document.getElementById('playbackSpeedSlider');
    const speedDisplay = document.getElementById('speedDisplay'); // ì†ë„ ë””ìŠ¤í”Œë ˆì´ ë§µí•‘
    // ğŸš© NEW: ìì—° ì§€ë¬¼ ê´€ë ¨ DOM ìš”ì†Œ ë§µí•‘
    const isNaturalFeature = document.getElementById('isNaturalFeature');
    const naturalFeatureDetails = document.getElementById('naturalFeatureDetails');
    const naturalFeatureType = document.getElementById('naturalFeatureType');

    // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ DOM ìš”ì†Œ
    const eventOverlay = document.getElementById('event-overlay');
    const eventOverlayImage = document.getElementById('event-overlay-image');
    const eventOverlayText = document.getElementById('event-overlay-text');

    // --- 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
    
    /** êµ­ê°€ ì´ë¦„ìœ¼ë¡œ êµ­ê°€ ì •ë³´ë¥¼ ì°¾ìŠµë‹ˆë‹¤. */
    function getCountryInfo(name) {
      return countries.find(c => c.name === name);
    }

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì‹œê°„ ê³„ì‚° ë¡œì§ì„ 'ì´ ì›”ìˆ˜' ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½

    /**
     * ì—°ë„ì™€ ì›”ì„ 'ì´ ì›”ìˆ˜'ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (AD 1ë…„ 1ì›” = 0)
     * @param {number} year - ì—°ë„ (BCëŠ” ìŒìˆ˜)
     * @param {number} month - ì›” (1-12)
     * @returns {number} ì´ ì›”ìˆ˜
     */
    function yearMonthToTotalMonths(year, month) {
        // 0ë…„ì€ ì—†ìœ¼ë¯€ë¡œ, BC 1ë…„(year=-1)ì€ AD 1ë…„(year=1) ë°”ë¡œ ì´ì „ ì‹œê°„ì…ë‹ˆë‹¤.
        // AD: (year - 1) * 12
        // BC: year * 12 (ì˜ˆ: -1ë…„ì€ -12ë¶€í„° ì‹œì‘)
        const baseMonths = year >= 1 ? (year - 1) * 12 : year * 12;
        return baseMonths + (month - 1);
    }

    /**
     * 'ì´ ì›”ìˆ˜'ë¥¼ ì—°ë„ì™€ ì›” ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * @param {number} totalMonths - ì´ ì›”ìˆ˜
     * @returns {{year: number, month: number}} ì—°ë„ì™€ ì›”
     */
    function totalMonthsToYearMonth(totalMonths) {
        const year = totalMonths >= 0 ? Math.floor(totalMonths / 12) + 1 : Math.floor(totalMonths / 12);
        const month = (totalMonths % 12 + 12) % 12 + 1;
        // 0ë…„ì€ ì—†ìœ¼ë¯€ë¡œ, ê³„ì‚°ëœ yearê°€ 0ì´ë©´ -1(BC 1ë…„)ë¡œ ì¡°ì •í•©ë‹ˆë‹¤.
        return { year: year === 0 ? -1 : year, month };
    }


    /** ì—°ë„ì™€ ì›”ì„ ë°›ì•„ 60ê°‘ì(ê°„ì§€)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
    function getGanji(year, month) {
        const gan = ["ê°‘", "ì„", "ë³‘", "ì •", "ë¬´", "ê¸°", "ê²½", "ì‹ ", "ì„", "ê³„"];
        const ji = ["ì", "ì¶•", "ì¸", "ë¬˜", "ì§„", "ì‚¬", "ì˜¤", "ë¯¸", "ì‹ ", "ìœ ", "ìˆ ", "í•´"];

        const baseYear = 1804;
        const baseGanIndex = 0; 
        const baseJiIndex = 0; 

        const diff = year - baseYear;

        const ganIndex = (baseGanIndex + diff) % 10;
        const jiIndex = (baseJiIndex + diff) % 12;

        return `${gan[ganIndex < 0 ? ganIndex + 10 : ganIndex]}${ji[jiIndex < 0 ? jiIndex + 12 : jiIndex]}ë…„`;
    }
    

    /** íŠ¹ì • ì—°ë„ì— ì¬ìœ„ ì¤‘ì¸ ì™• ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. */
function getKingByYear(countryName, year, month) {
  // ğŸš© ìˆ˜ì •: êµ­ê°€ ì´ë¦„ìœ¼ë¡œ í•´ë‹¹ êµ­ê°€ì˜ ObjectIdë¥¼ ì°¾ìŠµë‹ˆë‹¤.
  const country = getCountryInfo(countryName);
  if (!country) return null;
  const kingKey = country._id; // <- ObjectIdë¥¼ í‚¤ë¡œ ì‚¬ìš©
  const list = kings[kingKey];
      
      if (!list) return null;
      return list.find(k => {
        const startCombined = yearMonthToTotalMonths(k.start, k.start_month);
        const endCombined = (k.end === null || k.end === undefined || isNaN(k.end)) 
                            ? Infinity 
                            : yearMonthToTotalMonths(k.end, k.end_month);
        const currentCombined = yearMonthToTotalMonths(year, month);

        return startCombined <= currentCombined && currentCombined < endCombined;
      });
    }

    /** í˜„ì¬ ì—°ë„ì™€ ì›”ì˜ ì™• ì •ë³´ë¥¼ íŒ¨ë„ì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. */
    function updateKingLabel(year, month) {
      let html = "";
      countries.forEach(country => { // ğŸš© [ìˆ˜ì •] ë¶ˆí•„ìš”í•œ ê´„í˜¸ ì œê±°
        const king = getKingByYear(country.name, year, month); // <-- THIS LINE WAS MISSING OR MISPLACED
       if (king) { // <-- Now the 'if' statement works because 'king' is defined
            const startMonth = king.start_month || 1;
            const endMonth = king.end_month || 12;
            const endYearText = king.end === null ? 'í˜„ì¬' : `${king.end}ë…„ ${endMonth}ì›”`; 
            const period = `${king.start}ë…„ ${startMonth}ì›” ~ ${endYearText}`;
            let iconHtml;
            const countryColor = country.color || 'gray'; 

            if (country.flag) {
                iconHtml = `<img src="${country.flag}" class="country-flag-img" style="width: 18px; height: 12px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;">`;
            } else {
                iconHtml = `<span style="color:${countryColor}; style="width: 18px; height: 12px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;"">â–£</span>`;
            }

            let kingHtml = `${iconHtml} <b>${country.name}</b>: ${king.name} (${period})`;

            html += `<div class="king-item">${kingHtml}</div>`;
        }
    });
    document.getElementById('kingList').innerHTML = html || "í•´ë‹¹ ì—°ë„ ì™• ì •ë³´ ì—†ìŒ";
}
    /** * path_dataì™€ í˜„ì¬ ì‹œì ì„ ë°”íƒ•ìœ¼ë¡œ êµ°ëŒ€ì˜ ë³´ê°„ëœ ìœ„ì¹˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. */
    function getMilitaryPosition(pathData, currentCombined) {
        if (!pathData || pathData.length < 2) return null; 

        const currentTotalMonths = currentCombined;

        for (let i = 1; i < pathData.length; i++) {
            const startPoint = pathData[i - 1];
            const endPoint = pathData[i];

            const startTotalMonths = yearMonthToTotalMonths(startPoint.target_year, startPoint.target_month);
            const endTotalMonths = yearMonthToTotalMonths(endPoint.target_year, endPoint.target_month);
            
            if (startTotalMonths <= currentTotalMonths && currentTotalMonths < endTotalMonths) {
                const totalMonths = endTotalMonths - startTotalMonths;
                if (totalMonths <= 0) continue; 
                
                const monthsPassed = currentTotalMonths - startTotalMonths;
                
                let progress = monthsPassed / totalMonths;
                if (progress > 1) progress = 1; 

                const lat = startPoint.lat + (endPoint.lat - startPoint.lat) * progress;
                const lng = startPoint.lng + (endPoint.lng - startPoint.lng) * progress;
                
                return { lat: lat, lng: lng }; 
            }
        }
        
        if (pathData.length > 0) {
            const firstPoint = pathData[0];
            const lastPoint = pathData[pathData.length - 1];
            const firstTotalMonths = yearMonthToTotalMonths(firstPoint.target_year, firstPoint.target_month);
            const lastTotalMonths = yearMonthToTotalMonths(lastPoint.target_year, lastPoint.target_month);
            
            if (currentTotalMonths >= lastTotalMonths) {
                return { lat: lastPoint.lat, lng: lastPoint.lng };
            }
            if (currentTotalMonths < firstTotalMonths) {
                return { lat: firstPoint.lat, lng: firstPoint.lng };
            }
        }

        return null; 
    }

    /** í™œì„±í™”ëœ í¼ì„ ì œì™¸í•œ ëª¨ë“  í¼ì„ ë‹«ìŠµë‹ˆë‹¤. (ë™ì¼) */
    function closeAllFormsExcept(exceptId) {
        ['castleForm', 'historyForm', 'countryForm', 'kingForm', 'eventForm', 'drawingForm'].forEach(id => {
            if (id !== exceptId) { // ğŸš© [ìˆ˜ì •] drawingForm ì¶”ê°€
                document.getElementById(id).style.display = "none"; // ğŸš© [ìˆ˜ì •] eventForm ì¶”ê°€
            }
        });
    }

        /** ìì—° ì§€ë¬¼ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ì‹¬ë³¼ê³¼ í´ë˜ìŠ¤ ë§¤í•‘ (NEW) */
    function getNaturalFeatureIcon(type) {
        const icons = {
            'mountain': { symbol: 'â§Š', className: 'feature-mountain' }, // ì‚°
            'sea': { symbol: 'â™’ï¸', className: 'feature-sea' }, // ë°”ë‹¤/í˜¸ìˆ˜
            'river': { symbol: 'ğŸ›¶', className: 'feature-river' }, // ê°•/ë‚´ë¥™
            'mudflat': { symbol: 'ğŸ•³ï¸', className: 'feature-mudflat' }, // ë»˜/ëŠª (ê°ˆìƒ‰ ì›)
            'buffalo': { symbol: 'ğŸƒ', className: 'feature-other' },
            'horse': { symbol: 'ğŸ', className: 'feature-other' },
            'camel': { symbol: 'ğŸ«', className: 'feature-other' },
            'mongky': { symbol: 'ğŸ’', className: 'feature-other' } 
        };
        return icons[type] || icons['other'];
    }

/** ì—°ë„/ì›”ì— í•´ë‹¹í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì°¾ì•„ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
    function checkAndDisplayEvent(year, month) {
        // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ë ˆì´ì–´ê°€ ë¹„í™œì„±í™” ìƒíƒœì´ë©´, ì¦‰ì‹œ ìˆ¨ê¸°ê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
        if (!layerVisibility.event) {
            eventOverlay.classList.remove('visible');
            if (eventDisplayTimeout) {
                clearTimeout(eventDisplayTimeout);
                eventDisplayTimeout = null;
            }
            return;
        }

        // ğŸš© [ìˆ˜ì •] ì´ë²¤íŠ¸ê°€ ì—†ëŠ” ì‹œê°„ìœ¼ë¡œ ì´ë™í–ˆì„ ë•Œ, ì´ì „ íƒ€ì´ë¨¸ë¥¼ ëª…í™•íˆ ì·¨ì†Œí•˜ê³  ì°½ì„ ìˆ¨ê¹ë‹ˆë‹¤.
        if (eventDisplayTimeout) {
            clearTimeout(eventDisplayTimeout);            
            eventDisplayTimeout = null;
        }

        const currentEvent = events.find(e => e.year === year && e.month === month);

        if (currentEvent) {
            // ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´, ê¸°ì¡´ ì˜¤ë²„ë ˆì´ë¥¼ ì ì‹œ ìˆ¨ê²¼ë‹¤ê°€ ë‹¤ì‹œ í‘œì‹œí•˜ì—¬ ê¹œë¹¡ì„ íš¨ê³¼ë¥¼ ì¤ë‹ˆë‹¤.
            eventOverlay.classList.remove('visible');            
            setTimeout(() => {
                eventOverlayText.textContent = currentEvent.text;
                if (currentEvent.photo) {
                    eventOverlayImage.src = currentEvent.photo;
                    eventOverlayImage.style.display = 'block';
                } else {
                    eventOverlayImage.style.display = 'none'; // ì‚¬ì§„ì´ ì—†ìœ¼ë©´ ì´ë¯¸ì§€ íƒœê·¸ ìˆ¨ê¹€
                }
                eventOverlay.classList.add('visible');
                if (currentEvent.lat && currentEvent.lng) {
                    map.flyTo([currentEvent.lat, currentEvent.lng], 10);
                }

                // 1.5ì´ˆ í›„ì— ì°½ì„ ìˆ¨ê¸°ëŠ” íƒ€ì´ë¨¸ ì„¤ì •
                eventDisplayTimeout = setTimeout(() => {
                    eventOverlay.classList.remove('visible');
                    eventDisplayTimeout = null;                    
                }, 1500); // ğŸš© [ìˆ˜ì •] ì´ë²¤íŠ¸ í‘œì‹œ ì‹œê°„ì„ 1.5ì´ˆë¡œ ì¡°ì •
            }, 10);
        } else {
            // ì´ë²¤íŠ¸ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì°½ì„ ìˆ¨ê¹ë‹ˆë‹¤.
            eventOverlay.classList.remove('visible');
        }
    }

// --- 4. ì§€ë„ ë Œë”ë§ ë° ë§ˆì»¤ ìƒì„± í•¨ìˆ˜ ---

function updateMap(year, month) {
        // ğŸš© [ìˆ˜ì •] íˆíŠ¸ë§µ ë ˆì´ì–´ë¥¼ í¬í•¨í•œ ëª¨ë“  ë ˆì´ì–´ ì´ˆê¸°í™”
        Object.values(heatmapLayers).forEach(layer => map.removeLayer(layer));
        heatmapLayers = {};
        castleLayerGroup.clearLayers(); 

        markers.forEach(m => map.removeLayer(m));
        if (editMarker) {
            map.removeLayer(editMarker);
            editMarker = null;
        }

        // ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ê¸° ë ˆì´ì–´ ì´ˆê¸°í™”ë¥¼ ë‹¤ë¥¸ ë ˆì´ì–´ ì´ˆê¸°í™”ì™€ í•¨ê»˜ ì²˜ë¦¬
        drawnItems.clearLayers();

        // ğŸš© [ì¶”ê°€] ì €ì¥ëœ ê·¸ë¦¬ê¸° ë°ì´í„° ë Œë”ë§
        drawings.forEach(drawing => {
            const startYear = drawing.start_year || -Infinity;
            const endYear = drawing.end_year || Infinity;

            if (!(year >= startYear && year <= endYear)) return; // í˜„ì¬ ì‹œê°„ëŒ€ì— ì—†ìœ¼ë©´ ë Œë”ë§ ì•ˆí•¨

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] 'ê°•' ìœ í˜•ì€ 'ìì—°' ë ˆì´ì–´ í† ê¸€ì— ë”°ë¼ í‘œì‹œ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
            if (drawing.type === 'river' && !layerVisibility.natural) {
                return; // 'ìì—°' ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìœ¼ë©´ ê°•ì„ ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
            }
            if (drawing.type === 'mountain' && !layerVisibility.natural) {
                return; // 'ìì—°' ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìœ¼ë©´ ê°•ì„ ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
            }

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê·¸ë¦¬ê¸° ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
            let layer;
            switch (drawing.type) {
                case 'wall': // ğŸš© [ìˆ˜ì •] ì„±ê³½ ìŠ¤íƒ€ì¼ì„ 'å‡¹' í…ìŠ¤íŠ¸ë¥¼ ì´ìš©í•œ í…ìŠ¤ì²˜ë¡œ ë³€ê²½
                    // ğŸš© [ìˆ˜ì •] onEachFeatureë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
                    // ğŸš© [í•µì‹¬ ìˆ˜ì •] setTextëŠ” FeatureGroupì„ ë°˜í™˜í•˜ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°”ì¸ë”©ì„ onEachFeatureì—ì„œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
                    layer = L.geoJSON(drawing.geojson, { style: { color: 'transparent', weight: 10, opacity: 0 } })
                             .setText('å‡¹', {
                        repeat: true,
                        offset: 0,
                        attributes: { 'font-size': '12', 'fill': '#ffffff', 'dy': 5 }
                    });
                    // ìƒì„±ëœ ë ˆì´ì–´ ê·¸ë£¹ì— ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
                    bindDrawingEvents(layer, drawing);
                    break;
                
                case 'river': // ğŸš© [ì¶”ê°€] ê°• ìŠ¤íƒ€ì¼
                    layer = L.geoJSON(drawing.geojson, {
                        style: { color: "#3498db", weight: 6, opacity: 0.7 }, // íŒŒë€ìƒ‰
                        onEachFeature: function (feature, layer) {
                            bindDrawingEvents(layer, drawing);
                        }
                    }); 
                    break;

                case 'mountain': // ğŸš© [ì¶”ê°€] ì‚°ë§¥ ìŠ¤íƒ€ì¼
                    layer = L.geoJSON(drawing.geojson, {
                        style: { 
                            color: "#A0522D", // ê°ˆìƒ‰ ê³„ì—´ (Sienna)
                            weight: 9,
                            opacity: 0.5,
                            dashArray: '5, 10' // ì ì„  ìŠ¤íƒ€ì¼ë¡œ ì‚°ë§¥ í‘œí˜„
                        },
                        pane: 'drawingPane',
                        onEachFeature: (feature, layer) => bindDrawingEvents(layer, drawing)
                    });
                    break;
                case 'arrow': 
                    // ğŸš© [ìˆ˜ì •] ì—¬ëŸ¬ ì„ ë¶„(segment)ì— ì•„ì´ì½˜ì´ ì¤‘ë³µë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ L.polylineìœ¼ë¡œ ë³€í™˜
                    if (drawing.geojson.geometry.type === 'LineString') {
                        const latlngs = drawing.geojson.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        // ğŸš© [í•µì‹¬ ìˆ˜ì •] setTextëŠ” FeatureGroupì„ ë°˜í™˜í•˜ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°”ì¸ë”©ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤.
                        layer = L.polyline(latlngs, { color: 'transparent', weight: 10, opacity: 0, pane: 'drawingPane' })
                                 .setText('â±', {
                                     repeat: true,
                                     offset: 0,
                                     attributes: { 'font-size': '20', 'fill': '#ffffff', 'dy': 5 }
                                 });
                        bindDrawingEvents(layer, drawing); // ìƒì„±ëœ ë ˆì´ì–´ ê·¸ë£¹ì— ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
                    } else { // Polygon ë“± ë‹¤ë¥¸ íƒ€ì…ì€ ê¸°ì¡´ ë°©ì‹ ìœ ì§€
                        layer = L.geoJSON(drawing.geojson, { style: { color: 'transparent', weight: 10, opacity: 0 } }); // ì´ë²¤íŠ¸ ë°”ì¸ë”© í•„ìš” ì‹œ ì¶”ê°€
                    }
                    break;

                default: // ì‚°ë§¥, ë„ë¡œ ë“± ê¸°íƒ€
                    // ğŸš© [ìˆ˜ì •] í™”ì‚´í‘œ ë°ì½”ë ˆì´í„°ë¥¼ ì œê±°í•˜ê³ , ì¼ë°˜ ì„ /ë„í˜•ë§Œ ê·¸ë¦¬ë„ë¡ ë³€ê²½
                    layer = L.geoJSON(drawing.geojson, {
                        style: { 
                            color: "#ffffff", // í°ìƒ‰ ì„ 
                            weight: 5,       // ë‘ê»˜
                            opacity: 0.5     // íˆ¬ëª…ë„
                        },
                        pane: 'drawingPane', // ì „ìš© Paneì— ê·¸ë¦¬ê¸°
                        onEachFeature: function (feature, layer) {
                            bindDrawingEvents(layer, drawing);
                        }
                    });
                    break;
            }

            if (layer) {
                // layer._leaflet_idëŠ” bindDrawingEvents ë‚´ë¶€ì—ì„œ ì„¤ì •ë©ë‹ˆë‹¤.
                drawnItems.addLayer(layer);
            }
        });

        // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ë ˆì´ì–´ì— ëŒ€í•œ ê³µí†µ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜
        function bindDrawingEvents(layer, drawingData) {
            layer._leaflet_id = drawingData._id; // ì‚­ì œ/í¸ì§‘ì„ ìœ„í•œ ID ì—°ê²°
            layer.bindPopup(`<b>${drawingData.name}</b> (${drawingData.type})`);
            
            layer.on('click', () => {
                if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) {
                    const geojsonToEdit = drawingData.geojson;
                    openDrawingForm(geojsonToEdit, drawingData);
                }
            });

            layer.on('mouseover', function (e) {
                this.openPopup();
            });
            layer.on('mouseout', function (e) {
                this.closePopup();
            });
        }

        // ğŸš© [ì¶”ê°€] ê°•ì—­ í‘œì‹œë¥¼ ìœ„í•œ êµ­ê°€ë³„ í¬ì¸íŠ¸ ë°ì´í„° ìˆ˜ì§‘
        const countryPoints = {};
        if (layerVisibility.territory) {
            const currentTotalMonths = yearMonthToTotalMonths(year, month);

            castles.forEach(castle => {
                if (!castle.country_id || typeof castle.lat !== "number" || typeof castle.lng !== "number") return;

                const builtCombined = yearMonthToTotalMonths(castle.built_year || castle.built || 0, castle.built_month || 1);
                const destroyedCombined = yearMonthToTotalMonths(castle.destroyed || castle.destroyed_year || 9999, castle.destroyed_month || 12);
                
                if (builtCombined <= currentTotalMonths && currentTotalMonths <= destroyedCombined) {
                    if (!countryPoints[castle.country_id]) {
                        countryPoints[castle.country_id] = [];
                    }

                    // ğŸš© [ìˆ˜ì •] êµ­ê°€ ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ íˆíŠ¸ë§µ ê°•ë„(intensity)ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •
                    let intensity = 1.2; // ğŸš© [ìˆ˜ì •] ê¸°ë³¸ ê°•ë„ ìƒí–¥
                    if (selectedCountryId !== 'all') {
                        if (castle.country_id === selectedCountryId) {
                            intensity = 2.0; // ğŸš© [ìˆ˜ì •] ì„ íƒëœ êµ­ê°€ëŠ” ë” ê°•í•˜ê²Œ
                        } else {
                            intensity = 0.5; // ğŸš© [ìˆ˜ì •] ë‚˜ë¨¸ì§€ êµ­ê°€ëŠ” ì•½ê°„ ë” ê°•í•˜ê²Œ
                        }
                    }
                    countryPoints[castle.country_id].push([castle.lat, castle.lng, intensity]); 
                }
            });
        }


        markers = [];
        if (!Array.isArray(castles) || castles.length === 0) return;
        let marker = null;
        
        castles.forEach(castle => {
            // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„°ë§ ë¡œì§
            if (selectedCountryId !== 'all' && castle.country_id && castle.country_id !== selectedCountryId) {
                return; // ì„ íƒëœ êµ­ê°€ì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì´ ë§ˆì»¤ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
            }
            
            let popupHtml; 
            if (typeof castle.lat !== "number" || isNaN(castle.lat) || typeof castle.lng !== "number" || isNaN(castle.lng)) return;
            
        // ğŸš¨ [ìˆ˜ì • 1] country, countryId ë³€ìˆ˜ë¥¼ ë£¨í”„ ì‹œì‘ ë¶€ë¶„ì—ì„œ ì„ ì–¸í•˜ì—¬ ì¶©ëŒ ë°©ì§€
        const currentTotalMonths = yearMonthToTotalMonths(year, month);
        const builtTotalMonths = yearMonthToTotalMonths(castle.built_year || castle.built || 0, castle.built_month || 1);
        const destroyedTotalMonths = yearMonthToTotalMonths(castle.destroyed || castle.destroyed_year || 9999, castle.destroyed_month || 12);
        const isWithinDuration = builtTotalMonths <= currentTotalMonths && currentTotalMonths <= destroyedTotalMonths;
        const castleBuiltYear = castle.built_year || castle.built || 0;
        const castleDestroyedYear = castle.destroyed || castle.destroyed_year || 'í˜„ì¬';
        const builtText = `${castleBuiltYear}ë…„ ${castle.built_month || 1}ì›”`;
        const destroyedText = castleDestroyedYear === 'í˜„ì¬' ? 'í˜„ì¬' : `${castleDestroyedYear}ë…„ ${castle.destroyed_month || 12}ì›”`;

        const countryId = castle.country_id;
        const countryInfo = getCountryInfoById(countryId); // â¬…ï¸ 'country' ëŒ€ì‹  'countryInfo' ì‚¬ìš© (ì¶©ëŒ íšŒí”¼)
        
        const countryName = countryInfo ? countryInfo.name : 'ì•Œ ìˆ˜ ì—†ìŒ';
        const dotColor = countryInfo ? countryInfo.color : 'white'; 
        
        const king = getKingByYear(countryName, year, month); // â¬…ï¸ king ì¡°íšŒëŠ” countryName ì‚¬ìš©

            // ğŸš© 0. ì§€ì—­ëª…/í…ìŠ¤íŠ¸ ë¼ë²¨ ë§ˆì»¤ (NEW)
            if (castle.is_label) {
                if (!layerVisibility.label) return;
                if (!isWithinDuration) return;

                const labelIcon = L.divIcon({
                    className: 'location-label-marker',
                    html: `<div style="color: ${castle.label_color || '#FFFFFF'};">${castle.name}</div>`,
                    iconSize: [100, 20], // í¬ê¸°ëŠ” CSSì— ë§ê²Œ ì¡°ì •
                    iconAnchor: [50, 15] // ì¤‘ì•™ì— ë§ì¶”ê¸°
                });
                marker = L.marker([castle.lat, castle.lng], { icon: labelIcon });
                
             //   const builtText = `${castleBuiltYear}ë…„ ${castle.built_month || ''}ì›”`;
              //  const destroyedText = castle.destroyed || castle.destroyed_year ? `${castleDestroyedYear}ë…„ ${castle.destroyed_month || ''}ì›”` : 'ì•Œ ìˆ˜ ì—†ìŒ';
                popupHtml = `<b>ì§€ì—­ëª…: ${castle.name}</b><br>ê¸°ê°„: ${builtText} ~ ${destroyedText}<br>ì„¤ëª…: ${castle.desc ?? ''}`;
                
                //marker.bindPopup(popupHtml);
                // íŒì—… ì´ë²¤íŠ¸ ì¶”ê°€ (ì¼ë°˜ ë§ˆì»¤ì™€ ë™ì¼í•œ ê¹œë¹¡ì„ ë°©ì§€ ë¡œì§ ì ìš© ê°€ëŠ¥)
               // marker.on('mouseout', function (e) { this.closePopup(); });
              marker.on('click', (e) => { 
                map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                if (editMode) openCastleForm(castle._id); 
              });
              markers.push(marker);
              marker.addTo(map); 
              return; // ğŸš© [ë³µì›] ë‹¤ë¥¸ ë§ˆì»¤ íƒ€ì…ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ return ì¶”ê°€
            } 
            // ğŸš© 1. ìì—° ì§€ë¬¼ ë§ˆì»¤ (NEW)
            if (castle.is_natural_feature) { 
                if (!layerVisibility.natural) return;
                if (!isWithinDuration) return;

                const featureType = castle.natural_feature_type || 'other';
                const iconInfo = getNaturalFeatureIcon(featureType);
                
                const featureIcon = L.divIcon({
                    className: `natural-feature-marker ${iconInfo.className}`,
                        html: `<div>${iconInfo.symbol}</div><div class="feature-name">${castle.name}</div>`,
                        iconSize: [60, 40],
                        iconAnchor: [30, 40],
                        popupAnchor: [6, -30] // ğŸš© [ì¶”ê°€] íŒì—… ìœ„ì¹˜ë¥¼ ì•„ì´ì½˜ ìƒë‹¨ìœ¼ë¡œ ì¡°ì •
                });
                marker = L.marker([castle.lat, castle.lng], { icon: featureIcon });
                
            //    const builtText = `${castleBuiltYear}ë…„ ${castle.built_month || ''}ì›”`;
             //   const destroyedText = castle.destroyed || castle.destroyed_year ? `${castleDestroyedYear}ë…„ ${castle.destroyed_month || ''}ì›”` : 'ì•Œ ìˆ˜ ì—†ìŒ';
                // ğŸš© [ìˆ˜ì •] íŒì—… HTMLì— ì‚¬ì§„ URLì„ í¬í•¨í•˜ë„ë¡ ì¶”ê°€í•©ë‹ˆë‹¤.
                popupHtml = `
                    ${castle.name}</b><br>
                    ${castle.desc ?? ''}
                    ${castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ""}
                `;
                                
                marker.bindPopup(popupHtml);
                // íŒì—… ì´ë²¤íŠ¸ ì¶”ê°€
                marker.on('mouseover', function (e) { this.openPopup(); });
                marker.on('mouseout', function (e) { this.closePopup(); });
                marker.on('click', (e) => { 
                    map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                    if (editMode) openCastleForm(castle._id); 
                });
                markers.push(marker);
                marker.addTo(map);
                return; // ğŸš© [ë³µì›] ë‹¤ë¥¸ ë§ˆì»¤ íƒ€ì…ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ return ì¶”ê°€
            }
            // ğŸš© 2. ì „ì¥ ë§ˆì»¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            if (castle.is_battle) {
                if (!layerVisibility.battle) return;
                if (isWithinDuration) {
                    // ... ê¸°ì¡´ ì „ì¥ ë§ˆì»¤ ë Œë”ë§ ë¡œì§ ìœ ì§€ ...
                    const battleIcon = L.divIcon({
                        className: 'battle-marker',
                            html: `<div style="line-height: 0.8;">âš”ï¸</div><div style="font-size: 12px; color: white; white-space: nowrap; margin-top: -5px;">${castle.name}</div>`,
                            iconSize: [80, 40],
                            iconAnchor: [40, 30],
                            popupAnchor: [6, -25]

                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: battleIcon });
                    
             //       const builtText = `${castleBuiltYear}ë…„ ${castle.built_month || ''}ì›”`;
              //      const destroyedText = castle.destroyed || castle.destroyed_year ? `${castleDestroyedYear}ë…„ ${castle.destroyed_month || ''}ì›”` : 'ì•Œ ìˆ˜ ì—†ìŒ';
                    // ğŸš© [ìˆ˜ì •] íŒì—… HTMLì— ì‚¬ì§„ URLì„ í¬í•¨í•˜ë„ë¡ ì¶”ê°€í•©ë‹ˆë‹¤.
                    popupHtml = `
                        <b>ì „ì¥: ${castle.name}</b><br>
                        ê¸°ê°„: ${builtText} ~ ${destroyedText}<br>
                        ì„¤ëª…: ${castle.desc ?? ''}
                        ${castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ""}
                    `;
                                        
                    marker.bindPopup(popupHtml);
                                    // íŒì—… ì´ë²¤íŠ¸ ì¶”ê°€
                marker.on('mouseover', function (e) { this.openPopup(); });
                marker.on('mouseout', function (e) { this.closePopup(); });
                    marker.on('click', (e) => { 
                        map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                        if (editMode) openCastleForm(castle._id); 
                    });
                    markers.push(marker);
                    marker.addTo(map);
                    return; // ğŸš© [ë³µì›] ë‹¤ë¥¸ ë§ˆì»¤ íƒ€ì…ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ return ì¶”ê°€
                } else {
                    return; 
                }
            } 

            // ğŸš© 3. êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            if (castle.is_military_flag) {
                if (!layerVisibility.military) return;
                // ... ê¸°ì¡´ êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤ ë Œë”ë§ ë¡œì§ ìœ ì§€ ...
                // ğŸš¨ [í•µì‹¬ ìˆ˜ì •] êµ°ëŒ€ ë§ˆì»¤ëŠ” Built Date ì´ì „ì—ëŠ” ë¬´ì¡°ê±´ í‘œì‹œë˜ì§€ ì•Šì•„ì•¼ í•¨.
                if (!isWithinDuration) return; 
                
                let markerLat = castle.lat;
                let markerLng = castle.lng;
                let shouldDisplay = true; // isWithinDurationì´ trueì´ë¯€ë¡œ ê¸°ë³¸ í‘œì‹œ

                if (Array.isArray(castle.path_data) && castle.path_data.length >= 2) {
                    // ê²½ë¡œê°€ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´, ê²½ë¡œ ë³´ê°„ ë¡œì§ì„ ë”°ë¦„
                    const position = getMilitaryPosition(castle.path_data, currentTotalMonths);
                    if (position) {
                        markerLat = position.lat;
                        markerLng = position.lng;
                        // shouldDisplayëŠ” ì´ë¯¸ true.
                    } else {
                        shouldDisplay = false; // ê²½ë¡œ ë²”ìœ„ ë°–ì´ë©´ ë¯¸í‘œì‹œ
                    }
                } 
                // else: ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì •ì  ìœ„ì¹˜(castle.lat/lng) ì‚¬ìš©

                if (!shouldDisplay) return;

                const general = castle.general_name || 'ì¥ìˆ˜ ë¯¸ìƒ';
                const troops = castle.troop_count ? `${Number(castle.troop_count).toLocaleString()}` : 'ë³‘ë ¥ ë¯¸ìƒ';
                const flagColor = countryInfo.color || "white";  
                const generalPhotoUrl = castle.general_photo || ''; 

                // ğŸš© [ìˆ˜ì •] ì¥ìˆ˜ ì‚¬ì§„ ìœ ë¬´ì— ë”°ë¼ ì•„ì´ì½˜ ë‚´ìš©ì„ ë‹¤ë¥´ê²Œ êµ¬ì„±í•©ë‹ˆë‹¤.
                let iconContent;
                if (generalPhotoUrl) {
                    // ì‚¬ì§„ì´ ìˆì„ ê²½ìš°: ì‚¬ì§„ê³¼ í…ìŠ¤íŠ¸ë¥¼ ì¤‘ì•™ ì •ë ¬
                    iconContent = `
                        <div style="display: flex; flex-direction: column; align-items: center; text-align: center; gap: 2px;">
                            <div class="military-flag-details">
                                <span style="color:white">${troops}</span>
                            </div>
                            <img src="${generalPhotoUrl}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 3px solid ${flagColor};">
                            <div class="military-flag-details">
                                <span style="color:white">${general}</span>
                            </div>
                        </div>`;
                } else {
                    // ì‚¬ì§„ì´ ì—†ì„ ê²½ìš°: ê¸°ì¡´ ê¹ƒë°œ ì•„ì´ì½˜ ì‚¬ìš©
                    iconContent = `
                        <div class="flag-icon-container">
                            <div class="flag-icon-symbol" style="color:${flagColor};">âš‘</div>
                            <div class="military-flag-details" style="color:${flagColor}; font-size: 10px;">${countryName} ${general}<br>${troops}</div>
                        </div>`;
                }

                const flagIcon = L.divIcon({
                    className: 'custom-flag-marker', 
                    html: `<div style="display: flex; justify-content: center; align-items: center;">${iconContent}</div>`, 
                    iconSize: [70, 60],
                    iconAnchor: [35, 60],
                    popupAnchor:  [0, -60] // ğŸš© [ìˆ˜ì •] íŒì—… ìœ„ì¹˜ë¥¼ ì•„ì´ì½˜ ìƒë‹¨ìœ¼ë¡œ ì¡°ì •
                });
                
                marker = L.marker([markerLat, markerLng], { icon: flagIcon }); 
                
                const flagHtml = countryInfo.flag ? `<img src="${countryInfo.flag}" class="country-flag-img" style="width: 20px; height: 13px; border: 1px solid #ccc; vertical-align: middle; margin-right: 5px;">` : '';

                popupHtml = `
                    ${flagHtml}<b>${countryName}</b>
                    ${countryInfo.ethnicity ? `<br>ë¯¼ì¡±: ${countryInfo.ethnicity}` : ''}<br>
                    ì¥ìˆ˜: ${general} <br> 
                    ë³‘ë ¥: ${troops} <br> 
                    ìœ„ì¹˜: ${castle.name}<br>

                    ${generalPhotoUrl ? `<img src="${generalPhotoUrl}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ''}<br>
                    ${castle.desc ?? ''}
                `;
                
                marker.bindPopup(popupHtml);
                                // íŒì—… ì´ë²¤íŠ¸ ì¶”ê°€
                marker.on('mouseover', function (e) { this.openPopup(); });
                marker.on('mouseout', function (e) { this.closePopup(); });
                marker.on('click', (e) => { 
                    map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                    if (editMode) openCastleForm(castle._id); 
                });
                markers.push(marker);
                marker.addTo(map);
                return; // ğŸš© [ë³µì›] êµ°ëŒ€ ë§ˆì»¤ê°€ ì¼ë°˜ ì„± ë§ˆì»¤ë¡œ ë®ì–´ì”Œì›Œì§€ëŠ” ê²ƒì„ ë°©ì§€
            }


            // 4. ì¼ë°˜ ì„±/ë„ì‹œ ë§ˆì»¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        if (!layerVisibility.city) return;
        if (!isWithinDuration) return;
        
        const currentCountry = countryInfo; // â¬…ï¸ ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜í•œ countryInfo ì‚¬ìš©
        if (!currentCountry) return;
        
        // ğŸš© êµ­ê°€ ì¡´ì† ê¸°ê°„ ì²´í¬
        const countryStartCombined = yearMonthToTotalMonths(currentCountry.start, currentCountry.start_month);
        const countryEndCombined = (currentCountry.end === null || isNaN(currentCountry.end)) ? Infinity : yearMonthToTotalMonths(currentCountry.end, currentCountry.end_month); 
        
        if (!(countryStartCombined <= currentTotalMonths && countryEndCombined >= currentTotalMonths)) return; 

        //const king = getKingByYear(countryName, year, month); // âœ… ìˆ˜ì •: countryName ì‚¬ìš©
     
        //    const builtText = `${castleBuiltYear}ë…„ ${castle.built_month || 1}ì›”`;
        //    const destroyedText = castle.destroyed === null ? 'í˜„ì¬' : `${castle.destroyed}ë…„ ${castle.destroyed_month || 12}ì›”`;
            
            let kingHtml = king ? `<br><b>ì™•:</b> ${king.name} (${king.start}ë…„ ${king.start_month||1}ì›” ~ ${king.end === null ? 'í˜„ì¬' : `${king.end}ë…„ ${king.end_month||1}ì›”`})` : "";
           // ğŸš© [ìˆ˜ì •] êµ­ê¸° ì´ë¯¸ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜ ì¶”ê°€
        const flagHtml = currentCountry.flag ?
            `<img src="${currentCountry.flag}" class="country-flag-img" style="width: 20px; height: 13px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;">` : '';
        const countryEthnicity = currentCountry.ethnicity ? `<br>ë¯¼ì¡±: ${currentCountry.ethnicity}` : '';
        
        popupHtml = `
                <b>${castle.name}</b>
                <br>${flagHtml} ${countryName}${countryEthnicity}<br>
                ì¡´ì†: ${builtText} ~ ${destroyedText}` 
                + (castle.desc ? `<br><span>${castle.desc}</span>` : "") 
                + (castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : "") 
                + kingHtml


            if (currentCountry.flag && !castle.is_capital) {
              // ... ê¸°ì¡´ ê¹ƒë°œ + ì´ë¦„ ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
          // ğŸš© [ìˆ˜ì •] ì´ë¦„í‘œ ë°°ê²½ ì´ë¯¸ì§€ ì ìš©
          const flagAndNameIconHtml = `
            <div style="display: flex; align-items: center; gap: 5px;">
              <img src="${currentCountry.flag}" class="country-flag-img" style="width: 30px; height: 20px; border: 1px solid #fff;">
              <span class="city-name" style="color:${currentCountry.color || 'white'}; font-weight: bold; font-size: 10px; white-space: nowrap;">${castle.name}</span>
            </div>
              `;
              const customIcon = L.divIcon({
                  className: 'custom-flag-name-marker', 
                  html: flagAndNameIconHtml,
                  iconAnchor: [10, -5]
              });
              marker = L.marker([castle.lat, castle.lng], { icon: customIcon });
            }

            if (castle.is_capital) {
              // ... ê¸°ì¡´ ì™•ì„± ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
              if (currentCountry.flag) {
            const capitalWithFlagIconHtml = `<div class="capital-marker" style="display: flex; flex-direction: column; align-items: center;">
                <img src="${currentCountry.flag}" class="country-flag-img" style="width: 30px; height: 20px; border: 1px solid #fff; margin-bottom: 5px;">
                <span class="city-name">${currentCountry.name} ìˆ˜ë„<br>${castle.name}</span>
            </div>`;
                const customIcon = L.divIcon({
                  className: 'custom-capital-flag-marker',
                  html: capitalWithFlagIconHtml,
                  iconAnchor: [6, -2] 
                });
                marker = L.marker([castle.lat, castle.lng], { icon: customIcon, zIndexOffset: 1000 });
              } else { 
            const capitalIcon = L.divIcon({
              className: 'capital-marker',
              html: `
                <span style="color:${currentCountry.color || 'white'};">â–£</span><span class="city-name">${currentCountry.name} ìˆ˜ë„<br>${castle.name}</span>
                  `,
                  iconSize: [50, 50],
                  iconAnchor: [25, 4]
                });
                marker = L.marker([castle.lat, castle.lng], { icon: capitalIcon, zIndexOffset: 1000 });
              }
            } else { 
              // ... ê¸°ì¡´ ì¼ë°˜ ì„±/ë„ì‹œ ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
          // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¼ë°˜ì„± ë§ˆì»¤ë¥¼ ì›(dot)ì—ì„œ ì—­ì‚¼ê°í˜•(â–¼)ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
          const dotColor = currentCountry.color || 'white'; 
              const markerHtml = `<div style="position: relative; display: flex; flex-direction: column; align-items: center;">
                                    <div style="width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 10px solid ${dotColor}; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.8));"></div><div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color:${dotColor}; font-weight: bold; font-size: 10px; white-space: nowrap; text-shadow: -1px -1px 1px #000, 1px -1px 1px #000, -1px 1px 1px #000, 1px 1px 1px #000, 0px 0px 2px #000;">${castle.name}</div>
                                  </div>`;
              const customIcon = L.divIcon({
                className: 'custom-city-marker',
                html: markerHtml,
                iconAnchor: [6, 6],
                popupAnchor: [0.5, -5]
              });
              marker = L.marker([castle.lat, castle.lng], { icon: customIcon });
            }
        
            if (marker) {
              
              
              marker.bindPopup(popupHtml);
              // [ì¶”ê°€] ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ íŒì—… ì—´ê¸°
              marker.on('mouseover', function (e) {
                this.openPopup();
              });
              // [ì¶”ê°€] ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ íŒì—… ë‹«ê¸°
              marker.on('mouseout', function (e) {
                this.closePopup();
              });
              
              marker.on('click', (e) => { 
                map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                if (editMode) openCastleForm(castle._id); 
              });
              markers.push(marker);
              marker.addTo(map);
              marker = null; 
            }
        });

        // ğŸš© [ì¶”ê°€] ìˆ˜ì§‘ëœ í¬ì¸íŠ¸ë¡œ êµ­ê°€ë³„ íˆíŠ¸ë§µ ë ˆì´ì–´ ìƒì„± ë° ì¶”ê°€
        if (layerVisibility.territory) {
            for (const countryId in countryPoints) {
                const points = countryPoints[countryId];
                const countryInfo = getCountryInfoById(countryId);
                // ğŸš© [ìˆ˜ì •] countryInfoì™€ countryInfo.colorê°€ ëª¨ë‘ ìœ íš¨í•œì§€ í™•ì¸í•©ë‹ˆë‹¤.
                if (countryInfo && countryInfo.color && points.length > 0) {
                    const heatLayer = L.heatLayer(points, {
                        // ğŸš© [ìˆ˜ì •] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ radius, blur ê°’ ì¬ì¡°ì •
                        radius: map.getZoom() <= 5 ? 100 : (map.getZoom() <= 7 ? 80 : 60),
                        blur: map.getZoom() <= 5 ? 30 : (map.getZoom() <= 7 ? 25 : 20),
                        max: 1.0, // ê°•ë„ ìµœëŒ€ì¹˜ë¥¼ 1.0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì¼ê´€ëœ í‘œí˜„
                        maxZoom: 10, // íŠ¹ì • ì¤Œ ë ˆë²¨ ì´í•˜ì—ì„œë§Œ ë³´ì´ë„ë¡ ì„¤ì •
                        // ğŸš© [ìˆ˜ì •] countryInfo.colorê°€ ìœ íš¨í•˜ì§€ ì•Šì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê¸°ë³¸ ìƒ‰ìƒ('grey')ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                        gradient: { 0: 'transparent', 1: countryInfo.color || 'grey' } 
                    }).addTo(map);
                    
                    // ìƒì„±ëœ ë ˆì´ì–´ë¥¼ ê´€ë¦¬ë¥¼ ìœ„í•´ ì €ì¥
                    heatmapLayers[countryId] = heatLayer;
                }
            }
        }

    }

function getCountryInfoById(id) {
    // ğŸš© [í•„ìˆ˜ í™•ì¸] idê°€ ObjectId ê°ì²´ì¼ ìˆ˜ë„, ë¬¸ìì—´ì¼ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ, toString()ìœ¼ë¡œ ë¹„êµ
    if (!id) return null;
    return countries.find(c => c._id === id || c._id.toString() === id);
}
    // --- 5. ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™” ---
    function updateDrawings() {
        drawnItems.clearLayers();
    }
    async function fetchData(endpoint) {
      try {
        const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (!response.ok) {
          throw new Error(`${endpoint} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
        }
        return await response.json();
      } catch (error) {
        console.error(error);
        return []; 
      }
    }
    
    async function initialize() {
      console.log("ë°ì´í„° ì´ˆê¸°í™” ì¤‘...");

      // ğŸš© [í•µì‹¬ ìˆ˜ì •] Promise.allì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œí•˜ê³ , ëª¨ë‘ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
      const [castlesData, historyData, countriesData, eventsData, kingsDataResult, drawingsData] = await Promise.all([
          fetchData('castle'),
          fetchData('history'),
          fetchData('countries'),
          fetchData('events'),
          fetchData('kings'),
          fetchData('drawings')
      ]);

      // ğŸš© [í•µì‹¬ ìˆ˜ì •] Promise.allë¡œ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹í•©ë‹ˆë‹¤.
      castles = castlesData;
      history = historyData;
      countries = countriesData;
      events = eventsData;
      const kingsData = kingsDataResult; // kingsDataëŠ” ì•„ë˜ì—ì„œ ë³„ë„ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ kingsDataResultë¡œ ë°›ìŠµë‹ˆë‹¤.
      drawings = drawingsData;

      // ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ê³¼ ì´ë²¤íŠ¸ë¥¼ í•©ì³ì„œ ì‹œê°„ ëª©ë¡ ìƒì„±
      historyEventTimes = [...new Set(historyData.map(h => yearMonthToTotalMonths(h.year, h.month)))].sort((a, b) => a - b);
 
      // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì´ì „/ë‹¤ìŒ ì—­ì‚¬ ê¸°ë¡ìœ¼ë¡œ ì´ë™ ì‹œ 'ì›”'ê¹Œì§€ ì •í™•í•˜ê²Œ ì´ë™í•˜ë„ë¡ ë¡œì§ ìˆ˜ì •
      prevHistoryBtn.addEventListener('click', () => {
          const year = parseInt(yearInput.value);
          const month = parseInt(monthInput.value);
          const currentTotalMonths = yearMonthToTotalMonths(year, month);
          let foundPrev = false;

          for (let i = historyEventTimes.length - 1; i >= 0; i--) {
              if (historyEventTimes[i] < currentTotalMonths) {
                  const { year: targetYear, month: targetMonth } = totalMonthsToYearMonth(historyEventTimes[i]);
                  updateTime(targetYear, targetMonth);
                  foundPrev = true;
                  break;
              }
          }

      });

      nextHistoryBtn.addEventListener('click', () => {
          const year = parseInt(yearInput.value);
          const month = parseInt(monthInput.value);
          const currentTotalMonths = yearMonthToTotalMonths(year, month);
          let foundNext = false;

          for (let i = 0; i < historyEventTimes.length; i++) {
              if (historyEventTimes[i] > currentTotalMonths) {
                  const { year: targetYear, month: targetMonth } = totalMonthsToYearMonth(historyEventTimes[i]);
                  updateTime(targetYear, targetMonth);
                  foundNext = true;
                  break;
              }
          }

      });


      // ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ ë³€ê²½ ì‹œ ë§ˆì»¤ í¬ê¸° ì¡°ì ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      map.on('zoomend', () => {
          const zoom = map.getZoom();
          let scale = 1.0;

          // ì¤Œ ë ˆë²¨ì— ë”°ë¼ scale ê°’ ê²°ì •
          if (zoom <= 4) scale = 0.4;
          else if (zoom === 5) scale = 0.6;
          else if (zoom === 6) scale = 0.8;
          else if (zoom === 7) scale = 1.0;
          else if (zoom >= 8) scale = 1.2;

          // map ì»¨í…Œì´ë„ˆì— CSS ë³€ìˆ˜(--marker-scale) ì„¤ì •
          const mapContainer = map.getContainer();
          mapContainer.style.setProperty('--marker-scale', scale);
      });

      // ì´ˆê¸° ë¡œë“œ ì‹œ ë§ˆì»¤ í¬ê¸° ì„¤ì •
      map.fire('zoomend');

      // ğŸš© [ìˆ˜ì •] íƒ€ì¼ ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ì´ ì¤‘ë³µ ìƒì„±ë˜ì§€ ì•Šë„ë¡ ìˆ˜ì •
      if (tileLayerControl) {
          map.removeControl(tileLayerControl);
      }
      tileLayerControl = createTileLayerControl();
      tileLayerControl.addTo(map);

      // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      countryFilterSelect.onchange = (e) => {
          selectedCountryId = e.target.value;
          const { year, month } = getCurrentYearMonth();
          updateMap(year, month);
          // êµ­ê°€ í•„í„° ë³€ê²½ ì‹œ ì™• ëª©ë¡ë„ ì—…ë°ì´íŠ¸í•˜ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤.
          updateKingLabel(year, month);
      };
            // ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ ë³€ê²½ ì‹œ ê°•ì—­(íˆíŠ¸ë§µ)ì„ ë‹¤ì‹œ ê·¸ë¦¬ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      // ğŸš© [ìˆ˜ì •] ë¶ˆí•„ìš”í•œ updateMap í˜¸ì¶œì„ ì œê±°í•˜ì—¬ ì´ë²¤íŠ¸ ì¶©ëŒ ë° ë©ˆì¶¤ í˜„ìƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
      map.on('zoomend', () => {
          const { year, month } = getCurrentYearMonth();
          updateKingLabel(year, month);
      });
      
      // ğŸš© [ì¶”ê°€] ì†ë„ ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
      playbackSpeedSlider.oninput = () => {
          speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
          // ì¬ìƒ ì¤‘ì´ë¼ë©´ ì†ë„ë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë©ˆì·„ë‹¤ê°€ ë‹¤ì‹œ ì‹œì‘)
          if (playInterval) {
              stopPlayback();
              startPlayback();
          }
      };

      countryColors = {};
      countries.forEach(c => { countryColors[c.name] = c.color; });
      countries.sort((a, b) => { return a.name.localeCompare(b.name, 'ko'); });
      
    kings = {}; 
    if (Array.isArray(kingsData)) {
      kingsData.forEach(item => {
        // ğŸš© ìˆ˜ì •: MongoDB kings ì»¬ë ‰ì…˜ì˜ country_idë¥¼ í‚¤ë¡œ ì‚¬ìš©
        if (item.country_id && Array.isArray(item.kings)) {
             kings[item.country_id] = item.kings; // <- Use country_id as the key
        }
      });
    }

      // ğŸš© [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ê¸°ëŠ¥ í™œì„±í™”
      const logoutBtnHeader = document.getElementById('logoutBtnHeader');
      logoutBtnHeader.addEventListener('click', () => {
          if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              // ğŸš© [ìˆ˜ì •] ë‘ ì €ì¥ì†Œì˜ í† í°ì„ ëª¨ë‘ ì‚­ì œ
              localStorage.removeItem('token');
              sessionStorage.removeItem('token');
              localStorage.removeItem('token');
              window.location.href = 'login.html';
          }
      });

      // ğŸš© [ìˆ˜ì •] ì‚¬ìš©ì ì •ë³´ ê¸°ë°˜ UI ì„¤ì •
      currentUser = parseJwt(token);
      if (currentUser) {
          document.getElementById('usernameDisplay').textContent = `${currentUser.username}ë‹˜`;

          // 'admin' ë˜ëŠ” 'superuser'ì¼ ë•Œ í¸ì§‘ ëª¨ë“œ ë°”ë¡œ í™œì„±í™”
          if (currentUser.role === 'admin' || currentUser.role === 'superuser') {
              editMode = true;
              cityEditBtn.style.display = 'inline-block'; // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± í¸ì§‘ ë²„íŠ¼ í‘œì‹œ
              document.getElementById('countryEditBtn').style.display = 'inline-block';
              document.getElementById('kingEditBtn').style.display = 'inline-block';
              document.getElementById('eventEditBtn').style.display = 'inline-block';

              addHistoryBtn.style.display = 'inline-block';
          } else {
              editMode = false; // ì¼ë°˜ ì‚¬ìš©ìëŠ” í¸ì§‘ ëª¨ë“œ ë¹„í™œì„±í™”
          }
      } else {
          const adminLink = document.getElementById('adminLink');
          if (adminLink) adminLink.style.display = 'none';
          editMode = false;
      }

      // 'admin'ì¼ ë•Œë§Œ íšŒì› ê´€ë¦¬ ë§í¬ í‘œì‹œ (ì—­í•  ì²´í¬ ë¶„ë¦¬)
      if (currentUser?.role === 'admin') {
          const adminLink = document.getElementById('adminLink');
          if (adminLink) adminLink.style.display = 'inline-block';
      }

      // ğŸš© [ìˆ˜ì •] ê³ ëŒ€ ì§€ë„ ë²„íŠ¼ ë™ì  ìƒì„± ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      const mapButtonContainer = document.getElementById('ancient-map-button-container');
      mapButtonContainer.innerHTML = ''; // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
      ancientMaps.forEach(mapInfo => {
          const button = document.createElement('button');
          button.id = mapInfo.id;
          button.className = 'primary';
          button.textContent = mapInfo.name;
          
          button.addEventListener('click', () => {
              const newTab = window.open();
              newTab.document.write(`
                  <!DOCTYPE html>
                  <html lang="ko"><head><meta charset="UTF-8"><title>${mapInfo.name}</title>
                  <style>
                      body { margin: 0; background-color: #111; text-align: center; }
                      img { max-width: 100%; height: auto; cursor: zoom-in; transition: max-width 0.2s ease-in-out; }
                      img.zoomed { max-width: none; cursor: zoom-out; }
                  </style></head>
                  <body><img src="${mapInfo.url}" alt="${mapInfo.name}" onclick="this.classList.toggle('zoomed')"></body>
                  </html>
              `);
              newTab.document.close();
          });
          mapButtonContainer.appendChild(button);
      });

      updateCountrySelect();
      populateCountryFilter();
      updateKingFormCountrySelect();
      populateCitySelectForEdit(); // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
      createSliderTicks();
      const initialTotalMonths = parseInt(combinedSlider.value);
      const { year: initialYear, month: initialMonth } = totalMonthsToYearMonth(initialTotalMonths);
      updateTime(initialYear, initialMonth); // updateTimeìœ¼ë¡œ ì´ˆê¸°í™”
      console.log("ì´ˆê¸°í™” ì™„ë£Œ.");
    }
        // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateCitySelectForEdit() {
        const select = citySelectForEdit;
        select.innerHTML = '<option value="">-- ë„ì‹œ/ì„± ì„ íƒ --</option>'; // ì´ˆê¸°í™”
        // êµ°ëŒ€, ìì—°, ì§€ëª… íƒ€ì…ì´ ì•„ë‹Œ ì„±/ë„ì‹œë§Œ ëª©ë¡ì— ì¶”ê°€
        const filteredCastles = castles.filter(c => !c.is_military_flag && !c.is_natural_feature && !c.is_label)
                                       .sort((a, b) => a.name.localeCompare(b.name, 'ko'));
        filteredCastles.forEach(castle => {
            select.innerHTML += `<option value="${castle._id}">${castle.name} (${getCountryInfoById(castle.country_id)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'})</option>`;
        });
    }

        // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” ëˆˆê¸ˆì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    function createSliderTicks() {
        const ticksContainer = document.createElement('div');
        ticksContainer.style.cssText = "width:100%; margin: 0 auto; display: flex; font-size: 0.8em; color: #ccc; position: relative; top: -50px; z-index: 30;";

        const sliderMin = parseInt(combinedSlider.min);
        const totalSliderMonths = parseInt(combinedSlider.max) - sliderMin;

        for (let year = -2500; year <= 2500; year += 500) {
            const tickMonths = yearMonthToTotalMonths(year, 1);
            const positionPercent = ((tickMonths - sliderMin) / totalSliderMonths) * 100;

            const tick = document.createElement('div');
            tick.style.cssText = `position: absolute; left: ${positionPercent}%; transform: translateX(-50%); text-align: center;`;
            tick.innerHTML = `<span style="border-left: 1px solid #555; padding-left: 4px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${year}</span>`;
            ticksContainer.appendChild(tick);
        }

        // ê¸°ì¡´ sliderTicksë¥¼ ëŒ€ì²´
        const sliderContainer = document.querySelector('.slider-container');
        const existingTicks = sliderContainer.querySelector('div[style*="width:100%"]');
        if (existingTicks) existingTicks.remove();
        sliderContainer.appendChild(ticksContainer);
    }
    // ğŸš© [ì¶”ê°€] êµ­ê°€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—°ëŒ€í‘œë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    // ğŸš© [ìˆ˜ì •] ì£¼ìš” êµ­ê°€ì™€ ë‚˜ë¨¸ì§€ êµ­ê°€ë¥¼ ë¶„ë¦¬í•˜ì—¬ ë Œë”ë§í•˜ë„ë¡ ë¡œì§ ìˆ˜ì •
    function createDynastyTimeline() {
        const timelineContainer = document.getElementById('timeline-container');
        if (!timelineContainer || countries.length === 0) return;
    
        timelineContainer.innerHTML = ''; // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
    
        const validCountries = countries.filter(c => c.start !== null);
        if (validCountries.length === 0) return;
    
        // ìŠ¬ë¼ì´ë”ì˜ min/max ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ê¸°ê°„ ê³„ì‚°
        const sliderMin = parseInt(combinedSlider.min);
        const sliderMax = parseInt(combinedSlider.max);
        const totalSliderMonths = sliderMax - sliderMin;
    
        // ğŸš© [ìˆ˜ì •] is_main_dynasty í”Œë˜ê·¸ê°€ trueì¸ êµ­ê°€ë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
        const mainDynasties = validCountries.filter(c => c.is_main_dynasty).sort((a, b) => a.start - b.start);
        const minorDynasties = validCountries.filter(c => !c.is_main_dynasty).sort((a, b) => a.start - b.start);
    
        const processCountries = (countriesToProcess, isMain, startLane = 0) => {
            const lanes = [];
            let maxLaneIndex = startLane;
    
            countriesToProcess.forEach(country => {
                const startMonths = yearMonthToTotalMonths(country.start, country.start_month || 1);
                const endYear = country.end === null || isNaN(country.end) ? totalMonthsToYearMonth(sliderMax).year : country.end;
                const endMonths = yearMonthToTotalMonths(endYear, country.end_month || 12);
    
                if (isNaN(startMonths) || isNaN(endMonths)) return;
    
                const leftPercent = ((startMonths - sliderMin) / totalSliderMonths) * 100;
                const widthPercent = ((endMonths - startMonths) / totalSliderMonths) * 100;
    
                let laneIndex;
                if (isMain) {
                    // ì£¼ìš” êµ­ê°€ëŠ” ê²¹ì¹˜ì§€ ì•Šê²Œ ë°°ì¹˜
                    laneIndex = lanes.findIndex(laneEndTime => laneEndTime <= startMonths);
                    if (laneIndex === -1) {
                        laneIndex = lanes.length;
                    }
                    lanes[laneIndex] = endMonths;
                } else {
                    // ë‚˜ë¨¸ì§€ êµ­ê°€ëŠ” í•œ ì¤„ì— ëª¨ë‘ ë°°ì¹˜
                    laneIndex = startLane;
                }
    
                const bar = document.createElement('div');
                bar.className = 'timeline-bar';
                bar.classList.add(isMain ? 'main-dynasty' : 'minor-dynasty');
                bar.style.left = `${leftPercent}%`;
                bar.style.width = `${widthPercent}%`;
                bar.style.top = `${laneIndex * 10}px`; // 10px ê°„ê²©ìœ¼ë¡œ ë°°ì¹˜
                bar.style.backgroundColor = country.color || '#7f8c8d';
    
                bar.textContent = country.name;
                const endYearText = country.end ? `${country.end}ë…„` : 'í˜„ì¬';
                bar.title = `${country.name} (${country.start}ë…„ ~ ${endYearText})`;

                // ğŸš© [ì¶”ê°€] í´ë¦­ ì‹œ ì‹œê°„ ì´ë™ì„ ìœ„í•´ ë°ì´í„° ì†ì„± ì¶”ê°€
                bar.dataset.startYear = country.start;
                bar.dataset.startMonth = country.start_month || 1;
    
                timelineContainer.appendChild(bar);
                maxLaneIndex = Math.max(maxLaneIndex, laneIndex);
            });
            return maxLaneIndex + 1; // ë‹¤ìŒ ì‹œì‘ lane ì¸ë±ìŠ¤ ë°˜í™˜
        };
    
        // ì£¼ìš” ì™•ì¡° ë¨¼ì € ì²˜ë¦¬
        const nextLane = processCountries(mainDynasties, true, 0);
        // ë‚˜ë¨¸ì§€ êµ­ê°€ë“¤ì„ ë‹¤ìŒ ì¤„ì— í•œ ì¤„ë¡œ ì²˜ë¦¬
        const finalLaneCount = processCountries(minorDynasties, false, nextLane);
    
        // ì»¨í…Œì´ë„ˆ ë†’ì´ ìë™ ì¡°ì ˆ
        timelineContainer.style.height = `${finalLaneCount * 10}px`;
    }


    // --- 6. UI ì—…ë°ì´íŠ¸ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    // ğŸš© [ìˆ˜ì •] updateUI í•¨ìˆ˜: yearì™€ month ê°’ì„ ì§ì ‘ ì‚¬ìš© (ìŒìˆ˜ ì›” ë°©ì§€)
    function updateUI(year, month) {
      const yearText = (year < 1 ? ' ê¸°ì›ì „ ' : ' ì„œê¸° ') + (year < 1 ? Math.abs(year - 1) : year);
      const monthText = month;
      const ganjiText = getGanji(year, month);
      timeLabelDisplay.innerHTML = `ì—°ë„: ${yearText}ë…„ ${monthText}ì›” ${ganjiText}`;
      updateHistoryPanel(year);
      updateKingLabel(year, month); 
    }


    // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„° ë“œë¡­ë‹¤ìš´ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateCountryFilter() {
        countryFilterSelect.innerHTML = '<option value="all">-- ì „ì²´ êµ­ê°€ --</option>'; // ì´ˆê¸°í™”
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country._id;
            option.textContent = country.name;
            countryFilterSelect.appendChild(option);
        });
    }

    function getCurrentYearMonth() {
        const year = parseInt(yearInput.value);
        const month = parseInt(monthInput.value);
        return { year, month };
    }

    // ğŸš© [ìˆ˜ì •] ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶„ë¦¬ (ì„±ëŠ¥ ìµœì í™”)
    combinedSlider.addEventListener('input', () => {
      const totalMonths = parseInt(combinedSlider.value);
      const { year, month } = totalMonthsToYearMonth(totalMonths);
      updateTime(year, month);
    });
    
    // ğŸš© [ì œê±°] 'input' ì´ë²¤íŠ¸ì—ì„œ ëª¨ë“  ì—…ë°ì´íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë¯€ë¡œ 'change' ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì œê±°í•©ë‹ˆë‹¤.
    // combinedSlider.addEventListener('change', ...);

    // ğŸš© [ì¶”ê°€] ì‚¬ìš©ìê°€ ì—°ë„ ì…ë ¥ì°½ì„ ë¹„ìš°ê³  í¬ì»¤ìŠ¤ë¥¼ ìƒì—ˆì„ ë•Œì˜ ì²˜ë¦¬
    yearInput.addEventListener('input', (e) => {
        const value = e.target.value;
        if (value !== '' && value !== '-') {
            updateTime(parseInt(value) || 0, parseInt(monthInput.value) || 1);
        }
    });

    // ğŸš© [ì¶”ê°€] ì—°ë„ ì…ë ¥ì°½ì˜ ìŠ¤í”¼ë„ˆ ë²„íŠ¼ í´ë¦­ ì‹œ ì›” ìë™ ë³€ê²½
    yearInput.addEventListener('input', (e) => {
        const year = parseInt(e.target.value) || 0;
        const month = parseInt(monthInput.value) || 1;
        // ì‚¬ìš©ìê°€ ì§ì ‘ íƒ€ì´í•‘í•˜ëŠ” ê²½ìš°ëŠ” ì œì™¸í•˜ê³ , ìŠ¤í”¼ë„ˆ ë²„íŠ¼ í´ë¦­ ë“±ìœ¼ë¡œ ê°’ì´ ë³€ê²½ë  ë•Œë§Œ updateTime í˜¸ì¶œ
        if (e.inputType !== 'insertText' && e.inputType !== 'deleteContentBackward') {
            updateTime(year, month);
        }
    });
    // ğŸš© [ìˆ˜ì •] ì›” ì…ë ¥ì°½ ë³€ê²½ ì‹œ ì—°ë„ ìë™ ì¦ê° ê¸°ëŠ¥ ê°œì„ 
    monthInput.addEventListener('input', () => {
        const year = parseInt(yearInput.value) || 0;
        const month = parseInt(monthInput.value) || 1;
        updateTime(year, month);
    });

    function updateTime(year, month) {
        yearInput.value = year;
        monthInput.value = month;

        const totalMonths = yearMonthToTotalMonths(year, month);
        const sliderMin = parseInt(combinedSlider.min);
        const sliderMax = parseInt(combinedSlider.max);
        if (totalMonths >= sliderMin && totalMonths <= sliderMax) {
            combinedSlider.value = totalMonths;
        } 
        
        updateMap(year, month);
        updateUI(year, month);
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì–´ë–¤ ë°©ì‹ìœ¼ë¡œë“  ì‹œê°„ì´ ë³€ê²½ë˜ë©´ í•­ìƒ ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        checkAndDisplayEvent(year, month);
    }

    // ğŸš© [ìˆ˜ì •] ì›” ì…ë ¥ í•„ë“œì—ì„œ í™”ì‚´í‘œ í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì—°ë„ ë³€ê²½ ë¡œì§ ì¶©ëŒ í•´ê²°
    monthInput.addEventListener('keydown', (e) => {
        let keydownYear = parseInt(yearInput.value) || 0;
        const currentMonth = parseInt(monthInput.value) || 1;

        if (e.key === 'ArrowDown' && currentMonth === 1) {
            e.preventDefault(); // ê¸°ë³¸ ë™ì‘(ê°’ì´ 0ì´ ë˜ëŠ” ê²ƒ)ì„ ë§‰ìŒ
            updateTime(keydownYear - 1, 12);
        } else if (e.key === 'ArrowUp' && currentMonth === 12) {
            e.preventDefault(); // ê¸°ë³¸ ë™ì‘(ê°’ì´ 13ì´ ë˜ëŠ” ê²ƒ)ì„ ë§‰ìŒ
            updateTime(keydownYear + 1, 1);
        }
    });
    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¬ìƒ ì œì–´ ë¡œì§: BC/AD ì „í™˜ ë° ì›” í‘œì‹œ ë¬¸ì œ í•´ê²°
    let playInterval = null;
    
 function startPlayback() {
        if (playInterval) return; 

        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline';

        const monthsPerSecond = parseInt(playbackSpeedSlider.value) || 12;
        const intervalDuration = 1000 / monthsPerSecond; 

        playInterval = setInterval(() => {
            let totalMonths = parseInt(combinedSlider.value);
            
            // 1. ì´ ì›”ìˆ˜ë¥¼ 1 ì¦ê°€
            totalMonths++;
            
            // 2. ìŠ¬ë¼ì´ë” ìµœëŒ€ê°’ì„ ì´ˆê³¼í•˜ë©´ ì •ì§€
            if (totalMonths > parseInt(combinedSlider.max)) {
                stopPlayback();
                return;
            }
            
            // 3. ìƒˆë¡œìš´ ì—°/ì›” ê³„ì‚°
            const { year, month } = totalMonthsToYearMonth(totalMonths);
            
            // 4. UI ì—…ë°ì´íŠ¸
            combinedSlider.value = totalMonths;
            
            yearInput.value = year;
            monthInput.value = month;

            // ğŸš© [ìˆ˜ì •] ì¬ìƒ ì¤‘ì—ëŠ” updateTime í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ëª¨ë“  UIì™€ ì§€ë„ë¥¼ ì¼ê´€ì„± ìˆê²Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            updateTime(year, month);
            /*
            updateMap(year, month);
            updateUI(year, month);
            checkAndDisplayEvent(year, month);
            */
        }, intervalDuration); 
    }

    function stopPlayback() {
        clearInterval(playInterval);
        playInterval = null;
        playBtn.style.display = 'inline';
        pauseBtn.style.display = 'none';
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜ ë§¨ ë§ˆì§€ë§‰ì— ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    const originalInitialize = initialize;
    initialize = async () => {
        await originalInitialize();
        
        // ğŸš© [ì¶”ê°€] ì¬ìƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        playBtn.addEventListener('click', startPlayback);
        pauseBtn.addEventListener('click', stopPlayback);
        
        // ì†ë„ ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        playbackSpeedSlider.addEventListener('input', () => {
            speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
            if (playInterval) {
                stopPlayback();
                startPlayback(); // ì¦‰ì‹œ ìƒˆ ì†ë„ë¡œ ë‹¤ì‹œ ì‹œì‘
            }
        });
        
        // ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ ìë™ ì •ì§€
        combinedSlider.addEventListener('mousedown', stopPlayback);
        combinedSlider.addEventListener('touchstart', stopPlayback);
        
        // ì´ˆê¸° ì†ë„ ë””ìŠ¤í”Œë ˆì´ ì„¤ì •
        speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
    };
    
    // --- 7. ì—­ì‚¬ ê¸°ë¡ íŒ¨ë„ ì—…ë°ì´íŠ¸ ---
    function updateHistoryPanel(year) {
      const filteredRecords = history.filter(h => h.year === year);
      
      const historyYearTitle = document.getElementById('historyYearTitle');
      let titleText = `${year <= 0 ? ' ê¸°ì›ì „' : ' ì„œê¸°'} ${Math.abs(year)}ë…„ ì—­ì‚¬ ê¸°ë¡`;
      
      const firstKoreanRecord = filteredRecords.find(r => r.records?.korean?.content);
      if (firstKoreanRecord && firstKoreanRecord.event_name) {
        titleText += ` - ${firstKoreanRecord.event_name}`;
      }
      historyYearTitle.textContent = titleText;

      const koreanContainer = document.getElementById('koreanRecords');
      const foreignContainer = document.getElementById('foreignRecords');
      const trueHistoryContainer = document.getElementById('trueHistoryRecords');

      // ğŸš© [ìˆ˜ì •] í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ë‚´ì˜ ê³µë°±ê³¼ ì¤„ë°”ê¿ˆì„ ì œê±°í•˜ì—¬ ì™¼ìª½ ì •ë ¬ì„ ë§ì¶¥ë‹ˆë‹¤.
      koreanContainer.innerHTML = filteredRecords.filter(r => r.records?.korean?.content).map(r => `<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${r.records.korean.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.korean.source}</span><br>` : ''}${r.records.korean.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';
      foreignContainer.innerHTML = filteredRecords.filter(r => r.records?.foreign?.content).map(r => `<div class="record-item foreign"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${r.records.foreign.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.foreign.source}</span><br>` : ''}${r.records.foreign.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';
      trueHistoryContainer.innerHTML = filteredRecords.filter(r => r.records?.true_history?.content).map(r => `<div class="record-item true_history"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${r.records.true_history.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';

      
      // ğŸš© [ìˆ˜ì •] ê´€ë¦¬ìì´ê³  í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ 'ê¸°ë¡ ì¶”ê°€' ë²„íŠ¼ í‘œì‹œ
      addHistoryBtn.style.display = (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) ? 'inline-block' : 'none'; 
    }


    // --- 8. ì„±/êµ°ëŒ€ í¼ ê´€ë¦¬ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    
    // ğŸš© [ìˆ˜ì •] ê²½ë¡œ ì§€ì  ì¶”ê°€ í•¨ìˆ˜ (í˜„ì¬ ë§ˆì»¤ ìœ„ì¹˜ ìë™ ì…ë ¥)
    window.addPathPoint = function(point = {}) {
        const list = pathDataList;
        
        // í˜„ì¬ ìŠ¬ë¼ì´ë”ì˜ ì—°ë„ì™€ ì›”ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ê°€ì ¸ì˜´
        const defaultYear = yearInput.value;
        const defaultMonth = monthInput.value;
        
        // í¸ì§‘ ë§ˆì»¤ê°€ ìˆëŠ” ê²½ìš° ìœ„ë„/ê²½ë„ë¥¼ ê°€ì ¸ì˜´
        let defaultLat = '';
        let defaultLng = '';
        if (editMarker) {
            const latlng = editMarker.getLatLng();
            defaultLat = latlng.lat.toFixed(6);
            defaultLng = latlng.lng.toFixed(6);
        }

        const row = document.createElement('div');
        row.className = 'path-point-row';
        
        row.innerHTML = `
            <input type="number" class="path-year path-time-input" placeholder="ì—°ë„" value="${point.target_year || defaultYear}" required>
            <input type="number" class="path-month path-time-input" placeholder="ì›”" min="1" max="12" value="${point.target_month || defaultMonth}" required>
            <input type="number" step="any" class="path-lat" placeholder="ìœ„ë„" value="${point.lat || defaultLat}" required>
            <input type="number" step="any" class="path-lng" placeholder="ê²½ë„" value="${point.lng || defaultLng}" required>
            <button type="button" onclick="removePathPoint(this)">X</button>
        `;
        list.appendChild(row);
    }
    
    // ğŸš© [ì¶”ê°€] ê²½ë¡œ ì§€ì  ì œê±° í•¨ìˆ˜ (ë™ì¼)
    window.removePathPoint = function(button) {
        button.closest('.path-point-row').remove();
    }

    // ğŸš© [ì¶”ê°€] í¼ì—ì„œ ê²½ë¡œ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ (ë™ì¼)
    function collectPathData() {
        const pathPoints = document.querySelectorAll('#pathDataList .path-point-row');
        const pathData = [];
        pathPoints.forEach(row => {
            pathData.push({
                target_year: parseInt(row.querySelector('.path-year').value) || null,
                target_month: parseInt(row.querySelector('.path-month').value) || 1,
                lat: parseFloat(row.querySelector('.path-lat').value) || null,
                lng: parseFloat(row.querySelector('.path-lng').value) || null,
            });
        });
        return pathData.filter(p => p.target_year !== null && p.lat !== null && p.lng !== null);
    }
    // í¸ì§‘ ëª¨ë“œ í† ê¸€
    // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± í¸ì§‘ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    if (cityEditBtn) { // cityEditBtnì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        cityEditBtn.addEventListener('click', () => {
            closeAllFormsExcept('editCitySelectionForm');
            editCitySelectionForm.style.display = 'block';
            populateCitySelectForEdit(); // ëª©ë¡ì„ ìµœì‹  ìƒíƒœë¡œ ìœ ì§€
        });
    }
    cancelCitySelectionBtn.addEventListener('click', () => {
        editCitySelectionForm.style.display = 'none';
    });
    editSelectedCityBtn.addEventListener('click', () => {
        const selectedCityId = citySelectForEdit.value;
        if (selectedCityId) { editCitySelectionForm.style.display = 'none'; openCastleForm(selectedCityId); } else { alert('í¸ì§‘í•  ë„ì‹œ/ì„±ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); }
    });

    
    // ì§€ë„ í´ë¦­ ì‹œ ì„± ì¶”ê°€ í¼ ì—´ê¸° (í¸ì§‘ ëª¨ë“œì—ì„œë§Œ)
    map.on('click', (e) => {
      // ğŸš© [ìˆ˜ì •] í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•ŒëŠ” ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ
      if (!editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return;
      
      // ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ëŠ” ì¤‘ì¼ ë•ŒëŠ” í¼ì„ ì—´ì§€ ì•Šê³  ì¢…ë£Œ
      if (isDrawing) return;

      // ğŸš© [ìˆ˜ì •] ì§€ë„ í´ë¦­ ì‹œ ë°”ë¡œ í¼ì„ ì—´ì§€ ì•Šê³ , ìš°í´ë¦­ ë©”ë‰´ë¥¼ í†µí•´ ì—´ë„ë¡ ë³€ê²½ (ì•„ë˜ contextmenu ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì°¸ì¡°)
      // ì´ í•¸ë“¤ëŸ¬ëŠ” ì´ì œ ë¹„ì–´ìˆì–´ë„ ë˜ì§€ë§Œ, í–¥í›„ ë‹¤ë¥¸ í´ë¦­ ê¸°ë°˜ ê¸°ëŠ¥ì„ ìœ„í•´ ë‚¨ê²¨ë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    });

    // ğŸš© [ì¶”ê°€] ì§€ë„ì—ì„œ ìš°í´ë¦­ ì‹œ ì¢Œí‘œ ë³µì‚¬ íŒì—… í‘œì‹œ
    map.on('contextmenu', (e) => {
      const latlng = e.latlng;
      const textToCopy = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
      
      // ğŸš© [ìˆ˜ì •] íŒì—… ì»¨í…ì¸ ë¥¼ flexboxë¡œ ì„¤ì •í•˜ì—¬ ë‚´ë¶€ ìš”ì†Œë“¤ì„ ì„¸ë¡œë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
      const popupContent = document.createElement('div');
      popupContent.style.display = 'flex';
      popupContent.style.flexDirection = 'column';
      popupContent.style.gap = '8px'; // ë²„íŠ¼ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ì˜ ê°„ê²©
      popupContent.innerHTML = `<span>${textToCopy}</span>`;
      
      const copyButton = document.createElement('button');
      copyButton.innerText = 'ì¢Œí‘œ ë³µì‚¬';
      copyButton.className = 'primary'; // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
      copyButton.onclick = () => {
        navigator.clipboard.writeText(textToCopy).then(() => {
          map.closePopup();
        }).catch(err => {
          console.error('ì¢Œí‘œ ë³µì‚¬ ì‹¤íŒ¨:', err);
          alert('ì¢Œí‘œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
      };

      const addCastleButton = document.createElement('button');
      addCastleButton.innerText = 'ì—¬ê¸°ì— ìƒˆ ì˜¤ë¸Œì íŠ¸ ë§Œë“¤ê¸°';
      addCastleButton.className = 'primary';
      addCastleButton.onclick = () => {
      map.closePopup();
      // ğŸš© [ì¶”ê°€] ì„± ì¶”ê°€ í¼ì„ ì—¬ëŠ” ë¡œì§
      editingCastleKey = null;
      closeAllFormsExcept('castleForm');
      document.getElementById('castleForm').style.display = 'block';
      addCastleForm.reset();
      document.getElementById('deleteCastle').style.display = 'none';
      
      document.getElementById('castleLat').value = e.latlng.lat.toFixed(6);
      document.getElementById('castleLng').value = e.latlng.lng.toFixed(6);
      
      const currentYear = yearInput.value;
      const currentMonth = monthInput.value;
      document.getElementById('castleBuilt').value = currentYear;
      document.getElementById('castleBuiltMonth').value = currentMonth;
      
      document.getElementById('pathDataList').innerHTML = ''; // ê²½ë¡œ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      // ğŸš© [ì¶”ê°€] í¼ ì—´ ë•Œ êµ­ê°€ í•„ë“œë¥¼ ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ì„¤ì •
      document.getElementById('castleCountry').value = ''; 

      const defaultCountryName = document.getElementById('castleCountry').value;
      const defaultCountry = getCountryInfoById(defaultCountryName);
      if (defaultCountry) {
        document.getElementById('castleDestroyed').value = defaultCountry.end || '';
        document.getElementById('castleDestroyedMonth').value = defaultCountry.end_month || 12;
      }
      
      if (editMarker) map.removeLayer(editMarker);
      editMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
      editMarker.on('dragend', (event) => {
        const marker = event.target;
        const position = marker.getLatLng();
        document.getElementById('castleLat').value = position.lat.toFixed(6);
        document.getElementById('castleLng').value = position.lng.toFixed(6);
      });
      editMarker.bindPopup('ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •').openPopup();
      
      // ğŸš© ìì—° ì§€ë¬¼/êµ°ëŒ€ í”Œë˜ê·¸ ë¯¸ì²´í¬ ìƒíƒœë¡œ ê´€ë ¨ ì„¹ì…˜ ìˆ¨ê¹€
      pathDataSection.style.display = 'none';
      militaryFlagDetails.style.display = 'none';
      
      naturalFeatureDetails.style.display = 'none';

      // ğŸš© ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° 'ì¼ë°˜'ìœ¼ë¡œ ì´ˆê¸°í™”
      setActiveMarkerType('normal');
      };

      popupContent.appendChild(copyButton);
      // ğŸš© [ì¶”ê°€] í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ 'ì„± ì¶”ê°€' ë²„íŠ¼ì„ íŒì—…ì— í‘œì‹œ
      if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) {
        popupContent.appendChild(addCastleButton);
      }

      L.popup()
        .setLatLng(latlng)
        .setContent(popupContent)
        .openOn(map);
    });

    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    markerTypeSelector.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const type = e.target.dataset.type;
            setActiveMarkerType(type);
        }
    });


    /** ì„± í¸ì§‘ í¼ ì—´ê¸° (ë§ˆì»¤ í´ë¦­ ì‹œ í˜¸ì¶œ) */
    window.openCastleForm = function(id) {
        if (!editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return; 
        const castle = castles.find(c => c._id === id);
        if (!castle) return alert("ì„± ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        const countryInfo = getCountryInfoById(castle.country_id); 

        editingCastleKey = id;
        closeAllFormsExcept('castleForm');
        document.getElementById('castleForm').style.display = 'block';
        document.getElementById('cloneCastle').style.display = 'inline-block'; // ğŸš© [ì¶”ê°€] í¸ì§‘ ì‹œ ë³µì œ ë²„íŠ¼ í‘œì‹œ
        document.getElementById('deleteCastle').style.display = 'inline-block';
        
        document.getElementById('castleName').value = castle.name;
        document.getElementById('castleCountry').value = castle.country_id; // âœ… ID ì„¤ì •
        
        document.getElementById('castleBuilt').value = castle.built_year;
        document.getElementById('castleBuiltMonth').value = castle.built_month || 1;
        document.getElementById('castleDestroyed').value = castle.destroyed;
        document.getElementById('castleDestroyedMonth').value = castle.destroyed_month || 12;
        
        document.getElementById('castleLat').value = castle.lat;
        document.getElementById('castleLng').value = castle.lng;
        document.getElementById('castleDesc').value = castle.desc ?? '';
        document.getElementById('castlePhoto').value = castle.photo ?? '';
        // ğŸš© [ì¶”ê°€] êµ­ê°€ê°€ ìˆì„ ê²½ìš°, ê¸°ë³¸ íŒŒê´´ ì—°ë„ ì„¤ì •ì„ ìœ„í•œ ê°’ ì €ì¥
        if (countryInfo) {
            document.getElementById('castleDestroyed').value = castle.destroyed || countryInfo.end || '';
            document.getElementById('castleDestroyedMonth').value = castle.destroyed_month || countryInfo.end_month || 12;
        } else {
            document.getElementById('castleDestroyed').value = castle.destroyed || '';
            document.getElementById('castleDestroyedMonth').value = castle.destroyed_month || 12;
        }

        // ğŸš© [ìˆ˜ì •] ì²´í¬ë°•ìŠ¤ ëŒ€ì‹  ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
        let currentType = 'normal';
        if (castle.is_natural_feature) {
            currentType = 'natural';
        } else if (castle.is_military_flag) {
            currentType = 'military';
        } else if (castle.is_battle) {
            currentType = 'battle';
        } else if (castle.is_capital) {
            currentType = 'capital';
        } else if (castle.is_label) {
            currentType = 'label';
        }
        setActiveMarkerType(currentType);

        // ğŸš© [ì¶”ê°€] ìì—° ë˜ëŠ” ì§€ëª… íƒ€ì…ì¼ ê²½ìš° êµ­ê°€ í•„ë“œë¥¼ 'ìì—°ì§€ë¬¼'ë¡œ ì„¤ì •
        if (currentType === 'natural' || currentType === 'label') {
            document.getElementById('castleCountry').value = 'ìì—°ì§€ë¬¼';
        }
        if (currentType === 'label') {
            document.getElementById('labelColor').value = castle.label_color || '#FFFFFF';
        }
        // ğŸš© [ìˆ˜ì •] ì§€ëª… íƒ€ì…ì¼ ë•Œ ê±´ì„¤ ì—°ë„ì™€ ì›”ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        if (currentType === 'label') {
            document.getElementById('castleBuilt').value = castle.built_year || yearInput.value;
            document.getElementById('castleBuiltMonth').value = castle.built_month || monthInput.value;
        }

        // ğŸš© ìì—° ì§€ë¬¼ ì²´í¬ë°•ìŠ¤ ë° íƒ€ì… ë¡œë“œ
        const naturalChecked = castle.is_natural_feature || false;
  
        naturalFeatureDetails.style.display = naturalChecked ? 'flex' : 'none'; // flexë¡œ ë³€ê²½
        naturalFeatureType.value = castle.natural_feature_type || 'mountain';
        // ğŸš© END: ìì—° ì§€ë¬¼ ë¡œë“œ

        // ğŸš© ìˆ˜ì •: is_military_flag ëŒ€ì‹  currentType === 'military' ì‚¬ìš©
        const militaryFlagChecked = currentType === 'military';
        militaryFlagDetails.style.display = militaryFlagChecked ? 'block' : 'none';
        
        // ğŸš© ìˆ˜ì •: generalNameInput, troopCountInput, generalPhotoInput ì‚¬ìš©
        generalNameInput.value = castle.general_name || '';
        troopCountInput.value = castle.troop_count || '';
        generalPhotoInput.value = castle.general_photo || ''; // ë§µí•‘ ë³€ìˆ˜ ì‚¬ìš©
        
        // ğŸš© ê²½ë¡œ ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ
        document.getElementById('pathDataList').innerHTML = ''; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
        if (militaryFlagChecked && Array.isArray(castle.path_data)) {
             pathDataSection.style.display = 'block';
             castle.path_data.forEach(point => addPathPoint(point));
        } else {
             pathDataSection.style.display = 'none';
        }

        if (editMarker) map.removeLayer(editMarker);
        editMarker = L.marker([castle.lat, castle.lng], { draggable: true }).addTo(map);
        editMarker.on('dragend', (event) => {
            const marker = event.target;
            const position = marker.getLatLng();
            document.getElementById('castleLat').value = position.lat.toFixed(6);
            document.getElementById('castleLng').value = position.lng.toFixed(6);
        });
        editMarker.bindPopup('ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •').openPopup();

        map.setView([castle.lat, castle.lng], map.getZoom());
    };
    
    // êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ê±´ì„¤/íŒŒê´´ ì—°ë„ ìë™ ì±„ìš°ê¸°
    castleCountrySelect.addEventListener('change', (e) => {
        const selectedCountryId = e.target.value;
        const selectedCountry = getCountryInfoById(selectedCountryId);

        if (selectedCountry) {
            document.getElementById('castleBuilt').value = selectedCountry.start;
            document.getElementById('castleBuiltMonth').value = selectedCountry.start_month || 1;
            document.getElementById('castleDestroyed').value = selectedCountry.end || '';
            document.getElementById('castleDestroyedMonth').value = selectedCountry.end_month || 12;
        } else {
            document.getElementById('castleBuilt').value = yearInput.value;
            document.getElementById('castleDestroyed').value = '';
            document.getElementById('castleDestroyedMonth').value = 12;
        }
    });
    
    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ë²„íŠ¼ ìƒíƒœë¥¼ ì„¤ì •í•˜ê³  ê´€ë ¨ UIë¥¼ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
    function setActiveMarkerType(type) {
        // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
        markerTypeSelector.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
        });
        // ì„ íƒëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
        const activeButton = markerTypeSelector.querySelector(`button[data-type="${type}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }

        // íƒ€ì…ì— ë”°ë¼ ìƒì„¸ ì˜µì…˜ UI í‘œì‹œ/ìˆ¨ê¹€
        militaryFlagDetails.style.display = type === 'military' ? 'block' : 'none';
        pathDataSection.style.display = type === 'military' ? 'block' : 'none';
        naturalFeatureDetails.style.display = type === 'natural' ? 'flex' : 'none';
        
        // ğŸš© [ì¶”ê°€] 'ì§€ëª…' íƒ€ì…ì¼ ë•Œë§Œ ìƒ‰ìƒ ì„ íƒ UIë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        document.getElementById('labelColorRow').style.display = type === 'label' ? 'flex' : 'none';

        // ğŸš© [ì¶”ê°€] ìì—° ì§€ë¬¼ ì„ íƒ ì‹œ êµ­ê°€ í•„ë“œ ì²˜ë¦¬
        const castleCountrySelect = document.getElementById('castleCountry');
        if (type === 'natural' || type === 'label') {
             castleCountrySelect.value = 'ìì—°ì§€ë¬¼'; // 'ìì—°ì§€ë¬¼' ë˜ëŠ” 'ì§€ì—­ëª…'ì¼ ë•Œ êµ­ê°€ ìë™ ì„ íƒ
             document.getElementById('castleBuilt').value = -2333;
             document.getElementById('castleBuiltMonth').value = 1;
        } else {
             // ë‹¤ë¥¸ íƒ€ì…ìœ¼ë¡œ ëŒì•„ì˜¬ ê²½ìš° 'ìì—°ì§€ë¬¼' ì˜µì…˜ì´ ì„ íƒë˜ì§€ ì•Šë„ë¡ 'êµ­ê°€ ì„ íƒ'ìœ¼ë¡œ ëŒë¦¼
             if (castleCountrySelect.value === 'ìì—°ì§€ë¬¼') {
                 castleCountrySelect.value = ''; // 'êµ­ê°€ ì„ íƒ'ìœ¼ë¡œ ë˜ëŒë¦¼
             }
        }
        if (type !== 'military') {
            pathDataList.innerHTML = ''; // êµ°ëŒ€ íƒ€ì…ì´ ì•„ë‹ˆë©´ ê²½ë¡œ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
        }
    }
    

    // ì„± í¼ ì œì¶œ (ì €ì¥/ì—…ë°ì´íŠ¸)
    addCastleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const isUpdate = editingCastleKey !== null;
      const url = isUpdate ? `${API_BASE_URL}/castle/${editingCastleKey}` : `${API_BASE_URL}/castle`;
      const method = isUpdate ? 'PUT' : 'POST';

      // ğŸš© [ìˆ˜ì •] ë§ˆì»¤ íƒ€ì… ì„ íƒê¸°ë¡œë¶€í„° ë°ì´í„° ìƒì„±
      const selectedType = markerTypeSelector.querySelector('button.active')?.dataset.type || 'normal';
// ğŸš© [í•„ìˆ˜ ìˆ˜ì •]: country í•„ë“œë¥¼ ì‚­ì œí•˜ê³  country_idë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
      const selectedCountryId = document.getElementById('castleCountry').value; 


      const data = {
        name: document.getElementById('castleName').value,
        // ğŸš¨ [í•µì‹¬ ìˆ˜ì •]: country_id ì „ì†¡
        country_id: selectedCountryId === 'ìì—°ì§€ë¬¼' ? null : selectedCountryId, // ìì—°ì§€ë¬¼ì€ null ë˜ëŠ” undefined ì²˜ë¦¬
        built_year: parseInt(document.getElementById('castleBuilt').value) || null,
        built_month: parseInt(document.getElementById('castleBuiltMonth').value) || 1,
        destroyed: document.getElementById('castleDestroyed').value ? parseInt(document.getElementById('castleDestroyed').value) : null,
        destroyed_month: parseInt(document.getElementById('castleDestroyedMonth').value) || 12,
        lat: parseFloat(document.getElementById('castleLat').value),
        lng: parseFloat(document.getElementById('castleLng').value),
        photo: document.getElementById('castlePhoto').value || null,
        desc: document.getElementById('castleDesc').value,
        // ğŸš© [ìˆ˜ì •] ì„ íƒëœ íƒ€ì…ì— ë”°ë¼ boolean ê°’ ì„¤ì •
        is_capital: selectedType === 'capital',
        is_battle: selectedType === 'battle',
        is_military_flag: selectedType === 'military',
        is_natural_feature: selectedType === 'natural',
        is_label: selectedType === 'label', // ğŸš© [ì¶”ê°€]
        label_color: selectedType === 'label' ? document.getElementById('labelColor').value : null, // ğŸš© [ì¶”ê°€]
        natural_feature_type: selectedType === 'natural' ? document.getElementById('naturalFeatureType').value : null,
      };

      if (data.is_military_flag) {
        // ğŸš© ìˆ˜ì •: generalNameInput, troopCountInput, generalPhotoInput ì‚¬ìš©
        data.general_name = generalNameInput.value;
        data.troop_count = parseInt(troopCountInput.value) || 0;
        data.general_photo = generalPhotoInput.value || null; // ë§µí•‘ ë³€ìˆ˜ ì‚¬ìš©
        
        // ğŸš© ê²½ë¡œ ë°ì´í„° ì¶”ê°€
        data.path_data = collectPathData();
      } else {
        data.path_data = [];
      }
      
      if (!data.name || data.lat === undefined || data.lng === undefined || data.built_year === null) {
          return alert("ì„± ì´ë¦„, ê±´ì„¤ì—°ë„, ìœ„ë„, ê²½ë„ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
      }
      // ğŸš© [ìˆ˜ì •] ë§ˆì»¤ íƒ€ì…ì´ 'natural', 'battle', ë˜ëŠ” 'label'ì´ ì•„ë‹ ê²½ìš°ì—ë§Œ êµ­ê°€ í•„ë“œë¥¼ ê²€ì‚¬í•©ë‹ˆë‹¤.
      // ğŸš© [ìˆ˜ì •] !data.countryë¥¼ !data.country_idë¡œ ë³€ê²½í•˜ì—¬ ì˜¬ë°”ë¥¸ í•„ë“œë¥¼ ê²€ì‚¬í•©ë‹ˆë‹¤.
      if (selectedType !== 'natural' && selectedType !== 'battle' && selectedType !== 'label' && !data.country_id) {
          return alert("êµ­ê°€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”."); 
      }
      if (data.is_military_flag && data.path_data.length < 2) {
          alert("ê²½ë¡œ ì§€ì  2ê°œ ë¯¸ë§Œìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ì§€ë„ì—ì„œ êµ°ëŒ€ëŠ” ì´ë™í•˜ì§€ ì•Šê³  ì •ì  ìœ„ì¹˜ì— í‘œì‹œë©ë‹ˆë‹¤.");
      }

      try {
          const response = await fetch(url, {
              method: method,
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(data)
          });

          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }

          document.getElementById('castleForm').style.display = 'none';
          initialize();
      } catch (error) {
        console.error("Castle ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
        alert(`Castle ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
      }
    });

    // ì„± í¼ ì·¨ì†Œ
    cancelCastle.addEventListener('click', () => {
      document.getElementById('castleForm').style.display = 'none';
      if (editMarker) {
        map.removeLayer(editMarker);
        editMarker = null;
      }
    });

    // ì„± ì‚­ì œ
    deleteCastle.addEventListener('click', async () => {
        if (!editingCastleKey) return;

        if (!confirm('ì •ë§ë¡œ ì´ ì„±/ì „ì¥ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/castle/${editingCastleKey}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}` // ğŸš© [ìˆ˜ì •] ì‚­ì œ ìš”ì²­ì—ë„ í† í° ì¶”ê°€
                }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            document.getElementById('castleForm').style.display = 'none';
            initialize();
        } catch (error) {
            console.error("Castle ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Castle ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    // ğŸš© [ì¶”ê°€] ì„±/ì§€ë¬¼ ë³µì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('cloneCastle').addEventListener('click', () => {
        if (!editingCastleKey) return;

        const originalCastleName = document.getElementById('castleName').value;
        const previousDestroyedYear = document.getElementById('castleDestroyed').value;
        const previousDestroyedMonth = document.getElementById('castleDestroyedMonth').value;

        // ë³µì œ ëª¨ë“œë¡œ ì „í™˜
        editingCastleKey = null; // ìƒˆ í•­ëª©ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•´ í‚¤ë¥¼ nullë¡œ ì„¤ì •

        // UI ì—…ë°ì´íŠ¸
        document.querySelector('#castleForm h3').textContent = `'${originalCastleName}' ë³µì œí•˜ì—¬ ì •ë³´ ì¶”ê°€`;
        document.getElementById('deleteCastle').style.display = 'none';
        document.getElementById('cloneCastle').style.display = 'none';
        document.querySelector('#addCastleForm button[type="submit"]').textContent = 'ì¶”ê°€';

        // êµ­ê°€ì™€ ê¸°ê°„ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('castleCountry').value = ''; // êµ­ê°€ ì„ íƒ ì´ˆê¸°í™”
        document.getElementById('castleBuilt').value = previousDestroyedYear; // ì´ì „ íŒŒê´´ì—°ë„ë¥¼ ìƒˆ ê±´ì„¤ì—°ë„ë¡œ
        document.getElementById('castleBuiltMonth').value = previousDestroyedMonth;
        document.getElementById('castleDestroyed').value = ''; // íŒŒê´´ì—°ë„ ë¹„ìš°ê¸°

        alert(`'${originalCastleName}'ì˜ ë³µì œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ êµ­ê°€ì™€ ê¸°ê°„ì„ ì„¤ì •í•œ í›„ 'ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
    });

    /** êµ­ê°€ ëª©ë¡ì„ ì„±/ìœ„ì¹˜ í¼ì˜ <select>ì— ì—…ë°ì´íŠ¸ */
    function updateCountrySelect() {
      const select = document.getElementById('castleCountry');
      // ğŸš© [ìˆ˜ì •] ê¸°ë³¸ ì˜µì…˜ì„ ì¶”ê°€í•˜ê³  ê·¸ ë’¤ì— êµ­ê°€ ëª©ë¡ì„ ë¶™ì…ë‹ˆë‹¤.
      select.innerHTML = '<option value="">-- êµ­ê°€ ì„ íƒ --</option>' + 
                        countries.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
      
      // ğŸš© [ì¶”ê°€]: ìì—° ì§€ë¬¼ ë“± êµ­ê°€ê°€ ì—†ëŠ” ë§ˆì»¤ë¥¼ ìœ„í•œ ì˜µì…˜ ì¶”ê°€
     select.innerHTML += '<option value="ìì—°">--- ìì—° (êµ­ê°€ ë¬´ê´€) ---</option>';
    }

    // ì§€ë„ ê²€ìƒ‰ ê¸°ëŠ¥ (ì´ë™ë§Œ)
    searchBtn.addEventListener('click', async () => {
    const query = searchInput.value.trim().toLowerCase();
    if (!query) return;

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê²€ìƒ‰ ë¡œì§ ë³€ê²½: ì§€ì—­ëª…ê³¼ ì—­ì‚¬ ê¸°ë¡ì„ ëª¨ë‘ ê²€ìƒ‰
    if (query !== lastSearchQuery) {
        // ìƒˆë¡œìš´ ê²€ìƒ‰ì–´ì¼ ê²½ìš°
        // ğŸš© [ìˆ˜ì •] ëª¨ë“  ê°ì²´(ì„±, êµ°ëŒ€, ìì—°ì§€ë¬¼ ë“±)ì˜ ì´ë¦„ê³¼ ì¥ìˆ˜ ì´ë¦„ê¹Œì§€ ê²€ìƒ‰í•˜ë„ë¡ í•„í„°ë§ ì¡°ê±´ í™•ì¥
        const matchingCastles = castles
            .filter(c => 
                (c.name && c.name.toLowerCase().includes(query)) ||
                (c.general_name && c.general_name.toLowerCase().includes(query))
            )
            .map(c => ({ type: 'castle', data: c, year: c.built_year || c.built || 0 }));

        const matchingHistory = history
            .filter(h =>
                (h.event_name && h.event_name.toLowerCase().includes(query)) ||
                (h.records?.korean?.content && h.records.korean.content.toLowerCase().includes(query)) ||
                (h.records?.foreign?.content && h.records.foreign.content.toLowerCase().includes(query)) ||
                (h.records?.true_history?.content && h.records.true_history.content.toLowerCase().includes(query))
            )
            .map(h => ({ type: 'history', data: h, year: h.year }));

        // ğŸš© [ì¶”ê°€] ê·¸ë ¤ì§„ ì§€í˜•/ì§€ë¬¼(ê°•, ì„±ê³½ ë“±)ì˜ ì´ë¦„ë„ ê²€ìƒ‰ ëŒ€ìƒì— í¬í•¨
        const matchingDrawings = drawings
            .filter(d => d.name && d.name.toLowerCase().includes(query))
            .map(d => ({ type: 'drawing', data: d, year: d.start_year || 0 }));

        const combinedResults = [...matchingCastles, ...matchingHistory, ...matchingDrawings];

        if (combinedResults.length === 0) {
            alert(`"${query}"ì— í•´ë‹¹í•˜ëŠ” ì§€ì—­, ì¸ë¬¼, ì§€í˜• ë˜ëŠ” ì—­ì‚¬ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            lastSearchQuery = '';
            lastSearchResults = [];
            lastSearchIndex = -1;
            return;
        }

        // ê²°ê³¼ë¥¼ ì—°ë„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì €ì¥
        lastSearchResults = combinedResults.sort((a, b) => a.year - b.year);
        lastSearchQuery = query;
        lastSearchIndex = 0;
    } else {
        // ë™ì¼í•œ ê²€ìƒ‰ì–´ì¼ ê²½ìš°, ë‹¤ìŒ ê²°ê³¼ë¡œ ì¸ë±ìŠ¤ ì´ë™
        if (lastSearchResults.length === 0) return; // ì´ì „ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
        lastSearchIndex = (lastSearchIndex + 1) % lastSearchResults.length;
    }

    // í˜„ì¬ ì¸ë±ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ê²°ê³¼ë¡œ ì§€ë„ ë° ì‹œê°„ ì—…ë°ì´íŠ¸
    const currentResult = lastSearchResults[lastSearchIndex];
    
    if (currentResult.type === 'castle') {
        const castle = currentResult.data;
        const year = castle.built_year || castle.built;
        const month = castle.built_month || 1;
        if (year) updateTime(year, month);
        map.flyTo([castle.lat, castle.lng], 10);
    } else if (currentResult.type === 'history') {
        const historyItem = currentResult.data;
        const year = historyItem.year;
        const month = historyItem.month || 1;
        if (year) updateTime(year, month);
        // ì—­ì‚¬ ê¸°ë¡ì€ íŠ¹ì • ì¢Œí‘œê°€ ì—†ìœ¼ë¯€ë¡œ ì§€ë„ ì´ë™ì€ í•˜ì§€ ì•ŠìŒ
    } else if (currentResult.type === 'drawing') {
        const drawing = currentResult.data;
        const year = drawing.start_year;
        if (year) updateTime(year, 1); // ì›”ì€ 1ì›”ë¡œ ê³ ì •

        // GeoJSON ë°ì´í„°ì˜ ì¤‘ì‹¬ì ì„ ê³„ì‚°í•˜ì—¬ ì´ë™
        const tempLayer = L.geoJSON(drawing.geojson);
        const bounds = tempLayer.getBounds();
        if (bounds.isValid()) {
            map.flyTo(bounds.getCenter(), 8);
        }
    }
    });
    
    // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ì°½ì—ì„œ ì—”í„° í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // í¼ ì œì¶œ ë“± ê¸°ë³¸ ë™ì‘ ë°©ì§€
            searchBtn.click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
        }
    });

    // --- 9. êµ­ê°€ í¸ì§‘ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    
    countryEditBtn.addEventListener('click', () => {
        closeAllFormsExcept('countryForm');
        document.getElementById('countryForm').style.display = 'block';
        updateCountrySelectForEdit();
        document.getElementById('editCountryForm').reset();
        document.getElementById('countryOriginalName').value = '';
        document.getElementById('deleteCountryBtn').style.display = 'none';
        document.getElementById('saveCountryBtn').textContent = 'ì €ì¥/ì¶”ê°€';
        document.getElementById('countryColor').value = '#ffffff'; // ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ì„¤ì •

    });

    function updateCountrySelectForEdit() {
        const select = countrySelectForEdit;
        select.innerHTML = '<option value="">--- ê¸°ì¡´ êµ­ê°€ ì„ íƒ ---</option>' + 
                          countries.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    }

    countrySelectForEdit.addEventListener('change', () => {
        const name = countrySelectForEdit.value;
        if (!name) {
            document.getElementById('editCountryForm').reset();
            document.getElementById('countryOriginalName').value = '';
            document.getElementById('deleteCountryBtn').style.display = 'none';
            document.getElementById('saveCountryBtn').textContent = 'ì €ì¥';
            return;
        }
        
        const country = getCountryInfo(name);
        if (!country) return;

        document.getElementById('countryOriginalName').value = country.name;
        document.getElementById('countryName').value = country.name;
        document.getElementById('countryStart').value = country.start;
        document.getElementById('countryStartMonth').value = country.start_month || 1;
        document.getElementById('countryEnd').value = country.end;
        document.getElementById('countryEndMonth').value = country.end_month || 12;
        document.getElementById('countryColor').value = country.color || '#ffffff'; // ğŸš© [ìˆ˜ì •] country.colorê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’(#ffffff)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        document.getElementById('countryFlag').value = country.flag || '';
        document.getElementById('countryEthnicity').value = country.ethnicity || '';
        document.getElementById('isMainDynasty').checked = country.is_main_dynasty || false;

        document.getElementById('deleteCountryBtn').style.display = 'inline-block';
        document.getElementById('saveCountryBtn').textContent = 'ì €ì¥';
    });
    
    document.getElementById('editCountryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const originalName = document.getElementById('countryOriginalName').value;
        const newName = document.getElementById('countryName').value;
        const isUpdate = !!originalName;
        
        const data = {
            name: newName,
            start: parseInt(document.getElementById('countryStart').value),
            start_month: parseInt(document.getElementById('countryStartMonth').value) || 1,
            end: document.getElementById('countryEnd').value ? parseInt(document.getElementById('countryEnd').value) : null,
            end_month: parseInt(document.getElementById('countryEndMonth').value) || 12,
            color: document.getElementById('countryColor').value,
            flag: document.getElementById('countryFlag').value || null,
            ethnicity: document.getElementById('countryEthnicity').value || null,
            is_main_dynasty: document.getElementById('isMainDynasty').checked
        };
        
        if (!data.name || isNaN(data.start) || !data.color) {
            return alert("êµ­ê°€ ì´ë¦„, ì‹œì‘ ì—°ë„, ìƒ‰ìƒì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        try {
            let url = `${API_BASE_URL}/countries`;
            let method = 'POST';

            if (isUpdate) {
                url = `${API_BASE_URL}/countries/${encodeURIComponent(originalName)}`; 
                method = 'PUT';
            }
            
            const response = await fetch(url, {
                method: method,
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // ğŸš© [ìˆ˜ì •] ì¸ì¦ í† í° ì¶”ê°€
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            document.getElementById('countryForm').style.display = 'none';
            initialize(); 
        } catch (error) {
            console.error("Country ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Country ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    document.getElementById('deleteCountryBtn').addEventListener('click', async () => {
        const originalName = document.getElementById('countryOriginalName').value;
        if (!originalName || !confirm('ì •ë§ë¡œ ì´ êµ­ê°€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ë‹¹ êµ­ê°€ì˜ ëª¨ë“  ì„±/ì „ì¥ ì •ë³´ëŠ” ìœ ì§€ë˜ì§€ë§Œ êµ­ê°€ ì •ë³´ê°€ ì—†ì–´ì§‘ë‹ˆë‹¤.')) return;
        try {
            const response = await fetch(`${API_BASE_URL}/countries/${originalName}`, { 
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            document.getElementById('countryForm').style.display = 'none';
            initialize();
        } catch (error) {
            console.error("Country ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Country ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    document.getElementById('cancelCountryBtn').addEventListener('click', () => {
        document.getElementById('countryForm').style.display = 'none';
    });

    // --- 10. ì´ë²¤íŠ¸ í¸ì§‘ í¼ ê´€ë¦¬ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    eventEditBtn.addEventListener('click', () => { // ì´ ë²„íŠ¼ ìì²´ê°€ ê´€ë¦¬ìì—ê²Œë§Œ ë³´ì´ë¯€ë¡œ ë‚´ë¶€ ê¶Œí•œ ì²´í¬ëŠ” ë¶ˆí•„ìš”
        closeAllFormsExcept('eventForm');
        document.getElementById('eventForm').style.display = 'block';
        document.getElementById('editEventForm').reset();
        document.getElementById('eventMongoId').value = '';
        document.getElementById('deleteEventBtn').style.display = 'none';
        document.getElementById('saveEventBtn').textContent = 'ì €ì¥/ì¶”ê°€';
        populateEventSelect();
    });

    function populateEventSelect() {
        const select = document.getElementById('eventSelect');
        // ğŸš© [ìˆ˜ì •] ì—°ë„ ìˆœìœ¼ë¡œ ì •ë ¬
        events.sort((a, b) => a.year - b.year || a.month - b.month);
        select.innerHTML = '<option value="">--- ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ---</option>' +
            events.map(event => `<option value="${event._id}">${event.year}ë…„: ${event.text}</option>`).join('');
    }

    document.getElementById('eventSelect').addEventListener('change', (e) => {
        const eventId = e.target.value;
        const form = document.getElementById('editEventForm');
        const deleteBtn = document.getElementById('deleteEventBtn');
        const saveBtn = document.getElementById('saveEventBtn');

        if (!eventId) {
            form.reset();
            document.getElementById('eventMongoId').value = '';
            deleteBtn.style.display = 'none';
            saveBtn.textContent = 'ì €ì¥/ì¶”ê°€';
            return;
        }

        const event = events.find(ev => ev._id === eventId);
        if (event) {
            document.getElementById('eventMongoId').value = event._id;
            document.getElementById('eventYear').value = event.year;
            document.getElementById('eventMonth').value = event.month || 1;
            document.getElementById('eventText').value = event.text;
            document.getElementById('eventPhoto').value = event.photo || ''; // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL í•„ë“œ ì±„ìš°ê¸°
            deleteBtn.style.display = 'inline-block';
            saveBtn.textContent = 'ì €ì¥';
        }
    });

    document.getElementById('editEventForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const eventId = document.getElementById('eventMongoId').value;
        const isUpdate = !!eventId;
        const url = isUpdate ? `${API_BASE_URL}/events/${eventId}` : `${API_BASE_URL}/events`;
        const method = isUpdate ? 'PUT' : 'POST';

        const data = {
            year: parseInt(document.getElementById('eventYear').value),
            month: parseInt(document.getElementById('eventMonth').value) || 1,
            text: document.getElementById('eventText').value,
            photo: document.getElementById('eventPhoto').value || null, // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL ë°ì´í„° ìˆ˜ì§‘
        };

        if (isNaN(data.year) || !data.text) {
            return alert("ì—°ë„ì™€ ì´ë²¤íŠ¸ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        }

        try {
            const response = await fetch(url, { 
                method: method, 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                body: JSON.stringify(data) 
            });
            if (!response.ok) throw new Error('ì´ë²¤íŠ¸ ì €ì¥ ì‹¤íŒ¨');
            document.getElementById('eventForm').style.display = 'none';
            initialize();
        } catch (error) { alert(error.message); }
    });

    document.getElementById('deleteEventBtn').addEventListener('click', async () => {
        const eventId = document.getElementById('eventMongoId').value;
        if (!eventId || !confirm('ì´ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try { 
            const response = await fetch(`${API_BASE_URL}/events/${eventId}`, { 
                method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } 
            });
            if (!response.ok) throw new Error('ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨');
            document.getElementById('eventForm').style.display = 'none';
            initialize();
        } catch (error) { alert(error.message); }
    });

    document.getElementById('cancelEventBtn').addEventListener('click', () => { document.getElementById('eventForm').style.display = 'none'; });

    // --- 10. ì™• í¸ì§‘ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)

    kingEditBtn.addEventListener('click', () => { // ì´ ë²„íŠ¼ ìì²´ê°€ ê´€ë¦¬ìì—ê²Œë§Œ ë³´ì´ë¯€ë¡œ ë‚´ë¶€ ê¶Œí•œ ì²´í¬ëŠ” ë¶ˆí•„ìš”
        closeAllFormsExcept('kingForm');
        document.getElementById('kingForm').style.display = 'block';
        document.getElementById('editKingForm').reset();
        document.getElementById('kingOriginalKey').value = '';
        document.getElementById('kingOriginalIndex').value = '';
        document.getElementById('deleteKingBtn').style.display = 'none';
        document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
        
        loadKingsForCountry(true); 
    });

    function updateKingFormCountrySelect() {
        const select = kingCountrySelectForForm;
        // ğŸš© ìˆ˜ì •: option valueì— êµ­ê°€ ì´ë¦„ ëŒ€ì‹  êµ­ê°€ì˜ _idë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
        select.innerHTML = countries.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
        loadKingsForCountry(); 
    } 
    
    kingCountrySelectForForm.addEventListener('change', loadKingsForCountry);
    function loadKingsForCountry(resetForm = false) {
        // ğŸš© ìˆ˜ì •: ì„ íƒëœ valueëŠ” ì´ì œ countryIdì…ë‹ˆë‹¤.
        const countryId = kingCountrySelectForForm.value;
        const kingKey = countryId; // ì´ì œ keyëŠ” countryIdê°€ ë©ë‹ˆë‹¤.
        const kingList = kings[kingKey] || [];
        
        const select = kingSelect;
        select.innerHTML = '<option value="">--- ìƒˆ ì™• ì¶”ê°€ ---</option>' + 
                          kingList.map((k, index) => {
                              const startMonth = k.start_month || 1;
                              const endMonth = k.end_month || 1;
                              const endYearText = k.end === null ? 'í˜„ì¬' : `${k.end}ë…„ ${endMonth}ì›”`;
                              
                              return `<option value="${index}" 
                                        data-start="${k.start}" 
                                        data-end="${k.end}"
                                        data-start-month="${startMonth}"
                                        data-end-month="${endMonth}"
                                        data-id="${k._id ? k._id.toString() : ''}"
                                >${k.name} (${k.start}ë…„ ${startMonth}ì›” ~ ${endYearText})</option>`;
                          }).join('');
        if (resetForm) {
            document.getElementById('kingName').value = '';
            document.getElementById('kingStart').value = '';
            document.getElementById('kingStartMonth').value = 1;
            document.getElementById('kingEnd').value = '';
            document.getElementById('kingEndMonth').value = 12;
            document.getElementById('kingOriginalKey').value = '';
            document.getElementById('kingOriginalIndex').value = '';
            document.getElementById('deleteKingBtn').style.display = 'none';
            document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
        }
    }

kingSelect.addEventListener('change', () => {
    const index = kingSelect.value;
    // ğŸš© ìˆ˜ì •: kingKeyë¥¼ countryIdë¡œ ì‚¬ìš© (ì´ì „ kingKey ë¡œì§ì„ ì œê±°)
    const countryId = kingCountrySelectForForm.value;
    const kingList = kings[countryId] || []; // â¬…ï¸ ì˜¬ë°”ë¥¸ ì¡°íšŒ
    const kingMongoIdField = document.getElementById('kingMongoId'); 
        
        if (index === "") {
            document.getElementById('editKingForm').reset();
            document.getElementById('kingName').value = '';
            document.getElementById('kingStartMonth').value = 1;
            document.getElementById('kingEndMonth').value = 1;
            document.getElementById('kingOriginalKey').value = '';
            document.getElementById('kingOriginalIndex').value = '';
            document.getElementById('deleteKingBtn').style.display = 'none';
            document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
            kingMongoIdField.value = ''; 

            return;
        }

        const king = kingList[parseInt(index)];
        if (!king) return;
        kingMongoIdField.value = king._id ? king._id.toString() : ''; 
        
        
        document.getElementById('kingName').value = king.name;
        document.getElementById('kingStart').value = king.start;
        document.getElementById('kingStartMonth').value = king.start_month || 1;
        document.getElementById('kingEnd').value = king.end || '';
        document.getElementById('kingEndMonth').value = king.end_month || 12;
        document.getElementById('kingOriginalKey').value = countryId;
        document.getElementById('kingOriginalIndex').value = index;
        document.getElementById('deleteKingBtn').style.display = 'inline-block';
        document.getElementById('saveKingBtn').textContent = 'ì €ì¥';
    });



    // ì™• í¼ ì œì¶œ (ì¶”ê°€/ìˆ˜ì •)
    document.getElementById('editKingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const kingMongoId = document.getElementById('kingMongoId').value; 
        const isUpdate = kingMongoId !== '';
        
        // ğŸš© ìˆ˜ì •: countryName ëŒ€ì‹  countryIdë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const countryId = document.getElementById('kingCountryName').value;

        const newKingData = {
            countryId: countryId, // ğŸš¨ countryIdë¥¼ ì „ì†¡
            name: document.getElementById('kingName').value,
            start: parseInt(document.getElementById('kingStart').value),
            start_month: parseInt(document.getElementById('kingStartMonth').value) || 1,
            end: parseInt(document.getElementById('kingEnd').value) || null,
            end_month: parseInt(document.getElementById('kingEndMonth').value) || 12,
        };
        
        if (!newKingData.name || isNaN(newKingData.start)) {
            return alert("ì™• ì´ë¦„ê³¼ ì‹œì‘ ì—°ë„ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        let method = isUpdate ? 'PUT' : 'POST';
        let url = isUpdate ? `${API_BASE_URL}/kings/${kingMongoId}` : `${API_BASE_URL}/kings`; 

        try {
            const response = await fetch(url, {
                method: method, 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(newKingData)
            });

            if (!response.ok) {
                const errorData = await response.json(); 
                throw new Error(`${response.status}: ${errorData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
            
            if (!isUpdate) { // ì¶”ê°€(POST) ì„±ê³µ ì‹œì—ë§Œ ì—°ì† ì¶”ê°€ ëª¨ë“œ ì‘ë™
                
                // 1. ë°ì´í„°ë² ì´ìŠ¤ ê°±ì‹  ë° UI ì—…ë°ì´íŠ¸
                await initialize();
                
                // 2. êµ­ê°€ëª…ê³¼ êµ­ê°€ IDëŠ” ìœ ì§€
                document.getElementById('kingCountryName').value = countryId; 
                
                // 3. í¼ í•„ë“œ ë¦¬ì…‹
                document.getElementById('editKingForm').reset();
                
                // 4. ë¦¬ì…‹ í›„, ì´ˆê¸°ê°’ê³¼ ë²„íŠ¼ ìƒíƒœ ì¬ì„¤ì •
                document.getElementById('kingSelect').value = ''; // 'ìƒˆ ì™• ì¶”ê°€' ì„ íƒ
                document.getElementById('kingStartMonth').value = 1;
                document.getElementById('kingEndMonth').value = 12;
                document.getElementById('deleteKingBtn').style.display = 'none';
                document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
                document.getElementById('kingMongoId').value = '';
                
                // 5. í˜„ì¬ êµ­ê°€ì˜ ì™• ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
                loadKingsForCountry(false); // ë¦¬ì…‹í•˜ì§€ ì•ŠìŒ (í¼ì€ ì´ë¯¸ ë¦¬ì…‹ë¨)

            //    alert("ì™• ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ê°™ì€ êµ­ê°€ì— ì—°ì† ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

            } else { // ìˆ˜ì •(PUT) ì„±ê³µ ì‹œ í¼ ë‹«ê³  ì´ˆê¸°í™”
                alert("ì™• ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('kingForm').style.display = 'none';
                initialize();
            }

        } catch (error) {
            console.error("King ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`King ì •ë³´ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    // ì™• í¼ ì‚­ì œ (DELETE ìš”ì²­)
    document.getElementById('deleteKingBtn').addEventListener('click', async () => {
        const kingMongoId = document.getElementById('kingMongoId').value; 
        
        if (!kingMongoId || !confirm('ì •ë§ë¡œ ì´ ì™•ì˜ ì¬ìœ„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/kings/${kingMongoId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`${response.status}: ${errorData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }

            document.getElementById('kingForm').style.display = 'none';
            initialize(); 
        } catch (error) {
            console.error("King ì •ë³´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`King ì •ë³´ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    });


    // ğŸ‘‘ ì™• í¸ì§‘ ëª¨ë“œì—ì„œ í˜¸ì¶œ: URL IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì™• ì •ë³´ í¼ì— ì±„ìš°ê¸°
    window.editKing = (kingsId) => {
        document.getElementById('kingMongoId').value = kingsId; 
        document.getElementById('deleteKingBtn').style.display = 'inline';
        document.getElementById('saveKingBtn').textContent = 'ì €ì¥';


    if (!kingsId) return alert('í¸ì§‘í•  ì™•ì˜ IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');

    let targetKing = null;
    let countryId = null; 

    outer: for (const key in kings) {
        if (kings.hasOwnProperty(key)) {
            const index = kings[key].findIndex(k => k._id && k._id.toString() === kingsId);
            if (index !== -1) {
                targetKing = kings[key][index];
                countryId = key; // ğŸš© keyëŠ” ì´ì œ countryIdì…ë‹ˆë‹¤.
                break outer;
            }
        }
    }

    if (!targetKing) {
        console.error("IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", kingsId);
        return alert('í•´ë‹¹ IDë¥¼ ê°€ì§„ ì™• ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„° ë¶ˆì¼ì¹˜)');
    }
    // ğŸš¨ [í•µì‹¬ ìˆ˜ì •] countryIdë¥¼ <select>ì— ì„¤ì •í•˜ì—¬ loadKingsForCountryê°€ ì‘ë™í•˜ë„ë¡ í•¨
    document.getElementById('kingCountryName').value = countryId;  
        // ğŸš© [ì¶”ê°€] êµ­ê°€ë¥¼ ì„ íƒí–ˆìœ¼ë¯€ë¡œ, í•´ë‹¹ êµ­ê°€ì˜ ì™• ëª©ë¡ì„ ë¡œë“œí•˜ì—¬ <select>ì— ì±„ì›ë‹ˆë‹¤.
    loadKingsForCountry(false); // falseë¡œ ì„¤ì •í•˜ì—¬ í˜„ì¬ í¼ ê°’(countryId)ì„ ìœ ì§€

    // ğŸš© [ì¶”ê°€] ë¡œë“œëœ ëª©ë¡ì—ì„œ í˜„ì¬ ì™•ì„ ì°¾ì•„ì„œ kingSelectë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    const kingList = kings[countryId];
    const targetIndex = kingList.findIndex(k => k._id && k._id.toString() === kingsId);
    document.getElementById('kingSelect').value = targetIndex.toString(); // <select> ê°’ì„ í•´ë‹¹ indexë¡œ ë³€ê²½

        
        document.getElementById('kingName').value = targetKing.name || '';
        document.getElementById('kingStart').value = targetKing.start || '';
        document.getElementById('kingStartMonth').value = targetKing.start_month || 1;
        document.getElementById('kingEnd').value = targetKing.end || '';
        document.getElementById('kingEndMonth').value = targetKing.end_month || 12;
        
        document.getElementById('kingForm').style.display = 'block';
    }; 

    document.getElementById('cancelKingBtn').addEventListener('click', () => {
        document.getElementById('kingForm').style.display = 'none';
    }); 
    
    document.getElementById('editDrawingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const drawingId = document.getElementById('drawingMongoId').value;
        const isUpdate = !!drawingId;
        const url = isUpdate ? `${API_BASE_URL}/drawings/${drawingId}` : `${API_BASE_URL}/drawings`;
        const method = isUpdate ? 'PUT' : 'POST';

        const data = {
            name: document.getElementById('drawingName').value,
            type: document.getElementById('drawingType').value,
            start_year: parseInt(document.getElementById('drawingStartYear').value),
            end_year: document.getElementById('drawingEndYear').value ? parseInt(document.getElementById('drawingEndYear').value) : null,
            geojson: JSON.parse(document.getElementById('drawingGeoJson').value)
        };

        if (!data.name || isNaN(data.start_year)) {
            return alert("ì´ë¦„ê³¼ ì‹œì‘ ì—°ë„ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        }

        try {
            const response = await fetch(url, { 
                method, 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                body: JSON.stringify(data) 
            });
            if (!response.ok) throw new Error('ê·¸ë¦¬ê¸° ì •ë³´ ì €ì¥ ì‹¤íŒ¨');
            document.getElementById('drawingForm').style.display = 'none';
            initialize();
        } catch (error) { alert(error.message); }
    });

    document.getElementById('cancelDrawingBtn').addEventListener('click', () => { document.getElementById('drawingForm').style.display = 'none'; });

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê·¸ë¦¬ê¸° í¼ì˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    document.getElementById('deleteDrawingBtn').addEventListener('click', async () => {
        const drawingId = document.getElementById('drawingMongoId').value;
        if (!drawingId || !confirm('ì •ë§ë¡œ ì´ ë„í˜•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/drawings/${drawingId}`, { 
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
            document.getElementById('drawingForm').style.display = 'none';
            initialize(); // ì „ì²´ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        } catch (error) {
            alert(error.message);
        }
    });

    // --- 11. ê·¸ë¦¬ê¸° í¼ ê´€ë¦¬ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function openDrawingForm(geojson, drawingData = null) {
        closeAllFormsExcept('drawingForm');
        const form = document.getElementById('drawingForm');
        form.style.display = 'block';
        document.getElementById('editDrawingForm').reset();

        document.getElementById('drawingGeoJson').value = JSON.stringify(geojson);

        if (drawingData) { // í¸ì§‘ ëª¨ë“œ
            document.getElementById('drawingMongoId').value = drawingData._id;
            document.getElementById('drawingName').value = drawingData.name;
            document.getElementById('drawingType').value = drawingData.type;
            document.getElementById('drawingStartYear').value = drawingData.start_year;
            document.getElementById('drawingEndYear').value = drawingData.end_year || '';
            document.getElementById('deleteDrawingBtn').style.display = 'inline-block';
            document.getElementById('saveDrawingBtn').textContent = 'ì €ì¥';
        } else { // ì¶”ê°€ ëª¨ë“œ
            document.getElementById('drawingMongoId').value = '';
            document.getElementById('drawingStartYear').value = yearInput.value; // í˜„ì¬ ì—°ë„ ê¸°ë³¸ê°’
            document.getElementById('deleteDrawingBtn').style.display = 'none';
            document.getElementById('saveDrawingBtn').textContent = 'ì €ì¥';
        }
    });
    // --- 12. ì‚¬ì„œ ê¸°ë¡ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    
    addHistoryBtn.addEventListener('click', () => {
        editingHistoryKey = null; // ì´ ë²„íŠ¼ ìì²´ê°€ ê´€ë¦¬ìì—ê²Œë§Œ ë³´ì´ë¯€ë¡œ ë‚´ë¶€ ê¶Œí•œ ì²´í¬ëŠ” ë¶ˆí•„ìš”
        closeAllFormsExcept('historyForm');
        document.getElementById('historyForm').style.display = 'block';
        document.getElementById('addHistoryForm').reset();
        document.getElementById('deleteHistoryBtn').style.display = 'none'; // ğŸš© [ì¶”ê°€] ì¶”ê°€ ëª¨ë“œì—ì„œëŠ” ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
        
        document.getElementById('historyYear').value = yearInput.value;
        document.getElementById('historyMonth').value = monthInput.value;
        document.getElementById('saveHistoryBtn').textContent = 'ì €ì¥';
    });

    document.getElementById('cancelHistoryBtn').addEventListener('click', () => {
        document.getElementById('historyForm').style.display = 'none';
    });
    
    // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('deleteHistoryBtn').addEventListener('click', async () => {
        if (!editingHistoryKey) return;
        if (!confirm('ì •ë§ë¡œ ì´ ì—­ì‚¬ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/history/${editingHistoryKey}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) throw new Error('ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

            document.getElementById('historyForm').style.display = 'none';
            initialize(); // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        } catch (error) {
            alert(error.message);
        }
    });

    document.getElementById('addHistoryForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const isUpdate = editingHistoryKey !== null;
        const url = isUpdate ? `${API_BASE_URL}/history/${editingHistoryKey}` : `${API_BASE_URL}/history`;
        const method = isUpdate ? 'PUT' : 'POST';
        
        const data = {
            year: parseInt(document.getElementById('historyYear').value),
            month: parseInt(document.getElementById('historyMonth').value) || 1,
            event_name: document.getElementById('historyEvent').value,
            create_event: document.getElementById('createEvent').checked, // ğŸš© [ìˆ˜ì •] create_event í”Œë˜ê·¸ë¥¼ history ë°ì´í„°ì— í¬í•¨
            photo: document.getElementById('historyPhoto').value || null, // ğŸš© [ì¶”ê°€] ì‚¬ì§„ ë°ì´í„° ìˆ˜ì§‘
            records: {
                korean: {
                    source: document.getElementById('koreanSource').value,
                    content: document.getElementById('koreanContent').value
                },
                foreign: {
                    source: document.getElementById('foreignSource').value,
                    content: document.getElementById('foreignContent').value
                },
                true_history: {
                    content: document.getElementById('trueHistoryContent').value
                }
            }
        };
        const createEvent = document.getElementById('createEvent').checked; // ğŸš© [ì¶”ê°€] ì²´í¬ë°•ìŠ¤ ê°’ í™•ì¸

        if (isNaN(data.year) || !data.event_name) {
            return alert("ì—°ë„ì™€ ì´ë²¤íŠ¸ëª…ì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        try {
            const response = await fetch(url, {
                method: method, 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            // --- ğŸš© [í•µì‹¬ ì¶”ê°€] ì´ë²¤íŠ¸ ë°ì´í„° ë™ê¸°í™” ë¡œì§ ---
            let historyId;
            if (isUpdate) {
                historyId = editingHistoryKey; // ì—…ë°ì´íŠ¸ ì‹œì—ëŠ” ê¸°ì¡´ ID ì‚¬ìš©
                await response.json(); // ì‘ë‹µì„ ì½ì–´ ë²„í¼ë¥¼ ë¹„ì›ë‹ˆë‹¤.
            } else {
                const savedHistoryResponse = await response.json(); // POST ì‘ë‹µì—ì„œ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                historyId = savedHistoryResponse.id;
            }
            const linkedEvent = events.find(e => e.history_id === historyId);

            if (createEvent) {
                // ì²´í¬ë°•ìŠ¤ í™œì„±í™”: ì´ë²¤íŠ¸ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
                const eventData = {
                    year: data.year,
                    month: data.month,
                    text: data.event_name,
                    photo: data.photo,
                    history_id: historyId // ì‚¬ì„œ ê¸°ë¡ ID ì—°ê²°
                };

                const eventMethod = linkedEvent ? 'PUT' : 'POST';
                const eventUrl = linkedEvent ? `${API_BASE_URL}/events/${linkedEvent._id}` : `${API_BASE_URL}/events`;

                const eventResponse = await fetch(eventUrl, {
                    method: eventMethod,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },                    
                    body: JSON.stringify(eventData)
                });
                if (!eventResponse.ok) throw new Error('ì—°ë™ ì´ë²¤íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

            } else if (linkedEvent) {
                // ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”: ì—°ê²°ëœ ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
                const eventResponse = await fetch(`${API_BASE_URL}/events/${linkedEvent._id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!eventResponse.ok) throw new Error('ì—°ë™ ì´ë²¤íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            // --- ì´ë²¤íŠ¸ ë™ê¸°í™” ë¡œì§ ë ---


            document.getElementById('historyForm').style.display = "none";
            initialize(); 
        } catch (error) {
            console.error("History ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`History ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });
    
    window.editHistory = function(key) {
        const record = history.find(h => h._id === key); 
        if (!record || !editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return; // ğŸš© [ìˆ˜ì •] ê¶Œí•œ ì²´í¬
        if (!record) return alert("ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        editingHistoryKey = key;
        closeAllFormsExcept('historyForm');
        document.getElementById('historyForm').style.display = "block";
        document.getElementById('deleteHistoryBtn').style.display = 'inline-block'; // ğŸš© [ì¶”ê°€] í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        
        document.getElementById('historyKey').value = key;
        document.getElementById('historyMonth').value = record.month;
        document.getElementById('historyYear').value = record.year;
        document.getElementById('historyEvent').value = record.event_name;
        document.getElementById('historyPhoto').value = record.photo ?? ''; // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL ì±„ìš°ê¸°

        // ğŸš© [ìˆ˜ì •] ì—°ê²°ëœ ì´ë²¤íŠ¸ ì¡´ì¬ ì—¬ë¶€ê°€ ì•„ë‹Œ, history ë°ì´í„°ì— ì €ì¥ëœ create_event í”Œë˜ê·¸ ê°’ìœ¼ë¡œ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // const linkedEvent = events.find(e => e.history_id === key);
        document.getElementById('createEvent').checked = record.create_event || false;

        
        document.getElementById('koreanSource').value = record.records?.korean?.source ?? '';
        document.getElementById('koreanContent').value = record.records?.korean?.content ?? '';
        
        document.getElementById('foreignSource').value = record.records?.foreign?.source ?? '';
        document.getElementById('foreignContent').value = record.records?.foreign?.content ?? '';
        
        document.getElementById('trueHistoryContent').value = record.records?.true_history?.content ?? '';
        document.getElementById('saveHistoryBtn').textContent = 'ì €ì¥';
    }

    // --- 13. ì˜¤ë¥¸ìª½ íŒ¨ë„ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function initializeResizer() {
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('leftColumn');
        const rightPanel = document.getElementById('rightPanel');

        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.userSelect = 'none'; // ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
            document.body.style.cursor = 'col-resize';

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', stopResizing);
        });

        function handleMouseMove(e) {
            if (!isResizing) return;

            const containerRect = document.getElementById('mainContainer').getBoundingClientRect();
            const totalWidth = containerRect.width;
            const leftWidth = e.clientX - containerRect.left - resizer.offsetWidth / 2;
            const rightWidth = totalWidth - leftWidth - resizer.offsetWidth;

            leftPanel.style.flexBasis = `${leftWidth}px`;
            rightPanel.style.flexBasis = `${rightWidth}px`;

            // ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì§• ì¤‘ ì§€ë„ íƒ€ì¼ì´ ê¹œë¹¡ì´ì§€ ì•Šë„ë¡ ë¶€ë“œëŸ½ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            map.invalidateSize(false);
        }

        function stopResizing() {
            isResizing = false;
            document.body.style.userSelect = ''; // ì›ë˜ëŒ€ë¡œ ë³µì›
            document.body.style.cursor = '';
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', stopResizing);
            // ğŸš© [í•µì‹¬ ìˆ˜ì •] ë¦¬ì‚¬ì´ì§•ì´ ëë‚¬ì„ ë•Œ í•œ ë²ˆë§Œ ì§€ë„ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
            map.invalidateSize();
        }
    }

    // --- 14. ì˜¤ë¥¸ìª½ íŒ¨ë„ ë‚´ë¶€ ìˆ˜ì§ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function initializeVerticalResizer() {
        const resizer = document.getElementById('vertical-resizer');
        const kingPanel = document.getElementById('kingPanel');
        const historyPanel = document.getElementById('historyPanel');

        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            // ê°€ë¡œ ë¦¬ì‚¬ì´ì €ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ body ìŠ¤íƒ€ì¼ì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ
            // ëŒ€ì‹ , rightPanel ë‚´ì—ì„œë§Œ ì»¤ì„œ ëª¨ì–‘ì„ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            document.getElementById('rightPanel').style.cursor = 'row-resize';

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', stopResizing);
        });

        function handleMouseMove(e) {
            if (!isResizing) return;

            const rightPanelRect = document.getElementById('rightPanel').getBoundingClientRect();
            const kingPanelHeight = e.clientY - rightPanelRect.top;
            
            // ìµœì†Œ/ìµœëŒ€ ë†’ì´ ì œí•œ (ì„ íƒ ì‚¬í•­)
            const minHeight = 50; // ìµœì†Œ 50px
            const maxHeight = rightPanelRect.height - 100; // ìµœëŒ€ ë†’ì´ ì œí•œ

            if (kingPanelHeight > minHeight && kingPanelHeight < maxHeight) {
                kingPanel.style.flexBasis = `${kingPanelHeight}px`;
            }
        }

        function stopResizing() {
            isResizing = false;
            document.getElementById('rightPanel').style.cursor = '';
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', stopResizing);
        }
    }

    // --- 15. í¼ ì´ë™(ë“œë˜ê·¸) ê¸°ëŠ¥ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function makeFormsDraggable() {
        const formIds = ['castleForm', 'historyForm', 'countryForm', 'kingForm', 'eventForm', 'drawingForm', 'editCitySelectionForm']; // ğŸš© [ì¶”ê°€] editCitySelectionForm í¬í•¨

        formIds.forEach(id => {
            const form = document.getElementById(id);
            const header = form.querySelector('h3');

            if (!header) return;

            let isDragging = false;
            let offsetX, offsetY;

            header.addEventListener('mousedown', (e) => {
                // í¼ ë‚´ë¶€ì˜ ë‹¤ë¥¸ ìš”ì†Œ(input, select ë“±)ì—ì„œ ì‹œì‘ëœ mousedownì€ ë¬´ì‹œ
                if (e.target !== header) return;

                isDragging = true;
                offsetX = e.clientX - form.offsetLeft;
                offsetY = e.clientY - form.offsetTop;

                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;
                
                let newLeft = e.clientX - offsetX;
                let newTop = e.clientY - offsetY;

                form.style.left = `${newLeft}px`;
                form.style.top = `${newTop}px`;
            }

            function onMouseUp() {
                isDragging = false;
                document.body.style.userSelect = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        });
    }

    // ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì € ê¸°ëŠ¥ ì´ˆê¸°í™”
    initializeResizer();
    initializeVerticalResizer();
    makeFormsDraggable();

    // ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ ì´ˆê¸°í™”
    function initializeRightPanelToggle() {
        const toggleBtn = document.getElementById('rightPanelToggleBtn'); // ë²„íŠ¼
        const rightPanel = document.getElementById('rightPanel'); // ì˜¤ë¥¸ìª½ íŒ¨ë„
        const resizer = document.getElementById('resizer'); // ë¦¬ì‚¬ì´ì €

        toggleBtn.addEventListener('click', () => {
            const isCollapsed = rightPanel.classList.toggle('collapsed');
            resizer.classList.toggle('hidden', isCollapsed);

            if (isCollapsed) {
                toggleBtn.textContent = 'í¼ì¹˜ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                toggleBtn.style.left = '-28px'; // ì ‘í˜”ì„ ë•Œ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì •
            } else {
                toggleBtn.textContent = 'íŒ¨ë„ ì ‘ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µì›
                toggleBtn.style.left = '-28px'; // í¼ì³¤ì„ ë•Œ ë²„íŠ¼ ìœ„ì¹˜ ë³µì›
            }
        });
    }    
    
    // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰)
    function initializeDrawControl() {
        // ì‚¬ìš©ì ê¶Œí•œì— ë”°ë¼ ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ì„ ì§€ë„ì— ì¶”ê°€
        const user = parseJwt(token);
        if (user && (user.role === 'admin' || user.role === 'superuser')) {
            if (drawControl) map.removeControl(drawControl); // ì¤‘ë³µ ë°©ì§€
            drawControl = new L.Control.Draw({
                edit: false, // ë„í˜• í´ë¦­ìœ¼ë¡œë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥
                draw: { 
                    polygon: true, 
                    polyline: true, 
                    rectangle: true, 
                    circle: true, 
                    marker: true, 
                    circlemarker: false 
                }
            });
            map.addControl(drawControl);

            // ê·¸ë¦¬ê¸° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë°”ì¸ë”©
            map.on(L.Draw.Event.CREATED, function (e) {
                const layer = e.layer;
                const geojson = layer.toGeoJSON();
                openDrawingForm(geojson);
            });
            map.on('draw:drawstart', () => { isDrawing = true; });
            map.on('draw:drawstop', () => { isDrawing = false; });
        }
    }

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¤‘ë³µ ì„ ì–¸ëœ DOMContentLoaded ë¦¬ìŠ¤ë„ˆë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•˜ê³ , ëˆ„ë½ëœ ë ˆì´ì–´ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    document.addEventListener('DOMContentLoaded', async () => {
        await initialize();
        initializeRightPanelToggle();
        createSliderTicks(); // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” ëˆˆê¸ˆ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
        createDynastyTimeline(); // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
        initializeDrawControl(); // ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ

        // ğŸš© [ì¶”ê°€] ì¬ìƒ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ì„ ì´ê³³ìœ¼ë¡œ í†µí•©í•©ë‹ˆë‹¤.
        playBtn.addEventListener('click', startPlayback);
        pauseBtn.addEventListener('click', stopPlayback);

        playbackSpeedSlider.oninput = () => {
            speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
            if (playInterval) {
                stopPlayback();
                startPlayback(); // ì¦‰ì‹œ ìƒˆ ì†ë„ë¡œ ë‹¤ì‹œ ì‹œì‘
            }
        };
        speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`; // ì´ˆê¸° í‘œì‹œ

        combinedSlider.addEventListener('mousedown', stopPlayback);
        combinedSlider.addEventListener('touchstart', stopPlayback);

        // ğŸš© [ìˆ˜ì •] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ì‹œ ì¶”ê°€í•©ë‹ˆë‹¤.
        layerToggles.addEventListener('click', (e) => {
            if (e.target.classList.contains('layer-toggle-btn')) {
                const button = e.target;
                const layerType = button.dataset.layer;
                
                button.classList.toggle('active');
                layerVisibility[layerType] = button.classList.contains('active');
                
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
            }
        });

        // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë§‰ëŒ€ í´ë¦­ ì‹œ í•´ë‹¹ êµ­ê°€ì˜ ì‹œì‘ ì—°ë„ë¡œ ì´ë™
        const timelineContainer = document.getElementById('timeline-container');
        timelineContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('timeline-bar')) {
                const bar = e.target;
                const year = parseInt(bar.dataset.startYear);
                const month = parseInt(bar.dataset.startMonth);
                updateTime(year, month);
            }
        });
    });
  </script>

</body>
</html>