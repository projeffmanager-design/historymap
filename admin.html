<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬</title>
    <!-- ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ë°˜ì‘í˜•ì„ ìœ„í•œ ë·°í¬íŠ¸ ë©”íƒ€ íƒœê·¸ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ğŸš© [ì¶”ê°€] Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ğŸš© [ì¶”ê°€] ë¸Œë¼ìš°ì € íƒ­ ì•„ì´ì½˜(íŒŒë¹„ì½˜) ì„¤ì • -->
    <link rel="icon" type="image/png" href="https://mblogthumb-phinf.pstatic.net/MjAxNzAyMjdfMTY5/MDAxNDg4MTgzMTM3Njgy.kranOyMCE0geFsNMdN3cFzfhswjppZFRoREZIhB_oowg.qK_GkZnrnCj96GOrscX-MxqnbEiStdtpOD8hxeNGLXEg.PNG.ya0705/%EC%9D%B4%EB%AF%B8%EC%A7%80_3-01.png?type=w2">
    <style>
        body {
            background-color: #0c0d15;
            /* background-image: url('https://i.pinimg.com/736x/a3/bb/08/a3bb08156e438a1fa2c8ad66c6ffa667.jpg'); */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #ecf0f1;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #ecf0f1;
            text-shadow: 2px 2px 4px #000;
        }
        /* ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê²€ìƒ‰/í•„í„° ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        #user-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* ğŸš© [ì¶”ê°€] ì»¨íŠ¸ë¡¤ì´ ì—¬ëŸ¬ ì¤„ë¡œ ë‚˜ë‰˜ë„ë¡ í—ˆìš© */
            align-items: center;
        }
        .container {
            max-width: 1600px; /* ğŸš© [ìˆ˜ì •] í˜ì´ì§€ ì „ì²´ ë„ˆë¹„ í™•ì¥ */
            margin: 0 auto;
            background: #2c3e50;
            padding: 20px;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #5d7185;
            text-align: left;
        }
        /* ğŸš© [ì¶”ê°€] ì‘ì—… ë²„íŠ¼ ì…€ì´ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
        td:last-child {
            white-space: nowrap;
        }
        th {
            background-color: #3e4a56;
        }
        /* ğŸš© [ì¶”ê°€] ì •ë ¬ ê°€ëŠ¥í•œ í…Œì´ë¸” í—¤ë” ìŠ¤íƒ€ì¼ */
        th.sortable {
            cursor: pointer;
            position: relative;
        }
        th.sortable.sort-asc::after {
            content: ' â–²';
            opacity: 1;
        }
        th.sortable.sort-desc::after {
            content: ' â–¼';
            opacity: 1;
        }
        form {
            display: flex; 
            flex-direction: column; /* ğŸš© [ìˆ˜ì •] í¼ ìš”ì†Œë“¤ì„ ìˆ˜ì§ìœ¼ë¡œ ì •ë ¬ */
            gap: 10px;
            margin-bottom: 20px;
        }
        /* ğŸš© [ì¶”ê°€] ë“±ë¡ í¼ì€ ê°€ë¡œ ì •ë ¬ ìœ ì§€ */
        #registerForm {
            flex-direction: row; /* ê°€ë¡œ ì •ë ¬ ìœ ì§€ */
            align-items: flex-end; /* ìš”ì†Œë“¤ì„ í•˜ë‹¨ì— ì •ë ¬ */
            gap: 15px; /* ìš”ì†Œ ê°„ ê°„ê²© ì¡°ì • */
        }
        input, select, textarea { /* ğŸš© [ìˆ˜ì •] select, textarea ìŠ¤íƒ€ì¼ ì¶”ê°€ */
            padding: 8px;
            border-radius: 4px; 
            border: 1px solid #5d7185;
            background-color: #f0f0f0;
            color: black;
            width: 100%; /* ğŸš© [ì¶”ê°€] ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
            box-sizing: border-box; /* ğŸš© [ì¶”ê°€] íŒ¨ë”©ê³¼ í…Œë‘ë¦¬ë¥¼ ë„ˆë¹„ì— í¬í•¨ */
        }
        button {
            padding: 8px 15px;
            width: auto; 
            align-self: flex-start; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ì„ ì™¼ìª½ ì •ë ¬ */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #00aaff;
            color: white;
        }
        button.danger {
            background-color: #e74c3c;
        }
        #registerForm button {
            align-self: flex-end; /* ğŸš© [ìˆ˜ì •] ë“±ë¡ í¼ì˜ ë²„íŠ¼ë„ í•˜ë‹¨ ì •ë ¬ */
            padding: 9px 15px; /* ğŸš© [ìˆ˜ì •] ë‹¤ë¥¸ inputê³¼ ë†’ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ íŒ¨ë”© ì¡°ì • */
        }
        /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ ë¡œë”© ìƒíƒœ */
        button.loading {
            position: relative;
            color: transparent !important;
        }
        button.loading::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 16px; height: 16px;
            margin-top: -8px; margin-left: -8px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .nav-links {
            text-align: center;
            margin-top: 20px;
        }
        .nav-links a {
            color: #ecf0f1; /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
            text-decoration: none;
            margin: 0 10px;
        }
        /* ğŸš© [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        .toast.success { background-color: #27ae60; }
        .toast.error { background-color: #c0392b; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: #2c3e50;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #5d7185;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #00aaff;
        }
        #emailRecipientList {
            list-style-type: none;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #3e4a56;
            border: 1px solid #5d7185;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        /* ğŸš© [ì¶”ê°€] í™•ì¸ ëª¨ë‹¬ì˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        #confirmModalMessage {
            margin-bottom: 20px;
        }
        /* ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        #pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        #pagination-controls button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* ğŸš© [ì¶”ê°€] ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #chartContainer {
            position: relative; /* ğŸš© [ìˆ˜ì •] ì°¨íŠ¸ ë°˜ì‘í˜•ì„ ìœ„í•´ position ì¶”ê°€ */
            max-height: 350px; /* ğŸš© [ìˆ˜ì •] ì°¨íŠ¸ ìµœëŒ€ ë†’ì´ ì œí•œ */
            margin-bottom: 30px;
            background-color: #3e4a56;
            padding: 20px; border-radius: 8px;
        }
        #dailyLoginsChartContainer {
            position: relative; /* ğŸš© [ìˆ˜ì •] ì°¨íŠ¸ ë°˜ì‘í˜•ì„ ìœ„í•´ position ì¶”ê°€ */
            max-height: 350px; /* ğŸš© [ìˆ˜ì •] ì°¨íŠ¸ ìµœëŒ€ ë†’ì´ ì œí•œ */
            margin-bottom: 30px;
            background-color: #3e4a56;
            padding: 20px; border-radius: 8px;
        }
        #pageViewsChartContainer {
            position: relative;
            max-height: 350px;
            margin-bottom: 20px;
            background-color: #3e4a56;
            padding: 20px;
            border-radius: 8px;
        }
        #pageViewsSummaryContainer {
            background-color: #3e4a56;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
    </style>
    <!-- ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ -->
    <style>
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }

            /* ì»¨íŠ¸ë¡¤ë“¤ì„ ì„¸ë¡œë¡œ ìŒ“ê¸° */
            #user-controls, #registerForm {
                flex-direction: column;
                align-items: stretch; /* ì»¨íŠ¸ë¡¤ë“¤ì„ ê½‰ ì±„ì›€ */
            }
            #user-controls input, #user-controls select,
            #registerForm input, #registerForm select {
                width: 100%; /* ë„ˆë¹„ 100%ë¡œ ì„¤ì • */
            }

            /* í…Œì´ë¸”ì´ ë„˜ì¹  ê²½ìš° ê°€ë¡œ ìŠ¤í¬ë¡¤ ìƒì„± */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            /* ëª¨ë‹¬ ì°½ì´ í™”ë©´ì— ë” ì˜ ë§ë„ë¡ ì¡°ì • */
            .modal-content {
                width: 90%;
            }
        }
    </style>
    <!-- ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ -->
    <style>
        #editUserModal .modal-content {
            max-width: 500px;
        }
        #editUserModal form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #editUserModal .form-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #editUserModal .form-row label {
            width: 100px;
            flex-shrink: 0;
            text-align: right;
        }
        #editUserModal .form-row input,
        #editUserModal .form-row select {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <h1>íšŒì› ê´€ë¦¬</h1>
    <div class="container">
        <h2>ì‚¬ìš©ì ë“±ë¡ í˜„í™©</h2>
        <!-- ğŸš© [ì¶”ê°€] ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
        <div id="chartContainer">
            <canvas id="registrationChart"></canvas>
        </div>

        <h2>ìµœê·¼ 7ì¼ ì ‘ì†ì ìˆ˜</h2>
        <!-- ğŸš© [ì¶”ê°€] ì¼ì¼ ì ‘ì†ì ìˆ˜ ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ -->
        <div id="dailyLoginsChartContainer">
            <canvas id="dailyLoginsChart"></canvas>
        </div>

        <h2>í˜ì´ì§€ ë·° í†µê³„</h2>
        <div id="pageViewsChartContainer">
            <canvas id="pageViewsChart"></canvas>
        </div>
        <div id="pageViewsSummaryContainer">
            <table>
                <thead>
                    <tr>
                        <th>í˜ì´ì§€</th>
                        <th>ìµœê·¼ 7ì¼ í•©ê³„</th>
                    </tr>
                </thead>
                <tbody id="pageViewsSummary">
                    <!-- í˜ì´ì§€ ë·° í•©ê³„ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
                </tbody>
            </table>
            <p id="pageViewsSummaryNote" style="margin-top: 10px; font-size: 0.9em; color: #bdc3c7;">
                ìµœê·¼ 7ì¼ ë™ì•ˆ ì§‘ê³„ëœ í˜ì´ì§€ ë·° ê¸°ì¤€ì…ë‹ˆë‹¤.
            </p>
        </div>

        <h2>ì‚¬ìš©ì ëª©ë¡</h2>
        <!-- ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê²€ìƒ‰ ë° í•„í„° ì»¨íŠ¸ë¡¤ -->
        <div id="user-controls">
            <input type="text" id="userSearchInput" placeholder="ì‚¬ìš©ì ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." style="width: 250px;">
            <select id="roleFilterSelect" style="width: 150px;">
                <option value="all">-- ëª¨ë“  ì—­í•  --</option>
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="superuser">Superuser</option>
            </select>
            <label for="itemsPerPageSelect" style="color: #ecf0f1; font-weight: normal;">í•­ëª© ìˆ˜:</label>
            <select id="itemsPerPageSelect" style="width: 80px;">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
        </div>

        <table id="userTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort-by="username">ì‚¬ìš©ì ì´ë¦„</th>
                    <th class="sortable" data-sort-by="email">ì´ë©”ì¼</th>
                    <th class="sortable" data-sort-by="lastLogin">ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                    <th class="sortable" data-sort-by="loginCount">ë¡œê·¸ì¸ íšŸìˆ˜</th>
                    <th class="sortable" data-sort-by="role">ì—­í• </th>
                    <th class="sortable" data-sort-by="position">ì§ê¸‰</th>
                    <th class="sortable" data-sort-by="createdAt">ê°€ì…ì¼</th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="userList">
                <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </tbody>
        </table>

        <!-- ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ -->
        <div id="pagination-controls">
            <button id="prevPageBtn">ì´ì „</button>
            <span id="pageInfo"></span>
            <button id="nextPageBtn">ë‹¤ìŒ</button>
        </div>

        <h2>ë ˆì´ì–´ ê¸°ë³¸ ì„¤ì •</h2>
        <div id="layerSettingsContainer" style="background-color: #3e4a56; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <p style="margin-bottom: 15px; color: #ecf0f1;">ì§€ë„ í˜ì´ì§€ì—ì„œ ê° ë ˆì´ì–´ê°€ ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œë ì§€ ì„¤ì •í•©ë‹ˆë‹¤.</p>
            <div id="layerSettingsGrid" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <!-- ë ˆì´ì–´ ì„¤ì • ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button id="saveLayerSettingsBtn" class="primary" style="padding: 8px 16px;">ì„¤ì • ì €ì¥</button>
            </div>
        </div>

        <h2>ìƒˆ ì‚¬ìš©ì ë“±ë¡</h2>
        <form id="registerForm">
            <input type="text" id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" required>
            <input type="email" id="email" placeholder="ì´ë©”ì¼" required>
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            <select id="role">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="superuser">Superuser</option>
            </select>
            <select id="position">
                <!-- ğŸš© ê³ ë ¤ ì‚¬ê´€ í†µí•© 18ë‹¨ê³„ ì§ê¸‰í‘œ (ì¢…9í’ˆâ†’ì •1í’ˆ) -->
                <option value="ìˆ˜ë¶„ê¶Œì§€">ìˆ˜ë¶„ê¶Œì§€ (ì¢…9í’ˆ)</option>
                <option value="ì •ì">ì •ì (ì •9í’ˆ)</option>
                <option value="ê²€ì—´">ê²€ì—´ (ì¢…8í’ˆ)</option>
                <option value="ì£¼ì„œ">ì£¼ì„œ (ì •8í’ˆ)</option>
                <option value="ì§ë¬¸í•œ">ì§ë¬¸í•œ (ì¢…7í’ˆ)</option>
                <option value="ìˆ˜ì°¬">ìˆ˜ì°¬ (ì •7í’ˆ)</option>
                <option value="ê¸°ê±°ë„ìœ„">ê¸°ê±°ë„ìœ„ (ì¢…6í’ˆ)</option>
                <option value="ê¸°ê±°ë‘">ê¸°ê±°ë‘ (ì •6í’ˆ)</option>
                <option value="ê¸°ê±°ì‚¬">ê¸°ê±°ì‚¬ (ì¢…5í’ˆ)</option>
                <option value="ê¸°ê±°ì£¼">ê¸°ê±°ì£¼ (ì •5í’ˆ)</option>
                <option value="ì‹œê°•í•™ì‚¬">ì‹œê°•í•™ì‚¬ (ì¢…4í’ˆ)</option>
                <option value="ì‚¬ê´€ìˆ˜ì°¬">ì‚¬ê´€ìˆ˜ì°¬ (ì •4í’ˆ)</option>
                <option value="ì§ìˆ˜ì°¬ê´€">ì§ìˆ˜ì°¬ê´€ (ì¢…3í’ˆ)</option>
                <option value="ìˆ˜ì°¬ê´€">ìˆ˜ì°¬ê´€ (ì •3í’ˆ)</option>
                <option value="ë™ìˆ˜êµ­ì‚¬">ë™ìˆ˜êµ­ì‚¬ (ì¢…2í’ˆ)</option>
                <option value="ìˆ˜êµ­ì‚¬">ìˆ˜êµ­ì‚¬ (ì •2í’ˆ)</option>
                <option value="íŒì‚¬ê´€ì‚¬">íŒì‚¬ê´€ì‚¬ (ì¢…1í’ˆ)</option>
                <option value="ê°ìˆ˜êµ­ì‚¬">ê°ìˆ˜êµ­ì‚¬ (ì •1í’ˆ)</option>
            </select>
            <button type="submit">ë“±ë¡</button>
        </form>

        <hr style="border-color: #5d7185; margin: 30px 0;">

        <h2>ì¼ê´„ ë©”ì¼ ë°œì†¡</h2>
        <form id="bulkEmailForm">
            <input type="text" id="emailSubject" placeholder="ë©”ì¼ ì œëª©" required>
            <textarea id="emailBody" rows="5" placeholder="ë©”ì¼ ë‚´ìš©" required></textarea>
            <button type="submit">ì „ì²´ ë°œì†¡</button>
        </form>

        <!-- ğŸš© [ì¶”ê°€] ë©”ì¼ ë°œì†¡ ëŒ€ìƒ í™•ì¸ ëª¨ë‹¬ -->
        <div id="emailConfirmModal" class="modal">
            <div class="modal-content">
                <h3>ë©”ì¼ ë°œì†¡ ëŒ€ìƒ í™•ì¸</h3>
                <p><strong id="emailConfirmSubject"></strong> ì œëª©ìœ¼ë¡œ ì•„ë˜ ì‚¬ìš©ìë“¤ì—ê²Œ ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                <ul id="emailRecipientList">
                    <!-- ë°œì†¡ ëŒ€ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </ul>
                <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="cancelEmailSend" class="danger">ì·¨ì†Œ</button>
                    <button type="button" id="confirmEmailSend" class="primary">í™•ì¸ ë° ë°œì†¡</button>
                </div>
            </div>
        </div>

        <!-- ğŸš© [ì¶”ê°€] ë²”ìš© í™•ì¸ ëª¨ë‹¬ -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h3>ì‘ì—… í™•ì¸</h3>
                <p id="confirmModalMessage"></p>
                <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="cancelConfirm" class="danger">ì·¨ì†Œ</button>
                    <button type="button" id="confirmAction" class="primary">í™•ì¸</button>
                </div>
            </div>
        </div>

        <!-- ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <h3>ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</h3>
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-row">
                        <label for="editUsername">ì‚¬ìš©ì ì´ë¦„</label>
                        <input type="text" id="editUsername" required>
                    </div>
                    <div class="form-row">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail">
                    </div>
                    <div class="form-row">
                        <label for="editPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="editPassword" placeholder="ë³€ê²½í•  ê²½ìš°ì—ë§Œ ì…ë ¥">
                    </div>
                    <div class="form-row">
                        <label for="editRole">ì—­í• </label>
                        <select id="editRole" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="superuser">Superuser</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label for="editPosition">ì§ê¸‰</label>
                        <select id="editPosition">
                            <!-- ğŸš© ê³ ë ¤ ì‚¬ê´€ í†µí•© 18ë‹¨ê³„ ì§ê¸‰í‘œ (ì¢…9í’ˆâ†’ì •1í’ˆ) -->
                            <option value="ìˆ˜ë¶„ê¶Œì§€">ìˆ˜ë¶„ê¶Œì§€ (ì¢…9í’ˆ)</option>
                            <option value="ì •ì">ì •ì (ì •9í’ˆ)</option>
                            <option value="ê²€ì—´">ê²€ì—´ (ì¢…8í’ˆ)</option>
                            <option value="ì£¼ì„œ">ì£¼ì„œ (ì •8í’ˆ)</option>
                            <option value="ì§ë¬¸í•œ">ì§ë¬¸í•œ (ì¢…7í’ˆ)</option>
                            <option value="ìˆ˜ì°¬">ìˆ˜ì°¬ (ì •7í’ˆ)</option>
                            <option value="ê¸°ê±°ë„ìœ„">ê¸°ê±°ë„ìœ„ (ì¢…6í’ˆ)</option>
                            <option value="ê¸°ê±°ë‘">ê¸°ê±°ë‘ (ì •6í’ˆ)</option>
                            <option value="ê¸°ê±°ì‚¬">ê¸°ê±°ì‚¬ (ì¢…5í’ˆ)</option>
                            <option value="ê¸°ê±°ì£¼">ê¸°ê±°ì£¼ (ì •5í’ˆ)</option>
                            <option value="ì‹œê°•í•™ì‚¬">ì‹œê°•í•™ì‚¬ (ì¢…4í’ˆ)</option>
                            <option value="ì‚¬ê´€ìˆ˜ì°¬">ì‚¬ê´€ìˆ˜ì°¬ (ì •4í’ˆ)</option>
                            <option value="ì§ìˆ˜ì°¬ê´€">ì§ìˆ˜ì°¬ê´€ (ì¢…3í’ˆ)</option>
                            <option value="ìˆ˜ì°¬ê´€">ìˆ˜ì°¬ê´€ (ì •3í’ˆ)</option>
                            <option value="ë™ìˆ˜êµ­ì‚¬">ë™ìˆ˜êµ­ì‚¬ (ì¢…2í’ˆ)</option>
                            <option value="ìˆ˜êµ­ì‚¬">ìˆ˜êµ­ì‚¬ (ì •2í’ˆ)</option>
                            <option value="íŒì‚¬ê´€ì‚¬">íŒì‚¬ê´€ì‚¬ (ì¢…1í’ˆ)</option>
                            <option value="ê°ìˆ˜êµ­ì‚¬">ê°ìˆ˜êµ­ì‚¬ (ì •1í’ˆ)</option>
                        </select>
                    </div>
                    <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                        <button type="button" id="cancelUserEdit" class="danger">ì·¨ì†Œ</button>
                        <button type="submit" id="saveUserEdit" class="primary">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="nav-links">
        <a href="index.html" class="button-style primary">ë©”ì¸ ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <!-- ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="toastContainer"></div>
    <script>
        const API_BASE_URL = '/api'; // ğŸ’¡ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');

        // í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        const PAGE_NAME_MAP = {
            '/index.html': 'ë©”ì¸ ì§€ë„',
            '/login.html': 'ë¡œê·¸ì¸',
            '/register.html': 'íšŒì›ê°€ì…',
            '/admin.html': 'ê´€ë¦¬ì',
            '/account.html': 'ê³„ì • ê´€ë¦¬'
        };

        const describePagePath = (rawPath) => {
            if (!rawPath) {
                return { label: 'ì•Œ ìˆ˜ ì—†ìŒ', slug: 'unknown' };
            }
            if (rawPath === 'ê¸°íƒ€') {
                return { label: 'ê¸°íƒ€ í˜ì´ì§€', slug: 'ê¸°íƒ€' };
            }
            const normalized = rawPath.startsWith('/') ? rawPath : `/${rawPath}`;
            const slug = normalized.substring(1) || normalized;
            const friendly = PAGE_NAME_MAP[normalized] || slug;
            return { label: friendly, slug };
        };

        const hexToRgba = (hex, alpha) => {
            if (!hex || typeof hex !== 'string' || !hex.startsWith('#')) {
                return hex;
            }
            const trimmed = hex.replace('#', '');
            if (trimmed.length !== 6) {
                return hex;
            }
            const bigint = parseInt(trimmed, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const formatIsoDateForLabel = (isoDate) => {
            if (!isoDate) return '';
            const date = new Date(`${isoDate}T00:00:00Z`);
            if (Number.isNaN(date.getTime())) return isoDate;
            return `${date.getMonth() + 1}/${date.getDate()}`;
        };

        let allUsers = []; // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ëª©ë¡ì„ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        // ğŸš© [ì¶”ê°€] ì •ë ¬ ìƒíƒœë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        let currentSort = {
            key: 'username',
            direction: 'asc'
        };
        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ ë³€ìˆ˜
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredAndSortedUsers = []; // í•„í„°ë§ ë° ì •ë ¬ëœ ì „ì²´ ì‚¬ìš©ì ëª©ë¡

        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');


        // ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ğŸš© [ì¶”ê°€] ë²”ìš© í™•ì¸ ëª¨ë‹¬ í•¨ìˆ˜
        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmModalMessage').textContent = message;
            modal.style.display = 'block';

            const confirmBtn = document.getElementById('confirmAction');
            const cancelBtn = document.getElementById('cancelConfirm');

            const confirmHandler = () => {
                modal.style.display = 'none';
                onConfirm();
                cleanup();
            };

            const cancelHandler = () => {
                modal.style.display = 'none';
                cleanup();
            };

            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ëª©ë¡ì„ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderUsers(usersToRender) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            console.log('ë Œë”ë§í•  ì‚¬ìš©ì ìˆ˜:', usersToRender.length);
            if (usersToRender.length > 0) {
                console.log('ì²« ë²ˆì§¸ ì‚¬ìš©ì ë°ì´í„°:', usersToRender[0]);
            }
            usersToRender.forEach(user => { 
                const tr = document.createElement('tr');
                if (user.isLocked) {
                    tr.classList.add('locked');
                }
                const lastLogin = user.lastLogin 
                    ? new Date(user.lastLogin).toLocaleString() 
                    : 'ê¸°ë¡ ì—†ìŒ';
                const createdAt = user.createdAt 
                    ? new Date(user.createdAt).toLocaleString() 
                    : 'ì•Œ ìˆ˜ ì—†ìŒ';
                const position = user.position || 'ìˆ˜ë¶„ê¶Œì§€';
                console.log(`ì‚¬ìš©ì ${user.username} ì§ê¸‰:`, position);
                tr.innerHTML = ` 
                    <td>${user.username}</td>
                    <td>${user.email || 'ë¯¸ì…ë ¥'}</td>
                    <td>${lastLogin}</td>
                    <td>${user.loginCount || 0}íšŒ</td>
                    <td>${user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'N/A'}</td>
                    <td>${position}</td>
                    <td>${createdAt}</td>
                    <td>
                        <button class="button lock-btn" onclick="toggleLockStatus(this, '${user._id}', ${user.isLocked || false})">${user.isLocked ? 'ì ê¸ˆ í•´ì œ' : 'ê³„ì • ì ê¸ˆ'}</button>
                        <button class="primary" onclick="openEditUserModal('${user._id}')">ìˆ˜ì •</button>
                        <button class="button danger" onclick="deleteUser(this, '${user._id}')">ì‚­ì œ</button>
                        <button class="button switch-btn" onclick="switchToUser('${user._id}')">ìŠ¤ìœ„ì¹˜</button>
                    </td>
                `;
                userList.appendChild(tr);
            });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ë“±ë¡ ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜
        let registrationChartInstance = null;
        let pageViewsChartInstance = null;
        function renderRegistrationChart(users) {
            if (!users || users.length === 0) return;

            const monthlyCounts = {};

            users.forEach(user => {
                // ObjectIdì—ì„œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì¶œ
                const timestamp = new Date(parseInt(user._id.substring(0, 8), 16) * 1000);
                const year = timestamp.getFullYear();
                const month = (timestamp.getMonth() + 1).toString().padStart(2, '0');
                const yearMonth = `${year}-${month}`;

                if (!monthlyCounts[yearMonth]) {
                    monthlyCounts[yearMonth] = 0;
                }
                monthlyCounts[yearMonth]++;
            });

            const sortedMonths = Object.keys(monthlyCounts).sort();
            const labels = sortedMonths;
            const data = sortedMonths.map(month => monthlyCounts[month]);

            const ctx = document.getElementById('registrationChart').getContext('2d');
            
            if (registrationChartInstance) {
                registrationChartInstance.destroy();
            }

            registrationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì›”ë³„ ì‹ ê·œ ê°€ì…ì ìˆ˜',
                        data: data,
                        backgroundColor: 'rgba(0, 170, 255, 0.2)',
                        borderColor: 'rgba(0, 170, 255, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    maintainAspectRatio: false, // ğŸš© [ìˆ˜ì •] ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ê²Œ ë¹„ìœ¨ì„ ì¡°ì •í•˜ë„ë¡ ì„¤ì •
                    scales: { y: { beginAtZero: true, ticks: { color: '#ecf0f1' } }, x: { ticks: { color: '#ecf0f1' } } },
                    plugins: { legend: { labels: { color: '#ecf0f1' } } }
                }
            });
        }

        // ğŸš© [ì¶”ê°€] ì¼ì¼ ì ‘ì†ì ìˆ˜ ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜
        let dailyLoginsChartInstance = null;
        async function fetchAndRenderDailyLoginsChart() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats/daily-logins`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('ì ‘ì†ì í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                
                const data = await response.json();

                // ì§€ë‚œ 7ì¼ê°„ì˜ ë‚ ì§œ ë ˆì´ë¸” ìƒì„±
                const labels = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
                }

                // API ë°ì´í„°ì™€ ë‚ ì§œ ë ˆì´ë¸” ë§¤í•‘
                const chartData = labels.map(label => {
                    const [month, day] = label.split('/').map(Number);
                    const record = data.find(d => d.date.month === month && d.date.day === day);
                    return record ? record.count : 0;
                });

                const ctx = document.getElementById('dailyLoginsChart').getContext('2d');
                if (dailyLoginsChartInstance) {
                    dailyLoginsChartInstance.destroy();
                }
                dailyLoginsChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ì¼ì¼ ê³ ìœ  ì ‘ì†ì ìˆ˜',
                            data: chartData,
                            backgroundColor: 'rgba(46, 204, 113, 0.5)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        maintainAspectRatio: false, // ğŸš© [ìˆ˜ì •] ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ê²Œ ë¹„ìœ¨ì„ ì¡°ì •í•˜ë„ë¡ ì„¤ì •
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#ecf0f1', stepSize: 1 } },
                            x: { ticks: { color: '#ecf0f1' } }
                        },
                        plugins: { legend: { labels: { color: '#ecf0f1' } } }
                    }
                });
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function fetchAndRenderPageViewsStats(days = 7) {
            try {
                const response = await fetch(`${API_BASE_URL}/stats/page-views?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('í˜ì´ì§€ ë·° í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

                const stats = await response.json();
                const labelsRaw = Array.isArray(stats.labels) ? stats.labels : [];
                const labels = labelsRaw.map(formatIsoDateForLabel);
                const datasetsInput = Array.isArray(stats.datasets) ? stats.datasets : [];
                const chartColorPalette = ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#e67e22', '#f1c40f', '#1abc9c', '#34495e'];

                const chartDatasets = datasetsInput.map((dataset, idx) => {
                    const { label } = describePagePath(dataset.path);
                    const baseColor = chartColorPalette[idx % chartColorPalette.length];
                    const counts = Array.isArray(dataset.counts) ? dataset.counts : [];
                    const normalizedCounts = labels.map((_, index) => counts[index] || 0);
                    return {
                        label,
                        data: normalizedCounts,
                        borderColor: baseColor,
                        backgroundColor: hexToRgba(baseColor, 0.25),
                        fill: false,
                        tension: 0.2,
                        borderWidth: 2,
                        pointRadius: 3
                    };
                });

                if (chartDatasets.length === 0 && labels.length > 0) {
                    chartDatasets.push({
                        label: 'í˜ì´ì§€ ë·°',
                        data: Array(labels.length).fill(0),
                        borderColor: '#7f8c8d',
                        backgroundColor: hexToRgba('#7f8c8d', 0.2),
                        fill: false,
                        tension: 0.2,
                        borderDash: [6, 6],
                        pointRadius: 0
                    });
                }

                const ctx = document.getElementById('pageViewsChart').getContext('2d');
                if (pageViewsChartInstance) {
                    pageViewsChartInstance.destroy();
                }
                pageViewsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: chartDatasets
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#ecf0f1' } },
                            x: { ticks: { color: '#ecf0f1' } }
                        },
                        plugins: {
                            legend: { labels: { color: '#ecf0f1' } },
                            tooltip: {
                                callbacks: {
                                    title: (items) => items.map(item => labelsRaw[item.dataIndex] || item.label)
                                }
                            }
                        }
                    }
                });

                const summaryBody = document.getElementById('pageViewsSummary');
                summaryBody.innerHTML = '';
                const totals = Array.isArray(stats.totals) ? stats.totals : [];
                if (totals.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="2">ìˆ˜ì§‘ëœ í˜ì´ì§€ ë·° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
                    summaryBody.appendChild(tr);
                } else {
                    totals.slice(0, 10).forEach(item => {
                        const { label, slug } = describePagePath(item.path);
                        const displayName = item.path === 'ê¸°íƒ€' ? label : (label !== slug ? `${label} (${slug})` : label);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${displayName}</td><td>${(item.totalCount || 0).toLocaleString()}</td>`;
                        summaryBody.appendChild(tr);
                    });

                    const otherDataset = datasetsInput.find(dataset => dataset.path === 'ê¸°íƒ€');
                    if (otherDataset) {
                        const otherTotal = (otherDataset.counts || []).reduce((sum, value) => sum + value, 0);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>ê¸°íƒ€ í˜ì´ì§€</td><td>${otherTotal.toLocaleString()}</td>`;
                        summaryBody.appendChild(tr);
                    }
                }

                const summaryNote = document.getElementById('pageViewsSummaryNote');
                if (summaryNote) {
                    summaryNote.textContent = `ìµœê·¼ ${days}ì¼ ë™ì•ˆ ì§‘ê³„ëœ í˜ì´ì§€ ë·° ê¸°ì¤€ì…ë‹ˆë‹¤.`;
                }
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 403) { // ì ‘ê·¼ ê±°ë¶€
                    alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                
                allUsers = await response.json(); // ğŸš© [ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ì— ì‚¬ìš©ì ëª©ë¡ ì €ì¥
                console.log('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œë¨:', allUsers.length, 'ëª…');
                console.log('ì²« ë²ˆì§¸ ì‚¬ìš©ì ìƒ˜í”Œ:', allUsers[0]);
                
                filterAndRenderUsers(); // ğŸš© [ìˆ˜ì •] í•„í„°ë§/ì •ë ¬ í›„ ë Œë”ë§
                renderRegistrationChart(allUsers); // ğŸš© [ì¶”ê°€] ì°¨íŠ¸ ë Œë”ë§
                fetchAndRenderDailyLoginsChart(); // ğŸš© [ì¶”ê°€] ì¼ì¼ ì ‘ì†ì ì°¨íŠ¸ ë Œë”ë§
                
                // ğŸš© [ì¶”ê°€] ì •ë ¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
                initializeSortingListeners();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ì‚¬ìš©ì ë“±ë¡
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value;
            const role = document.getElementById('role').value;
            const position = document.getElementById('position').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password, email, role, position })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                
                showToast('ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('registerForm').reset();
                fetchUsers();
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        // ì‚¬ìš©ì ì‚­ì œ
        window.deleteUser = function(button, userId) {
            showConfirmModal('ì •ë§ë¡œ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
                button.classList.add('loading');
                button.disabled = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    showToast('ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    fetchUsers(); // ì‚­ì œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê³„ì • ì ê¸ˆ/í•´ì œ í† ê¸€
        window.toggleLockStatus = function(button, userId, isCurrentlyLocked) {
            const actionText = isCurrentlyLocked ? 'í•´ì œ' : 'ì ê¸ˆ';
            showConfirmModal(`ì •ë§ë¡œ ì´ ì‚¬ìš©ìì˜ ê³„ì •ì„ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                button.classList.add('loading');
                button.disabled = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}/lock`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ lock: !isCurrentlyLocked })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `ê³„ì • ${actionText}ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                    }
                    showToast(`ì‚¬ìš©ì ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ${actionText}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    const tr = button.closest('tr');
                    tr.classList.toggle('locked', !isCurrentlyLocked);
                    button.textContent = isCurrentlyLocked ? 'ê³„ì • ì ê¸ˆ' : 'ì ê¸ˆ í•´ì œ';
                    button.setAttribute('onclick', `toggleLockStatus(this, '${userId}', ${!isCurrentlyLocked})`);
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            });
        };

        // TODO: ì¼ê´„ ë©”ì¼ ë°œì†¡ ê¸°ëŠ¥ì€ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ê´€ë ¨ í¼ ID 'bulkEmailForm' ì—†ìŒ)
        // ğŸš© [ì¶”ê°€] ëª¨ë‹¬ì˜ 'í™•ì¸ ë° ë°œì†¡' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('confirmEmailSend').addEventListener('click', async () => {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const modal = document.getElementById('emailConfirmModal');
            const confirmBtn = document.getElementById('confirmEmailSend');

            modal.style.display = 'none'; // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            showToast('ë©”ì¼ ë°œì†¡ì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...', 'success');

            confirmBtn.classList.add('loading');
            confirmBtn.disabled = true;

            try {
                // ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ì„ ìœ„í•´ì„œëŠ” ë°±ì—”ë“œì— í•´ë‹¹ API êµ¬í˜„ì´ í•„ìš”í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” ì„±ê³µ/ì‹¤íŒ¨ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.

                // ì•„ë˜ëŠ” ë°±ì—”ë“œ API í˜¸ì¶œ ì˜ˆì‹œì…ë‹ˆë‹¤.
                /*
                const response = await fetch(`${API_BASE_URL}/users/send-bulk-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ subject, body })
                });
                if (!response.ok) throw new Error('ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                */
                
                // ì‹œë®¬ë ˆì´ì…˜ ì„±ê³µ ë©”ì‹œì§€
                setTimeout(() => {
                    showToast('ì „ì²´ ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('bulkEmailForm').reset();
                }, 1000);

            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                // ì‹œë®¬ë ˆì´ì…˜ì´ë¯€ë¡œ setTimeout ì•ˆì— ë„£ì§€ ì•ŠìŒ
                confirmBtn.classList.remove('loading');
                confirmBtn.disabled = false;
            }
        });

        // ğŸš© [ì¶”ê°€] ëª¨ë‹¬ì˜ 'ì·¨ì†Œ' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('cancelEmailSend').addEventListener('click', () => {
            document.getElementById('emailConfirmModal').style.display = 'none';
        });

        // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ ë° í•„í„°ë§ ê¸°ëŠ¥
        const userSearchInput = document.getElementById('userSearchInput');
        const roleFilterSelect = document.getElementById('roleFilterSelect');

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜ ì„ íƒ
        const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
        itemsPerPageSelect.addEventListener('change', () => {
            itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
            currentPage = 1; // í•­ëª© ìˆ˜ê°€ ë°”ë€Œë©´ ì²« í˜ì´ì§€ë¡œ ë¦¬ì…‹
            filterAndRenderUsers();
        });

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredAndSortedUsers.length / itemsPerPage);
            pageInfo.textContent = `í˜ì´ì§€ ${currentPage} / ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        // ğŸš© [ìˆ˜ì •] ê²€ìƒ‰/í•„í„°ë§ í•¨ìˆ˜ì— ì •ë ¬ ë¡œì§ ì¶”ê°€
        function filterAndRenderUsers() {
            const searchTerm = userSearchInput.value.toLowerCase();
            const selectedRole = roleFilterSelect.value;

            // 1. í•„í„°ë§
            let tempUsers = allUsers.filter(user => {
                const matchesSearch = user.username.toLowerCase().includes(searchTerm);
                const matchesRole = selectedRole === 'all' || user.role === selectedRole;
                return matchesSearch && matchesRole;
            });

            // 2. ì •ë ¬
            // filteredAndSortedUsersë¥¼ ì—…ë°ì´íŠ¸í•˜ê¸° ì „ì— ì •ë ¬ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            // ì´ë ‡ê²Œ í•˜ë©´ í˜ì´ì§€ë¥¼ ë„˜ê¸¸ ë•Œë§ˆë‹¤ ì •ë ¬í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            const key = currentSort.key;
            const direction = currentSort.direction === 'asc' ? 1 : -1;

            // ì •ë ¬ ë¡œì§
            tempUsers.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (key === 'lastLogin' || key === 'createdAt') {
                    // 'ê¸°ë¡ ì—†ìŒ' (null) ê°’ì„ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬
                    const dateA = valA ? new Date(valA).getTime() : 0;
                    const dateB = valB ? new Date(valB).getTime() : 0;
                    return (dateA - dateB) * direction;
                } else if (key === 'loginCount') {
                    const numA = Number(valA) || 0;
                    const numB = Number(valB) || 0;
                    return (numA - numB) * direction;
                } else {
                    // ë¬¸ìì—´ ë¹„êµ
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                    if (valA < valB) return -1 * direction;
                    if (valA > valB) return 1 * direction;
                    return 0;
                }
            });

            filteredAndSortedUsers = tempUsers;

            // 3. í˜ì´ì§€ë„¤ì´ì…˜
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsers = filteredAndSortedUsers.slice(startIndex, endIndex);
            renderUsers(paginatedUsers);
            updatePaginationControls();
        }

        // ì´ˆê¸° ë¡œë“œ
        // ğŸš© [ì¶”ê°€] ì •ë ¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeSortingListeners() {
            const userTableHead = document.querySelector('#userTable thead');
            if (!userTableHead) {
                console.error('ì‚¬ìš©ì í…Œì´ë¸” í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const initialSortHeader = userTableHead.querySelector(`th[data-sort-by="${currentSort.key}"]`);
            if (initialSortHeader) {
                initialSortHeader.classList.add(`sort-${currentSort.direction}`);
            }

            userTableHead.addEventListener('click', e => {
                const header = e.target.closest('th.sortable');
                if (!header) return;

                const sortKey = header.dataset.sortBy;
                if (!sortKey) return;

                console.log('ì •ë ¬ ì‹œì‘:', sortKey, 'í˜„ì¬:', currentSort);

                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = 'asc';
                }

                // ëª¨ë“  í—¤ë”ì—ì„œ ì •ë ¬ í´ë˜ìŠ¤ ì œê±°
                userTableHead.querySelectorAll('th.sortable').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                });

                // í˜„ì¬ í—¤ë”ì— ì •ë ¬ í´ë˜ìŠ¤ ì¶”ê°€
                header.classList.add(`sort-${currentSort.direction}`);
                
                currentPage = 1; // ì •ë ¬ ì‹œ ì²« í˜ì´ì§€ë¡œ
                filterAndRenderUsers();
            });
        }

        // ğŸš© [ìˆ˜ì •] í•„í„°/ê²€ìƒ‰ ì‹œ í˜ì´ì§€ë¥¼ 1ë¡œ ë¦¬ì…‹
        userSearchInput.addEventListener('input', () => { currentPage = 1; filterAndRenderUsers(); });
        roleFilterSelect.addEventListener('change', () => { currentPage = 1; filterAndRenderUsers(); });

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                filterAndRenderUsers();
            }
        });
        nextPageBtn.addEventListener('click', () => {
            currentPage++;
            filterAndRenderUsers();
        });

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ ë¡œì§
        const editUserModal = document.getElementById('editUserModal');
        const editUserForm = document.getElementById('editUserForm');

        window.openEditUserModal = (userId) => {
            const user = allUsers.find(u => u._id === userId);
            if (!user) {
                showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            document.getElementById('editUserId').value = user._id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editRole').value = user.role;
            document.getElementById('editPosition').value = user.position || 'ìˆ˜ë¶„ê¶Œì§€';
            document.getElementById('editPassword').value = ''; // ë¹„ë°€ë²ˆí˜¸ í•„ë“œëŠ” í•­ìƒ ë¹„ì›€

            editUserModal.style.display = 'block';
        };

        document.getElementById('cancelUserEdit').addEventListener('click', () => {
            editUserModal.style.display = 'none';
        });

        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const saveBtn = document.getElementById('saveUserEdit');

            const data = {
                username: document.getElementById('editUsername').value,
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value,
                position: document.getElementById('editPosition').value,
            };

            const password = document.getElementById('editPassword').value;
            if (password) {
                data.password = password;
            }

            saveBtn.classList.add('loading');
            saveBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                showToast('ì‚¬ìš©ì ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                editUserModal.style.display = 'none';
                await fetchUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                saveBtn.classList.remove('loading');
                saveBtn.disabled = false;
            }
        });

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ìŠ¤ìœ„ì¹˜ í•¨ìˆ˜
        async function switchToUser(userId) {
            if (!confirm('í•´ë‹¹ ì‚¬ìš©ìë¡œ ìŠ¤ìœ„ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì„¸ì…˜ì´ ë³€ê²½ë©ë‹ˆë‹¤.')) return;
            
            try {
                const response = await fetch(`http://localhost:3000/api/admin/switch-user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.token);
                    showToast('ì‚¬ìš©ìë¡œ ìŠ¤ìœ„ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    const error = await response.json();
                    showToast(error.message || 'ìŠ¤ìœ„ì¹˜ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetchUsers();
        fetchAndRenderPageViewsStats(7); // ìµœê·¼ 7ì¼ í˜ì´ì§€ë·° í†µê³„ ë¡œë“œ

        // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ì„¤ì • ê´€ë¦¬ í•¨ìˆ˜ë“¤
        const layerLabels = {
            city: 'ì„±ë„ì‹œ',
            placeLabel: 'ì§€ëª…',
            countryLabel: 'êµ­ê°€ëª…',
            ethnicLabel: 'ë¯¼ì¡±',
            military: 'êµ°ëŒ€',
            natural: 'ìì—°',
            event: 'ì´ë²¤íŠ¸',
            territoryPolygon: 'ì˜í† ',
            rivers: 'ê°•',
            timeline: 'ì—°ëŒ€í‘œ',
            kingPanel: 'ì™•',
            historyPanel: 'ì—­ì‚¬',
            userContributions: 'ì‚¬ê´€(å²é¤¨)'
        };

        // ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadLayerSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/layer-settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('ë ˆì´ì–´ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();
                renderLayerSettings(data.settings);
            } catch (error) {
                showToast('ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
                // ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ë Œë”ë§
                renderLayerSettings({
                    city: true,
                    placeLabel: false,
                    countryLabel: true,
                    ethnicLabel: false,
                    military: false,
                    natural: false,
                    event: false,
                    territoryPolygon: true,
                    rivers: false,
                    timeline: true,
                    kingPanel: false,
                    historyPanel: false,
                    userContributions: true
                });
            }
        }

        // ë ˆì´ì–´ ì„¤ì • UI ë Œë”ë§
        function renderLayerSettings(settings) {
            const container = document.getElementById('layerSettingsGrid');
            container.innerHTML = '';

            Object.entries(settings).forEach(([layerKey, isEnabled]) => {
                const label = layerLabels[layerKey] || layerKey;
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 4px 8px; background-color: #2c3e50; border-radius: 4px; white-space: nowrap;';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `layer-${layerKey}`;
                checkbox.checked = isEnabled;
                checkbox.dataset.layer = layerKey;

                const labelElement = document.createElement('label');
                labelElement.htmlFor = `layer-${layerKey}`;
                labelElement.textContent = label;
                labelElement.style.cssText = 'color: #ecf0f1; cursor: pointer; font-size: 14px; margin: 0;';

                div.appendChild(checkbox);
                div.appendChild(labelElement);
                container.appendChild(div);
            });
        }

        // ë ˆì´ì–´ ì„¤ì • ì €ì¥
        async function saveLayerSettings() {
            const checkboxes = document.querySelectorAll('#layerSettingsGrid input[type="checkbox"]');
            const settings = {};

            checkboxes.forEach(checkbox => {
                settings[checkbox.dataset.layer] = checkbox.checked;
            });

            try {
                const response = await fetch(`${API_BASE_URL}/layer-settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ settings })
                });

                if (!response.ok) {
                    throw new Error('ë ˆì´ì–´ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                showToast('ë ˆì´ì–´ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                showToast('ë ˆì´ì–´ ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ì„¤ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('saveLayerSettingsBtn').addEventListener('click', saveLayerSettings);

        // ğŸš© [ì¶”ê°€] ì´ˆê¸°í™” ì‹œ ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        loadLayerSettings();

    </script>
</body>
</html>
