<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬</title>
    <!-- ğŸš© [ì¶”ê°€] ë¸Œë¼ìš°ì € íƒ­ ì•„ì´ì½˜(íŒŒë¹„ì½˜) ì„¤ì • -->
    <link rel="icon" type="image/png" href="https://mblogthumb-phinf.pstatic.net/MjAxNzAyMjdfMTY5/MDAxNDg4MTgzMTM3Njgy.kranOyMCE0geFsNMdN3cFzfhswjppZFRoREZIhB_oowg.qK_GkZnrnCj96GOrscX-MxqnbEiStdtpOD8hxeNGLXEg.PNG.ya0705/%EC%9D%B4%EB%AF%B8%EC%A7%80_3-01.png?type=w2">
    <style>
        body {
            background-color: #0c0d15;
        //    background-image: url('https://i.pinimg.com/736x/a3/bb/08/a3bb08156e438a1fa2c8ad66c6ffa667.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #ecf0f1;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #ecf0f1;
            text-shadow: 2px 2px 4px #000;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #2c3e50;
            padding: 20px;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #5d7185;
            text-align: left;
        }
        th {
            background-color: #3e4a56;
        }
        form {
            display: flex; 
            flex-direction: column; /* ğŸš© [ìˆ˜ì •] í¼ ìš”ì†Œë“¤ì„ ìˆ˜ì§ìœ¼ë¡œ ì •ë ¬ */
            gap: 10px;
            margin-bottom: 20px;
        }
        /* ğŸš© [ì¶”ê°€] ë“±ë¡ í¼ì€ ê°€ë¡œ ì •ë ¬ ìœ ì§€ */
        #registerForm {
            flex-direction: row;
        }
        input, select, textarea { /* ğŸš© [ìˆ˜ì •] select, textarea ìŠ¤íƒ€ì¼ ì¶”ê°€ */
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #5d7185;
            background-color: #f0f0f0;
            color: black;
            width: 100%; /* ğŸš© [ì¶”ê°€] ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
            box-sizing: border-box; /* ğŸš© [ì¶”ê°€] íŒ¨ë”©ê³¼ í…Œë‘ë¦¬ë¥¼ ë„ˆë¹„ì— í¬í•¨ */
        }
        button {
            padding: 8px 15px;
            width: auto; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ë„ˆë¹„ë¥¼ ë‚´ìš©ì— ë§ê²Œ ìë™ ì¡°ì • */
            align-self: flex-start; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ì„ ì™¼ìª½ ì •ë ¬ */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #00aaff;
            color: white;
        }
        button.danger {
            background-color: #e74c3c;
        }
        #registerForm button {
            align-self: auto; /* ğŸš© [ì¶”ê°€] ë“±ë¡ í¼ì˜ ë²„íŠ¼ì€ ê¸°ë³¸ ì •ë ¬ ìœ ì§€ */
        }
        .nav-links {
            text-align: center;
            margin-top: 20px;
        }
        .nav-links a {
            color: #ecf0f1; /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
            text-decoration: none;
            margin: 0 10px;
        }
        /* ğŸš© [ì¶”ê°€] ë©”ì¼ ë°œì†¡ ëŒ€ìƒ í™•ì¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: #2c3e50;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #5d7185;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #00aaff;
        }
        #emailRecipientList {
            list-style-type: none;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #3e4a56;
            border: 1px solid #5d7185;
            border-radius: 4px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>íšŒì› ê´€ë¦¬</h1>
    <div class="container">
        <h2>ì‚¬ìš©ì ëª©ë¡</h2>
        <table>
            <thead>
                <tr>
                    <th>ì‚¬ìš©ì ì´ë¦„</th>
                    <th>ì—­í• </th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="userList">
                <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </tbody>
        </table>

        <h2>ìƒˆ ì‚¬ìš©ì ë“±ë¡</h2>
        <form id="registerForm">
            <input type="text" id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" required>
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            <select id="role">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="superuser">Superuser</option>
            </select>
            <button type="submit">ë“±ë¡</button>
        </form>
        <p id="message"></p>

        <hr style="border-color: #5d7185; margin: 30px 0;">

        <h2>ì¼ê´„ ë©”ì¼ ë°œì†¡</h2>
        <form id="bulkEmailForm">
            <input type="text" id="emailSubject" placeholder="ë©”ì¼ ì œëª©" required>
            <textarea id="emailBody" rows="5" placeholder="ë©”ì¼ ë‚´ìš©" required></textarea>
            <button type="submit">ì „ì²´ ë°œì†¡</button>
        </form>

        <!-- ğŸš© [ì¶”ê°€] ë©”ì¼ ë°œì†¡ ëŒ€ìƒ í™•ì¸ ëª¨ë‹¬ -->
        <div id="emailConfirmModal" class="modal">
            <div class="modal-content">
                <h3>ë©”ì¼ ë°œì†¡ ëŒ€ìƒ í™•ì¸</h3>
                <p><strong id="emailConfirmSubject"></strong> ì œëª©ìœ¼ë¡œ ì•„ë˜ ì‚¬ìš©ìë“¤ì—ê²Œ ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                <ul id="emailRecipientList">
                    <!-- ë°œì†¡ ëŒ€ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </ul>
                <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="cancelEmailSend" class="danger">ì·¨ì†Œ</button>
                    <button type="button" id="confirmEmailSend" class="primary">í™•ì¸ ë° ë°œì†¡</button>
                </div>
            </div>
        </div>
    </div>
    <div class="nav-links">
        <a href="index.html" class="button-style primary">ë©”ì¸ ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api'; 
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');

        // í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let allUsers = []; // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ëª©ë¡ì„ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

        // ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 403) {
                    alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                
                allUsers = await response.json(); // ğŸš© [ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ì— ì‚¬ìš©ì ëª©ë¡ ì €ì¥
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                allUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    // ğŸš© [ìˆ˜ì •] ì—­í• (role)ì„ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” select ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë³€ê²½
                    tr.innerHTML = `
                        <td>${user.username}</td>
                        <td>
                            <select onchange="updateUserRole('${user._id}', this.value)">
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="superuser" ${user.role === 'superuser' ? 'selected' : ''}>Superuser</option>
                            </select>
                        </td>
                        <td>
                            <button class="danger" onclick="deleteUser('${user._id}')">ì‚­ì œ</button> 
                            <!-- ğŸš© [ì°¸ê³ ] ì—­í•  ìˆ˜ì • ë²„íŠ¼ì€ select onchangeë¡œ ëŒ€ì²´ë˜ì–´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
                            <button onclick="editUserRole('${user._id}')">ì—­í•  ìˆ˜ì •</button> -->
                        </td>
                    `;
                    userList.appendChild(tr);
                });
            } catch (error) {
                document.getElementById('message').textContent = error.message;
            }
        }

        // ì‚¬ìš©ì ë“±ë¡
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const messageEl = document.getElementById('message');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password, role })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                
                messageEl.textContent = 'ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
                document.getElementById('registerForm').reset();
                fetchUsers();
            } catch (error) {
                messageEl.textContent = error.message;
            }
        });

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì—­í•  ìˆ˜ì •
        window.updateUserRole = async function(userId, newRole) {
            const messageEl = document.getElementById('message');
            if (!confirm(`ì‚¬ìš©ìì˜ ì—­í• ì„ '${newRole}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                fetchUsers(); // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ë©´, selectë¥¼ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸° ìœ„í•´ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ role: newRole })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                messageEl.textContent = 'ì‚¬ìš©ì ì—­í• ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
                fetchUsers(); // ë³€ê²½ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                messageEl.textContent = `ì—­í•  ë³€ê²½ ì‹¤íŒ¨: ${error.message}`;
            }
        }
        // ì‚¬ìš©ì ì‚­ì œ
        window.deleteUser = async function(userId) {
            if (!confirm('ì •ë§ë¡œ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                fetchUsers();
            } catch (error) {
                document.getElementById('message').textContent = error.message;
            }
        }

        // ì¼ê´„ ë©”ì¼ ë°œì†¡
        document.getElementById('bulkEmailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const messageEl = document.getElementById('message');
            
            // ğŸš© [ìˆ˜ì •] ëª¨ë‹¬ì°½ì— ë°œì†¡ ëŒ€ìƒ ëª©ë¡ í‘œì‹œ
            const modal = document.getElementById('emailConfirmModal');
            const recipientList = document.getElementById('emailRecipientList');
            const confirmSubject = document.getElementById('emailConfirmSubject');

            confirmSubject.textContent = `'${subject}'`;
            recipientList.innerHTML = allUsers.map(user => `<li>${user.username}</li>`).join('');
            modal.style.display = 'block';
        });

        // ğŸš© [ì¶”ê°€] ëª¨ë‹¬ì˜ 'í™•ì¸ ë° ë°œì†¡' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('confirmEmailSend').addEventListener('click', async () => {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const messageEl = document.getElementById('message');
            const modal = document.getElementById('emailConfirmModal');

            modal.style.display = 'none'; // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            messageEl.textContent = 'ë©”ì¼ ë°œì†¡ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤...';

            try {
                // ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ì„ ìœ„í•´ì„œëŠ” ë°±ì—”ë“œì— í•´ë‹¹ API êµ¬í˜„ì´ í•„ìš”í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” ì„±ê³µ/ì‹¤íŒ¨ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.

                // ì•„ë˜ëŠ” ë°±ì—”ë“œ API í˜¸ì¶œ ì˜ˆì‹œì…ë‹ˆë‹¤.
                /*
                const response = await fetch(`${API_BASE_URL}/users/send-bulk-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ subject, body })
                });
                if (!response.ok) throw new Error('ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                */
                
                // ì‹œë®¬ë ˆì´ì…˜ ì„±ê³µ ë©”ì‹œì§€
                setTimeout(() => {
                    messageEl.textContent = 'ì „ì²´ ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    document.getElementById('bulkEmailForm').reset();
                }, 1000);

            } catch (error) {
                messageEl.textContent = error.message;
            }
        });

        // ğŸš© [ì¶”ê°€] ëª¨ë‹¬ì˜ 'ì·¨ì†Œ' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('cancelEmailSend').addEventListener('click', () => {
            document.getElementById('emailConfirmModal').style.display = 'none';
        });

        // ì´ˆê¸° ë¡œë“œ
        fetchUsers();
    </script>
</body>
</html>
