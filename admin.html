<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬</title>
    <!-- ğŸš© [ì¶”ê°€] Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ğŸš© [ì¶”ê°€] ë¸Œë¼ìš°ì € íƒ­ ì•„ì´ì½˜(íŒŒë¹„ì½˜) ì„¤ì • -->
    <link rel="icon" type="image/png" href="https://mblogthumb-phinf.pstatic.net/MjAxNzAyMjdfMTY5/MDAxNDg4MTgzMTM3Njgy.kranOyMCE0geFsNMdN3cFzfhswjppZFRoREZIhB_oowg.qK_GkZnrnCj96GOrscX-MxqnbEiStdtpOD8hxeNGLXEg.PNG.ya0705/%EC%9D%B4%EB%AF%B8%EC%A7%80_3-01.png?type=w2">
    <style>
        body {
            background-color: #0c0d15;
        //    background-image: url('https://i.pinimg.com/736x/a3/bb/08/a3bb08156e438a1fa2c8ad66c6ffa667.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #ecf0f1;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #ecf0f1;
            text-shadow: 2px 2px 4px #000;
        }
        /* ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê²€ìƒ‰/í•„í„° ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        #user-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* ğŸš© [ì¶”ê°€] ì»¨íŠ¸ë¡¤ì´ ì—¬ëŸ¬ ì¤„ë¡œ ë‚˜ë‰˜ë„ë¡ í—ˆìš© */
            align-items: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #2c3e50;
            padding: 20px;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #5d7185;
            text-align: left;
        }
        th {
            background-color: #3e4a56;
        }
        form {
            display: flex; 
            flex-direction: column; /* ğŸš© [ìˆ˜ì •] í¼ ìš”ì†Œë“¤ì„ ìˆ˜ì§ìœ¼ë¡œ ì •ë ¬ */
            gap: 10px;
            margin-bottom: 20px;
        }
        /* ğŸš© [ì¶”ê°€] ë“±ë¡ í¼ì€ ê°€ë¡œ ì •ë ¬ ìœ ì§€ */
        #registerForm {
            flex-direction: row; /* ê°€ë¡œ ì •ë ¬ ìœ ì§€ */
            align-items: flex-end; /* ìš”ì†Œë“¤ì„ í•˜ë‹¨ì— ì •ë ¬ */
            gap: 15px; /* ìš”ì†Œ ê°„ ê°„ê²© ì¡°ì • */
        }
        input, select, textarea { /* ğŸš© [ìˆ˜ì •] select, textarea ìŠ¤íƒ€ì¼ ì¶”ê°€ */
            padding: 8px;
            border-radius: 4px; 
            border: 1px solid #5d7185;
            background-color: #f0f0f0;
            color: black;
            width: 100%; /* ğŸš© [ì¶”ê°€] ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
            box-sizing: border-box; /* ğŸš© [ì¶”ê°€] íŒ¨ë”©ê³¼ í…Œë‘ë¦¬ë¥¼ ë„ˆë¹„ì— í¬í•¨ */
        }
        button {
            padding: 8px 15px;
            width: auto; 
            align-self: flex-start; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ì„ ì™¼ìª½ ì •ë ¬ */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #00aaff;
            color: white;
        }
        button.danger {
            background-color: #e74c3c;
        }
        #registerForm button {
            align-self: flex-end; /* ğŸš© [ìˆ˜ì •] ë“±ë¡ í¼ì˜ ë²„íŠ¼ë„ í•˜ë‹¨ ì •ë ¬ */
            padding: 9px 15px; /* ğŸš© [ìˆ˜ì •] ë‹¤ë¥¸ inputê³¼ ë†’ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ íŒ¨ë”© ì¡°ì • */
        }
        /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ ë¡œë”© ìƒíƒœ */
        button.loading {
            position: relative;
            color: transparent !important;
        }
        button.loading::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 16px; height: 16px;
            margin-top: -8px; margin-left: -8px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .nav-links {
            text-align: center;
            margin-top: 20px;
        }
        .nav-links a {
            color: #ecf0f1; /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
            text-decoration: none;
            margin: 0 10px;
        }
        /* ğŸš© [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        .toast.success { background-color: #27ae60; }
        .toast.error { background-color: #c0392b; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: #2c3e50;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #5d7185;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #00aaff;
        }
        #emailRecipientList {
            list-style-type: none;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #3e4a56;
            border: 1px solid #5d7185;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        /* ğŸš© [ì¶”ê°€] í™•ì¸ ëª¨ë‹¬ì˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        #confirmModalMessage {
            margin-bottom: 20px;
        }
        /* ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        #pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        #pagination-controls button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* ğŸš© [ì¶”ê°€] ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #chartContainer {
            width: 100%;
            margin-bottom: 30px;
            background-color: #3e4a56;
            padding: 20px; border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>íšŒì› ê´€ë¦¬</h1>
    <div class="container">
        <h2>ì‚¬ìš©ì ë“±ë¡ í˜„í™©</h2>
        <!-- ğŸš© [ì¶”ê°€] ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
        <div id="chartContainer">
            <canvas id="registrationChart"></canvas>
        </div>

        <h2>ì‚¬ìš©ì ëª©ë¡</h2>
        <!-- ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê²€ìƒ‰ ë° í•„í„° ì»¨íŠ¸ë¡¤ -->
        <div id="user-controls">
            <input type="text" id="userSearchInput" placeholder="ì‚¬ìš©ì ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." style="width: 250px;">
            <select id="roleFilterSelect" style="width: 180px;">
                <option value="all">-- ëª¨ë“  ì—­í•  --</option>
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="superuser">Superuser</option>
            </select>
            <label for="itemsPerPageSelect" style="color: #ecf0f1; font-weight: normal;">í•­ëª© ìˆ˜:</label>
            <select id="itemsPerPageSelect" style="width: 80px;">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
        </div>
        <table>
            <thead>
                <tr>
                    <th class="sortable" data-sort-by="username">ì‚¬ìš©ì ì´ë¦„</th>
                    <th class="sortable" data-sort-by="lastLogin">ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                    <th class="sortable" data-sort-by="role">ì—­í• </th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="userList">
                <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </tbody>
        </table>

        <!-- ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ -->
        <div id="pagination-controls">
            <button id="prevPageBtn">ì´ì „</button>
            <span id="pageInfo"></span>
            <button id="nextPageBtn">ë‹¤ìŒ</button>
        </div>

        <h2>ìƒˆ ì‚¬ìš©ì ë“±ë¡</h2>
        <form id="registerForm">
            <input type="text" id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" required>
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            <select id="role">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="superuser">Superuser</option>
            </select>
            <button type="submit">ë“±ë¡</button>
        </form>

        <hr style="border-color: #5d7185; margin: 30px 0;">

        <h2>ì¼ê´„ ë©”ì¼ ë°œì†¡</h2>
        <form id="bulkEmailForm">
            <input type="text" id="emailSubject" placeholder="ë©”ì¼ ì œëª©" required>
            <textarea id="emailBody" rows="5" placeholder="ë©”ì¼ ë‚´ìš©" required></textarea>
            <button type="submit">ì „ì²´ ë°œì†¡</button>
        </form>

        <!-- ğŸš© [ì¶”ê°€] ë©”ì¼ ë°œì†¡ ëŒ€ìƒ í™•ì¸ ëª¨ë‹¬ -->
        <div id="emailConfirmModal" class="modal">
            <div class="modal-content">
                <h3>ë©”ì¼ ë°œì†¡ ëŒ€ìƒ í™•ì¸</h3>
                <p><strong id="emailConfirmSubject"></strong> ì œëª©ìœ¼ë¡œ ì•„ë˜ ì‚¬ìš©ìë“¤ì—ê²Œ ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                <ul id="emailRecipientList">
                    <!-- ë°œì†¡ ëŒ€ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </ul>
                <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="cancelEmailSend" class="danger">ì·¨ì†Œ</button>
                    <button type="button" id="confirmEmailSend" class="primary">í™•ì¸ ë° ë°œì†¡</button>
                </div>
            </div>
        </div>

        <!-- ğŸš© [ì¶”ê°€] ë²”ìš© í™•ì¸ ëª¨ë‹¬ -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h3>ì‘ì—… í™•ì¸</h3>
                <p id="confirmModalMessage"></p>
                <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="cancelConfirm" class="danger">ì·¨ì†Œ</button>
                    <button type="button" id="confirmAction" class="primary">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>
    <div class="nav-links">
        <a href="index.html" class="button-style primary">ë©”ì¸ ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <!-- ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="toastContainer"></div>


    <script>
        const API_BASE_URL = '/api'; // ğŸ’¡ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');

        // í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        let allUsers = []; // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ëª©ë¡ì„ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        // ğŸš© [ì¶”ê°€] ì •ë ¬ ìƒíƒœë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        let currentSort = {
            key: 'username',
            direction: 'asc'
        };
        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ ë³€ìˆ˜
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredAndSortedUsers = []; // í•„í„°ë§ ë° ì •ë ¬ëœ ì „ì²´ ì‚¬ìš©ì ëª©ë¡

        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');


        // ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ğŸš© [ì¶”ê°€] ë²”ìš© í™•ì¸ ëª¨ë‹¬ í•¨ìˆ˜
        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmModalMessage').textContent = message;
            modal.style.display = 'block';

            const confirmBtn = document.getElementById('confirmAction');
            const cancelBtn = document.getElementById('cancelConfirm');

            const confirmHandler = () => {
                modal.style.display = 'none';
                onConfirm();
                cleanup();
            };

            const cancelHandler = () => {
                modal.style.display = 'none';
                cleanup();
            };

            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ëª©ë¡ì„ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderUsers(usersToRender) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            usersToRender.forEach(user => { 
                const tr = document.createElement('tr');
                if (user.isLocked) {
                    tr.classList.add('locked');
                }
                const lastLogin = user.lastLogin 
                    ? new Date(user.lastLogin).toLocaleString() 
                    : 'ê¸°ë¡ ì—†ìŒ';
                tr.innerHTML = ` 
                    <td>${user.username}</td>
                    <td>${lastLogin}</td>
                    <td>
                        <select onchange="updateUserRole(this, '${user._id}', '${user.role}')" data-userid="${user._id}">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="superuser" ${user.role === 'superuser' ? 'selected' : ''}>Superuser</option>
                        </select>
                    </td>
                    <td>
                        <button class="button lock-btn" onclick="toggleLockStatus(this, '${user._id}', ${user.isLocked || false})">${user.isLocked ? 'ì ê¸ˆ í•´ì œ' : 'ê³„ì • ì ê¸ˆ'}</button>
                        <button class="button" onclick="requestPasswordReset(this, '${user.username}')">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
                        <button class="button danger" onclick="deleteUser(this, '${user._id}')">ì‚­ì œ</button>
                    </td>
                `;
                userList.appendChild(tr);
            });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ë“±ë¡ ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜
        let registrationChartInstance = null;
        function renderRegistrationChart(users) {
            if (!users || users.length === 0) return;

            const monthlyCounts = {};

            users.forEach(user => {
                // ObjectIdì—ì„œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì¶œ
                const timestamp = new Date(parseInt(user._id.substring(0, 8), 16) * 1000);
                const year = timestamp.getFullYear();
                const month = (timestamp.getMonth() + 1).toString().padStart(2, '0');
                const yearMonth = `${year}-${month}`;

                if (!monthlyCounts[yearMonth]) {
                    monthlyCounts[yearMonth] = 0;
                }
                monthlyCounts[yearMonth]++;
            });

            const sortedMonths = Object.keys(monthlyCounts).sort();
            const labels = sortedMonths;
            const data = sortedMonths.map(month => monthlyCounts[month]);

            const ctx = document.getElementById('registrationChart').getContext('2d');
            
            if (registrationChartInstance) {
                registrationChartInstance.destroy();
            }

            registrationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì›”ë³„ ì‹ ê·œ ê°€ì…ì ìˆ˜',
                        data: data,
                        backgroundColor: 'rgba(0, 170, 255, 0.2)',
                        borderColor: 'rgba(0, 170, 255, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, ticks: { color: '#ecf0f1' } }, x: { ticks: { color: '#ecf0f1' } } },
                    plugins: { legend: { labels: { color: '#ecf0f1' } } }
                }
            });
        }

        // ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 403) { // ì ‘ê·¼ ê±°ë¶€
                    alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                
                allUsers = await response.json(); // ğŸš© [ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ì— ì‚¬ìš©ì ëª©ë¡ ì €ì¥
                filterAndRenderUsers(); // ğŸš© [ìˆ˜ì •] í•„í„°ë§/ì •ë ¬ í›„ ë Œë”ë§
                renderRegistrationChart(allUsers); // ğŸš© [ì¶”ê°€] ì°¨íŠ¸ ë Œë”ë§

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ì‚¬ìš©ì ë“±ë¡
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password, role })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                
                showToast('ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('registerForm').reset();
                fetchUsers();
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì—­í•  ìˆ˜ì •
        window.updateUserRole = function(selectElement, userId, oldRole) {
            const newRole = selectElement.value;
            showConfirmModal(`ì‚¬ìš©ìì˜ ì—­í• ì„ '${newRole}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}/role`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ role: newRole })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    showToast('ì‚¬ìš©ì ì—­í• ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // ì„±ê³µ ì‹œ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•  í•„ìš” ì—†ì´ oldRoleì„ ì—…ë°ì´íŠ¸
                    selectElement.setAttribute('onchange', `updateUserRole(this, '${userId}', '${newRole}')`);
                } catch (error) {
                    showToast(`ì—­í•  ë³€ê²½ ì‹¤íŒ¨: ${error.message}`, 'error');
                    selectElement.value = oldRole; // ì‹¤íŒ¨ ì‹œ ì›ë˜ ì—­í• ë¡œ ë˜ëŒë¦¼
                }
            });
            // ì‚¬ìš©ìê°€ ëª¨ë‹¬ì—ì„œ 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥´ë©´, onConfirmì´ ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
            // select ê°’ì€ onchangeì— ì˜í•´ ì´ë¯¸ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ, ì·¨ì†Œ ì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë ¤ì•¼ í•¨
            document.getElementById('cancelConfirm').addEventListener('click', () => {
                selectElement.value = oldRole;
            }, { once: true });
        }
        // ì‚¬ìš©ì ì‚­ì œ
        window.deleteUser = function(button, userId) {
            showConfirmModal('ì •ë§ë¡œ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
                button.classList.add('loading');
                button.disabled = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    showToast('ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    fetchUsers(); // ì‚­ì œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê³„ì • ì ê¸ˆ/í•´ì œ í† ê¸€
        window.toggleLockStatus = function(button, userId, isCurrentlyLocked) {
            const actionText = isCurrentlyLocked ? 'í•´ì œ' : 'ì ê¸ˆ';
            showConfirmModal(`ì •ë§ë¡œ ì´ ì‚¬ìš©ìì˜ ê³„ì •ì„ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                button.classList.add('loading');
                button.disabled = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}/lock`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ lock: !isCurrentlyLocked })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `ê³„ì • ${actionText}ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                    }
                    showToast(`ì‚¬ìš©ì ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ${actionText}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    const tr = button.closest('tr');
                    tr.classList.toggle('locked', !isCurrentlyLocked);
                    button.textContent = isCurrentlyLocked ? 'ê³„ì • ì ê¸ˆ' : 'ì ê¸ˆ í•´ì œ';
                    button.setAttribute('onclick', `toggleLockStatus(this, '${userId}', ${!isCurrentlyLocked})`);
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            });
        };

        // ğŸš© [ì¶”ê°€] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ë°œì†¡ ìš”ì²­
        window.requestPasswordReset = function(button, username) {
            showConfirmModal(`'${username}' ì‚¬ìš©ìì—ê²Œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                button.classList.add('loading');
                button.disabled = true;
                try {
                    // ë°±ì—”ë“œì— ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ APIê°€ êµ¬í˜„ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
                    const response = await fetch(`${API_BASE_URL}/auth/request-password-reset`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ username: username })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'ì¬ì„¤ì • ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    showToast(`'${username}' ì‚¬ìš©ìì—ê²Œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            });
        };

        // ì¼ê´„ ë©”ì¼ ë°œì†¡
        document.getElementById('bulkEmailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            
            // ğŸš© [ìˆ˜ì •] ëª¨ë‹¬ì°½ì— ë°œì†¡ ëŒ€ìƒ ëª©ë¡ í‘œì‹œ
            const modal = document.getElementById('emailConfirmModal');
            const recipientList = document.getElementById('emailRecipientList');
            const confirmSubject = document.getElementById('emailConfirmSubject');

            confirmSubject.textContent = `'${subject}'`;
            recipientList.innerHTML = allUsers.map(user => `<li>${user.username}</li>`).join('');
            modal.style.display = 'block';
        });

        // ğŸš© [ì¶”ê°€] ëª¨ë‹¬ì˜ 'í™•ì¸ ë° ë°œì†¡' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('confirmEmailSend').addEventListener('click', async () => {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const modal = document.getElementById('emailConfirmModal');
            const confirmBtn = document.getElementById('confirmEmailSend');

            modal.style.display = 'none'; // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            showToast('ë©”ì¼ ë°œì†¡ì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...', 'success');

            confirmBtn.classList.add('loading');
            confirmBtn.disabled = true;

            try {
                // ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ì„ ìœ„í•´ì„œëŠ” ë°±ì—”ë“œì— í•´ë‹¹ API êµ¬í˜„ì´ í•„ìš”í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” ì„±ê³µ/ì‹¤íŒ¨ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.

                // ì•„ë˜ëŠ” ë°±ì—”ë“œ API í˜¸ì¶œ ì˜ˆì‹œì…ë‹ˆë‹¤.
                /*
                const response = await fetch(`${API_BASE_URL}/users/send-bulk-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ subject, body })
                });
                if (!response.ok) throw new Error('ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                */
                
                // ì‹œë®¬ë ˆì´ì…˜ ì„±ê³µ ë©”ì‹œì§€
                setTimeout(() => {
                    showToast('ì „ì²´ ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('bulkEmailForm').reset();
                }, 1000);

            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                // ì‹œë®¬ë ˆì´ì…˜ì´ë¯€ë¡œ setTimeout ì•ˆì— ë„£ì§€ ì•ŠìŒ
                confirmBtn.classList.remove('loading');
                confirmBtn.disabled = false;
            }
        });

        // ğŸš© [ì¶”ê°€] ëª¨ë‹¬ì˜ 'ì·¨ì†Œ' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('cancelEmailSend').addEventListener('click', () => {
            document.getElementById('emailConfirmModal').style.display = 'none';
        });

        // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ ë° í•„í„°ë§ ê¸°ëŠ¥
        const userSearchInput = document.getElementById('userSearchInput');
        const roleFilterSelect = document.getElementById('roleFilterSelect');

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜ ì„ íƒ
        const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
        itemsPerPageSelect.addEventListener('change', () => {
            itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
            currentPage = 1; // í•­ëª© ìˆ˜ê°€ ë°”ë€Œë©´ ì²« í˜ì´ì§€ë¡œ ë¦¬ì…‹
            filterAndRenderUsers();
        });

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredAndSortedUsers.length / itemsPerPage);
            pageInfo.textContent = `í˜ì´ì§€ ${currentPage} / ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        // ğŸš© [ìˆ˜ì •] ê²€ìƒ‰/í•„í„°ë§ í•¨ìˆ˜ì— ì •ë ¬ ë¡œì§ ì¶”ê°€
        function filterAndRenderUsers() {
            const searchTerm = userSearchInput.value.toLowerCase();
            const selectedRole = roleFilterSelect.value;

            // 1. í•„í„°ë§
            let tempUsers = allUsers.filter(user => {
                const matchesSearch = user.username.toLowerCase().includes(searchTerm);
                const matchesRole = selectedRole === 'all' || user.role === selectedRole;
                return matchesSearch && matchesRole;
            });

            // 2. ì •ë ¬
            // filteredAndSortedUsersë¥¼ ì—…ë°ì´íŠ¸í•˜ê¸° ì „ì— ì •ë ¬ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            // ì´ë ‡ê²Œ í•˜ë©´ í˜ì´ì§€ë¥¼ ë„˜ê¸¸ ë•Œë§ˆë‹¤ ì •ë ¬í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            const key = currentSort.key;
            const direction = currentSort.direction === 'asc' ? 1 : -1;

            // ì •ë ¬ ë¡œì§
            tempUsers.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (key === 'lastLogin') {
                    // 'ê¸°ë¡ ì—†ìŒ' (null) ê°’ì„ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬
                    valA = valA ? new Date(valA).getTime() : -Infinity;
                    valB = valB ? new Date(valB).getTime() : -Infinity;
                } else {
                    // ë¬¸ìì—´ ë¹„êµ
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                }

                if (valA < valB) {
                    return -1 * direction;
                }
                if (valA > valB) {
                    return 1 * direction;
                }
                return 0;
            });

            filteredAndSortedUsers = tempUsers;

            // 3. í˜ì´ì§€ë„¤ì´ì…˜
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsers = filteredAndSortedUsers.slice(startIndex, endIndex);
            renderUsers(paginatedUsers);
            updatePaginationControls();
        }

        userSearchInput.addEventListener('input', filterAndRenderUsers);
        roleFilterSelect.addEventListener('change', filterAndRenderUsers);

        // ì´ˆê¸° ë¡œë“œ
        // ğŸš© [ì¶”ê°€] í…Œì´ë¸” í—¤ë” í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì •ë ¬ìš©)
        // ğŸš© [ìˆ˜ì •] í•„í„°/ê²€ìƒ‰ ì‹œ í˜ì´ì§€ë¥¼ 1ë¡œ ë¦¬ì…‹
        userSearchInput.addEventListener('input', () => { currentPage = 1; filterAndRenderUsers(); });
        roleFilterSelect.addEventListener('change', () => { currentPage = 1; filterAndRenderUsers(); });

        document.querySelector('thead').addEventListener('click', e => {
            const header = e.target.closest('th.sortable');
            if (!header) return;

            const sortKey = header.dataset.sortBy;

            if (currentSort.key === sortKey) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = sortKey;
                currentSort.direction = 'asc';
            }

            // ëª¨ë“  í—¤ë”ì—ì„œ ì •ë ¬ í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // í˜„ì¬ í—¤ë”ì— ì •ë ¬ í´ë˜ìŠ¤ ì¶”ê°€
            header.classList.add(`sort-${currentSort.direction}`);
            filterAndRenderUsers();
        });

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                filterAndRenderUsers();
            }
        });
        nextPageBtn.addEventListener('click', () => {
            currentPage++;
            filterAndRenderUsers();
        });
        fetchUsers();
    </script>
</body>
</html>
