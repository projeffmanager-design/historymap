<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬</title>
    <!-- ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ë°˜ì‘í˜•ì„ ìœ„í•œ ë·°í¬íŠ¸ ë©”íƒ€ íƒœê·¸ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ğŸš© [ì¶”ê°€] Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ğŸš© [ì¶”ê°€] ë¸Œë¼ìš°ì € íƒ­ ì•„ì´ì½˜(íŒŒë¹„ì½˜) ì„¤ì • -->
    <link rel="icon" type="image/png" href="https://mblogthumb-phinf.pstatic.net/MjAxNzAyMjdfMTY5/MDAxNDg4MTgzMTM3Njgy.kranOyMCE0geFsNMdN3cFzfhswjppZFRoREZIhB_oowg.qK_GkZnrnCj96GOrscX-MxqnbEiStdtpOD8hxeNGLXEg.PNG.ya0705/%EC%9D%B4%EB%AF%B8%EC%A7%80_3-01.png?type=w2">
    <style>
        body {
            background-color: #0c0d15;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #ecf0f1;
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
        }
        
        /* ğŸš© [ì¶”ê°€] íŒì—… ì „ìš© í—¤ë” */
        .popup-header {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .popup-header h1 {
            margin: 0;
            font-size: 1.8em;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        h1, h2 {
            text-align: center;
            color: #ecf0f1;
            text-shadow: 2px 2px 4px #000;
        }
        /* ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê²€ìƒ‰/í•„í„° ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        #user-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* ğŸš© [ì¶”ê°€] ì»¨íŠ¸ë¡¤ì´ ì—¬ëŸ¬ ì¤„ë¡œ ë‚˜ë‰˜ë„ë¡ í—ˆìš© */
            align-items: center;
        }
        .container {
            max-width: 100%; /* ğŸš© [ìˆ˜ì •] íŒì—…ì—ì„œ ì „ì²´ ë„ˆë¹„ í™œìš© */
            margin: 0 auto;
            background: #2c3e50;
            padding: 20px;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #5d7185;
            text-align: left;
        }
        /* ğŸš© [ì¶”ê°€] ì‘ì—… ë²„íŠ¼ ì…€ì´ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
        td:last-child {
            white-space: nowrap;
        }
        th {
            background-color: #3e4a56;
        }
        /* ğŸš© [ì¶”ê°€] ì •ë ¬ ê°€ëŠ¥í•œ í…Œì´ë¸” í—¤ë” ìŠ¤íƒ€ì¼ */
        th.sortable {
            cursor: pointer;
            position: relative;
        }
        th.sortable.sort-asc::after {
            content: ' â–²';
            opacity: 1;
        }
        th.sortable.sort-desc::after {
            content: ' â–¼';
            opacity: 1;
        }
        form {
            display: flex; 
            flex-direction: column; /* ğŸš© [ìˆ˜ì •] í¼ ìš”ì†Œë“¤ì„ ìˆ˜ì§ìœ¼ë¡œ ì •ë ¬ */
            gap: 10px;
            margin-bottom: 20px;
        }
        /* ğŸš© [ì¶”ê°€] ë“±ë¡ í¼ì€ ê°€ë¡œ ì •ë ¬ ìœ ì§€ */
        #registerForm {
            flex-direction: row; /* ê°€ë¡œ ì •ë ¬ ìœ ì§€ */
            align-items: flex-end; /* ìš”ì†Œë“¤ì„ í•˜ë‹¨ì— ì •ë ¬ */
            gap: 15px; /* ìš”ì†Œ ê°„ ê°„ê²© ì¡°ì • */
        }
        input, select, textarea { /* ğŸš© [ìˆ˜ì •] select, textarea ìŠ¤íƒ€ì¼ ì¶”ê°€ */
            padding: 8px;
            border-radius: 4px; 
            border: 1px solid #5d7185;
            background-color: #f0f0f0;
            color: black;
            width: 100%; /* ğŸš© [ì¶”ê°€] ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
            box-sizing: border-box; /* ğŸš© [ì¶”ê°€] íŒ¨ë”©ê³¼ í…Œë‘ë¦¬ë¥¼ ë„ˆë¹„ì— í¬í•¨ */
        }
        button {
            padding: 8px 15px;
            width: auto; 
            align-self: flex-start; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ì„ ì™¼ìª½ ì •ë ¬ */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #00aaff;
            color: white;
        }
        button.danger {
            background-color: #e74c3c;
        }
        #registerForm button {
            align-self: flex-end; /* ğŸš© [ìˆ˜ì •] ë“±ë¡ í¼ì˜ ë²„íŠ¼ë„ í•˜ë‹¨ ì •ë ¬ */
            padding: 9px 15px; /* ğŸš© [ìˆ˜ì •] ë‹¤ë¥¸ inputê³¼ ë†’ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ íŒ¨ë”© ì¡°ì • */
        }
        /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ ë¡œë”© ìƒíƒœ */
        button.loading {
            position: relative;
            color: transparent !important;
        }
        button.loading::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 16px; height: 16px;
            margin-top: -8px; margin-left: -8px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .nav-links {
            text-align: center;
            margin-top: 20px;
        }
        .nav-links a {
            color: #ecf0f1; /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
            text-decoration: none;
            margin: 0 10px;
        }
        /* ğŸš© [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        .toast.success { background-color: #27ae60; }
        .toast.error { background-color: #c0392b; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: #2c3e50;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #5d7185;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #00aaff;
        }
        #emailRecipientList {
            list-style-type: none;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #3e4a56;
            border: 1px solid #5d7185;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        /* ğŸš© [ì¶”ê°€] í™•ì¸ ëª¨ë‹¬ì˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        #confirmModalMessage {
            margin-bottom: 20px;
        }
        /* ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        #pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        #pagination-controls button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* â”€â”€ ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ â”€â”€ */
        #dashboard {
            margin-bottom: 30px;
        }
        .dash-kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .kpi-card {
            background: linear-gradient(135deg, #1e2a38 0%, #2c3e50 100%);
            border: 1px solid #3a4f63;
            border-radius: 10px;
            padding: 16px 18px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }
        .kpi-card.blue::before  { background: #00aaff; }
        .kpi-card.green::before { background: #2ecc71; }
        .kpi-card.orange::before{ background: #e67e22; }
        .kpi-card.purple::before{ background: #9b59b6; }
        .kpi-card.red::before   { background: #e74c3c; }
        .kpi-card.teal::before  { background: #1abc9c; }
        .kpi-card.yellow::before{ background: #f1c40f; }
        .kpi-card.pink::before  { background: #e91e63; }
        .kpi-label {
            font-size: 0.72em;
            color: #8fa8c0;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .kpi-value {
            font-size: 2em;
            font-weight: 700;
            color: #ecf0f1;
            line-height: 1;
        }
        .kpi-sub {
            font-size: 0.75em;
            color: #7f8c9a;
        }
        .kpi-icon {
            position: absolute;
            right: 14px; top: 12px;
            font-size: 1.6em;
            opacity: 0.25;
        }
        .dash-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .dash-charts-grid.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }
        .chart-card {
            background: #1e2a38;
            border: 1px solid #3a4f63;
            border-radius: 10px;
            padding: 16px 18px;
        }
        .chart-card h3 {
            margin: 0 0 12px;
            font-size: 0.82em;
            color: #8fa8c0;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            text-align: left;
            text-shadow: none;
        }
        .chart-card .chart-wrap {
            position: relative;
            height: 180px;
        }
        .chart-card.tall .chart-wrap {
            height: 220px;
        }
        /* ì‚¬ê´€ ë­í‚¹ í…Œì´ë¸” */
        .contrib-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.83em;
        }
        .contrib-table th {
            background: #2c3e50;
            color: #8fa8c0;
            font-weight: 600;
            padding: 6px 8px;
            border: none;
            text-align: left;
        }
        .contrib-table td {
            padding: 6px 8px;
            border: none;
            border-bottom: 1px solid #2c3a48;
            color: #ecf0f1;
        }
        .contrib-table tr:last-child td { border-bottom: none; }
        .rank-badge {
            display: inline-block;
            width: 20px; height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 0.75em;
            font-weight: 700;
        }
        .rank-badge.gold   { background: #f1c40f; color: #000; }
        .rank-badge.silver { background: #bdc3c7; color: #000; }
        .rank-badge.bronze { background: #e67e22; color: #fff; }
        .rank-badge.other  { background: #3a4f63; color: #ecf0f1; }
        /* í™œë™ í”¼ë“œ */
        .activity-feed {
            list-style: none;
            padding: 0; margin: 0;
            font-size: 0.82em;
            max-height: 220px;
            overflow-y: auto;
        }
        .activity-feed li {
            padding: 5px 0;
            border-bottom: 1px solid #2c3a48;
            color: #bdc3c7;
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        .activity-feed li:last-child { border-bottom: none; }
        .activity-feed .af-name { color: #ecf0f1; font-weight: 600; }
        .activity-feed .af-date { color: #5d7185; white-space: nowrap; font-size: 0.9em; }
        /* ì§ê¸‰ ë¶„í¬ */
        .rank-dist-list {
            list-style: none;
            padding: 0; margin: 0;
            font-size: 0.82em;
        }
        .rank-dist-list li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #2c3a48;
            color: #bdc3c7;
        }
        .rank-dist-list li:last-child { border-bottom: none; }
        .rank-bar-wrap {
            flex: 1;
            background: #2c3a48;
            border-radius: 3px;
            height: 6px;
            overflow: hidden;
        }
        .rank-bar {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, #00aaff, #9b59b6);
        }
        .rank-count {
            color: #ecf0f1;
            font-weight: 600;
            min-width: 20px;
            text-align: right;
        }
        /* ìŠ¹ì¸ë¥  ë§ */
        .approval-ring-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 180px;
            gap: 6px;
        }
        .approval-ring-label {
            font-size: 0.8em;
            color: #8fa8c0;
        }
        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ (êµ¬) â†’ ìˆ¨ê¸°ê¸° */
        #chartContainer, #dailyLoginsChartContainer,
        #pageViewsChartContainer, #pageViewsSummaryContainer {
            display: none;
        }
    </style>
    <!-- ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ -->
    <style>
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }

            /* ì»¨íŠ¸ë¡¤ë“¤ì„ ì„¸ë¡œë¡œ ìŒ“ê¸° */
            #user-controls, #registerForm {
                flex-direction: column;
                align-items: stretch; /* ì»¨íŠ¸ë¡¤ë“¤ì„ ê½‰ ì±„ì›€ */
            }
            #user-controls input, #user-controls select,
            #registerForm input, #registerForm select {
                width: 100%; /* ë„ˆë¹„ 100%ë¡œ ì„¤ì • */
            }

            /* í…Œì´ë¸”ì´ ë„˜ì¹  ê²½ìš° ê°€ë¡œ ìŠ¤í¬ë¡¤ ìƒì„± */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            /* ëª¨ë‹¬ ì°½ì´ í™”ë©´ì— ë” ì˜ ë§ë„ë¡ ì¡°ì • */
            .modal-content {
                width: 90%;
            }
        }
    </style>
    <!-- ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ -->
    <style>
        #editUserModal .modal-content {
            max-width: 500px;
        }
        #editUserModal form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #editUserModal .form-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #editUserModal .form-row label {
            width: 100px;
            flex-shrink: 0;
            text-align: right;
        }
        #editUserModal .form-row input,
        #editUserModal .form-row select {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <!-- ğŸš© [ì¶”ê°€] íŒì—… ì „ìš© í—¤ë” -->
    <div class="popup-header">
        <h1>íšŒì› ê´€ë¦¬</h1>
    </div>
    
    <div class="container">
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ëŒ€ì‹œë³´ë“œ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="dashboard">

            <!-- KPI ì¹´ë“œ í–‰ -->
            <div class="dash-kpi-grid">
                <div class="kpi-card blue">
                    <span class="kpi-icon">ï¿½</span>
                    <span class="kpi-label">ì „ì²´ ì‚¬ê´€</span>
                    <span class="kpi-value" id="kpi-totalUsers">â€”</span>
                    <span class="kpi-sub" id="kpi-newUsers7d">ìµœê·¼ 7ì¼ ì‹ ì…: â€”ëª…</span>
                </div>
                <div class="kpi-card green">
                    <span class="kpi-icon">âœ…</span>
                    <span class="kpi-label">ìŠ¹ì¸ëœ ì‚¬ë£Œ</span>
                    <span class="kpi-value" id="kpi-approved">â€”</span>
                    <span class="kpi-sub" id="kpi-totalContribs">ì „ì²´ ì œì¶œ: â€”ê±´</span>
                </div>
                <div class="kpi-card orange">
                    <span class="kpi-icon">â³</span>
                    <span class="kpi-label">ëŒ€ê¸° ì¤‘ ì‚¬ë£Œ</span>
                    <span class="kpi-value" id="kpi-pending">â€”</span>
                    <span class="kpi-sub" id="kpi-reviewed">ê²€í† ì™„ë£Œ(ìŠ¹ì¸ëŒ€ê¸°): â€”ê±´</span>
                </div>
                <div class="kpi-card red">
                    <span class="kpi-icon">âŒ</span>
                    <span class="kpi-label">ë°˜ë ¤ëœ ì‚¬ë£Œ</span>
                    <span class="kpi-value" id="kpi-rejected">â€”</span>
                    <span class="kpi-sub" id="kpi-approvalRate">ìŠ¹ì¸ë¥ : â€”%</span>
                </div>
                <div class="kpi-card teal">
                    <span class="kpi-icon">ğŸ‘</span>
                    <span class="kpi-label">ì´ íˆ¬í‘œ ìˆ˜</span>
                    <span class="kpi-value" id="kpi-totalVotes">â€”</span>
                    <span class="kpi-sub" id="kpi-avgVotes">ì‚¬ë£Œë‹¹ í‰ê· : â€”í‘œ</span>
                </div>
                <div class="kpi-card purple">
                    <span class="kpi-icon">ğŸ†</span>
                    <span class="kpi-label">ì´ë‹¬ì˜ MVP</span>
                    <span class="kpi-value" id="kpi-mvp" style="font-size:1.2em;">â€”</span>
                    <span class="kpi-sub" id="kpi-mvpCount">ìŠ¹ì¸ â€”ê±´</span>
                </div>
                <div class="kpi-card yellow">
                    <span class="kpi-icon">ğŸ“‚</span>
                    <span class="kpi-label">ìµœë‹¤ ì¹´í…Œê³ ë¦¬</span>
                    <span class="kpi-value" id="kpi-topCategory" style="font-size:1.2em;">â€”</span>
                    <span class="kpi-sub" id="kpi-topCategoryCount">â€”ê±´</span>
                </div>
                <div class="kpi-card pink">
                    <span class="kpi-icon">ğŸ“…</span>
                    <span class="kpi-label">ì´ë²ˆ ë‹¬ ì œì¶œ</span>
                    <span class="kpi-value" id="kpi-thisMonth">â€”</span>
                    <span class="kpi-sub">ì§€ë‚œ ë‹¬ ëŒ€ë¹„ í‘œì‹œ</span>
                </div>
            </div>

            <!-- ì°¨íŠ¸ í–‰ 1: ì‚¬ë£Œ ì¶”ì´ + ì¼ì¼ ì ‘ì†ì -->
            <div class="dash-charts-grid">
                <div class="chart-card tall">
                    <h3>ğŸ“ˆ ì‚¬ë£Œ ì œì¶œ ì¶”ì´ (ìµœê·¼ 30ì¼)</h3>
                    <div class="chart-wrap"><canvas id="contribTrendChart"></canvas></div>
                </div>
                <div class="chart-card tall">
                    <h3>ğŸ”µ ì¼ì¼ ê³ ìœ  ì ‘ì†ì (ìµœê·¼ 7ì¼)</h3>
                    <div class="chart-wrap"><canvas id="dailyLoginsChart2"></canvas></div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ í–‰ 2: ì‚¬ê´€ ë­í‚¹ + ì‚¬ë£Œ ìƒíƒœ ë„ë„› + ì¹´í…Œê³ ë¦¬ ë¶„í¬ -->
            <div class="dash-charts-grid three-col">
                <div class="chart-card" style="grid-column: span 1;">
                    <h3>ğŸ… ì‚¬ê´€ ê¸°ì—¬ ë­í‚¹ TOP 10</h3>
                    <table class="contrib-table">
                        <thead><tr><th>#</th><th>ì‚¬ê´€ëª…</th><th>ìŠ¹ì¸</th><th>ì œì¶œ</th></tr></thead>
                        <tbody id="contribRankBody"></tbody>
                    </table>
                </div>
                <div class="chart-card">
                    <h3>ğŸ“Š ì‚¬ë£Œ ìƒíƒœ ë¶„í¬</h3>
                    <div class="chart-wrap"><canvas id="statusDonutChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ“š ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬</h3>
                    <div class="chart-wrap"><canvas id="categoryChart"></canvas></div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ í–‰ 3: ì§ê¸‰ ë¶„í¬ + ìµœê·¼ í™œë™ í”¼ë“œ + í˜ì´ì§€ë·° -->
            <div class="dash-charts-grid three-col">
                <div class="chart-card">
                    <h3>ğŸ–ï¸ ì‚¬ê´€ ì§ê¸‰ ë¶„í¬</h3>
                    <ul class="rank-dist-list" id="rankDistList"></ul>
                </div>
                <div class="chart-card">
                    <h3>ğŸ• ìµœê·¼ ì‚¬ë£Œ í™œë™</h3>
                    <ul class="activity-feed" id="activityFeed"></ul>
                </div>
                <div class="chart-card">
                    <h3>ğŸŒ í˜ì´ì§€ë·° (ìµœê·¼ 7ì¼)</h3>
                    <div class="chart-wrap"><canvas id="pageViewsChart2"></canvas></div>
                </div>
            </div>

        </div>
        <!-- â•â•â•â•â•â•â•â•â•â•â•â• ëŒ€ì‹œë³´ë“œ ë â•â•â•â•â•â•â•â•â•â•â•â• -->

        <!-- êµ¬ ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ (ìˆ¨ê¹€ â€” JS í˜¸í™˜ìš©) -->
        <div id="chartContainer" style="display:none"><canvas id="registrationChart"></canvas></div>
        <div id="dailyLoginsChartContainer" style="display:none"><canvas id="dailyLoginsChart"></canvas></div>
        <div id="pageViewsChartContainer" style="display:none"><canvas id="pageViewsChart"></canvas></div>
        <div id="pageViewsSummaryContainer" style="display:none">
            <table><thead><tr><th>í˜ì´ì§€</th><th>í•©ê³„</th></tr></thead>
            <tbody id="pageViewsSummary"></tbody></table>
            <p id="pageViewsSummaryNote"></p>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <h2 style="margin:0;">ì‚¬ìš©ì ëª©ë¡</h2>
            <button type="button" id="copyEmailsBtn">ğŸ“‹ ì „ì²´ ì´ë©”ì¼ ì£¼ì†Œ ë³µì‚¬</button>
        </div>

        <!-- ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê²€ìƒ‰ ë° í•„í„° ì»¨íŠ¸ë¡¤ -->
        <div id="user-controls">
            <input type="text" id="userSearchInput" placeholder="ì‚¬ìš©ì ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." style="width: 250px;">
            <select id="roleFilterSelect" style="width: 150px;">
                <option value="all">-- ëª¨ë“  ì—­í•  --</option>
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="superuser">Superuser</option>
            </select>
            <label for="itemsPerPageSelect" style="color: #ecf0f1; font-weight: normal;">í•­ëª© ìˆ˜:</label>
            <select id="itemsPerPageSelect" style="width: 80px;">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
        </div>

        <table id="userTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort-by="username">ì‚¬ìš©ì ì´ë¦„</th>
                    <th class="sortable" data-sort-by="email">ì´ë©”ì¼</th>
                    <th class="sortable" data-sort-by="lastLogin">ë§ˆì§€ë§‰ í™œë™ <span style="font-size:10px;color:#95a5a6;" title="ë¡œê·¸ì¸/ì‚¬ë£Œì œì¶œ ì¤‘ ë” ìµœê·¼ ë‚ ì§œ í‘œì‹œ">â„¹</span></th>
                    <th class="sortable" data-sort-by="loginCount">ë¡œê·¸ì¸ íšŸìˆ˜</th>
                    <th class="sortable" data-sort-by="role">ì—­í• </th>
                    <th class="sortable" data-sort-by="position">ì§ê¸‰</th>
                    <th class="sortable" data-sort-by="score">í¬ì¸íŠ¸</th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="userList">
                <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </tbody>
        </table>

        <!-- ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ -->
        <div id="pagination-controls">
            <button id="prevPageBtn">ì´ì „</button>
            <span id="pageInfo"></span>
            <button id="nextPageBtn">ë‹¤ìŒ</button>
        </div>

        <h2>ë ˆì´ì–´ ê¸°ë³¸ ì„¤ì •</h2>
        <div id="layerSettingsContainer" style="background-color: #3e4a56; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <p style="margin-bottom: 15px; color: #ecf0f1;">ì§€ë„ í˜ì´ì§€ì—ì„œ ê° ë ˆì´ì–´ê°€ ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œë ì§€ ì„¤ì •í•©ë‹ˆë‹¤.</p>
            <div id="layerSettingsGrid" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <!-- ë ˆì´ì–´ ì„¤ì • ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button id="saveLayerSettingsBtn" class="primary" style="padding: 8px 16px;">ì„¤ì • ì €ì¥</button>
            </div>
        </div>

        <h2>ìƒˆ ì‚¬ìš©ì ë“±ë¡</h2>
        <form id="registerForm">
            <input type="text" id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" required>
            <input type="email" id="email" placeholder="ì´ë©”ì¼" required>
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            <select id="role">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="superuser">Superuser</option>
            </select>
            <select id="position">
                <!-- ğŸš© ê³ ë ¤ ì‚¬ê´€ í†µí•© 18ë‹¨ê³„ ì§ê¸‰í‘œ (ì¢…9í’ˆâ†’ì •1í’ˆ) -->
                <option value="ìˆ˜ë¶„ê¶Œì§€">ìˆ˜ë¶„ê¶Œì§€ (ì¢…9í’ˆ)</option>
                <option value="ì •ì">ì •ì (ì •9í’ˆ)</option>
                <option value="ê²€ì—´">ê²€ì—´ (ì¢…8í’ˆ)</option>
                <option value="ì£¼ì„œ">ì£¼ì„œ (ì •8í’ˆ)</option>
                <option value="ì§ë¬¸í•œ">ì§ë¬¸í•œ (ì¢…7í’ˆ)</option>
                <option value="ìˆ˜ì°¬">ìˆ˜ì°¬ (ì •7í’ˆ)</option>
                <option value="ê¸°ê±°ë„ìœ„">ê¸°ê±°ë„ìœ„ (ì¢…6í’ˆ)</option>
                <option value="ê¸°ê±°ë‘">ê¸°ê±°ë‘ (ì •6í’ˆ)</option>
                <option value="ê¸°ê±°ì‚¬">ê¸°ê±°ì‚¬ (ì¢…5í’ˆ)</option>
                <option value="ê¸°ê±°ì£¼">ê¸°ê±°ì£¼ (ì •5í’ˆ)</option>
                <option value="ì‹œê°•í•™ì‚¬">ì‹œê°•í•™ì‚¬ (ì¢…4í’ˆ)</option>
                <option value="ì‚¬ê´€ìˆ˜ì°¬">ì‚¬ê´€ìˆ˜ì°¬ (ì •4í’ˆ)</option>
                <option value="ì§ìˆ˜ì°¬ê´€">ì§ìˆ˜ì°¬ê´€ (ì¢…3í’ˆ)</option>
                <option value="ìˆ˜ì°¬ê´€">ìˆ˜ì°¬ê´€ (ì •3í’ˆ)</option>
                <option value="ë™ìˆ˜êµ­ì‚¬">ë™ìˆ˜êµ­ì‚¬ (ì¢…2í’ˆ)</option>
                <option value="ìˆ˜êµ­ì‚¬">ìˆ˜êµ­ì‚¬ (ì •2í’ˆ)</option>
                <option value="íŒì‚¬ê´€ì‚¬">íŒì‚¬ê´€ì‚¬ (ì¢…1í’ˆ)</option>
                <option value="ê°ìˆ˜êµ­ì‚¬">ê°ìˆ˜êµ­ì‚¬ (ì •1í’ˆ)</option>
            </select>
            <button type="submit">ë“±ë¡</button>
        </form>

        <!-- ğŸš© [ì¶”ê°€] ë²”ìš© í™•ì¸ ëª¨ë‹¬ -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h3>ì‘ì—… í™•ì¸</h3>
                <p id="confirmModalMessage"></p>
                <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="cancelConfirm" class="danger">ì·¨ì†Œ</button>
                    <button type="button" id="confirmAction" class="primary">í™•ì¸</button>
                </div>
            </div>
        </div>

        <!-- ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <h3>ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</h3>
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-row">
                        <label for="editUsername">ì‚¬ìš©ì ì´ë¦„</label>
                        <input type="text" id="editUsername" required>
                    </div>
                    <div class="form-row">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail">
                    </div>
                    <div class="form-row">
                        <label for="editPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="editPassword" placeholder="ë³€ê²½í•  ê²½ìš°ì—ë§Œ ì…ë ¥">
                    </div>
                    <div class="form-row">
                        <label for="editRole">ì—­í• </label>
                        <select id="editRole" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="superuser">Superuser</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label for="editPosition">ì§ê¸‰ ê°•ì œ ì§€ì • (ì •3í’ˆ~ì¢…9í’ˆ, ì¬ìƒê¸‰ ì œì™¸)</label>
                        <select id="editPosition">
                            <!-- ìë™(ì ìˆ˜ ê¸°ë°˜) / ê°•ì œ ì§€ì • í•´ì œ -->
                            <option value="">ìë™ (ì ìˆ˜ ê¸°ë°˜)</option>
                            <!-- ì •3í’ˆ~ì¢…9í’ˆ -->
                            <option value="ìˆ˜ë¶„ê¶Œì§€">ìˆ˜ë¶„ê¶Œì§€ (ì¢…9í’ˆ)</option>
                            <option value="ì •ì">ì •ì (ì •9í’ˆ)</option>
                            <option value="ê²€ì—´">ê²€ì—´ (ì¢…8í’ˆ)</option>
                            <option value="ì£¼ì„œ">ì£¼ì„œ (ì •8í’ˆ)</option>
                            <option value="ì§ë¬¸í•œ">ì§ë¬¸í•œ (ì¢…7í’ˆ)</option>
                            <option value="ìˆ˜ì°¬">ìˆ˜ì°¬ (ì •7í’ˆ)</option>
                            <option value="ê¸°ê±°ë„ìœ„">ê¸°ê±°ë„ìœ„ (ì¢…6í’ˆ)</option>
                            <option value="ê¸°ê±°ë‘">ê¸°ê±°ë‘ (ì •6í’ˆ)</option>
                            <option value="ê¸°ê±°ì‚¬">ê¸°ê±°ì‚¬ (ì¢…5í’ˆ)</option>
                            <option value="ê¸°ê±°ì£¼">ê¸°ê±°ì£¼ (ì •5í’ˆ)</option>
                            <option value="ì‹œê°•í•™ì‚¬">ì‹œê°•í•™ì‚¬ (ì¢…4í’ˆ)</option>
                            <option value="ì‚¬ê´€ìˆ˜ì°¬">ì‚¬ê´€ìˆ˜ì°¬ (ì •4í’ˆ)</option>
                            <option value="ì§ìˆ˜ì°¬ê´€">ì§ìˆ˜ì°¬ê´€ (ì¢…3í’ˆ)</option>
                            <option value="ìˆ˜ì°¬ê´€">ìˆ˜ì°¬ê´€ (ì •3í’ˆ)</option>
                        </select>
                        <small style="color:#95a5a6;">â€» ì¬ìƒê¸‰(ì •1~ì¢…2í’ˆ)ì€ ì•„ë˜ 'ì¬ìƒê¸‰ ì§€ì •'ì„ ì‚¬ìš©í•˜ì„¸ìš”. 'ìë™'ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì ìˆ˜ ê¸°ë°˜ ì§ê¸‰ì´ ì ìš©ë˜ë©° ìˆœìœ„ì— í¬í•¨ë©ë‹ˆë‹¤.</small>
                    </div>
                    <div class="form-row">
                        <label for="editDesignatedRank">ì¬ìƒê¸‰ ì§€ì • (ê´€ë¦¬ì ìˆ˜ë™ ì§€ì •)</label>
                        <select id="editDesignatedRank">
                            <option value="">ì§€ì • ì—†ìŒ (ìë™/ì ìˆ˜ ê¸°ì¤€)</option>
                            <option value="1">1ìœ„ â€” ì •1í’ˆ ê°ìˆ˜êµ­ì‚¬</option>
                            <option value="2">2ìœ„ â€” ì¢…1í’ˆ íŒì‚¬ê´€ì‚¬</option>
                            <option value="3">3ìœ„ â€” ì •2í’ˆ ìˆ˜êµ­ì‚¬</option>
                            <option value="4">4ìœ„ â€” ì¢…2í’ˆ ë™ìˆ˜êµ­ì‚¬</option>
                        </select>
                    </div>
                    <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                        <button type="button" id="cancelUserEdit" class="danger">ì·¨ì†Œ</button>
                        <button type="submit" id="saveUserEdit" class="primary">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="nav-links">
        <a href="javascript:history.back()" class="button-style primary">ë©”ì¸ ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <!-- ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="toastContainer"></div>
    <script>
        const API_BASE_URL = '/api'; // ğŸ’¡ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');

        // í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
        }

        const PAGE_NAME_MAP = {
            '/index.html': 'ë©”ì¸ ì§€ë„',
            '/login.html': 'ë¡œê·¸ì¸',
            '/register.html': 'íšŒì›ê°€ì…',
            '/admin.html': 'ê´€ë¦¬ì',
            '/account.html': 'ê³„ì • ê´€ë¦¬'
        };

        const describePagePath = (rawPath) => {
            if (!rawPath) {
                return { label: 'ì•Œ ìˆ˜ ì—†ìŒ', slug: 'unknown' };
            }
            if (rawPath === 'ê¸°íƒ€') {
                return { label: 'ê¸°íƒ€ í˜ì´ì§€', slug: 'ê¸°íƒ€' };
            }
            const normalized = rawPath.startsWith('/') ? rawPath : `/${rawPath}`;
            const slug = normalized.substring(1) || normalized;
            const friendly = PAGE_NAME_MAP[normalized] || slug;
            return { label: friendly, slug };
        };

        const hexToRgba = (hex, alpha) => {
            if (!hex || typeof hex !== 'string' || !hex.startsWith('#')) {
                return hex;
            }
            const trimmed = hex.replace('#', '');
            if (trimmed.length !== 6) {
                return hex;
            }
            const bigint = parseInt(trimmed, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const formatIsoDateForLabel = (isoDate) => {
            if (!isoDate) return '';
            const date = new Date(`${isoDate}T00:00:00Z`);
            if (Number.isNaN(date.getTime())) return isoDate;
            return `${date.getMonth() + 1}/${date.getDate()}`;
        };

        // ğŸš© [ì¶”ê°€] ì§ê¸‰ëª…ì„ êµ¬ì²´ì ìœ¼ë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ì ìˆ˜ ê¸°ë°˜, server.js/ranking.htmlê³¼ ë™ì¼ ê¸°ì¤€)
        function getDetailedPosition(score) {
            if (score >= 2600) return 'ì •3í’ˆ ìˆ˜ì°¬ê´€';
            if (score >= 2100) return 'ì¢…3í’ˆ ì§ìˆ˜ì°¬ê´€';
            if (score >= 1700) return 'ì •4í’ˆ ì‚¬ê´€ìˆ˜ì°¬';
            if (score >= 1400) return 'ì¢…4í’ˆ ì‹œê°•í•™ì‚¬';
            if (score >= 1100) return 'ì •5í’ˆ ê¸°ê±°ì£¼';
            if (score >= 850)  return 'ì¢…5í’ˆ ê¸°ê±°ì‚¬';
            if (score >= 650)  return 'ì •6í’ˆ ê¸°ê±°ë‘';
            if (score >= 450)  return 'ì¢…6í’ˆ ê¸°ê±°ë„ìœ„';
            if (score >= 300)  return 'ì •7í’ˆ ìˆ˜ì°¬';
            if (score >= 200)  return 'ì¢…7í’ˆ ì§ë¬¸í•œ';
            if (score >= 120)  return 'ì •8í’ˆ ì£¼ì„œ';
            if (score >= 60)   return 'ì¢…8í’ˆ ê²€ì—´';
            if (score >= 30)   return 'ì •9í’ˆ ì •ì';
            return 'ì¢…9í’ˆ ìˆ˜ë¶„ê¶Œì§€';
        }

        let allUsers = []; // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ëª©ë¡ì„ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        // ğŸš© [ì¶”ê°€] ì •ë ¬ ìƒíƒœë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        let currentSort = {
            key: 'username',
            direction: 'asc'
        };
        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ ë³€ìˆ˜
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredAndSortedUsers = []; // í•„í„°ë§ ë° ì •ë ¬ëœ ì „ì²´ ì‚¬ìš©ì ëª©ë¡

        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');


        // ğŸš© [ì¶”ê°€] í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ğŸš© [ì¶”ê°€] ë²”ìš© í™•ì¸ ëª¨ë‹¬ í•¨ìˆ˜
        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmModalMessage').textContent = message;
            modal.style.display = 'block';

            const confirmBtn = document.getElementById('confirmAction');
            const cancelBtn = document.getElementById('cancelConfirm');

            const confirmHandler = () => {
                modal.style.display = 'none';
                onConfirm();
                cleanup();
            };

            const cancelHandler = () => {
                modal.style.display = 'none';
                cleanup();
            };

            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ëª©ë¡ì„ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderUsers(usersToRender) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            console.log('ë Œë”ë§í•  ì‚¬ìš©ì ìˆ˜:', usersToRender.length);
            if (usersToRender.length > 0) {
                console.log('ì²« ë²ˆì§¸ ì‚¬ìš©ì ë°ì´í„°:', usersToRender[0]);
            }
            usersToRender.forEach(user => { 
                const tr = document.createElement('tr');
                if (user.isLocked) {
                    tr.classList.add('locked');
                }
                const lastLogin = user.lastLogin 
                    ? new Date(user.lastLogin).toLocaleString() 
                    : 'ê¸°ë¡ ì—†ìŒ';
                
                // ğŸš© ë§ˆì§€ë§‰ í™œë™: ë¡œê·¸ì¸ vs ìµœê·¼ ê¸°ì—¬ ë‚ ì§œ ì¤‘ ë” ìµœê·¼ ê²ƒ
                const loginDate = user.lastLogin ? new Date(user.lastLogin) : null;
                const contribDate = user.lastContributionAt ? new Date(user.lastContributionAt) : null;
                let lastActivity, lastActivityLabel;
                if (loginDate && contribDate) {
                    if (contribDate > loginDate) {
                        lastActivity = contribDate.toLocaleString();
                        lastActivityLabel = `<span title="ë¡œê·¸ì¸: ${loginDate.toLocaleString()}" style="cursor:help;">${lastActivity} <span style="font-size:9px;color:#27ae60;background:rgba(39,174,96,0.15);padding:0 3px;border-radius:3px;">ì‚¬ë£Œ</span></span>`;
                    } else {
                        lastActivity = loginDate.toLocaleString();
                        lastActivityLabel = `<span title="ìµœê·¼ì‚¬ë£Œ: ${contribDate.toLocaleString()}" style="cursor:help;">${lastActivity} <span style="font-size:9px;color:#3498db;background:rgba(52,152,219,0.15);padding:0 3px;border-radius:3px;">ë¡œê·¸ì¸</span></span>`;
                    }
                } else {
                    lastActivityLabel = lastLogin;
                }
                const createdAt = user.createdAt 
                    ? new Date(user.createdAt).toLocaleString() 
                    : 'ì•Œ ìˆ˜ ì—†ìŒ';
                const score = user.score || 0;
                const drNames = { 1: 'ì •1í’ˆâ˜…', 2: 'ì¢…1í’ˆâ˜…', 3: 'ì •2í’ˆâ˜…', 4: 'ì¢…2í’ˆâ˜…' };
                const drFullNames = { 1: 'ê°ìˆ˜êµ­ì‚¬', 2: 'íŒì‚¬ê´€ì‚¬', 3: 'ìˆ˜êµ­ì‚¬', 4: 'ë™ìˆ˜êµ­ì‚¬' };

                // ì§ê¸‰ ê²°ì •: designated_rank > designated_position > ì ìˆ˜ ê¸°ë°˜ ìˆœ
                let position, positionBadge = '';
                if (user.designated_rank != null && drFullNames[user.designated_rank]) {
                    position = drFullNames[user.designated_rank];
                    positionBadge = `<span style="font-size:9px;background:#c0392b;color:#fff;border-radius:3px;padding:0 3px;margin-left:3px;" title="ê´€ë¦¬ì ì§€ì • ì¬ìƒê¸‰">ì¬ìƒì§€ì •</span>`;
                } else if (user.designated_position) {
                    position = user.designated_position;
                    positionBadge = `<span style="font-size:9px;background:#e67e22;color:#fff;border-radius:3px;padding:0 3px;margin-left:3px;" title="ê´€ë¦¬ì ì§€ì • ì§ê¸‰">ì§ê¸‰ì§€ì •</span>`;
                } else {
                    position = getDetailedPosition(score);
                }

                console.log(`ì‚¬ìš©ì ${user.username} ì§ê¸‰:`, position, 'í¬ì¸íŠ¸:', score);
                const isAdminRole = user.role === 'admin' || user.role === 'superuser';
                const adminBadge = isAdminRole
                    ? `<span style="font-size:9px;background:#8e44ad;color:#fff;border-radius:3px;padding:0 3px;margin-left:3px;">ê´€ë¦¬ì</span>`
                    : '';
                tr.innerHTML = ` 
                    <td>${user.username}</td>
                    <td>${user.email || 'ë¯¸ì…ë ¥'}</td>
                    <td>${lastActivityLabel}</td>
                    <td>${user.loginCount || 0}íšŒ</td>
                    <td>${user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'N/A'}${adminBadge}</td>
                    <td>${position}${positionBadge}</td>
                    <td>${score}</td>
                    <td>
                        <button class="button lock-btn" onclick="toggleLockStatus(this, '${user._id}', ${user.isLocked || false})">${user.isLocked ? 'ì ê¸ˆ í•´ì œ' : 'ê³„ì • ì ê¸ˆ'}</button>
                        <button class="primary" onclick="openEditUserModal('${user._id}')">ìˆ˜ì •</button>
                        <button class="button danger" onclick="deleteUser(this, '${user._id}')">ì‚­ì œ</button>
                        <button class="button switch-btn" onclick="switchToUser('${user._id}')">ìŠ¤ìœ„ì¹˜</button>
                    </td>
                `;
                userList.appendChild(tr);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìƒˆ ëŒ€ì‹œë³´ë“œ ë¡œì§ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const CHART_COLORS = {
            blue:   '#00aaff', green: '#2ecc71', orange: '#e67e22',
            purple: '#9b59b6', red:   '#e74c3c', teal:   '#1abc9c',
            yellow: '#f1c40f', pink:  '#e91e63', grey:   '#7f8c8d'
        };
        const CATEGORY_LABELS = {
            oldmap: 'ê³ ì§€ë„', geography: 'ì§€ë¦¬ì§€', literature: 'ë¬¸í•™',
            historical_record: 'ì—­ì‚¬ì„œ', other: 'ê¸°íƒ€'
        };
        function hex2rgba(hex, a) {
            const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            return `rgba(${r},${g},${b},${a})`;
        }
        const dashCharts = {};
        function makeChart(id, type, data, options = {}) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (dashCharts[id]) dashCharts[id].destroy();
            const defaultOpts = {
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8fa8c0', font: { size: 11 } } } },
                scales: type === 'doughnut' || type === 'pie' ? {} : {
                    y: { beginAtZero: true, ticks: { color: '#8fa8c0', font: { size: 10 } }, grid: { color: '#2c3a48' } },
                    x: { ticks: { color: '#8fa8c0', font: { size: 10 } }, grid: { color: '#2c3a48' } }
                }
            };
            dashCharts[id] = new Chart(ctx, { type, data, options: { ...defaultOpts, ...options } });
        }

        async function loadDashboard() {
            try {
                const [dashRes, loginRes, pvRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/admin/dashboard`, { headers: { Authorization: `Bearer ${token}` } }),
                    fetch(`${API_BASE_URL}/stats/daily-logins`,  { headers: { Authorization: `Bearer ${token}` } }),
                    fetch(`${API_BASE_URL}/stats/page-views?days=7`, { headers: { Authorization: `Bearer ${token}` } }),
                ]);
                const dash = dashRes.ok ? await dashRes.json() : null;
                const logins = loginRes.ok ? await loginRes.json() : [];
                const pvStats = pvRes.ok ? await pvRes.json() : null;

                if (dash) renderDashboard(dash, logins, pvStats);
            } catch (e) {
                console.warn('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì˜¤ë¥˜:', e);
            }
        }

        function renderDashboard(dash, logins, pvStats) {
            const s = dash.summary;

            // â”€â”€ KPI ì¹´ë“œ â”€â”€
            document.getElementById('kpi-totalUsers').textContent = s.totalUsers;
            document.getElementById('kpi-newUsers7d').textContent = `ìµœê·¼ 7ì¼ ì‹ ì…: ${s.newUsers7d}ëª…`;
            document.getElementById('kpi-approved').textContent = s.approvedContribs;
            document.getElementById('kpi-totalContribs').textContent = `ì „ì²´ ì œì¶œ: ${s.totalContribs}ê±´`;
            document.getElementById('kpi-pending').textContent = s.pendingContribs;
            document.getElementById('kpi-reviewed').textContent = `ê²€í† ì™„ë£Œ(ìŠ¹ì¸ëŒ€ê¸°): ${s.reviewedContribs}ê±´`;
            document.getElementById('kpi-rejected').textContent = s.rejectedContribs;
            const rate = s.totalContribs > 0 ? Math.round(s.approvedContribs / s.totalContribs * 100) : 0;
            document.getElementById('kpi-approvalRate').textContent = `ìŠ¹ì¸ë¥ : ${rate}%`;
            document.getElementById('kpi-totalVotes').textContent = s.totalVotes;
            document.getElementById('kpi-avgVotes').textContent = `ì‚¬ë£Œë‹¹ í‰ê· : ${s.avgVotes}í‘œ`;

            // MVP
            const mvp = (dash.topContributors || [])[0];
            document.getElementById('kpi-mvp').textContent = mvp ? mvp._id : 'â€”';
            document.getElementById('kpi-mvpCount').textContent = mvp ? `ìŠ¹ì¸ ${mvp.approved}ê±´` : '';

            // ìµœë‹¤ ì¹´í…Œê³ ë¦¬
            const topCat = (dash.categoryStats || [])[0];
            document.getElementById('kpi-topCategory').textContent = topCat ? (CATEGORY_LABELS[topCat._id] || topCat._id) : 'â€”';
            document.getElementById('kpi-topCategoryCount').textContent = topCat ? `${topCat.count}ê±´` : '';

            // ì´ë²ˆ ë‹¬ ì‚¬ë£Œ
            const now = new Date();
            const thisMonthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const lastMonthKey = `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;
            const thisM = (dash.monthlyTrend || []).find(m => m._id === thisMonthKey);
            const lastM = (dash.monthlyTrend || []).find(m => m._id === lastMonthKey);
            document.getElementById('kpi-thisMonth').textContent = thisM ? thisM.count : 0;

            // â”€â”€ ì‚¬ë£Œ ì œì¶œ ì¶”ì´ â”€â”€
            const trendLabels = (dash.recentActivity || []).map(d => d._id.slice(5));
            const trendData   = (dash.recentActivity || []).map(d => d.count);
            makeChart('contribTrendChart', 'bar', {
                labels: trendLabels,
                datasets: [{
                    label: 'ì‚¬ë£Œ ì œì¶œ',
                    data: trendData,
                    backgroundColor: hex2rgba(CHART_COLORS.blue, 0.6),
                    borderColor: CHART_COLORS.blue,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            });

            // â”€â”€ ì¼ì¼ ì ‘ì†ì â”€â”€
            const loginLabels = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                loginLabels.push(`${d.getMonth()+1}/${d.getDate()}`);
            }
            const loginData = loginLabels.map(label => {
                const [m, d2] = label.split('/').map(Number);
                const rec = logins.find(r => r.date && r.date.month === m && r.date.day === d2);
                return rec ? rec.count : 0;
            });
            makeChart('dailyLoginsChart2', 'line', {
                labels: loginLabels,
                datasets: [{
                    label: 'ê³ ìœ  ì ‘ì†ì',
                    data: loginData,
                    borderColor: CHART_COLORS.green,
                    backgroundColor: hex2rgba(CHART_COLORS.green, 0.15),
                    borderWidth: 2, fill: true, tension: 0.3,
                    pointBackgroundColor: CHART_COLORS.green
                }]
            });

            // â”€â”€ ì‚¬ê´€ ë­í‚¹ â”€â”€
            const rankBodies = ['gold','silver','bronze'];
            const tbody = document.getElementById('contribRankBody');
            tbody.innerHTML = '';
            (dash.topContributors || []).forEach((c, i) => {
                const badgeCls = i < 3 ? rankBodies[i] : 'other';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="rank-badge ${badgeCls}">${i+1}</span></td>
                    <td>${c._id}</td>
                    <td style="color:#2ecc71;font-weight:700">${c.approved}</td>
                    <td style="color:#8fa8c0">${c.total}</td>`;
                tbody.appendChild(tr);
            });

            // â”€â”€ ìƒíƒœ ë„ë„› â”€â”€
            makeChart('statusDonutChart', 'doughnut', {
                labels: ['ìŠ¹ì¸', 'ëŒ€ê¸°', 'ê²€í† ì™„ë£Œ', 'ë°˜ë ¤'],
                datasets: [{
                    data: [s.approvedContribs, s.pendingContribs, s.reviewedContribs, s.rejectedContribs],
                    backgroundColor: [CHART_COLORS.green, CHART_COLORS.orange, CHART_COLORS.blue, CHART_COLORS.red],
                    borderWidth: 2, borderColor: '#1e2a38'
                }]
            }, { plugins: { legend: { position: 'bottom', labels: { color: '#8fa8c0', font: { size: 10 }, boxWidth: 12 } } } });

            // â”€â”€ ì¹´í…Œê³ ë¦¬ ê°€ë¡œ ë§‰ëŒ€ â”€â”€
            const catLabels = (dash.categoryStats || []).map(c => CATEGORY_LABELS[c._id] || c._id);
            const catData   = (dash.categoryStats || []).map(c => c.count);
            const catColors = [CHART_COLORS.blue, CHART_COLORS.teal, CHART_COLORS.purple, CHART_COLORS.orange, CHART_COLORS.grey];
            makeChart('categoryChart', 'bar', {
                labels: catLabels,
                datasets: [{
                    label: 'ê±´ìˆ˜',
                    data: catData,
                    backgroundColor: catColors.map(c => hex2rgba(c, 0.7)),
                    borderColor: catColors,
                    borderWidth: 1, borderRadius: 4
                }]
            }, { indexAxis: 'y', plugins: { legend: { display: false } } });

            // â”€â”€ ì§ê¸‰ ë¶„í¬ â”€â”€
            const rdList = document.getElementById('rankDistList');
            rdList.innerHTML = '';
            const maxRank = Math.max(1, ...(dash.rankDistribution || []).map(r => r.count));
            (dash.rankDistribution || []).filter(r => r._id).forEach(r => {
                const pct = Math.round(r.count / maxRank * 100);
                const li = document.createElement('li');
                li.innerHTML = `
                    <span style="min-width:80px;color:#ecf0f1">${r._id}</span>
                    <div class="rank-bar-wrap"><div class="rank-bar" style="width:${pct}%"></div></div>
                    <span class="rank-count">${r.count}</span>`;
                rdList.appendChild(li);
            });

            // â”€â”€ ìµœê·¼ í™œë™ í”¼ë“œ â”€â”€
            const feed = document.getElementById('activityFeed');
            feed.innerHTML = '';
            // contributions APIì—ì„œ ìµœì‹  10ê±´ ê°€ì ¸ì˜¤ê¸°
            fetch(`${API_BASE_URL}/contributions?limit=10`, { headers: { Authorization: `Bearer ${token}` } })
                .then(r => r.ok ? r.json() : [])
                .then(items => {
                    (items || []).slice(0, 10).forEach(item => {
                        const d = new Date(item.createdAt);
                        const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                        const statusIcon = { approved:'âœ…', pending:'â³', reviewed:'ğŸ”', rejected:'âŒ' }[item.status] || 'ğŸ“';
                        const li = document.createElement('li');
                        li.innerHTML = `<span><span class="af-name">${item.username || '?'}</span> ${statusIcon} ${item.name || ''}</span><span class="af-date">${dateStr}</span>`;
                        feed.appendChild(li);
                    });
                    if (!items || items.length === 0) {
                        feed.innerHTML = '<li style="color:#5d7185">ìµœê·¼ í™œë™ ì—†ìŒ</li>';
                    }
                });

            // â”€â”€ í˜ì´ì§€ë·° ë¼ì¸ ì°¨íŠ¸ â”€â”€
            if (pvStats && Array.isArray(pvStats.labels) && pvStats.labels.length > 0) {
                const pvLabels = pvStats.labels.map(l => l.slice(5));
                const pvColors = [CHART_COLORS.blue, CHART_COLORS.green, CHART_COLORS.orange, CHART_COLORS.purple, CHART_COLORS.teal];
                const pvDatasets = (pvStats.datasets || []).slice(0, 5).map((ds, i) => ({
                    label: describePagePath(ds.path).label,
                    data: ds.counts || [],
                    borderColor: pvColors[i % pvColors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2, tension: 0.3, pointRadius: 2
                }));
                makeChart('pageViewsChart2', 'line', { labels: pvLabels, datasets: pvDatasets });
            }
        }

        // êµ¬ ì°¨íŠ¸ í•¨ìˆ˜ë“¤ â€” í˜¸í™˜ì„± ìœ ì§€ (fetchUsers ì•ˆì—ì„œ í˜¸ì¶œë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¹ˆ í•¨ìˆ˜ë¡œ ë³´ì¡´)
        let registrationChartInstance = null;
        let pageViewsChartInstance = null;
        let dailyLoginsChartInstance = null;
        function renderRegistrationChart() {}
        async function fetchAndRenderDailyLoginsChart() {}
        async function fetchAndRenderPageViewsStats() {}

        // ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 403) { // ì ‘ê·¼ ê±°ë¶€
                    alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                
                allUsers = await response.json(); // ğŸš© [ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ì— ì‚¬ìš©ì ëª©ë¡ ì €ì¥
                console.log('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œë¨:', allUsers.length, 'ëª…');
                console.log('ì²« ë²ˆì§¸ ì‚¬ìš©ì ìƒ˜í”Œ:', allUsers[0]);
                
                filterAndRenderUsers(); // ğŸš© [ìˆ˜ì •] í•„í„°ë§/ì •ë ¬ í›„ ë Œë”ë§
                renderRegistrationChart(allUsers); // ğŸš© [ì¶”ê°€] ì°¨íŠ¸ ë Œë”ë§
                fetchAndRenderDailyLoginsChart(); // ğŸš© [ì¶”ê°€] ì¼ì¼ ì ‘ì†ì ì°¨íŠ¸ ë Œë”ë§
                
                // ğŸš© [ì¶”ê°€] ì •ë ¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
                initializeSortingListeners();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ì‚¬ìš©ì ë“±ë¡
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value;
            const role = document.getElementById('role').value;
            const position = document.getElementById('position').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password, email, role, position })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                
                showToast('ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('registerForm').reset();
                fetchUsers();
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        // ì‚¬ìš©ì ì‚­ì œ
        window.deleteUser = function(button, userId) {
            showConfirmModal('ì •ë§ë¡œ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
                button.classList.add('loading');
                button.disabled = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    showToast('ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    fetchUsers(); // ì‚­ì œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ê³„ì • ì ê¸ˆ/í•´ì œ í† ê¸€
        window.toggleLockStatus = function(button, userId, isCurrentlyLocked) {
            const actionText = isCurrentlyLocked ? 'í•´ì œ' : 'ì ê¸ˆ';
            showConfirmModal(`ì •ë§ë¡œ ì´ ì‚¬ìš©ìì˜ ê³„ì •ì„ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                button.classList.add('loading');
                button.disabled = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}/lock`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ lock: !isCurrentlyLocked })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `ê³„ì • ${actionText}ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                    }
                    showToast(`ì‚¬ìš©ì ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ${actionText}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    const tr = button.closest('tr');
                    tr.classList.toggle('locked', !isCurrentlyLocked);
                    button.textContent = isCurrentlyLocked ? 'ê³„ì • ì ê¸ˆ' : 'ì ê¸ˆ í•´ì œ';
                    button.setAttribute('onclick', `toggleLockStatus(this, '${userId}', ${!isCurrentlyLocked})`);
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            });
        };

        // ğŸ“‹ ì „ì²´ ì´ë©”ì¼ ì£¼ì†Œ í´ë¦½ë³´ë“œ ë³µì‚¬
        document.getElementById('copyEmailsBtn').addEventListener('click', () => {
            const emails = allUsers
                .filter(u => u.email && !u.isGuest)
                .map(u => u.email)
                .join(', ');
            if (!emails) {
                showToast('ë³µì‚¬í•  ì´ë©”ì¼ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            navigator.clipboard.writeText(emails).then(() => {
                const count = allUsers.filter(u => u.email && !u.isGuest).length;
                showToast(`âœ… ${count}ëª…ì˜ ì´ë©”ì¼ ì£¼ì†Œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }).catch(() => {
                showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        });

        // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ ë° í•„í„°ë§ ê¸°ëŠ¥
        const userSearchInput = document.getElementById('userSearchInput');
        const roleFilterSelect = document.getElementById('roleFilterSelect');

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜ ì„ íƒ
        const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
        itemsPerPageSelect.addEventListener('change', () => {
            itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
            currentPage = 1; // í•­ëª© ìˆ˜ê°€ ë°”ë€Œë©´ ì²« í˜ì´ì§€ë¡œ ë¦¬ì…‹
            filterAndRenderUsers();
        });

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredAndSortedUsers.length / itemsPerPage);
            pageInfo.textContent = `í˜ì´ì§€ ${currentPage} / ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        // ğŸš© [ìˆ˜ì •] ê²€ìƒ‰/í•„í„°ë§ í•¨ìˆ˜ì— ì •ë ¬ ë¡œì§ ì¶”ê°€
        function filterAndRenderUsers() {
            const searchTerm = userSearchInput.value.toLowerCase();
            const selectedRole = roleFilterSelect.value;

            // 1. í•„í„°ë§
            let tempUsers = allUsers.filter(user => {
                const matchesSearch = user.username.toLowerCase().includes(searchTerm);
                const matchesRole = selectedRole === 'all' || user.role === selectedRole;
                return matchesSearch && matchesRole;
            });

            // 2. ì •ë ¬
            // filteredAndSortedUsersë¥¼ ì—…ë°ì´íŠ¸í•˜ê¸° ì „ì— ì •ë ¬ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            // ì´ë ‡ê²Œ í•˜ë©´ í˜ì´ì§€ë¥¼ ë„˜ê¸¸ ë•Œë§ˆë‹¤ ì •ë ¬í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            const key = currentSort.key;
            const direction = currentSort.direction === 'asc' ? 1 : -1;

            // ì •ë ¬ ë¡œì§
            tempUsers.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (key === 'lastLogin' || key === 'createdAt') {
                    // 'ê¸°ë¡ ì—†ìŒ' (null) ê°’ì„ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬
                    const dateA = valA ? new Date(valA).getTime() : 0;
                    const dateB = valB ? new Date(valB).getTime() : 0;
                    return (dateA - dateB) * direction;
                } else if (key === 'loginCount' || key === 'score') {
                    const numA = Number(valA) || 0;
                    const numB = Number(valB) || 0;
                    return (numA - numB) * direction;
                } else {
                    // ë¬¸ìì—´ ë¹„êµ
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                    if (valA < valB) return -1 * direction;
                    if (valA > valB) return 1 * direction;
                    return 0;
                }
            });

            filteredAndSortedUsers = tempUsers;

            // 3. í˜ì´ì§€ë„¤ì´ì…˜
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsers = filteredAndSortedUsers.slice(startIndex, endIndex);
            renderUsers(paginatedUsers);
            updatePaginationControls();
        }

        // ì´ˆê¸° ë¡œë“œ
        // ğŸš© [ì¶”ê°€] ì •ë ¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeSortingListeners() {
            const userTableHead = document.querySelector('#userTable thead');
            if (!userTableHead) {
                console.error('ì‚¬ìš©ì í…Œì´ë¸” í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const initialSortHeader = userTableHead.querySelector(`th[data-sort-by="${currentSort.key}"]`);
            if (initialSortHeader) {
                initialSortHeader.classList.add(`sort-${currentSort.direction}`);
            }

            userTableHead.addEventListener('click', e => {
                const header = e.target.closest('th.sortable');
                if (!header) return;

                const sortKey = header.dataset.sortBy;
                if (!sortKey) return;

                console.log('ì •ë ¬ ì‹œì‘:', sortKey, 'í˜„ì¬:', currentSort);

                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = 'asc';
                }

                // ëª¨ë“  í—¤ë”ì—ì„œ ì •ë ¬ í´ë˜ìŠ¤ ì œê±°
                userTableHead.querySelectorAll('th.sortable').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                });

                // í˜„ì¬ í—¤ë”ì— ì •ë ¬ í´ë˜ìŠ¤ ì¶”ê°€
                header.classList.add(`sort-${currentSort.direction}`);
                
                currentPage = 1; // ì •ë ¬ ì‹œ ì²« í˜ì´ì§€ë¡œ
                filterAndRenderUsers();
            });
        }

        // ğŸš© [ìˆ˜ì •] í•„í„°/ê²€ìƒ‰ ì‹œ í˜ì´ì§€ë¥¼ 1ë¡œ ë¦¬ì…‹
        userSearchInput.addEventListener('input', () => { currentPage = 1; filterAndRenderUsers(); });
        roleFilterSelect.addEventListener('change', () => { currentPage = 1; filterAndRenderUsers(); });

        // ğŸš© [ì¶”ê°€] í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                filterAndRenderUsers();
            }
        });
        nextPageBtn.addEventListener('click', () => {
            currentPage++;
            filterAndRenderUsers();
        });

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ ë¡œì§
        const editUserModal = document.getElementById('editUserModal');
        const editUserForm = document.getElementById('editUserForm');

        window.openEditUserModal = (userId) => {
            const user = allUsers.find(u => u._id === userId);
            if (!user) {
                showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            document.getElementById('editUserId').value = user._id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editRole').value = user.role;
            // designated_positionì´ ìˆìœ¼ë©´ ê·¸ ê°’ìœ¼ë¡œ, ì—†ìœ¼ë©´ ë¹ˆê°’(ìë™)
            document.getElementById('editPosition').value = user.designated_position || '';
            document.getElementById('editDesignatedRank').value = user.designated_rank != null ? String(user.designated_rank) : '';
            document.getElementById('editPassword').value = ''; // ë¹„ë°€ë²ˆí˜¸ í•„ë“œëŠ” í•­ìƒ ë¹„ì›€

            editUserModal.style.display = 'block';
        };

        document.getElementById('cancelUserEdit').addEventListener('click', () => {
            editUserModal.style.display = 'none';
        });

        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const saveBtn = document.getElementById('saveUserEdit');

            const data = {
                username: document.getElementById('editUsername').value,
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value,
                // positionì€ designated_position APIë¡œ ë³„ë„ ì²˜ë¦¬ â€” ì—¬ê¸°ì„œëŠ” ì „ì†¡ ì•ˆ í•¨
            };

            const password = document.getElementById('editPassword').value;
            if (password) {
                data.password = password;
            }

            saveBtn.classList.add('loading');
            saveBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                // ì§ê¸‰ ê°•ì œ ì§€ì • ë³„ë„ API í˜¸ì¶œ (ë¹ˆê°’ì´ë©´ null â†’ í•´ì œ)
                const posVal = document.getElementById('editPosition').value;
                const designatedPosition = posVal === '' ? null : posVal;
                const dpResponse = await fetch(`${API_BASE_URL}/users/${userId}/designated-position`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ designated_position: designatedPosition })
                });
                if (!dpResponse.ok) {
                    const dpError = await dpResponse.json();
                    throw new Error(dpError.message || 'ì§ê¸‰ ì§€ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }

                // ì¬ìƒê¸‰ ì§€ì • ë³„ë„ API í˜¸ì¶œ
                const drVal = document.getElementById('editDesignatedRank').value;
                const designatedRank = drVal === '' ? null : parseInt(drVal, 10);
                const drResponse = await fetch(`${API_BASE_URL}/users/${userId}/designated-rank`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ designated_rank: designatedRank })
                });
                if (!drResponse.ok) {
                    const drError = await drResponse.json();
                    throw new Error(drError.message || 'ì¬ìƒê¸‰ ì§€ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }

                showToast('ì‚¬ìš©ì ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                editUserModal.style.display = 'none';
                await fetchUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                saveBtn.classList.remove('loading');
                saveBtn.disabled = false;
            }
        });

        // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ìŠ¤ìœ„ì¹˜ í•¨ìˆ˜
        async function switchToUser(userId) {
            if (!confirm('í•´ë‹¹ ì‚¬ìš©ìë¡œ ìŠ¤ìœ„ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì„¸ì…˜ì´ ë³€ê²½ë©ë‹ˆë‹¤.')) return;
            
            try {
                const response = await fetch(`http://localhost:3000/api/admin/switch-user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.token);
                    showToast('ì‚¬ìš©ìë¡œ ìŠ¤ìœ„ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    const error = await response.json();
                    showToast(error.message || 'ìŠ¤ìœ„ì¹˜ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetchUsers();
        loadDashboard();
        fetchAndRenderPageViewsStats(7); // êµ¬ í˜¸í™˜ìš© (ë¹ˆ í•¨ìˆ˜)

        // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ì„¤ì • ê´€ë¦¬ í•¨ìˆ˜ë“¤
        const layerLabels = {
            city: 'ì„±ë„ì‹œ',
            placeLabel: 'ì§€ëª…',
            countryLabel: 'êµ­ê°€ëª…',
            ethnicLabel: 'ë¯¼ì¡±',
            military: 'êµ°ëŒ€',
            natural: 'ìì—°',
            event: 'ì´ë²¤íŠ¸',
            territoryPolygon: 'ì˜í† ',
            rivers: 'ê°•',
            timeline: 'ì—°ëŒ€í‘œ',
            kingPanel: 'ì™•',
            historyPanel: 'ì—­ì‚¬',
            userContributions: 'ì‚¬ê´€(å²é¤¨)'
        };

        // ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadLayerSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/layer-settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('ë ˆì´ì–´ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();
                renderLayerSettings(data.settings);
            } catch (error) {
                showToast('ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
                // ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ë Œë”ë§
                renderLayerSettings({
                    city: true,
                    placeLabel: false,
                    countryLabel: true,
                    ethnicLabel: false,
                    military: false,
                    natural: false,
                    event: false,
                    territoryPolygon: true,
                    rivers: false,
                    timeline: true,
                    kingPanel: false,
                    historyPanel: false,
                    userContributions: true
                });
            }
        }

        // ë ˆì´ì–´ ì„¤ì • UI ë Œë”ë§
        function renderLayerSettings(settings) {
            const container = document.getElementById('layerSettingsGrid');
            container.innerHTML = '';

            Object.entries(settings).forEach(([layerKey, isEnabled]) => {
                const label = layerLabels[layerKey] || layerKey;
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 4px 8px; background-color: #2c3e50; border-radius: 4px; white-space: nowrap;';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `layer-${layerKey}`;
                checkbox.checked = isEnabled;
                checkbox.dataset.layer = layerKey;

                const labelElement = document.createElement('label');
                labelElement.htmlFor = `layer-${layerKey}`;
                labelElement.textContent = label;
                labelElement.style.cssText = 'color: #ecf0f1; cursor: pointer; font-size: 14px; margin: 0;';

                div.appendChild(checkbox);
                div.appendChild(labelElement);
                container.appendChild(div);
            });
        }

        // ë ˆì´ì–´ ì„¤ì • ì €ì¥
        async function saveLayerSettings() {
            const checkboxes = document.querySelectorAll('#layerSettingsGrid input[type="checkbox"]');
            const settings = {};

            checkboxes.forEach(checkbox => {
                settings[checkbox.dataset.layer] = checkbox.checked;
            });

            try {
                const response = await fetch(`${API_BASE_URL}/layer-settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ settings })
                });

                if (!response.ok) {
                    throw new Error('ë ˆì´ì–´ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                showToast('ë ˆì´ì–´ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                showToast('ë ˆì´ì–´ ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ì„¤ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('saveLayerSettingsBtn').addEventListener('click', saveLayerSettings);



        // ğŸš© [ì¶”ê°€] ì´ˆê¸°í™” ì‹œ ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        loadLayerSettings();

    </script>
</body>
</html>
