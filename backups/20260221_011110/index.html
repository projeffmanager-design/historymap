<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ë ¤ë§Œë¦¬ì§€ë„ (é«˜éº—è¬é‡Œåœ°åœ–)</title>
    <link rel="icon" type="image/jpg" href="https://github.com/projeffmanager-design/historymap/blob/main/2I63ySQI9qG-97MMKptL_n5FJhNOWE2DLt-ZKOcLL5TKeV4xxTfCN06j0lhGg5YMDH0ade2X99P-pzcKInnlOg.png?raw=true">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=East+Sea+Dokdo&family=Nanum+Myeongjo:wght@700&family=Yeon+Sung&display=swap" rel="stylesheet">
    
<style>
    /* ğŸš© ê·¸ë¦¬ê¸° í¼ ìœ„ì¹˜ ê°•ì œ ì„¤ì • - ìš°ì¸¡ í•˜ë‹¨ (ìµœìš°ì„  ìˆœìœ„) */
    div#drawingForm[style],
    div#drawingForm {
        position: absolute !important;
        bottom: 10px !important;
        right: 10px !important;
        left: auto !important;
        top: auto !important;
        transform: none !important;
        z-index: 1000 !important;
        background: rgba(30, 42, 56, 0.95) !important;
        padding: 12px 16px !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        max-width: 90% !important;
        width: auto !important;
        color: #ecf0f1 !important;
    }
    
    #drawingForm form,
    div#drawingForm form {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        gap: 10px !important;
        flex-wrap: wrap !important;
        justify-content: flex-start !important;
    }

    /* íŒì—…ì´ í•­ìƒ ì—°ëŒ€í‘œì™€ label marker ìœ„ì— ì˜¤ë„ë¡ z-index ê°•ì œ */
    .leaflet-popup-pane {
        z-index: 10000 !important;
    }
    
    /* ğŸ¯ ì½¤íŒ©íŠ¸ íŒì—… ìŠ¤íƒ€ì¼ (ìì—° ì§€í˜•ì§€ë¬¼ìš©) */
    .compact-popup .leaflet-popup-content-wrapper {
        padding: 4px 8px !important;
        margin: 0 !important;
    }
    .compact-popup .leaflet-popup-content {
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1.2 !important;
    }
    .compact-popup .leaflet-popup-tip-container {
        margin-top: -1px !important;
    }

    /* ğŸš© [ì¶”ê°€] ë¹ˆí‹°ì§€/ìˆ˜ë¬µí™” ìŠ¤íƒ€ì¼ ì ìš© â€” íƒ€ì¼ ë ˆì´ì–´ì—ë§Œ */
    #map {
        filter: sepia(0.4) contrast(0.9) brightness(1.1) grayscale(0.15);
        font-family: 'Noto Serif KR', serif;
    }
    /* ğŸš© [ì¶”ê°€] ë§ˆì»¤/ë¼ë²¨ ë ˆì´ì–´ëŠ” filter ì—­ë³´ì • â†’ êµ­ê°€ëª…ì´ íë¦¿í•´ì§€ì§€ ì•Šë„ë¡ */
    #map .leaflet-marker-pane,
    #map .leaflet-tooltip-pane,
    #map .leaflet-popup-pane {
        filter: sepia(0) contrast(1.11) brightness(0.91) grayscale(0);
    }

    /* ğŸš© [ì¶”ê°€] ì˜í†  í´ë¦¬ê³¤ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ â€” ìŠ¬ë¼ì´ë” ì´ë™ ì‹œ ìì—°ìŠ¤ëŸ¬ìš´ ë³€í™” */
    .leaflet-overlay-pane svg path {
        transition: fill-opacity 0.25s ease, opacity 0.25s ease, stroke-opacity 0.25s ease;
    }
    /* ìŠ¬ë¼ì´ë” ë“œë˜ê·¸ ì¤‘ì—ëŠ” ì¦‰ì‹œ ì „í™˜ (ê¹œë¹¡ì„ ì—†ëŠ” snap) */
    body.slider-dragging .leaflet-overlay-pane svg path {
        transition: none;
    }
    /* êµ­ê°€ë³„ SVG ì»¨í…Œì´ë„ˆ(renderer)ì—ë„ ë“œë˜ê·¸ ì¤‘ ì¦‰ì‹œ ì „í™˜ */
    body.slider-dragging .leaflet-overlay-pane svg {
        transition: none;
    }

    /* ğŸš© [ì¶”ê°€] ì§€ë„ ë³€ê²½ ìŠ¤ìœ„ì¹˜(ë ˆì´ì–´ ì»¨íŠ¸ë¡¤) ë¹ˆí‹°ì§€ ìŠ¤íƒ€ì¼ - ì „ì²´ ë¶„ìœ„ê¸°ì— ë§ì¶¤ */
    .leaflet-control-layers {
        border: 1px solid rgba(139, 69, 19, 0.6) !important;
        background: rgba(30, 42, 56, 0.95) !important;
        backdrop-filter: blur(8px) saturate(0.8) !important;
        box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        border-radius: 6px !important;
        padding: 2px 4px !important;
        right: 12px !important;
        top: 12px !important;
        position: fixed !important;
        min-width: 56px;
        z-index: 1200 !important;
        font-family: 'Nanum Myeongjo', 'East Sea Dokdo', serif;
        font-size: 10px;
        color: #f5e9d2;
    }
    .leaflet-control-layers-toggle {
        background: linear-gradient(45deg, #8B4513, #A0522D);
        border-radius: 3px;
        width: 22px;
        height: 16px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.4);
        border: 1px solid #DAA520;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0.9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 7px;
        color: #f5e9d2;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .leaflet-control-layers-toggle::before {
        content: "";
    }
    .leaflet-control-layers-toggle:hover {
        opacity: 1;
        box-shadow: 0 3px 8px rgba(0,0,0,0.6);
        transform: scale(1.05);
        background: linear-gradient(45deg, #A0522D, #8B4513);
    }
    .leaflet-control-layers-expanded {
        background: rgba(30, 42, 56, 0.98) !important;
        border-radius: 7px !important;
        box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        border: 1px solid rgba(218, 165, 32, 0.5);
        backdrop-filter: blur(10px) saturate(0.9) !important;
    }
    .leaflet-control-layers-list label {
        font-family: 'Nanum Myeongjo', 'East Sea Dokdo', serif;
        font-size: 10px;
        color: #f5e9d2;
        letter-spacing: 0.02em;
        margin-bottom: 1px;
        padding: 2px 3px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 3px;
        border-radius: 2px;
        transition: background-color 0.2s ease;
        white-space: nowrap;
    }
    .leaflet-control-layers-list label:hover {
        background-color: rgba(218, 165, 32, 0.1);
    }
    .leaflet-control-layers-separator {
        border-top: 1px solid rgba(218, 165, 32, 0.3);
        margin: 1px 0;
    }
    .leaflet-control-layers-base label input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 11px;
        height: 11px;
        border: 1px solid #DAA520;
        border-radius: 50%;
        background: rgba(30, 42, 56, 0.8);
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    .leaflet-control-layers-base label input[type="radio"]:checked {
        background: #DAA520;
        border-color: #FFD700;
        box-shadow: 0 0 5px rgba(218, 165, 32, 0.6);
    }
    .leaflet-control-layers-base label input[type="radio"]:hover {
        border-color: #FFD700;
        box-shadow: 0 0 3px rgba(218, 165, 32, 0.4);
    }
    .leaflet-control-layers-base label input[type="radio"]:checked::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 3px;
        height: 3px;
        background: #2d1c0b;
        border-radius: 50%;
    }

    /* ğŸš© [ì¶”ê°€] ìˆ˜ë¬µí™” ë²ˆì§ íš¨ê³¼ (SVG filter) - ë¸”ëŸ¬ íš¨ê³¼ ì œê±°, ì„ ëª…ë„ í–¥ìƒ */
    .sumi-ink-effect {
        filter: contrast(1.1) brightness(1.05); /* ë¸”ëŸ¬ ëŒ€ì‹  ëŒ€ë¹„ì™€ ë°ê¸° ì¡°ì •ìœ¼ë¡œ ì„ ëª…ë„ í–¥ìƒ */
    }

    /* ğŸš© [ì¶”ê°€] ì£¼ìš” ì§€ëª…/íƒ€ì´í‹€ í°íŠ¸ */
    .vintage-label {
        font-family: 'East Sea Dokdo', 'Nanum Myeongjo', serif !important;
        font-size: 1.25em;
        letter-spacing: 0.04em;
        color: #2d1c0b;
        text-shadow: 0 1px 0 #fff, 0 0 6px #e5e0d8;
    }

    /* ğŸš© [ì¶”ê°€] ì„¤ëª…ë¬¸/íŒì—…ìš© */
    .vintage-desc {
        font-family: 'Noto Serif KR', serif;
        font-size: 1em;
        letter-spacing: 0.02em;
        line-height: 1.7;
        color: #3a2a1a;
    }

    /* ğŸš© [v3.3] êµ­ê°€ëª… ë¼ë²¨ â€” êµ­ê°€ ê³ ìœ  ìƒ‰ìƒ, ëšœë ·í•œ ì™¸ê³½ì„  */
    .macro-country-name {
        font-family: 'Nanum Myeongjo', serif;
        font-size: 16px;
        font-weight: bold;
        white-space: nowrap;
        pointer-events: none;
        text-align: center;
        line-height: 1;
        letter-spacing: 3px;
        text-shadow: -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000, 0px 0px 3px #000;
        /* --marker-scale ì˜í–¥ ì°¨ë‹¨: êµ­ê°€ëª…ì€ renderMacroCountryNames()ì˜ countryFontSizeë¡œë§Œ í¬ê¸° ì œì–´ */
        transform: scale(1) !important;
    }

    .macro-country-label-icon { pointer-events: none; }

</style>
<script>
// ğŸš€ [ìŠ¤ë§ˆíŠ¸ ìºì‹œ ê´€ë¦¬] ë°ì´í„° êµ¬ì¡° ë³€ê²½ ì‹œì—ë§Œ IndexedDB ì‚­ì œ
(function() {
    const CONFIG = {
        APP_VERSION: '3.5.0',           // [v3.5] castle ìºì‹œ ë³µì› - IndexedDB ìºì‹±ìœ¼ë¡œ 13ì´ˆâ†’0.1ì´ˆ
        DATA_SCHEMA_VERSION: '2.0.0'    // ë°ì´í„° êµ¬ì¡° ë³€ê²½ ì‹œì—ë§Œ ë³€ê²½
    };
    
    const storedAppVersion = localStorage.getItem('app_version');
    const storedSchemaVersion = localStorage.getItem('data_schema_version');
    
    // 1ï¸âƒ£ ë°ì´í„° êµ¬ì¡°ê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ IndexedDB ì‚­ì œ
    if (storedSchemaVersion !== CONFIG.DATA_SCHEMA_VERSION) {
        console.log(`ğŸ“¦ ë°ì´í„° êµ¬ì¡° ë³€ê²½ ê°ì§€: ${storedSchemaVersion || 'ì—†ìŒ'} â†’ ${CONFIG.DATA_SCHEMA_VERSION}`);
        console.log('ğŸ“¦ IndexedDB ì´ˆê¸°í™” ì¤‘... (ì˜í†  ë°ì´í„° ì¬ë‹¤ìš´ë¡œë“œ í•„ìš”)');
        
        // IndexedDBë§Œ ì„ íƒì  ì‚­ì œ
        if (window.indexedDB) {
            indexedDB.databases().then(dbs => {
                dbs.forEach(db => {
                    console.log(`ğŸ—‘ï¸ IndexedDB ì‚­ì œ: ${db.name}`);
                    indexedDB.deleteDatabase(db.name);
                });
            }).catch(e => console.warn('IndexedDB í´ë¦¬ì–´ ì‹¤íŒ¨:', e));
        }
        
        localStorage.setItem('data_schema_version', CONFIG.DATA_SCHEMA_VERSION);
    } else {
        console.log(`â™»ï¸ ê¸°ì¡´ ìºì‹œ ë°ì´í„° ì‚¬ìš© ê°€ëŠ¥ (ìŠ¤í‚¤ë§ˆ ë²„ì „: ${CONFIG.DATA_SCHEMA_VERSION})`);
    }
    
    // 2ï¸âƒ£ ì•± ë²„ì „ì´ ë³€ê²½ëœ ê²½ìš° (UI/ë¡œì§ ìˆ˜ì •)
    if (storedAppVersion !== CONFIG.APP_VERSION) {
        console.log(`ğŸ”„ ì•± ë²„ì „ ì—…ë°ì´íŠ¸: ${storedAppVersion || 'ì—†ìŒ'} â†’ ${CONFIG.APP_VERSION}`);
        
        // Service Worker ìºì‹œë§Œ í´ë¦¬ì–´ (HTML/CSS/JS ìµœì‹ í™”)
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => {
                    console.log(`ğŸ—‘ï¸ ìºì‹œ ì‚­ì œ: ${name}`);
                    caches.delete(name);
                });
            });
        }
        
        localStorage.setItem('app_version', CONFIG.APP_VERSION);
        
        // ê°•ì œ ë¦¬ë¡œë“œ (ìºì‹œ ë¬´ì‹œ)
        if (!window.location.hash.includes('reloaded')) {
            console.log('ğŸ”„ ê°•ì œ ë¦¬ë¡œë“œ ì‹¤í–‰ (ë°ì´í„°ëŠ” ë³´ì¡´)...');
            window.location.href = window.location.pathname + '?v=' + CONFIG.APP_VERSION + '&t=' + Date.now() + '#reloaded';
            return;
        }
    }
    
    console.log(`âœ… ë²„ì „ í™•ì¸ ì™„ë£Œ: ì•± ${CONFIG.APP_VERSION} / ë°ì´í„° ${CONFIG.DATA_SCHEMA_VERSION}`);
})();

// (removed duplicate/conflicting menu toggle logic)
</script>
<style>
            .header-icon img {
            width: 120px;
            height: auto;
            max-width: 100%;
        }
/* ì„¸ë¡œê°€ ê°€ë¡œë³´ë‹¤ ê¸¸ë©´(ëª¨ë°”ì¼ ê°•ì œ) ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ì ìš© */
body.force-mobile #mainContainer {
    flex-direction: column !important;
    height: 100% !important;
    padding: 0 !important;
    padding-top: 44px !important; /* íƒ‘ë°” ë†’ì´ë§Œí¼ ì—¬ë°± */
    box-sizing: border-box !important;
}
body.force-mobile #leftColumn {
    flex-basis: 100% !important;
}
body.force-mobile #rightPanel {
    position: fixed !important;
    z-index: 1002;
    background-color: #1e2a38e0;
    backdrop-filter: blur(10px);
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
body.force-mobile #controls-wrapper {
    position: static !important;
    top: auto !important;
    left: auto !important;
    width: 100% !important;
    margin-top: 0 !important;
    border-bottom: 2px solid #00aaff;
    z-index: 1000 !important;
    background-color: #1e2a38e0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 0 0 12px 12px;
    display: block !important;
    transform: none !important;
    animation: none !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
}
body.force-mobile #controls-wrapper.visible {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
body.force-mobile #controls-wrapper:not(.visible) {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
@keyframes slideDownMenu {
    /* í”Œë¡œíŒ… ì• ë‹ˆë©”ì´ì…˜ ì‚¬ìš© ì•ˆí•¨ */
}
/* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œ top-barë¥¼ PCì™€ ë™ì¼í•˜ê²Œ ìƒë‹¨ì— ìœ ì§€ */
body.force-mobile #top-bar-container {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding: 5px 10px !important;
    position: fixed !important;
    top: 0 !important;
    bottom: auto !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 1100 !important;
    background-color: rgba(30, 42, 56, 0.97) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
}
body.force-mobile #top-left-icons {
    display: none !important;
}
body.force-mobile #main-title {
    display: none !important;
}
body.force-mobile #top-right-auth {
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    flex-wrap: nowrap !important;
}
/* ëª¨ë°”ì¼ íƒ‘ë°”: ì‚¬ê´€ëª¨ì§‘Â·ë­í‚¹ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (í–„ë²„ê±° ë©”ë‰´ë¡œ ëŒ€ì²´) */
body.force-mobile #recruitLink,
body.force-mobile #rankingBtn {
    display: none !important;
}
/* ëª¨ë°”ì¼ íƒ‘ë°”: ê³ ì§€ë„ ë²„íŠ¼ ì»´íŒ©íŠ¸í•˜ê²Œ */
body.force-mobile #topbar-ancient-maps-btn {
    font-size: 11px !important;
    padding: 4px 8px !important;
    margin-left: 0 !important;
}
body.force-mobile #topbar-ancient-maps-dropdown-menu {
    min-width: 160px !important;
    font-size: 11px !important;
    right: 0 !important;
    left: auto !important;
}
/* ëª¨ë°”ì¼ íƒ‘ë°”: ì‚¬ìš©ìëª… í‘œì‹œ */
body.force-mobile #usernameDisplay {
    display: block !important;
    white-space: nowrap !important;
    font-weight: bold !important;
    font-size: 12px !important;
}
body.force-mobile #pcTopPanelToggleBtn {
    display: none !important;
}
/* ëª¨ë°”ì¼ íƒ‘ë°”: í¸ì§‘ ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (í–„ë²„ê±° ë©”ë‰´ë¡œ ëŒ€ì²´) */
body.force-mobile #topbar-edit-dropdown-container {
    display: none !important;
}
body.force-mobile #accountLink {
    display: inline-block !important;
    padding: 4px 8px !important;
    font-size: 11px !important;
}
body.force-mobile #adminLink {
    padding: 4px 8px !important;
    font-size: 11px !important;
}
body.force-mobile #logoutBtnHeader {
    padding: 4px 8px !important;
    font-size: 11px !important;
}
/* ëª¨ë°”ì¼ ì „ìš© ì§€ë„ ìœ„ ì»¨íŠ¸ë¡¤ ì™„ì „ ìˆ¨ê¸°ê¸° */
body.force-mobile #mobile-tile-layer-control {
    display: none !important;
}
body.force-mobile #mobile-left-controls {
    display: none !important;
}
body.force-mobile #time-controls-map {
    display: none !important;
}
/* ëª¨ë°”ì¼ì—ì„œ ë­í‚¹ íŒ¨ë„: ìŠ¬ë¼ì´ë” ë°”ë¡œ ìœ„ */
body.force-mobile #rankingDisplay {
    bottom: 60px !important;
}
body.force-mobile #rightPanel {
    top: 0;
    right: 0;
    width: 85vw;
    max-width: 400px;
    height: 100vh;
    border-left: 2px solid #00aaff;
    border-top: none;
    display: none !important;
    transform: translateX(100%) !important;
}
body.force-mobile #rightPanel.visible {
    display: flex !important;
    transform: none !important;
}
body.force-mobile #rightPanelToggleBtn {
    top: auto;
    bottom: 15px;
    left: auto;
    right: 15px;
    z-index: 1003;
    writing-mode: horizontal-tb;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 40px;
    padding: 0;
    display: block !important;
}
/* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œ í•„í„°/ê²€ìƒ‰ í–‰ì„ í•œ ì¤„ë¡œ ì»´íŒ©íŠ¸í•˜ê²Œ í‘œì‹œ */
body.force-mobile .right-controls {
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
    gap: 2px !important;
}
body.force-mobile #country-filter-container {
    order: 1 !important;
    flex-basis: auto !important;
    height: 24px !important;
}
body.force-mobile #country-filter-container label {
    font-size: 9px !important;
}
body.force-mobile #countryFilterSelect {
    font-size: 9px !important;
    padding: 1px 2px !important;
    height: 100% !important;
    min-width: 60px !important;
    width: 60px !important;
}
body.force-mobile #dynastyTimelineFilterPanel {
    order: 2 !important;
    flex-basis: auto !important;
    height: 24px !important;
}
body.force-mobile #ethnicityFilterContainer {
    font-size: 9px !important;
    height: 100% !important;
}
body.force-mobile #ethnicityFilterContainer label {
    font-size: 9px !important;
}
body.force-mobile #ethnicityFilterContainer select {
    font-size: 9px !important;
    padding: 1px 2px !important;
    height: 100% !important;
    min-width: 65px !important;
    width: 65px !important;
}
body.force-mobile .right-controls > div:last-child {
    order: 3 !important;
    flex: 0 0 auto !important;
    min-width: unset !important;
    width: auto !important;
    height: 24px !important;
    display: flex !important;
    align-items: center !important;
    gap: 1px !important;
}
body.force-mobile #searchInput {
    font-size: 9px !important;
    padding: 1px 3px !important;
    height: 100% !important;
    flex: 0 0 80px !important;
    min-width: 80px !important;
}
body.force-mobile #searchBtn {
    font-size: 9px !important;
    padding: 1px 4px !important;
    height: 100% !important;
    flex: 0 0 56px !important;
}

/* ğŸš© [ì œê±°ë¨ - í•˜ë‹¨ì˜ í†µí•© CSSë¡œ ëŒ€ì²´] */

/* ğŸš© [ì œê±°ë¨ - í•˜ë‹¨ì˜ í†µí•© CSSë¡œ ëŒ€ì²´] */

body.force-mobile #time-controls-map .time-control-btn {
    min-height: 24px !important;
    font-size: 9px !important;
    padding: 2px 3px !important;
    min-width: 24px !important;
    flex: 0 0 auto !important;
    order: 10 !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì¬ìƒ/ì •ì§€ ë²„íŠ¼ ë° ì»¨í…Œì´ë„ˆ ê°•ì œ ìˆ¨ê¸°ê¸° */
body.force-mobile .playback-button-container,
body.force-mobile #playBtn,
body.force-mobile #pauseBtn,
body.force-mobile #time-controls-map .playback-button-container,
body.force-mobile #time-controls-map #playBtn,
body.force-mobile #time-controls-map #pauseBtn {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
}

/* ğŸš© PCì—ì„œ ëª¨ë°”ì¼ ì „ìš© ìš”ì†Œ ìˆ¨ê¸°ê¸° */
#mobile-left-controls,
#mobile-right-controls {
    display: none !important;
}

/* (ëª¨ë°”ì¼ ì „ìš© ì»¨íŠ¸ë¡¤ì€ ì´ì œ í–„ë²„ê±° ë©”ë‰´ë¡œ ëŒ€ì²´ - ì•„ë˜ force-mobile ì„¹ì…˜ì—ì„œ ëª¨ë‘ ìˆ¨ê¹€ ì²˜ë¦¬ë¨) */

/* ğŸš© [ì™„ì „ ì¬ì„¤ê³„] ëª¨ë°”ì¼ ìƒë‹¨ UI ì™„ë²½ ì •ë ¬ */

/* ì—°ë„ í‘œì‹œ ë°•ìŠ¤ */
body.force-mobile #timeLabelDisplay {
    font-size: 10px !important;
    font-family: 'Courier New', monospace !important;
    white-space: nowrap !important;
    flex: 0 0 auto !important;
    background: rgba(30, 42, 56, 0.9) !important;
    padding: 6px 8px !important;
    border-radius: 4px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 28px !important;
    line-height: 1 !important;
    box-sizing: border-box !important;
    border: 1px solid rgba(93, 113, 133, 0.5) !important;
}

/* í™”ì‚´í‘œ ë²„íŠ¼ */
body.force-mobile #mobile-year-controls button {
    padding: 0 10px !important;
    font-size: 12px !important;
    height: 28px !important;
    min-height: 28px !important;
    max-height: 28px !important;
    background: rgba(30, 42, 56, 0.95) !important;
    border: 1px solid #5d7185 !important;
    border-radius: 4px !important;
    line-height: 26px !important;
    display: inline-block !important;
    text-align: center !important;
    box-sizing: border-box !important;
    cursor: pointer !important;
    color: #ecf0f1 !important;
    vertical-align: top !important;
    margin: 0 !important;
}

/* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œ ê¸°ì¡´ ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ìˆ¨ê¹€ - ì´ë¯¸ ìƒìœ„ CSSì—ì„œ ì²˜ë¦¬ë¨ */

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ í‘œì‹œ ë²„íŠ¼ í‘œì‹œ - mobile-right-controlsë¡œ ì²˜ë¦¬ë¨ */

/* ëª¨ë°”ì¼ ìš°ì¸¡ ì»¨íŠ¸ë¡¤ ë‚´ë¶€ ë²„íŠ¼ë“¤ í†µì¼ ìŠ¤íƒ€ì¼ */
body.force-mobile #mobile-right-controls button {
    height: 28px !important;
    min-height: 28px !important;
    max-height: 28px !important;
    padding: 0 8px !important;
    font-size: 10px !important;
    white-space: nowrap !important;
    line-height: 1 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-sizing: border-box !important;
    border-radius: 4px !important;
    background: rgba(30, 42, 56, 0.95) !important;
    border: 1px solid #5d7185 !important;
    color: #ecf0f1 !important;
    cursor: pointer !important;
}

/* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œ ì™• ëª©ë¡ íŒ¨ë„ ìŠ¤íƒ€ì¼ (ê¸°ë³¸ ìˆ¨ê¹€ì€ JavaScriptë¡œ ì²˜ë¦¬) */
body.force-mobile #map-king-panel {
    width: 200px !important;
    max-height: 20vh !important;
    padding: 6px !important;
    bottom: 75px !important;
    left: 5px !important;
}

body.force-mobile #map-king-panel h3 {
    font-size: 9px !important;
    margin-bottom: 4px !important;
    padding-bottom: 3px !important;
}

body.force-mobile #map-king-list {
    font-size: 7px !important;
    line-height: 1.3 !important;
}

/* ğŸš© [ì¶”ê°€] PCì—ì„œ ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ */
#map-history-panel {
    transition: width 0.3s ease, padding 0.3s ease !important;
}

#map-history-panel:not(.expanded) {
    width: 32px !important;
    padding: 4px 2px !important;
    overflow: hidden !important;
}

/* ê°ì¶˜ ìƒíƒœì—ì„œ ìˆ¨ê¸¸ ìš”ì†Œë“¤ - IDì™€ ìì‹ ì„ íƒìë¡œ ì •í™•íˆ ì§€ì • */
#map-history-panel:not(.expanded) #map-history-resizer,
#map-history-panel:not(.expanded) > div:nth-child(2) > span,
#map-history-panel:not(.expanded) > div:nth-child(3),
#map-history-panel:not(.expanded) > div:nth-child(4),
#map-history-panel:not(.expanded) #map-prev-history-btn,
#map-history-panel:not(.expanded) #map-next-history-btn,
#map-history-panel:not(.expanded) #map-open-history-form-btn {
    display: none !important;
}

/* ğŸš© [ìˆ˜ì •] ì¶•ì†Œ ì‹œ íŒ¨ë„ ìì²´ë¥¼ íˆ¬ëª…í•˜ê³  ì‘ê²Œ, ì—°ëŒ€í‘œ ìš°ì¸¡ í•˜ë‹¨ìœ¼ë¡œ ì´ë™ */
#map-history-panel:not(.expanded) {
    background: transparent !important;
    backdrop-filter: none !important;
    padding: 0 !important;
    width: auto !important;
    height: auto !important;
    top: 270px !important; /* ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ í•˜ë‹¨ (60px + 200px ë†’ì´ + 10px ì—¬ë°±) */
    right: 15px !important;
    bottom: auto !important;
    left: auto !important;
    transform: none !important;
    box-shadow: none !important;
    border: none !important;
}

/* í† ê¸€ ë²„íŠ¼ë§Œ ìœ ì§€ - ë°°ê²½ ìˆê²Œ */
#map-history-panel:not(.expanded) #map-history-toggle-btn {
    display: inline-block !important;
    margin: 0 !important;
    padding: 4px 8px !important;
    min-width: 40px !important;
    font-size: 11px !important;
    background: rgba(30, 42, 56, 0.95) !important;
    border: 1px solid #5d7185 !important;
    border-radius: 4px !important;
}

/* ê°ì¶˜ ìƒíƒœì—ì„œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆëŠ” ì¤‘ì•™ ì •ë ¬ */
#map-history-panel:not(.expanded) > div:nth-child(2) {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    margin: 0 !important;
    background: transparent !important;
}

#map-history-panel.expanded {
    width: 320px !important;
    padding: 12px !important;
}

#map-history-panel.expanded #map-history-resizer {
    display: block !important;
}

/* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œ ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ìŠ¤íƒ€ì¼ (ê¸°ë³¸ ìˆ¨ê¹€ì€ JavaScriptë¡œ ì²˜ë¦¬) */
body.force-mobile #map-history-panel {
    width: 40px !important;
    padding: 8px 4px !important;
    right: 5px !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì¶•ì†Œ ìƒíƒœì¼ ë•Œ ì—°ëŒ€í‘œ ìš°ì¸¡ í•˜ë‹¨ìœ¼ë¡œ */
body.force-mobile #map-history-panel:not(.expanded) {
    top: 200px !important; /* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ ì—°ëŒ€í‘œ í•˜ë‹¨ (35px + 150px ë†’ì´ + 15px ì—¬ë°±) */
    right: 10px !important;
}

body.force-mobile #map-history-panel.expanded {
    width: calc(100vw - 10px) !important;
    max-width: 320px !important;
    padding: 8px !important;
    right: 5px !important;
    left: auto !important;
    max-height: 50vh !important;
    overflow-y: auto !important;
}

body.force-mobile #map-history-panel > div:first-child span {
    display: none !important;
}

body.force-mobile #map-history-panel h3,
body.force-mobile #map-history-panel #map-history-records,
body.force-mobile #map-history-panel #map-prev-history-btn,
body.force-mobile #map-history-panel #map-next-history-btn,
body.force-mobile #map-history-panel #map-open-history-form-btn {
    display: none !important;
}

body.force-mobile #map-history-panel.expanded > div:first-child span {
    display: inline !important;
}

body.force-mobile #map-history-panel.expanded h3,
body.force-mobile #map-history-panel.expanded #map-history-records {
    display: block !important;
}

body.force-mobile #map-history-panel.expanded #map-prev-history-btn,
body.force-mobile #map-history-panel.expanded #map-next-history-btn,
body.force-mobile #map-history-panel.expanded #map-open-history-form-btn {
    display: inline-block !important;
}

body.force-mobile #map-history-panel h3 {
    font-size: 11px !important;
}

body.force-mobile #map-history-panel.expanded h3 {
    font-size: 11px !important;
}

body.force-mobile #map-history-records {
    font-size: 9px !important;
    line-height: 1.4 !important;
}

body.force-mobile #map-history-panel #map-history-toggle-btn {
    transform: rotate(90deg);
}

body.force-mobile #map-history-panel.expanded #map-history-toggle-btn {
    transform: rotate(0deg);
}

/* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œ í†µí•© íƒ€ì„ë¼ì¸ì„ í•˜ë‹¨ ì¤‘ì•™ì— ë°°ì¹˜ */
body.force-mobile #timeline-slider-wrapper {
    position: fixed !important;
    bottom: 20px !important; /* ëª¨ë°”ì¼ì—ì„œëŠ” ë” ë‚®ê²Œ */
    left: 50% !important;
    transform: translateX(-50%) !important;
    top: auto !important;
    right: auto !important;
    width: 90% !important; /* ëª¨ë°”ì¼ì—ì„œ 90% ë„ˆë¹„ */
    max-width: none !important;
    z-index: 900 !important;
    background: transparent !important;
    border: none !important; /* ğŸš© [ì¶”ê°€] í…Œë‘ë¦¬ ì œê±° */
    box-shadow: none !important; /* ğŸš© [ì¶”ê°€] ê·¸ë¦¼ì ì œê±° */
}

body.force-mobile #timeline-container {
    position: relative !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    background: transparent !important; /* ğŸš© [ì¶”ê°€] ë°°ê²½ ì™„ì „ íˆ¬ëª… */
    border: none !important; /* ğŸš© [ì¶”ê°€] í…Œë‘ë¦¬ ì œê±° */
    max-height: 150px !important; /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ìµœëŒ€ ë†’ì´ ì œí•œ */
    overflow-y: auto !important; /* ğŸš© [ì¶”ê°€] ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì—°ëŒ€í‘œ í˜ì´ë“œ ìš”ì†Œ ì™„ì „ ì œê±° */
body.force-mobile #timeline-fade-left,
body.force-mobile #timeline-fade-right {
    display: none !important;
}

/* ğŸš© [ì œê±°ë¨] edit-controlsëŠ” ì´ì œ time-controls-map ë‚´ë¶€ì— mobile-right-controlsë¡œ í†µí•© */

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ìŠ¤ì¼€ì¼ ìˆ¨ê¸°ê¸° (í™•ëŒ€/ì¶•ì†Œ ë²„íŠ¼ì€ PCì—ì„œë„ ì œê±°) */
body.force-mobile .leaflet-control-scale {
    display: none !important;
}

/* ğŸš© [ì‚­ì œë¨] ëª¨ë°”ì¼ì—ì„œ ê³ ëŒ€ ì§€ë„ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ì¡°ì • (íƒ‘ë°”ë¡œ ì´ë™ë¨) */
/* body.force-mobile #ancient-map-button-container {
    bottom: 120px !important; 
    left: 5px !important;
    right: auto !important;
    flex-direction: column !important; 
    max-width: 150px !important;
    padding: 8px !important;
} */

body.force-mobile #map-search-filter {
    display: none !important; /* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œ ì™„ì „íˆ ìˆ¨ê¹€ */
}

body.force-mobile #map-search-filter select,
body.force-mobile #map-search-filter input,
body.force-mobile #map-search-filter button {
    font-size: 8px !important;
    padding: 1px 3px !important;
    min-height: 22px !important;
    flex-shrink: 0 !important;
}

body.force-mobile #map-search-filter label {
    font-size: 8px !important;
    white-space: nowrap !important;
}

body.force-mobile #drawingForm {
    display: none !important; /* ë³´ì´ì§€ ì•Šì„ ë•Œ */
    position: fixed !important;
    bottom: 10px !important;
    left: 10px !important;
    right: auto !important;
    top: auto !important;
    transform: none !important;
    max-width: 95% !important;
    width: auto !important;
    padding: 8px !important;
}

body.force-mobile #drawingForm[style*="display: block"],
body.force-mobile #drawingForm[style*="display:block"] {
    display: flex !important; /* ë³´ì¼ ë•Œ */
}

body.force-mobile #drawingForm button {
    min-height: 36px !important;
    font-size: 12px !important;
    padding: 6px 8px !important;
}

body.force-mobile #drawingForm input,
body.force-mobile #drawingForm select {
    min-height: 32px !important;
    font-size: 12px !important;
    padding: 4px 6px !important;
}

body.force-mobile #drawingForm label {
    font-size: 11px !important;
}

/* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ëª¨ë“  í¸ì§‘ í¼ í¬ê¸° ì¡°ì • */
body.force-mobile #castleForm,
body.force-mobile #historyForm,
body.force-mobile #countryForm,
body.force-mobile #kingForm,
body.force-mobile #eventForm {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 90vw !important;
    max-width: 90vw !important;
    max-height: 85vh !important;
    overflow-y: auto !important;
    padding: 15px !important;
}

body.force-mobile #castleForm h3,
body.force-mobile #historyForm h3,
body.force-mobile #countryForm h3,
body.force-mobile #kingForm h3,
body.force-mobile #eventForm h3 {
    font-size: 16px !important;
    margin: 0 0 10px 0 !important;
}

body.force-mobile .form-row {
    margin-bottom: 8px !important;
}

body.force-mobile .form-row label {
    font-size: 13px !important;
    margin-bottom: 4px !important;
}

body.force-mobile .form-row input,
body.force-mobile .form-row select,
body.force-mobile .form-row textarea {
    font-size: 14px !important;
    padding: 8px !important;
    min-height: 40px !important;
}

body.force-mobile .form-row textarea {
    min-height: 80px !important;
}

body.force-mobile .form-actions button {
    font-size: 14px !important;
    padding: 10px 16px !important;
    min-height: 44px !important;
    margin: 4px !important;
}

body.force-mobile .marker-type-selector button {
    font-size: 13px !important;
    padding: 8px 12px !important;
    min-height: 40px !important;
}
</style>
<!DOCTYPE html>
<html lang="ko">
<head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <!-- ğŸš€ [ìºì‹œ ë¬´íš¨í™”] ë¸Œë¼ìš°ì € ìºì‹œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ê³ ë ¤ë§Œë¦¬ì§€ë„ (é«˜éº—è¬é‡Œåœ°åœ–) v2.0</title>
  <link rel="icon" type="image/jpg" href="https://pds.joongang.co.kr/news/component/htmlphoto_mmdata/200609/htm_20060904073327a000a010-001.JPG">
  <!-- ğŸš© [ì¶”ê°€] Google Fonts (Noto Serif KR) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- ğŸš© [ìˆ˜ì •] Nanum Brush Script ê¸€ê¼´ ì¶”ê°€ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Yeon+Sung&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- ğŸš© [ì¶”ê°€] Leaflet.draw í”ŒëŸ¬ê·¸ì¸ -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath/leaflet.textpath.min.js"></script>
  <!-- ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì´ë²¤íŠ¸ë¥¼ ìœ„í•œ Hammer.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <!-- ğŸš© [ì¶”ê°€] Leaflet.PolylineDecorator í”ŒëŸ¬ê·¸ì¸ (í™”ì‚´í‘œìš©) -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <!-- Topojson for compressed territory tiles -->
  <script src="https://unpkg.com/topojson-client@3"></script>
  <style>
    /* ------------------- 1. ì „ì²´ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ CSS ------------------- */
    /* ğŸš© [ì¶”ê°€] ë·°í¬íŠ¸ ì „ì²´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ html, body ë†’ì´ ì„¤ì • */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
    body {
        background-color: #19191b; 
        /* background-image: url('https://i.pinimg.com/1200x/ea/ff/c5/eaffc5798174bca27342dc968d58a61a.jpg'); */
        /* background-size: cover; */
        /* background-position: center; */
        /* background-attachment: fixed; */
        color: #dbdbdb; 
        font-family: Arial, sans-serif;
        font-size:medium;
        display: flex; /* ğŸš© [ì¶”ê°€] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
        flex-direction: column; /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ì •ë ¬ */
    }
    /* ğŸš© [ìˆ˜ì •] mainContainerê°€ bodyì˜ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ flex-grow: 1 ì„¤ì • */
    #mainContainer {
        display: flex; /* ğŸš© [ìˆ˜ì •] mainContainerë¥¼ flexë¡œ ë³€ê²½ */
        width: 100%; /* ë„ˆë¹„ 100% */
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        padding: 0 10px 10px; /* ìƒë‹¨ ì—¬ë°± ì œê±°, ì¢Œìš°/í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
        box-sizing: border-box; /* íŒ¨ë”©ì„ ë„ˆë¹„/ë†’ì´ì— í¬í•¨ */
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    #map { 
        height: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #19191b; /* ğŸš© [ì¶”ê°€] íƒ€ì¼ ë¡œë”© ì „ ë°°ê²½ìƒ‰ ì„¤ì • */
        position: relative; /* ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ì˜ ê¸°ì¤€ì ìœ¼ë¡œ ì„¤ì • */
        overflow: hidden; /* ğŸš© [ì¶”ê°€] íƒ€ì¼ ë¡œë”© ì¤‘ ê²½ê³„ê°€ ë³´ì´ëŠ” í˜„ìƒ ë°©ì§€ */
    }
    /* ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì € í•¸ë“¤ ìŠ¤íƒ€ì¼ */
    #resizer { 
        width: 5px; 
        cursor: col-resize; 
        background-color: #5d7185; 
        flex-shrink: 0; 
        transition: background-color 0.2s; 
    } 
    #resizer:hover { 
        background-color: #00aaff; 
    }
    /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ë¦¬ì‚¬ì´ì € í•¸ë“¤ ìŠ¤íƒ€ì¼ */
    #vertical-resizer {
        height: 1px;
        cursor: row-resize;
        background-color: #ffffff;
        flex-shrink: 0; /* ë¦¬ì‚¬ì´ì € ë†’ì´ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
    }
    #rightPanel {
        /* ğŸš© [ìˆ˜ì •] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ë‚´ë¶€ ìš”ì†Œ ì œì–´ */
        display: flex;
        flex-direction: column;
        flex-basis: 30%; /* ğŸš© [ìˆ˜ì •] widthë¥¼ flex-basisë¡œ ë³€ê²½ */
        transition: all 0.3s ease-in-out; /* ğŸš© [ì¶”ê°€] ì ‘ê³  í´ì§ˆ ë•Œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        position: relative; /* ğŸš© [ì¶”ê°€] í† ê¸€ ë²„íŠ¼ì˜ ìœ„ì¹˜ ê¸°ì¤€ì  */
        border-top: 3px solid #00aaff; 
        /* ğŸš© [í•µì‹¬ ìˆ˜ì •] ì˜¤ë¥¸ìª½ íŒ¨ë„ì— ë°°ê²½ ì´ë¯¸ì§€ ë° ê°€ë…ì„±ì„ ìœ„í•œ ì˜¤ë²„ë ˆì´ ì¶”ê°€ */
        background-image: url('https://i.namu.wiki/i/VnqWqBvjxcHxswDWPKyIinchC7ZIdLK1N5LfaklC7gnTyzvTRTlekzY8Ln249BOp5cWCv2QbtwSnjZ1OYDq8yQ.webp');
        background-size: cover;
        background-position: center;
        background-color: rgba(0, 0, 0, 0.5); /* ì–´ë‘ìš´ ì˜¤ë²„ë ˆì´ */
        background-blend-mode: multiply; /* ì´ë¯¸ì§€ë¥¼ ì–´ë‘¡ê²Œ ë§Œë“¦ */
        min-height: 0; /* ğŸš© [ì¶”ê°€] flex ìì‹ ìš”ì†Œì˜ ìŠ¤í¬ë¡¤ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ ì„¤ì • */
    }
    /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #rightPanelToggleBtn {
        position: absolute;
        top: 10px;
        left: -28px; /* íŒ¨ë„ ì™¼ìª½ì— ë¶™ë„ë¡ ìœ„ì¹˜ ì¡°ì • */
        z-index: 999;
        padding: 10px 5px;
        writing-mode: vertical-rl; /* í…ìŠ¤íŠ¸ë¥¼ ì„¸ë¡œë¡œ í‘œì‹œ */
        border-radius: 5px 0 0 5px;
        border-right: none;
        font-size: 12px;
        line-height: 1;
    }
    /* ğŸš© [ì¶”ê°€] ë¦¬ì‚¬ì´ì €ë„ í•¨ê»˜ ìˆ¨ê¹€ ì²˜ë¦¬ */
    #resizer.hidden {
        display: none; /* ë¦¬ì‚¬ì´ì €ëŠ” ì™„ì „íˆ ìˆ¨ê¹€ */
    }
    #kingPanel {
        display: flex; /* ğŸš© [ì¶”ê°€] flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
        flex-direction: column; /* ğŸš© [ì¶”ê°€] ìˆ˜ì§ ì •ë ¬ */
        flex-shrink: 0; /* ğŸš© [ì¶”ê°€] íŒ¨ë„ ë†’ì´ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
        border-bottom: 1px solid #5d7185;
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    /* ğŸš© [ì¶”ê°€] ì™• ëª©ë¡ ë‚´ìš© ì˜ì—­ ìŠ¤í¬ë¡¤ ì ìš© */
    #kingPanel .slider-label {
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ë°” í‘œì‹œ */
    }
    #historyPanelContainer {
        display: flex; /* ğŸš© [ìˆ˜ì •] ë‚´ë¶€ ìš”ì†Œë¥¼ flexë¡œ ì œì–´ */
        flex-direction: column;
        flex-basis: 70%;
        padding-top: 15px;
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
    }
    /* ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ ë‚´ìš© ì˜ì—­ ìŠ¤í¬ë¡¤ ì ìš© */
    #historyRecords {
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ë°” í‘œì‹œ */
        min-height: 0; /* flex ì•„ì´í…œì˜ ìµœì†Œ ë†’ì´ ë¬¸ì œ í•´ê²° */
        padding-right: 5px; /* ìŠ¤í¬ë¡¤ë°”ì™€ì˜ ê°„ê²© í™•ë³´ */
    }
    #historyPanel {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        transition: all 0.3s ease-in-out; /* ğŸš© [ì¶”ê°€] ì ‘ê³  í´ì§ˆ ë•Œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
    }
    #historyPanel.collapsed {
        display: none;
    }
    #historyPanelToggleBtn {
        margin-left: 10px;
        cursor: pointer;
    }
    /* ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë°” ì»¨í…Œì´ë„ˆ - í•­ìƒ í‘œì‹œ */
    #timeline-container {
        position: fixed;
        bottom: 45px;
        left: 2%;
        right: 2%;
        width: 96%;
        height: 60px; /* ë†’ì´ ì¦ê°€ë¡œ ì´ë²¤íŠ¸ ë§ˆì»¤ ê³µê°„ í™•ë³´ */
        overflow: visible;
        display: block;
        background: transparent;
        z-index: 9998;
        pointer-events: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ì´ë²¤íŠ¸ ì°¨ë‹¨ */
    }
    
    /* ì´ë²¤íŠ¸ ë§ˆì»¤ë“¤ì„ ìƒë‹¨ì— ë°°ì¹˜ */
    #timeline-container .historical-event-marker {
        position: absolute;
        top: 0;
        pointer-events: auto;
    }
    
    /* ì—°ë„ í‘œì‹œë¥¼ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ ìƒë‹¨ì— ë°°ì¹˜ */
    #timeline-container #year-indicator {
        position: absolute;
        top: -35px;
        left: 50%;
        transform: translateX(-50%);
        pointer-events: none;
    }

    /* ğŸš© [ìˆ˜ì •] íƒ€ì„ìŠ¬ë¼ì´ë” ì»¨íŠ¸ë¡¤ - í•­ìƒ í‘œì‹œ */
    #timeline-control {
        position: fixed;
        bottom: 5px;
        left: 2.5vw; /* 95vw ë„ˆë¹„ë¡œ ì¤‘ì•™ ì •ë ¬ */
        width: 95vw;
        z-index: 9999;
        pointer-events: none;
        background: transparent; /* íˆ¬ëª… ë°°ê²½ */
        border-radius: 4px;
        padding: 2px;
        display: block !important; /* ê°•ì œ í‘œì‹œ */
    }

    /* ìŠ¬ë¼ì´ë”ë§Œ ì´ë²¤íŠ¸ í—ˆìš© */
    #timeline-control #combinedSlider {
        pointer-events: auto;
    }

    /* ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ - ì˜µì…”ë„ */
    #timeline-sidebar {
        position: fixed;
        bottom: 40px;
        left: 2%;
        right: 2%;
        width: 96%;
        max-width: none;
        height: 70vh;
        background: rgba(10, 16, 26, 0.82);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,220,100,0.15);
        border-radius: 10px;
        z-index: 1000;
        transition: opacity 0.3s ease;
        opacity: 0;
        pointer-events: none;
        overflow-x: hidden;
        overflow-y: auto;
        cursor: grab;
        padding: 10px;
        box-sizing: border-box;
        display: none;
    }

    #timeline-sidebar:active {
        cursor: grabbing;
    }

    /* ìŠ¬ë¼ì´ë” ê³ ì§€ë„ ìŠ¤íƒ€ì¼ */
    #combinedSlider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px; /* ë” ì»´íŒ©íŠ¸í•˜ê²Œ */
        background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
        border-radius: 3px; /* ë°˜ì§€ë¦„ ê°ì†Œ */
        outline: none;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    #combinedSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px; /* ë” ì‘ê²Œ */
        height: 16px; /* ë” ì‘ê²Œ */
        background: linear-gradient(45deg, #DAA520, #FFD700);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 1px 4px rgba(0,0,0,0.4);
        border: 1px solid #8B4513; /* í…Œë‘ë¦¬ ì–‡ê²Œ */
        margin-top: -5px; /* ì¤‘ì•™ ì •ë ¬ */
    }

    #combinedSlider::-moz-range-thumb {
        width: 16px; /* ë” ì‘ê²Œ */
        height: 16px; /* ë” ì‘ê²Œ */
        background: linear-gradient(45deg, #DAA520, #FFD700);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 1px 4px rgba(0,0,0,0.4);
        border: 1px solid #8B4513; /* í…Œë‘ë¦¬ ì–‡ê²Œ */
    }

    /* ìŠ¬ë¼ì´ë” ì—°ë„ íˆ´íŒ */
    #slider-year-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 3px 6px; /* íŒ¨ë”© ê°ì†Œ */
        border-radius: 3px; /* ë°˜ì§€ë¦„ ê°ì†Œ */
        font-size: 11px; /* í°íŠ¸ í¬ê¸° ê°ì†Œ */
        font-weight: bold;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 10000;
        bottom: 20px; /* ìœ„ì¹˜ ì¡°ì • */
        left: 50%;
        transform: translateX(-50%);
        font-family: 'East Sea Dokdo', cursive;
    }

    #slider-year-tooltip.show {
        opacity: 1;
    }
    /* ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ - ìƒë‹¨ ì¤‘ì•™ ì˜¤ë²„ë ˆì´ */
    #timeline-sidebar {
        position: fixed;
        bottom: 40px;
        left: 2%;
        right: 2%;
        width: 96%;
        max-width: none;
        height: 70vh;
        background: rgba(10, 16, 26, 0.82);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,220,100,0.15);
        border-radius: 10px;
        z-index: 1000;
        transition: opacity 0.3s ease;
        /* opacity, pointer-events, displayëŠ” JavaScriptë¡œ ì œì–´ */
        overflow-x: hidden;
        overflow-y: auto;
        padding: 15px;
        box-sizing: border-box;
    }

    #timeline-sidebar h3 {
        margin: 0;
        font-size: 18px;
        color: #f5e9d2;
        font-family: 'Nanum Myeongjo', serif;
        font-weight: 700;
        letter-spacing: 2px;
    }

    #close-timeline-sidebar {
        background: none;
        border: none;
        color: #ecf0f1;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

    #close-timeline-sidebar:hover {
        background-color: rgba(255,255,255,0.1);
    }

    /* ğŸš© [êµ¬í˜„] ì‚¬ê±´ ê·¸ë£¹í™” ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ (ìš°ì¸¡ ë°˜íˆ¬ëª… íŒ¨ë„) */
    #event-sidebar {
        position: fixed;
        top: 50px;
        right: 0;
        width: 320px;
        max-height: calc(100vh - 120px);
        background: rgba(20, 30, 42, 0.92);
        backdrop-filter: blur(10px);
        border-left: 1px solid rgba(139, 69, 19, 0.4);
        border-radius: 8px 0 0 8px;
        z-index: 1050;
        overflow-y: auto;
        padding: 14px;
        box-sizing: border-box;
        font-size: 14px;
        font-family: 'Nanum Myeongjo', 'East Sea Dokdo', serif;
        color: #ecf0f1;
        transition: transform 0.35s ease, opacity 0.35s ease;
        transform: translateX(100%);
        opacity: 0;
        pointer-events: none;
        box-shadow: -4px 0 16px rgba(0,0,0,0.4);
    }
    #event-sidebar.open {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }
    
    #event-sidebar h3 {
        margin: 0 0 12px 0;
        font-size: 18px;
        font-weight: bold;
        color: #f5e9d2;
        text-align: center;
        border-bottom: 1px solid rgba(255,255,255,0.3);
        padding-bottom: 10px;
        font-family: 'East Sea Dokdo', cursive;
        letter-spacing: 2px;
    }
    #event-sidebar .sidebar-close-btn {
        position: absolute;
        top: 8px;
        right: 10px;
        background: none;
        border: none;
        color: #ecf0f1;
        font-size: 20px;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
    }
    #event-sidebar .sidebar-close-btn:hover {
        background: rgba(255,255,255,0.15);
    }
    
    .accordion-item {
        margin-bottom: 8px;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .accordion-header {
        width: 100%;
        background: rgba(255,255,255,0.1);
        border: none;
        color: #fff;
        padding: 10px 12px;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }
    
    .accordion-header:hover {
        background: rgba(255,255,255,0.2);
    }
    
    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
        background: rgba(0,0,0,0.3);
    }
    
    .accordion-content.open {
        max-height: 2000px;
    }
    
    .event-item {
        padding: 8px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .event-item:hover {
        background: rgba(78, 205, 196, 0.15);
    }
    
    .event-item:last-child {
        border-bottom: none;
    }
    
    .event-year {
        font-weight: bold;
        color: #4ecdc4;
        font-size: 13px;
    }
    
    .event-title {
        font-weight: 500;
        color: #fff;
        margin: 4px 0;
        font-size: 14px;
    }
    
    .event-description {
        color: #ccc;
        font-size: 12px;
        line-height: 1.4;
        margin-top: 4px;
    }

    /* ğŸš© [ìˆ˜ì •] í†µí•© íƒ€ì„ë¼ì¸ ì»¨í…Œì´ë„ˆ */
    #timeline-container {
        position: relative;
        width: 100%;
        height: 20px; /* ğŸš© [ìˆ˜ì •] ë§ˆì»¤ í‘œì‹œìš©ìœ¼ë¡œ ë†’ì´ ì¶•ì†Œ */
        overflow: hidden;
        pointer-events: auto;
        display: block;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        margin-top: 5px;
        z-index: 5; /* ìŠ¬ë¼ì´ë”ë³´ë‹¤ ì•„ë˜ */
        box-sizing: border-box;
        margin-top: 5px; /* ğŸš© [ìˆ˜ì •] ê³µë°± ìµœì†Œí™” */
    }
    
    /* ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì½˜í…ì¸  - ë§ˆìŠ¤í¬ ì œê±° */
    #timeline-content {
        position: relative;
        height: 100%;
        min-width: 3000px; /* ì¶©ë¶„íˆ ë„“ì€ ìº”ë²„ìŠ¤ */
        padding-top: 0; /* ğŸš© [ìˆ˜ì •] tickì´ ìœ„ì— ìˆìœ¼ë¯€ë¡œ padding ì œê±° */
    }
    
    /* ğŸš© [ì¶”ê°€] timeline-sidebarì˜ timeline-contentë„ ë™ì¼í•œ ë„ˆë¹„ */
    #timeline-sidebar #timeline-content {
        min-width: 3000px; /* timeline-containerì™€ ë™ì¼í•œ ë„ˆë¹„ */
    }
    
    /* ğŸš© [ìˆ˜ì •] í˜ì´ë“œ ë ˆì´ì–´ ì œê±° */
    #timeline-fade-left,
    #timeline-fade-right {
        display: none;
    }
    

    
    /* ğŸš© [ì¶”ê°€] í•„í„° ì„ íƒ ì‹œ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
    select.filter-active {
        background-color: #4a90e2 !important;
        color: white !important;
        border-color: #357abd !important;
        font-weight: bold;
    }
    
    /* ğŸš© [ìˆ˜ì •] í™•ëŒ€ì¶•ì†Œ ë²„íŠ¼ ì™„ì „ ì œê±° */
    .leaflet-control-zoom {
        display: none !important;
    }
    
    /* ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar {
        position: absolute;
        height: 12px;
        border-radius: 2px;
        cursor: pointer;
        pointer-events: auto; /* ğŸš© [ìˆ˜ì •] í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ ë°›ë„ë¡ autoë¡œ ë³€ê²½ */
        transition: filter 0.2s;
        color: white;
        font-size: 10px;
        font-family: 'Nanum Myeongjo', serif;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
        text-align: left;
        line-height: 12px;
        padding-left: 5px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .timeline-bar:hover {
        filter: none;
        transform: scaleY(1.3);
    }
    /* ğŸš© [ì¶”ê°€] ì£¼ìš” ì™•ì¡° ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar.main-dynasty {
        height: 12px;
        z-index: 10;
        line-height: 12px;
    }
    /* ğŸš© [ì¶”ê°€] ë‚˜ë¨¸ì§€ êµ­ê°€ ë§‰ëŒ€ ìŠ¤íƒ€ì¼ */
    .timeline-bar.minor-dynasty {
        height: 10px;
        z-index: 5;
        opacity: 0.85;
    }
    /* ğŸš© [ìˆ˜ì •] í†µí•© íƒ€ì„ë¼ì¸ ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ - í•œì§€ ì§ˆê°ê³¼ ë¶“ë í•¸ë“¤ */
    #combinedSlider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        background: linear-gradient(90deg,
            rgba(241, 225, 161, 0.4) 0%,
            rgba(241, 225, 161, 0.6) 50%,
            rgba(241, 225, 161, 0.4) 100%);
        background-image:
            radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.15) 1px, transparent 1px),
            radial-gradient(circle at 75% 75%, rgba(0, 0, 0, 0.1) 1px, transparent 1px);
        background-size: 20px 20px, 15px 15px;
        outline: none;
        height: 10px;
        border-radius: 5px;
        border: 1px solid rgba(161, 131, 75, 0.4);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        position: relative;
        z-index: 1;
    }

    /* Chrome, Safari, Opera, Edge */
    /* ğŸš© [ìˆ˜ì •] ë¶“ë ëª¨ì–‘ ìŠ¬ë¼ì´ë” í•¸ë“¤ */
    #combinedSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        background-color: #1e2a38;
        background-image: url('https://github.com/projeffmanager-design/historymap/blob/main/2I63ySQI9qG-97MMKptL_n5FJhNOWE2DLt-ZKOcLL5TKeV4xxTfCN06j0lhGg5YMDH0ade2X99P-pzcKInnlOg.png?raw=true');
        background-size: 80% 80%;
        background-position: center;
        background-repeat: no-repeat;
        border: 2px solid #DAA520;
        border-radius: 3px 3px 12px 12px;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        transform: translateY(-7px);
        transition: all 0.2s ease;
        z-index: 15;
    }

    #combinedSlider::-webkit-slider-thumb:hover {
        transform: translateY(-10px) scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
    }

    #combinedSlider::-webkit-slider-thumb:active {
        transform: translateY(-6px) scale(0.95);
    }

    /* Firefox */
    #combinedSlider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background-color: #1e2a38;
        background-image: url('https://github.com/projeffmanager-design/historymap/blob/main/2I63ySQI9qG-97MMKptL_n5FJhNOWE2DLt-ZKOcLL5TKeV4xxTfCN06j0lhGg5YMDH0ade2X99P-pzcKInnlOg.png?raw=true');
        background-size: 80% 80%;
        background-position: center;
        background-repeat: no-repeat;
        border: 2px solid #DAA520;
        border-radius: 3px 3px 12px 12px;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        transition: all 0.2s ease;
        z-index: 15;
    }

    #combinedSlider::-moz-range-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.7);
    }

    #combinedSlider::-moz-range-track {
        background: linear-gradient(90deg,
            rgba(241, 225, 161, 0.3) 0%,
            rgba(241, 225, 161, 0.5) 50%,
            rgba(241, 225, 161, 0.3) 100%);
        background-image:
            radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
            radial-gradient(circle at 75% 75%, rgba(0, 0, 0, 0.1) 1px, transparent 1px);
        background-size: 20px 20px, 15px 15px;
        height: 8px;
        border-radius: 4px;
        border: 1px solid rgba(161, 131, 75, 0.3);
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* íƒ€ì„ìŠ¬ë¼ì´ë” ëˆˆê¸ˆ ë°” */
    #slider-ticks-bar {
        overflow: visible;
    }
    .slider-tick {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        transform: translateX(-50%);
        pointer-events: none;
    }
    .slider-tick-line {
        width: 1px;
        background: rgba(255, 255, 255, 0.35);
        margin-top: 2px;
    }
    .slider-tick-line.major {
        background: rgba(255, 255, 255, 0.7);
        width: 1.5px;
    }
    .slider-tick-label {
        font-size: 9px;
        color: rgba(255, 255, 255, 0.55);
        white-space: nowrap;
        font-family: 'Inter', -apple-system, sans-serif;
        letter-spacing: 0;
        line-height: 1;
    }
    .slider-tick-label.major {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.85);
        font-weight: 500;
    }

    /* ğŸš© [ì¶”ê°€] ì‹œëŒ€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .era-marker {
        position: absolute;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        pointer-events: auto;
        cursor: pointer;
        z-index: 10;
        height: 50%;       /* ì „ì²´ ë†’ì´ì˜ ì ˆë°˜ì”© ì ìœ  */
    }
    .era-marker-label {
        font-size: 9.5px;
        font-family: 'Noto Serif KR', 'Nanum Myeongjo', serif;
        font-weight: 700;
        white-space: nowrap;
        padding: 1px 4px;
        border-radius: 3px;
        letter-spacing: -0.2px;
        line-height: 1.4;
        margin-bottom: 2px;
        transition: transform 0.15s ease, opacity 0.15s ease;
        text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }
    /* í•œêµ­ì‚¬: í™©ê¸ˆìƒ‰ ê³„ì—´ â€” ìŠ¬ë¼ì´ë” ìœ„ ì „ìš© ë°”ì— ë°°ì¹˜ */
    .era-marker.korea {
        flex-direction: column-reverse; /* ì„ (ìœ„) â†’ ë¼ë²¨(ì•„ë˜) ìˆœì„œ â€” ìŠ¬ë¼ì´ë”ì— ì„ ì´ ë‹¿ë„ë¡ */
        bottom: 0;
        top: auto;
    }
    .era-marker.korea .era-marker-label {
        color: #FFD700;
        border-top: 1.5px solid rgba(255, 215, 0, 0.7);
        border-bottom: none;
        margin-bottom: 0;
        margin-top: 2px;
    }
    .era-marker.korea .era-marker-line {
        width: 1.5px;
        background: linear-gradient(to top, rgba(255, 215, 0, 0.9), rgba(255, 215, 0, 0.15));
        height: 8px;
    }
    /* ì¤‘êµ­ì‚¬: ë¶‰ì€ìƒ‰ ê³„ì—´ â€” ëˆˆê¸ˆë°” ì•„ë˜ìª½ì— ë°°ì¹˜ */
    .era-marker.china {
        flex-direction: column-reverse; /* ì„  â†’ ë¼ë²¨ ìˆœì„œ */
        bottom: 0;
        top: auto;
    }
    .era-marker.china .era-marker-label {
        color: #FF7F7F;
        border-top: 1.5px solid rgba(255, 100, 100, 0.7);
        border-bottom: none;
        margin-bottom: 0;
        margin-top: 2px;
    }
    .era-marker.china .era-marker-line {
        width: 1.5px;
        background: linear-gradient(to top, rgba(255, 100, 100, 0.8), rgba(255, 100, 100, 0.1));
        height: 8px;
    }
    .era-marker:hover .era-marker-label {
        transform: scale(1.15);
        opacity: 1 !important;
    }

    /* ğŸš© [ìˆ˜ì •] í†µí•© íƒ€ì„ë¼ì¸ ì»¨í…Œì´ë„ˆ */
    #timeline-container {
        position: relative;
        height: 20px;
        overflow: hidden;
        pointer-events: auto;
        display: block;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        margin-top: 5px;
        z-index: 5; /* ìŠ¬ë¼ì´ë”ë³´ë‹¤ ì•„ë˜ */
    }
    .leaflet-control-zoom {
        margin: 0 !important;
    }

    /* ------------------- 2. ë§ˆì»¤ ë””ìì¸ CSS ------------------- */
    
    /* ì „ì¥ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .battle-marker {
        font-size: 36px; /* ì „ì¥ ì•„ì´ì½˜ í¬ê¸° í‚¤ì›€ */
        color: #ffffff; /* ë¶‰ì€ìƒ‰ */ /* ì „ì¥ ë§ˆì»¤ ìƒ‰ìƒ */
        font-weight: bold;
        background-color: transparent; /* ë°°ê²½ íˆ¬ëª…í•˜ê²Œ ë³€ê²½ */
        padding: 2px 5px; /* íŒ¨ë”© ì¶”ê°€ */
        text-shadow: 1px 1px 2px #000;
        text-align: center;
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));
    }
    
    /* ì „ì¥ ë§ˆì»¤ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .battle-marker-text {
        font-size: 12px;
        color: white;
        white-space: nowrap;
        margin-top: -5px;
    }
    
    /* ì§€ì—­ëª… ë¼ë²¨ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .label-text-marker {
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));
    }
    
    /* ì¼ë°˜ ì„±/ë„ì‹œ ë§ˆì»¤ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    /* ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆì§€ë§Œ, í•„ìš”ì‹œ ì—¬ê¸°ì„œ ì¶”ê°€ ì¡°ì • ê°€ëŠ¥ */
    
/* ------------------- ì™•ì„± ë§ˆì»¤ CSS ì¶”ê°€ ------------------- */
    .capital-marker {
        display: flex;
        flex-direction: row;
        align-items: center;
        line-height: 1;
        transform: scale(var(--marker-scale, 1));
        padding: 3px 8px 3px 3px;
    }
    /* ë‚™ê´€(ë„ì¥) ìŠ¤íƒ€ì¼ */
    .capital-marker .capital-seal {
        width: 16px;
        height: 16px;
        background-color: #c0392b;
        border: 1.5px solid #922b21;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 900;
        margin-right: 6px;
        border-radius: 2px;
        transform: rotate(-3deg);
        flex-shrink: 0;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        box-shadow: 0 0 4px rgba(192,57,43,0.7), 0 3px 6px rgba(0,0,0,0.85);
    }
    /* ì™•ì„± ì´ë¦„ í…ìŠ¤íŠ¸ */
    .capital-marker .city-name {
        font-family: 'Nanum Myeongjo', serif;
        font-size: 13px;
        font-weight: 900;
        color: #fff;
        letter-spacing: 1px;
        white-space: nowrap;
        text-align: left;
        text-shadow: -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000, 0px 0px 3px #000;
        background: none;
        padding: 0;
        margin: 0;
        display: inline;
    }

    /* ğŸš© [ì¶”ê°€] êµ­ê¸° ì´ë¯¸ì§€ í†¤ ë‹¤ìš´ */
    .country-flag-img {
        filter: saturate(60%) brightness(90%) drop-shadow(2px 2px 3px rgba(0,0,0,0.7));
    }

    /* ì¥ìˆ˜/ë³‘ë ¥ ì •ë³´: ë°°ê²½ìƒ‰ ìœ ì§€ */
    .military-flag-details {
        background-color: transparent;
        padding: 1px 3px;
        border-radius: 3px;
        display: inline-block;
        white-space: nowrap; 
        text-align: center; 
        color: white;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
    }
        .flag-icon-container {
        /* ì‚¬ìš©ì ì§€ì • ê³ ì • í¬ê¸° ìœ ì§€ */
        display: flex; /* Flexbox í™œì„±í™” */
        flex-direction: column; /* ìˆ˜ì§ ì •ë ¬ (ê¹ƒë°œ ìœ„, í…ìŠ¤íŠ¸ ì•„ë˜) */
        align-items: center; /* ë‚´ë¶€ ì•„ì´í…œ ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
        text-align: center;
        /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
        transform: scale(var(--marker-scale, 1));

        /* ì „ì²´ ë§ˆì»¤ í¬ê¸° ë° ìœ„ì¹˜ ì¡°ì • (êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤) */
        width: 30px; 
        height: 30px; /* í¬ê¸° ì¡°ì • */
        
        line-height: 1; 
        font-weight: bold;
        color: #ecf0f1; 
        text-shadow: 1px 1px 1px #000; /* í…ìŠ¤íŠ¸ ê·¸ë¦¼ì ì¶”ê°€ */
        font-size: 15px; /* ê¹ƒë°œ ê¸°í˜¸ í¬ê¸° */
    }
    /* ê¹ƒë°œ ê¸°í˜¸ (âš‘) ìŠ¤íƒ€ì¼ */
    .flag-icon-symbol {
        font-size: 20px; /* ê¹ƒë°œ ê¸°í˜¸ í¬ê¸°ë¥¼ ì¢€ ë” í‚¤ì›ë‹ˆë‹¤. */
        line-height: 1;
        height: 30px; /* í…ìŠ¤íŠ¸ì™€ì˜ ë¶„ë¦¬ë¥¼ ìœ„í•´ ë†’ì´ ê³ ì • */
        margin-bottom: 2px;
    }

    /* ------------------- ì§€ì—­ëª… í…ìŠ¤íŠ¸ ë§ˆì»¤ CSS ì¶”ê°€ ------------------- */
        .location-label-marker {
    font-size: var(--label-font-size, 15px);
    font-weight: bold;
    color: #ffffff;
    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
    background-color: rgba(44, 62, 80, 0);
    border-radius: 5px;
    padding: 5px 10px;
    font-family: 'East Sea Dokdo', 'Nanum Myeongjo', serif !important;
    white-space: nowrap;
    line-height: 1.2;
    text-align: center;
    z-index: 600;
    pointer-events: none;
    transform: scale(var(--marker-scale, 1));
        }

        /* ëª¨ë°”ì¼ì—ì„œ ì§€ë„ ë§ˆì»¤/ì§€ëª…/ì•„ì´ì½˜ë§Œ í¬ê²Œ */
        @media (max-width: 900px) {
            .location-label-marker { font-size: 16px !important; }
            .capital-marker { font-size: 22px !important; }
            .capital-marker .city-name { font-size: 12px !important; }
            .battle-marker { font-size: 36px !important; }
            .flag-icon-container { font-size: 16px !important; }
            .flag-icon-symbol { font-size: 20px !important; }
            .natural-feature-marker { font-size: 20px !important; }
            .natural-feature-marker .feature-name { font-size: 12px !important; }
        }
        @media (max-width: 600px) {
            .location-label-marker { font-size: 18px !important; }
            .capital-marker { font-size: 24px !important; }
            .capital-marker .city-name { font-size: 13px !important; }
            .battle-marker { font-size: 42px !important; }
            .flag-icon-container { font-size: 18px !important; }
            .flag-icon-symbol { font-size: 22px !important; }
            .natural-feature-marker { font-size: 22px !important; }
            .natural-feature-marker .feature-name { font-size: 13px !important; }
        }
        @media (max-width: 400px) {
            .location-label-marker { font-size: 20px !important; }
            .capital-marker { font-size: 26px !important; }
            .capital-marker .city-name { font-size: 14px !important; }
            .battle-marker { font-size: 48px !important; }
            .flag-icon-container { font-size: 20px !important; }
            .flag-icon-symbol { font-size: 24px !important; }
            .natural-feature-marker { font-size: 24px !important; }
            .natural-feature-marker .feature-name { font-size: 14px !important; }
        }

    /* ------------------- 3. í¼ ë° íŒ¨ë„ ë””ìì¸ CSS ------------------- */
    /* ğŸš© [ìˆ˜ì •] í¼ íŒ¨ë„ ìŠ¤íƒ€ì¼ ê°œì„  */
    /* ğŸš© [ìˆ˜ì •] í¼ ì´ë™ì„ ìœ„í•´ left, transform ì†ì„± ì œê±° */
        #castleForm, #historyForm, #countryForm, #kingForm, #eventForm {
            /* ğŸš© [ìˆ˜ì •] ì¢Œì¸¡ ìƒë‹¨ì— ê³ ì • ìœ„ì¹˜ */
            position: absolute; 
            top: 10px;
            left: 10px;
            background: #2c3e50; color: #ecf0f1; border: 1px solid #5d7185;
            padding: 20px; 
            z-index: 1000; 
            border-radius: 8px;
            width: 600px;
            /* ğŸš© [ì¶”ê°€] í¼ì´ ë„ˆë¬´ ê¸¸ì–´ì§ˆ ê²½ìš° ìŠ¤í¬ë¡¤ì´ ìƒê¸°ë„ë¡ max-height ì„¤ì • */
            max-height: 90vh;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); max-width: 90%; min-width: 350px;
            overflow: auto; /* ğŸš© [ìˆ˜ì •] í¼ í¬ê¸°ë¥¼ ì¤„ì´ë©´ ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ìƒê¸°ë„ë¡ */
            resize: both;
            min-width: 250px;
            min-height: 200px;
            max-width: 98vw;
            max-height: 95vh;
        }
        
        /* ğŸš© [ì¶”ê°€] ëª¨ë“  í¼ í—¤ë”ë¥¼ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ í‘œì‹œ */
        #castleForm h3, #historyForm h3, #countryForm h3, #kingForm h3, #eventForm h3, 
        #drawingForm h3, #editCitySelectionForm h3 {
            cursor: move;
            user-select: none;
        }
        
        /* drawingForm ìŠ¤íƒ€ì¼ì€ íŒŒì¼ ìƒë‹¨ì— í†µí•©ë¨ */
        
        #drawingForm .form-row {
            display: contents !important;
        }
        
        #drawingForm label {
            font-size: 12px;
            margin: 0;
            white-space: nowrap;
        }
        
        #drawingForm input[type="text"] {
            width: 100px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        #drawingForm input[type="number"] {
            width: 70px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        #drawingForm select {
            width: 80px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        #drawingForm button {
            padding: 4px 12px;
            font-size: 12px;
        }

        /* ------------------- ëª¨ë°”ì¼ í¼ ë°˜ì‘í˜• ------------------- */
                @media (max-width: 967px) {
                    #castleForm, #historyForm, #countryForm, #kingForm, #eventForm {
                        width: 90vw !important;
                        left: 5vw !important;
                        min-width: unset !important;
                        max-width: 95vw !important;
                        max-height: 90vh !important;
                        overflow-y: auto !important;
                        padding-bottom: 80px !important; /* ë²„íŠ¼ ê³µê°„ í™•ë³´ */
                    }
                    #castleForm .form-actions,
                    #historyForm .form-actions,
                    #countryForm .form-actions,
                    #kingForm .form-actions,
                    #eventForm .form-actions,
                    #drawingForm .form-actions {
                        position: sticky;
                        bottom: 0;
                        background: #2c3e50;
                        z-index: 10;
                        padding: 10px 0 0 0;
                        margin-bottom: 0;
                        width: 100%;
                        justify-content: flex-end;
                        display: flex;
                    }
                    /* í¼ì€ JSë¡œ ì—´ë¦´ ë•Œë§Œ display:block/flexê°€ ë¨. ê°•ì œ display: flex !important ì œê±° */
                    #castleForm,
                    #historyForm,
                    #countryForm,
                    #kingForm,
                    #eventForm {
                        flex-direction: column !important;
                    }
                    #castleForm form,
                    #historyForm form,
                    #countryForm form,
                    #kingForm form,
                    #eventForm form {
                        display: flex;
                        flex-direction: column;
                        flex: 1 1 auto;
                        min-height: 0;
                    }
                    /* drawingForm ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ì€ íŒŒì¼ ìƒë‹¨ì— í†µí•©ë¨ */
                    #drawingForm input,
                    #drawingForm select {
                        font-size: 11px !important;
                        padding: 3px 6px !important;
                    }
                    #drawingForm button {
                        font-size: 11px !important;
                        padding: 3px 10px !important;
                    }
                }
            </style>
</body>
<style>    
    /* ì‚¬ì„œ ê¸°ë¡ ì¹¼ëŸ¼ ìŠ¤íƒ€ì¼ */
    .record-column { 
        border: 1px solid #ffffff00; border-radius: 4px; background: #3e526800; 
        font-size: 12px; /* ğŸš© [ì¶”ê°€] 'ê¸°ë¡ ì—†ìŒ' í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
        padding: 1px; /* ğŸš© [ì¶”ê°€] ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
    }
    .record-column h2 { border-bottom: 1px solid #000000; }
    .record-item {
        /* ğŸš© [ìˆ˜ì •] ë°°ê²½ ì´ë¯¸ì§€ ë° ê´€ë ¨ ìŠ¤íƒ€ì¼ ì ìš© */
        background-image: url('https://img.freepik.com/free-photo/vintage-grungy-textured-paper-background_53876-103932.jpg?semt=ais_hybrid&w=740&q=80');
        background-size: cover;
        color: #000000; /* ì–´ë‘ìš´ ê¸€ììƒ‰ */
        border: 1px solid #7c481c; /* í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½ */
        border-radius: 4px;
        padding: 10px; /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
        margin-bottom: 5px; /* ğŸš© [ìˆ˜ì •] ì•„ì´í…œ ê°„ ê°„ê²© ì¡°ì • */
        font-size: 12px; /* ğŸš© [ìˆ˜ì •] ê¸€ì”¨ í¬ê¸° 10pxë¡œ ì¡°ì • */
        white-space: pre-wrap;
        line-height: 1.5; /* ğŸš© [ì¶”ê°€] ì „ì²´ì ì¸ ì¤„ ê°„ê²© ì„¤ì • */
        font-family: 'Noto Serif KR', serif; /* íŒì—…ê³¼ ë™ì¼í•œ í°íŠ¸ ì ìš© */
    }
    .record-item.foreign { 
        /* ğŸš© [ìˆ˜ì •] foreign ê¸°ë¡ë„ ë™ì¼í•œ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ë„ë¡ ë°°ê²½ìƒ‰ ì œê±° */
        border: 1px solid #8c7b6c; border-radius: 4px; 
        font-size: 12px; /* ğŸš© [ì¶”ê°€] 'ê¸°ë¡ ì—†ìŒ' í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
    } 
    .record-item.true_history { border-left: 3px solid #2ecc71; } 
    


    /* ğŸš© [ìˆ˜ì •] í¼ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ê°œì„  (ë‹¤í¬ í…Œë§ˆ ì ìš©) */
    #castleForm input, #historyForm input, #countryForm input, #kingForm input, #eventForm input, #drawingForm input,
    #castleForm select, #historyForm select, #countryForm select, #kingForm select, #eventForm select, #drawingForm select, #castleForm textarea,
    #historyForm textarea {
        margin: 4px 0; 
        padding: 8px; 
        width: 100%; 
        box-sizing: border-box; 
        background-color: #1c2833;
        color: #ecf0f1;
        border: 1px solid #5d7185;
        border-radius: 4px;
    }
    #castleForm input:focus, #historyForm input:focus, #countryForm input:focus, #kingForm input:focus, #eventForm input:focus, #drawingForm input:focus,
    #castleForm select:focus, #historyForm select:focus, #countryForm select:focus, #kingForm select:focus, #eventForm select:focus, #drawingForm select:focus, #castleForm textarea:focus,
    #historyForm textarea:focus {
        outline: none;
        border-color: #00aaff;
        box-shadow: 0 0 5px rgba(0, 170, 255, 0.5);
    }
    .record-item button {
        float: right; margin-left: 10px; background-color: #be0000; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer;
    }

    /* ê²½ë¡œ ë°ì´í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .path-point-row {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
      align-items: center;
      padding: 5px;
      border: 1px solid #5d7185;
      border-radius: 3px;
    }
    .path-point-row input {
      flex-grow: 1;
      width: auto; /* flex-grow ë•Œë¬¸ì— width: 100% ë¬´ì‹œ */
      min-width: 0;
    }
    .path-point-row .path-time-input {
      width: 50px;
    }
    .path-point-row button {
      width: 30px;
      padding: 5px;
      margin: 0;
      background-color: #e74c3c;
    }
    #pathDataSection h4 {
      white-space: nowrap; /* ì œëª© ì¤„ë°”ê¿ˆ ë°©ì§€ */
    }

    /* ğŸš© [ì¶”ê°€] í¼ ë ˆì´ì•„ì›ƒ ê°œì„  */
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 10px;
    }
    .form-row label {
      width: 100px; /* ë ˆì´ë¸” ë„ˆë¹„ ê³ ì • */
      flex-shrink: 0; /* ë ˆì´ë¸” ë„ˆë¹„ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
      text-align: right;
      padding-right: 5px;
    }
    .form-row input, .form-row select, .form-row textarea, .form-row .input-group {
      flex-grow: 1; /* ì…ë ¥ í•„ë“œê°€ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
    }
    .input-group {
      display: flex;
      gap: 5px;
    }
    /* ì¬ìƒ/ì •ì§€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
    .playback-button-container {
        position: relative;
        width: auto; /* ğŸš© [ìˆ˜ì •] ë„ˆë¹„ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ë„ë¡ ë³€ê²½ */
        height: auto; /* ğŸš© [ìˆ˜ì •] ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ë„ë¡ ë³€ê²½ */
        align-self: center; /* flex ì•„ì´í…œ ìŠ¤ìŠ¤ë¡œ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
    }

    /* ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒ ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
    .marker-type-selector {
      display: flex;
      border: 1px solid #5d7185;
      border-radius: 5px;
      overflow: hidden;
    }
    /* ğŸš© [í•µì‹¬ ìˆ˜ì •] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ì´ ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ë„ë¡ ìˆ˜ì • */
    .marker-type-selector button {
      flex-grow: 1;
      /* ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ìƒì†ë°›ìœ¼ë¯€ë¡œ ì•„ë˜ ì†ì„±ë“¤ì€ ì œê±° ë˜ëŠ” ìˆ˜ì •ë©ë‹ˆë‹¤. */
      /* all: unset; */
      /* text-align: center; */
      /* padding: 6px 5px; */
      /* cursor: pointer; */
      transition: all 0.2s ease; /* ğŸš© [ìˆ˜ì •] ê¸°ë³¸ ë²„íŠ¼ê³¼ ë™ì¼í•œ ì „í™˜ íš¨ê³¼ ì ìš© */
      opacity: 0.5; /* ë¹„í™œì„± ìƒíƒœì¼ ë•Œ ë°˜íˆ¬ëª… ì²˜ë¦¬ */
      border-radius: 0; /* ğŸš© [ì¶”ê°€] ë²„íŠ¼ ê·¸ë£¹ì˜ ì¤‘ê°„ ë²„íŠ¼ë“¤ì€ ê°ì§„ ëª¨ì„œë¦¬ë¡œ */
      border-right: none; /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ ì œê±°í•˜ì—¬ ë²„íŠ¼ë“¤ì´ ë¶™ì–´ë³´ì´ê²Œ í•¨ */
    }
    .marker-type-selector button.active {
      background-color: #008cff; /* ğŸš© [ìˆ˜ì •] í™œì„± ìƒ‰ìƒì„ ë‹¤ë¥¸ ë²„íŠ¼ê³¼ í†µì¼ */
      opacity: 1; /* í™œì„± ìƒíƒœì¼ ë•Œ ì™„ì „ ë¶ˆíˆ¬ëª… */
      font-weight: bold;
    }
    .marker-type-selector button:hover:not(.active) {
      background-color: #36434f; /* ğŸš© [ìˆ˜ì •] í˜¸ë²„ ìƒ‰ìƒì„ ë‹¤ë¥¸ ë²„íŠ¼ê³¼ í†µì¼ */
      opacity: 0.8; /* ğŸš© [ì¶”ê°€] ë¹„í™œì„± ë²„íŠ¼ í˜¸ë²„ ì‹œ ì•½ê°„ ë” ì§„í•˜ê²Œ */
    }

    /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µí•© ë° ì—­í• ë³„ í´ë˜ìŠ¤ ì •ì˜ */
    button, .button-style, input[type="button"], input[type="submit"] {
        all: unset; /* ëª¨ë“  ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        display: inline-block;
        box-sizing: border-box;
        background-color: #3e4a56; /* ë” ì–´ë‘ìš´ ê¸°ë³¸ ë°°ê²½ìƒ‰ */
        color: #f0f0f0; /* ğŸš© [ìˆ˜ì •] ë” ë°ì€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        border: 1px solid #5d7185; /* ğŸš© [ìˆ˜ì •] í…Œë‘ë¦¬ ìƒ‰ìƒ ë°ê²Œ ì¡°ì • */
        padding: 5px 5px; /* ğŸš© [ìˆ˜ì •] íŒ¨ë”© ì¡°ì • */
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease; /* ğŸš© [ìˆ˜ì •] ëª¨ë“  ì†ì„±ì— ì „í™˜ íš¨ê³¼ ì ìš© */
        font-size: 12px; /* ğŸš© [ìˆ˜ì •] í°íŠ¸ í¬ê¸° ì¡°ì • */
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* ğŸš© [ì¶”ê°€] í…ìŠ¤íŠ¸ ê·¸ë¦¼ìë¡œ ê°€ë…ì„± í–¥ìƒ */
    }
    
    /* ğŸš© [ì¶”ê°€] PC ë²„ì „ ì‹œê°„ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
    #time-controls-map {
        flex-wrap: wrap;
        max-width: calc(100% - 180px);
    }
    
    #time-controls-map #timeLabelDisplay {
        min-width: 180px;
    }
    
    #time-controls-map #timeLabelDisplay #yearLabel {
        min-width: 65px;
    }
    
    #time-controls-map #timeLabelDisplay #monthLabel {
        min-width: 20px;
    }
    
    #time-controls-map #timeLabelDisplay #ganjiLabel {
        min-width: 40px;
    }

    /* Compact style used while user is dragging the timeline slider */
    #time-controls-map #timeLabelDisplay.compact,
    #timeLabelDisplay-pc.compact,
    #current-year-display.compact {
        font-size: 11px !important;
        padding: 2px 6px !important;
        height: 22px !important;
        line-height: 16px !important;
        transition: font-size 0.12s ease, padding 0.12s ease;
        opacity: 0.95;
    }

    button:hover, .button-style:hover, input[type="button"]:hover, input[type="submit"]:hover {
        background-color: #36434f; /* ì–´ë‘ìš´ í˜¸ë²„ ìƒ‰ìƒ */
        border-color: #5d7185;
    }

    button.primary, button.active, .button-style.active, button:active, input[type="submit"] {
        background-color: #008cff; /* ğŸš© [ìˆ˜ì •] í™œì„±/ì£¼ìš” ìƒ‰ìƒì„ ë” ë°ì€ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        border-color: #008cff;
    }

    button.primary:hover, input[type="submit"]:hover {
        background-color: #006bb3; /* ğŸš© [ìˆ˜ì •] primary ë²„íŠ¼ í˜¸ë²„ ì‹œ ë” ì–´ë‘ìš´ íŒŒë€ìƒ‰ */
        border-color: #006bb3;
    }

    button.danger {
        background-color: #c0392b; /* í†¤ ë‹¤ìš´ëœ ìœ„í—˜ ìƒ‰ìƒ */
        border-color: #c0392b;
    }
    button.danger:hover {
        background-color: #e74c3c;
    }

        /* ìì—° ì§€ë¬¼ ë§ˆì»¤ ìŠ¤íƒ€ì¼ (NEW) */
    .natural-feature-marker {
        font-size: 20px; /* ì•„ì´ì½˜ í¬ê¸° */
        font-weight: bold;
        text-shadow: 1px 1px 2px #000;
        text-align: center;
        line-height: 1.2;
        padding: 5px;
        border-radius: 50%;
    }
    /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì ˆ */
    .natural-feature-marker { transform: scale(var(--marker-scale, 1)); }
    .natural-feature-marker .feature-name {
        font-size: 11px;
        font-weight: bold;
        color: #ffffff; /* í°ìƒ‰ ê¸€ì”¨ë¡œ ë³€ê²½ */
        background: none; /* ë°°ê²½ìƒ‰ ì œê±° */
        padding: 1px 3px; /* íŒ¨ë”© ì¶•ì†Œ */
        border-radius: 2px;
        display: inline-block;
        white-space: nowrap;
        margin-top: 2px;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; /* ê²€ì€ìƒ‰ í…Œë‘ë¦¬ íš¨ê³¼ (ë¸”ëŸ¬ ì—†ìŒ) */
        border: none; /* í…Œë‘ë¦¬ ì œê±° */
    }
    /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ìì—°ì§€ë¬¼ ë¼ë²¨ í¬ê¸° ì¡°ì ˆ */
    @media (min-width: 901px) {
        /* ì¤Œ ë ˆë²¨ 6-7: í° í°íŠ¸ */
        .zoom-level-6 .natural-feature-marker .feature-name,
        .zoom-level-7 .natural-feature-marker .feature-name {
            font-size: 13px !important;
        }
        /* ì¤Œ ë ˆë²¨ 8: ê¸°ë³¸ í°íŠ¸ */
        .zoom-level-8 .natural-feature-marker .feature-name {
            font-size: 11px !important;
        }
        /* ì¤Œ ë ˆë²¨ 9+: í° í°íŠ¸ */
        .zoom-level-9 .natural-feature-marker .feature-name,
        .zoom-level-10 .natural-feature-marker .feature-name,
        .zoom-level-11 .natural-feature-marker .feature-name,
        .zoom-level-12 .natural-feature-marker .feature-name,
        .zoom-level-13 .natural-feature-marker .feature-name,
        .zoom-level-14 .natural-feature-marker .feature-name,
        .zoom-level-15 .natural-feature-marker .feature-name {
            font-size: 13px !important;
        }
    }
    /* íŠ¹ì • íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ */
    .feature-mountain { color: #2ecc71; background-color: transparent; } /* ì‚°/ìˆ² */
    .feature-sea { color: #3498db; background-color: transparent; } /* ë°”ë‹¤/í˜¸ìˆ˜ */
    .feature-river { color: #1abc9c; background-color: transparent; } /* ê°•/ë‚´ë¥™ */
    .feature-mudflat { color: #f1c40f; background-color: transparent; } /* ë»˜/ëŠª */
    .feature-hunting { color: #e67e22; background-color: transparent; } /* ì‚¬ëƒ¥í„° */
    .feature-construction { color: #95a5a6; background-color: transparent; } /* ê±´ì„¤ */
    .feature-other { color: #ecf0f1; background-color: transparent; } /* ê¸°íƒ€ */

    /* ğŸš© [ì¶”ê°€] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #layer-toggles .layer-toggle-btn {
        padding: 6px 8px; /* ğŸš© [ìˆ˜ì •] ë‹¤ë¥¸ ë²„íŠ¼ê³¼ ë†’ì´ ë§ì¶¤ (ì¶•ì†Œ) */
        font-size: 11px;
    }

    /* ğŸš© [ì‹ ê·œ] í¸ì§‘ ì»¨íŠ¸ë¡¤ PC ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    #edit-controls {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
        height: 26px;
    }
    #edit-controls #mainEditBtn {
        height: 100%;
        padding: 4px 10px;
        font-size: 13px;
        line-height: 1.2;
        box-sizing: border-box;
    }
    #edit-dropdown-container {
        position: relative;
        display: none;
        height: 100%;
    }
    #edit-dropdown-container #mainEditBtn {
        white-space: nowrap;
    }

    /* í¼ ë‚´ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #castleForm .form-actions button, #historyForm .form-actions button, 
    #countryForm .form-actions button, #kingForm .form-actions button,
    #eventForm .form-actions button, #drawingForm .form-actions button {
        width: 80px;
    }

    /* ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ìŠ¤íƒ€ì¼: ì„±ê³½ ë°°ê²½/ì „ê²½ ìŠ¤íƒ€ì¼ */
    .wall-background, .wall-foreground {
        /* í´ë¦­ ì´ë²¤íŠ¸ê°€ ì „ê²½ ë ˆì´ì–´ì—ë§Œ ë°œìƒí•˜ë„ë¡ ì„¤ì • */
        pointer-events: none;
    }
    .wall-foreground { pointer-events: auto; }

    /* ì™• ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .king-item {
        font-size: 12px; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
        line-height: 1.5;
        margin-bottom: 4px;
    }

    /* ğŸš© [ì¶”ê°€] ê²€ìƒ‰ì°½ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #searchInput {
        display: flex;
        align-items: center;
        all: unset;
        box-sizing: border-box;
        padding: 6px 10px; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ê³¼ ë†’ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ íŒ¨ë”© ì¡°ì • */
        border: 1px solid #4e5d6c;
        border-radius: 4px 0 0 4px; /* ì™¼ìª½ë§Œ ë‘¥ê¸€ê²Œ */
        background-color: #f0f0f0;
        color: black;
        font-size: 12px;
        line-height: 1.2;
        width: 180px; /* ğŸš© [ìˆ˜ì •] ê²€ìƒ‰ì°½ ë„ˆë¹„ í™•ëŒ€ */
    }

    /* ------------------- 4. ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ CSS (NEW) ------------------- */
    /* í™”ë©´ ë„ˆë¹„ê°€ 1200px ì´í•˜ì¼ ë•Œ ì ìš© */
    @media (max-width: 1200px) {
        #top-controls-container {
            flex-direction: column; /* ìˆ˜ì§ìœ¼ë¡œ ìŒ“ê¸° */
            align-items: flex-start; /* ì™¼ìª½ ì •ë ¬ */
            gap: 15px;
        }
        .time-controls, .right-controls {
            width: 100%; /* ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
            flex-wrap: wrap; /* ë‚´ë¶€ ìš”ì†Œë“¤ì´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ì–´ê°€ë„ë¡ ì„¤ì • */
            justify-content: flex-start; /* ì™¼ìª½ë¶€í„° ì •ë ¬ */
            gap: 10px; /* ìš”ì†Œ ê°„ ê°„ê²© ì¶”ê°€ */
        }
        .right-controls {
            justify-content: flex-start; /* ì˜¤ë¥¸ìª½ ì»¨íŠ¸ë¡¤ë„ ì™¼ìª½ë¶€í„° ì •ë ¬ */
        }
    }
    /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë‹«ê¸° ë²„íŠ¼ */
    #closeControlsBtn {
        display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 1003;
        /* ğŸš© [ìˆ˜ì •] ë°°ê²½ê³¼ í…Œë‘ë¦¬ ì œê±° */
        background: none;
        border: none;
        /* ğŸš© [ìˆ˜ì •] í¬ê¸°ì™€ ìƒ‰ìƒ ì¡°ì • */
        font-size: 22px;
        color: #dbdbdb;
    }

    /* ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ì— ë”°ë¼ í¬ê¸°ê°€ ì¡°ì ˆë  ë§ˆì»¤ë“¤ì˜ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .custom-city-marker, .custom-flag-name-marker, .custom-capital-flag-marker, .battle-marker {
        transform: scale(var(--marker-scale, 1.0));
    }

    /* ğŸš© [ì‚­ì œë¨] ê³ ëŒ€ ì§€ë„ ë³´ê¸° ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ (íƒ‘ë°”ë¡œ ì´ë™ë¨) */
    /* #ancient-map-button-container {
        display: none; 
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: auto;
        padding: 12px;
        justify-content: center;
        align-items: stretch;
        background: rgba(30, 42, 56, 0.85);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    } */

    /* ë“œë¡­ë‹¤ìš´ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ */
    .dropdown-arrow {
        display: inline-block;
        margin-left: 5px;
        transition: transform 0.3s ease;
        font-size: 10px;
    }
    /* ğŸš© [ì¶”ê°€] ì„±ê³½ ê·¸ë¦¼ì íš¨ê³¼ë¥¼ ìœ„í•œ SVG í•„í„° */
    .svg-shadow-filter {
        -webkit-filter: drop-shadow( 0px 0px 1.5px rgba(0,0,0,1));
        filter: drop-shadow( 0px 0px 1.5px rgba(0,0,0,1));
        /* ì°¸ê³ : ì¼ë¶€ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•´ -webkit- ì ‘ë‘ì‚¬ í¬í•¨ */
    }

    /* ------------------- 5. ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¬ë¼ì´ë“œ íŒ¨ë„ (NEW) ------------------- */
    @media (max-width: 967px) { /* ğŸš© [ìˆ˜ì •] ê°•ì œ ëª¨ë°”ì¼ ë·° í´ë˜ìŠ¤ ì œê±° */
        /* ê¸°ë³¸ì ìœ¼ë¡œ body ìŠ¤í¬ë¡¤ì„ ë§‰ìŠµë‹ˆë‹¤. */
        html, body {
            /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ê¸°ë³¸ ê¸€ì”¨ í¬ê¸° í‚¤ì›Œì„œ ê°€ë…ì„± í–¥ìƒ */
            font-size: 15px;
            overflow: hidden;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆë¥¼ í™”ë©´ ì „ì²´ë¡œ í™•ì¥í•©ë‹ˆë‹¤. */
        #mainContainer {
            flex-direction: column !important; /* ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ˜ì§ìœ¼ë¡œ ìŒ“ìŠµë‹ˆë‹¤. */
            height: 100%;
            padding: 0;
        }

        /* ì§€ë„ê°€ í•­ìƒ ì „ì²´ í™”ë©´ì„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. */
        #leftColumn {
            flex-basis: 100% !important;
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ë§Œ í™”ë©´ ë°–ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤. */
        #rightPanel {
            position: fixed !important;
            z-index: 1002; /* í¼ë³´ë‹¤ ìœ„ì—, ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ë³´ë‹¤ ìœ„ì— */
            background-color: #1e2a38e0; /* ë°˜íˆ¬ëª… ë°°ê²½ */
            display: block !important;
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* ìƒë‹¨ ë©”ë‰´ëŠ” í•­ìƒ ë³´ì´ê³  ì´ë™í•˜ì§€ ì•ŠìŒ */
        #controls-wrapper {
            position: static !important;
            top: auto !important;
            left: auto !important;
            width: 100% !important;
            transform: none !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            border-bottom: 2px solid #00aaff;
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ ì´ˆê¸° ìœ„ì¹˜ (í™”ë©´ ì˜¤ë¥¸ìª½) */
        #rightPanel {
            /* ğŸš© [ìˆ˜ì •] íŒ¨ë„ì´ ì˜¤ë¥¸ìª½ì—ì„œ ë‚˜ì˜¤ë„ë¡ ë³µì› */
            top: 0;
            right: 0;
            width: 85%; /* í™”ë©´ì˜ 85% ë„ˆë¹„ */
            max-width: 400px;
            height: 100%;
            transform: translateX(100%);
            border-left: 2px solid #00aaff;
            border-top: none; /* ìƒë‹¨ í…Œë‘ë¦¬ ì œê±° */
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ì€ í† ê¸€ë¨ */
        #rightPanel.visible {
            transform: translateX(0);
        }

        /* ê°€ë¡œ/ì„¸ë¡œ ë¦¬ì‚¬ì´ì €ëŠ” ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¹ë‹ˆë‹¤. */
        #resizer, #vertical-resizer {
            display: none;
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
        #rightPanelToggleBtn {
            /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ í•˜ë‹¨ìœ¼ë¡œ ì´ë™ */
            top: auto;
            bottom: 15px;
            left: auto; /* ì˜¤ë¥¸ìª½ ì •ë ¬ì„ ìœ„í•´ leftëŠ” autoë¡œ ë‘¡ë‹ˆë‹¤. */
            right: 15px;
            z-index: 1003; /* ğŸš© [ì¶”ê°€] íŒ¨ë„(z-index: 1002)ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
            /* ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ìš© ë””ìì¸ ë³€ê²½ */
            writing-mode: horizontal-tb; /* ì„¸ë¡œì“°ê¸° í•´ì œ */
            width: 40px; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
            height: 40px; /* ğŸš© [ìˆ˜ì •] ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
            border-radius: 50%; /* ì›í˜• ë²„íŠ¼ */
            font-size: 20px; /* ğŸš© [ìˆ˜ì •] ì•„ì´ì½˜ í¬ê¸° ì¶•ì†Œ */
            line-height: 40px; /* ğŸš© [ìˆ˜ì •] ì•„ì´ì½˜ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            padding: 0;
        }
        /* ğŸš© [ì¶”ê°€] íŒ¨ë„ì´ ì—´ë ¸ì„ ë•Œ ë‹«ê¸° ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
        #rightPanel.visible + #rightPanelToggleBtn {
            /* ğŸš© [ìˆ˜ì •] íŒ¨ë„ì´ ì—´ë ¸ì„ ë•Œ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ íŒ¨ë„ì˜ ì™¼ìª½ ìƒë‹¨ìœ¼ë¡œ ì´ë™ */
            right: auto;
            left: 10px;
        }


        /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì˜¤ë¥¸ìª½ íŒ¨ë„ ë‚´ë¶€ ê¸€ì”¨ í¬ê¸° ì¡°ì • */
        #rightPanel .king-item,
        #rightPanel .record-item {
            font-size: 14px;
        }

        /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë ˆì´ì•„ì›ƒ: 4ì¤„ë¡œ ë¶„ë¦¬ */
        #top-controls-container {
            flex-direction: column !important;
            width: 100% !important;
            gap: 5px !important;
            justify-content: flex-start !important;
        }
        
        /* 1ì¤„: ì‹œê°„ ë° ì†ë„ ì»¨íŠ¸ë¡¤ */
        .time-controls {
            width: 100% !important;
            flex-wrap: wrap !important;
            order: 1;
            flex-basis: 100% !important;
            margin-bottom: 0 !important;
        }
        /* ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ ì‹œê°„ ì»¨íŠ¸ë¡¤ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        #time-controls-map {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            right: auto !important;
            max-width: calc(100% - 20px) !important;
            font-size: 11px !important;
            padding: 6px !important;
            flex-wrap: wrap !important;
        }
        #time-controls-map input[type="number"] {
            width: 60px !important;
            font-size: 11px !important;
            padding: 2px !important;
        }
        #time-controls-map button {
            font-size: 11px !important;
            padding: 3px 6px !important;
        }
        #time-controls-map #playbackSpeedSlider {
            width: 50px !important;
        }
        
        /* ğŸš© [ì‹ ê·œ] ëª¨ë°”ì¼ì—ì„œ í¸ì§‘ ì»¨íŠ¸ë¡¤ ì •ë ¬ - ì˜¤ë¥¸ìª½ ìƒë‹¨ */
        #edit-controls {
            position: fixed !important;
            top: 10px !important;
            right: 10px !important;
            bottom: auto !important;
            left: auto !important;
            margin-left: 0 !important;
            gap: 5px !important;
            height: auto !important;
            flex-wrap: wrap !important;
        }
        #edit-controls #mainEditBtn {
            height: 26px !important;
            padding: 4px 6px !important;
            font-size: 12px !important;
            white-space: nowrap !important;
        }
        #edit-dropdown-container {
            flex-shrink: 0 !important;
        }
        #edit-dropdown-menu {
            position: absolute !important;
            top: 100% !important;
            left: 0 !important;
            background-color: #1e2a38 !important;
            border: 1px solid #00aaff !important;
            border-radius: 4px !important;
            z-index: 1000 !important;
            min-width: 120px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
            display: none !important;
        }
        #edit-dropdown-menu.show {
            display: flex !important;
            flex-direction: column !important;
        }
        #edit-dropdown-menu .dropdown-item {
            display: block !important;
            width: 100% !important;
            padding: 6px 10px !important;
            text-align: left !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            font-size: 12px !important;
            color: #f0f0f0 !important;
            transition: background-color 0.2s !important;
        }
        #edit-dropdown-menu .dropdown-item:hover {
            background-color: #00aaff !important;
            color: #1e2a38 !important;
        }
        
        /* 2ì¤„: í•„í„° ë° ê²€ìƒ‰ (êµ­ê°€í•„í„°, ë¯¼ì¡±í•„í„°, ê²€ìƒ‰ì„ í•œ ì¤„ì—) */
        .right-controls {
            width: 100% !important;
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: wrap !important;
            order: 2;
            justify-content: flex-start !important;
            gap: 5px !important;
            align-items: center !important;
            margin-top: 0 !important;
            flex-basis: 100% !important;
        }
        /* êµ­ê°€í•„í„° - ê³ ì • í¬ê¸° */
        #country-filter-container {
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            height: 26px !important;
            gap: 3px !important;
            order: 1 !important;
        }
        #country-filter-container label {
            display: none !important;
        }
        #countryFilterSelect {
            width: 90px !important;
            font-size: 13px !important;
            padding: 5px 4px !important;
            height: 100% !important;
            box-sizing: border-box !important;
            line-height: 1.8 !important;
        }
        /* select option ê¸€ì”¨ í¬ê¸° */
        #countryFilterSelect option {
            font-size: 16px !important;
            padding: 12px 6px !important;
            line-height: 2 !important;
            background-color: #3e4a56 !important;
            color: #ffffff !important;
        }
        /* ë¯¼ì¡±í•„í„° - ê³ ì • í¬ê¸° */
        #dynastyTimelineFilterPanel {
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            gap: 2px !important;
            height: 26px !important;
            order: 2 !important;
        }
        #ethnicityFilterContainer {
            font-size: 13px !important;
            display: flex !important;
            align-items: center !important;
            gap: 2px !important;
            height: 100% !important;
        }
        /* ë¯¼ì¡±í•„í„° select ìš”ì†Œ - ë†’ì´ ë° ê¸€ì”¨ í¬ê¸° í†µì¼ */
        #ethnicityFilterContainer select {
            font-size: 13px !important;
            padding: 5px 4px !important;
            height: 100% !important;
            box-sizing: border-box !important;
            line-height: 1.8 !important;
        }
        /* ë¯¼ì¡±í•„í„° select option ê¸€ì”¨ í¬ê¸° */
        #ethnicityFilterContainer select option {
            font-size: 20px !important;
            padding: 12px 6px !important;
            line-height: 2 !important;
            background-color: #3e4a56 !important;
            color: #ffffff !important;
        }
        /* ê²€ìƒ‰ ì…ë ¥ ë° ë²„íŠ¼ - ë‚¨ì€ ê³µê°„ ì°¨ì§€í•˜ì§€ ì•Šê³  ê³ ì • í¬ê¸° */
        .right-controls > div:last-child {
            display: flex !important;
            align-items: center !important;
            position: relative !important;
            height: 26px !important;
            gap: 0 !important;
            flex: 0 0 auto !important;
            width: auto !important;
            order: 3 !important;
        }
        #searchInput {
            height: 100% !important;
            padding: 4px 6px !important;
            flex: 0 0 120px !important;
            font-size: 13px !important;
            min-width: 120px !important;
            box-sizing: border-box !important;
        }
        #searchBtn {
            height: 100% !important;
            flex-shrink: 0 !important;
            padding: 4px 10px !important;
            font-size: 13px !important;
            border-radius: 0 4px 4px 0 !important;
            border-left: none !important;
            box-sizing: border-box !important;
        }
        
        /* ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ - ì‹œê°„ ì»¨íŠ¸ë¡¤ ë‚´ë¶€ë¡œ ì´ë™ (ëª¨ë°”ì¼ì—ì„œ ì¤„ë°”ê¿ˆ) */
        #time-controls-map {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            right: 10px !important;
            max-width: calc(100% - 20px) !important;
            flex-wrap: wrap !important;
        }
        
        #time-controls-map > div {
            border-left: none !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
            width: 100% !important;
            margin-top: 8px !important;
            padding-top: 8px !important;
            border-top: 1px solid rgba(255,255,255,0.2) !important;
        }
        
        .layer-toggle-btn {
            flex: 0 0 calc(25% - 4px) !important;
            font-size: 10px !important;
            padding: 3px 2px !important;
            margin: 2px !important;
        }
        #country-filter-container {
            flex: 0 0 auto !important;
            min-width: 85px !important;
            margin: 0 !important;
        }
        #country-filter-container label {
            display: none !important;
        }
        #countryFilterSelect {
            width: 85px !important;
            font-size: 11px !important;
            padding: 3px !important;
        }
        #dynastyTimelineFilterPanel {
            flex: 0 0 auto !important;
            min-width: auto !important;
            order: 2;
            margin: 0 !important;
        }
        #dynastyTimelineFilterPanel > div {
            display: flex !important;
            flex-direction: row !important;
            gap: 2px !important;
            font-size: 11px !important;
        }
        /* ê²€ìƒ‰ ë°•ìŠ¤ - ë‚¨ì€ ê³µê°„ ì‚¬ìš© */
        .right-controls > div:last-child {
            flex: 1 1 auto !important;
            min-width: 100px !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            position: relative !important;
        }
        #searchInput {
            width: 100% !important;
            font-size: 11px !important;
            padding: 4px !important;
        }
        #searchBtn {
            padding: 4px 6px !important;
            font-size: 11px !important;
            flex-shrink: 0 !important;
        }
        
        /* 4ì¤„: ìŠ¬ë¼ì´ë”ì™€ ì—°ëŒ€í‘œ */
        #timeline-control {
            position: fixed !important;
            bottom: 0 !important; /* ğŸš© [ìˆ˜ì •] í™”ë©´ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™ */
            left: 15% !important; /* ì¢Œì¸¡ ë²„íŠ¼ ì»¨í…Œì´ë„ˆì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ ì¡°ì • */
            right: 2.5% !important;
            width: auto !important;
            z-index: 9999 !important;
            background: transparent !important;
            padding: 10px !important;
            border-radius: 0 !important;
            backdrop-filter: none !important;
        }
        
        #timeline-container {
            height: 35px !important;
        }
        
        #timeline-fade-left,
        #timeline-fade-right {
            width: 80px !important;
        }
        
        /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #controls-wrapper .layer-toggle-btn {
            font-size: 11px !important;
            padding: 4px 2px !important;
        }
        /* ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ í¸ì§‘ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ ì¡°ì • */
        #edit-dropdown-menu {
            min-width: 150px; /* ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ ë„ˆë¹„ í™•ë³´ */
        }
        
        /* ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ë¶€ ì»¨íŠ¸ë¡¤ë“¤ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        #time-controls-map {
            position: fixed !important;
            top: 55px !important;
            left: 10px !important;
            right: 10px !important;
            width: auto !important;
            max-width: calc(100vw - 90px) !important;
            z-index: 500 !important;
            flex-wrap: wrap !important;
            padding: 6px !important;
        }
        
        #time-controls-map #timeLabelDisplay {
            font-size: 10px !important;
            min-width: 160px !important;
        }
        
        #time-controls-map #yearLabel {
            display: inline-block !important;
            min-width: 60px !important;
            text-align: right !important;
        }
        
        #time-controls-map #monthLabel {
            display: inline-block !important;
            min-width: 18px !important;
            text-align: right !important;
        }
        
        #time-controls-map #ganjiLabel {
            display: inline-block !important;
            min-width: 35px !important;
        }
        
        #time-controls-map #yearInput {
            width: 55px !important;
            min-height: 32px !important;
            font-size: 13px !important;
            padding: 4px !important;
        }
        
        #time-controls-map #monthInput {
            width: 38px !important;
            min-height: 32px !important;
            font-size: 13px !important;
            padding: 4px !important;
        }
        
        #time-controls-map .time-control-btn,
        #time-controls-map #playBtn,
        #time-controls-map #pauseBtn {
            min-height: 28px !important;
            font-size: 11px !important;
            padding: 3px 6px !important;
        }
        
        #time-controls-map input[type="range"] {
            min-height: 32px !important;
        }
        
        #time-controls-map label,
        #time-controls-map #speedDisplay {
            font-size: 11px !important;
        }
        
        #layer-toggles {
            width: 100% !important;
            margin-top: 8px !important;
            flex-wrap: wrap !important;
        }
        
        #layer-toggles .layer-toggle-btn {
            flex: 0 0 calc(33.333% - 6px) !important;
            min-height: 26px !important;
            font-size: 9px !important;
            padding: 3px 4px !important;
            margin: 2px !important;
        }
        
        #edit-controls {
            position: fixed !important;
            top: 55px !important;
            right: 10px !important;
            z-index: 500 !important;
        }
        
        #edit-controls button {
            min-height: 32px !important;
            padding: 6px 10px !important;
            font-size: 12px !important;
        }
        
        #map-search-filter {
            position: fixed !important;
            bottom: 10px !important;
            left: 10px !important;
            right: 10px !important;
            transform: none !important;
            width: auto !important;
            padding: 6px 8px !important;
            flex-wrap: wrap !important;
            gap: 6px !important;
            z-index: 1000 !important;
        }
        
        #map-search-filter select,
        #map-search-filter input,
        #map-search-filter button {
            font-size: 10px !important;
            padding: 3px 5px !important;
            min-height: 28px !important;
        }
        
        /* ëª¨ë“  í¸ì§‘ í¼ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        #castleForm, #historyForm, #editForm, #battleForm,
        #cityForm, #labelForm, #naturalForm, #armyForm, #eventForm, #editBattleForm {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 90vw !important;
            max-width: 500px !important;
            max-height: 85vh !important;
            overflow-y: auto !important;
            z-index: 10000 !important;
            padding: 15px !important;
        }
        
        #castleForm input, #historyForm input, #editForm input, #battleForm input,
        #cityForm input, #labelForm input, #naturalForm input, #armyForm input,
        #eventForm input, #editBattleForm input,
        #castleForm select, #historyForm select, #editForm select, #battleForm select,
        #cityForm select, #labelForm select, #naturalForm select, #armyForm select,
        #eventForm select, #editBattleForm select,
        #castleForm textarea, #historyForm textarea, #editForm textarea, #battleForm textarea,
        #cityForm textarea, #labelForm textarea, #naturalForm textarea, #armyForm textarea,
        #eventForm textarea, #editBattleForm textarea {
            min-height: 44px !important;
            font-size: 14px !important;
            padding: 10px !important;
            margin-bottom: 8px !important;
        }
        
        #castleForm button, #historyForm button, #editForm button, #battleForm button,
        #cityForm button, #labelForm button, #naturalForm button, #armyForm button,
        #eventForm button, #editBattleForm button {
            min-height: 44px !important;
            font-size: 14px !important;
            padding: 10px !important;
            margin: 5px !important;
        }
    }

    /* ğŸš© [ì¶”ê°€] í¸ì§‘ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        #edit-dropdown-menu {
                display: none;
                position: absolute;
                right: 0;
                top: 100%;
                background-color: #ecf0f1;
                border: 1px solid #5d7185;
                border-radius: 4px;
                z-index: 1010;
                min-width: 120px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                max-height: 60vh;
                overflow-y: auto;
        }
        /* (max-width: 967px) ë¯¸ë””ì–´ ì¿¼ë¦¬ ë‚´ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ì€ force-mobileì™€ ë™ì¼í•˜ê²Œ ë§ì¶”ê±°ë‚˜ ì‚­ì œ */
    #edit-dropdown-menu.show {
        display: block;
    }
    /* ğŸš© [ì¶”ê°€] ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
    .dropdown-item {
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: none;
        background: none;
    }
    .dropdown-item.danger {
        color: #ff7675;
        font-weight: 600;
    }
    .dropdown-item.danger:hover {
        background-color: #c0392b;
        color: #fff;
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] íŒì—… ìŠ¤íƒ€ì¼ -->
  <style>
    .leaflet-popup-content-wrapper {
        background-image: url('https://img.freepik.com/free-photo/vintage-grungy-textured-paper-background_53876-103932.jpg?semt=ais_hybrid&w=740&q=80');
        background-size: cover;
        background-repeat: no-repeat;
        color: #333; /* ì–´ë‘ìš´ ê¸€ììƒ‰ìœ¼ë¡œ ê°€ë…ì„± í™•ë³´ */
        border-radius: 5px;
        box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        z-index: 10000 !important;
    }
    .leaflet-popup-content {
        font-family: 'Noto Serif KR', serif; /* íŒì—… í°íŠ¸ ë³€ê²½ */
        margin: 13px 19px;
        line-height: 1.5;
        white-space: pre-wrap; /* ğŸš© [ì¶”ê°€] ì¤„ë°”ê¿ˆê³¼ ê³µë°± ë³´ì¡´ */
        word-wrap: break-word; /* ğŸš© [ì¶”ê°€] ê¸´ ë‹¨ì–´ ìë™ ì¤„ë°”ê¿ˆ */
        text-align: left; /* ğŸš© [ì¶”ê°€] ì¢Œì¸¡ ì •ë ¬ */
        max-height: 300px; /* ğŸš© [ì¶”ê°€] ìµœëŒ€ ë†’ì´ ì„¤ì • */
        overflow-y: auto; /* ğŸš© [ì¶”ê°€] ì„¸ë¡œ ìŠ¤í¬ë¡¤ */
    }
    .leaflet-popup-content-wrapper {
        max-height: 350px; /* ğŸš© [ì¶”ê°€] íŒì—… ì „ì²´ ìµœëŒ€ ë†’ì´ */
    }
    .leaflet-popup {
        z-index: 10000 !important;
    }

    /* ğŸš© [ì¶”ê°€] ì˜í†  í´ë¦¬ê³¤ ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
    .leaflet-interactive {
        transition: fill-opacity 0.5s ease, opacity 0.5s ease, fill 0.5s ease;
    }

    /* ğŸš© [ì¶”ê°€] ì—­ì‚¬ì  ì‚¬ê±´ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .historical-event-marker {
        position: relative;
    }

    .historical-event-marker::before {
        content: '';
        position: absolute;
        top: -16px; /* ìŠ¬ë¼ì´ë” ë°”ë¡œ ìœ„ì— ê²¹ì¹˜ì§€ ì•Šê²Œ ìœ„ìª½ìœ¼ë¡œ ì´ë™ */
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-bottom: 6px solid rgba(30, 42, 56, 0.95);
        z-index: 11;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }

    /* ğŸš© [ì¶”ê°€] ì—­ì‚¬ì  ì‚¬ê±´ íˆ´íŒ ìŠ¤íƒ€ì¼ */
    .historical-event-tooltip {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ë³€ê²½ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ -->
  <style>
    .leaflet-control-layers-selector {
        display: flex;
        flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
        gap: 4px;
        background-color: transparent;
        padding: 0;
        border-radius: 0;
        box-shadow: none;
    }
    .leaflet-control-layers-selector button {
        padding: 2px 8px;
        font-size: 13px;
    }
  </style>

  <!-- ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ê¸° íˆ´ë°” ìœ„ì¹˜ ì¡°ì • - ì—°ëŒ€í‘œ í•˜ë‹¨ ë°°ì¹˜ -->
  <style>
    .leaflet-top.leaflet-left {
        top: 270px !important; /* ì—°ëŒ€í‘œ ë°”ë¡œ ì•„ë˜ (60px + 200px + 10px) */
    }
    .leaflet-top.leaflet-left .leaflet-draw-toolbar {
        margin-top: 0 !important;
    }
    /* ëª¨ë°”ì¼ì—ì„œ ê·¸ë¦¬ê¸° íˆ´ë°” ìœ„ì¹˜ ì¡°ì • */
    body.force-mobile .leaflet-top.leaflet-left {
        top: 200px !important; /* ëª¨ë°”ì¼ ì—°ëŒ€í‘œ í•˜ë‹¨ */
    }
  </style>

  <!-- ğŸš© [ì¶”ê°€] í—¤ë” ì»¨í…Œì´ë„ˆ ë° ë¡œê·¸ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ -->
  <style>
    /* ğŸš© [ìˆ˜ì •] ìµœìƒë‹¨ ë°” (ë¡œê·¸ì¸ ì •ë³´ ë“±) ìŠ¤íƒ€ì¼ */
    #top-bar-container {
        display: flex;
        justify-content: space-between;
        align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        padding: 5px 20px; /* ìƒí•˜ íŒ¨ë”© ì¶•ì†Œ */
        width: 100%;
        box-sizing: border-box;
        position: relative;
        z-index: 1100;
    }
    
    /* ğŸ” í–„ë²„ê±° ë©”ë‰´ ìŠ¤íƒ€ì¼ */
    #hamburger-menu-btn {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        background: rgba(30, 42, 56, 0.95);
        border: 1px solid #5d7185;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0;
        gap: 5px;
        z-index: 1101;
    }
    
    #hamburger-menu-btn:hover {
        background: rgba(50, 62, 76, 0.95);
        border-color: #00aaff;
    }
    
    #hamburger-menu-btn span {
        display: block;
        width: 22px;
        height: 2px;
        background: #ecf0f1;
        transition: all 0.3s ease;
        border-radius: 2px;
    }
    
    #hamburger-menu-btn.active span:nth-child(1) {
        transform: rotate(45deg) translate(7px, 7px);
    }
    
    #hamburger-menu-btn.active span:nth-child(2) {
        opacity: 0;
    }
    
    #hamburger-menu-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -7px);
    }
    
    /* ğŸ” ìŠ¬ë¼ì´ë”© ë©”ë‰´ íŒ¨ë„ */
    #hamburger-menu-panel {
        position: fixed;
        top: 0;
        left: -350px;
        width: 350px;
        height: 100vh;
        background: rgba(30, 42, 56, 0.98);
        backdrop-filter: blur(10px);
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        transition: left 0.3s ease;
        z-index: 1100;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
    }
    
    #hamburger-menu-panel.active {
        left: 0;
    }
    
    #hamburger-menu-panel h3 {
        color: #f5e9d2;
        font-size: 16px;
        margin: 20px 0 10px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    #hamburger-menu-panel .menu-section {
        margin-bottom: 20px;
    }
    
    #hamburger-menu-panel label {
        display: block;
        color: #ddd;
        font-size: 13px;
        margin-bottom: 5px;
    }
    
    #hamburger-menu-panel input[type="text"],
    #hamburger-menu-panel input[type="number"],
    #hamburger-menu-panel select {
        width: 100%;
        padding: 8px;
        font-size: 13px;
        border: 1px solid #5d7185;
        border-radius: 4px;
        background: rgba(50, 62, 76, 0.5);
        color: #ecf0f1;
        box-sizing: border-box;
    }
    
    #hamburger-menu-panel button {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        font-size: 13px;
        border: 1px solid #5d7185;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: rgba(50, 62, 76, 0.8);
        color: #ecf0f1;
    }
    
    #hamburger-menu-panel button:hover {
        background: rgba(70, 82, 96, 0.9);
        border-color: #00aaff;
    }
    
    /* ğŸ” ë©”ë‰´ ì˜¤ë²„ë ˆì´ (ë°°ê²½ ì–´ë‘¡ê²Œ) */
    #hamburger-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1099;
        display: none;
        transition: opacity 0.3s ease;
    }
    
    #hamburger-menu-overlay.active {
        display: block;
    }
    /* ğŸš© [ìˆ˜ì •] ì œëª© ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #title-container {
        text-align: center;
        padding: 0 20px 10px; /* ì œëª© ì•„ë˜ì—ë§Œ íŒ¨ë”© ì ìš© */
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #top-right-auth {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
    }
    #top-left-icons {
        display: flex; /* ì•„ì´ì½˜ë“¤ì„ ê°€ë¡œë¡œ ë‚˜ì—´ */
        gap: 5px;     /* ì•„ì´ì½˜ ì‚¬ì´ì˜ ê°„ê²© */
        flex-shrink: 0;
    }
    @media (min-width: 968px) {
        #top-left-icons {
            display: flex !important;
        }
    }
    @media (max-width: 967px) {
        #top-left-icons {
            display: none !important;
        }
    }
    /* ğŸš© [ìˆ˜ì •] ì œëª© ìŠ¤íƒ€ì¼ ì¡°ì • */
    #title-container h1 {
        margin: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
        display: inline-block;
    }

    /* ğŸš© [ìˆ˜ì •] ì»¨íŠ¸ë¡¤ íŒ¨ë„ ì „ì²´ ê¸€ê¼´ í†µì¼ */
    #controls-wrapper {
        font-family: Arial, sans-serif;
        font-weight: 700;
    }

    /* ğŸš© [ì¶”ê°€] í•œì ì œëª©ì„ ìœ„í•œ ë¶“ê¸€ì”¨ í°íŠ¸ ìŠ¤íƒ€ì¼ */
    .hanja-title {
        font-family: 'Yeon Sung', cursive;
        font-weight: 400;
        font-size: 0.9em; /* í•œê¸€ê³¼ì˜ ì¡°í™”ë¥¼ ìœ„í•´ í¬ê¸° ë¯¸ì„¸ ì¡°ì • */
    }
  </style>
  <!-- ğŸš© [í•µì‹¬ ìˆ˜ì •] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ì„ ë³„ë„ì˜ <style> íƒœê·¸ë¡œ ë¶„ë¦¬í•˜ì—¬ CSS ì¶©ëŒ í•´ê²° -->
  <style> 
    #event-overlay {
        position: absolute;
        top: 50%;
        left: 50%; /* ğŸš© [ìˆ˜ì •] leftColumn ë‚´ë¶€ì—ì„œ ì¤‘ì•™ ì •ë ¬ */
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 1);
        color: #e5ff00;
        padding: 20px 40px;
        border-radius: 12px; /* ğŸš© [ìˆ˜ì •] z-indexë¥¼ ë§¤ìš° ë†’ê²Œ ì„¤ì •í•˜ì—¬ ëª¨ë“  ìš”ì†Œ ìœ„ì— ì˜¤ë„ë¡ í•¨ */
        z-index: 9999;
        font-size: 2.5em;
        /* ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ í‘œì‹œí•˜ê¸° ìœ„í•´ flexbox ì‚¬ìš© */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;

        font-weight: bold;
        text-shadow: 2px 2px 5px #000;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none; /* ì˜¤ë²„ë ˆì´ê°€ ì§€ë„ í´ë¦­ì„ ë§‰ì§€ ì•Šë„ë¡ ì„¤ì • */
        white-space: nowrap;
        border: 0px solid rgba(255, 255, 255, 0.5);
    }
    #event-overlay.visible { opacity: 1; }
    /* ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    #event-overlay-image {
        max-width: 40vw;
        max-height: 25vh;
        border-radius: 8px;
        object-fit: contain;
    }
    /* ğŸš© [ì¶”ê°€] PC ë²„ì „ ìƒë‹¨ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #pcTopPanelToggleBtn {
        display: none; /* ğŸš© [ìˆ˜ì •] ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¸°ê³ , ëª¨ë°”ì¼ì—ì„œë§Œ í‘œì‹œ */
        /* ğŸš© [ì œê±°] ê°œë³„ ë§ˆì§„ ì œê±°, gapìœ¼ë¡œ í†µì¼ */
        padding: 6px 10px;
        background-color: transparent; /* ë°°ê²½ íˆ¬ëª… */
        font-size: 22px; /* ğŸš© [ìˆ˜ì •] ì•„ì´ì½˜ í¬ê¸° í‚¤ì›€ */
        border: none; /* ğŸš© [ìˆ˜ì •] í…Œë‘ë¦¬ ì œê±° */
        color: #dbdbdb; /* ğŸš© [ì¶”ê°€] ê¸°ë³¸ ì•„ì´ì½˜ ìƒ‰ìƒ */
        color: #00aaff; /* ğŸš© [ìˆ˜ì •] í˜¸ë²„ ë° í™œì„± ìƒíƒœ ìƒ‰ìƒ (ì•„ì´ì½˜ ìƒ‰ìƒ ë³€ê²½) */
    }

    /* ğŸš© [ì¶”ê°€] ìƒë‹¨ íŒ¨ë„ ìˆ¨ê¹€ í´ë˜ìŠ¤ */
    /* ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ ìˆ¨ê¹€ í´ë˜ìŠ¤ */
    body.right-panel-hidden #rightPanel {
        flex-basis: 0 !important; /* Force to 0 */
        overflow: hidden;
        padding: 0;
        border: none;
    }
    body.right-panel-hidden #resizer {
        display: none;
    }

    /* ğŸš© [ìˆ˜ì •] ì˜¤ë¥¸ìª½ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ PC/íƒœë¸”ë¦¿/ëª¨ë°”ì¼ ëª¨ë‘ ë³´ì´ë„ë¡ */
    @media (min-width: 901px) {
        #rightPanelToggleBtn {
            writing-mode: vertical-rl;
            top: 10px;
            left: -28px;
            right: auto;
            bottom: auto;
            width: auto;
            height: auto;
            border-radius: 5px 0 0 5px;
            font-size: 12px;
            line-height: 1;
            padding: 10px 5px;
            display: block !important;
        }
    }
    @media (max-width: 900px) {
        #rightPanelToggleBtn {
            display: block !important;
        }
    }
    @media (max-width: 967px) {
        #pcTopPanelToggleBtn { display: block; }
        
        /* ëª¨ë°”ì¼ìš© timeline-sidebar ìŠ¤íƒ€ì¼ */
        #timeline-sidebar {
            bottom: 40px !important;
            left: 2% !important;
            right: 2% !important;
            width: 96% !important;
            max-width: none !important;
            height: 60vh !important;
            top: auto !important;
            background: rgba(10,16,26,0.85) !important;
            backdrop-filter: blur(4px) !important;
            border: 1px solid rgba(255,220,100,0.15) !important;
            font-size: 13px !important;
        }
        
        #timeline-sidebar h3 {
            font-size: 16px !important;
        }
        
        .timeline-group-header h4 {
            font-size: 15px !important;
        }
        
        .timeline-event {
            font-size: 13px !important;
            padding: 8px 12px !important;
        }
        
        .timeline-event-title {
            font-size: 13px !important;
        }
        
        .timeline-event-desc {
            font-size: 11px !important;
        }
    }
</style>
<body>
  <!-- ğŸ¨ [ì¶”ê°€] ìˆ˜ë¬µí™” íš¨ê³¼ë¥¼ ìœ„í•œ SVG í•„í„° -->
  <svg width="0" height="0" style="position: absolute;">
    <defs>
      <filter id="sumi-ink-blur" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="1.5"/>
        <feColorMatrix type="matrix" values="0.8 0 0 0 0  0 0.6 0 0 0  0 0 0.4 0 0  0 0 0 0.7 0"/>
      </filter>
    </defs>
  </svg>
  
  <!-- ğŸš€ [v2.0.5] ì´ˆê¸° ë¡œë”© í™”ë©´ (JavaScript ì‹¤í–‰ ì „ë¶€í„° í‘œì‹œ) -->
  <div id="initial-loading-screen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #130000 0%, #2c0a0a 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 999999;
    color: #f5e9d2;
    font-family: 'Noto Serif KR', serif;
  ">
    <h2 style="font-size: 2.5em; margin-bottom: 20px; text-shadow: 2px 2px 4px #000;">
      ê³ ë ¤ë§Œë¦¬ì§€ë„ <span style="font-size: 0.7em;">(é«˜éº—è¬é‡Œåœ°åœ–)</span>
    </h2>
    
    <!-- ğŸ¯ ëœë¤ ë¡œë”© ë©”ì‹œì§€ -->
    <div id="loading-message-text" style="font-size: 1.2em; margin-bottom: 10px; color: #d4af37; min-height: 30px; text-align: center; padding: 0 20px;">
      ì—­ì‚¬ì˜ ë¬¸ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </div>
    
    <!-- ğŸ¯ í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
    <div style="width: 400px; max-width: 80%; background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; height: 8px; margin-bottom: 20px;">
      <div id="loading-progress-bar-initial" style="width: 0%; height: 100%; background: linear-gradient(90deg, #d4af37, #f5e9d2); transition: width 0.3s ease; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);"></div>
    </div>
    
    <!-- ğŸ¯ í¼ì„¼íŠ¸ í‘œì‹œ -->
    <div id="loading-percentage-initial" style="font-size: 14px; color: #d4af37; margin-bottom: 30px; font-weight: bold;">0%</div>
    
    <div style="
      width: 60px;
      height: 60px;
      border: 5px solid rgba(212, 175, 55, 0.3);
      border-top-color: #d4af37;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    "></div>
    <style>
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </div>

  
  <!-- ğŸš© [ìˆ˜ì •] í—¤ë”ë¥¼ ìµœìƒë‹¨ ë°”ì™€ ì œëª© ì»¨í…Œì´ë„ˆë¡œ ë¶„ë¦¬ -->
  <div id="top-bar-container">
      <!-- Hamburger Menu Button -->
      <button id="hamburger-menu-btn">
          <span></span>
          <span></span>
          <span></span>
      </button>
      
      <div id="top-left-icons">
          <a href="https://www.youtube.com/@booksbogo" target="_blank" rel="noopener noreferrer" title="ì±…ë³´ê³ "><img style="width: 26px; height: 26px; border-radius: 50%;" src="https://yt3.googleusercontent.com/ZiZJsEzG5LkM6UItGT5mrhygyGxYWsj8OmpLYeVnMNAbtD3D7KWtGX3NsjhMMFbMFUyZ-tY-Pg=s160-c-k-c0x00ffffff-no-rj"></a>
          <a href="https://www.youtube.com/@%EC%9D%B4%EC%9A%A9%ED%9B%88%EB%B0%95%EC%82%AC%EC%9D%98%EC%B0%90%EC%82%BC%EA%B5%AD%EC%82%AC" target="_blank" rel="noopener noreferrer" title="ì°ì‚¼êµ­ì‚¬"><img style="width: 26px; height: 26px; border-radius: 50%;" src="https://yt3.googleusercontent.com/adIg0ayz8Thp44XkOP7Wscn4cebPYCNhr2I_ZVuMEGPMdfXRZZTRI-qBiCh68BpHZa_ZmcH9YZ8=s160-c-k-c0x00ffffff-no-rj"></a>
          <a href="https://www.youtube.com/@Ourhistory2023" target="_blank" rel="noopener noreferrer" title="ìš°ë¦¬ì—­ì‚¬"><img style="width: 26px; height: 26px; border-radius: 50%;" src="https://yt3.googleusercontent.com/90aOk5qirQI3Ug5MZGEtOSonAKL3AYWZSeYXnYTtQpC8XDWdbYOEr4D5V5Dy-V_ADN6fdhwV=s160-c-k-c0x00ffffff-no-rj"></a>
        </div>
    <h1 id="main-title" style="font-family: 'Noto Serif KR', serif; margin: 0; display: inline-block; color: #f5e9d2; text-shadow: 2px 2px 4px #000;"><img src="https://github.com/projeffmanager-design/historymap/blob/main/2I63ySQI9qG-97MMKptL_n5FJhNOWE2DLt-ZKOcLL5TKeV4xxTfCN06j0lhGg5YMDH0ade2X99P-pzcKInnlOg.png?raw=true" width="25" height="25"> ê³ ë ¤ë§Œë¦¬ì§€ë„ <span class="hanja-title">(é«˜éº—è¬é‡Œåœ°åœ–)</span></h1>

        <div id="top-right-auth">

        <span id="usernameDisplay" style="font-weight: bold;"></span>
        
          <!-- ğŸš© [ì¶”ê°€] ê³ ì§€ë„ ë²„íŠ¼ -->
          <button id="topbar-ancient-maps-btn" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #ecf0f1; padding: 6px 10px; font-size: 12px; font-weight: 500; cursor: pointer; margin-left: 10px; transition: all 0.3s ease; font-family: 'Noto Serif KR', serif;">ê³ ì§€ë„ â–¼</button>
          
          <!-- ğŸš© [ì¶”ê°€] ê³ ì§€ë„ ë“œë¡­ë‹¤ìš´ ì»¨í…Œì´ë„ˆ -->
          <div id="topbar-ancient-maps-dropdown-container" style="position: relative;">
              <div id="topbar-ancient-maps-dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0; background: rgba(30, 42, 56, 0.98); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px; z-index: 1102; min-width: 180px; margin-top: 4px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                  <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
              </div>
          </div>
          
          <!-- ğŸš© [ì¶”ê°€] í¸ì§‘ ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ -->
          <div id="topbar-edit-dropdown-container" style="position: relative; display: none;">
              <button id="topbarEditBtn" class="button-style primary" style="background-color: #3498db; border-color: #2980b9;">í¸ì§‘ â–¾</button>
              <div id="topbar-edit-dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0; background: rgba(30, 42, 56, 0.98); border: 1px solid #5d7185; border-radius: 4px; padding: 8px; z-index: 1102; min-width: 150px; margin-top: 4px;">
                  <button id="topbar-cityEditBtn" style="display: block; width: 100%; padding: 8px; margin: 2px 0; font-size: 13px; background: transparent; border: none; color: #ecf0f1; cursor: pointer; text-align: left; border-radius: 4px;">ì„±/ë„ì‹œ í¸ì§‘</button>
                  <button id="topbar-countryEditBtn" style="display: block; width: 100%; padding: 8px; margin: 2px 0; font-size: 13px; background: transparent; border: none; color: #ecf0f1; cursor: pointer; text-align: left; border-radius: 4px;">êµ­ê°€ í¸ì§‘</button>
                  <button id="topbar-kingEditBtn" style="display: block; width: 100%; padding: 8px; margin: 2px 0; font-size: 13px; background: transparent; border: none; color: #ecf0f1; cursor: pointer; text-align: left; border-radius: 4px;">ì™• í¸ì§‘</button>
                  <button id="topbar-eventEditBtn" style="display: block; width: 100%; padding: 8px; margin: 2px 0; font-size: 13px; background: transparent; border: none; color: #ecf0f1; cursor: pointer; text-align: left; border-radius: 4px;">ì´ë²¤íŠ¸ í¸ì§‘</button>
                  <button id="topbar-trashBtn" style="display: block; width: 100%; padding: 8px; margin: 2px 0; font-size: 13px; background: transparent; border: none; color: #f39c12; cursor: pointer; text-align: left; border-radius: 4px;">ğŸ—‘ï¸ íœ´ì§€í†µ</button>
                  <hr style="border: 0; border-top: 1px solid #5d7185; margin: 4px 0;">
                  <button id="topbar-exitEditBtn" style="display: block; width: 100%; padding: 8px; margin: 2px 0; font-size: 13px; background: transparent; border: none; color: #e74c3c; cursor: pointer; text-align: left; border-radius: 4px;">í¸ì§‘ëª¨ë“œ ì¢…ë£Œ</button>
              </div>
          </div>
          
          <!-- ğŸš© [ì´ë™] PCìš© ì»¨íŠ¸ë¡¤ í† ê¸€ ë²„íŠ¼ì„ ì•„ì´ë”” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ -->
          <!-- ëª¨ë°”ì¼ì—ì„œëŠ” í†±ë‹ˆ ë²„íŠ¼ ì œê±° -->
          <button id="pcTopPanelToggleBtn" class="button-style" title="ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°" style="display:none;">âš™ï¸</button>
          <a id="recruitLink" href="recruit.html" class="button-style" style="background-color: #f39c12; border-color: #e67e22; font-weight: 600;">ì‚¬ê´€ ëª¨ì§‘</a>
          <button id="rankingBtn" class="button-style" style="background-color: #f39c12; border-color: #e67e22; font-weight: 600;">ì‚¬ê´€(å²é¤¨)ë­í‚¹</button>
      </div>
  </div>

  <!-- Hamburger Menu Overlay -->
  <div id="hamburger-menu-overlay"></div>
  
  <!-- Hamburger Menu Panel -->
  <div id="hamburger-menu-panel">
      <h3>ğŸ” ê²€ìƒ‰ & í•„í„°</h3>
      <div class="menu-section">
          <label for="menu-search-input">ê²€ìƒ‰:</label>
          <input type="text" id="menu-search-input" placeholder="ì„±, ë„ì‹œ, ì§€ì—­ëª… ê²€ìƒ‰">
          <button id="menu-search-btn" class="primary">ê²€ìƒ‰</button>
          
          <label for="menu-ethnicity-select" style="margin-top: 10px;">ë¯¼ì¡± í•„í„°:</label>
          <select id="menu-ethnicity-select">
              <option value="all">ì „ì²´</option>
          </select>
          
          <label for="menu-country-select" style="margin-top: 10px;">êµ­ê°€ í•„í„°:</label>
          <select id="menu-country-select">
              <option value="all">ì „ì²´</option>
          </select>
      </div>
      
      <h3>â±ï¸ ì‹œê°„ ì œì–´</h3>
      <div class="menu-section">
          <label for="menu-year-input">ì—°ë„:</label>
          <input type="number" id="menu-year-input" min="-5000" max="2030" value="400">
          
          <label for="menu-month-input">ì›”:</label>
          <input type="number" id="menu-month-input" min="1" max="12" value="1">
          
          <button id="menu-go-to-time" class="primary">ì´ë™</button>
      </div>
      
      <h3>ğŸ¨ í‘œì‹œ ë ˆì´ì–´</h3>
      <div class="menu-section">
          <label><input type="checkbox" id="menu-layer-city" checked> ì„±/ë„ì‹œ</label>
          <label><input type="checkbox" id="menu-layer-territory" checked> ì˜í† </label>
          <label><input type="checkbox" id="menu-layer-country-label" checked> êµ­ê°€ëª…</label>
          <label><input type="checkbox" id="menu-layer-place-label"> ì§€ëª…</label>
          <label><input type="checkbox" id="menu-layer-ethnic-label"> ë¯¼ì¡±</label>
          <label><input type="checkbox" id="menu-layer-military"> êµ°ëŒ€</label>
          <label><input type="checkbox" id="menu-layer-natural"> ìì—°</label>
          <label><input type="checkbox" id="menu-layer-rivers"> ê°•</label>
          <label><input type="checkbox" id="menu-layer-timeline"> ì—°ëŒ€í‘œ</label>
          <label><input type="checkbox" id="menu-layer-king"> ì™• íŒ¨ë„</label>
          <label><input type="checkbox" id="menu-layer-history"> ì—­ì‚¬ íŒ¨ë„</label>
          <label><input type="checkbox" id="menu-layer-contributions" checked> ì‚¬ê´€ ì‚¬ë£Œ</label>
      </div>
      
      <h3>ğŸ“ ë„êµ¬</h3>
      <div class="menu-section">
          <button id="menu-historical-record">ì‚¬ê´€ ê¸°ë¡ ì œì¶œ</button>
          <hr style="border: 0; border-top: 1px solid #5d7185; margin: 8px 0;">
          <button id="menu-ranking-btn" style="background: rgba(243,156,18,0.1); border-color: #f39c12; color: #f39c12;">ğŸ† ì‚¬ê´€ ë­í‚¹</button>
          <hr style="border: 0; border-top: 1px solid #5d7185; margin: 8px 0;">
          <button id="menu-account-management">ê³„ì • ê´€ë¦¬</button>
          <button id="menu-user-management" style="display:none;">íšŒì› ê´€ë¦¬</button>
          <button id="menu-territory-management" style="display:none;">ì˜í†  ê´€ë¦¬</button>
          <button id="menu-logout" class="danger">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
  </div>

  <!-- ğŸš© [ìˆ˜ì •] ì»¨íŠ¸ë¡¤ëŸ¬ë“¤ì„ ë³„ë„ì˜ wrapperë¡œ ë¶„ë¦¬ -->
  <!-- ğŸš© [ìˆ˜ì •] contentContainerë¥¼ mainContainerë¡œ ë³€ê²½í•˜ê³ , leftColumnê³¼ rightPanelì„ í¬í•¨í•˜ë„ë¡ êµ¬ì¡° ë³€ê²½ -->
  <div id="mainContainer">
    <div id="leftColumn" style="flex-basis: 70%; flex-grow: 1; flex-shrink: 1;">
      <div id="map" style="width: 100%; height: 100%; min-height: 0; position: relative;">
        <!-- ğŸš© [ìˆ¨ê¹€] ì‹œê°„ ì»¨íŠ¸ë¡¤ê³¼ ë ˆì´ì–´ í† ê¸€ì„ ì§€ë„ ë‚´ë¶€ ì™¼ìª½ ìƒë‹¨ì— ë°°ì¹˜ (í–„ë²„ê±° ë©”ë‰´ë¡œ ì´ë™) -->
        <div id="time-controls-map" class="time-controls" style="position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(30, 42, 56, 0.95); padding: 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none; align-items: center; gap: 5px;">
            <!-- ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ê·¸ë£¹ (ì—°ë„ + í™”ì‚´í‘œ + í‘œì‹œ + í¸ì§‘) -->
            <div id="mobile-left-controls" style="display: none; align-items: center; gap: 2px;">
                <span id="timeLabelDisplay" style="white-space: nowrap; text-align: left; font-size: 13px; font-family: 'Courier New', monospace; display: inline-block; padding: 4px 8px; background: rgba(0,0,0,0.2); border-radius: 3px; height: 26px; line-height: 18px; box-sizing: border-box; font-weight: 600;">
                    <span id="eraLabel" style="display: inline-block;">A.D.</span> <span id="yearLabel" style="display: inline-block; text-align: right; min-width: 50px;">0400</span>ë…„ <span id="monthLabel" style="display: inline-block; text-align: right; min-width: 15px;">01</span>ì›”  <span id="ganjiLabel" style="display: inline-block; font-size: 11px; opacity: 0.9;"></span>
                </span>
                <!-- ëª¨ë°”ì¼ìš© í™”ì‚´í‘œ ë²„íŠ¼ -->
                <div id="mobile-year-controls" style="display: flex; align-items: center; gap: 1px;">
                    <button id="prevYearBtn" class="year-arrow-btn" style="padding: 0 6px; font-size: 12px; background: rgba(50, 62, 76, 0.9); border: 1px solid #5d7185; border-radius: 3px; color: #ecf0f1; cursor: pointer; height: 26px; line-height: 1;">â—€</button>
                    <button id="nextYearBtn" class="year-arrow-btn" style="padding: 0 6px; font-size: 12px; background: rgba(50, 62, 76, 0.9); border: 1px solid #5d7185; border-radius: 3px; color: #ecf0f1; cursor: pointer; height: 26px; line-height: 1;">â–¶</button>
                </div>
                
                <!-- ğŸš© [ì´ë™] ëª¨ë°”ì¼ìš© í‘œì‹œ ë²„íŠ¼ -->
                <div id="mobile-layer-toggle-container" style="position: relative;">
                    <button id="mobile-layer-toggle-btn" style="padding: 0 6px; font-size: 10px; background: rgba(30, 42, 56, 0.9); border: 1px solid #5d7185; border-radius: 3px; color: #ecf0f1; cursor: pointer; font-weight: 500; height: 22px; line-height: 1;">í‘œì‹œ â–¾</button>
                    <div id="mobile-layer-menu" style="display: none; position: absolute; top: 100%; left: 0; background: rgba(30, 42, 56, 0.98); border: 1px solid #5d7185; border-radius: 4px; padding: 8px; z-index: 1002; min-width: 120px; margin-top: 4px;">
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="city" checked style="margin-right: 6px;"> ì„±ë„ì‹œ
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="placeLabel" style="margin-right: 6px;"> ì§€ëª…
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="countryLabel" checked style="margin-right: 6px;"> êµ­ê°€ëª…
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="ethnicLabel" style="margin-right: 6px;"> ë¯¼ì¡±
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="military" style="margin-right: 6px;"> êµ°ëŒ€
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="natural" style="margin-right: 6px;"> ìì—°
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="event" style="margin-right: 6px;"> ì´ë²¤íŠ¸
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="territoryPolygon" checked style="margin-right: 6px;"> ì˜í† 
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="rivers" style="margin-right: 6px;"> ê°•
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="timeline" checked style="margin-right: 6px;"> ì—°ëŒ€í‘œ
                        </label>
                        <hr style="border: 0; border-top: 1px solid #5d7185; margin: 4px 0;">
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="kingPanel" style="margin-right: 6px;"> ì™•
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="historyPanel" style="margin-right: 6px;"> ì—­ì‚¬
                        </label>
                        <label style="display: flex; align-items: center; padding: 4px 0; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" class="mobile-layer-checkbox" data-layer="eventSidebar" style="margin-right: 6px;"> ì‚¬ê±´ëª©ë¡
                        </label>
                    </div>
                </div>
                
                <!-- ğŸš© [ì´ë™] ëª¨ë°”ì¼ìš© í¸ì§‘ ë²„íŠ¼ -->
                <div id="mobile-edit-dropdown-container" style="position: relative;">
                    <button id="mobile-edit-btn" style="padding: 0 6px; font-size: 10px; background: rgba(30, 42, 56, 0.9); border: 1px solid #5d7185; border-radius: 3px; color: #ecf0f1; cursor: pointer; font-weight: 500; height: 22px; line-height: 1;">í¸ì§‘ â–¾</button>
                    <div id="mobile-edit-menu" style="display: none; position: absolute; top: 100%; left: 0; background: rgba(30, 42, 56, 0.98); border: 1px solid #5d7185; border-radius: 4px; padding: 8px; z-index: 1002; min-width: 120px; margin-top: 4px;">
                        <button id="mobile-cityEditBtn" style="display: block; width: 100%; padding: 6px; margin: 2px 0; font-size: 11px; background: transparent; border: none; color: #ecf0f1; cursor: pointer; text-align: left;">ì„±/ë„ì‹œ í¸ì§‘</button>
                        <button id="mobile-countryEditBtn" style="display: block; width: 100%; padding: 6px; margin: 2px 0; font-size: 11px; background: transparent; border: none; color: #ecf0f1; cursor: pointer; text-align: left;">êµ­ê°€ í¸ì§‘</button>
                        <button id="mobile-kingEditBtn" style="display: block; width: 100%; padding: 6px; margin: 2px 0; font-size: 11px; background: transparent; border: none; color: #ecf0f1; cursor: pointer; text-align: left;">ì™• í¸ì§‘</button>
                        <button id="mobile-eventEditBtn" style="display: block; width: 100%; padding: 6px; margin: 2px 0; font-size: 11px; background: transparent; border: none; color: #ecf0f1; cursor: pointer; text-align: left;">ì´ë²¤íŠ¸ í¸ì§‘</button>
                        <hr style="border: 0; border-top: 1px solid #5d7185; margin: 4px 0;">
                        <button id="mobile-exitEditBtn" style="display: block; width: 100%; padding: 6px; margin: 2px 0; font-size: 11px; background: transparent; border: none; color: #e74c3c; cursor: pointer; text-align: left;">í¸ì§‘ëª¨ë“œ ì¢…ë£Œ</button>
                    </div>
                </div>
            </div>
            
            <!-- PC ì „ìš© ì»¨íŠ¸ë¡¤ -->
            <span id="timeLabelDisplay-pc" style="white-space: nowrap; text-align: left; font-size: 15px; display: inline-block; font-family: 'Courier New', monospace; font-weight: 600;">
                <span id="yearLabel-pc" style="display: inline-block; text-align: right; min-width: 100px;"></span>ë…„ <span id="monthLabel-pc" style="display: inline-block; text-align: right; min-width: 20px;"></span>ì›”  <span id="ganjiLabel-pc" style="display: inline-block;"></span>
            </span>
            
            <input type="number" id="yearInput" min="-5000" max="2030" step="1" value="400" style="width:60px !important; padding: 4px; font-family: 'Courier New', monospace;" title="ìŒìˆ˜ëŠ” B.C. (ì˜ˆ: -400 = B.C. 401)">
            <input type="number" id="monthInput" min="1" max="12" step="1" value="1" style="width:40px !important; padding: 4px; font-family: 'Courier New', monospace;">
            <div class="playback-button-container">
                <button id="playBtn" class="primary" style="padding: 3px 6px; font-size: 11px;">ì¬ìƒ</button>
                <button id="pauseBtn" class="danger" style="display: none; padding: 3px 6px; font-size: 11px;">ì •ì§€</button>
            </div>
            <label for="playbackSpeedSlider" style="font-weight: normal; font-size: 12px;">ì†ë„:</label>
            <input type="range" id="playbackSpeedSlider" min="1" max="60" value="12" style="width: 60px; vertical-align: middle;">
            <span id="speedDisplay" style="vertical-align: middle; font-size: 12px;">12ì›”/ì´ˆ</span>
            
            <!-- ğŸš© [ì¶”ê°€] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ì„ ì‹œê°„ ì»¨íŠ¸ë¡¤ ì˜†ì— ë°°ì¹˜ -->
            <div id="layer-toggles" style="display: flex; align-items: center; gap: 2px; margin-left: 8px; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 8px;">
                <button type="button" class="layer-toggle-btn" data-layer="city" style="padding: 2px 4px; font-size: 10px;">ì„±ë„ì‹œ</button>
                <button type="button" class="layer-toggle-btn" data-layer="placeLabel" style="padding: 2px 4px; font-size: 10px;">ì§€ëª…</button>
                <button type="button" class="layer-toggle-btn" data-layer="countryLabel" style="padding: 2px 4px; font-size: 10px;">êµ­ê°€ëª…</button>
                <button type="button" class="layer-toggle-btn " data-layer="ethnicLabel" style="padding: 2px 4px; font-size: 10px;">ë¯¼ì¡±</button>
                <button type="button" class="layer-toggle-btn" data-layer="military" style="padding: 2px 4px; font-size: 10px;">êµ°ëŒ€</button>
                <button type="button" class="layer-toggle-btn" data-layer="natural" style="padding: 2px 4px; font-size: 10px;">ìì—°</button>
                <button type="button" class="layer-toggle-btn" data-layer="event" style="padding: 2px 4px; font-size: 10px;">ì´ë²¤íŠ¸</button>
                <button type="button" class="layer-toggle-btn" data-layer="territoryPolygon" style="padding: 2px 4px; font-size: 10px;">ì˜í† </button>
                <button type="button" class="layer-toggle-btn" data-layer="rivers" style="padding: 2px 4px; font-size: 10px;">ê°•</button>
                <button type="button" class="layer-toggle-btn" data-layer="timeline" style="padding: 2px 4px; font-size: 10px;">ì—°ëŒ€í‘œ</button>
                <button type="button" class="layer-toggle-btn" data-layer="eventSidebar" style="padding: 2px 4px; font-size: 10px;">ì‚¬ê±´ëª©ë¡</button>
            </div>
            
            <!-- ğŸš© [ì¶”ê°€] PCìš© í¸ì§‘ ë²„íŠ¼ (ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¹€) -->
            <div id="edit-dropdown-container" style="position: relative;">
                <button id="mainEditBtn" class="primary" style="padding: 6px 12px; white-space: nowrap; font-size: 13px; background: rgba(30, 42, 56, 0.95); border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">í¸ì§‘ â–¾</button>
                <div id="edit-dropdown-menu">
                    <button id="cityEditBtnDropdown" class="dropdown-item">ì„±/ë„ì‹œ í¸ì§‘</button>
                    <button id="countryEditBtnDropdown" class="dropdown-item">êµ­ê°€ í¸ì§‘</button>
                    <button id="kingEditBtnDropdown" class="dropdown-item">ì™• í¸ì§‘</button>
                    <button id="eventEditBtnDropdown" class="dropdown-item">ì´ë²¤íŠ¸ í¸ì§‘</button>
                    <button id="trashBtnDropdown" class="dropdown-item" style="color: #f39c12;">ğŸ—‘ï¸ íœ´ì§€í†µ</button>
                    <hr style="border: 0; border-top: 1px solid #5d7185; margin: 4px 0;">
                    <button id="exitEditBtnDropdown" class="dropdown-item danger">í¸ì§‘ëª¨ë“œ ì¢…ë£Œ</button>
                </div>
            </div>
            
            <!-- ğŸš© [ì¶”ê°€] PCìš© ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ë³€ê²½ ë²„íŠ¼ -->
            <button id="satellite-tile-btn-pc" class="layer-toggle-btn active" style="padding: 2px 4px; font-size: 10px;">ìœ„ì„±</button>
            <button id="normal-tile-btn-pc" class="layer-toggle-btn" style="padding: 2px 4px; font-size: 10px;">ì¼ë°˜</button>
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ìš© ìœ„ì„±/ì¼ë°˜ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨) -->
        <div id="mobile-tile-layer-control" style="display: none; position: fixed; bottom: 50px; right: 10px; z-index: 1000; gap: 2px;">
            <button id="satellite-tile-btn" class="active" style="padding: 4px 10px; font-size: 10px; background: rgba(50, 62, 76, 0.9); border: 1px solid rgba(93, 113, 133, 0.5); border-radius: 3px; color: #b0b0b0; cursor: pointer; font-weight: 500;">ìœ„ì„±</button>
            <button id="normal-tile-btn" style="padding: 4px 10px; font-size: 10px; background: rgba(50, 62, 76, 0.9); border: 1px solid rgba(93, 113, 133, 0.5); border-radius: 3px; color: #b0b0b0; cursor: pointer; font-weight: 500;">ì¼ë°˜</button>
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] í˜„ì¬ ì—°ë„ í‘œì‹œ (ì™¼ìª½ ìƒë‹¨) -->
        <div id="current-year-display" style="position: fixed; top: 10px; left: 10px; z-index: 1000; background: transparent; color: white; font-family: 'Noto Serif KR', serif; font-size: 18px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); pointer-events: none;"></div>
        
        <!-- ğŸš© [ë³µêµ¬] ì§€ë„ ìœ„ ë¯¸ë‹ˆ ì‚¬ê´€ ë­í‚¹ (5ìœ„ê¹Œì§€) -->
        <div id="rankingDisplay" style="position: fixed; bottom: 80px; right: 10px; z-index: 1000; background: rgba(10,18,30,0.45); backdrop-filter: blur(3px); border: none; border-radius: 8px; color: white; font-size: 12px; font-family: 'Noto Serif KR', serif; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); line-height: 1.6; pointer-events: auto; min-width: 160px; user-select: none;">
            <div id="rankingDisplay-header" style="padding: 5px 10px 4px; cursor: pointer; border-bottom: 1px solid rgba(241,196,15,0.15); font-weight: bold; font-size: 12px; color: #f1c40f; display: flex; align-items: center; gap: 4px;">
                ğŸ† <span>ì‚¬ê´€ ë­í‚¹</span>
            </div>
            <div id="rankingDisplay-body" style="padding: 6px 10px 8px;"></div>
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë°” ì»¨í…Œì´ë„ˆ - pointer-eventsëŠ” JSë¡œ ì œì–´ -->
        <div id="timeline-container" style="position: fixed; bottom: 45px; left: 2%; right: 2%; width: 96%; height: 20px; overflow: visible; display: block; background: transparent; z-index: 9998; pointer-events: none;">
            <!-- ì—°ë„ í‘œì‹œ (ìŠ¬ë¼ì´ë” í•¸ë“¤ ì¤‘ì•™ì— í‘œì‹œ) -->
            <div id="year-indicator" style="position: absolute; left: 50%; top: -35px; transform: translateX(-50%); background: rgba(0, 0, 0, 0.9); color: white; padding: 6px 14px; border-radius: 8px; font-size: 22px; line-height: 22px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; box-sizing: border-box; pointer-events: none; opacity: 0; transition: opacity 0.2s ease; z-index: 10001; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></div>
            <!-- ì—°ëŒ€í‘œ ë°”ë“¤ (createDynastyTimeline()ì— ì˜í•´ ë™ì  ìƒì„±) -->
        </div>
        
        <!-- ğŸš© [ìˆ˜ì •] íƒ€ì„ìŠ¬ë¼ì´ë”: í™”ë©´ ìµœí•˜ë‹¨ì— ë°°ì¹˜ (í•­ìƒ í‘œì‹œ) -->
        <div id="timeline-control" style="position: fixed; bottom: 5px; left: 2%; right: 2%; width: 96%; z-index: 9999; pointer-events: none; background: transparent; border-radius: 4px; padding: 2px;">
            <!-- ì—°ë„ í‘œì‹œ (ìŠ¬ë¼ì´ë” í•¸ë“¤ ìœ„ì— ë”°ë¼ë‹¤ë‹˜) -->
            <div id="slider-year-tooltip" style="position: absolute; background: rgba(0, 0, 0, 0.9); color: white; padding: 8px 16px; border-radius: 6px; font-size: 18px; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.2s ease; z-index: 10000; bottom: 20px; left: 50%; transform: translateX(-50%); border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px);"></div>

            <!-- ğŸš© í•œêµ­ì‚¬ ë§ˆì»¤ ë°” (ìŠ¬ë¼ì´ë” ë°”ë¡œ ìœ„ â€” ë°°ê²½ ì—†ìŒ, ì§€ë„ ìœ„ì— íˆ¬ëª…í•˜ê²Œ) -->
            <div id="slider-korea-bar" style="position: relative; width: 100%; height: 20px; pointer-events: none; margin-bottom: 1px;"></div>

            <!-- ìŠ¬ë¼ì´ë” + ëˆˆê¸ˆë°”ë§Œ ë¸”ëŸ¬ ë°°ê²½ ì ìš© -->
            <div style="background: rgba(0, 0, 0, 0.08); backdrop-filter: blur(1px); border-radius: 4px; box-shadow: 0 -1px 3px rgba(0,0,0,0.1); padding: 2px 2px 0;">
                <!-- ìŠ¬ë¼ì´ë” -->
                <input type="range" id="combinedSlider" min="-60000" max="24359" step="1" value="4800" style="width: 100%; background: transparent; cursor: pointer;">

                <!-- ëˆˆê¸ˆ + ì¤‘êµ­ì‚¬ ë§ˆì»¤ ë°” -->
                <div id="slider-ticks-bar" style="position: relative; width: 100%; height: 26px; pointer-events: none; margin-top: 1px;"></div>
            </div>
          </div>
    
          <!-- event-sidebar removed (per user request) -->

        <!-- ğŸš© [ê³¼ì œ2 êµ¬í˜„] ë¯¼ì¡±ë³„/êµ­ê°€ë³„ ì‚¬ê±´ ê·¸ë£¹í™” ì‚¬ì´ë“œë°” -->
        <div id="event-sidebar">
            <button class="sidebar-close-btn" id="close-event-sidebar" title="ë‹«ê¸°">Ã—</button>
            <h3>ğŸ“œ ì—­ì‚¬ì  ì‚¬ê±´</h3>
            <div id="event-sidebar-content">
                <!-- renderEventSidebar()ì— ì˜í•´ ë™ì  ìƒì„± -->
                <p style="color: #999; text-align: center;">ì´ë²¤íŠ¸ ë°ì´í„° ë¡œë”© ì¤‘...</p>
            </div>
        </div>
        
        <!-- ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì»¨í…Œì´ë„ˆ - ì˜µì…”ë„, í–„ë²„ê±° ë©”ë‰´ë¡œ í† ê¸€ -->
        <div id="timeline-sidebar" style="position: fixed; bottom: 40px; left: 2%; right: 2%; width: 96%; max-width: none; height: 70vh; background: rgba(10,16,26,0.82); backdrop-filter: blur(4px); border: 1px solid rgba(255,220,100,0.15); border-radius: 10px; z-index: 1000; transition: opacity 0.3s ease; opacity: 0; pointer-events: none; display: none; overflow-x: hidden; overflow-y: auto; cursor: grab; padding: 10px; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">
                <h3 style="margin: 0; font-size: 18px; color: #f5e9d2; font-family: 'Nanum Myeongjo', serif; font-weight: 700; letter-spacing: 2px;">êµ­ê°€ë³„ ì—°ëŒ€í‘œ</h3>
                <button id="close-timeline-sidebar" style="background: none; border: none; color: #ecf0f1; font-size: 18px; cursor: pointer; padding: 0;">Ã—</button>
            </div>
            <div id="timeline-content" style="color: #ddd; font-size: 13px; line-height: 1.5;">
                <!-- createDynastyTimeline()ì— ì˜í•´ ë™ì  ìƒì„± -->
            </div>
        </div>
        
        
        
        
        <!-- ğŸš© [ìˆ˜ì •] ê²€ìƒ‰ ë° í•„í„°ë¥¼ ì§€ë„ ë‚´ë¶€ í•˜ë‹¨ì— ë°°ì¹˜ (ê¸°ë³¸ ìˆ¨ê¹€) -->
        <div id="map-search-filter" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(30, 42, 56, 0.95); padding: 8px 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center;">
            
            <!-- ë¯¼ì¡± í•„í„° -->
            <div style="display: flex; align-items: center; gap: 4px;">
                <label for="mapEthnicityFilterSelect" style="font-size: 11px; white-space: nowrap; margin: 0;">ë¯¼ì¡±:</label>
                <div id="mapEthnicityContainer" style="display: flex; align-items: center; gap: 2px;">
                </div>
            </div>
            
            <!-- ê²€ìƒ‰ -->
            <div style="display: flex; align-items: center; gap: 0; position: relative;">
                <input type="text" id="mapSearchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" autocomplete="off" style="padding: 4px 6px; font-size: 11px; width: 90px; border-radius: 4px 0 0 4px;"/>
                <button id="mapSearchBtn" class="primary" style="padding: 4px 8px; font-size: 11px; border-radius: 0 4px 4px 0; border-left: none;">ê²€ìƒ‰</button>
                <div id="mapSearchResults" style="position: absolute; bottom: 100%; left: 0; right: 0; background: #3e4a56; border: 1px solid #5d7185; z-index: 1001; max-height: 250px; overflow-y: auto; display: none; font-size: 12px; margin-bottom: 4px;">
                </div>
            </div>
        </div>
        
        <!-- ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° íˆ´ë°”ë¥¼ ì§€ë„ ìš°ì¸¡ í•˜ë‹¨ì— ê°€ë¡œë¡œ ë°°ì¹˜ -->
        <div id="drawingForm" style="display:none; position: absolute !important; bottom: 10px !important; right: 10px !important; left: auto !important; top: auto !important;">
            <h3 style="margin-top: 0;">ê·¸ë¦¬ê¸° í¸ì§‘</h3>
            <form id="editDrawingForm">
                <input type="hidden" id="drawingMongoId">
                <input type="hidden" id="drawingGeoJson">
                
                <label for="drawingName">ì´ë¦„:</label>
                <input type="text" id="drawingName" required>
                
                <label for="drawingType">ìœ í˜•:</label>
                <select id="drawingType">
                    <option value="river">ê°•</option>
                    <option value="wall">ì„±ê³½</option>
                    <option value="arrow">í™”ì‚´í‘œ</option>
                    <option value="mountain">ì‚°ë§¥</option>
                    <option value="general">ì¼ë°˜ë„í˜•</option>
                </select>
                
                <label for="drawingColor">ìƒ‰ìƒ:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="color" id="drawingColor" value="#3388ff" style="width: 60px; height: 30px; border: 1px solid #5d7185; background: none; cursor: pointer;">
                    <span id="drawingColorHex" style="font-size: 12px; color: #95a5a6;">#3388ff</span>
                </div>
                
                <label for="drawingStartYear">ì‹œì‘:</label>
                <input type="number" id="drawingStartYear" required>
                
                <label for="drawingEndYear">ì¢…ë£Œ:</label>
                <input type="number" id="drawingEndYear" placeholder="ì„ íƒ">
                
                <button type="button" id="cancelDrawingBtn">ì·¨ì†Œ</button>
                <button type="button" id="deleteDrawingBtn" class="danger" style="display:none;">ì‚­ì œ</button>
                <button type="submit" id="saveDrawingBtn" class="primary">ì €ì¥</button>
            </form>
        </div>
        
        <!-- ğŸš© [ìˆ˜ì •] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ë¥¼ map div ì•ˆìœ¼ë¡œ ì´ë™ -->
        <div id="event-overlay">
            <img id="event-overlay-image" src="" style="display: none;">
            <video id="event-overlay-video" controls style="display: none; max-width: 100%; max-height: 300px;"></video>
            <span id="event-overlay-text"></span>
        </div>
      </div> 

      <!-- ğŸš© [ì¶”ê°€] ì—­ì‚¬ ë³µì› ê¸°ì—¬ í¼ -->
      <div id="contributionForm" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2c3e50; color: #ecf0f1; border: 1px solid #e67e22; padding: 20px; z-index: 100000; border-radius: 8px; width: 400px; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.7);">
          <h3 style="color: #e67e22; margin-top: 0;">ì—­ì‚¬ ì—°êµ¬ </h3>
          <p style="font-size: 12px; color: #bdc3c7; margin-bottom: 15px;">
              ì‚¬ë£Œë‚˜ ê³ ì§€ë„ë¥¼ ê·¼ê±°ë¡œ ìƒì–´ë²„ë¦° ì§€ëª…ì„ ì°¾ì•„ì£¼ì„¸ìš”.<br>
              íƒ€ë‹¹ì„±ì´ ì…ì¦ë˜ë©´ ê·€í•˜ì˜ ì´ë¦„ìœ¼ë¡œ ì§€ë„ì— ì˜êµ¬ ë“±ë¡ë©ë‹ˆë‹¤.
          </p>
          <form id="addContributionForm">
              <input type="hidden" id="contribLat">
              <input type="hidden" id="contribLng">
              <div class="form-row">
                  <label>ì§€ëª…:</label>
                  <input type="text" id="contribName" required placeholder="ì˜ˆ: ëŒ€ë™ì‹œ, í‰ì–‘ì„±">
              </div>
              <!-- ğŸš© [ì¶”ê°€] ìœ í˜• ì„ íƒ: ì„±/ë„ì‹œ vs ìì—°ì§€ë¬¼ -->
              <div class="form-row">
                  <label>ì§€ëª… ìœ í˜•:</label>
                  <select id="contribPlaceType">
                      <option value="city">ì„±/ë„ì‹œ</option>
                      <option value="natural_mountain">ìì—°ì§€ë¬¼ - ì‚°</option>
                      <option value="natural_river">ìì—°ì§€ë¬¼ - ê°•/í˜¸ìˆ˜</option>
                      <option value="natural_sea">ìì—°ì§€ë¬¼ - ë°”ë‹¤</option>
                      <option value="natural_other">ìì—°ì§€ë¬¼ - ê¸°íƒ€</option>
                  </select>
              </div>
              <!-- ğŸš© [ì¶”ê°€] ì†Œì† êµ­ê°€ (ì„±/ë„ì‹œì¼ ë•Œë§Œ í•„ìˆ˜) -->
              <div class="form-row" id="contribCountryRow">
                  <label>ì†Œì† êµ­ê°€: <span style="color:#e74c3c">*</span></label>
                  <select id="contribCountryId">
                      <option value="">-- êµ­ê°€ ì„ íƒ --</option>
                  </select>
              </div>
              <!-- ìƒˆ êµ­ê°€ ì§ì ‘ ì…ë ¥ -->
              <div class="form-row" id="contribNewCountryRow" style="display:none;">
                  <label>ìƒˆ êµ­ê°€ëª…: <span style="color:#e74c3c">*</span></label>
                  <input type="text" id="contribNewCountryName" placeholder="ì˜ˆ: ì½”ì‚´ë¼, ì•„ìœ íƒ€" style="width:100%;">
                  <small style="color:#95a5a6; margin-top:4px; display:block;">ì¡´ì¬í•˜ì§€ ì•ŠëŠ” êµ­ê°€ëŠ” ìŠ¹ì¸ ì‹œ ìë™ ë“±ë¡ë©ë‹ˆë‹¤.</small>
              </div>
              <div class="form-row" id="contribStartYearRow">
                  <label>ì‹œì‘ ì—°ë„: <span style="color:#e74c3c">*</span></label>
                  <input type="number" id="contribStartYear" placeholder="ì˜ˆ: -202, 918" min="-10000" max="2100">
              </div>
              <div class="form-row" id="contribEndYearRow">
                  <label>ì¢…ë£Œ ì—°ë„:</label>
                  <input type="number" id="contribEndYear" placeholder="í˜„ì¬ê¹Œì§€ë©´ ë¹„ì›Œë‘ì„¸ìš”" min="-10000" max="2100">
              </div>
              <div class="form-row" id="contribCapitalRow">
                  <label>ìˆ˜ë„ ì—¬ë¶€:</label>
                  <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
                      <input type="checkbox" id="contribIsCapital"> 
                  </label>
              </div>
              <div class="form-row">
                  <label>ì¦ê±° ìœ í˜•:</label>
                  <select id="contribCategory">
                      <option value="geography">ì§€í˜•/ê¸°í›„ ì¦ê±°</option>
                      <option value="oldmap">ê³ ì§€ë„ ì¦ê±°</option>
                      <option value="literature">ë¬¸í—Œ ì¦ê±°</option>
                      <option value="other">ê¸°íƒ€ ì¶”ë¡ </option>
                  </select>
              </div>
              <div class="form-row">
                  <label>ì„¤ëª…/ê·¼ê±°:</label>
                  <textarea id="contribDesc" rows="4" required placeholder="ì´ê³³ì´ í•´ë‹¹ ì§€ëª…ì´ë¼ê³  ìƒê°í•˜ëŠ” ê·¼ê±°ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
              </div>
              <div class="form-row">
                  <label>ì°¸ê³  URL:</label>
                  <input type="text" id="contribEvidence" placeholder="ì´ë¯¸ì§€ë‚˜ ê´€ë ¨ ë§í¬ (ì„ íƒ)">
              </div>
              <div class="form-actions" style="text-align: right; margin-top: 10px;">
                  <button type="button" id="cancelContribBtn">ì·¨ì†Œ</button>
                  <button type="submit" class="primary" style="background-color: #e67e22; border-color: #d35400;">ì œì¶œí•˜ê¸°</button>
              </div>
          </form>
      </div>

      <!-- ğŸš© [ì¶”ê°€] ì‚¬ê´€ ì—­ì‚¬ê¸°ë¡ ì œì¶œ í¼ -->
      <div id="historicalRecordForm" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2c3e50; color: #ecf0f1; border: 1px solid #e67e22; padding: 20px; z-index: 100000; border-radius: 8px; width: 450px; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.7);">
          <h3 style="color: #e67e22; margin-top: 0;">ğŸ“œ ì‚¬ê´€ ì—­ì‚¬ê¸°ë¡ ì œì¶œ</h3>
          <p style="font-size: 12px; color: #bdc3c7; margin-bottom: 15px;">
              ì‚¬ê´€ìœ¼ë¡œì„œì˜ ì—­ì‚¬ ì—°êµ¬ ì„±ê³¼ë¥¼ ê¸°ë¡ìœ¼ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.<br>
              ì—°ë„, ì´ë¦„, ì¶œì „, ë‚´ìš©ì„ ì •í™•íˆ ì…ë ¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
          </p>
          <form id="addHistoricalRecordForm">
              <div class="form-row">
                  <label>ì—°ë„:</label>
                  <input type="number" id="recordYear" required placeholder="ì˜ˆ: 918, -57, 1392" min="-10000" max="2100">
              </div>
              <div class="form-row">
                  <label>ì´ë¦„/ì œëª©:</label>
                  <input type="text" id="recordName" required placeholder="ì˜ˆ: íƒœì¡° ì™•ê±´ ì¦‰ìœ„, ëŒ€ëª½í•­ìŸ">
              </div>
              <div class="form-row">
                  <label>ì¶œì „:</label>
                  <input type="text" id="recordSource" required placeholder="ì˜ˆ: ê³ ë ¤ì‚¬, ì‚¼êµ­ì‚¬ê¸°, ê³ ì§€ë„">
              </div>
              <div class="form-row">
                  <label>ë‚´ìš©:</label>
                  <textarea id="recordContent" rows="6" required placeholder="ì—­ì‚¬ì  ì‚¬ì‹¤ì´ë‚˜ ê¸°ë¡ ë‚´ìš©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”."></textarea>
              </div>
              <div class="form-row">
                  <label>ì°¸ê³  URL:</label>
                  <input type="text" id="recordEvidence" placeholder="ì´ë¯¸ì§€ë‚˜ ê´€ë ¨ ë§í¬ (ì„ íƒ)">
              </div>
              <div class="form-actions" style="text-align: right; margin-top: 10px;">
                  <button type="button" id="cancelRecordBtn" onclick="document.getElementById('historicalRecordForm').style.display='none';">ì·¨ì†Œ</button>
                  <button type="submit" class="primary" style="background-color: #e67e22; border-color: #d35400;">ì œì¶œí•˜ê¸°</button>
              </div>
          </form>
      </div>
      <div id="rankInfoModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2c3e50; color: #ecf0f1; border: 2px solid #f1c40f; padding: 20px; z-index: 99999; border-radius: 12px; width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.8);">
          <h3 style="color: #f1c40f; text-align: center; margin-top: 0;">ğŸ“œ ê³ ë ¤ë§Œë¦¬ì§€ë„ ì‚¬ê´€(å²é¤¨) ì§ê¸‰ ì²´ê³„ ì•ˆë‚´</h3>
          <div style="margin-bottom: 15px; text-align: center; font-size: 14px; color: #bdc3c7; font-style: italic;">
              "ì‚¬ê´€ì˜ ë¶“ ëì—ì„œ ëŒ€ë¥™ì˜ ê°•ì—­ì´ ë˜ì‚´ì•„ë‚©ë‹ˆë‹¤."
          </div>
          <div style="font-size: 13px; line-height: 1.6;">
              <p>ê³ ë ¤ë§Œë¦¬ì§€ë„ëŠ” ã€ê³ ë ¤ì‚¬ã€, ã€ê³ ë ¤ë„ê²½ã€ ë° ê³ ì§€ë„ì™€ ì²œë¬¸ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ì™œê³¡ëœ ì—­ì‚¬ë¥¼ ë°”ë¡œì¡ëŠ” ì‚¬ê´€ë“¤ì˜ ì§‘ë‹¨ì§€ì„± ì—°êµ¬ì†Œì…ë‹ˆë‹¤. ì—¬ëŸ¬ë¶„ì˜ ëª¨ë“  ì—°êµ¬ ì„±ê³¼ëŠ” ì—„ê²©í•œ ê³ ì¦ì„ ê±°ì³ í’ˆê³„ë¡œ í™˜ì‚°ë©ë‹ˆë‹¤.</p>

              <h4 style="color: #f1c40f;">ğŸ›ï¸ ì‚¬ê´€ì˜ í’ˆê³„ì™€ ì§„ê¸‰</h4>
              <h5>1. ì¬ìƒê¸‰ (ê²½ìŸ ì„ëª… - ë‹¨ 1ëª…ì”©)</h5>
              <p>í•™ë¬¸ì  ì„±ì·¨ê°€ ê°€ì¥ ë†’ì€ 4ì¸ì€ ê³ ë ¤ ì¡°ì •ì˜ ìµœê³  ì§€ë„ë¶€ê°€ ë©ë‹ˆë‹¤.</p>
              <ul>
                  <li><strong>ì •1í’ˆ ê°ìˆ˜êµ­ì‚¬(ç›£ä¿®åœ‹å²) (5,000P+ | 1ìœ„)</strong>: ëŒ€ë¥™ ê³ ë ¤ ë³µì› ì‚¬ì—… ì´ê´„. ì—­ì‚¬ ë³µì› ì •ì±… ìµœì¢… ê²°ì •ê¶Œ.</li>
                  <li><strong>ì¢…1í’ˆ íŒì‚¬ê´€ì‚¬(åˆ¤å²é¤¨äº‹) (4,300P+ | 2ìœ„)</strong>: ì‚¬ì´ˆ(å²è‰) ìµœì¢… ìˆ˜í˜¸ì. ì „ì²´ ë°ì´í„° ìˆ˜ì • ë° ì•„ì¹´ì´ë¹™ ê´€ë¦¬ê¶Œ.</li>
                  <li><strong>ì •2í’ˆ ìˆ˜êµ­ì‚¬(ä¿®åœ‹å²) (3,700P+ | 3ìœ„)</strong>: ë³´ê³ ì„œ ìµœì¢… ìŠ¹ì¸ê¶Œ. ìŠ¹ì¸ëœ ì—°êµ¬ëŠ” ì§€ë„ ìœ„ 'ê³µì‹ ê°•ì—­'ìœ¼ë¡œ í™•ì •.</li>
                  <li><strong>ì¢…2í’ˆ ë™ìˆ˜êµ­ì‚¬(åŒä¿®åœ‹å²) (3,100P+ | 4ìœ„)</strong>: ê¶Œì—­ë³„(ì‚°ë™, ê°•ë‚¨, ëŒ€ë™ ë“±) ì—°êµ¬ ì±…ì„ ë° 2ì°¨ ê²€ì¦ ì´ê´„.</li>
              </ul>

              <h5>2. ì¤‘ê²¬ ë° ê³ ìœ„ í•™ê´€ (ìë™ ì§„ê¸‰)</h5>
              <p>ì‹¤ë¬´ ì—°êµ¬ì™€ ê³ ì¦ì„ ì£¼ë„í•˜ëŠ” ì „ë¬¸ í•™ì ì¸µì…ë‹ˆë‹¤.</p>
              <ul>
                  <li><strong>ì •3í’ˆ ìˆ˜ì°¬ê´€(ä¿®æ’°å®˜) ~ ì¢…3í’ˆ ì§ìˆ˜ì°¬ê´€(ç›´ä¿®æ’°å®˜)</strong>: êµ­ê°€ ê³µì¸ ê³ ì¦ ìœ„ì›. ì£¼ìš” ë…¼ìŸ ì§€ì—­ì˜ í•™ìˆ  ì‹¬ì˜ ë‹´ë‹¹.</li>
                  <li><strong>ì •4í’ˆ ì‚¬ê´€ìˆ˜ì°¬(å²é¤¨ä¿®æ’°) ~ ì¢…4í’ˆ ì‹œê°•í•™ì‚¬(ä¾è¬›å­¸å£«)</strong>: ë³´ê³ ì„œ 1ì°¨ ê²€í† ê¶Œ. ì²œë¬¸ í˜„ìƒê³¼ ì§€ëª… ì¢Œí‘œì˜ ì¼ì¹˜ì„± ê²€ì¦.</li>
                  <li><strong>ì •5í’ˆ ê¸°ê±°ì£¼(èµ·å±…æ³¨) / ë‚­ì¤‘(éƒä¸­) ~ ì¢…6í’ˆ ê¸°ê±°ë„ìœ„(èµ·å±…éƒ½å°‰)</strong>: ì¤‘ê²¬ ì—°êµ¬ì›. ëŒ€ë¥™ ì§€í‘œì™€ ì‚¬ì„œ ê¸°ë¡ì˜ ëŒ€ì¡° ì—°êµ¬ ìˆ˜í–‰.</li>
              </ul>

              <h5>3. í•˜ê¸‰ ì‚¬ê´€ ë° ìˆ˜ìŠµ (í™œë™ ê¸°ë°˜)</h5>
              <p>ê¸°ì´ˆ ì‚¬ë£Œë¥¼ ë°œêµ´í•˜ê³  ê¸°ë¡ì˜ ì´ˆì•ˆì„ ì‘ì„±í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.</p>
              <ul>
                  <li><strong>ì •7í’ˆ ìˆ˜ì°¬(ä¿®æ’°) ~ ì •9í’ˆ ì •ì(æ­£å­—)</strong>: ì§€ì—­ë³„ ì‚¬ë£Œ ìˆ˜ì§‘ ë° í˜„ì¥ ì§€í˜• ì—°êµ¬ ë³´ê³ ì„œ ì‘ì„±.</li>
                  <li><strong>ì¢…9í’ˆ ìˆ˜ë¶„ê¶Œì§€(ä¿®åˆ†æ¬ŠçŸ¥)</strong>: ì´ì œ ë§‰ ì—°êµ¬ì— í•©ë¥˜í•œ ìˆ˜ìŠµ ì‚¬ê´€.</li>
              </ul>

              <h4 style="color: #f1c40f;">ğŸ“œ ì—°êµ¬ ì ìˆ˜(P) ì‚°ì • ê¸°ì¤€</h4>
              <ul>
                  <li><strong>ì—­ì‚¬ì—°êµ¬ ë³´ê³ ì„œ ì œì¶œ</strong>: 3P (ì‚¬ë£Œ, ì§€ë„, ì²œë¬¸ ê¸°ë¡ ë“± ê¸°ì´ˆ ì—°êµ¬ ìƒì£¼)</li>
                  <li><strong>ë³´ê³ ì„œ ìµœì¢… ìŠ¹ì¸</strong>: 10P (ë™ìˆ˜êµ­ì‚¬(åŒä¿®åœ‹å²) ì´ìƒì˜ ê²€ì¦ì„ í†µí•´ ì—­ì‚¬ì  ì‚¬ì‹¤ë¡œ í™•ì • ì‹œ)</li>
                  <li><strong>ë™ë£Œ ì‚¬ê´€ì˜ ì§€ì§€</strong>: 1P (ì—°êµ¬ ë‚´ìš©ì— ëŒ€í•œ í•™ìˆ ì  ì¶”ì²œ ë° ê³µê°, ì¼ì¼ ìµœëŒ€ 10íšŒ)</li>
                  <li><strong>ë³´ê³ ì„œ ê²€í†  (ì‹œê°•í•™ì‚¬(ä¾è¬›å­¸å£«) ì´ìƒ)</strong>: 5P (í•˜ê¸‰ì ë³´ê³ ì„œ ê²€í†  ë° ìŠ¹ì¸ ê¶Œê³ )</li>
                  <li><strong>ë² ìŠ¤íŠ¸ ê³ ì¦ ì„ ì • (ì§ìˆ˜ì°¬ê´€(ç›´ä¿®æ’°å®˜) ì´ìƒ)</strong>: 50P (ì£¼ê°„ ë² ìŠ¤íŠ¸ ê³ ì¦ìœ¼ë¡œ ì„ ì • ì‹œ)</li>
              </ul>

              <h4 style="color: #f1c40f;">ğŸ›¡ï¸ ì‚¬ê´€ì˜ ìë¶€ì‹¬</h4>
              <ul>
                  <li><strong>ì—­ì‚¬ì˜ ì‹¤ì²´ ë³µì›</strong>: ì—¬ëŸ¬ë¶„ì˜ ë³´ê³ ì„œ í•œ ì¥ì´ í•œë°˜ë„ì— ê°‡í˜”ë˜ ê³ ë ¤ë¥¼ ê´‘í™œí•œ ëŒ€ë¥™ì˜ ì£¼ì¸ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.</li>
                  <li><strong>ë…ìì  ì‚¬ê´€ ì •ë¦½</strong>: ì™œê³¡ëœ ì‹ë¯¼ ì‚¬ê´€ì„ ë°°ê²©í•˜ê³ , ì²œë¬¸ê³¼ ì§€ë¦¬ë¼ëŠ” ê³¼í•™ì  ê·¼ê±°ë¡œ ì—­ì‚¬ë¥¼ ë‹¤ì‹œ ì”ë‹ˆë‹¤.</li>
                  <li><strong>ë¶ˆë©¸ì˜ ì´ë¦„</strong>: ìµœê³ ìœ„ ì‚¬ê´€ì˜ ì—°êµ¬ ì—…ì ì€ ë³µì›ëœ <strong>'ëŒ€ë¥™ ê³ ë ¤ ì „ë„'</strong>ì˜ ëª…ì˜ˆì˜ ì „ë‹¹ì— ì˜êµ¬íˆ í—Œì•¡ë©ë‹ˆë‹¤.</li>
              </ul>

              <p style="font-style: italic; text-align: center; margin: 20px 0;">"ê¸°ë¡ë˜ì§€ ì•Šì€ ì—­ì‚¬ëŠ” ì‚¬ë¼ì§€ì§€ë§Œ, ì‚¬ê´€ì´ ì¦ëª…í•œ ê°•ì—­ì€ ì˜ì›í•©ë‹ˆë‹¤." ì§€ê¸ˆ ë°”ë¡œ ëŒ€ë¥™ì˜ ì§€ëª…ê³¼ ì²œë¬¸ì˜ ê¶¤ì ì„ ë‹´ì€ ì²« ë²ˆì§¸ ì—°êµ¬ ë³´ê³ ì„œë¥¼ ì œì¶œí•˜ì‹­ì‹œì˜¤.</p>

              <h4 style="color: #f1c40f;">ğŸ–ï¸ ì‚¬ê´€ì˜ ê³µì ì„ ìŒ“ëŠ” ë²• (Ways to Contribute)</h4>
              <p>ë‹¨ìˆœí•œ ë°ì´í„° ì…ë ¥ì´ ì•„ë‹Œ, ì‚¬ë£Œë¥¼ ì…ì¦í•˜ê³  ë…¼ë¦¬ë¥¼ ì„¸ìš°ëŠ” ê³¼ì •ì´ ëª¨ë‘ ê³µì (Point)ì´ ë©ë‹ˆë‹¤.</p>

              <h5>1. ì—­ì‚¬ì—°êµ¬ ë³´ê³ ì„œ ìƒì£¼ (ì‚¬ë£Œ ì œì¶œ) - 3P</h5>
              <ul>
                  <li><strong>ì§€ëª… ê³ ì¦</strong>: ê³ ì§€ë„ì™€ í˜„ì¬ì˜ ëŒ€ë¥™ ì§€í˜•ì„ ëŒ€ì¡°í•˜ì—¬ ê³ ë ¤ì˜ ì„±ê³½, ê°•, ì‚°ì˜ ìœ„ì¹˜ë¥¼ ë³´ê³ í•©ë‹ˆë‹¤.</li>
                  <li><strong>ì²œë¬¸ ê¸°ë¡ ëŒ€ì¡°</strong>: ã€ê³ ë ¤ì‚¬ã€ ì²œë¬¸ì§€ì— ê¸°ë¡ëœ ì¼ì‹, ì˜¤ì„±ì·¨ë£¨ í˜„ìƒì´ ì‹¤ì œ ëŒ€ë¥™ íŠ¹ì • ì¢Œí‘œì—ì„œ ê´€ì¸¡ë¨ì„ ê³¼í•™ì ìœ¼ë¡œ ì¦ëª…í•©ë‹ˆë‹¤.</li>
                  <li><strong>ë¬¸ë¬¼ ì…ì¦</strong>: ì‚¬ì„œ ì†ì˜ ì›ìˆ­ì´, ë‚™íƒ€, ê¸ˆ, ë¹„ë‹¨ ë“± ëŒ€ë¥™ì  ì‚°ë¬¼ì— ëŒ€í•œ ê¸°ë¡ì„ ê·¼ê±°ë¡œ ê°•ì—­ì˜ ë²”ìœ„ë¥¼ ë…¼ì¦í•©ë‹ˆë‹¤.</li>
              </ul>

              <h5>2. ì—°êµ¬ ë³´ê³ ì„œ ìµœì¢… ìŠ¹ì¸ (ê³ ì¦ ì„±ê³µ) - 10P</h5>
              <ul>
                  <li><strong>ì¬ìƒì˜ ì¬ê°€</strong>: ì œì¶œí•œ ë³´ê³ ì„œê°€ ë™ìˆ˜êµ­ì‚¬(åŒä¿®åœ‹å²)(ì¢…2í’ˆ) ì´ìƒì˜ ì •ë°€ ê²€ì¦ì„ ê±°ì³ 'ì—­ì‚¬ì  ì‚¬ì‹¤'ë¡œ ì¸ì •ë°›ìœ¼ë©´ í° ê³µì ì„ ì–»ìŠµë‹ˆë‹¤.</li>
                  <li><strong>ê°•ì—­ í™•ì •</strong>: ìŠ¹ì¸ëœ ë³´ê³ ì„œ ì†ì˜ ì§€ëª…ì€ 'ê³ ë ¤ë§Œë¦¬ì§€ë„'ì˜ ê³µì‹ ì§€ëª…ìœ¼ë¡œ í™•ì •ë˜ì–´ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê³µê°œë©ë‹ˆë‹¤.</li>
              </ul>

              <h5>3. ë™ë£Œ ì‚¬ê´€ì˜ í•™ìˆ  ì§€ì§€ (ì¶”ì²œ) - 1P</h5>
              <ul>
                  <li><strong>í•™ìˆ ì  ê³µê°</strong>: ë‹¤ë¥¸ ì‚¬ê´€ë“¤ì´ ì—¬ëŸ¬ë¶„ì˜ ê³ ì¦ ë…¼ë¦¬ì— ì°¬ë™í•˜ì—¬ 'ì§€ì§€(ì¶”ì²œ)'ë¥¼ ë³´ë‚¼ ë•Œë§ˆë‹¤ ê³µì ì´ ìŒ“ì…ë‹ˆë‹¤.</li>
                  <li><strong>ì¼ì¼ ì œí•œ</strong>: í•œ ì‚¬ê´€ë‹¹ ì¼ì¼ ìµœëŒ€ 10íšŒì˜ ì¶”ì²œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
              </ul>

              <h5>4. ë³´ê³ ì„œ ê²€í†  (ì‹œê°•í•™ì‚¬(ä¾è¬›å­¸å£«) ì´ìƒ) - 5P</h5>
              <ul>
                  <li><strong>í•™ìˆ ì  ë¬¸ì§€ê¸°</strong>: ì‹œê°•í•™ì‚¬(ä¾è¬›å­¸å£«) ì´ìƒì˜ ì‚¬ê´€ì´ í•˜ê¸‰ìì˜ ë³´ê³ ì„œë¥¼ ê²€í† í•˜ê³  ìŠ¹ì¸ ê¶Œê³ ë¥¼ ë‚´ë¦½ë‹ˆë‹¤.</li>
                  <li><strong>ìƒìƒ ì‹œìŠ¤í…œ</strong>: ê²€í† ìê°€ ìŠ¹ì¸ ê¶Œê³ í•œ ë³´ê³ ì„œê°€ ìµœì¢… ìŠ¹ì¸ë˜ë©´ ê²€í† ìì—ê²Œë„ 5ì ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.</li>
                  <li><strong>ì½”ì¹­ ì—­í• </strong>: ë‹¨ìˆœ ê°ì‹œê°€ ì•„ë‹Œ ë” ì •êµí•œ ë³´ê³ ì„œ ì‘ì„±ì„ ìœ„í•œ ì§€ë„ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
              </ul>

              <h5>5. ë² ìŠ¤íŠ¸ ê³ ì¦ ì„ ì • ì´ë²¤íŠ¸ - 50P</h5>
              <ul>
                  <li><strong>ì£¼ê°„ ë² ìŠ¤íŠ¸</strong>: ì§ìˆ˜ì°¬ê´€(ç›´ä¿®æ’°å®˜) ì´ìƒì˜ ì‹¬ì‚¬ë¥¼ í†µí•´ ì„ ì •ë˜ëŠ” ìµœê³ ì˜ ê³ ì¦ì…ë‹ˆë‹¤.</li>
                  <li><strong>í”„ë¡œì íŠ¸ì„± ê³µì </strong>: ì™¸êµ ê³ ì¦ì´ë‚˜ í•™ìˆ  ì‹¬ì˜ ë“± ëŒ€ê·œëª¨ ì—°êµ¬ì— ëŒ€í•œ ë³´ìƒì…ë‹ˆë‹¤.</li>
              </ul>
              </ul>

              <h4 style="color: #f1c40f;">ğŸ›ï¸ ğŸ“œ ê³ ë ¤ ì‚¬ê´€(å²é¤¨) í†µí•© 18ë‹¨ê³„ ì§ê¸‰í‘œ</h4>
              <h5>[ì¬ìƒê¸‰: ê²½ìŸ ì„ëª…ì œ (ì •1í’ˆ~ì¢…2í’ˆ)]</h5>
              <p>ìµœê³ ì˜ ê³ ì¦ ì‹¤ë ¥ì„ ê°–ì¶˜ ë‹¨ 4ì¸ì—ê²Œë§Œ í—ˆë½ë˜ëŠ” ì§€ê³ í•œ ì§ìœ„ì…ë‹ˆë‹¤.</p>
              <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin: 10px 0;">
                  <thead>
                      <tr style="background: #34495e;">
                          <th style="border: 1px solid #5d7185; padding: 5px;">êµ¬ë¶„</th>                        
                          <th style="border: 1px solid #5d7185; padding: 5px;">í’ˆê³„</th>
                          <th style="border: 1px solid #5d7185; padding: 5px;">ì§ê¸‰ëª…</th>
                          <th style="border: 1px solid #5d7185; padding: 5px;">ì„ëª… ì¡°ê±´</th>
                          <th style="border: 1px solid #5d7185; padding: 5px;">ë¹„ê³  ë° ì—­í• </th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •1í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ê°ìˆ˜êµ­ì‚¬(ç›£ä¿®åœ‹å²)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">1ìœ„ + 5,000ì </td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì‹œì¤‘(ä¾ì¤‘) ê²¸ì„. ì‚¬ê´€ì˜ ìµœê³  ìˆ˜ì¥</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…1í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">íŒì‚¬ê´€ì‚¬(åˆ¤å²é¤¨äº‹)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">2ìœ„ + 4,300ì </td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">êµ­ê°€ì˜ ëŒ€ì‚¬(å¤§äº‹) ê¸°ë¡ ìµœì¢… ìŠ¹ì¸</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •2í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ìˆ˜êµ­ì‚¬(ä¿®åœ‹å²)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">3ìœ„ + 3,700ì </td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">í‰ì¥ì‚¬ ë“± ê²¸ì„. ì‹¤ë¡ í¸ì°¬ ì´ê´„</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…2í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ë™ìˆ˜êµ­ì‚¬(åŒä¿®åœ‹å²)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">4ìœ„ + 3,100ì </td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •ë‹¹ë¬¸í•™, ì°¸ì§€ì •ì‚¬ ë“± ê²¸ì„</td>
                      </tr>
                  </tbody>
              </table>

              <h5>[ìƒê¸‰~í•˜ê¸‰ ì‚¬ê´€: ìë™ ì§„ê¸‰ì œ (ì •3í’ˆ~ì¢…9í’ˆ)]</h5>
              <p>ì¼ì • ê³µì ì„ ìŒ“ìœ¼ë©´ ê·¸ ì „ë¬¸ì„±ì„ ì¸ì •ë°›ì•„ ìë™ìœ¼ë¡œ í’ˆê³„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</p>
              <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin: 10px 0;">
                  <thead>
                      <tr style="background: #34495e;">
                          <th style="border: 1px solid #5d7185; padding: 5px;">êµ¬ë¶„</th>
                          <th style="border: 1px solid #5d7185; padding: 5px;">í’ˆê³„</th>
                          <th style="border: 1px solid #5d7185; padding: 5px;">ì§ê¸‰ëª…</th>
                          <th style="border: 1px solid #5d7185; padding: 5px;">ëˆ„ì  ê³µì </th>
                          <th style="border: 1px solid #5d7185; padding: 5px;">ë¹„ê³  ë° ì—­í• </th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ìƒê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •3í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ìˆ˜ì°¬ê´€(ä¿®æ’°å®˜)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">2,600</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">í•œë¦¼í•™ì‚¬ ìŠ¹ì§€ ë“± ê²¸ì„. ê¸°ë¡ ê²€í†  ë° êµì •</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ìƒê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…3í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì§ìˆ˜ì°¬ê´€(ç›´ä¿®æ’°å®˜)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">2,100</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢ŒÂ·ìš°ì‚°ê¸°ìƒì‹œ ë“± ê²¸ì„</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ìƒê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •4í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì‚¬ê´€ìˆ˜ì°¬(å²é¤¨ä¿®æ’°)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">1,700</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¤‘ì„œë¬¸í•˜ì„± ê³ ìœ„ ê´€ì› ê²¸ì„</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ìƒê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…4í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì‹œê°•í•™ì‚¬(ä¾è¬›å­¸å£«)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">1,400</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì™•ì˜ ê³ì—ì„œ ì—­ì‚¬ì  ì‚¬ë¡€ë¥¼ ê°•ë¡ í•˜ë©° ê¸°ë¡</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¤‘ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •5í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ê¸°ê±°ì£¼(èµ·å±…æ³¨) / ë‚­ì¤‘(éƒä¸­)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">1,100</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì™•ì˜ ì–¸í–‰ ë°€ì°© ê¸°ë¡ (ê°€ì¥ í•µì‹¬ì ì¸ ì‚¬ê´€)</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¤‘ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…5í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ê¸°ê±°ì‚¬(èµ·å±…èˆ) / ì›ì™¸ë‘(å“¡å¤–éƒ)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">850</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ê¸°ë¡ ì´ˆì•ˆ ì‘ì„± ë° í–‰ì • ì‹¤ë¬´</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¤‘ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •6í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ê¸°ê±°ë‘(èµ·å±…éƒ) / ì§ì‚¬ê´€(ç›´å²é¤¨)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">650</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì‚¬ì´ˆ(å²è‰) ì‘ì„±ì˜ ì‹¤ë¬´ ì£¼ì—­</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¤‘ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…6í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ê¸°ê±°ë„ìœ„(èµ·å±…éƒ½å°‰)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">450</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">êµ­ì™•ì˜ í–‰ì°¨ ë° ëŒ€ì™¸ í™œë™ ê¸°ë¡</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">í•˜ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •7í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ìˆ˜ì°¬(ä¿®æ’°)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">300</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">í•œë¦¼ì› ë“± ì‹¤ë¬´ ì‚¬ê´€</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">í•˜ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…7í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì§ë¬¸í•œ(ç›´æ–‡ç¿°)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">200</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ë¬¸ì¥ê³¼ ê¸°ë¡ì˜ ê¸°ì´ˆ ì •ë¹„</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">í•˜ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •8í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì£¼ì„œ(æ³¨æ›¸)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">120</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">íšŒì˜ ê¸°ë¡ ë° ì‚¬ë³¸ ê´€ë¦¬</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">í•˜ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…8í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ê²€ì—´(æª¢é–±)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">60</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ê¸°ë¡ë¬¼ì˜ ì˜¤íƒˆì ë° ì‚¬ì‹¤ê´€ê³„ 1ì°¨ í™•ì¸</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">í•˜ê¸‰</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •9í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì •ì(æ­£å­—)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">30</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">êµì„œê´€ ë“±ì—ì„œ ë¬¸í—Œ ë³´ê´€ ë° ì •ë¦¬</td>
                      </tr>
                      <tr>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì…ë¬¸</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì¢…9í’ˆ</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ìˆ˜ë¶„ê¶Œì§€(ä¿®åˆ†æ¬ŠçŸ¥)</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">0</td>
                          <td style="border: 1px solid #5d7185; padding: 5px;">ì‹¤ë¬´ ìˆ˜ìŠµ ë° ê¸°ë¡ ë³´ì¡° (ì…ë¬¸)</td>
                      </tr>
                  </tbody>
              </table>

              <h4 style="color: #f1c40f;">ğŸ’¡ ì‚¬ê´€ì„ ìœ„í•œ ë„ì›€ë§</h4>
              <p>ê³µì ì€ ë§¤ì¼ ì •ì‚°ë©ë‹ˆë‹¤: íŠ¹íˆ ì¬ìƒê¸‰ ê´€ì§ì€ ì‹¤ì‹œê°„ ì ìˆ˜ ê²½ìŸì— ë”°ë¼ ë§¤ì¼ ì•„ì¹¨ ì¡°ì •ë  ìˆ˜ ìˆìœ¼ë‹ˆ, ê°ìˆ˜êµ­ì‚¬(ç›£ä¿®åœ‹å²) ìë¦¬ë¥¼ ì§€í‚¤ê¸° ìœ„í•´ ëŠì„ì—†ì´ ëŒ€ë¥™ì˜ ì‚¬ë£Œë¥¼ íƒêµ¬í•˜ì‹­ì‹œì˜¤.</p>
              <p>í—ˆìœ„ ë³´ê³  ì£¼ì˜: ê·¼ê±° ì—†ëŠ” ì •ë³´ë¥¼ ë°˜ë³µì ìœ¼ë¡œ ì œì¶œí•  ê²½ìš°, <strong>ì¢ŒÂ·ìš°ì‚¬ê°„(ì •6í’ˆ)</strong>ì˜ ë¹„íŒì„ ë°›ì•„ ê³µì ì´ ì‚­ê°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

              <h4 style="color: #f1c40f;">ğŸ¯ ê°ìˆ˜êµ­ì‚¬(ç›£ä¿®åœ‹å²)(5,000ì )ê¹Œì§€ì˜ ì„±ì¥ ì—¬ì •</h4>
              <ul>
                  <li><strong>ì…ë¬¸~ì¤‘ê²¬ êµ¬ê°„ (0~1,400ì )</strong>: ì£¼ë¡œ ì‚¬ë£Œ ì œì¶œ(3ì )ê³¼ í•™ìŠµì— ì§‘ì¤‘í•˜ëŠ” ì„±ì‹¤í•¨ì˜ êµ¬ê°„ì…ë‹ˆë‹¤. ê¸°ì´ˆ ê³ ì¦ ëŠ¥ë ¥ì„ í‚¤ìš°ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.</li>
                  <li><strong>ì¤‘ê²¬~ê³ ìœ„ êµ¬ê°„ (1,400~2,600ì )</strong>: ìˆ˜ì°¬ê´€(ì¢…4í’ˆ)ì´ ëœ ì‹œì ë¶€í„° ê²€í†  ì ìˆ˜(5ì )ê°€ ì¶”ê°€ë˜ì–´ ì ìˆ˜ íšë“ ì†ë„ê°€ 1.5ë°° ë¹¨ë¼ì§‘ë‹ˆë‹¤. í•™ìˆ ì  ë¬¸ì§€ê¸° ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
                  <li><strong>ê³ ìœ„~ìµœì¢… êµ¬ê°„ (2,600~5,000ì )</strong>: ìƒì„œ, í•œë¦¼í•™ì‚¬ë¡œì„œ ì™¸êµ ê³ ì¦ì´ë‚˜ í•™ìˆ  ì‹¬ì˜ ë“± í”„ë¡œì íŠ¸ì„± ê³µì (50ì )ì„ í†µí•´ ìˆ˜ë°± ì  ë‹¨ìœ„ì˜ ì ìˆ˜ë¥¼ ì–»ì„ ê¸°íšŒë¥¼ ê°€ì§‘ë‹ˆë‹¤.</li>
              </ul>

              <h4 style="color: #f1c40f;">ğŸ”„ ê²€í†  ê¶Œí•œì˜ ì „ëµì  í™œìš©</h4>
              <p>ì‹œê°•í•™ì‚¬(ä¾è¬›å­¸å£«)ë¶€í„°ëŠ” ì§ì ‘ ì‚¬ë£Œë¥¼ ì°¾ëŠ” ê²ƒë³´ë‹¤ í•˜ê¸‰ ì‚¬ê´€ë“¤ì˜ ê¸°ì´ˆ ë°ì´í„°ë¥¼ ë‹¤ë“¬ì–´ ìŠ¹ì¸ ê°€ëŠ¥í•œ ìˆ˜ì¤€ìœ¼ë¡œ ëŒì–´ì˜¬ë¦¬ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì…ë‹ˆë‹¤. ê²€í†  í–‰ìœ„ ìì²´ì— 5ì ì˜ ë³´ìƒì´ ì£¼ì–´ì§€ë©°, ìŠ¹ì¸ ê¶Œê³ ê°€ ìµœì¢… ìŠ¹ì¸ë˜ë©´ ì¶”ê°€ ì ìˆ˜ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

              <div style="text-align: center; margin-top: 20px;">
                  <button type="button" id="closeRankInfoBtn" style="background: #8e44ad; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ë‹«ê¸°</button>
              </div>
          </div>
      </div>

      <!-- ğŸ—‘ï¸ íœ´ì§€í†µ ëª¨ë‹¬ -->
      <div id="trashModal" style="display:none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2c3e50; color: #ecf0f1; border: 2px solid #f39c12; padding: 20px; z-index: 2002; border-radius: 12px; width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.8);">
          <h3 style="color: #f39c12; text-align: center; margin-top: 0;">ğŸ—‘ï¸ íœ´ì§€í†µ</h3>
          <div style="margin-bottom: 15px; text-align: center; font-size: 14px; color: #bdc3c7;">
              ì‚­ì œëœ ì„±/ì „ì¥ ì •ë³´ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
          </div>

          <div id="trashContent" style="margin-bottom: 20px;">
              <div style="text-align: center; color: #95a5a6; padding: 40px;">
                  íœ´ì§€í†µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
              </div>
          </div>

          <div style="text-align: center; margin-top: 20px;">
              <button type="button" id="closeTrashBtn" style="background: #8e44ad; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ë‹«ê¸°</button>
          </div>
      </div>

      </div>
    <!-- ğŸš© [ì¶”ê°€] ì˜¤ë¥¸ìª½ íŒ¨ë„ í¬ê¸° ì¡°ì ˆì„ ìœ„í•œ ë¦¬ì‚¬ì´ì € í•¸ë“¤ -->
    <div id="resizer"></div>

  </div> <!-- mainContainer ì¢…ë£Œ -->

    <!-- ğŸš© [ì´ë™] ì™• íŒ¨ë„ & ì—­ì‚¬ íŒ¨ë„: #map(filter ì ìš©) ë°–ìœ¼ë¡œ ì´ë™ â†’ position:fixed ì •ìƒ ë™ì‘ -->
    <!-- ğŸš© ì™• ëª©ë¡ íˆ¬ëª… ë°•ìŠ¤ (ì§€ë„ ì™¼ìª½ í•˜ë‹¨, í™•ëŒ€ì¶•ì†Œ ë²„íŠ¼ ìœ„) -->
    <div id="map-king-panel" style="position: fixed; bottom: 80px; left: 10px; width: 370px; max-height: 30vh; z-index: 998; background: rgba(30, 42, 56, 0.40); backdrop-filter: blur(3px); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); overflow-y: auto; pointer-events: auto; display: none;">
        <div id="map-king-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 8px; cursor: grab; user-select: none;">
            <h3 style="margin: 0; font-size: 14px; color: #f5e9d2;">â ¿ êµ­ê°€ë³„ ì™• ëª©ë¡</h3>
            <div style="display: flex; gap: 4px; align-items: center; flex-shrink: 0;">
                <button id="map-king-toggle-btn" title="íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°" style="padding: 2px 6px; font-size: 11px; width: 28px; min-width: 28px;">â—†</button>
                <button id="map-king-close-btn" title="ë‹«ê¸°" style="padding: 0; font-size: 13px; width: 22px; height: 22px; min-width: 22px; line-height: 1; display: flex; align-items: center; justify-content: center; background: rgba(180,60,60,0.7); border: 1px solid rgba(255,100,100,0.5); border-radius: 4px; color: #fff; cursor: pointer;">âœ•</button>
            </div>
        </div>
        <div id="map-king-list" style="font-size: 12px; line-height: 1.6; color: #ddd;">
            í•´ë‹¹ ì—°ë„ ì™• ì •ë³´ ì—†ìŒ
        </div>
    </div>

    <!-- ğŸš© ì—­ì‚¬ ê¸°ë¡ íˆ¬ëª… ë°•ìŠ¤ (ìš°ì¸¡ ìƒë‹¨ ê³ ì •) -->
    <div id="map-history-panel" class="expanded" style="position: fixed; top: 270px; right: 10px; width: 320px; max-height: calc(100vh - 350px); z-index: 1000; background: rgba(30, 42, 56, 0.40); backdrop-filter: blur(3px); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); overflow-y: auto; pointer-events: auto; display: none;">
        <!-- í¬ê¸° ì¡°ì ˆ í•¸ë“¤ (ì™¼ìª½ ê°€ì¥ìë¦¬) -->
        <div id="map-history-resizer" style="position: absolute; left: 0; top: 0; bottom: 0; width: 8px; cursor: ew-resize; z-index: 1001; background: rgba(255, 255, 255, 0.1);"></div>
        <!-- ë“œë˜ê·¸ í•¸ë“¤ í—¤ë” -->
        <div id="map-history-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; cursor: grab; user-select: none;">
            <span style="font-size: 13px; font-weight: bold; color: #f5e9d2;">â ¿ ì—­ì‚¬ ê¸°ë¡</span>
            <div style="display: flex; gap: 4px; flex-shrink: 0; align-items: center;">
                <button id="map-prev-history-btn" title="ì´ì „ ê¸°ë¡" style="padding: 2px 6px; font-size: 11px; width: 28px; min-width: 28px;">â—€</button>
                <button id="map-next-history-btn" title="ë‹¤ìŒ ê¸°ë¡" style="padding: 2px 6px; font-size: 11px; width: 28px; min-width: 28px;">â–¶</button>
                <button id="map-history-close-btn" title="ë‹«ê¸°" style="padding: 0; font-size: 13px; width: 22px; height: 22px; min-width: 22px; line-height: 1; display: flex; align-items: center; justify-content: center; background: rgba(180,60,60,0.7); border: 1px solid rgba(255,100,100,0.5); border-radius: 4px; color: #fff; cursor: pointer;">âœ•</button>
            </div>
        </div>
        <!-- ì—°ë„ ì œëª© -->
        <div style="margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 8px;">
            <h3 style="margin: 0; font-size: 13px; color: #f5e9d2; word-wrap: break-word; white-space: normal;"><span id="map-history-year-title"></span></h3>
        </div>
        <div id="map-history-records" style="font-size: 12px; line-height: 1.5; color: #ddd;">
            <div id="map-all-records">
                <div id="map-all-records-content">ê¸°ë¡ ì—†ìŒ</div>
            </div>
        </div>
    </div>

    <div id="castleForm" style="display:none;">
        <h3>ìƒˆë¡œìš´ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€/í¸ì§‘</h3> <form id="addCastleForm"><input type="hidden" id="castleKey"><div class="form-row"><label>ë§ˆì»¤ íƒ€ì…:</label><div id="markerTypeSelector" class="marker-type-selector"><button type="button" data-type="normal" class="active">ì„±/ë„ì‹œ</button><button type="button" data-type="military">êµ°ëŒ€</button><button type="button" data-type="natural">ìì—°</button><button type="button" data-type="label">ì§€ëª…</button></div></div><div class="form-row"><label for="castleName">ì´ë¦„:</label>
        <input type="text" id="castleName" style="width: 280px;" required> 
        <!-- ğŸš© [ì¶”ê°€] ê¸°ì—¬ ë³€í™˜ ì‹œ ì›ë³¸ ê¸°ì—¬ì ì •ë³´ ì €ì¥ìš© íˆë“  í•„ë“œ -->
        <input type="hidden" id="originContributionId">
        <input type="hidden" id="originContributor">
      </div>
      <div class="form-row" id="labelColorRow" style="display:none;">
    <label for="labelColor">ê¸€ì ìƒ‰ìƒ:</label>
        <input type="color" id="labelColor" value="#FFFFFF" style="height: 30px; padding: 2px;">
      </div>
      <!-- âœ¨ [ì‹ ê·œ] ì§€ëª… íƒ€ì… ì„ íƒ (ì§€ëª…/êµ­ê°€ëª…/ë¯¼ì¡±) -->
      <div class="form-row" id="labelTypeRow" style="display:none;">
    <label for="labelType">ë¼ë²¨ íƒ€ì…:</label>
        <select id="labelType">
            <option value="place">ì§€ëª… (ì‚°, ê°•, ì§€í˜•)</option>
            <option value="country">êµ­ê°€ëª… (ê³ êµ¬ë ¤, ì¡°ì„  ë“±)</option>
            <option value="ethnic">ë¯¼ì¡± ê±°ì£¼ì§€ (í•œë¯¼ì¡±, ì—¬ì§„ì¡± ë“±)</option>
        </select>
      </div>
      <!-- ğŸš© [ì¶”ê°€] ì§€ëª… ê¸€ì í¬ê¸° ì„ íƒ -->
      <div class="form-row" id="labelSizeRow" style="display:none;">
    <label for="labelSize">ê¸€ì í¬ê¸°:</label>
        <select id="labelSize">
            <option value="medium">ì¤‘</option><option value="large">ëŒ€</option><option value="small">ì†Œ</option></select>
      </div>
      <div class="form-row">
        <label>ìœ„ë„/ê²½ë„:</label>
        <div class="input-group">
          <input type="number" id="castleLat" step="any" required placeholder="ìœ„ë„">
          <input type="number" id="castleLng" step="any" required placeholder="ê²½ë„">
        </div>
      </div>
      <!-- ğŸš© [ì¶”ê°€] ì „ì¥, ì§€ëª…, ìì—° íƒ€ì…ì„ ìœ„í•œ ë‹¨ì¼ ê¸°ê°„ ì„¤ì • ì„¹ì…˜ -->
      <div id="simpleDateSection" style="display:none;">
          <div class="form-row">
              <label for="simpleStartYear">ì‹œì‘ ì—°ë„:</label>
              <div class="input-group">
                  <input type="number" id="simpleStartYear" placeholder="ì‹œì‘ ì—°ë„">
                  <input type="number" id="simpleStartMonth" min="1" max="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
              </div>
          </div>
          <div class="form-row">
              <label for="simpleEndYear">ì¢…ë£Œ ì—°ë„:</label>
              <div class="input-group">
                  <input type="number" id="simpleEndYear" placeholder="ì¢…ë£Œ ì—°ë„">
                  <input type="number" id="simpleEndMonth" min="1" max="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
              </div>
          </div>
      </div>
      <div class="form-row">
    <label for="castleDesc">ì„¤ëª…:</label>
        <textarea id="castleDesc" rows="3"></textarea>
      </div>
      <div class="form-row">
    <label for="castlePhoto">ì‚¬ì§„ URL:</label>
        <input type="text" id="castlePhoto" placeholder="ì„ íƒ ì‚¬í•­">
      </div>
      <!-- ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ì„¤ì • ì„¹ì…˜ -->
      <div class="form-row">
    <label for="customIcon">ì»¤ìŠ¤í…€ ì•„ì´ì½˜ URL:</label>
        <input type="text" id="customIcon" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ ì‚¬í•­)">
      </div>
      <div class="form-row">
        <label>ì•„ì´ì½˜ í¬ê¸°:</label>
        <div class="input-group">
          <input type="number" id="iconWidth" placeholder="ë„ˆë¹„ (px)" min="10" max="200" style="width: 120px;">
          <input type="number" id="iconHeight" placeholder="ë†’ì´ (px)" min="10" max="200" style="width: 120px;">
        </div>
      </div>
      <!-- ğŸš© [ìˆ˜ì •] 'ì„±' íƒ€ì… ì „ìš© ì—­ì‚¬ ê¸°ë¡ ê´€ë¦¬ ì„¹ì…˜ -->
      <div id="castleHistorySection" style="border: 1px solid #00aaff; padding: 10px; margin-top: 10px; border-radius: 4px;">
          <h4>ğŸ“œ ì„±/ë„ì‹œ ì—­ì‚¬ ê¸°ë¡</h4>
          <!-- ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ ëª©ë¡ì— ìŠ¤í¬ë¡¤ì„ ì ìš©í•©ë‹ˆë‹¤. -->
          <div id="castleHistoryList" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
              <!-- ì—­ì‚¬ ê¸°ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
          </div>
          <button type="button" id="addCastleHistoryBtn" style="margin-top: 5px;">ì—­ì‚¬ ê¸°ë¡ ì¶”ê°€</button>
      </div>
      <style>
          .history-record-row {
              display: flex; /* ğŸš© [ìˆ˜ì •] flexbox ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
              flex-wrap: nowrap; /* ğŸš© [ì¶”ê°€] í•œ ì¤„ë¡œ í‘œì‹œ */
              align-items: center; /* ğŸš© [ì¶”ê°€] ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
              gap: 5px;
              width: 100%;

              margin-bottom: 10px; /* ğŸš© [ìˆ˜ì •] í–‰ ê°„ ê°„ê²© ì¡°ì • */
              padding-bottom: 10px; /* ğŸš© [ì¶”ê°€] í–‰ ì•„ë˜ì— íŒ¨ë”© ì¶”ê°€ */
              border-bottom: 1px solid #4e5d6c; /* ğŸš© [ì¶”ê°€] í–‰ êµ¬ë¶„ì„  */
          }

          /* ğŸš© [ì¶”ê°€] ê° ì…ë ¥ í•„ë“œë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
          .history-field-container {
              display: flex;
              flex-direction: column;
          }
          .history-field-container label {
              font-size: 11px;
              color: #bdc3c7;
              margin-bottom: 3px;
          }
          /* ğŸš© [ìˆ˜ì •] ê° ì…ë ¥ í•„ë“œì˜ ë„ˆë¹„ë¥¼ flex ì†ì„±ìœ¼ë¡œ ì§€ì • (ë ˆì´ë¸” ì¶”ê°€ì— ë”°ë¥¸ ì¡°ì •) */
          /* ğŸš© [ì¶”ê°€] ìë™ ì™„ì„± ê²°ê³¼ ëª©ë¡ ìŠ¤íƒ€ì¼ */
          .autocomplete-results {
              display: none; position: absolute; top: 100%; left: 0; right: 0; 
              background: #3e4a56; border: 1px solid #5d7185; 
              z-index: 1002; max-height: 150px; overflow-y: auto;
          }
          .autocomplete-item { padding: 8px; cursor: pointer; }
          .autocomplete-item:hover { background-color: #5d7185; }
          .history-field-container.history-name { flex: 1 1 100px; }
          .history-field-container.history-country { flex: 1 1 100px; }
          .history-field-container.history-start-year { flex: 0 1 75px; } /* ğŸš© [ìˆ˜ì •] 6digit í¬ê¸° (55px->75px) */
          .history-field-container.history-start-month { flex: 0 1 55px; } /* ğŸš© [ìˆ˜ì •] 4digit í¬ê¸° (35px->55px) */
          .history-field-container.history-end-year { flex: 0 1 75px; } /* ğŸš© [ìˆ˜ì •] 6digit í¬ê¸° (55px->75px) */
          .history-field-container.history-end-month { flex: 0 1 55px; } /* ğŸš© [ìˆ˜ì •] 4digit í¬ê¸° (35px->55px) */
          .history-record-row button { align-self: flex-end; flex-shrink: 0; width: 30px; padding: 5px; margin: 0; background-color: #e74c3c; }
          .history-record-row input[type="checkbox"] { width: auto; margin: 0; }
      </style>
        <style>
            /* ë°˜ì‘í˜•: í™”ë©´ì´ ì¤„ë©´ ê³ ë ¤ë§Œë¦¬ì§€ë„ ì œëª© í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
            #main-title {
                transition: font-size 0.2s;
            }
            @media (max-width: 900px) {
                #main-title { font-size: 1.3em; }
            }
            @media (max-width: 600px) {
                #main-title { font-size: 0.8em; margin: 0 !important; padding: 0 !important; display: none !important; }
            }
            @media (max-width: 500px) {
                #main-title {
                    display: none !important;
                }
            }
            /* ë°˜ì‘í˜•: ë¡œë”© í™”ë©´ ì œëª© í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
            @media (max-width: 480px) {
                #initial-loading-screen h2 {
                    font-size: 1.6em !important;
                    white-space: nowrap;
                    text-align: center;
                }
            }
            @media (max-width: 360px) {
                #initial-loading-screen h2 {
                    font-size: 1.3em !important;
                    white-space: nowrap;
                    text-align: center;
                }
            }
        </style>
      

         <hr style="margin: 15px 0;">
      <div class="form-row" id="naturalFeatureDetails">
        <div style="display: flex; align-items: center; gap: 10px;">
          <label for="naturalFeatureType" style="margin: 0; white-space: nowrap;">ì§€ë¬¼ ì¢…ë¥˜:</label>
          <select id="naturalFeatureType" style="flex: 1; min-width: 150px;">
            <option value="mountain">ì‚°/ìˆ²</option>
            <option value="sea">ë°”ë‹¤/í˜¸ìˆ˜</option>
            <option value="river">ê°•/ë‚´ë¥™</option>
            <option value="mudflat">ë»˜/ëŠª</option>
            <option value="horse">ë§</option>
            <option value="buffalo">ë¬¼ì†Œ</option>
            <option value="mongky">ì›ìˆ­ì´</option>
            <option value="camel">ë‚™íƒ€</option>
            <option value="hunting">ì‚¬ëƒ¥í„° ğŸ¹</option>
            <option value="construction">ê±´ì„¤ âš’ï¸</option>
          </select>
        </div>
      </div>
     <div id="militaryFlagDetails" style="border-top: 0px solid #ccc; padding-top: 5px; margin-top: 10px;">
    <div class="form-row">
        <label for="militaryCountryNameInput">ì†Œì† êµ­ê°€:</label>
        <!-- ğŸš© [í•µì‹¬ ìˆ˜ì •] êµ­ê°€ ê²€ìƒ‰ ì…ë ¥ì°½ê³¼ ì„ íƒ ëª©ë¡ì„ ë‚˜ë€íˆ ë°°ì¹˜í•©ë‹ˆë‹¤. -->
        <div style="display: flex; flex-grow: 1; gap: 10px; position: relative;">
            <input type="text" id="militaryCountryNameInput" placeholder="ì†Œì† êµ­ê°€ëª… ì…ë ¥..." autocomplete="off" required style="flex-grow: 1;">
            <div class="autocomplete-results" id="militaryCountryResults"></div>
            <select id="militaryCountrySelect" style="width: 180px; flex-shrink: 0;"></select>
        </div>
        <input type="hidden" id="militaryCountryId" value="">
    </div>
    <div class="form-row">
        <label for="generalName">ì¥ìˆ˜ ì´ë¦„:</label>
        <input type="text" id="generalName" placeholder="ì¥ìˆ˜ ì´ë¦„">
    </div>
    <div class="form-row">
        <label for="troopCount">ë³‘ë ¥ (ëª…):</label>
        <input type="number" id="troopCount" placeholder="ìˆ«ìë§Œ">
    </div>
    <div class="form-row">
        <label for="generalPhoto">ì¥ìˆ˜ ì‚¬ì§„ URL:</label>
        <input type="text" id="generalPhoto" placeholder="ì„ íƒ ì‚¬í•­">
    </div>
</div>
<div id="pathDataSection" style="border: 1px solid #00aaff; padding: 10px; margin-top: 10px; border-radius: 4px;">
                <h4>âš”ï¸ êµ°ëŒ€ ì´ë™ ê²½ë¡œ (Path Data)</h4>
                <div id="pathDataList"></div>
                <button type="button" onclick="addPathPoint()" style="margin-top: 5px;">ê²½ë¡œ ì§€ì  ì¶”ê°€</button>
            </div>

      <br>
      <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
        <!-- ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ìˆœì„œ ë³€ê²½ ë° ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì ìš© -->
        <!-- ğŸš© [ì¶”ê°€] ê¸°ì—¬ë¡œ ë˜ëŒë¦¬ê¸° ë²„íŠ¼ -->
        <button type="button" id="revertContributionBtn" class="danger" style="display:none; background-color: #e67e22; border-color: #d35400;">ê¸°ì—¬ë¡œ ë˜ëŒë¦¬ê¸°</button>
        <button type="button" id="cloneCastle" class="primary" style="display:none;">ë³µì œ</button> <!-- ğŸš© [ìˆ˜ì •] ë³µì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì ìš© -->
        <button type="button" id="deleteCastle" class="danger" style="display:none;">ğŸ—‘ï¸ íœ´ì§€í†µìœ¼ë¡œ ì´ë™</button>
        <button type="button" id="cancelCastle">ì·¨ì†Œ</button>
        <button type="submit" class="primary">ì €ì¥</button> <!-- ğŸš© [ìˆ˜ì •] ID ì¶”ê°€ -->
      </div>
    </form>
  </div>

  <!-- ğŸš© [ìˆ˜ì •] ë„ì‹œ/ì„±/ì§€ëª… í¸ì§‘ ì„ íƒ í¼ -->
  <div id="editCitySelectionForm" style="display: none; position: absolute; top: 100px; left: calc(50% - 225px); background: #2c3e50; color: #ecf0f1; border: 1px solid #5d7185; padding: 20px; z-index: 1000; border-radius: 8px; width: 450px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); max-width: 90%; min-width: 350px;">
      <h3>í¸ì§‘í•  ë„ì‹œ/ì„±/ì§€ëª… ì„ íƒ</h3>
      <!-- ğŸš© [í•µì‹¬ ìˆ˜ì •] ë„ì‹œ/ì„± ì„ íƒ UIë¥¼ ìë™ ì™„ì„± ê²€ìƒ‰ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ -->
      <div class="form-row" style="margin-bottom: 15px;">
          <label for="citySearchInputForEdit">ë„ì‹œ/ì„±/ì§€ëª…:</label>
          <div style="display: flex; flex-grow: 1; gap: 10px; position: relative;">
              <div style="position: relative; flex-grow: 1;">
                  <input type="text" id="citySearchInputForEdit" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." autocomplete="off">
                  <div id="citySearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: #3e4a56; border: 1px solid #5d7185; z-index: 1001; max-height: 150px; overflow-y: auto; display: none;"></div>
              </div>
              <select id="citySelectForEdit" style="width: 180px; flex-shrink: 0;"></select>
          </div>
      </div>
      <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelCitySelectionBtn">ì·¨ì†Œ</button>
          <button type="button" id="editSelectedCityBtn" class="primary">í¸ì§‘</button>
      </div>
  </div>
    <div id="historyForm" style="display:none;">
      <h3>ì‚¬ì„œ ê¸°ë¡ í¸ì§‘/ì¶”ê°€</h3>
      <form id="addHistoryForm">
          <input type="hidden" id="historyKey"> 
          <div class="form-row">
            <label for="historyYear">ì—°ë„:</label>
            <div class="input-group">
              <input type="number" id="historyYear" required>
              <input type="number" id="historyMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
          </div>
          <div class="form-row">
            <label for="historyEvent">ì´ë²¤íŠ¸ëª…:</label>
            <input type="text" id="historyEvent" required>
          </div>
          <div class="form-row">
            <label for="historyPhoto">ì‚¬ì§„ URL:</label>
            <input type="text" id="historyPhoto" placeholder="ì„ íƒ ì‚¬í•­">
          </div>
          <div class="form-row">
            <label for="createEvent">ì´ë²¤íŠ¸ ë°œìƒ:</label>
            <input type="checkbox" id="createEvent" style="width: auto; justify-self: start;">
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**1. ìš°ë¦¬ ì—­ì‚¬ì„œ**</h4>
          <div class="form-row">
            <label for="koreanSource">ì¶œì „:</label>
            <input type="text" id="koreanSource" placeholder="ì˜ˆ: ì‚¼êµ­ì‚¬ê¸°">
          </div>
          <div class="form-row">
            <label for="koreanContent">ë‚´ìš©:</label>
            <textarea id="koreanContent" rows="3"></textarea>
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**2. ì¡êµ­ ì—­ì‚¬ì„œ**</h4>
          <div class="form-row">
            <label for="foreignSource">ì¶œì „:</label>
            <input type="text" id="foreignSource" placeholder="ì˜ˆ: êµ¬ë‹¹ì„œ">
          </div>
          <div class="form-row">
            <label for="foreignContent">ë‚´ìš©:</label>
            <textarea id="foreignContent" rows="3"></textarea>
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="margin-bottom: 10px;">**3. ì§„ì§œ ì—­ì‚¬ (ì²œë¬¸/ì§€ë¦¬ ê¸°ë°˜ ì—°êµ¬)**</h4>
          <div class="form-row">
            <label for="trueHistoryContent">ë‚´ìš©:</label>
            <textarea id="trueHistoryContent" rows="3"></textarea>
          </div>
          <div class="form-actions" style="text-align: right; margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" id="cancelHistoryBtn">ì·¨ì†Œ</button>
            <button type="button" id="deleteHistoryBtn" class="danger" style="display: none;">ì‚­ì œ</button>
            <button type="submit" id="saveHistoryBtn" class="primary">ì €ì¥</button>
          </div>
      </form>
  </div>

    <div id="countryForm" style="display:none;">
    <h3>êµ­ê°€ ì •ë³´ í¸ì§‘</h3>
    <!-- ğŸš© [ìˆ˜ì •] êµ­ê°€ ì„ íƒ UIë¥¼ ìë™ ì™„ì„± ê²€ìƒ‰ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ -->
    <div class="form-row" style="margin-bottom: 15px;">
        <label for="countrySelectForEdit">ê¸°ì¡´ êµ­ê°€:</label>
        <div style="display: flex; flex-grow: 1; gap: 10px; position: relative;">
            <input type="text" id="countrySearchForEdit" placeholder="êµ­ê°€ëª… ë˜ëŠ” ë¯¼ì¡±ìœ¼ë¡œ ê²€ìƒ‰..." autocomplete="off" style="flex-grow: 1;">
            <div id="countrySearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: #3e4a56; border: 1px solid #5d7185; z-index: 1001; max-height: 150px; overflow-y: auto; display: none;"></div>
            <select id="countrySelectForEdit" style="width: 180px; flex-shrink: 0;"></select>
        </div>
    </div>
    <form id="editCountryForm">
        <input type="hidden" id="countryOriginalName">
        <input type="hidden" id="countryOriginalId">
        <div class="form-row">
            <label for="countryName">êµ­ê°€ ì´ë¦„:</label>
            <input type="text" id="countryName" required>
        </div>
        <div class="form-row">
            <label for="countryStart">ì‹œì‘ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="countryStart" required value="-2333">
                <input type="number" id="countryStartMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="countryEnd">ì¢…ë£Œ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="countryEnd">
                <input type="number" id="countryEndMonth" min="1" max="12" value="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="countryColor">ë§ˆì»¤ ìƒ‰ìƒ:</label>
            <input type="color" id="countryColor" value="#ffffff" required style="width: 100%; padding: 0;">
        </div>
        <div class="form-row">
            <label for="countryFlag">í”Œë˜ê·¸ URL:</label>
            <input type="text" id="countryFlag" placeholder="ì„ íƒ ì‚¬í•­">
        </div>
        <div class="form-row">
            <label for="countryEthnicity">ë¯¼ì¡±:</label>
            <input type="text" id="countryEthnicity" placeholder="ì˜ˆ: ê³ êµ¬ë ¤ì¡±">
        </div>
        <div class="form-row">
            <label for="isMainDynasty">ìš°ë¦¬ ë¯¼ì¡±:</label>
            <input type="checkbox" id="isMainDynasty" style="width: auto; justify-self: start;">
        </div>
        <div class="form-row">
            <label for="countrySealText" style="line-height:1.3;">ë‚™ì¸ ê¸€ì”¨:<br><small style="color:#95a5a6; font-weight:400;">ìˆ˜ë„ ë§ˆì»¤ ë‚™ê´€ì— í‘œì‹œë  ê¸€ì (ë¹„ì›Œë‘ë©´ êµ­ê°€ëª…ì—ì„œ ìë™ ì¶”ì¶œ)</small></label>
            <input type="text" id="countrySealText" placeholder="ì˜ˆ: æ¼¢, ê³ , ?" maxlength="2" style="width: 60px; flex-grow: 0; text-align: center; font-size: 15px;">
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelCountryBtn">ì·¨ì†Œ</button>
          <button type="button" id="deleteCountryBtn" class="danger">ì‚­ì œ</button>
          <button type="submit" id="saveCountryBtn" class="primary">ì €ì¥/ì¶”ê°€</button>
        </div>
    </form>
  </div>
  
    <div id="kingForm" style="display:none;">
    <h3>ì™• ì •ë³´ í¸ì§‘</h3>
    <form id="editKingForm">
        <input type="hidden" id="kingMongoId" name="kingMongoId">
        <input type="hidden" id="kingOriginalKey">
        <input type="hidden" id="kingOriginalIndex">
        <!-- ğŸš© [ìˆ˜ì •] êµ­ê°€ ì„ íƒì„ ìë™ ì™„ì„± ê²€ìƒ‰ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ -->
        <input type="hidden" id="kingCountryId">
        <div class="form-row" style="margin-bottom: 15px;">
            <label for="kingCountryNameInput">êµ­ê°€:</label>
            <!-- ğŸš© [í•µì‹¬ ìˆ˜ì •] êµ­ê°€ ê²€ìƒ‰ ì…ë ¥ì°½ê³¼ ì„ íƒ ëª©ë¡ì„ ë‚˜ë€íˆ ë°°ì¹˜í•©ë‹ˆë‹¤. -->
            <div style="display: flex; flex-grow: 1; gap: 10px; position: relative;">
                <div style="position: relative; flex-grow: 1;">
                    <input type="text" id="kingCountryNameInput" placeholder="êµ­ê°€ëª… ì…ë ¥..." autocomplete="off">
                    <div id="kingCountryResults" style="position: absolute; top: 100%; left: 0; right: 0; background: #3e4a56; border: 1px solid #5d7185; z-index: 1001; max-height: 150px; overflow-y: auto; display: none;"></div>
                </div>
                <select id="kingCountrySelect" style="width: 180px; flex-shrink: 0;"></select>
            </div>
        </div>
        <div class="form-row">
            <label for="kingSelect">ì™• ì„ íƒ/ì¶”ê°€:</label>
            <select id="kingSelect">
                <option value="">ìƒˆ ì™• ì¶”ê°€</option>
            </select>
        </div>
        <div class="form-row">
            <label for="kingName">ì™• ì´ë¦„:</label>
            <input type="text" id="kingName" required>
        </div>
        <div class="form-row">
            <label for="kingSummary">í•œì¤„í‰:</label>
            <input type="text" id="kingSummary" placeholder="ì™•ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª… (ì„ íƒ)">
        </div>
        <div class="form-row">
            <label for="kingStart">ì‹œì‘ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="kingStart" required>
                <input type="number" id="kingStartMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="kingEnd">ì¢…ë£Œ ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="kingEnd">
                <input type="number" id="kingEndMonth" min="1" max="12" value="12" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="cancelKingBtn">ì·¨ì†Œ</button>
          <button type="button" id="deleteKingBtn" class="danger" style="display:none;">ì‚­ì œ</button>
          <button type="submit" id="saveKingBtn" class="primary">ì¶”ê°€</button>
        </div>
    </form>
  </div>

  <!-- ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ í¸ì§‘ í¼ -->
    <div id="eventForm" style="display:none;">
    <h3>ì—°ë„ë³„ ì´ë²¤íŠ¸ í¸ì§‘</h3> <!-- ğŸš© [ìˆ˜ì •] í¼ êµ¬ì¡°ë¥¼ ë‹¤ë¥¸ í¼ê³¼ í†µì¼ -->
    <form id="editEventForm">
        <input type="hidden" id="eventMongoId">
        <div class="form-row" style="margin-bottom: 15px;">
            <label for="eventSelect">ê¸°ì¡´ ì´ë²¤íŠ¸:</label>
            <select id="eventSelect" style="flex-grow: 1;"></select>
        </div>
        <div class="form-row">
            <label for="eventYear">ì—°ë„:</label>
            <div class="input-group">
                <input type="number" id="eventYear" required>
                <input type="number" id="eventMonth" min="1" max="12" value="1" placeholder="ì›”" style="width: 60px; flex-grow: 0;">
            </div>
        </div>
        <div class="form-row">
            <label for="eventText">ì´ë²¤íŠ¸ ë‚´ìš©:</label>
            <input type="text" id="eventText" required>
        </div>
        <div class="form-row">
            <label for="eventPhoto">ì‚¬ì§„ URL:</label>
            <input type="text" id="eventPhoto" placeholder="ì„ íƒ ì‚¬í•­">
        </div>
        <hr style="margin: 15px 0;">
        <div class="form-actions" style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;"> <!-- ğŸš© [ìˆ˜ì •] form-actions í´ë˜ìŠ¤ ì ìš© -->
            <button type="button" id="cancelEventBtn">ì·¨ì†Œ</button>
            <button type="button" id="deleteEventBtn" class="danger" style="display:none;">ì‚­ì œ</button>
            <button type="submit" id="saveEventBtn" class="primary">ì €ì¥/ì¶”ê°€</button>
        </div>
    </form>
  </div>
  
  <!-- ğŸš© [ì´ë™ë¨] ê·¸ë¦¬ê¸° í¼ì„ ì§€ë„ ë‚´ë¶€ë¡œ ì´ë™ -->

<script>
    
    // ğŸš© [ì¶”ê°€] JWT í† í°ì„ ë””ì½”ë”©í•˜ì—¬ payloadë¥¼ ì–»ëŠ” í•¨ìˆ˜
    function parseJwt(token) {
        try {
            // í† í°ì˜ payload ë¶€ë¶„ì„ ì¶”ì¶œ (ë‘ ë²ˆì§¸ ë¶€ë¶„)
            const base64Url = token.split('.')[1];
            // Base64Urlì„ ì¼ë°˜ Base64ë¡œ ë³€í™˜
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            // Base64 ë””ì½”ë”© í›„ UTF-8 ë¬¸ìì—´ë¡œ ë³€í™˜
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null; // ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
        }
    }
    // ğŸš© [ìˆ˜ì •] localStorage ë˜ëŠ” sessionStorageì—ì„œ í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    let token = localStorage.getItem('token') || sessionStorage.getItem('token');
    
    // "null" ë¬¸ìì—´ ì²´í¬ ë° ì •ë¦¬ (ë” ê°•ë ¥í•œ ì²´í¬)
    if (!token || token === 'null' || token === 'undefined' || token.trim() === '') {
        console.warn('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ê°ì§€:', token);
        localStorage.removeItem('token');
        sessionStorage.removeItem('token');
        token = null;
    }
    
    // JWT í˜•ì‹ ê²€ì¦ (xxx.yyy.zzz í˜•íƒœì—¬ì•¼ í•¨)
    if (token && token.split('.').length !== 3) {
        console.warn('âš ï¸ ì˜ëª»ëœ JWT í˜•ì‹:', token);
        localStorage.removeItem('token');
        sessionStorage.removeItem('token');
        token = null;
    }
    
    if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
    } else {
        console.log('âœ… ìœ íš¨í•œ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ë¨');
    }


    // ----------------------------------------------------
    // âš™ï¸ ì„¤ì •
    // ----------------------------------------------------
    // ğŸš© [ìˆ˜ì •] ê³ ëŒ€ ì§€ë„ ì •ë³´ë¥¼ ë°°ì—´ë¡œ ê´€ë¦¬
    const ancientMaps = [
        {
            id: 'daecheongBtn', 
            name: 'ëŒ€ì²­ê´‘ì—¬ë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/1.%20%E1%84%83%E1%85%A2%E1%84%8E%E1%85%A5%E1%86%BC%E1%84%80%E1%85%AA%E1%86%BC%E1%84%8B%E1%85%A7%E1%84%83%E1%85%A9.JPG?raw=true' 
        },
        { 
            id: 'cheonhaBtn', 
            name: 'ì²œí•˜ê³ ê¸ˆëŒ€ì´í¸ëŒë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/3%20%E1%84%8E%E1%85%A5%E1%86%AB%E1%84%92%E1%85%A1%E1%84%80%E1%85%A9%E1%84%80%E1%85%B3%E1%86%B7%E1%84%83%E1%85%A2%E1%84%8E%E1%85%A9%E1%86%BC%E1%84%91%E1%85%A7%E1%86%AB%E1%84%85%E1%85%A1%E1%86%B7%E1%84%83%E1%85%A9%20%E1%84%92%E1%85%A1%E1%86%AB%E1%84%80%E1%85%B3%E1%86%AF%E1%84%91%E1%85%A1%E1%86%AB(%E1%84%8E%E1%85%A2%E1%86%A8%E1%84%87%E1%85%A9%E1%84%80%E1%85%A9%E1%84%87%E1%85%A5%E1%86%AB%E1%84%8B%E1%85%A7%E1%86%A8).JPG?raw=true' 
        },
        {   id: 'honilBtn', 
            name: 'í˜¼ì¼ê°•ë¦¬ì—­ëŒ€êµ­ë„ì§€ë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/4%20%E1%84%87%E1%85%A9%E1%84%80%E1%85%B3%E1%86%B8%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%92%E1%85%A9%E1%86%AB%E1%84%8B%E1%85%B5%E1%86%AF%E1%84%80%E1%85%A1%E1%86%BC%E1%84%85%E1%85%B5%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%83%E1%85%A2%E1%84%80%E1%85%AE%E1%86%A8%E1%84%83%E1%85%A9%E1%84%8C%E1%85%B5%E1%84%83%E1%85%A9%20(%E1%84%8E%E1%85%A2%E1%86%A8%E1%84%87%E1%85%A9%E1%84%80%E1%85%A9%20%E1%84%92%E1%85%A1%E1%86%AB%E1%84%80%E1%85%B3%E1%86%AF%E1%84%87%E1%85%A5%E1%86%AB%E1%84%8B%E1%85%A7%E1%86%A8).JPG?raw=true' 
        },
        {   id: 'woojukdoBtn', 
            name: 'ìš°ì ë„', 
            url: 'https://github.com/projeffmanager-design/img/blob/main/2%20%E1%84%8B%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%A8%E1%84%83%E1%85%A9%20%E1%84%8E%E1%85%A2%E1%86%A8%E1%84%87%E1%85%A9%E1%84%80%E1%85%A9%20%E1%84%92%E1%85%A1%E1%86%AB%E1%84%80%E1%85%B3%E1%86%AF%E1%84%91%E1%85%A1%E1%86%AB.JPG?raw=true' 
        },
        {   id: 'surnameBtn', 
            name: 'ì„±ì”¨ë¶„í¬ì§€ë„', 
            url: 'https://m.21jingji.com/article/20190603/herald/c9f01b60b033a026a276deb3896ceb78.html' 
        }
    ];

    // ğŸ¯ [ë¡œì»¬/ì„œë²„ í˜¸í™˜] ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© (ë°°í¬ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ë„ë©”ì¸ ì¶”ì )
    const API_BASE_URL = '/api'; // ë¡œì»¬: localhost:3000/api, Vercel: historymap-psi.vercel.app/api
    let isLoggedIn = true; // ì´ í˜ì´ì§€ëŠ” í•­ìƒ ë¡œê·¸ì¸ëœ ìƒíƒœì…ë‹ˆë‹¤.
    // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
    let countries = [];
    let currentUser = null; // ğŸš© [ì¶”ê°€] í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì €ì¥
    let countryColors = {};
    let castles = [];
    let history = [];
    let kings = {}; // { countryKey: [ {name, start, end}, ... ] }
    let events = []; // ğŸš© [ì¶”ê°€] ì—°ë„ë³„ ì´ë²¤íŠ¸ ë°ì´í„° ì €ì¥ì†Œ
    let historyEventTimes = []; // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ì˜ ì—°/ì›” ëª©ë¡
    let historyYears = []; // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ì´ ìˆëŠ” ì—°ë„ ëª©ë¡
    let drawings = []; // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ë°ì´í„° ì €ì¥ì†Œ
    let territories = []; // ğŸš© [ì¶”ê°€] ì˜í†  í´ë¦¬ê³¤ ë°ì´í„° ì €ì¥ì†Œ
    let naturalFeatures = []; // ğŸŒŠ [ì¶”ê°€] ìì—° ì§€í˜•ì§€ë¬¼ (ê°•, ì‚°ë§¥ ë“±) ë°ì´í„° ì €ì¥ì†Œ
    let contributions = []; // ğŸš© [ì¶”ê°€] ìœ ì € ê¸°ì—¬ ë°ì´í„°
    let markers = [];
    let allCastleMarkers = []; // ğŸš© [ì¶”ê°€] ëª¨ë“  ì„± ë§ˆì»¤ ì €ì¥ì†Œ
    let currentOpenPopup = null; // ğŸš© [ì¶”ê°€] í˜„ì¬ ì—´ë¦° íŒì—… ì¶”ì 
    let isInitializing = true; // ğŸš€ [ìµœì í™”] ì´ˆê¸° ë¡œë”© í”Œë˜ê·¸
    window._castleMarkersRendered = false; // ğŸ¯ ì„±/ë„ì‹œ ë§ˆì»¤ ë Œë”ë§ ì™„ë£Œ ì‹ í˜¸

    // UI ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ (isLoggedIn ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸°í™”)
    let editMode = false;
    // ğŸš© [ìˆ˜ì •] ë¡œê·¸ì¸ í›„ í•­ìƒ ì¼ë°˜ ë·° ëª¨ë“œë¡œ ì‹œì‘ (í¸ì§‘ëª¨ë“œ ìë™ ë³µì› ì œê±°)
    // localStorageì˜ editModeëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    let editingCastleKey = null;
    let editingHistoryKey = null;
    let editMarker = null; // ë“œë˜ê·¸ ê°€ëŠ¥í•œ í¸ì§‘ìš© ë§ˆì»¤
    let mouseOutTimer = null; // íŒì—… ë‹«ê¸° ì§€ì—° íƒ€ì´ë¨¸
    let eventDisplayTimeout = null; // ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ ì‚¬ë¼ì§ íƒ€ì´ë¨¸
    let contributionMode = false; // ğŸš© [ì¶”ê°€] ê¸°ì—¬ ëª¨ë“œ ìƒíƒœ
    let contributionMarker = null; // ê¸°ì—¬ ìœ„ì¹˜ í‘œì‹œ ë§ˆì»¤
    let lastCheckedEventTime = { year: null, month: null }; // ğŸš© [ìˆ˜ì •] ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•œ ì—°/ì›”ì„ ì¶”ì 
    let activePopupMarker = null; // í˜„ì¬ íŒì—…ì´ ì—´ë¦° ë§ˆì»¤ë¥¼ ì¶”ì 
    
    // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ê´€ë ¨ ë³€ìˆ˜
    let drawnItems = new L.FeatureGroup();
    let drawControl;
    let isDrawing = false; // ğŸš© [ì¶”ê°€] í˜„ì¬ ë„í˜•ì„ ê·¸ë¦¬ê³  ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” ìƒíƒœ ë³€ìˆ˜
    
    // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ ìƒíƒœ ì €ì¥ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
    let lastSearchQuery = '';
    let lastSearchResults = [];
    let lastSearchIndex = -1;

    // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„° ìƒíƒœ
    let selectedCountryId = 'all';
    // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„° ìƒíƒœ
    let selectedEthnicity = 'all';

    // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ê°€ì‹œì„± ìƒíƒœ
    let layerVisibility = {
        city: true,         // ğŸ”„ [ìˆ˜ì •] ì„±/ë„ì‹œ ì´ˆê¸° ON (ë„ì‹œ/ì„± ë§ˆì»¤ í‘œì‹œ)
        placeLabel: true,  // ğŸ”„ [ìˆ˜ì •] ì§€ëª… ì´ˆê¸° ON (ì´ˆë³´ì‚° ë“± ì§€ëª… í‘œì‹œ)
        countryLabel: true, // âœ¨ [ìˆ˜ì •] êµ­ê°€ëª… ë¼ë²¨ ì´ˆê¸° ON
        ethnicLabel: false, // âœ¨ [ì‹ ê·œ] ë¯¼ì¡± ê±°ì£¼ì§€
        military: false,   // ğŸ”„ [ìµœì í™”] êµ°ëŒ€ ì´ˆê¸° OFF
        battle: false,     // ğŸ”„ [ìµœì í™”] ì „ì¥ ì´ˆê¸° OFF
        natural: true,     // ğŸ”„ [ìˆ˜ì •] ìì—° ì´ˆê¸° ON (ìì—°ì§€ë¬¼ ë§ˆì»¤ í‘œì‹œ)
        territoryPolygon: true, // ğŸ”„ [ë³€ê²½] ì˜í†  ì´ˆê¸° ON (ìë™ ë¡œë”©)
        rivers: false,    // ğŸŒŠ [ì¶”ê°€] ê°• ë ˆì´ì–´ ê°€ì‹œì„±
        event: false,      // ğŸ“– [ìµœì í™”] ì´ë²¤íŠ¸ ì´ˆê¸° OFF
        timeline: false,   // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ê°€ì‹œì„± - ì˜µì…”ë„ë¡œ ê¸°ë³¸ ìˆ¨ê¹€
        kingPanel: false,  // ğŸš© [ìˆ˜ì •] ì™•ëª©ë¡ íŒ¨ë„ ì´ˆê¸°ê°’ OFF
        historyPanel: false, // ğŸš© [ìˆ˜ì •] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ì´ˆê¸°ê°’ on (ë˜ëŒë¦¼)
        userContributions: false, // ğŸš© [ì¶”ê°€] ìœ ì € ê¸°ì—¬ ë ˆì´ì–´
        eventSidebar: false, // ğŸš© [ê³¼ì œ2] ì‚¬ê±´ëª©ë¡ ì‚¬ì´ë“œë°” í† ê¸€
        // ğŸ”„ [í˜¸í™˜ì„±] ê¸°ì¡´ 'label'ì€ placeLabelë¡œ ë§¤í•‘
        get label() { return this.placeLabel; },
        set label(value) { this.placeLabel = value; }
    };
    // ğŸš© [ìˆ˜ì •] battle ë ˆì´ì–´: ë…ë¦½ ì „ì¥ ë§ˆì»¤(is_battle=true) + ì—­ì‚¬ ë ˆì½”ë“œ ì „ì¥(history[].is_battle=true) ë‘˜ ë‹¤ ì§€ì›

    // --- 2. DOM ìš”ì†Œ ë§µí•‘ ---

    // ğŸš© [ì¶”ê°€] ì˜í†  ìƒ‰ì¹  ë°©ì‹ ì§€ì • (specify)
    // ê°€ëŠ¥í•œ ê°’: 'country' (ê¸°ë³¸), 'ethnicity', 'random', 'grayscale', ë˜ëŠ” ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜
    window.territoryColorSpec = 'country';

    // ì…‹íŒ… í•¨ìˆ˜: ë¬¸ìì—´ ë˜ëŠ” í•¨ìˆ˜(territory, countryInfo, year, month) -> ìŠ¤íƒ€ì¼ ê°ì²´
    window.setTerritoryColorSpec = function(spec) {
        if (typeof spec === 'string' || typeof spec === 'function') {
            window.territoryColorSpec = spec;
            // ì¦‰ì‹œ ì¬ë Œë”ë§
            try { updateMap(parseInt(yearInput.value, 10), parseInt(monthInput.value, 10)); } catch (e) { console.warn('Update failed after setting territoryColorSpec:', e); }
            return true;
        }
        return false;
    };

    // í—¬í¼: ë¬¸ìì—´ì„ ìƒ‰ìœ¼ë¡œ í•´ì‹œ
    function hashStringToColor(str, s = 60, l = 60) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const h = Math.abs(hash) % 360;
        return `hsl(${h}, ${s}%, ${l}%)`;
    }

    // í—¬í¼: ìƒ‰ì„ ê·¸ë ˆì´ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜ (simple RGB avg)
    function toGrayscale(hexColor) {
        // accepts hex like #rrggbb or rgb/hsl passthrough
        if (!hexColor) return '#888888';
        if (hexColor.startsWith('hsl')) return hexColor; // skip complex conversions for now
        if (hexColor.startsWith('#') && hexColor.length === 7) {
            const r = parseInt(hexColor.slice(1,3), 16);
            const g = parseInt(hexColor.slice(3,5), 16);
            const b = parseInt(hexColor.slice(5,7), 16);
            const avg = Math.round((r+g+b)/3);
            const hex = avg.toString(16).padStart(2, '0');
            return `#${hex}${hex}${hex}`;
        }
        return hexColor; // fallback
    }

    // í—¬í¼: ì‹œë“œëœ ìƒ‰ (ì˜í† ë§ˆë‹¤ ì¼ê´€ëœ ëœë¤ ìƒ‰)
    function seededColor(seedStr) {
        let hash = 2166136261;
        for (let i = 0; i < seedStr.length; i++) {
            hash ^= seedStr.charCodeAt(i);
            hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
        }
        const h = Math.abs(hash) % 360;
        return `hsl(${h}, 60%, 60%)`;
    }

    // í•µì‹¬: ì˜í†  ìŠ¤íƒ€ì¼ ìƒì„±ê¸°
    function getTerritoryStyle(territory, countryInfo, year, month) {
        try {
            const spec = window.territoryColorSpec;
            // ì‚¬ìš©ì ì§€ì • í•¨ìˆ˜ì¸ ê²½ìš° ì§ì ‘ í˜¸ì¶œ
            if (typeof spec === 'function') {
                const result = spec(territory, countryInfo, year, month);
                if (result && typeof result === 'object') return result;
            }

            const mode = typeof spec === 'string' ? spec : 'country';

            const baseOpacity = 0.62;
            // ğŸ”‘ [ê°œì„ ] countryInfoê°€ null (êµ­ê°€ ë¡œë”© ì¤‘)ì´ë©´ íšŒìƒ‰ fallback í‘œì‹œ
            const baseColor = countryInfo && countryInfo.color ? countryInfo.color : '#888888';

            switch (mode) {
                case 'ethnicity': {
                    const eth = countryInfo && countryInfo.ethnicity ? countryInfo.ethnicity : (countryInfo && countryInfo.name ? countryInfo.name : 'unknown');
                    const color = Array.isArray(eth) ? hashStringToColor(eth.join(',')) : hashStringToColor(String(eth));
                    return { color: color, weight: 2, opacity: 0.7, fillColor: color, fillOpacity: baseOpacity };
                }
                case 'random': {
                    const color = seededColor(territory._id ? String(territory._id) : (territory.name || 'territory'));
                    return { color: color, weight: 2, opacity: 0.7, fillColor: color, fillOpacity: baseOpacity };
                }
                case 'grayscale': {
                    const color = toGrayscale(baseColor);
                    return { color: color, weight: 2, opacity: 0.6, fillColor: color, fillOpacity: baseOpacity * 0.8 };
                }
                case 'country':
                default: {
                    return { color: baseColor, weight: 2, opacity: 0.6, fillColor: baseColor, fillOpacity: baseOpacity };
                }
            }
        } catch (e) {
            console.error('getTerritoryStyle error:', e);
            const base = countryInfo && countryInfo.color ? countryInfo.color : '#ffffff';
            return { color: base, weight: 2, opacity: 0.6, fillColor: base, fillOpacity: 0.62 };
        }
    }

    // ğŸš© [ì¶”ê°€] ìƒ‰ìƒ ë°ê¸° ì¡°ì • í—¬í¼ í•¨ìˆ˜
    function adjustColorBrightness(hex, percent) {
        // hexë¥¼ RGBë¡œ ë³€í™˜
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);

        // ë°ê¸° ì¡°ì •
        const newR = Math.max(0, Math.min(255, Math.round(r * (1 + percent))));
        const newG = Math.max(0, Math.min(255, Math.round(g * (1 + percent))));
        const newB = Math.max(0, Math.min(255, Math.round(b * (1 + percent))));

        // RGBë¥¼ hexë¡œ ë³€í™˜
        return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
    }

    // ğŸš© [ì¶”ê°€] UI: ì˜í†  ìƒ‰ì¹  ë°©ì‹ ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ë ˆì´ì–´ í† ê¸€ ì˜†ì— ì¶”ê°€
    (function addTerritoryColorSpecControl() {
        const container = document.getElementById('layer-toggles');
        if (!container) return;
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.gap = '6px';

        const label = document.createElement('label');
        label.textContent = 'ìƒ‰ì¹ :';
        label.style.fontSize = '11px';
        label.style.color = '#ecf0f1';

        const select = document.createElement('select');
        select.id = 'territoryColorSpecSelect';
        select.style.fontSize = '11px';
        select.style.background = 'transparent';
        select.style.border = '1px solid #5d7185';
        select.style.color = '#ecf0f1';
        select.style.padding = '2px 6px';
        select.style.borderRadius = '4px';

        const options = [
            { value: 'country', text: 'êµ­ê°€ìƒ‰ (ê¸°ë³¸)' },
            { value: 'ethnicity', text: 'ë¯¼ì¡± ê¸°ë°˜' },
            { value: 'random', text: 'ëœë¤(ì˜í† ë³„ ê³ ì •)' },
            { value: 'grayscale', text: 'ê·¸ë ˆì´ìŠ¤ì¼€ì¼' }
        ];
        options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt.value;
            o.textContent = opt.text;
            select.appendChild(o);
        });

        select.value = window.territoryColorSpec;
        select.addEventListener('change', (e) => {
            const val = e.target.value;
            window.setTerritoryColorSpec(val);
        });

        wrapper.appendChild(label);
        wrapper.appendChild(select);
        container.appendChild(wrapper);
    })();

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ëª¨ë°”ì¼ ë·°ì¼ ë•Œ ê¸°ë³¸ ì¤Œ ë ˆë²¨ì„ ë‹¤ë¥´ê²Œ ì„¤ì •í•©ë‹ˆë‹¤.
    const isMobileOnLoad = window.innerWidth <= 967;
    const map = L.map('map', {
        center: [36, 120],
        zoom: isMobileOnLoad ? 5 : 6, // ëª¨ë°”ì¼ì´ë©´ 5, ë°ìŠ¤í¬í†±ì´ë©´ 6
        minZoom: 4, // ì§€ë„ë¥¼ ë„ˆë¬´ ì‘ê²Œ ì¶•ì†Œí•˜ëŠ” ê²ƒì„ ë°©ì§€
        worldCopyJump: true, // ğŸš© [ì¶”ê°€] ì§€ë„ ì¢Œìš° ë¡¤ë§(ì—°ì† ìŠ¤í¬ë¡¤) ê¸°ëŠ¥ í™œì„±í™”
        attributionControl: false, // ğŸš© [ì¶”ê°€] leaflet attribution(ë§í¬) ìˆ¨ê¹€
        zoomControl: false, // ğŸš© [ì¶”ê°€] ê¸°ë³¸ ì¤Œ ì»¨íŠ¸ë¡¤ ë¹„í™œì„±í™” (ìˆ˜ë™ìœ¼ë¡œ ìœ„ì¹˜ ì§€ì •)
        preferCanvas: true, // ğŸš€ [ìµœì í™”] Canvas ë Œë”ë§ ì‚¬ìš© â€” SVGë³´ë‹¤ ìˆ˜ë°± ê°œ ë§ˆì»¤ì—ì„œ í›¨ì”¬ ë¹ ë¦„
        // ğŸ¯ [ì¡°ì •] ì§€ë„ ì´ë™ ë¬µì§í•˜ê²Œ, ìŠ¤í¬ë¡¤ ì¤Œ ê°„ì„­ ìµœì†Œí™”
        inertia: true,               // ë“œë˜ê·¸ í›„ ê´€ì„± ì´ë™ ìœ ì§€
        inertiaDeceleration: 1800,   // ê¸°ë³¸ 3000 â†’ ë‚®ì„ìˆ˜ë¡ ì²œì²œíˆ ë©ˆì¶¤ (ë¬µì§í•¨)
        inertiaMaxSpeed: 1000,       // ê¸°ë³¸ 1500 â†’ ìµœëŒ€ ì†ë„ ì œí•œ
        zoomSnap: 0.5,               // ê¸°ë³¸ 1 â†’ ì¤Œ ë‹¨ê³„ë¥¼ 0.5 ë‹¨ìœ„ë¡œ ë¶€ë“œëŸ½ê²Œ
        zoomDelta: 0.5,              // ë²„íŠ¼ í´ë¦­/í‚¤ë³´ë“œ ì¤Œ ë‹¨ìœ„ (ê¸°ë³¸ 1 â†’ 0.5ë¡œ ì„¸ë°€í•˜ê²Œ)
        wheelPxPerZoomLevel: 120,    // ê¸°ë³¸ 60 â†’ ë‘ ë°°ë¡œ ëŠ˜ë ¤ ìŠ¤í¬ë¡¤ ì¤Œ ê°ë„ ë‚®ì¶¤
        wheelDebounceTime: 80        // ê¸°ë³¸ 40ms â†’ 80ms ë¡œ ìŠ¤í¬ë¡¤ ì¤Œ ë”œë ˆì´ ì¶”ê°€
    });
    
    // ğŸš© [ì¶”ê°€] ì¤Œ ì»¨íŠ¸ë¡¤ì„ ì™¼ìª½ í•˜ë‹¨ì— ì¶”ê°€
    L.control.zoom({
        position: 'bottomleft'
    }).addTo(map);
    
    // ğŸš© [ìˆ˜ì •] ë¹ˆí‹°ì§€ íƒ€ì¼ì…‹ìœ¼ë¡œ êµì²´ ë° baseMaps/overlayMaps ì •ì˜
    const baseMaps = {
        'ìœ„ì„±ëª¨ë“œ': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18,
            keepBuffer: 8,
            updateWhenIdle: false,
            updateInterval: 200,
            unloadInvisibleTiles: true,
            fadeAnimation: true,
            opacity: 1,
            transition: 'opacity 0.5s ease-in-out'
        }).on('tileerror', function(e) {
            console.warn('ğŸ—ºï¸ [ì§€ë„ íƒ€ì¼ ì˜¤ë¥˜] ìœ„ì„±ëª¨ë“œ íƒ€ì¼ ë¡œë”© ì‹¤íŒ¨:', e);
        }),
        'ë‹¤í¬ëª¨ë“œ': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'CartoDB Dark Matter',
            maxZoom: 18,
            keepBuffer: 8,
            updateWhenIdle: false,
            updateInterval: 200,
            unloadInvisibleTiles: true,
            fadeAnimation: true,
            opacity: 1,
            transition: 'opacity 0.5s ease-in-out'
        }).on('tileerror', function(e) {
            console.warn('ğŸ—ºï¸ [ì§€ë„ íƒ€ì¼ ì˜¤ë¥˜] ë‹¤í¬ëª¨ë“œ íƒ€ì¼ ë¡œë”© ì‹¤íŒ¨:', e);
        }),
        'ë¼ì´íŠ¸ëª¨ë“œ': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'CartoDB Positron',
            maxZoom: 18,
            keepBuffer: 8,
            updateWhenIdle: false,
            updateInterval: 200,
            unloadInvisibleTiles: true,
            fadeAnimation: true,
            opacity: 1,
            transition: 'opacity 0.5s ease-in-out'
        }).on('tileerror', function(e) {
            console.warn('ğŸ—ºï¸ [ì§€ë„ íƒ€ì¼ ì˜¤ë¥˜] ë¼ì´íŠ¸ëª¨ë“œ íƒ€ì¼ ë¡œë”© ì‹¤íŒ¨:', e);
        }),
        'ì¼ë°˜ëª¨ë“œ': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            keepBuffer: 8,
            updateWhenIdle: false,
            updateInterval: 200,
            unloadInvisibleTiles: true,
            fadeAnimation: true,
            opacity: 1,
            transition: 'opacity 0.5s ease-in-out'
        }).on('tileerror', function(e) {
            console.warn('ğŸ—ºï¸ [ì§€ë„ íƒ€ì¼ ì˜¤ë¥˜] ì¼ë°˜ëª¨ë“œ íƒ€ì¼ ë¡œë”© ì‹¤íŒ¨:', e);
        })
    };
    
    // ğŸš© [ì¶”ê°€] ì˜¤ë²„ë ˆì´ ë ˆì´ì–´ (ì—°ëŒ€í‘œ í† ê¸€ ì œê±°)
    const overlayMaps = {
        // 'ì—°ëŒ€í‘œ ë³´ê¸°' ì œê±°ë¨
    };
    
    // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ì»¨íŠ¸ë¡¤(ì§€ë„ ë³€ê²½ ìŠ¤ìœ„ì¹˜) ì¶”ê°€ - ìš°ì¸¡ ìƒë‹¨
    L.control.layers(baseMaps, overlayMaps, {
        position: 'topright',
        collapsed: true
    }).addTo(map);
    
    // ğŸš© [ì œê±°] ì—°ëŒ€í‘œ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (overlayMapsì—ì„œ ì œê±°ë¨)
    
    // ğŸš© [ìˆ˜ì •] ì°½ í¬ê¸° ë³€ê²½ ì‹œ timeline-control ìœ„ì¹˜ ì¡°ì • (timeline-sidebarëŠ” í•­ìƒ í‘œì‹œ)
    window.addEventListener('resize', function() {
        // timeline-sidebarëŠ” CSS ë¯¸ë””ì–´ ì¿¼ë¦¬ë¡œ ìë™ ì¡°ì •ë¨
        // timeline-control ìœ„ì¹˜ëŠ” CSSë¡œ ê³ ì •ë¨
    });
    
    // ğŸš© [ìˆ˜ì •] ê¸°ë³¸ ë ˆì´ì–´ë¥¼ ìœ„ì„±ëª¨ë“œë¡œ ë³€ê²½
    let currentTileLayer = baseMaps['ìœ„ì„±ëª¨ë“œ'];
    currentTileLayer.addTo(map);

    // ğŸš© [ì¶”ê°€] ì§€ë„ ì™¼ìª½ ì•„ë˜ì— ì¶•ì²™ ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    L.control.scale({ imperial: false }).addTo(map); // ë¯¸í„°ë²•(metric)ë§Œ í‘œì‹œ

    // ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ê¸° ë ˆì´ì–´ë¥¼ ìœ„í•œ ì „ìš© Pane ìƒì„±
    // zIndexë¥¼ ë‚®ê²Œ ì„¤ì •í•˜ì—¬ ë§ˆì»¤ ë“± ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ ì„ íƒì„ ë°©í•´í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
    map.createPane('drawingPane');
    map.getPane('drawingPane').style.zIndex = 450; // overlayPane(400)ë³´ë‹¤ ì•½ê°„ ìœ„, markerPane(600)ë³´ë‹¤ ì•„ë˜

    // ğŸš© [ì¶”ê°€] ì§€ëª…(label)ë§Œì„ ìœ„í•œ ìµœìƒìœ„ pane ìƒì„±
    if (!map.getPane('labelPane')) {
    map.createPane('labelPane');
    map.getPane('labelPane').style.zIndex = 700;
    }

    let castleLayerGroup = L.layerGroup().addTo(map); 
    let territoryLayerGroup = L.layerGroup().addTo(map); // ğŸš© [ì¶”ê°€] ì˜í†  í´ë¦¬ê³¤ ë ˆì´ì–´ ê·¸ë£¹
    let contributionLayerGroup = L.layerGroup().addTo(map); // ğŸš© [ì¶”ê°€] ê¸°ì—¬ ë ˆì´ì–´ ê·¸ë£¹
    let labelLayerGroup = L.layerGroup().addTo(map); // ğŸš© [ì¶”ê°€] ë¼ë²¨ ë ˆì´ì–´ ê·¸ë£¹

    // ğŸš© [ê³¼ì œ1 êµ¬í˜„] ê±°ì‹œ ëª¨ë“œ êµ­ê°€ëª… ë ˆì´ì–´ (zoom < 7 ì—ì„œ ì‚¬ìš©)
    let macroCountryLayer = L.layerGroup();
    let currentMacroMode = -1; // -1=ì´ˆê¸°í™” ì „, 0=ê±°ì‹œ, 1=ì¤‘ê°„, 2=ë¯¸ì‹œ

    // ğŸš€ [ìµœì í™”] ì˜í† ê°€ ì‹¤ì œ ë Œë”ë§ëœ êµ­ê°€ë§Œ ì¶”ì  (ê±°ì‹œ ëª¨ë“œ êµ­ê°€ëª… í‘œì‹œìš©)
    let _renderedCountryIds = new Set();           // updateMap ì˜í†  ë£¨í”„ì—ì„œ ìˆ˜ì§‘
    let _renderedCountryCentroids = new Map();     // country_id â†’ {lat, lng, count} ì˜í†  ì¤‘ì‹¬ì  ëˆ„ì 

    // ğŸš© [ê³¼ì œ1] ê±°ì‹œ ëª¨ë“œìš© êµ­ê°€ëª… Pane (ë§ˆì»¤ ìœ„ì— í‘œì‹œ)
    if (!map.getPane('macroLabelPane')) {
        map.createPane('macroLabelPane');
        map.getPane('macroLabelPane').style.zIndex = 650; // markerPane(600) ìœ„, labelPane(700) ì•„ë˜
    }

    /**
     * [ê³¼ì œ1 í•µì‹¬] ì¤Œ ë ˆë²¨ ê¸°ë°˜ ê±°ì‹œ/ë¯¸ì‹œ ëª¨ë“œ ì „í™˜ (LOD)
     * zoom < 6:   ê±°ì‹œ ëª¨ë“œ(0) â€” êµ­ê°€ëª…ë§Œ í‘œì‹œ          (ì•½ 300km+ ë·°)
     * zoom 6~<7:  ì¤‘ê°„ ëª¨ë“œ(1) â€” êµ­ê°€ëª… + ìˆ˜ë„ë§Œ í‘œì‹œ   (ì•½ 200km ë·°)
     * zoom >= 7:  ë¯¸ì‹œ ëª¨ë“œ(2) â€” êµ­ê°€ëª… + ìˆ˜ë„ + ëª¨ë“  ì„± í‘œì‹œ (ì•½ 100km ë·°)
     */
    function applyLODMode() {
        if (!map) return;
        const zoom = map.getZoom();
        const newMode = zoom < 6 ? 0 : zoom < 7 ? 1 : 2;

        // ëª¨ë“œ ë³€ê²½ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        if (newMode === currentMacroMode) return;
        currentMacroMode = newMode;

        console.log(`ğŸ”­ [LOD] ëª¨ë“œ ì „í™˜: ${['ê±°ì‹œ(êµ­ê°€ëª…ë§Œ)','ì¤‘ê°„(ìˆ˜ë„)','ë¯¸ì‹œ(ì „ì²´)'][newMode]} (zoom=${zoom})`);

        if (newMode === 0) {
            // ê±°ì‹œ ëª¨ë“œ: ì„¸ë¶€ ë§ˆì»¤ ëª¨ë‘ ìˆ¨ê¹€
            if (map.hasLayer(castleLayerGroup)) map.removeLayer(castleLayerGroup);
            if (map.hasLayer(labelLayerGroup)) map.removeLayer(labelLayerGroup);
        } else {
            // ì¤‘ê°„/ë¯¸ì‹œ ëª¨ë“œ: ì„¸ë¶€ ë§ˆì»¤ ë³µì› í›„ ì¬ë Œë”ë§
            if (!map.hasLayer(castleLayerGroup)) castleLayerGroup.addTo(map);
            if (!map.hasLayer(labelLayerGroup)) labelLayerGroup.addTo(map);

            const { year: curYear, month: curMonth } = typeof getCurrentYearMonth === 'function'
                ? getCurrentYearMonth()
                : { year: parseInt(yearInput?.value || 400), month: 1 };
            updateMap(curYear, curMonth, false, true);
        }
    }

    /**
     * êµ­ê°€ëª…ì„ ìˆ˜ë„(is_capital) ìœ„ì¹˜ì— ëŒ€í˜• í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ (ì¤Œ ë ˆë²¨ ë¬´ê´€, í•­ìƒ í‘œì‹œ)
     * - ìˆ˜ë„ê°€ ì—†ìœ¼ë©´ ì˜í†  ì¤‘ì‹¬ì  ì‚¬ìš©
     * - layerVisibility.countryLabelì´ falseë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
     */
    function renderMacroCountryNames() {
        macroCountryLayer.clearLayers();

        // layerVisibility.countryLabelì´ êº¼ì ¸ ìˆìœ¼ë©´ êµ­ê°€ëª… ë¹„í‘œì‹œ
        if (!layerVisibility.countryLabel) return;

        // ğŸš€ [í•µì‹¬] ì‹¤ì œ ì˜í† ê°€ ë Œë”ë§ëœ êµ­ê°€ë§Œ í‘œì‹œ (ëª¨ë“  êµ­ê°€ X)
        if (_renderedCountryIds.size === 0) return;

        const { year, month } = typeof getCurrentYearMonth === 'function' 
            ? getCurrentYearMonth() 
            : { year: parseInt(yearInput?.value || 400), month: 1 };

        // êµ­ê°€ëª… í°íŠ¸ í¬ê¸° ê³ ì • (ì¤Œ ë ˆë²¨ ë¬´ê´€)
        const countryFontSize = 14;

        // ë Œë”ë§ëœ êµ­ê°€ë³„ ë¼ë²¨ ìœ„ì¹˜ ê²°ì •
        // ìš°ì„ ìˆœìœ„: â‘  ìˆ˜ë„ ì¢Œí‘œ â†’ â‘¡ ì˜í†  ì¤‘ì‹¬ì (centroid)
        const currentTotalMonths = yearMonthToTotalMonths(year, month);

        // ìˆ˜ë„ ì¸ë±ìŠ¤ (ë Œë”ë§ëœ êµ­ê°€ë§Œ)
        const capitalByCountry = new Map();
        castles.forEach(c => {
            if (!c.lat || !c.lng || !c.country_id) return;
            if (!_renderedCountryIds.has(c.country_id)) return;
            if (c.is_capital) {
                const info = getActiveHistoryInfo(c.history, currentTotalMonths);
                if (info && !capitalByCountry.has(c.country_id)) {
                    capitalByCountry.set(c.country_id, c);
                }
            }
        });

        let labelCount = 0;

        _renderedCountryIds.forEach(countryId => {
            const country = getCountryInfoById(countryId);
            if (!country) return;

            // ë¯¼ì¡± í•„í„° ì ìš©
            if (selectedEthnicity !== 'all') {
                if (!country.ethnicity || !country.ethnicity.includes(selectedEthnicity)) return;
            }

            let labelLat, labelLng;

            // â‘  ìˆ˜ë„ ì¢Œí‘œ ìš°ì„ 
            const capital = capitalByCountry.get(countryId);
            if (capital) {
                labelLat = capital.lat;
                labelLng = capital.lng;
            }

            // â‘¡ ìˆ˜ë„ê°€ ì—†ìœ¼ë©´ ì˜í†  ì¤‘ì‹¬ì (centroid) ì‚¬ìš©
            if (!labelLat && _renderedCountryCentroids.has(countryId)) {
                const c = _renderedCountryCentroids.get(countryId);
                labelLat = c.lat / c.count;
                labelLng = c.lng / c.count;
            }

            if (!labelLat || !labelLng) return;

            const countryColor = country.color || '#ffffff';
            const flagHtmlMacro = country.flag
                ? `<img src="${country.flag}" class="country-flag-img" style="width:18px;height:12px;margin-right:4px;vertical-align:middle;border:0.5px solid rgba(255,255,255,0.3);">`
                : '';
            const icon = L.divIcon({
                className: 'macro-country-label-icon',
                html: `<div class="macro-country-name" style="color: ${countryColor}; font-size: ${countryFontSize}px; display:flex; align-items:center;">${flagHtmlMacro}${country.name}</div>`,
                iconSize: [200, 40],
                iconAnchor: [100, 20]
            });

            L.marker([labelLat, labelLng], { 
                icon: icon, 
                interactive: false,
                pane: 'macroLabelPane'
            }).addTo(macroCountryLayer);

            labelCount++;
        });

        console.log(`  âœ… êµ­ê°€ëª… ${labelCount}ê°œ ë Œë”ë§`);
    }

    // ğŸš© [ê³¼ì œ1] zoomend ì´ë²¤íŠ¸ì— LOD ëª¨ë“œ ì „í™˜ ì—°ê²°
    map.on('zoomend', applyLODMode);

    // ğŸš© [ì¶”ê°€] zoomend ì‹œ ê°™ì€ ëª¨ë“œ ë‚´ ì¤Œ ë³€ê²½ ì‹œ ë§ˆì»¤ ì¬ë Œë”ë§ (êµ­ê°€ëª…ì€ updateMap ë‚´ë¶€ì—ì„œ ê°±ì‹ )
    map.on('zoomend', () => {
        // ê°™ì€ LOD ëª¨ë“œ ì•ˆì—ì„œ ì¤Œì´ ë°”ë€Œë©´ applyLODModeê°€ ìŠ¤í‚µë˜ë¯€ë¡œ
        // ë¯¸ì‹œ/ì¤‘ê°„ ëª¨ë“œì—ì„œ ë·°í¬íŠ¸ê°€ ë°”ë€ ë§ˆì»¤ë¥¼ ì§ì ‘ ì¬ë Œë”ë§
        if (currentMacroMode !== 0) {
            clearTimeout(window._zoomendMarkerTimer);
            window._zoomendMarkerTimer = setTimeout(() => {
                const { year, month } = typeof getCurrentYearMonth === 'function'
                    ? getCurrentYearMonth()
                    : { year: parseInt(yearInput?.value || 400), month: 1 };
                updateMap(year, month, false, true);
            }, 200);
        } else {
            // ê±°ì‹œ ëª¨ë“œ: ë§ˆì»¤ ì—†ì´ êµ­ê°€ëª…ë§Œ ì¬ë Œë”ë§ (í°íŠ¸ í¬ê¸° ë³€ê²½ ë°˜ì˜)
            if (layerVisibility.countryLabel) renderMacroCountryNames();
        }
    });

    map.addLayer(drawnItems); // ğŸš© [ì¶”ê°€] ê·¸ë¦° ë„í˜•ì„ ë‹´ì„ ë ˆì´ì–´ ê·¸ë£¹ ì¶”ê°€
    const combinedSlider = document.getElementById('combinedSlider'); // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” DOM ìš”ì†Œ
    const eraLabel = document.getElementById('eraLabel'); // ğŸš© [ì¶”ê°€] B.C./A.D. í‘œì‹œ ë¼ë²¨
    const yearLabel = document.getElementById('yearLabel');
    const ganjiLabel = document.getElementById('ganjiLabel'); // ğŸš© [ìˆ˜ì •] ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë³€ìˆ˜ ì œê±°
    const monthLabel = document.getElementById('monthLabel'); // ğŸš© [ìˆ˜ì •] ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë³€ìˆ˜ ì œê±°
    const yearInput = document.getElementById('yearInput');
    const sliderTicks = document.getElementById('sliderTicks');
    const castleForm = document.getElementById('castleForm');
    const addCastleForm = document.getElementById('addCastleForm');
    const searchInput = document.getElementById('mapSearchInput'); // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ì°½
    const searchBtn = document.getElementById('mapSearchBtn'); // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ ë²„íŠ¼
    // const openHistoryFormBtn = document.getElementById('openHistoryFormBtn'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
    const countrySelectForEdit = document.getElementById('countrySelectForEdit');
    // const prevHistoryBtn = document.getElementById('prevHistoryBtn'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
    // const nextHistoryBtn = document.getElementById('nextHistoryBtn'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
    const kingCountrySelectForForm = document.getElementById('kingCountryName');
    const kingSelect = document.getElementById('kingSelect');
    
    // ğŸš© [ì¶”ê°€] ì„±/ìœ„ì¹˜ í¼ ë‚´ êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ì‚¬ìš©)
    // ì„±/ìœ„ì¹˜ í¼ ë‚´ ì²´í¬ë°•ìŠ¤ ë° ìƒì„¸ ì •ë³´
    const layerToggles = document.getElementById('layer-toggles');
    const militaryFlagDetails = document.getElementById('militaryFlagDetails');
    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° DOM ìš”ì†Œ
    const militaryCountryNameInput = document.getElementById('militaryCountryNameInput');
    const militaryCountrySelect = document.getElementById('militaryCountrySelect');
    const castleHistorySection = document.getElementById('castleHistorySection');
    const simpleDateSection = document.getElementById('simpleDateSection');
    const castleDescRow = document.getElementById('castleDesc').closest('.form-row');
    const castlePhotoRow = document.getElementById('castlePhoto').closest('.form-row');

    const markerTypeSelector = document.getElementById('markerTypeSelector');

// ğŸš© ìˆ˜ì •: ìƒˆë¡œ ì¶”ê°€ëœ êµ°ëŒ€ ê´€ë ¨ ì…ë ¥ í•„ë“œ ë§µí•‘
const generalNameInput = document.getElementById('generalName');
const troopCountInput = document.getElementById('troopCount');
const generalPhotoInput = document.getElementById('generalPhoto'); // 1ë‹¨ê³„ì—ì„œ ì¶”ê°€í•œ í•„ë“œ


    const pathDataSection = document.getElementById('pathDataSection'); 
    const pathDataList = document.getElementById('pathDataList'); 
    
    // ğŸš© [ì¶”ê°€] ì¬ìƒ ê´€ë ¨ DOM ìš”ì†Œ ë§µí•‘
    const timeLabelDisplay = document.getElementById('timeLabelDisplay'); 
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const playbackSpeedSlider = document.getElementById('playbackSpeedSlider');
    const speedDisplay = document.getElementById('speedDisplay'); // ì†ë„ ë””ìŠ¤í”Œë ˆì´ ë§µí•‘
    // ğŸš© NEW: ìì—° ì§€ë¬¼ ê´€ë ¨ DOM ìš”ì†Œ ë§µí•‘
    const isNaturalFeature = document.getElementById('isNaturalFeature');
    const naturalFeatureDetails = document.getElementById('naturalFeatureDetails');
    const naturalFeatureType = document.getElementById('naturalFeatureType');

    // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ DOM ìš”ì†Œ
    const eventOverlay = document.getElementById('event-overlay');
    const eventOverlayImage = document.getElementById('event-overlay-image');
    const eventOverlayVideo = document.getElementById('event-overlay-video');
    const eventOverlayText = document.getElementById('event-overlay-text');

    // ğŸš© [ì¶”ê°€] í¼ì„ ì—´ê³  í™”ë©´ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚¤ëŠ” í•¨ìˆ˜
    function openForm(formId) {
        const form = document.getElementById(formId);
        if (!form) return;

        form.style.display = 'block';

        // í¼ì„ ë·°í¬íŠ¸ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚µë‹ˆë‹¤.
        const formHeight = form.offsetHeight;
        const windowHeight = window.innerHeight;
        const topPosition = Math.max(20, (windowHeight - formHeight) / 2); // ìƒë‹¨ì— ìµœì†Œ 20px ì—¬ë°±
        form.style.top = `${topPosition}px`;
    }

    // ğŸ—‘ï¸ íœ´ì§€í†µ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    async function openTrashModal() {
        const trashModal = document.getElementById('trashModal');
        const trashContent = document.getElementById('trashContent');

        if (!trashModal || !trashContent) return;

        // ë¡œë”© í‘œì‹œ
        trashContent.innerHTML = '<div style="text-align: center; color: #95a5a6; padding: 40px;">íœ´ì§€í†µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        // ëª¨ë‹¬ í‘œì‹œ
        trashModal.style.display = 'block';

        try {
            // íœ´ì§€í†µ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const response = await fetch(`${API_BASE_URL}/castle/trash`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (handleApiError(response)) return;

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const trashItems = await response.json();

            if (trashItems.length === 0) {
                trashContent.innerHTML = '<div style="text-align: center; color: #95a5a6; padding: 40px;">íœ´ì§€í†µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // íœ´ì§€í†µ ì•„ì´í…œ í‘œì‹œ
            const itemsHtml = trashItems.map(item => {
                const deletedDate = item.deletedAt ? new Date(item.deletedAt).toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                return `
                    <div style="border: 1px solid #5d7185; margin: 10px 0; padding: 15px; border-radius: 8px; background: rgba(255,255,255,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #f39c12;">${item.name || 'ì´ë¦„ ì—†ìŒ'}</h4>
                            <div>
                                <button onclick="restoreCastle('${item._id}')" style="background: #27ae60; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px;">ë³µì›</button>
                                <button onclick="permanentDeleteCastle('${item._id}', '${item.name || 'ì´ë¦„ ì—†ìŒ'}')" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ì˜êµ¬ ì‚­ì œ</button>
                            </div>
                        </div>
                        <div style="color: #bdc3c7; font-size: 12px; margin-bottom: 8px;">
                            ì‚­ì œì¼: ${deletedDate}
                        </div>
                        <div style="color: #ecf0f1; font-size: 13px;">
                            ${item.desc ? item.desc.substring(0, 100) + (item.desc.length > 100 ? '...' : '') : 'ì„¤ëª… ì—†ìŒ'}
                        </div>
                    </div>
                `;
            }).join('');

            trashContent.innerHTML = itemsHtml;

        } catch (error) {
            console.error('íœ´ì§€í†µ ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
            trashContent.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 40px;">íœ´ì§€í†µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ğŸ—‘ï¸ ì„± ë³µì› í•¨ìˆ˜
    async function restoreCastle(castleId) {
        if (!confirm('ì´ ì„±/ì „ì¥ ì •ë³´ë¥¼ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/castle/${castleId}/restore`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (handleApiError(response)) return;

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            alert(result.message || 'ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
            await openTrashModal();

            // ì§€ë„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (í•„ìš”ì‹œ)
            await loadCastles();

        } catch (error) {
            console.error('ì„± ë³µì› ì¤‘ ì˜¤ë¥˜:', error);
            alert(`ì„± ë³µì› ì‹¤íŒ¨: ${error.message}`);
        }
    }

    // ğŸ—‘ï¸ ì„± ì˜êµ¬ ì‚­ì œ í•¨ìˆ˜
    async function permanentDeleteCastle(castleId, castleName) {
        if (!confirm(`"${castleName}"ì„(ë¥¼) ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) return;

        try {
            const response = await fetch(`${API_BASE_URL}/castle/${castleId}/permanent`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (handleApiError(response)) return;

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            alert(result.message || 'ì˜êµ¬ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
            await openTrashModal();

        } catch (error) {
            console.error('ì„± ì˜êµ¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
            alert(`ì„± ì˜êµ¬ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    // --- 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
    
    /** êµ­ê°€ ì´ë¦„ìœ¼ë¡œ êµ­ê°€ ì •ë³´ë¥¼ ì°¾ìŠµë‹ˆë‹¤. */
    function getCountryInfo(name) {
      return countries.find(c => c.name === name);
    }

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì‹œê°„ ê³„ì‚° ë¡œì§ì„ 'ì´ ì›”ìˆ˜' ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½

    /**
     * ì—°ë„ì™€ ì›”ì„ 'ì´ ì›”ìˆ˜'ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (AD 1ë…„ 1ì›” = 0)
     * @param {number} year - ì—°ë„ (BCëŠ” ìŒìˆ˜)
     * @param {number} month - ì›” (1-12)
     * @returns {number} ì´ ì›”ìˆ˜
     */
    function yearMonthToTotalMonths(year, month) {
        // 0ë…„ì€ ì—†ìœ¼ë¯€ë¡œ, BC 1ë…„(year=-1)ì€ AD 1ë…„(year=1) ë°”ë¡œ ì´ì „ ì‹œê°„ì…ë‹ˆë‹¤.
        // AD: (year - 1) * 12
        // BC: year * 12 (ì˜ˆ: -1ë…„ì€ -12ë¶€í„° ì‹œì‘)
        const baseMonths = year >= 1 ? (year - 1) * 12 : year * 12;
        return baseMonths + (month - 1);
    }

    /**
     * 'ì´ ì›”ìˆ˜'ë¥¼ ì—°ë„ì™€ ì›” ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * @param {number} totalMonths - ì´ ì›”ìˆ˜
     * @returns {{year: number, month: number}} ì—°ë„ì™€ ì›”
     */
    // ğŸš© [ì¶”ê°€] ì—­ì‚¬ì  ì‚¬ê±´ ë°ì´í„° (ê³ ë ¤ ì¤‘ì‹¬ì˜ ì£¼ìš” ì‚¬ê±´ë“¤)
    const historicalEvents = [
        { year: -57, month: 1, title: "ì‹ ë¼ ê±´êµ­", description: "ë°•í˜ê±°ì„¸ê°€ ì‹ ë¼ë¥¼ ê±´êµ­í•œ í•´. ëŒ€ë¥™ ì‹ ë¼ì˜ ì‹œì‘ì ìœ¼ë¡œ ì‚°ë‘¥ ë°˜ë„ ê°•ì—­ì´ ê°•ì¡°ë©ë‹ˆë‹¤.", category: "foundation" },
        { year: 18, month: 1, title: "ê³ êµ¬ë ¤ ëŒ€ì„±ì‚°ì„± ì „íˆ¬", description: "ê³ êµ¬ë ¤ê°€ í•œë‚˜ë¼ êµ°ëŒ€ë¥¼ ê²©íŒŒí•œ ëŒ€ìŠ¹ë¦¬. ìš”ë™ ì§€ì—­ ê°•ì—­ í™•ì¥.", category: "battle" },
        { year: 668, month: 1, title: "ì‚¼êµ­í†µì¼", description: "ì‹ ë¼ê°€ ë‹¹ë‚˜ë¼ì˜ ë„ì›€ìœ¼ë¡œ ê³ êµ¬ë ¤ì™€ ë°±ì œë¥¼ ë©¸ë§ì‹œí‚¤ê³  í•œë°˜ë„ë¥¼ í†µì¼.", category: "unification" },
        { year: 918, month: 6, title: "ê³ ë ¤ ê±´êµ­", description: "ì™•ê±´ì´ í›„ê³ êµ¬ë ¤ë¥¼ ê°œì¹­í•˜ì—¬ ê³ ë ¤ë¥¼ ê±´êµ­. ëŒ€ë¥™ ê°•ì—­ì˜ ìƒˆë¡œìš´ ì‹œì‘.", category: "foundation" },
        { year: 936, month: 1, title: "í›„ì‚¼êµ­ í†µì¼", description: "ê³ ë ¤ê°€ í›„ë°±ì œë¥¼ ì •ë²Œí•˜ê³  í•œë°˜ë„ë¥¼ ì¬í†µì¼. ì™•ê±´ì˜ ëŒ€ì—… ì™„ì„±.", category: "unification" },
        { year: 1018, month: 1, title: "ê°•ê°ì°¬ì˜ ê·€ì£¼ëŒ€ì²©", description: "ê³ ë ¤ ì¥êµ° ê°•ê°ì°¬ì´ ê±°ë€ ì¹¨ëµì„ ë¬¼ë¦¬ì¹œ ëŒ€ìŠ¹ë¦¬. í•´ì „ì˜ ì „ì„¤.", category: "battle" },
        { year: 1170, month: 1, title: "ë¬´ì‹ ì •ë³€", description: "ë¬´ì‹ ë“¤ì´ ì™•ê¶Œì„ ì¥ì•…í•œ ì •ë³€. ê³ ë ¤ì˜ êµ°ì‚¬ì •ê¶Œ ì‹œëŒ€ ì‹œì‘.", category: "political" },
        { year: 1231, month: 1, title: "ëª½ê³¨ ì¹¨ëµ ì‹œì‘", description: "ëª½ê³¨êµ°ì˜ ê³ ë ¤ ì¹¨ëµì´ ë³¸ê²©í™”. 30ë…„ í•­ìŸì˜ ì‹œì‘.", category: "invasion" },
        { year: 1270, month: 1, title: "ì› ê°„ì„­ê¸° ì‹œì‘", description: "ê³ ë ¤ê°€ ëª½ê³¨(ì›)ì˜ ê°„ì„­ì„ ë°›ê¸° ì‹œì‘. ê°•ì—­ì´ ì¶•ì†Œë˜ëŠ” ì‹œê¸°.", category: "foreign" },
        { year: 1356, month: 1, title: "ê³µë¯¼ì™• ì¦‰ìœ„", description: "ê³µë¯¼ì™•ì´ ì¦‰ìœ„í•˜ì—¬ ê°œí˜ì„ ì¶”ì§„. ê³ ë ¤ ë§ê¸°ì˜ ê°œí˜ ì‹œë„.", category: "political" },
        { year: 1392, month: 1, title: "ì¡°ì„  ê±´êµ­", description: "ì´ì„±ê³„ê°€ ê³ ë ¤ë¥¼ ë©¸ë§ì‹œí‚¤ê³  ì¡°ì„ ì„ ê±´êµ­. ê³ ë ¤ ì‹œëŒ€ì˜ ì¢…ê²°.", category: "transition" }
    ];

    function totalMonthsToYearMonth(totalMonths) {
        const year = totalMonths >= 0 ? Math.floor(totalMonths / 12) + 1 : Math.floor(totalMonths / 12);
        const month = (totalMonths % 12 + 12) % 12 + 1;
        // 0ë…„ì€ ì—†ìœ¼ë¯€ë¡œ, ê³„ì‚°ëœ yearê°€ 0ì´ë©´ -1(BC 1ë…„)ë¡œ ì¡°ì •í•©ë‹ˆë‹¤.
        return { year: year === 0 ? -1 : year, month };
    }

    function normalizeHistoryNumber(value, fallback) {
        if (value === undefined || value === null || value === '') return fallback;
        const parsed = parseInt(value, 10);
        return Number.isNaN(parsed) ? fallback : parsed;
    }

    function sortHistoryByStart(historyList) {
        if (!Array.isArray(historyList)) return [];
        return [...historyList].sort((a, b) => {
            const aYear = normalizeHistoryNumber(a?.start_year, Number.MAX_SAFE_INTEGER);
            const bYear = normalizeHistoryNumber(b?.start_year, Number.MAX_SAFE_INTEGER);
            if (aYear !== bYear) return aYear - bYear;

            const aMonth = normalizeHistoryNumber(a?.start_month, 1);
            const bMonth = normalizeHistoryNumber(b?.start_month, 1);
            return aMonth - bMonth;
        });
    }

    /**
     * ì£¼ì–´ì§„ ì´ ì›”ìˆ˜ ì‹œì ì— í•´ë‹¹í•˜ëŠ” ì—­ì‚¬ ê¸°ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
     * ë°°ì—´ì˜ ë’¤ì— ìˆëŠ” ë ˆì½”ë“œê°€ ìš°ì„ ë˜ë„ë¡ ì—­ìˆœìœ¼ë¡œ íƒìƒ‰í•©ë‹ˆë‹¤.
     * @param {Array} historyList - ì„±/ë„ì‹œì˜ ì—­ì‚¬ ê¸°ë¡ ë°°ì—´
     * @param {number} currentTotalMonths - ë¹„êµí•  ì´ ì›”ìˆ˜ ê°’
     * @returns {{record: object, startYear: number, startMonth: number, endYear: number|null, endMonth: number, startTotalMonths: number, endTotalMonths: number}|null}
     */
    function getActiveHistoryInfo(historyList, currentTotalMonths) {
        if (!Array.isArray(historyList) || historyList.length === 0) return null;

        for (let index = historyList.length - 1; index >= 0; index--) {
            const record = historyList[index];
            if (!record) continue;

            const startYear = normalizeHistoryNumber(record.start_year, -5000);
            const startMonth = normalizeHistoryNumber(record.start_month, 1);
            const startTotalMonths = yearMonthToTotalMonths(startYear, startMonth);

            const hasEndYear = !(record.end_year === undefined || record.end_year === null || record.end_year === '');
            const endYear = hasEndYear ? normalizeHistoryNumber(record.end_year, null) : null;
            const endMonth = hasEndYear ? normalizeHistoryNumber(record.end_month, 12) : 12;
            const endTotalMonths = hasEndYear && endYear !== null
                ? yearMonthToTotalMonths(endYear, endMonth)
                : Infinity;

            if (currentTotalMonths >= startTotalMonths && currentTotalMonths <= endTotalMonths) {
                return {
                    record,
                    startYear,
                    startMonth,
                    endYear,
                    endMonth,
                    startTotalMonths,
                    endTotalMonths
                };
            }
        }

        return null;
    }


    /** ì—°ë„ì™€ ì›”ì„ ë°›ì•„ 60ê°‘ì(ê°„ì§€)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
    function getGanji(year, month) {
        const gan = ["ê°‘", "ì„", "ë³‘", "ì •", "ë¬´", "ê¸°", "ê²½", "ì‹ ", "ì„", "ê³„"];
        const ji = ["ì", "ì¶•", "ì¸", "ë¬˜", "ì§„", "ì‚¬", "ì˜¤", "ë¯¸", "ì‹ ", "ìœ ", "ìˆ ", "í•´"];

        const baseYear = 1804;
        const baseGanIndex = 0; 
        const baseJiIndex = 0; 

        const diff = year - baseYear;

        const ganIndex = (baseGanIndex + diff) % 10;
        const jiIndex = (baseJiIndex + diff) % 12;

        return `${gan[ganIndex < 0 ? ganIndex + 10 : ganIndex]}${ji[jiIndex < 0 ? jiIndex + 12 : jiIndex]}ë…„`;
    }
    

    /** íŠ¹ì • ì—°ë„ì— ì¬ìœ„ ì¤‘ì¸ ì™• ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. */
function getKingByYear(countryName, year, month) {
  // ğŸš© ìˆ˜ì •: êµ­ê°€ ì´ë¦„ìœ¼ë¡œ í•´ë‹¹ êµ­ê°€ì˜ ObjectIdë¥¼ ì°¾ìŠµë‹ˆë‹¤.
  const country = getCountryInfo(countryName);
  if (!country) return null;
  const kingKey = country._id; // <- ObjectIdë¥¼ í‚¤ë¡œ ì‚¬ìš©
  const list = kings[kingKey];
      
      if (!list) return null;
      return list.find(k => {
        const startCombined = yearMonthToTotalMonths(k.start, k.start_month);
        const endCombined = (k.end === null || k.end === undefined || isNaN(k.end)) 
                            ? Infinity 
                            : yearMonthToTotalMonths(k.end, k.end_month);
        const currentCombined = yearMonthToTotalMonths(year, month);

        return startCombined <= currentCombined && currentCombined < endCombined;
      });
    }

    /** í˜„ì¬ ì—°ë„ì™€ ì›”ì˜ ì™• ì •ë³´ë¥¼ íŒ¨ë„ì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. */
    function updateKingLabel(year, month) {
      console.log(`ğŸ” [ì™• íŒ¨ë„] updateKingLabel í˜¸ì¶œ: ${year}ë…„ ${month}ì›”, kings ê°œìˆ˜: ${Object.keys(kings).length}`);
      let html = "";
      countries.forEach(country => { // ğŸš© [ìˆ˜ì •] ë¶ˆí•„ìš”í•œ ê´„í˜¸ ì œê±°
        const king = getKingByYear(country.name, year, month); // <-- THIS LINE WAS MISSING OR MISPLACED
       if (king) { // <-- Now the 'if' statement works because 'king' is defined
            // ğŸš© [ë””ë²„ê·¸] ì™• ë°ì´í„° í™•ì¸
            if (king.name === 'íƒœì¡°' || king.name === 'ê´‘ê°œí† ì™•') {
                console.log('ì™• ë°ì´í„° í™•ì¸:', king.name, 'summary:', king.summary);
            }
            
            const startMonth = king.start_month || 1;
            const endMonth = king.end_month || 12;
            const endYearText = king.end === null ? 'í˜„ì¬' : `${king.end}ë…„ ${endMonth}ì›”`; 
            const period = `${king.start}ë…„ ${startMonth}ì›” ~ ${endYearText}`;
            let iconHtml;
            const countryColor = country.color || 'gray'; 

            if (country.flag) {
                iconHtml = `<img src="${country.flag}" class="country-flag-img" style="width: 18px; height: 12px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;">`;
            } else {
                iconHtml = `<span style="color:${countryColor}; style="width: 18px; height: 12px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;"">â–£</span>`;
            }

            // ğŸš© í•œì¤„í‰ì„ HTML ì†ì„±ì— ì•ˆì „í•˜ê²Œ í‘œì‹œ (ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„)
            const kingSummary = (king.summary || 'í•œì¤„í‰ ì—†ìŒ').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            let kingHtml = `${iconHtml} <b><span class="country-name-link" style="cursor: pointer; text-decoration: underline;" onclick="zoomToCountryCapital('${country._id}')">${country.name}</span></b>: <span class="king-name" style="cursor: help;" title="${kingSummary}">${king.name}</span> (${period})`;

            html += `<div class="king-item">${kingHtml}</div>`;
        }
    });
    const kingContent = html || "í•´ë‹¹ ì—°ë„ ì™• ì •ë³´ ì—†ìŒ";
    console.log(`ğŸ” [ì™• íŒ¨ë„] kingContent ê¸¸ì´: ${kingContent.length}, ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: ${kingContent.substring(0, 100)}`);
    // document.getElementById('kingList').innerHTML = kingContent; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°ë¡œ ë¹„í™œì„±í™”
    // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ ì™• ëª©ë¡ íŒ¨ë„ë§Œ ì—…ë°ì´íŠ¸
    const mapKingList = document.getElementById('map-king-list');
    if (mapKingList) {
        mapKingList.innerHTML = kingContent;
        console.log(`âœ… [ì™• íŒ¨ë„] map-king-list ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
    } else {
        console.warn('âš ï¸ [ì™• íŒ¨ë„] map-king-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}
    
    /** êµ­ê°€ì˜ ìˆ˜ë„ë¡œ ì§€ë„ë¥¼ í™•ëŒ€/ì´ë™í•˜ëŠ” í•¨ìˆ˜ */
    window.zoomToCountryCapital = function(countryId) {
        // í•´ë‹¹ êµ­ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const country = countries.find(c => c._id === countryId);
        if (!country) return;
        
        // í˜„ì¬ ì‹œì  ê°€ì ¸ì˜¤ê¸°
        const { year, month } = getCurrentYearMonth();
        const currentTotalMonths = yearMonthToTotalMonths(year, month);
        
        // í•´ë‹¹ êµ­ê°€ì˜ ìˆ˜ë„(is_capital: true) ì°¾ê¸°
        const capital = castles.find(castle => 
            castle.country_id === countryId && 
            castle.is_capital === true &&
            castle.lat && castle.lng
        );
        
        if (capital) {
            // ìˆ˜ë„ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
            map.setView([capital.lat, capital.lng], 8, { animate: true, duration: 1 });
        } else {
            // ìˆ˜ë„ê°€ ì—†ìœ¼ë©´ í•´ë‹¹ êµ­ê°€ì˜ ì²« ë²ˆì§¸ ì„±/ë„ì‹œë¡œ ì´ë™
            const firstCity = castles.find(castle => 
                castle.country_id === countryId && 
                castle.lat && castle.lng
            );
            if (firstCity) {
                map.setView([firstCity.lat, firstCity.lng], 8, { animate: true, duration: 1 });
            }
        }
    };
    
    /** * path_dataì™€ í˜„ì¬ ì‹œì ì„ ë°”íƒ•ìœ¼ë¡œ êµ°ëŒ€ì˜ ë³´ê°„ëœ ìœ„ì¹˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. */
    function getMilitaryPosition(pathData, currentCombined) {
        if (!pathData || pathData.length < 2) return null; 

        const currentTotalMonths = currentCombined;

        for (let i = 1; i < pathData.length; i++) {
            const startPoint = pathData[i - 1];
            const endPoint = pathData[i];

            const startTotalMonths = yearMonthToTotalMonths(startPoint.target_year, startPoint.target_month);
            const endTotalMonths = yearMonthToTotalMonths(endPoint.target_year, endPoint.target_month);
            
            if (startTotalMonths <= currentTotalMonths && currentTotalMonths < endTotalMonths) {
                const totalMonths = endTotalMonths - startTotalMonths;
                if (totalMonths <= 0) continue; 
                
                const monthsPassed = currentTotalMonths - startTotalMonths;
                
                let progress = monthsPassed / totalMonths;
                if (progress > 1) progress = 1; 

                const lat = startPoint.lat + (endPoint.lat - startPoint.lat) * progress;
                const lng = startPoint.lng + (endPoint.lng - startPoint.lng) * progress;
                
                return { lat: lat, lng: lng }; 
            }
        }
        
        if (pathData.length > 0) {
            const firstPoint = pathData[0];
            const lastPoint = pathData[pathData.length - 1];
            const firstTotalMonths = yearMonthToTotalMonths(firstPoint.target_year, firstPoint.target_month);
            const lastTotalMonths = yearMonthToTotalMonths(lastPoint.target_year, lastPoint.target_month);
            
            if (currentTotalMonths >= lastTotalMonths) {
                return { lat: lastPoint.lat, lng: lastPoint.lng };
            }
            if (currentTotalMonths < firstTotalMonths) {
                return { lat: firstPoint.lat, lng: firstPoint.lng };
            }
        }

        return null; 
    }

    /** í™œì„±í™”ëœ í¼ì„ ì œì™¸í•œ ëª¨ë“  í¼ì„ ë‹«ìŠµë‹ˆë‹¤. (ë™ì¼) */
    function closeAllFormsExcept(exceptId) {
        ['castleForm', 'historyForm', 'countryForm', 'kingForm', 'eventForm', 'drawingForm', 'editCitySelectionForm'].forEach(id => {
            if (id !== exceptId) {
                const el = document.getElementById(id);
                if (el) el.style.display = "none";
            }
        });
    }

        /** ìì—° ì§€ë¬¼ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ì‹¬ë³¼ê³¼ í´ë˜ìŠ¤ ë§¤í•‘ (NEW) */
    function getNaturalFeatureIcon(type) {
        const icons = {
            'mountain': { symbol: 'â§Š', className: 'feature-mountain' }, // ì‚°
            'sea': { symbol: 'â™’ï¸', className: 'feature-sea' }, // ë°”ë‹¤/í˜¸ìˆ˜
            'river': { symbol: 'ğŸ›¶', className: 'feature-river' }, // ê°•/ë‚´ë¥™
            'mudflat': { symbol: 'ğŸ•³ï¸', className: 'feature-mudflat' }, // ë»˜/ëŠª (ê°ˆìƒ‰ ì›)
            'buffalo': { symbol: 'ğŸƒ', className: 'feature-other' },
            'horse': { symbol: 'ğŸ', className: 'feature-other' },
            'camel': { symbol: 'ğŸ«', className: 'feature-other' },
            'mongky': { symbol: 'ğŸ’', className: 'feature-other' },
            'hunting': { symbol: 'ğŸ¹', className: 'feature-hunting' },
            'construction': { symbol: 'âš’ï¸', className: 'feature-construction' },
            'other': { symbol: 'â–', className: 'feature-other' }
        };
        return icons[type] || icons['other'];
    }

/** ì—°ë„/ì›”ì— í•´ë‹¹í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì°¾ì•„ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
    function checkAndDisplayEvent(year, month) {
        // ğŸš© [ìˆ˜ì •] í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤ ì´ì „ì˜ ì´ë²¤íŠ¸ í‘œì‹œ íƒ€ì´ë¨¸ë¥¼ í•­ìƒ ì·¨ì†Œí•©ë‹ˆë‹¤.
        if (eventDisplayTimeout) clearTimeout(eventDisplayTimeout);

        // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ë ˆì´ì–´ê°€ ë¹„í™œì„±í™” ìƒíƒœì´ë©´, ì¦‰ì‹œ ìˆ¨ê¸°ê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
        if (!layerVisibility.event) {
            eventOverlay.classList.remove('visible');
            // ğŸš© [ì¶”ê°€] ì´ë²¤íŠ¸ ë ˆì´ì–´ê°€ ë¹„í™œì„±í™”ë˜ë©´, ìˆ¨ê¹€ íƒ€ì´ë¨¸ë„ ì·¨ì†Œí•˜ê³  nullë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
            if (eventDisplayTimeout) {
                clearTimeout(eventDisplayTimeout);
                eventDisplayTimeout = null;
            }
            return;
        }

        const currentEvent = events.find(e => e.year === year && (e.month ?? 1) === month);

        if (currentEvent) {
            // ğŸš© [í•µì‹¬ ìˆ˜ì •] setTimeoutì„ ì‚¬ìš©í•œ ê¹œë¹¡ì„ íš¨ê³¼ë¥¼ ì œê±°í•˜ê³ , ì§ì ‘ DOMì„ ì¡°ì‘í•˜ì—¬ ë Œë”ë§ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.
            eventOverlayText.textContent = currentEvent.text;
            
            // ğŸš© [ì¶”ê°€] URLì´ ë¹„ë””ì˜¤ì¸ì§€ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸í•˜ì—¬ ì ì ˆí•˜ê²Œ í‘œì‹œ
            if (currentEvent.photo) {
                const url = currentEvent.photo.toLowerCase();
                const isVideo = url.includes('youtube.com') || url.includes('youtu.be') || 
                                url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.ogg');
                
                if (isVideo) {
                    // YouTube URLì¸ ê²½ìš° embed í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    let videoSrc = currentEvent.photo;
                    if (url.includes('youtube.com/watch?v=')) {
                        const videoId = currentEvent.photo.split('v=')[1].split('&')[0];
                        videoSrc = `https://www.youtube.com/embed/${videoId}`;
                    } else if (url.includes('youtu.be/')) {
                        const videoId = currentEvent.photo.split('youtu.be/')[1].split('?')[0];
                        videoSrc = `https://www.youtube.com/embed/${videoId}`;
                    }
                    
                    // YouTubeì¸ ê²½ìš° iframe ì‚¬ìš©, ì•„ë‹ˆë©´ video íƒœê·¸ ì‚¬ìš©
                    if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        eventOverlayVideo.innerHTML = `<iframe width="100%" height="300" src="${videoSrc}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                        eventOverlayVideo.style.display = 'block';
                        eventOverlayImage.style.display = 'none';
                    } else {
                        eventOverlayVideo.innerHTML = '';
                        eventOverlayVideo.src = currentEvent.photo;
                        eventOverlayVideo.style.display = 'block';
                        eventOverlayImage.style.display = 'none';
                    }
                } else {
                    // ì´ë¯¸ì§€ì¸ ê²½ìš°
                    eventOverlayVideo.innerHTML = '';
                    eventOverlayVideo.style.display = 'none';
                    eventOverlayImage.src = currentEvent.photo;
                    eventOverlayImage.style.display = 'block';
                }
            } else {
                eventOverlayVideo.innerHTML = '';
                eventOverlayVideo.style.display = 'none';
                eventOverlayImage.style.display = 'none';
            }
            eventOverlay.classList.add('visible');

            // 1.5ì´ˆ í›„ì— ì°½ì„ ìˆ¨ê¸°ëŠ” íƒ€ì´ë¨¸ì˜ ì—­í• ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
            eventDisplayTimeout = setTimeout(() => {
                eventOverlay.classList.remove('visible');
                eventDisplayTimeout = null;
            }, 2000);

        } else {
            // ì´ë²¤íŠ¸ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì°½ì„ ìˆ¨ê¹ë‹ˆë‹¤.
            eventOverlay.classList.remove('visible');
        }
    }

// --- 3.5 ì˜í†  í´ë¦¬ê³¤ ìë™ ìƒ‰ìƒ ê³„ì‚° í•¨ìˆ˜ ---

    // ğŸš© [ì¶”ê°€] í´ë¦¬ê³¤ ë‚´ë¶€ì— ì ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ (Ray Casting ì•Œê³ ë¦¬ì¦˜)
    function isPointInPolygon(point, polygon) {
        const [lat, lng] = point;
        let inside = false;
        
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
            const [lat1, lng1] = polygon[i];
            const [lat2, lng2] = polygon[j];
            
            const intersect = ((lng1 > lng) !== (lng2 > lng)) &&
                (lat < (lat2 - lat1) * (lng - lng1) / (lng2 - lng1) + lat1);
            if (intersect) inside = !inside;
        }
        
        return inside;
    }

    // ğŸš© [v3.1] êµ¬ì—­ ì ìœ  ì•Œê³ ë¦¬ì¦˜
    // ìš°ì„ ìˆœìœ„: â‘  ìˆ˜ë„ ë³´ìœ  êµ­ê°€ â†’ â‘¡ ì„± ê°¯ìˆ˜ ìµœë‹¤ êµ­ê°€ (í•­ìƒ ìƒ‰ì¹ )
    // ë°˜í™˜: { countryId, isExclusive, countriesInZone: [...] } ë˜ëŠ” null
    function calculateDominantCountry(territory, year, month) {
        // ì˜í†  ë°ì´í„°ì— country_idê°€ ì§ì ‘ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš© (castles ì—†ì–´ë„ ë Œë”ë§ ê°€ëŠ¥)
        if (territory.properties && territory.properties.country_id) {
            const countryId = territory.properties.country_id;
            // ğŸ”‘ [ê°œì„ ] String/ìˆ«ì í˜•ì‹ ì°¨ì´ í—ˆìš© â€” ë¬¸ìì—´ë¡œ í†µì¼ í›„ ì¬ì‹œë„
            const countryInfo = getCountryInfoById(countryId)
                             || getCountryInfoById(String(countryId));
            if (countryInfo) {
                return { countryId: String(countryId), isExclusive: true, countriesInZone: [String(countryId)] };
            }
            // countriesê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë„ country_idê°€ ì¡´ì¬í•˜ë©´ í†µê³¼
            // (countryInfo=null â†’ countryNotFound ì²˜ë¦¬. noCountryëŠ” ì•„ë‹˜)
            if (countries.length === 0) {
                return { countryId: String(countryId), isExclusive: true, countriesInZone: [String(countryId)] };
            }
        }
        
        // castles ê¸°ë°˜ ì§€ë°° êµ­ê°€ ê³„ì‚°
        let geometry;
        if (territory.geojson && territory.geojson.geometry) {
            geometry = territory.geojson.geometry;
        } else if (territory.type && territory.coordinates) {
            geometry = { type: territory.type, coordinates: territory.coordinates };
        } else {
            return null;
        }
        
        const currentTotalMonths = yearMonthToTotalMonths(year, month);
        const countryCount = {};          // countryId â†’ ì„± ê°¯ìˆ˜
        const capitalCountries = new Set(); // ì´ êµ¬ì—­ ë‚´ ìˆ˜ë„ë¥¼ ê°€ì§„ êµ­ê°€ ëª©ë¡
        
        // Polygon ë˜ëŠ” MultiPolygon ì²˜ë¦¬ ë° ì¢Œí‘œ ë³€í™˜ (ìºì‹±)
        let polygonData = [];
        if (geometry.type === 'Polygon') {
            const coords = geometry.coordinates[0];
            const converted = coords.map(coord => [coord[1], coord[0]]);
            const bounds = calculateBounds(converted);
            polygonData = [{ coords: converted, bounds }];
        } else if (geometry.type === 'MultiPolygon') {
            polygonData = geometry.coordinates.map(poly => {
                const coords = poly[0];
                const converted = coords.map(coord => [coord[1], coord[0]]);
                const bounds = calculateBounds(converted);
                return { coords: converted, bounds };
            });
        } else {
            return null;
        }
        
        // ëª¨ë“  ì„±/ë„ì‹œ ë§ˆì»¤ë¥¼ ìˆœíšŒ
        castles.forEach(castle => {
            if (typeof castle.lat !== "number" || typeof castle.lng !== "number") return;
            if (castle.is_natural_feature || castle.is_label || castle.is_military_flag) return;
            
            let isInside = false;
            for (const polygon of polygonData) {
                if (castle.lat < polygon.bounds.minLat || castle.lat > polygon.bounds.maxLat ||
                    castle.lng < polygon.bounds.minLng || castle.lng > polygon.bounds.maxLng) {
                    continue;
                }
                if (isPointInPolygon([castle.lat, castle.lng], polygon.coords)) {
                    isInside = true;
                    break;
                }
            }
            
            if (!isInside) return;
            
            const activeHistoryInfo = getActiveHistoryInfo(castle.history, currentTotalMonths);
            if (!activeHistoryInfo) return;
            
            const countryId = activeHistoryInfo.record.country_id || castle.country_id;
            if (!countryId) return;
            
            // ì„± ê°¯ìˆ˜ ì¹´ìš´íŠ¸ (ê°€ì¤‘ì¹˜ ì—†ì´ ìˆœìˆ˜ 1ê°œ = 1)
            countryCount[countryId] = (countryCount[countryId] || 0) + 1;
            
            // ìˆ˜ë„ ì—¬ë¶€ ê¸°ë¡
            if (activeHistoryInfo.record.is_capital || castle.is_capital) {
                capitalCountries.add(countryId);
            }
        });
        
        const uniqueCountries = Object.keys(countryCount);
        
        // êµ¬ì—­ ë‚´ ë„ì‹œê°€ 0ê°œë©´ â†’ castles ë¯¸ë¡œë“œ ìƒíƒœì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ properties.country_idë¡œ fallback
        if (uniqueCountries.length === 0) {
            if (territory.properties && territory.properties.country_id) {
                const fallbackId = String(territory.properties.country_id);
                if (castles.length === 0) {
                    // castles ë¡œë”© ëŒ€ê¸° ì¤‘ì„ì„ í‘œì‹œ (ê³¼ë„í•œ ë¡œê·¸ ë°©ì§€: ì²« 5ê°œë§Œ)
                    if (typeof calculateDominantCountry._fallbackLogCount === 'undefined') calculateDominantCountry._fallbackLogCount = 0;
                    if (calculateDominantCountry._fallbackLogCount < 5) {
                        console.log(`â³ [ì„± ë°ì´í„° ë¡œë”© ëŒ€ê¸° ì¤‘] territory "${territory.name}" â†’ properties.country_id(${fallbackId}) fallback ì‚¬ìš©`);
                        calculateDominantCountry._fallbackLogCount++;
                    }
                }
                return { countryId: fallbackId, isExclusive: true, countriesInZone: [fallbackId] };
            }
            return null;
        }
        
        // ë‹¨ì¼ êµ­ê°€ â†’ ë°°íƒ€ì  ì ìœ 
        if (uniqueCountries.length === 1) {
            return { countryId: uniqueCountries[0], isExclusive: true, countriesInZone: uniqueCountries };
        }
        
        // ğŸš© [v3.1 í•µì‹¬] í˜¼í•© ì ìœ  íŒì •
        // â‘  ìˆ˜ë„ê°€ ìˆëŠ” êµ­ê°€ â†’ ë¬´ì¡°ê±´ ê·¸ êµ­ê°€ (ìˆ˜ë„ê°€ ì—¬ëŸ¬ êµ­ê°€ì— ìˆìœ¼ë©´ ì„± ê°¯ìˆ˜ë¡œ ê²°ì •)
        if (capitalCountries.size === 1) {
            const winner = capitalCountries.values().next().value;
            return { countryId: winner, isExclusive: false, countriesInZone: uniqueCountries };
        }
        if (capitalCountries.size > 1) {
            // ìˆ˜ë„ê°€ ì—¬ëŸ¬ êµ­ê°€ â†’ ê·¸ ì¤‘ ì„± ê°¯ìˆ˜ê°€ ë” ë§ì€ êµ­ê°€
            let winner = null, maxCount = 0;
            for (const cid of capitalCountries) {
                if (countryCount[cid] > maxCount) {
                    maxCount = countryCount[cid];
                    winner = cid;
                }
            }
            return { countryId: winner, isExclusive: false, countriesInZone: uniqueCountries };
        }
        
        // â‘¡ ìˆ˜ë„ ì—†ìŒ â†’ ì„± ê°¯ìˆ˜ê°€ ë” ë§ì€ êµ­ê°€
        let dominantCountry = null;
        let maxCount = 0;
        for (const [countryId, count] of Object.entries(countryCount)) {
            if (count > maxCount) {
                maxCount = count;
                dominantCountry = countryId;
            }
        }
        
        return { countryId: dominantCountry, isExclusive: false, countriesInZone: uniqueCountries };
    }

    // ğŸš© [ìˆ˜ì •] territoryì˜ Bounding Box ê³„ì‚° (ìºì‹±)
    function getTerritoryBounds(territory) {
        if (territory._bounds) return territory._bounds;
        
        // ğŸš© [ìˆ˜ì •] territory.geojson ë˜ëŠ” territory.type/coordinates ì§€ì›
        let geometry;
        if (territory.geojson && territory.geojson.geometry) {
            geometry = territory.geojson.geometry;
        } else if (territory.type && territory.coordinates) {
            geometry = { type: territory.type, coordinates: territory.coordinates };
        } else {
            return null;
        }
        
        let minLat = Infinity, maxLat = -Infinity;
        let minLng = Infinity, maxLng = -Infinity;
        
        const collect = (coords) => {
            coords.forEach(([lng, lat]) => {
                if (lat < minLat) minLat = lat;
                if (lat > maxLat) maxLat = lat;
                if (lng < minLng) minLng = lng;
                if (lng > maxLng) maxLng = lng;
            });
        };
        
        if (geometry.type === 'Polygon') {
            collect(geometry.coordinates[0]);
        } else if (geometry.type === 'MultiPolygon') {
            geometry.coordinates.forEach(poly => collect(poly[0]));
        }
        
        territory._bounds = { minLat, maxLat, minLng, maxLng };
        return territory._bounds;
    }
    
    // ğŸš© [ì¶”ê°€] Bounding Box ê³„ì‚°
    function calculateBounds(coords) {
        let minLat = Infinity, maxLat = -Infinity;
        let minLng = Infinity, maxLng = -Infinity;
        
        for (const [lat, lng] of coords) {
            if (lat < minLat) minLat = lat;
            if (lat > maxLat) maxLat = lat;
            if (lng < minLng) minLng = lng;
            if (lng > maxLng) maxLng = lng;
        }
        
        return { minLat, maxLat, minLng, maxLng };
    }

    // ğŸ¨ [ì¶”ê°€] ë‹¨ì¼ ë¼ë²¨ë§Œ ì—…ë°ì´íŠ¸ (ë¼ë²¨ ìˆ˜ì • ì‹œ)
    function updateSingleLabel(oldCastle, newCastle, year, month) {
        if (!map || !map._loaded) return;
        
        console.log(`ğŸ·ï¸ ë¼ë²¨ ì—…ë°ì´íŠ¸: ${oldCastle.name} â†’ ${newCastle.name}`);
        console.log(`  ğŸ” oldCastle._id: ${oldCastle._id}, name: ${oldCastle.name}`);
        console.log(`  ğŸ“Š ì „ì²´ ë§ˆì»¤ ìˆ˜: ${markers.length}ê°œ`);
        
        // ê¸°ì¡´ ë¼ë²¨ ë§ˆì»¤ ì œê±°
        let removedCount = 0;
        let checkedCount = 0;
        const markersToRemove = [];
        
        // markers ë°°ì—´ì—ì„œ ì°¾ì•„ì„œ ì œê±°
        for (let i = markers.length - 1; i >= 0; i--) {
            const marker = markers[i];
            const castleData = marker._castleData || marker.options.castleData;
            if (castleData) {
                checkedCount++;
                const idMatch = castleData._id && oldCastle._id && 
                               (castleData._id === oldCastle._id || 
                                castleData._id.toString() === oldCastle._id.toString());
                const nameMatch = castleData.name === oldCastle.name;
                
                // ë””ë²„ê¹…: _idê°€ ì¼ì¹˜í•˜ëŠ” ë§ˆì»¤ ì •ë³´ ì¶œë ¥
                if (idMatch) {
                    console.log(`  ğŸ” ë§ˆì»¤[${i}]: ${castleData.name} (${castleData._id}), is_label: ${castleData.is_label}`);
                }
                
                if (idMatch || nameMatch) {
                    console.log(`  ğŸ¯ ë§¤ì¹­ëœ ë§ˆì»¤ ë°œê²¬: ${castleData.name} (${castleData._id})`);
                    if (castleLayerGroup && castleLayerGroup.hasLayer(marker)) {
                        castleLayerGroup.removeLayer(marker);
                    }
                    markers.splice(i, 1);
                    removedCount++;
                }
            }
        }
        console.log(`  ğŸ“– ë¼ë²¨ ë§ˆì»¤ í™•ì¸: ${checkedCount}ê°œ ì¤‘ ${removedCount}ê°œ ì œê±°`);
        
        // ì œê±° ì‹¤íŒ¨ ì‹œ ì „ì²´ ë§µ ê°±ì‹ 
        if (removedCount === 0) {
            console.warn(`  âš ï¸ ê¸°ì¡´ ë§ˆì»¤ë¥¼ ì°¾ì§€ ëª»í•¨. ì „ì²´ ë§µ ê°±ì‹ ìœ¼ë¡œ ëŒ€ì²´`);
            const { year, month } = getCurrentYearMonth();
            updateMap(year, month);
            return;
        }
        
        // ìƒˆ ë¼ë²¨ ì¶”ê°€ (ì‹œê°„ ë²”ìœ„ ë° ê°€ì‹œì„± ì²´í¬)
        const startYear = newCastle.start_year || newCastle.built_year || -Infinity;
        const endYear = newCastle.end_year || newCastle.destroyed_year || Infinity;
        const isWithinDuration = startYear <= year && endYear >= year;
        
        console.log(`  ğŸ“… ì‹œê°„ ì²´í¬: ${startYear} <= ${year} <= ${endYear} = ${isWithinDuration}`);
        
        if (!isWithinDuration) {
            console.log(`  â­ï¸ í˜„ì¬ ì‹œê°„ëŒ€(${year})ì— í•´ë‹¹í•˜ì§€ ì•Šì•„ í‘œì‹œ ì•ˆ í•¨`);
            return;
        }
        
        // ë¼ë²¨ íƒ€ì…ë³„ ê°€ì‹œì„± ì²´í¬
        const labelType = newCastle.label_type || 'place';

        // ğŸš© label_type='country'ëŠ” macroCountryLayerì—ì„œ ì˜í†  ê¸°ë°˜ìœ¼ë¡œ í‘œì‹œí•˜ë¯€ë¡œ ì œì™¸
        if (labelType === 'country') return;

        let shouldRender = false;
        if (labelType === 'ethnic') {
            shouldRender = layerVisibility.ethnicLabel;
        } else {
            shouldRender = layerVisibility.placeLabel;
        }
        

        
        if (!shouldRender) {
            console.log(`  â­ï¸ ${labelType} ë¼ë²¨ ë ˆì´ì–´ê°€ êº¼ì ¸ìˆì–´ í‘œì‹œ ì•ˆ í•¨`);
            return;
        }
        
        const castleName = newCastle.name;
        let marker;
        
        // ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
        if (newCastle.custom_icon) {
            const iconWidth = newCastle.icon_width || 32;
            const iconHeight = newCastle.icon_height || 32;
            const customIconHtml = `<img src="${newCastle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
            const labelIcon = L.divIcon({
                className: 'custom-icon-marker',
                html: customIconHtml,
                iconSize: [iconWidth, iconHeight],
                iconAnchor: [iconWidth / 2, 0],
                pane: 'labelPane'
            });
            marker = L.marker([newCastle.lat, newCastle.lng], { icon: labelIcon, pane: 'labelPane' });
        } else {
            // ì €ì¥ëœ í¬ê¸°ì— ë”°ë¼ í°íŠ¸ í¬ê¸° ê²°ì •
            let fontSize = '15px';
            switch (newCastle.label_size) {
                case 'large':
                    fontSize = '26px';
                    break;
                case 'small':
                    fontSize = '10px';
                    break;
            }
            const labelIcon = L.divIcon({
                className: 'label-text-marker', 
                html: `<div style="
                    font-size: ${fontSize}; 
                    font-weight: bold; 
                    color: ${newCastle.label_color || '#FFFFFF'}; 
                    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
                    white-space: nowrap;
                    text-align: center;
                ">${castleName}</div>`,
                iconSize: [150, 40],
                iconAnchor: [75, 0],
                pane: 'labelPane'
            });
            marker = L.marker([newCastle.lat, newCastle.lng], { icon: labelIcon, pane: 'labelPane' });
        }
        
        // ë§ˆì»¤ì— ë°ì´í„° ì €ì¥
        marker._castleData = newCastle;
        marker.isCapital = isCapitalCastle(newCastle); // ğŸš© [ì¶”ê°€] ìˆ˜ë„ íŒë³„ ì†ì„±
        
        // í´ë¦­ ì´ë²¤íŠ¸
        marker.on('click', () => {
            openCastleForm(newCastle._id);
        });
        
        // ë ˆì´ì–´ì— ì¶”ê°€
        markers.push(marker);
        if (castleLayerGroup) {
            marker.addTo(castleLayerGroup);
        }
        console.log(`  âœ… ìƒˆ ë¼ë²¨ ì¶”ê°€ ì™„ë£Œ (ìˆ˜ë„: ${marker.isCapital})`);
    }

    // ğŸ”§ [v2.0.6] ìì—° ì§€í˜•ì§€ë¬¼ ê°œë³„ ì—…ë°ì´íŠ¸
    function updateSingleNaturalFeature(oldCastle, newCastle, year, month) {
        if (!map || !map._loaded) return;
        
        console.log(`ğŸŒ³ ìì—° ì§€í˜•ì§€ë¬¼ ì—…ë°ì´íŠ¸: ${oldCastle.name} â†’ ${newCastle.name}`);
        
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        let removedCount = 0;
        for (let i = allCastleMarkers.length - 1; i >= 0; i--) {
            const marker = allCastleMarkers[i];
            const castleData = marker._castleData;
            if (castleData && (castleData._id === oldCastle._id || castleData.name === oldCastle.name)) {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
                allCastleMarkers.splice(i, 1);
                removedCount++;
            }
        }
        console.log(`  ğŸ“– ê¸°ì¡´ ë§ˆì»¤ ${removedCount}ê°œ ì œê±°`);
        
        // ì‹œê°„ ë²”ìœ„ ì²´í¬
        const startYear = newCastle.start_year || newCastle.built_year || -Infinity;
        const endYear = newCastle.end_year || newCastle.destroyed_year || Infinity;
        const isWithinDuration = startYear <= year && endYear >= year;
        
        if (!isWithinDuration || !layerVisibility.natural) {
            console.log(`  â­ï¸ í˜„ì¬ ì‹œê°„ëŒ€(${year}) ë˜ëŠ” ë ˆì´ì–´ ë¹„í™œì„±í™”ë¡œ í‘œì‹œ ì•ˆ í•¨`);
            return;
        }
        
        // ìƒˆ ë§ˆì»¤ ìƒì„±
        let marker;
        const castleName = newCastle.name;
        
        if (newCastle.custom_icon) {
            const iconWidth = newCastle.icon_width || 32;
            const iconHeight = newCastle.icon_height || 32;
            const customIconHtml = `<img src="${newCastle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
            const featureIcon = L.divIcon({
                className: 'custom-icon-marker',
                html: customIconHtml,
                iconSize: [iconWidth, iconHeight],
                iconAnchor: [iconWidth / 2, iconHeight],
                popupAnchor: [0, -iconHeight]
            });
            marker = L.marker([newCastle.lat, newCastle.lng], { icon: featureIcon });
        } else {
            const featureType = newCastle.natural_feature_type || 'other';
            let iconInfo = getNaturalFeatureIcon(featureType);
            if (!iconInfo) {
                iconInfo = getNaturalFeatureIcon('other');
            }
            const iconClass = iconInfo?.className || 'feature-other';
            const iconSymbol = iconInfo?.symbol || 'â–';
            
            const featureIcon = L.divIcon({
                className: `natural-feature-marker ${iconClass}`,
                html: `<div>${iconSymbol}</div><div class="feature-name">${castleName}</div>`,
                iconSize: [60, 40],
                iconAnchor: [30, 40],
                popupAnchor: [6, -30]
            });
            marker = L.marker([newCastle.lat, newCastle.lng], { icon: featureIcon });
        }
        
        // íŒì—… ì¶”ê°€
        const editorInfoHtml = newCastle.lastModifiedBy 
            ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${newCastle.lastModifiedBy}</small>` 
            : (newCastle.createdBy ? `<br><small>ìƒì„±ì: ${newCastle.createdBy}</small>` : '');
        
        const popupHtml = `<div style="padding:0;margin:0;line-height:1.4;"><b style="font-size:14px;">${castleName}</b>${newCastle.desc ? `<br><span style="font-size:12px;">${newCastle.desc}</span>` : ''}${newCastle.photo ? `<br><img src="${newCastle.photo}" style="max-width:150px;max-height:100px;object-fit:cover;margin-top:4px;">` : ''}${editorInfoHtml}</div>`;
        
        marker.bindPopup(popupHtml, {
            className: 'compact-popup',
            maxWidth: 200,
            minWidth: 100
        });
        
        marker.on('click', function () {
            if (this && typeof this.openPopup === 'function') this.openPopup();
        });
        
        // ë§ˆì»¤ ì €ì¥ ë° ì¶”ê°€
        marker._castleData = newCastle;
        marker.isCapital = isCapitalCastle(newCastle); // ğŸš© [ì¶”ê°€] ìˆ˜ë„ íŒë³„ ì†ì„±
        allCastleMarkers.push(marker);
        markers.push(marker); // ğŸ¯ markers ë°°ì—´ì—ë„ ì¶”ê°€
        
        // ğŸ¯ [í•µì‹¬] castleLayerGroupì— ì¶”ê°€ (ìì—° ì§€í˜•ì§€ë¬¼ì˜ ì˜¬ë°”ë¥¸ ë ˆì´ì–´)
        if (castleLayerGroup) {
            marker.addTo(castleLayerGroup);
        } else {
            marker.addTo(map);
        }
        
        console.log(`  âœ… ìƒˆ ìì—° ì§€í˜•ì§€ë¬¼ ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ (ë ˆì´ì–´: ${castleLayerGroup ? 'castleLayerGroup' : 'map'})`);
    }

    // ğŸ¨ [ì¶”ê°€] ìƒˆë¡œìš´ ë¼ë²¨ ì¶”ê°€ (ë¼ë²¨ ìƒì„± ì‹œ)
    function addSingleLabel(newCastle, year, month) {
        if (!map || !map._loaded) return;
        
        console.log(`ğŸ·ï¸ ìƒˆ ë¼ë²¨ ìƒì„±: ${newCastle.name}`);
        
        // ë¼ë²¨ íƒ€ì…ë³„ ê°€ì‹œì„± ì²´í¬
        const labelType = newCastle.label_type || 'place';
        let shouldRender = false;
        if (labelType === 'country') {
            shouldRender = layerVisibility.countryLabel;
        } else if (labelType === 'ethnic') {
            shouldRender = layerVisibility.ethnicLabel;
        } else {
            shouldRender = layerVisibility.placeLabel;
        }
        
        if (!shouldRender) {
            console.log(`  â­ï¸ ${labelType} ë¼ë²¨ ë ˆì´ì–´ê°€ êº¼ì ¸ìˆì–´ í‘œì‹œ ì•ˆ í•¨`);
            return;
        }
        
        const castleName = newCastle.name;
        let marker;
        
        // ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
        if (newCastle.custom_icon) {
            const iconWidth = newCastle.icon_width || 32;
            const iconHeight = newCastle.icon_height || 32;
            const customIconHtml = `<img src="${newCastle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
            const labelIcon = L.divIcon({
                className: 'custom-icon-marker',
                html: customIconHtml,
                iconSize: [iconWidth, iconHeight],
                iconAnchor: [iconWidth / 2, 0],
                pane: 'labelPane'
            });
            marker = L.marker([newCastle.lat, newCastle.lng], { icon: labelIcon, pane: 'labelPane' });
        } else {
            // ì €ì¥ëœ í¬ê¸°ì— ë”°ë¼ í°íŠ¸ í¬ê¸° ê²°ì •
            let fontSize = '15px';
            switch (newCastle.label_size) {
                case 'large':
                    fontSize = '26px';
                    break;
                case 'small':
                    fontSize = '10px';
                    break;
            }
            const labelIcon = L.divIcon({
                className: 'label-text-marker', 
                html: `<div style="
                    font-size: ${fontSize}; 
                    font-weight: bold; 
                    color: ${newCastle.label_color || '#FFFFFF'}; 
                    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
                    white-space: nowrap;
                    text-align: center;
                ">${castleName}</div>`,
                iconSize: [150, 40],
                iconAnchor: [75, 0],
                pane: 'labelPane'
            });
            marker = L.marker([newCastle.lat, newCastle.lng], { icon: labelIcon, pane: 'labelPane' });
        }
        
        // ë§ˆì»¤ì— ë°ì´í„° ì €ì¥
        marker._castleData = newCastle;
        marker.isCapital = isCapitalCastle(newCastle); // ğŸš© [ì¶”ê°€] ìˆ˜ë„ íŒë³„ ì†ì„±
        
        // í´ë¦­ ì´ë²¤íŠ¸
        marker.on('click', () => {
            openCastleForm(newCastle._id);
        });
        
        // ë ˆì´ì–´ì— ì¶”ê°€
        markers.push(marker);
        // ë¼ë²¨ì€ labelLayerGroupì— ì¶”ê°€í•˜ì—¬ castleLayerì™€ ë¶„ë¦¬
        if (labelLayerGroup) {
            marker.addTo(labelLayerGroup);
        } else if (castleLayerGroup) {
            marker.addTo(castleLayerGroup);
        }
        // íŠ¸ë˜í‚¹ ë°°ì—´ì— ì¶”ê°€
        marker._castleData = newCastle;
        if (!allCastleMarkers.includes(marker)) allCastleMarkers.push(marker);
        console.log(`  âœ… ë¼ë²¨ ì¶”ê°€ ì™„ë£Œ`);
    }

      // ğŸ¨ [ì¶”ê°€] íŠ¹ì • êµ­ê°€ì˜ ë¼ë²¨ë§Œ ë‹¤ì‹œ ë Œë”ë§ (êµ­ê°€ ì •ë³´ ìˆ˜ì • ì‹œ)
      function updateCountryLabelsOnly(countryIdentifier, year, month) {
          // countryIdentifier may be a country _id or the country name â€” resolve to object when possible
          if (!map || !map._loaded) return;

          const countryObj = countries.find(c => String(c._id) === String(countryIdentifier) || c.name === countryIdentifier);
          const countryId = countryObj ? String(countryObj._id) : String(countryIdentifier);
          const countryName = countryObj ? countryObj.name : countryIdentifier;

          console.log(`ğŸ·ï¸ êµ­ê°€ ë¼ë²¨ ì—…ë°ì´íŠ¸: id=${countryId}, name=${countryName}`);

          // í•´ë‹¹ êµ­ê°€ì˜ ë¼ë²¨ë§Œ ì°¾ì•„ì„œ ì œê±°
          const markersToRemove = [];
          for (let i = markers.length - 1; i >= 0; i--) {
              const marker = markers[i];
              const castleData = marker._castleData || marker.options.castleData;
              if (castleData && castleData.is_label && castleData.label_type === 'country' &&
                  (String(castleData.country_id) === countryId || castleData.country_id === countryName)) {
                  if (castleLayerGroup && castleLayerGroup.hasLayer(marker)) {
                      castleLayerGroup.removeLayer(marker);
                  }
                  markers.splice(i, 1);
                  markersToRemove.push(marker);
              }
          }
          console.log(`  ğŸ—‘ï¸ ê¸°ì¡´ ë¼ë²¨ ì œê±°: ${markersToRemove.length}ê°œ`);

          // í•´ë‹¹ êµ­ê°€ì˜ ë¼ë²¨ ë‹¤ì‹œ ë Œë”ë§
          let addedCount = 0;
          castles.forEach(castle => {
              if (castle.is_label && castle.label_type === 'country' &&
                  (String(castle.country_id) === countryId || castle.country_id === countryName)) {
                  // ì‹œê°„ ë²”ìœ„ ì²´í¬ (ì•ˆì „í•˜ê²Œ ê¸°ë³¸ê°’ ì²˜ë¦¬)
                  const start = (castle.start_year !== undefined && castle.start_year !== null) ? castle.start_year : (castle.built_year || -Infinity);
                  const end = (castle.end_year !== undefined && castle.end_year !== null) ? castle.end_year : (castle.destroyed_year || Infinity);
                  const isWithinDuration = start <= year && end >= year;
                  if (!isWithinDuration) return;

                  // ë¼ë²¨ ê°€ì‹œì„± ì²´í¬
                  if (!layerVisibility.countryLabel) return;

                  const castleName = castle.name;
                  let marker;

                  // ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
                  if (castle.custom_icon) {
                      const iconWidth = castle.icon_width || 32;
                      const iconHeight = castle.icon_height || 32;
                      const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                      const labelIcon = L.divIcon({
                          className: 'custom-icon-marker',
                          html: customIconHtml,
                          iconSize: [iconWidth, iconHeight],
                          iconAnchor: [iconWidth / 2, 0],
                          pane: 'labelPane'
                      });
                      marker = L.marker([castle.lat, castle.lng], { icon: labelIcon, pane: 'labelPane' });
                  } else {
                      // ì €ì¥ëœ í¬ê¸°ì— ë”°ë¼ í°íŠ¸ í¬ê¸° ê²°ì •
                      let fontSize = '15px';
                      switch (castle.label_size) {
                          case 'large':
                              fontSize = '26px';
                              break;
                          case 'small':
                              fontSize = '10px';
                              break;
                      }
                      const labelIcon = L.divIcon({
                          className: 'label-text-marker', 
                          html: `<div style="
                              font-size: ${fontSize}; 
                              font-weight: bold; 
                              color: ${castle.label_color || '#FFFFFF'}; 
                              text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
                              white-space: nowrap;
                              text-align: center;
                          ">${castleName}</div>`,
                          iconSize: [150, 40],
                          iconAnchor: [75, 0],
                          pane: 'labelPane'
                      });
                      marker = L.marker([castle.lat, castle.lng], { icon: labelIcon, pane: 'labelPane' });
                  }

                  // ë§ˆì»¤ì— ë°ì´í„° ì €ì¥
                  marker._castleData = castle;
                  marker.isCapital = isCapitalCastle(castle);

                  // ë ˆì´ì–´ì— ì¶”ê°€
                  markers.push(marker);
                  if (labelLayerGroup) marker.addTo(labelLayerGroup); else if (castleLayerGroup) marker.addTo(castleLayerGroup);
                  marker._castleData = castle;
                  if (!allCastleMarkers.includes(marker)) allCastleMarkers.push(marker);
                  addedCount++;
              }
          });

          console.log(`  âœ… ìƒˆ ë¼ë²¨ ì¶”ê°€: ${addedCount}ê°œ`);
      }

    // ğŸŒ³ [v2.0.7] ìì—° ì§€í˜•ì§€ë¬¼ ê°œë³„ ì¶”ê°€
    function addSingleNaturalFeature(newCastle, year, month) {
        if (!map || !map._loaded) return;
        
        console.log(`ğŸŒ³ ìƒˆ ìì—° ì§€í˜•ì§€ë¬¼ ìƒì„±: ${newCastle.name}`);
        
        // ìì—° ì§€í˜•ì§€ë¬¼ ë ˆì´ì–´ ê°€ì‹œì„± ì²´í¬
        if (!layerVisibility.natural) {
            console.log(`  â­ï¸ ìì—° ì§€í˜•ì§€ë¬¼ ë ˆì´ì–´ê°€ êº¼ì ¸ìˆì–´ í‘œì‹œ ì•ˆ í•¨`);
            return;
        }
        
        // ì‹œê°„ ë²”ìœ„ ì²´í¬
        const startYear = newCastle.start_year || newCastle.built_year || -Infinity;
        const endYear = newCastle.end_year || newCastle.destroyed_year || Infinity;
        const isWithinDuration = startYear <= year && endYear >= year;
        
        if (!isWithinDuration) {
            console.log(`  â­ï¸ ì‹œê°„ ë²”ìœ„ ë²—ì–´ë‚¨ (${startYear} ~ ${endYear}), í˜„ì¬ ${year}ë…„`);
            return;
        }
        
        const castleName = newCastle.name;
        let marker;
        
        // ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
        if (newCastle.custom_icon) {
            const iconWidth = newCastle.icon_width || 32;
            const iconHeight = newCastle.icon_height || 32;
            const customIconHtml = `<img src="${newCastle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
            const featureIcon = L.divIcon({
                className: 'custom-icon-marker',
                html: customIconHtml,
                iconSize: [iconWidth, iconHeight],
                iconAnchor: [iconWidth / 2, iconHeight],
                popupAnchor: [0, -iconHeight]
            });
            marker = L.marker([newCastle.lat, newCastle.lng], { icon: featureIcon });
        } else {
            // ìì—° ì§€í˜•ì§€ë¬¼ íƒ€ì…ì— ë”°ë¥¸ ê¸°ë³¸ ì•„ì´ì½˜
            const featureType = newCastle.natural_feature_type || 'other';
            let iconInfo = getNaturalFeatureIcon(featureType);
            if (!iconInfo) {
                iconInfo = getNaturalFeatureIcon('other');
            }
            const iconClass = iconInfo?.className || 'feature-other';
            const iconSymbol = iconInfo?.symbol || 'â–';
            
            const featureIcon = L.divIcon({
                className: `natural-feature-marker ${iconClass}`,
                html: `<div>${iconSymbol}</div><div class="feature-name">${castleName}</div>`,
                iconSize: [60, 40],
                iconAnchor: [30, 40],
                popupAnchor: [6, -30]
            });
            marker = L.marker([newCastle.lat, newCastle.lng], { icon: featureIcon });
        }
        
        // íŒì—… ì„¤ì •
        const editorInfoHtml = newCastle.lastModifiedBy 
            ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${newCastle.lastModifiedBy}</small>` 
            : (newCastle.createdBy ? `<br><small>ìƒì„±ì: ${newCastle.createdBy}</small>` : '');
        
        const popupHtml = `<div style="padding:0;margin:0;line-height:1.4;"><b style="font-size:14px;">${castleName}</b>${newCastle.desc ? `<br><span style="font-size:12px;">${newCastle.desc}</span>` : ''}${newCastle.photo ? `<br><img src="${newCastle.photo}" style="max-width:150px;max-height:100px;object-fit:cover;margin-top:4px;">` : ''}${editorInfoHtml}</div>`;
        
        marker.bindPopup(popupHtml, {
            className: 'compact-popup',
            maxWidth: 200,
            minWidth: 100
        });
        
        // í´ë¦­ ì´ë²¤íŠ¸
        marker.on('click', function (e) { 
            if (this && typeof this.openPopup === 'function') this.openPopup();
            map.flyTo(e.latlng, 10);
            if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) openCastleForm(newCastle._id); 
        });
        
        // ë§ˆì»¤ë¥¼ castleLayerGroupì— ì¶”ê°€
        marker._castleData = newCastle;
        marker.isCapital = isCapitalCastle(newCastle); // ğŸš© [ì¶”ê°€] ìˆ˜ë„ íŒë³„ ì†ì„±
        allCastleMarkers.push(marker);
        marker.addTo(castleLayerGroup);
        
        console.log(`  âœ… ìƒˆ ìì—° ì§€í˜•ì§€ë¬¼ ì¶”ê°€: ${castleName}`);
    }

// ğŸš€ [ì´ˆê³ ì† ë¼ë²¨] ëª¨ë“  ë¼ë²¨ ì¦‰ì‹œ ë Œë”ë§ (ì˜í†  ê³„ì‚° ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
function renderImmediateCountryLabels(year, month) {
    if (!map || !castles || castles.length === 0) {
        console.log('âš ï¸ [ì´ˆê³ ì† ë¼ë²¨] castles ë°ì´í„° ë¯¸ì¤€ë¹„');
        return;
    }
    
    console.log('ğŸš© [ì´ˆê³ ì† ë¼ë²¨] ì „ì²´ ë¼ë²¨ ì¦‰ì‹œ ë Œë”ë§ ì‹œì‘');
    
    // í™œì„±í™”ëœ ë ˆì´ì–´ í™•ì¸
    const shouldRenderCountry = layerVisibility.countryLabel;
    const shouldRenderPlace = layerVisibility.placeLabel;
    const shouldRenderEthnic = layerVisibility.ethnicLabel;
    
    // ğŸš€ [v2.0.5 ìµœì í™”] ì´ˆê¸° ë¡œë”© ì‹œ ì¤‘ìš” ë¼ë²¨ ê°•ì œ í‘œì‹œ
    const isInitial = window.isInitializing;
    if (isInitial) {
        console.log('ğŸš© [ì´ˆê¸° ë¡œë”©] ì¤‘ìš” ë¼ë²¨ ê°•ì œ í‘œì‹œ ëª¨ë“œ í™œì„±í™”');
    }
    
    console.log(`ğŸ·ï¸ [ë¼ë²¨ ë ˆì´ì–´] country: ${shouldRenderCountry}, place: ${shouldRenderPlace}, ethnic: ${shouldRenderEthnic}, ì´ˆê¸°ë¡œë”©: ${isInitial}`);
    
    // castlesì—ì„œ ëª¨ë“  ë¼ë²¨ í•„í„°ë§ (is_label === true)
    const allLabels = castles.filter(c => c.is_label === true);
    
    console.log(`ğŸ·ï¸ [ì´ˆê³ ì† ë¼ë²¨] ì „ì²´ ë¼ë²¨ ê°œìˆ˜: ${allLabels.length}ê°œ`);
    
    let renderedCount = 0;
    let forcedCount = 0;
    
    // ë¼ë²¨ ì¦‰ì‹œ ë Œë”ë§ (ì˜í†  ê³„ì‚° ë¶ˆí•„ìš”)
    allLabels.forEach(label => {
        // ë¼ë²¨ íƒ€ì…ë³„ ê°€ì‹œì„± ì²´í¬
        const labelType = label.label_type || 'place';
        let shouldRender = false;
        
        // ï¿½ label_type='country'ëŠ” macroCountryLayerì—ì„œ ì˜í†  ê¸°ë°˜ìœ¼ë¡œ í‘œì‹œí•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ì œì™¸
        if (labelType === 'country') return;

        // ï¿½ğŸš€ [v2.0.5] ì´ˆê¸° ë¡œë”© ì‹œ ì¤‘ìš” ë¼ë²¨ ê°•ì œ í‘œì‹œ
        // importanceê°€ 3 ì´ìƒì¸ ë¼ë²¨ì€ ë ˆì´ì–´ ì„¤ì •ê³¼ ë¬´ê´€í•˜ê²Œ í‘œì‹œ
        const importance = label.importance || 0;
        const forceShow = false; // ì´ˆê¸° ë¡œë”© ì‹œì—ë„ í† ê¸€ ë²„íŠ¼ìœ¼ë¡œ ì œì–´
        
        if (labelType === 'country') {
            shouldRender = shouldRenderCountry;
        } else if (labelType === 'ethnic') {
            shouldRender = shouldRenderEthnic;
        } else {
            shouldRender = shouldRenderPlace; // place, city, mountain, river ë“±
        }
        
        if (!shouldRender) return;
        
        // ì‹œê°„ ë²”ìœ„ ì²´í¬
        const startYear = label.start_year || label.built_year || -Infinity;
        const endYear = label.end_year || label.destroyed_year || Infinity;
        if (!(startYear <= year && endYear >= year)) return;
        
        // êµ­ê°€ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸° (ìˆìœ¼ë©´)
        let labelColor = label.label_color || '#FFFFFF';
        if (labelType === 'country' && countries && countries.length > 0) {
            const country = countries.find(c => c.name === label.country_id);
            if (country && country.color) {
                labelColor = country.color;
            }
        }
        
        // ë¼ë²¨ í¬ê¸°
        const labelSize = label.label_size || 'medium';
        let fontSize;
        switch (labelSize) {
            case 'small': fontSize = 14; break;
            case 'large': fontSize = 22; break;
            default: fontSize = 18;
        }
        
        const marker = L.marker([label.lat, label.lng], {
            icon: L.divIcon({
                className: `label-text-marker ${labelType}-label-immediate`,
                html: `<div style="
                    font-size: ${fontSize}px;
                    font-weight: bold;
                    color: ${labelColor};
                    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
                    white-space: nowrap;
                    text-align: center;
                    pointer-events: none;
                ">${label.name}</div>`,
                iconSize: [150, 40],
                iconAnchor: [75, 0]
            }),
            pane: 'labelPane'
        });
        
        marker.addTo(labelLayerGroup);
        marker._castleData = label;
        marker._isImmediateLabel = true; // ì¦‰ì‹œ ë Œë”ë§ëœ ë¼ë²¨ í‘œì‹œ
        marker._forceShown = forceShow; // ê°•ì œ í‘œì‹œ ì—¬ë¶€ ê¸°ë¡
        allCastleMarkers.push(marker);
        renderedCount++;
        if (forceShow && !shouldRenderCountry && !shouldRenderPlace && !shouldRenderEthnic) {
            forcedCount++;
        }
    });
    
    console.log(`âœ… [ì´ˆê³ ì† ë¼ë²¨] ì „ì²´ ë¼ë²¨ ì¦‰ì‹œ ë Œë”ë§ ì™„ë£Œ: ${renderedCount}ê°œ (ê°•ì œí‘œì‹œ: ${forcedCount}ê°œ)`);
}

// --- 4. ì§€ë„ ë Œë”ë§ ë° ë§ˆì»¤ ìƒì„± í•¨ìˆ˜ ---

// ğŸ”„ [ë¬´í•œ ë£¨í”„ ë°©ì§€] updateMap ë””ë°”ìš´ì‹±
let updateMapTimer = null;
let lastUpdateMapCall = { year: null, month: null, cacheOnly: null, dataFingerprint: null };
let pendingUpdateMapRAF = null; // ğŸš€ [v2.0.9] requestAnimationFrame ID

// ğŸš€ [v3.5 ìµœì í™”] ë””ë°”ìš´ì‹±ëœ updateMap í˜¸ì¶œ â€” ì´ˆê¸°í™” ì¤‘ ì—°ì‡„ í˜¸ì¶œ(4~5íšŒ)ì„ 1íšŒë¡œ ì¶•ì†Œ
let _requestUpdateMapTimer = null;
function requestUpdateMap(force = false) {
    clearTimeout(_requestUpdateMapTimer);
    _requestUpdateMapTimer = setTimeout(() => {
        const { year, month } = getCurrentYearMonth();
        updateMap(year, month, false, force);
    }, 120); // 120ms ë””ë°”ìš´ìŠ¤ â€” ì—°ì† í˜¸ì¶œ ë³‘í•©
}

function updateMap(year, month, cacheOnly = false, force = false) {
        // ğŸš€ [v2.0.9] requestAnimationFrameìœ¼ë¡œ ë Œë”ë§ ìµœì í™” (ì´ˆê¸° ë¡œë”© ì‹œì—ë§Œ)
        if (!isInitializing && pendingUpdateMapRAF) {
            // ì´ë¯¸ ì˜ˆì•½ëœ ë Œë”ë§ì´ ìˆìœ¼ë©´ ì·¨ì†Œí•˜ê³  ìƒˆë¡œ ì˜ˆì•½
            cancelAnimationFrame(pendingUpdateMapRAF);
            pendingUpdateMapRAF = null;
        }
        
        // ğŸ›¡ï¸ [ì¤‘ë³µ í˜¸ì¶œ ì°¨ë‹¨] ë™ì¼í•œ íŒŒë¼ë¯¸í„°ë¡œ 300ms ì´ë‚´ ì¬í˜¸ì¶œ ì‹œ ë¬´ì‹œ (forceê°€ trueë©´ ìŠ¤í‚µ)
        // ğŸ”‘ [ê°œì„ ] 16ms â†’ 300ms â€” ì´ˆê¸°í™” ì—°ì‡„ í˜¸ì¶œ(4-5íšŒ) ì°¨ë‹¨
        // ë‹¨, ë°ì´í„° ê°œìˆ˜ê°€ ë³€í–ˆìœ¼ë©´ (ìƒˆ ë°ì´í„° ë„ì°©) ì¦‰ì‹œ í†µê³¼
        const now = Date.now();
        const dataFingerprint = `${castles.length}_${territories.length}_${countries.length}`;
        if (!force && lastUpdateMapCall.year === year && 
            lastUpdateMapCall.month === month && 
            lastUpdateMapCall.cacheOnly === cacheOnly &&
            lastUpdateMapCall.dataFingerprint === dataFingerprint &&
            lastUpdateMapCall.timestamp && 
            (now - lastUpdateMapCall.timestamp) < 300) {
            return; // ì¡°ìš©íˆ ìŠ¤í‚µ (ë¡œê·¸ ìƒëµ â€” ì—°ì‡„ í˜¸ì¶œ ì‹œ ë¡œê·¸ ê³¼ë‹¤ ë°©ì§€)
        }
        
        // í˜¸ì¶œ ì •ë³´ ê¸°ë¡
        lastUpdateMapCall = { year, month, cacheOnly, timestamp: now, dataFingerprint };
        
        // ğŸ¯ updateMap ì‹¤í–‰ë§ˆë‹¤ ë§ˆì»¤ ì™„ë£Œ í”Œë˜ê·¸ ë¦¬ì…‹ â€” ì´ updateMapì˜ ë Œë”ë§ì´ ëë‚˜ì•¼ ë¡œë”© í•´ì œ
        window._castleMarkersRendered = false;
        
        // ğŸš€ [ìµœì í™”] ì´ˆê¸° ë¡œë”© ì¤‘ì—ëŠ” ì‹¤í–‰ ì°¨ë‹¨
        if (isInitializing) {
            console.log('â­ï¸ ì´ˆê¸° ë¡œë”© ì¤‘ì´ë¯€ë¡œ updateMap ìŠ¤í‚µ');
            return;
        }
        
        // ğŸ¯ [í•µì‹¬] ë¹ˆ ë°ì´í„°ë¡œ ìºì‹œ ë°ì´í„° ë®ì–´ì“°ê¸° ë°©ì§€
        // castlesê°€ 0ê°œì¸ë° territoriesê°€ ìˆë‹¤ë©´, ì´ì „ì— ë Œë”ë§ëœ ìºì‹œ ë³´í˜¸
        // ë‹¨, ì´ˆê¸° ë¡œë”© ì§í›„ì—ëŠ” territoriesë§Œ ìˆì–´ë„ ë Œë”ë§ í—ˆìš© (ë¹ˆ ì§€ë„ ë°©ì§€)
        const isInitialLoad = (castles.length === 0 && territories.length > 0 && !isInitializing);
        
        if (isInitialLoad) {
            // ğŸš€ [v2.0.9] ì´ˆê¸° ë¡œë”© ì§í›„: territoriesë§Œ ë¨¼ì € í‘œì‹œ (castles ë°±ê·¸ë¼ìš´ë“œ ëŒ€ê¸° ì¤‘)
            console.log('ğŸ—ºï¸ [ì´ˆê¸° ë¡œë”©] territoriesë§Œ ë¨¼ì € ë Œë”ë§ (castles ë°±ê·¸ë¼ìš´ë“œ ë¡œë”© ì¤‘...)');
            // ë Œë”ë§ ê³„ì† ì§„í–‰
        } else if (castles.length === 0 && territories.length > 0 && isInitializing) {
            // ì´ˆê¸°í™” ì¤‘ì— í˜¸ì¶œë˜ë©´ ìŠ¤í‚µ
            console.log('â­ï¸ [ì´ˆê¸°í™” ì¤‘] updateMap ìŠ¤í‚µ (isInitializing=true)');
            return;
        }
        
        // ë‘˜ ë‹¤ ë¹„ì–´ìˆìœ¼ë©´ ë Œë”ë§ ë¶ˆê°€
        if (castles.length === 0 && territories.length === 0) {
            console.log('â­ï¸ castlesì™€ territoriesê°€ ëª¨ë‘ ë¹„ì–´ìˆìŒ, ë Œë”ë§í•  ë°ì´í„° ì—†ìŒ');
            return;
        }
        
        // ğŸš€ [ìµœì í™”] ë””ë²„ê·¸ ë¡œê·¸ ìµœì†Œí™” â€” updateMapì€ ë¹ˆë²ˆí•˜ê²Œ í˜¸ì¶œë˜ë¯€ë¡œ í•œ ì¤„ë¡œ ì¶•ì•½
        console.log(`ğŸ—ºï¸ updateMap: year=${year}, month=${month}, castles=${castles.length}, territories=${territories.length}`);
        
        // Leaflet.heat ì´ˆê¸°í™”ëŠ” ì§€ë„ load ì´í›„ì—ë§Œ ì•ˆì „í•˜ê²Œ ì§„í–‰ ê°€ëŠ¥í•˜ë¯€ë¡œ, ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë‹¤ì‹œ í˜¸ì¶œì„ ì˜ˆì•½í•©ë‹ˆë‹¤.
        if (!map || !map._loaded) {
            if (map && typeof map.once === 'function') {
                map.once('load', () => updateMap(year, month, cacheOnly));
            }
            return;
        }

        // ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ê¸° ë ˆì´ì–´ ì´ˆê¸°í™”ë¥¼ ë‹¤ë¥¸ ë ˆì´ì–´ ì´ˆê¸°í™”ì™€ í•¨ê»˜ ì²˜ë¦¬
        if (drawnItems) drawnItems.clearLayers();
        
        // ğŸš€ [ê¹œë¹¡ì„ ë°©ì§€] ìƒˆ ë ˆì´ì–´ ê·¸ë£¹ì„ ë¨¼ì € ê·¸ë¦° ë’¤ ê¸°ì¡´ ê·¸ë£¹ê³¼ êµì²´ (double-buffer)
        const oldTerritoryLayerGroup = territoryLayerGroup;
        territoryLayerGroup = L.layerGroup().addTo(map);
        // ì´ì „ rendererë“¤ì€ ë‚˜ì¤‘ì— ì œê±° (ì§€ê¸ˆì€ ìœ ì§€í•˜ì—¬ ê³µë°± ë°©ì§€)
        const oldRenderers = window._territoryRenderers || [];
        window._territoryRenderers = [];

        if (contributionLayerGroup) {
            contributionLayerGroup.clearLayers();
        }
        
        // ğŸ“–ï¸ [ì¶”ê°€] ì—°ë„ ë³€ê²½ ì‹œ ë Œë”ë§ëœ ì˜í†  ì¶”ì  ì´ˆê¸°í™”
        if (typeof clearRenderedTerritories === 'function') {
            clearRenderedTerritories();
        }
        
        // ğŸ“–ğŸš© ì˜í†  í´ë¦¬ê³¤ ìë™ ìƒ‰ìƒ ì±„ìš°ê¸° (GeoJSON í–‰ì •êµ¬ì—­ ê¸°ë°˜)
        if (layerVisibility.territoryPolygon) {
            const startTime = performance.now();
            let renderedCount = 0;
            const view = map.getBounds();
            const viewBox = { minLat: view.getSouth(), maxLat: view.getNorth(), minLng: view.getWest(), maxLng: view.getEast() };
            
            // ğŸš€ [ìµœì í™”] ë Œë”ë§ëœ êµ­ê°€ ì¶”ì  ì´ˆê¸°í™” (ê±°ì‹œ ëª¨ë“œ êµ­ê°€ëª…ìš©)
            _renderedCountryIds.clear();
            _renderedCountryCentroids.clear();
            
            // ğŸš© [ì¶”ê°€] ì´ë¯¸ ë Œë”ë§ëœ ì˜í†  ì¶”ì  (ì¤‘ë³µ ë°©ì§€)
            const renderedTerritories = new Set();
            
            console.log(`ğŸ—ºï¸ ì˜í†  ë Œë”ë§ ì‹œì‘: territories=${territories.length}, territoryPolygon=${layerVisibility.territoryPolygon}`);
            
            let skipReasons = { duplicate: 0, outOfView: 0, timeRange: 0, noCountry: 0, countryNotFound: 0 };
            
            // ğŸš© [v3.2 í•µì‹¬] 2-pass ë Œë”ë§: êµ­ê°€ë³„ Feature ìˆ˜ì§‘ â†’ êµ­ê°€ë³„ ë‹¨ì¼ ë ˆì´ì–´ë¡œ ë³‘í•©
            // ì´ë ‡ê²Œ í•˜ë©´ ê°™ì€ êµ­ê°€ì˜ ì¤‘ì²© í´ë¦¬ê³¤ì´ ë‹¨ì¼ pathê°€ ë˜ì–´ fillOpacity ì¤‘ì²© ë°©ì§€
            const countryFeatures = new Map();   // countryId â†’ { features: [], popups: [], countryInfo, style }
            
            territories.forEach(territory => {
                const territoryKey = `${territory._id || territory.name}_${year}`;
                const localKey = `${territory.name}_${territory.type}`;
                
                if (renderedTerritories.has(localKey)) {
                    skipReasons.duplicate++;
                    return;
                }
                renderedTerritories.add(localKey);
                
                const tBounds = getTerritoryBounds(territory);
                if (tBounds && (tBounds.maxLat < viewBox.minLat || tBounds.minLat > viewBox.maxLat || tBounds.maxLng < viewBox.minLng || tBounds.minLng > viewBox.maxLng)) {
                    skipReasons.outOfView++;
                    return;
                }

                const startYear = territory.start || territory.start_year || -5000;
                const endYear = territory.end || territory.end_year || 3000;
                
                if (!(year >= startYear && year <= endYear)) {
                    skipReasons.timeRange++;
                    return;
                }
                
                const dominantResult = calculateDominantCountry(territory, year, month);
                if (!dominantResult) {
                    skipReasons.noCountry++;
                    return;
                }
                
                const dominantCountryId = dominantResult.countryId;
                let countryInfo = getCountryInfoById(dominantCountryId);
                if (!countryInfo) {
                    skipReasons.countryNotFound++;
                    // ğŸ”‘ [ì§„ë‹¨] ë§¤ì¹­ ì‹¤íŒ¨ IDë¥¼ ì²˜ìŒ 10ê°œë§Œ ì¶œë ¥ (ë°ì´í„° ì ê²€ìš©)
                    if (!updateMap._loggedMissingIds) updateMap._loggedMissingIds = new Set();
                    if (updateMap._loggedMissingIds.size < 10 && !updateMap._loggedMissingIds.has(dominantCountryId)) {
                        console.warn(`âš ï¸ [êµ­ê°€ ë§¤ì¹­ ì‹¤íŒ¨] ID: "${dominantCountryId}" (territory: "${territory.name}")`);
                        updateMap._loggedMissingIds.add(dominantCountryId);
                    }
                    // ğŸ”‘ [ê°œì„ ] êµ­ê°€ ì •ë³´ ì—†ì–´ë„ íšŒìƒ‰ìœ¼ë¡œ fallback ë Œë”ë§ (ë¹ˆ ì§€ë„ ë°©ì§€)
                    countryInfo = { color: '#888888', name: dominantCountryId };
                }
                
                // ë¯¼ì¡± í•„í„°ë§
                if (selectedEthnicity !== 'all') {
                    if (!countryInfo.ethnicity || !countryInfo.ethnicity.includes(selectedEthnicity)) {
                        return;
                    }
                }
                
                // Feature ìƒì„±
                const feature = {
                    type: 'Feature',
                    geometry: {
                        type: territory.type,
                        coordinates: territory.coordinates
                    },
                    properties: {
                        name: territory.name,
                        country_id: dominantCountryId,
                        startYear: startYear,
                        endYear: endYear,
                        isExclusive: dominantResult.isExclusive,
                        countriesInZone: dominantResult.countriesInZone
                    }
                };
                
                // êµ­ê°€ë³„ ìˆ˜ì§‘
                if (!countryFeatures.has(dominantCountryId)) {
                    const computedStyle = getTerritoryStyle(territory, countryInfo, year, month);
                    countryFeatures.set(dominantCountryId, {
                        features: [],
                        countryInfo: countryInfo,
                        style: computedStyle
                    });
                }
                countryFeatures.get(dominantCountryId).features.push(feature);
                
                // êµ­ê°€ ì¤‘ì‹¬ì  ì¶”ì  (ê±°ì‹œ ëª¨ë“œìš©)
                _renderedCountryIds.add(dominantCountryId);
                const tBnds = getTerritoryBounds(territory);
                if (tBnds) {
                    const cLat = (tBnds.minLat + tBnds.maxLat) / 2;
                    const cLng = (tBnds.minLng + tBnds.maxLng) / 2;
                    if (_renderedCountryCentroids.has(dominantCountryId)) {
                        const c = _renderedCountryCentroids.get(dominantCountryId);
                        c.lat += cLat; c.lng += cLng; c.count++;
                    } else {
                        _renderedCountryCentroids.set(dominantCountryId, { lat: cLat, lng: cLng, count: 1 });
                    }
                }

                if (typeof renderedTerritoryKeys !== 'undefined') {
                    renderedTerritoryKeys.add(territoryKey);
                }
                
                renderedCount++;
            });
            
            // ğŸš© [v3.3] 2ì°¨ íŒ¨ìŠ¤: êµ­ê°€ë³„ë¡œ FeatureCollection ë Œë”ë§ (ì¤‘ì²© ìƒ‰ìƒ í†µì¼)
            // ê° êµ­ê°€ë§ˆë‹¤ ì „ìš© SVG rendererë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ë ˆë²¨ì—ì„œ opacity ì œì–´
            if (!window._territoryRenderers) window._territoryRenderers = [];
            
            countryFeatures.forEach(({ features, countryInfo, style }, countryId) => {
                const featureCollection = {
                    type: 'FeatureCollection',
                    features: features
                };
                
                // ê·¸ë£¹ opacity ì¶”ì¶œ, ê°œë³„ pathëŠ” fillOpacity=1
                const groupOpacity = style.fillOpacity || 0.3;
                const borderOpacity = style.opacity || 0.6;
                const pathStyle = Object.assign({}, style, {
                    fillOpacity: 1,
                    opacity: 1
                });
                
                // ğŸš© êµ­ê°€ë³„ ì „ìš© SVG renderer ìƒì„± â†’ ìì²´ <svg> ì»¨í…Œì´ë„ˆë¥¼ ê°€ì§
                const countryRenderer = L.svg({ padding: 0.5 });
                window._territoryRenderers.push(countryRenderer);
                
                const countryLayer = L.geoJSON(featureCollection, {
                    style: pathStyle,
                    renderer: countryRenderer,
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        const sY = props.startYear;
                        const eY = props.endYear;
                        let popupContent;
                        if (props.isExclusive) {
                            popupContent = `<b>${props.name || 'ì˜í† '}</b><br>ì§€ë°°êµ­: ${countryInfo.name}<br>ê¸°ê°„: ${sY}ë…„ ~ ${eY === Infinity ? 'í˜„ì¬' : eY + 'ë…„'}`;
                        } else {
                            const zoneNames = (props.countriesInZone || [])
                                .map(cid => { const ci = getCountryInfoById(cid); return ci ? ci.name : cid; })
                                .join(', ');
                            popupContent = `<b>${props.name || 'ì˜í† '}</b><br>ì§€ë°°êµ­: ${countryInfo.name} (í˜¼í•©: ${zoneNames})<br>ê¸°ê°„: ${sY}ë…„ ~ ${eY === Infinity ? 'í˜„ì¬' : eY + 'ë…„'}`;
                        }
                        layer.bindPopup(popupContent);
                    }
                });
                
                territoryLayerGroup.addLayer(countryLayer);
                
                // ğŸš© [v3.3 í•µì‹¬] rendererì˜ SVG ì»¨í…Œì´ë„ˆì— ê·¸ë£¹ opacity ì ìš©
                // ì´ë ‡ê²Œ í•˜ë©´ ê°™ì€ êµ­ê°€ì˜ ëª¨ë“  pathê°€ í•˜ë‚˜ì˜ <svg> ì•ˆì—ì„œ fillOpacity=1ë¡œ ê·¸ë ¤ì§€ê³ ,
                // <svg> ìì²´ì˜ opacityê°€ groupOpacityê°€ ë˜ì–´ ì¤‘ì²© ë¶€ë¶„ë„ ë™ì¼í•œ ìƒ‰ìƒ í†¤ ìœ ì§€
                if (countryRenderer._container) {
                    countryRenderer._container.style.opacity = groupOpacity;
                } else {
                    // ì»¨í…Œì´ë„ˆê°€ ì•„ì§ ì—†ìœ¼ë©´ ë‹¤ìŒ í”„ë ˆì„ì— ì ìš©
                    requestAnimationFrame(() => {
                        if (countryRenderer._container) {
                            countryRenderer._container.style.opacity = groupOpacity;
                        }
                    });
                }
            });
            
            console.log(`âœ… ì˜í†  ë Œë”ë§ ì™„ë£Œ: ${renderedCount}ê°œ í´ë¦¬ê³¤ (${countryFeatures.size}ê°œ êµ­ê°€ ë ˆì´ì–´)`);
            console.log(`ğŸ“Š ìŠ¤í‚µ ì´ìœ : ì¤‘ë³µ=${skipReasons.duplicate}, ë·°í¬íŠ¸ë°–=${skipReasons.outOfView}, ì‹œê°„ë²”ìœ„=${skipReasons.timeRange}, êµ­ê°€ì—†ìŒ=${skipReasons.noCountry}, êµ­ê°€ì°¾ê¸°ì‹¤íŒ¨=${skipReasons.countryNotFound}`);
        }

        // ğŸŒŠ [ì¶”ê°€] ìì—° ì§€í˜•ì§€ë¬¼ (ê°•) ë Œë”ë§
        if (layerVisibility.rivers && naturalFeatures.length > 0) {
            const riverStartTime = performance.now();
            let riverRenderedCount = 0;
            
            naturalFeatures.forEach(feature => {
                if (feature.type === 'river' && feature.geometry && feature.geometry.type === 'LineString') {
                    // GeoJSON LineStringì„ Leaflet Polylineìœ¼ë¡œ ë³€í™˜
                    const latLngs = feature.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    const riverLine = L.polyline(latLngs, {
                        color: '#3498db',      // íŒŒë€ìƒ‰
                        weight: 2,
                        opacity: 0.7,
                        smoothFactor: 1
                    });
                    
                    // íŒì—… ì¶”ê°€ (ì½¤íŒ©íŠ¸ ë²„ì „)
                    const popupContent = `<div style="padding:2px;margin:0;line-height:1.3;"><b style="font-size:13px;">${feature.name}</b><br><span style="font-size:11px;color:#666;">${feature.name_en}</span></div>`;
                    riverLine.bindPopup(popupContent, {
                        className: 'compact-popup',
                        maxWidth: 200,
                        minWidth: 100
                    });
                    
                    territoryLayerGroup.addLayer(riverLine);
                    riverRenderedCount++;
                }
            });
            
            const riverEndTime = performance.now();
          //  console.log(`ğŸŒŠ ê°• ë Œë”ë§ ì™„ë£Œ: ${riverRenderedCount}ê°œ (${(riverEndTime - riverStartTime).toFixed(0)}ms)`);
        }

        // ğŸš€ [ê¹œë¹¡ì„ ë°©ì§€] ìƒˆ ë ˆì´ì–´ê°€ ëª¨ë‘ ê·¸ë ¤ì§„ ë’¤ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ê¸°ì¡´ ë ˆì´ì–´ ì œê±°
        requestAnimationFrame(() => {
            if (oldTerritoryLayerGroup) {
                oldTerritoryLayerGroup.clearLayers(); // ğŸ”§ [ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìˆ˜ì •] GeoJSON í•˜ìœ„ ë ˆì´ì–´ í•´ì œ
                map.removeLayer(oldTerritoryLayerGroup);
            }
            oldRenderers.forEach(r => { try { map.removeLayer(r); } catch(e) {} });
        });

        // ğŸš© [ì¶”ê°€] ìœ ì € ê¸°ì—¬(ë³µì›) ë Œë”ë§
        if (layerVisibility.userContributions) {
            // ê¸°ì—¬ ë ˆì´ì–´ ê·¸ë£¹ì´ ì—†ìœ¼ë©´ ìƒì„±
            if (!contributionLayerGroup) contributionLayerGroup = L.layerGroup().addTo(map);
            if (!map.hasLayer(contributionLayerGroup)) contributionLayerGroup.addTo(map);
            
            contributionLayerGroup.clearLayers();

            contributions.forEach(contrib => {
                // ğŸš© [ìˆ˜ì •] 'ìœ ì €ë³µì›' ë ˆì´ì–´ì—ëŠ” 'ëŒ€ê¸° ì¤‘(pending)'ê³¼ '1ì°¨ ê²€í†  ì™„ë£Œ(reviewed)' ê¸°ì—¬ë§Œ í‘œì‹œ (ìµœì¢… ìŠ¹ì¸ëœ ê²ƒì€ ì •ì‹ ì˜¤ë¸Œì íŠ¸ê°€ ë¨)
                if (contrib.status !== 'pending' && contrib.status !== 'reviewed') return;

                // ğŸš© [ì¶”ê°€] ì‚¬ê´€ ê¸°ë¡ì˜ ê²½ìš° ì¢Œí‘œê°€ ì—†ìœ¼ë¯€ë¡œ ì§€ë„ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
                if (contrib.category === 'historical_record' || !contrib.lat || !contrib.lng) {
                    return;
                }

                // ìì‹ ì˜ ê¸°ì—¬ì¸ì§€ í™•ì¸
                const isMyContribution = currentUser && contrib.userId && (
                    (currentUser.userId && currentUser.userId === contrib.userId.toString()) ||
                    (currentUser.userId && currentUser.userId === contrib.userId) ||
                    (currentUser.id && currentUser.id === contrib.userId.toString()) ||
                    (currentUser.id && currentUser.id === contrib.userId)
                );
                
                // ğŸš© [ìˆ˜ì •] ìƒíƒœì— ë”°ë¼ ë§ˆì»¤ ìƒ‰ìƒ ë³€ê²½: pending(ëŒ€ê¸°) = ì£¼í™©, reviewed(1ì°¨ê²€í† ì™„ë£Œ) = ì´ˆë¡
                const isReviewed = contrib.status === 'reviewed';
                let iconColor;
                if (isReviewed) {
                    iconColor = '#27ae60'; // ì´ˆë¡ìƒ‰: 1ì°¨ ê²€í†  ì™„ë£Œ
                } else if (isMyContribution) {
                    iconColor = '#3498db'; // íŒŒë€ìƒ‰: ë‚´ ëŒ€ê¸° ì¤‘ ì‚¬ë£Œ
                } else {
                    iconColor = '#f39c12'; // ì£¼í™©ìƒ‰: ë‹¤ë¥¸ ì‚¬ëŒì˜ ëŒ€ê¸° ì¤‘ ì‚¬ë£Œ
                }
                const statusTitle = isReviewed ? '1ì°¨ ê²€í†  ì™„ë£Œ' : (isMyContribution ? 'ë‚´ ì‚¬ë£Œ (ëŒ€ê¸° ì¤‘)' : 'ì‚¬ë£Œ (ëŒ€ê¸° ì¤‘)');
                const iconHtml = `<div style="width: 16px; height: 20px; background: ${iconColor}; border: 2px solid #fff; border-radius: 2px; box-shadow: 0 0 4px rgba(0,0,0,0.5); position: relative;" title="${statusTitle}">
                    <div style="width: 8px; height: 2px; background: #fff; position: absolute; top: 4px; left: 2px;"></div>
                    <div style="width: 8px; height: 2px; background: #fff; position: absolute; top: 8px; left: 2px;"></div>
                    <div style="width: 8px; height: 2px; background: #fff; position: absolute; top: 12px; left: 2px;"></div>
                </div>`;
                const contribIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                });

                const marker = L.marker([contrib.lat, contrib.lng], { icon: contribIcon });
                
                let adminControls = '';
                
                // ğŸš© [ìˆ˜ì •] í˜„ì¬ ì‚¬ìš©ì ì •ë³´ë¥¼ í† í°ì—ì„œ ì§ì ‘ íŒŒì‹± (ì „ì—­ currentUserê°€ nullì¼ ìˆ˜ ìˆìŒ)
                let popupCurrentUser = currentUser;
                if (!popupCurrentUser && token) {
                    popupCurrentUser = parseJwt(token);
                }
                
                // ê¶Œí•œì— ë”°ë¥¸ ë²„íŠ¼ í‘œì‹œ
                if (popupCurrentUser) {
                    const userPosition = currentUser ? currentUser.position : popupCurrentUser.position;
                    const userRole = currentUser ? currentUser.role : popupCurrentUser.role;
                    const isAdminRole = userRole === 'admin' || userRole === 'superuser';
                    
                    // ğŸš© ì§ê¸‰ ë°°ì—´ì€ ì„œë²„ì˜ RANK_CONFIG.rolesì™€ ë™ì¼í•˜ê²Œ ìœ ì§€
                    const reviewerPositions = ['ì‹œê°•í•™ì‚¬', 'ì‚¬ê´€ìˆ˜ì°¬', 'ì§ìˆ˜ì°¬ê´€', 'ìˆ˜ì°¬ê´€'];
                    const approverPositions = ['ë™ìˆ˜êµ­ì‚¬', 'ìˆ˜êµ­ì‚¬', 'íŒì‚¬ê´€ì‚¬', 'ê°ìˆ˜êµ­ì‚¬'];
                    
                    const canReview = isAdminRole || reviewerPositions.includes(userPosition);
                    const canApprove = isAdminRole || approverPositions.includes(userPosition);
                    
                    // ğŸš© ê²€í†  ë²„íŠ¼ (ì‹œê°•í•™ì‚¬ ì´ìƒ ë˜ëŠ” admin/superuser) - pending ìƒíƒœì´ë©´ í‘œì‹œ
                    if (canReview && contrib.status === 'pending') {
                        adminControls += `<button onclick="showReviewModal('${contrib._id}')" class="button-style" style="padding: 2px 6px; font-size: 11px; margin-left: 5px; background-color: #f39c12;">ğŸ” ê²€í† </button>`;
                    }
                    
                    // ğŸš© ìŠ¹ì¸ ë²„íŠ¼ (ë™ìˆ˜êµ­ì‚¬ ì´ìƒ ë˜ëŠ” admin/superuser)
                    if (canApprove && (contrib.status === 'reviewed' || contrib.status === 'pending')) {
                        adminControls += `<button onclick="approveContribution('${contrib._id}')" class="button-style primary" style="padding: 2px 6px; font-size: 11px; margin-left: 5px; background-color: #27ae60;">âœ… ìµœì¢… ìŠ¹ì¸</button>`;
                    }
                    
                    // ğŸš© ë§ˆì»¤ ë³€í™˜ ë²„íŠ¼ (ë™ìˆ˜êµ­ì‚¬ ì´ìƒ ë˜ëŠ” admin/superuser) - approved ìƒíƒœì—ì„œ castleì´ ì—†ì„ ë•Œ ìˆ˜ë™ ë³€í™˜ìš©
                    if ((canApprove || isAdminRole) && contrib.status === 'approved') {
                        adminControls += `<button onclick="convertContribution('${contrib._id}')" class="button-style primary" style="padding: 2px 6px; font-size: 11px; margin-left: 5px;">ğŸ° ë§ˆì»¤ ë³€í™˜</button>`;
                    }
                }

                // ğŸš© [ìˆ˜ì •] íŒì—… ì½˜í…ì¸  ë ˆì´ì•„ì›ƒ ê°œì„ 
                const categoryText = {
                    'literature': 'ë¬¸í—Œ ì¦ê±°',
                    'geography': 'ì§€í˜•/ê¸°í›„ ì¦ê±°',
                    'oldmap': 'ê³ ì§€ë„ ì¦ê±°',
                    'other': 'ê¸°íƒ€ ì¶”ë¡ '
                }[contrib.category] || 'ê¸°íƒ€';

                // ğŸš© [ì¶”ê°€] ìƒíƒœë³„ í…ìŠ¤íŠ¸ ë° ìƒ‰ìƒ
                const statusInfo = {
                    'pending': { text: 'ê²€í†  ëŒ€ê¸°', color: '#f39c12', icon: 'â³' },
                    'reviewed': { text: 'ê²€í†  ì™„ë£Œ', color: '#3498db', icon: 'ğŸ”' },
                    'approved': { text: 'ìµœì¢… ìŠ¹ì¸', color: '#27ae60', icon: 'âœ…' },
                    'rejected': { text: 'ê±°ë¶€ë¨', color: '#e74c3c', icon: 'âŒ' }
                }[contrib.status] || { text: 'ì•Œ ìˆ˜ ì—†ìŒ', color: '#95a5a6', icon: 'â“' };

                // ğŸš© [ì¶”ê°€] ê²€í† ì/ìŠ¹ì¸ì ì •ë³´
                let reviewerInfo = '';
                if (contrib.reviewerUsername) {
                    reviewerInfo += `<div style="display: flex; justify-content: space-between;"><span>ê²€í† ì:</span> <span style="color: #3498db;">${contrib.reviewerUsername}</span></div>`;
                }
                if (contrib.approverUsername) {
                    reviewerInfo += `<div style="display: flex; justify-content: space-between;"><span>ìµœì¢… ìŠ¹ì¸ì:</span> <span style="color: #27ae60;">${contrib.approverUsername}</span></div>`;
                }

                const popupContent = `<div style="min-width: 200px; line-height: 1.4; font-size: 13px; white-space: normal;">
                        <h4 style="margin: 0 0 6px 0; color: #000000; border-bottom: 1px solid rgba(0,0,0,0.2); padding-bottom: 4px;">ğŸ“œ ${contrib.name}${isMyContribution ? ' ğŸ‘¤' : ''}</h4>
                        <p style="margin: 0 0 8px 0; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: auto;">${contrib.description}</p>
                        <div style="font-size: 11px; color: #000000; display: flex; flex-direction: column; gap: 3px; border-top: 1px solid rgba(0,0,0,0.2); padding-top: 6px;">
                            <div style="display: flex; justify-content: space-between;"><span>ë³µì›ì:</span> <b>${contrib.username}${isMyContribution ? ' (ë‚˜)' : ''}</b></div>
                            <div style="display: flex; justify-content: space-between;"><span>ì¦ê±° ìœ í˜•:</span> <span>${categoryText}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span>ìƒíƒœ:</span> <span style="color: ${statusInfo.color};">${statusInfo.icon} ${statusInfo.text}</span></div>
                            ${reviewerInfo}
                            <div style="display: flex; justify-content: space-between;"><span>ì¶”ì²œìˆ˜:</span> <span id="vote-count-${contrib._id}">${contrib.votes || 0}</span></div>
                            ${(contrib.commentCount > 0) ? `<div style="display: flex; justify-content: space-between;"><span>ì˜ê²¬:</span> <span style="color: #000000;">ğŸ’¬ ${contrib.commentCount}</span></div>` : ''}
                        </div>
                        <div style="margin-top: 8px; text-align: right; display: flex; justify-content: flex-end; gap: 5px; flex-wrap: wrap;">
                            <button onclick="openContribDetail('${contrib._id}')" class="button-style" style="padding: 2px 6px; font-size: 11px; background-color: #2c3e50; color: white; border-radius: 3px;">ğŸ“„ ìƒì„¸ë³´ê¸°</button>
                            ${isMyContribution && contrib.status !== 'approved' ? `<button onclick="deleteMyContribution('${contrib._id}')" class="button-style" style="padding: 2px 6px; font-size: 11px; background-color: #e74c3c; color: white;">ğŸ—‘ï¸ ì‚­ì œ</button>` : ''}
                            ${currentUser && !isMyContribution && !(contrib.votedBy && contrib.votedBy.includes(currentUser.userId)) ? `<button onclick="voteContribution('${contrib._id}')" class="button-style" style="padding: 2px 6px; font-size: 11px;">ğŸ‘ ì¶”ì²œ</button>` : ''}
                            ${adminControls}
                        </div>
                    </div>`;
                
                marker.bindPopup(popupContent, { autoClose: false, closeOnClick: false });

                // ğŸš© [ì¶”ê°€] ë§ˆìš°ìŠ¤ ì˜¤ë²„ íŒì—… ê¸°ëŠ¥ ì¶”ê°€
                let popupTimeout;
                marker.on('mouseover', function (e) {
                    clearTimeout(popupTimeout);
                    if (currentOpenPopup && currentOpenPopup !== this) currentOpenPopup.closePopup();
                    this.openPopup();
                    currentOpenPopup = this;
                });
                marker.on('popupopen', function (e) {
                    const popup = e.popup;
                    if (popup && popup._container) {
                        popup._container.addEventListener('mouseenter', () => clearTimeout(popupTimeout), { once: true });
                        popup._container.addEventListener('mouseleave', () => this.closePopup(), { once: true });
                        
                        // íŒì—…ì´ ì—´ë¦´ ë•Œ ì¶”ì²œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                        const voteBtn = popup._container.querySelector(`button[onclick="voteContribution('${contrib._id}')"]`);
                        if (voteBtn && currentUser) {
                            const hasVoted = contrib.votedBy && contrib.votedBy.includes(currentUser.userId);
                            voteBtn.textContent = hasVoted ? 'ğŸ‘ ì·¨ì†Œ' : 'ğŸ‘ ì¶”ì²œ';
                            voteBtn.style.backgroundColor = hasVoted ? '#e74c3c' : '#3498db';
                        }
                    }
                });
                marker.on('mouseout', function (e) {
                    popupTimeout = setTimeout(() => {
                        const popup = this.getPopup();
                        if (!popup || !popup._container || !popup._container.matches(':hover')) this.closePopup();
                    }, 300);
                });

                contributionLayerGroup.addLayer(marker);
            });
        } else {
            if (contributionLayerGroup) {
                contributionLayerGroup.clearLayers();
                map.removeLayer(contributionLayerGroup);
            }
        }


        // ğŸš© [ì¶”ê°€] ì €ì¥ëœ ê·¸ë¦¬ê¸° ë°ì´í„° ë Œë”ë§
        drawings.forEach(drawing => {
            const startYear = drawing.start_year || -Infinity;
            const endYear = drawing.end_year || Infinity;

            if (!(year >= startYear && year <= endYear)) return; // í˜„ì¬ ì‹œê°„ëŒ€ì— ì—†ìœ¼ë©´ ë Œë”ë§ ì•ˆí•¨

            // ğŸŒŠ [ìˆ˜ì •] 'ê°•' ìœ í˜•ì€ 'ê°•' ë ˆì´ì–´ í† ê¸€ì— ë”°ë¼ í‘œì‹œ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
            if (drawing.type === 'river' && !layerVisibility.rivers) {
                return; // 'ê°•' ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìœ¼ë©´ ê°•ì„ ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
            }
            // ğŸš© [ìˆ˜ì •] 'ì‚°ë§¥' ìœ í˜•ì€ 'ìì—°' ë ˆì´ì–´ í† ê¸€ì— ë”°ë¼ í‘œì‹œ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
            if (drawing.type === 'mountain' && !layerVisibility.natural) {
                return; // 'ìì—°' ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìœ¼ë©´ ì‚°ë§¥ì„ ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
            }
            // ğŸš© [ì¶”ê°€] 'ì„±ê³½'ê³¼ 'í™”ì‚´í‘œ' ìœ í˜•ì€ 'ì§€ëª…' ë ˆì´ì–´ í† ê¸€ì— ë”°ë¼ í‘œì‹œ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
            if ((drawing.type === 'wall' || drawing.type === 'arrow') && !layerVisibility.label) {
                return; // 'ì§€ëª…' ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìœ¼ë©´ ì„±ê³½ê³¼ í™”ì‚´í‘œë¥¼ ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
            }

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê·¸ë¦¬ê¸° ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
            let layer;
            // ğŸš© [ì¶”ê°€] ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ ë˜ëŠ” ê¸°ë³¸ ìƒ‰ìƒ ì‚¬ìš©
            const customColor = drawing.color || '#3388ff';
            
            switch (drawing.type) {
                case 'wall': // ğŸš© [ìˆ˜ì •] ì„±ê³½ ìŠ¤íƒ€ì¼ì„ 'å‡¹' í…ìŠ¤íŠ¸ë¥¼ ì´ìš©í•œ í…ìŠ¤ì²˜ë¡œ ë³€ê²½
                    // ğŸš© [ìˆ˜ì •] onEachFeatureë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
                    // ğŸš© [í•µì‹¬ ìˆ˜ì •] setTextëŠ” FeatureGroupì„ ë°˜í™˜í•˜ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°”ì¸ë”©ì„ onEachFeatureì—ì„œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
                    layer = L.geoJSON(drawing.geojson, { style: { color: 'transparent', weight: 10, opacity: 0 } })
                             .setText('å‡¹', {
                        repeat: true,
                        offset: 0,
                        attributes: { 'font-size': '12', 'fill': '#ffffff', 'dy': 5, 'class': 'svg-shadow-filter' }
                    });
                    // ìƒì„±ëœ ë ˆì´ì–´ ê·¸ë£¹ì— ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
                    bindDrawingEvents(layer, drawing);
                    break;
                
                case 'river': // ğŸš© [ì¶”ê°€] ê°• ìŠ¤íƒ€ì¼
                    layer = L.geoJSON(drawing.geojson, {
                        style: { color: "#3498db", weight: 6, opacity: 0.7 }, // íŒŒë€ìƒ‰
                        onEachFeature: function (feature, layer) {
                            bindDrawingEvents(layer, drawing);
                        }
                    }); 
                    break;

                case 'mountain': // ğŸš© [ì¶”ê°€] ì‚°ë§¥ ìŠ¤íƒ€ì¼
                    layer = L.geoJSON(drawing.geojson, {
                        style: { 
                            color: "#A0522D", // ê°ˆìƒ‰ ê³„ì—´ (Sienna)
                            weight: 9,
                            opacity: 0.5,
                            dashArray: '5, 10' // ì ì„  ìŠ¤íƒ€ì¼ë¡œ ì‚°ë§¥ í‘œí˜„
                        },
                        pane: 'drawingPane',
                        onEachFeature: (feature, layer) => bindDrawingEvents(layer, drawing)
                    });
                    break;
                    
                case 'general': // ğŸš© [ì¶”ê°€] ì¼ë°˜ë„í˜• - ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ ì‚¬ìš©
                    // ğŸš© [ìˆ˜ì •] Circle íƒ€ì…ì€ íŠ¹ë³„ ì²˜ë¦¬ (GeoJSONì—ì„œ radius ì†ì„± ì‚¬ìš©)
                    if (drawing.geojson.properties && drawing.geojson.properties.radius) {
                        // Circleì„ ìœ„í•œ íŠ¹ë³„ ì²˜ë¦¬
                        const coords = drawing.geojson.geometry.coordinates;
                        layer = L.circle([coords[1], coords[0]], {
                            radius: drawing.geojson.properties.radius,
                            color: customColor,
                            weight: 3,
                            opacity: 0.8,
                            fillColor: customColor,
                            fillOpacity: 0.5,
                            pane: 'drawingPane'
                        });
                        bindDrawingEvents(layer, drawing);
                    } else {
                        // ì¼ë°˜ GeoJSON (Polygon, LineString, Point ë“±)
                        layer = L.geoJSON(drawing.geojson, {
                            style: function(feature) {
                                return {
                                    color: customColor,
                                    weight: 3,
                                    opacity: 0.8,
                                    fillColor: customColor,
                                    fillOpacity: 0.5,
                                    pane: 'drawingPane'
                                };
                            },
                            // ğŸš© [ì¶”ê°€] Point íƒ€ì…(ë§ˆì»¤)ì„ ì›ìœ¼ë¡œ í‘œì‹œ
                            pointToLayer: function(feature, latlng) {
                                return L.circleMarker(latlng, {
                                    radius: 8,
                                    color: customColor,
                                    weight: 3,
                                    opacity: 0.8,
                                    fillColor: customColor,
                                    fillOpacity: 0.5,
                                    pane: 'drawingPane'
                                });
                            },
                            onEachFeature: (feature, layer) => bindDrawingEvents(layer, drawing)
                        });
                    }
                    break;
                    
                case 'arrow': 
                    // ğŸš© [ìˆ˜ì •] ì—¬ëŸ¬ ì„ ë¶„(segment)ì— ì•„ì´ì½˜ì´ ì¤‘ë³µë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ L.polylineìœ¼ë¡œ ë³€í™˜
                    if (drawing.geojson.geometry.type === 'LineString') {
                        const latlngs = drawing.geojson.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        // ğŸš© [í•µì‹¬ ìˆ˜ì •] setTextëŠ” FeatureGroupì„ ë°˜í™˜í•˜ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°”ì¸ë”©ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤.
                        layer = L.polyline(latlngs, { color: 'transparent', weight: 10, opacity: 0, pane: 'drawingPane' })
                                 .setText('â±', {
                                     repeat: true,
                                     offset: 0,
                                     attributes: { 'font-size': '20', 'fill': '#ffffff', 'dy': 5 }
                                 });
                        bindDrawingEvents(layer, drawing); // ìƒì„±ëœ ë ˆì´ì–´ ê·¸ë£¹ì— ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
                    } else { // Polygon ë“± ë‹¤ë¥¸ íƒ€ì…ì€ ê¸°ì¡´ ë°©ì‹ ìœ ì§€
                        layer = L.geoJSON(drawing.geojson, { style: { color: 'transparent', weight: 10, opacity: 0 } }); // ì´ë²¤íŠ¸ ë°”ì¸ë”© í•„ìš” ì‹œ ì¶”ê°€
                    }
                    break;

                default: // ì‚°ë§¥, ë„ë¡œ ë“± ê¸°íƒ€
                    // ğŸš© [ìˆ˜ì •] í™”ì‚´í‘œ ë°ì½”ë ˆì´í„°ë¥¼ ì œê±°í•˜ê³ , ì¼ë°˜ ì„ /ë„í˜•ë§Œ ê·¸ë¦¬ë„ë¡ ë³€ê²½
                    layer = L.geoJSON(drawing.geojson, {
                        style: { 
                            color: "#ffffff", // í°ìƒ‰ ì„ 
                            weight: 5,       // ë‘ê»˜
                            opacity: 0.5     // íˆ¬ëª…ë„
                        },
                        pane: 'drawingPane', // ì „ìš© Paneì— ê·¸ë¦¬ê¸°
                        onEachFeature: function (feature, layer) {
                            bindDrawingEvents(layer, drawing);
                        }
                    });
                    break;
            }

            if (layer) {
                // layer._leaflet_idëŠ” bindDrawingEvents ë‚´ë¶€ì—ì„œ ì„¤ì •ë©ë‹ˆë‹¤.
                drawnItems.addLayer(layer);
            }
        });

        // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ë ˆì´ì–´ì— ëŒ€í•œ ê³µí†µ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜
        function bindDrawingEvents(layer, drawingData) {
            layer._leaflet_id = drawingData._id; // ì‚­ì œ/í¸ì§‘ì„ ìœ„í•œ ID ì—°ê²°
            layer.bindPopup(`<b>${drawingData.name}</b> (${drawingData.type})`);
            
            // ğŸš© [ìˆ˜ì •] mouseover íŒì—…ì„ ì œê±°í•˜ê³ , í´ë¦­ ì‹œì—ë§Œ íŒì—…ì´ ë‚˜íƒ€ë‚˜ë„ë¡ ìˆ˜ì •
            layer.on('click', (e) => { 
                // ğŸš© [ìˆ˜ì •] ë§ˆì»¤ì¸ ê²½ìš° í´ë¦­í•œ ìœ„ì¹˜ì—, ë„í˜•ì¸ ê²½ìš° ì¤‘ì‹¬ì— íŒì—… í‘œì‹œ
                if (layer instanceof L.Marker) {
                    layer.openPopup();
                } else {
                    layer.openPopup(e.latlng);
                }
                
                // ğŸš© [ìˆ˜ì •] ë§ˆì»¤ì™€ ë„í˜•ì„ êµ¬ë¶„í•˜ì—¬ ì´ë™ ì²˜ë¦¬
                if (layer instanceof L.Marker) {
                    map.flyTo(layer.getLatLng(), 10);
                } else {
                    const bounds = layer.getBounds();
                    if (bounds && bounds.isValid()) {
                        map.flyTo(bounds.getCenter(), 8);
                    }
                }
                
                // ğŸš© í¸ì§‘ ëª¨ë“œì¼ ë•Œ í¼ ì—´ê¸°
                if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) {
                    const geojsonToEdit = drawingData.geojson;
                    openDrawingForm(geojsonToEdit, drawingData);
                }
            });
        }

        castleLayerGroup.clearLayers(); // ë§ˆì»¤ ë ˆì´ì–´ëŠ” ê¸°ì¡´ì²˜ëŸ¼ í´ë¦¬ì–´ í›„ ë‹¤ì‹œ ì¶”ê°€
        markers = [];

        // ï¿½ [ë©”ëª¨ë¦¬ ìµœì í™”] ë§ˆì»¤ ë Œë”ë§ ì‹œ í˜„ì¬ padded bounds ê¸°ë¡ (moveend ì¬ë Œë”ë§ íŒë‹¨ìš©)
        window._lastMarkerRenderBounds = map.getBounds().pad(1.0);

        // ï¿½ğŸš© êµ­ê°€ëª… í…ìŠ¤íŠ¸ í•­ìƒ ê°±ì‹  (ì¤Œ ë ˆë²¨ ë¬´ê´€)
        renderMacroCountryNames();
        if (!map.hasLayer(macroCountryLayer)) macroCountryLayer.addTo(map);

        // ğŸš© [ê³¼ì œ1] ê±°ì‹œ ëª¨ë“œ(zoom < 6)ì—ì„œëŠ” ìì—°ì§€ë¬¼/ë¼ë²¨ë§Œ ë Œë”ë§
        if (currentMacroMode === 0) {
            console.log('ğŸ”­ [LOD] ê±°ì‹œ ëª¨ë“œ â†’ ìì—°ì§€ë¬¼/ë¼ë²¨ ë Œë”ë§');
            allCastleMarkers = [];
        } else if (currentMacroMode === 1) {
            console.log('ğŸ” [LOD] ì¤‘ê°„ ëª¨ë“œ â†’ ìˆ˜ë„+ìì—°ì§€ë¬¼/ë¼ë²¨ ë Œë”ë§ (ì•½ 200km ë·°)');
        }
        
        console.log(`ğŸ° ì„±/ë„ì‹œ ë Œë”ë§ ì‹œì‘: castles=${castles.length}, layerVisibility.city=${layerVisibility.city}`);
        
        if (!Array.isArray(castles) || castles.length === 0) {
            console.warn('âš ï¸ castles ë°°ì—´ì´ ë¹„ì–´ìˆê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹˜');
            // castlesê°€ ì—†ì–´ë„ ë¡œë”© ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ â€” territoriesë§Œ ìˆì–´ë„ í•´ì œ ê°€ëŠ¥
            window._castleMarkersRendered = true;
            return;
        }
        
        // ğŸš¨ [ì œê±°] city ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìœ¼ë©´ ê°•ì œë¡œ ì¼œëŠ” ë””ë²„ê·¸ ì½”ë“œ ì œê±°
        // if (!layerVisibility.city) {
        //     console.warn('âš ï¸ city ë ˆì´ì–´ê°€ êº¼ì ¸ìˆìŒ! ê°•ì œë¡œ ì¼œì„œ ë””ë²„ê¹…í•©ë‹ˆë‹¤.');
        //     layerVisibility.city = true;
        // }
        
        let renderedCastleCount = 0;
        let marker;
        
        // ğŸš€ [ìµœì í™”] ë·°í¬íŠ¸ ë°– ë§ˆì»¤ ìŠ¤í‚µì„ ìœ„í•œ í˜„ì¬ í™”ë©´ ë²”ìœ„ ìºì‹±
        const _viewBounds = map.getBounds();
        const _viewPadded = _viewBounds.pad(1.5); // 150% ì—¬ìœ  â€” ì¤Œ/ì´ë™ í›„ ì„± ëˆ„ë½ ë°©ì§€
        
        labelLayerGroup.clearLayers(); // ğŸš© [ì¶”ê°€] ë¼ë²¨ ë ˆì´ì–´ í´ë¦¬ì–´
        castleLayerGroup.clearLayers();
        allCastleMarkers = []; // ğŸš€ [ìµœì í™”] ë§¤ ë Œë”ë§ ì‹œ ë§ˆì»¤ íŠ¸ë˜í‚¹ ë°°ì—´ ì´ˆê¸°í™”
        castles.forEach(castle => {
            // ğŸš© LOD í•„í„°ë§
            // ê±°ì‹œ ëª¨ë“œ(zoom < 6,  ì•½ 300km+): ìì—°ì§€ë¬¼/ë¼ë²¨ë§Œ
            // ì¤‘ê°„ ëª¨ë“œ(zoom 6~<7, ì•½ 200km):  ìì—°ì§€ë¬¼/ë¼ë²¨/ìˆ˜ë„ë§Œ
            // ë¯¸ì‹œ ëª¨ë“œ(zoom >= 7, ì•½ 100km):  ì „ì²´ ì„± í‘œì‹œ
            const _isMacro = currentMacroMode === 0;
            const _isMid   = currentMacroMode === 1;
            // is_capital: castle ìµœìƒìœ„ or history ë ˆì½”ë“œ ì¤‘ í•˜ë‚˜ë¼ë„ trueë©´ ìˆ˜ë„ë¡œ ê°„ì£¼
            const _isCapital = castle.is_capital ||
                (Array.isArray(castle.history) && castle.history.some(h => h.is_capital));
            if (_isMacro && !castle.is_natural_feature && !castle.is_label) return;
            if (_isMid   && !castle.is_natural_feature && !castle.is_label && !_isCapital) return;
            
            const baseCountryId = castle.country_id || castle.countryId || (Array.isArray(castle.history) && castle.history.length > 0 ? castle.history[0]?.country_id : null);

            // ğŸš© [ì¶”ê°€] êµ­ê°€ í•„í„°ë§ ë¡œì§
            if (selectedCountryId !== 'all' && baseCountryId && baseCountryId !== selectedCountryId) {
                return; // ì„ íƒëœ êµ­ê°€ì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì´ ë§ˆì»¤ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
            }
            
            let popupHtml; 
            if (typeof castle.lat !== "number" || isNaN(castle.lat) || typeof castle.lng !== "number" || isNaN(castle.lng)) return;
            
            // ğŸš€ [ìµœì í™”] ë·°í¬íŠ¸ ë°–ì˜ ë§ˆì»¤ëŠ” ë Œë”ë§ ìŠ¤í‚µ (ìˆ˜ë„ëŠ” í•­ìƒ ë Œë”ë§)
            if (!_isCapital && !_viewPadded.contains(L.latLng(castle.lat, castle.lng))) {
                return;
            }
            
            // ğŸ·ï¸ [ìµœìš°ì„ ] ë¼ë²¨ì€ history ë°°ì—´ì´ ì—†ìœ¼ë¯€ë¡œ ë¨¼ì € ì²˜ë¦¬
            if (castle.is_label) {
                const labelType = castle.label_type || 'place';

                // ğŸš© label_type='country'ëŠ” macroCountryLayerì—ì„œ ì˜í†  ê¸°ë°˜ìœ¼ë¡œ í‘œì‹œí•˜ë¯€ë¡œ ì œì™¸
                if (labelType === 'country') return;

                let shouldRender = false;
                if (labelType === 'ethnic') {
                    shouldRender = layerVisibility.ethnicLabel;
                } else {
                    shouldRender = layerVisibility.placeLabel;
                }
                
                if (!shouldRender) return;
                
                // ë¼ë²¨ì˜ ì‹œê°„ ë²”ìœ„ ì²´í¬ (built_year/destroyed_year ì‚¬ìš©)
                const startYear = castle.start_year || castle.built_year || -Infinity;
                const endYear = castle.end_year || castle.destroyed_year || Infinity;
                const isWithinDuration = startYear <= year && endYear >= year;
                
                if (!isWithinDuration) return;
                
                const castleName = castle.name;
                const builtText = castle.built_year ? `${castle.built_year}ë…„` : 'ë¯¸ìƒ';
                const destroyedText = castle.destroyed_year ? `${castle.destroyed_year}ë…„` : 'í˜„ì¬';
                
                // ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ë˜ëŠ” í…ìŠ¤íŠ¸ ë¼ë²¨
                if (castle.custom_icon) {
                    const iconWidth = castle.icon_width || 32;
                    const iconHeight = castle.icon_height || 32;
                    const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                    const labelIcon = L.divIcon({
                        className: 'custom-icon-marker',
                        html: customIconHtml,
                        iconSize: [iconWidth, iconHeight],
                        iconAnchor: [iconWidth / 2, 0],
                        pane: 'labelPane'
                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: labelIcon, pane: 'labelPane' });
                } else {
                    const labelSize = castle.label_size || 'medium';
                    let fontSize;
                    switch (labelSize) {
                        case 'small': fontSize = 14; break;
                        case 'large': fontSize = 22; break;
                        default: fontSize = 18;
                    }
                    
                    const labelIcon = L.divIcon({
                        className: 'label-text-marker',
                        html: `<div style="
                            font-size: ${fontSize}px;
                            font-weight: bold;
                            color: ${castle.label_color || '#FFFFFF'}; 
                            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 2px #000;
                            white-space: nowrap;
                            text-align: center;
                        ">${castleName}</div>`,
                        iconSize: [150, 40],
                        iconAnchor: [75, 0],
                        pane: 'labelPane'
                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: labelIcon, pane: 'labelPane' });
                }
                
                const editorInfoHtml = castle.lastModifiedBy 
                    ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}</small>` 
                    : (castle.createdBy ? `<br><small>ìƒì„±ì: ${castle.createdBy}</small>` : '');
                
                popupHtml = `<b>ì§€ì—­ëª…: ${castleName}</b><br>ê¸°ê°„: ${builtText} ~ ${destroyedText}<br>ì„¤ëª…: ${castle.desc ?? ''}${editorInfoHtml}`;
                
                marker.bindPopup(popupHtml, { autoClose: false, closeOnClick: false });
                
                let popupTimeout;
                
                marker.on('mouseover', function(e) {
                    clearTimeout(popupTimeout);
                    if (currentOpenPopup && currentOpenPopup !== this) {
                        currentOpenPopup.closePopup();
                    }
                    this.openPopup();
                    currentOpenPopup = this;
                });
                
                marker.on('popupopen', function(e) {
                    const popup = e.popup;
                    if (popup && popup._container) {
                        popup._container.addEventListener('mouseenter', function() {
                            clearTimeout(popupTimeout);
                        }, { once: true });
                        popup._container.addEventListener('mouseleave', function() {
                            if (marker && marker.closePopup) {
                                marker.closePopup();
                            }
                        }, { once: true });
                    }
                });
                
                marker.on('mouseout', function(e) {
                    popupTimeout = setTimeout(() => {
                        const popup = this.getPopup();
                        if (!popup || !popup._container || !popup._container.matches(':hover')) {
                            this.closePopup();
                        }
                    }, 300);
                });
                
                marker.on('click', (e) => { 
                    map.flyTo(e.latlng, 10);
                    if (editMode) {
                        openCastleForm(castle._id);
                    } else {
                        if (marker && marker._popup) {
                            marker.openPopup();
                        }
                    }
                });
                
                marker._castleData = castle;
                markers.push(marker);
                marker.addTo(labelLayerGroup); // ğŸš© [ìˆ˜ì •] ë¼ë²¨ì€ labelLayerGroupì— ì¶”ê°€
                return; // ë¼ë²¨ ì²˜ë¦¬ ì™„ë£Œ, ë‹¤ìŒ castleë¡œ
            }
            
        // ğŸš¨ [ìˆ˜ì • 1] country, countryId ë³€ìˆ˜ë¥¼ ë£¨í”„ ì‹œì‘ ë¶€ë¶„ì—ì„œ ì„ ì–¸í•˜ì—¬ ì¶©ëŒ ë°©ì§€        
        const currentTotalMonths = yearMonthToTotalMonths(year, month);
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] í˜„ì¬ ì‹œê°„ì— ë§ëŠ” ì—­ì‚¬ ê¸°ë¡ ì°¾ê¸°
        const activeHistoryInfo = getActiveHistoryInfo(castle.history, currentTotalMonths);

        // ğŸš© [FIX] ì¼ë¶€ ì§€ëª…ì´ ì˜ëª» `is_natural_feature: true`ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²½ìš°(ì˜ˆ: 'ì›”ì„±')
        // ì´ë¦„/ìˆ˜ë„ ì—¬ë¶€ ê¸°ë°˜ì˜ íœ´ë¦¬ìŠ¤í‹±ìœ¼ë¡œ í™”ë©´ ë Œë”ë§ ì‹œì—ëŠ” ì¸ê³µêµ¬ì¡°ë¬¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        const effectiveIsNatural = (() => {
            // ì›ë˜ ê°’ì´ falseë©´ ê·¸ëŒ€ë¡œ false
            if (!castle.is_natural_feature) return false;

            // ëª…ì‹œì  ì˜ˆì™¸: ìˆ˜ë„ì´ê±°ë‚˜ ì´ë¦„ì— 'ì„±/ê¶/åŸ'ì´ í¬í•¨ëœ ê²½ìš°ëŠ” ì¸ê³µ êµ¬ì¡°ë¬¼ë¡œ ê°„ì£¼
            const nameSuggestsManmade = typeof castle.name === 'string' && /ì„±|ê¶|åŸ/.test(castle.name);
            if (castle.is_capital || nameSuggestsManmade) {
                console.log(`âš ï¸ [ìì—°ì§€ë¬¼ ì˜¤ë¶„ë¥˜ ë³´ì •] '${castle.name}'ë¥¼ ì¸ê³µ êµ¬ì¡°ë¬¼ë¡œ ì²˜ë¦¬ (ì›ë³¸ is_natural_feature=true)`);
                return false;
            }

            // ê·¸ ì™¸ëŠ” ì›ë˜ê°’ ìœ ì§€
            return true;
        })();

        // ğŸš© [ìˆ˜ì •] ìœ íš¨í•œ ì—­ì‚¬ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì´ ì„±ì„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ (ìì—° ì§€í˜•ì§€ë¬¼ ì œì™¸)
        if (!activeHistoryInfo && !effectiveIsNatural) return;

        const { record: activeHistoryRecord, startYear: recordStartYear, startMonth: recordStartMonth, endYear: recordEndYear, endMonth: recordEndMonth } = activeHistoryInfo || {};

    const castleName = activeHistoryRecord?.name || castle.name;
    const countryId = activeHistoryRecord?.country_id || castle.country_id || castle.countryId;
        const countryInfo = getCountryInfoById(countryId);
        const countryName = countryInfo ? countryInfo.name : 'ì•Œ ìˆ˜ ì—†ìŒ';
        const dotColor = countryInfo ? countryInfo.color : 'white';

        // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„°ë§ ë¡œì§ (ë¶€ë¶„ ì¼ì¹˜) - í˜„ì¬ í™œì„±í™”ëœ íˆìŠ¤í† ë¦¬ì˜ êµ­ê°€ ë¯¼ì¡±ë§Œ ì²´í¬
        if (selectedEthnicity !== 'all') {
            if (!countryInfo || !countryInfo.ethnicity || !countryInfo.ethnicity.includes(selectedEthnicity)) {
                return; // í˜„ì¬ ì‹œì ì˜ êµ­ê°€ê°€ ì„ íƒëœ ë¯¼ì¡±ì„ í¬í•¨í•˜ì§€ ì•Šìœ¼ë©´ ì œì™¸
            }
        }

        const isWithinDuration = activeHistoryInfo ? true : (effectiveIsNatural ?
            ((castle.built_year || castle.start_year) && (castle.destroyed_year || castle.end_year)) ?
                (((castle.built_year || castle.start_year || -Infinity) <= year) && ((castle.destroyed_year || castle.end_year || Infinity) >= year)) :
                true : // built_year/start_yearê°€ ëª¨ë‘ ì—†ëŠ” ìì—°ì§€ë¬¼ì€ í•­ìƒ í‘œì‹œ
            false);
         // console.log ì œê±° (ì„±ëŠ¥ ìµœì í™” â€” ë£¨í”„ ë‚´ ë°˜ë³µ í˜¸ì¶œ ë°©ì§€)
         const builtText = `${recordStartYear}ë…„ ${recordStartMonth}ì›”`;
         const destroyedText = recordEndYear === null ? 'í˜„ì¬' : `${recordEndYear}ë…„ ${recordEndMonth}ì›”`;
         
         const king = getKingByYear(countryName, year, month); // â¬…ï¸ king ì¡°íšŒëŠ” countryName ì‚¬ìš©

             // ğŸš© 1. ìì—° ì§€ë¬¼ ë§ˆì»¤ (NEW)
            if (effectiveIsNatural) { 
                 if (!layerVisibility.natural) {
                     return;
                 }
                 // ğŸš© [ìˆ˜ì •] ìì—° ì§€í˜•ì§€ë¬¼ ì‹œê°„ ë²”ìœ„ ì²´í¬
                 if (!isWithinDuration) {
                     return;
                 }

                // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
                if (castle.custom_icon) {
                    const iconWidth = castle.icon_width || 32;
                    const iconHeight = castle.icon_height || 32;
                    const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                    const featureIcon = L.divIcon({
                        className: 'custom-icon-marker',
                        html: customIconHtml,
                        iconSize: [iconWidth, iconHeight],
                        iconAnchor: [iconWidth / 2, iconHeight],
                        popupAnchor: [0, -iconHeight]
                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: featureIcon });
                } else {
                    const featureType = castle.natural_feature_type || 'other';
                    let iconInfo = getNaturalFeatureIcon(featureType);
                    if (!iconInfo) {
                        iconInfo = getNaturalFeatureIcon('other');
                    }
                    const iconClass = iconInfo?.className || 'feature-other';
                    const iconSymbol = iconInfo?.symbol || 'â–';
                    
                    const featureIcon = L.divIcon({
                        className: `natural-feature-marker ${iconClass} sumi-ink-effect`,
                            html: `<div>${iconSymbol}</div><div class="feature-name">${castleName}</div>`,
                            iconSize: [60, 40],
                            iconAnchor: [30, 40],
                            popupAnchor: [6, -30] // ğŸš© [ì¶”ê°€] íŒì—… ìœ„ì¹˜ë¥¼ ì•„ì´ì½˜ ìƒë‹¨ìœ¼ë¡œ ì¡°ì •
                    });
                    marker = L.marker([castle.lat, castle.lng], { icon: featureIcon });
                }
                
                const editorInfoHtml = castle.lastModifiedBy 
                    ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}</small>` 
                    : (castle.createdBy ? `<br><small>ìƒì„±ì: ${castle.createdBy}</small>` : '');
                
                // ğŸš© [v2.0.6] ì½¤íŒ©íŠ¸ íŒì—… - ê³µë°± ì™„ì „ ì œê±° (í•œ ì¤„ë¡œ)
                popupHtml = `<div style="padding:0;margin:0;line-height:1.4;"><b style="font-size:14px;">${castleName}</b>${castle.desc ? `<br><span style="font-size:12px;">${castle.desc}</span>` : ''}${castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px;max-height:100px;object-fit:cover;margin-top:4px;">` : ''}${editorInfoHtml}</div>`;
                                
                marker.bindPopup(popupHtml, {
                    className: 'compact-popup',
                    maxWidth: 200,
                    minWidth: 100
                });
                // ğŸš© [ìˆ˜ì •] ë§ˆìš°ìŠ¤ ì˜¤ë²„ íŒì—…ì„ ì œê±°í•˜ê³ , í´ë¦­ ì‹œì—ë§Œ íŒì—…ì´ ë‚˜íƒ€ë‚˜ë„ë¡ ìˆ˜ì •
                // Use a normal function so `this` is bound to the marker instance
                marker.on('click', function (e) { 
                    // `this` is the marker that was clicked; avoid referencing outer `marker` variable
                    if (this && typeof this.openPopup === 'function') this.openPopup(); // íŒì—… ì—´ê¸°
                    map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                    if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) openCastleForm(castle._id); 
                });
                markers.push(marker);
                 marker.addTo(castleLayerGroup);
                return; // ğŸš© [ë³µì›] ë‹¤ë¥¸ ë§ˆì»¤ íƒ€ì…ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ return ì¶”ê°€
            }

            // ğŸš© [ì œê±°] ë…ë¦½ëœ ì „ì¥ ë§ˆì»¤ íƒ€ì…ì€ ì´ì œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ì—­ì‚¬ ë ˆì½”ë“œì˜ is_battle í”Œë˜ê·¸ ì‚¬ìš©)

            // ğŸš© 2. êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            if (castle.is_military_flag) {
                if (!layerVisibility.military) return;
                // ... ê¸°ì¡´ êµ°ëŒ€ í”Œë˜ê·¸ ë§ˆì»¤ ë Œë”ë§ ë¡œì§ ìœ ì§€ ...
                // ğŸš© [ìˆ˜ì •] isWithinDuration ì²´í¬
                if (!isWithinDuration) return; 
                
                let markerLat = castle.lat;
                let markerLng = castle.lng;
                let shouldDisplay = true; // isWithinDurationì´ trueì´ë¯€ë¡œ ê¸°ë³¸ í‘œì‹œ

                if (Array.isArray(castle.path_data) && castle.path_data.length >= 2) {
                    // ê²½ë¡œê°€ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´, ê²½ë¡œ ë³´ê°„ ë¡œì§ì„ ë”°ë¦„
                    const position = getMilitaryPosition(castle.path_data, currentTotalMonths);
                    if (position) {
                        markerLat = position.lat;
                        markerLng = position.lng;
                        // shouldDisplayëŠ” ì´ë¯¸ true.
                    } else {
                        shouldDisplay = false; // ê²½ë¡œ ë²”ìœ„ ë°–ì´ë©´ ë¯¸í‘œì‹œ
                    }
                } 
                // else: ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì •ì  ìœ„ì¹˜(castle.lat/lng) ì‚¬ìš©

                if (!shouldDisplay) return;

                // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
                if (castle.custom_icon) {
                    const iconWidth = castle.icon_width || 32;
                    const iconHeight = castle.icon_height || 32;
                    const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                    const flagIcon = L.divIcon({
                        className: 'custom-icon-marker',
                        html: customIconHtml,
                        iconSize: [iconWidth, iconHeight],
                        iconAnchor: [iconWidth / 2, iconHeight],
                        popupAnchor: [0, -iconHeight]
                    });
                    marker = L.marker([markerLat, markerLng], { icon: flagIcon });
                    
                    const flagHtml = countryInfo.flag ? `<img src="${countryInfo.flag}" class="country-flag-img" style="width: 20px; height: 13px; border: 1px solid #ccc; vertical-align: middle; margin-right: 5px;">` : '';
                    const descriptionHtml = castle.desc ? `<br>ì„¤ëª…: ${castle.desc}` : '';
                    const metaInfo = [];
                    if (castle.createdBy) metaInfo.push(`ìƒì„±ì: ${castle.createdBy}`);
                    if (castle.lastModifiedBy) metaInfo.push(`ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}`);
                    const editorInfoHtml = metaInfo.length ? `<br><small>${metaInfo.join('<br>')}</small>` : '';
                    
                    popupHtml = `${flagHtml}<b>${countryName}</b>${countryInfo.ethnicity ? `<br>ë¯¼ì¡±: ${countryInfo.ethnicity}` : ''}<br>${castle.general_name ? `ì¥ìˆ˜: ${castle.general_name}<br>` : ''}${castle.troop_count ? `ë³‘ë ¥: ${Number(castle.troop_count).toLocaleString()}<br>` : ''}${castle.general_photo ? `<br><img src="${castle.general_photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ''}${descriptionHtml}${editorInfoHtml}`;
                    
                    marker.bindPopup(popupHtml, { autoClose: false, closeOnClick: false });
                    
                    let popupTimeout;
                    
                    marker.on('mouseover', function(e) {
                        clearTimeout(popupTimeout);
                        // ì´ì „ íŒì—… ë‹«ê¸°
                        if (currentOpenPopup && currentOpenPopup !== this) {
                            currentOpenPopup.closePopup();
                        }
                        this.openPopup();
                        currentOpenPopup = this;
                    });
                    
                    marker.on('popupopen', function(e) {
                        const popup = e.popup;
                        if (popup && popup._container) {
                            popup._container.addEventListener('mouseenter', function() {
                                clearTimeout(popupTimeout);
                            }, { once: true });
                            popup._container.addEventListener('mouseleave', function() {
                                marker.closePopup();
                            }, { once: true });
                        }
                    });
                    
                    marker.on('mouseout', function(e) {
                        popupTimeout = setTimeout(() => {
                            const popup = this.getPopup();
                            if (!popup || !popup._container || !popup._container.matches(':hover')) {
                                this.closePopup();
                            }
                        }, 300);
                    });
                    
                    marker.on('click', (e) => { 
                        map.flyTo(e.latlng, 10);
                        if (editMode) {
                            openCastleForm(castle._id);
                        } else {
                            if (marker && marker._popup) {
                                marker.openPopup();
                            }
                        }
                    });
                    markers.push(marker);
                    marker.addTo(castleLayerGroup);
                    return;
                }

                const general = castle.general_name || 'ì¥ìˆ˜ ë¯¸ìƒ';
                const troops = castle.troop_count ? `${Number(castle.troop_count).toLocaleString()}` : 'ë³‘ë ¥ ë¯¸ìƒ';
                const flagColor = countryInfo.color || "white";  
                const generalPhotoUrl = castle.general_photo || ''; 

                // ğŸš© [ìˆ˜ì •] ì¥ìˆ˜ ì‚¬ì§„ ìœ ë¬´ì— ë”°ë¼ ì•„ì´ì½˜ ë‚´ìš©ì„ ë‹¤ë¥´ê²Œ êµ¬ì„±í•©ë‹ˆë‹¤.
                let iconContent;
                if (generalPhotoUrl) {
                    // ì‚¬ì§„ì´ ìˆì„ ê²½ìš°: ì‚¬ì§„ê³¼ í…ìŠ¤íŠ¸ë¥¼ ì¤‘ì•™ ì •ë ¬
                    iconContent = `
                        <div style="display: flex; flex-direction: column; align-items: center; text-align: center; gap: 2px;">
                            <div class="military-flag-details">
                                <span style="color:white">${troops}</span>
                            </div>
                            <img src="${generalPhotoUrl}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 3px solid ${flagColor};">
                            <div class="military-flag-details">
                                <span style="color:white">${general}</span>
                            </div>
                        </div>`;
                } else {
                    // ì‚¬ì§„ì´ ì—†ì„ ê²½ìš°: ê¸°ì¡´ ê¹ƒë°œ ì•„ì´ì½˜ ì‚¬ìš©
                    iconContent = `
                        <div class="flag-icon-container">
                            <div class="flag-icon-symbol" style="color:${flagColor};">âš‘</div>
                            <div class="military-flag-details" style="color:${flagColor}; font-size: 10px;">${countryName} ${general}<br>${troops}</div>
                        </div>`;
                }

                const flagIcon = L.divIcon({
                    className: 'custom-flag-marker', 
                    html: `<div style="display: flex; justify-content: center; align-items: center;">${iconContent}</div>`, 
                    iconSize: [70, 60],
                    iconAnchor: [35, 60],
                    popupAnchor:  [0, -60] // ğŸš© [ìˆ˜ì •] íŒì—… ìœ„ì¹˜ë¥¼ ì•„ì´ì½˜ ìƒë‹¨ìœ¼ë¡œ ì¡°ì •
                });
                
                marker = L.marker([markerLat, markerLng], { icon: flagIcon }); 
                
                const flagHtml = countryInfo.flag ? `<img src="${countryInfo.flag}" class="country-flag-img" style="width: 20px; height: 13px; border: 1px solid #ccc; vertical-align: middle; margin-right: 5px;">` : '';

                const descriptionHtml = castle.desc ? `<br>ì„¤ëª…: ${castle.desc}` : '';
                const metaInfo = [];
                if (castle.createdBy) metaInfo.push(`ìƒì„±ì: ${castle.createdBy}`);
                if (castle.lastModifiedBy) metaInfo.push(`ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}`);
                const editorInfoHtml = metaInfo.length ? `<br><small>${metaInfo.join('<br>')}</small>` : '';

                popupHtml = `${flagHtml}<b>${countryName}</b>${countryInfo.ethnicity ? `<br>ë¯¼ì¡±: ${countryInfo.ethnicity}` : ''}<br>ì¥ìˆ˜: ${general}<br>ë³‘ë ¥: ${troops}<br>${generalPhotoUrl ? `<br><img src="${generalPhotoUrl}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ''}${descriptionHtml}${editorInfoHtml}`;
                
                marker.bindPopup(popupHtml, { autoClose: false, closeOnClick: false });
                
                let popupTimeout;
                
                marker.on('mouseover', function(e) {
                    clearTimeout(popupTimeout);
                    // ì´ì „ íŒì—… ë‹«ê¸°
                    if (currentOpenPopup && currentOpenPopup !== this) {
                        currentOpenPopup.closePopup();
                    }
                    this.openPopup();
                    currentOpenPopup = this;
                });
                
                marker.on('popupopen', function(e) {
                    const popup = e.popup;
                    if (popup && popup._container) {
                        popup._container.addEventListener('mouseenter', function() {
                            clearTimeout(popupTimeout);
                        }, { once: true });
                        popup._container.addEventListener('mouseleave', function() {
                            marker.closePopup();
                        }, { once: true });
                    }
                });
                
                marker.on('mouseout', function(e) {
                    popupTimeout = setTimeout(() => {
                        const popup = this.getPopup();
                        if (!popup || !popup._container || !popup._container.matches(':hover')) {
                            this.closePopup();
                        }
                    }, 300);
                });
                
                marker.on('click', (e) => { 
                    map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                    if (editMode) {
                        openCastleForm(castle._id);
                    } else {
                        if (marker && marker._popup) {
                            marker.openPopup();
                        }
                    }
                });
                markers.push(marker);
                 marker.addTo(castleLayerGroup);
                return; // ğŸš© [ë³µì›] êµ°ëŒ€ ë§ˆì»¤ê°€ ì¼ë°˜ ì„± ë§ˆì»¤ë¡œ ë®ì–´ì”Œì›Œì§€ëŠ” ê²ƒì„ ë°©ì§€
            }


            // 4. ì „ì¥ ë§ˆì»¤ (ë…ë¦½ íƒ€ì… ë˜ëŠ” ì—­ì‚¬ ê¸°ë¡ì˜ ì „ì¥ ì²´í¬ë°•ìŠ¤)
        // ğŸš© ì „ì¥ì€ ë‘ ê°€ì§€ í˜•íƒœë¡œ ì¡´ì¬: 1) castle.is_battle=true (ë…ë¦½ ë§ˆì»¤), 2) activeHistoryRecord.is_battle=true (ì—­ì‚¬ ê¸°ë¡ì˜ ì²´í¬ë°•ìŠ¤)
        // ğŸš© ì „ì¥ì€ ì„±/ë„ì‹œ ë ˆì´ì–´ì— í¬í•¨ë˜ì–´ í‘œì‹œë¨ (ë³„ë„ í† ê¸€ ì—†ìŒ)
        const isBattleMarker = castle.is_battle || activeHistoryRecord?.is_battle;
        if (isBattleMarker && layerVisibility.city) {
            // ì „ì¥ë„ êµ­ê°€ ìƒ‰ê¹” ì‚¬ìš© (ì´ë¯¸ ìœ„ì—ì„œ countryInfo ê°€ì ¸ì˜´)
            const battleColor = countryInfo?.color || 'white';
            
            // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì‚¬ìš©
            if (castle.custom_icon) {
                const iconWidth = castle.icon_width || 32;
                const iconHeight = castle.icon_height || 32;
                const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                const battleIcon = L.divIcon({
                    className: 'custom-icon-marker',
                    html: customIconHtml,
                    iconSize: [iconWidth, iconHeight],
                    iconAnchor: [iconWidth / 2, iconHeight],
                    popupAnchor: [0, -iconHeight]
                });
                marker = L.marker([castle.lat, castle.lng], { icon: battleIcon });
            } else {
                // ê¹ƒë°œ ì„±ê³¼ ìœ ì‚¬í•œ êµ¬ì¡°: ê°€ë¡œ ë°°ì¹˜ (ì•„ì´ì½˜ + ì´ë¦„), êµ­ê°€ ìƒ‰ê¹” ì‚¬ìš©, í­ë°œ ì•„ì´ì½˜ì€ ë” í¬ê²Œ
                const battleMarkerHtml = `
                <div style="display: flex; align-items: center; gap: 4px; transform: scale(var(--marker-scale, 1));">
                  <div style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 28px; line-height: 1; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.9));">ğŸ’¥</div>
                  <span class="battle-name" style="color: ${battleColor}; font-weight: bold; font-size: 11px; white-space: nowrap; text-shadow: -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000, 0px 0px 3px #000, 0px 0px 5px #000;">${castleName}</span>
                </div>
                `;
                
                const battleIcon = L.divIcon({
                    className: 'custom-battle-marker',
                    html: battleMarkerHtml,
                    iconAnchor: [14, -5] // ì•„ì´ì½˜ì´ ì»¤ì§„ë§Œí¼ ì•µì»¤ë„ ì¡°ì •
                });
                marker = L.marker([castle.lat, castle.lng], { icon: battleIcon });
            }
            
            const editorInfoHtml = castle.lastModifiedBy 
                ? `<br><small>ë§ˆì§€ë§‰ ìˆ˜ì •: ${castle.lastModifiedBy}</small>` 
                : (castle.createdBy ? `<br><small>ìƒì„±ì: ${castle.createdBy}</small>` : '');
            
            popupHtml = `<b>ì „ì¥: ${castleName}</b><br>ê¸°ê°„: ${builtText} ~ ${destroyedText}<br>ì„¤ëª…: ${castle.desc ?? ''}${castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : ""}${editorInfoHtml}`;
            
            marker.bindPopup(popupHtml, { autoClose: false, closeOnClick: false });
            
            let popupTimeout;
            
            marker.on('mouseover', function(e) {
                clearTimeout(popupTimeout);
                // ì´ì „ íŒì—… ë‹«ê¸°
                if (currentOpenPopup && currentOpenPopup !== this) {
                    currentOpenPopup.closePopup();
                }
                this.openPopup();
                currentOpenPopup = this;
            });
            
            marker.on('popupopen', function(e) {
                const popup = e.popup;
                if (popup && popup._container) {
                    popup._container.addEventListener('mouseenter', function() {
                        clearTimeout(popupTimeout);
                    }, { once: true });
                    popup._container.addEventListener('mouseleave', function() {
                        if (marker && marker.closePopup) {
                            marker.closePopup();
                        }
                    });
                }
            });
            
            marker.on('mouseout', function(e) {
                popupTimeout = setTimeout(() => {
                    const popup = this.getPopup();
                    if (!popup || !popup._container || !popup._container.matches(':hover')) {
                        this.closePopup();
                    }
                }, 300);
            });
            
            marker.on('click', (e) => { 
                map.flyTo(e.latlng, 10);
                if (editMode) {
                    openCastleForm(castle._id);
                } else {
                    if (marker && marker._popup) {
                        marker.openPopup();
                    }
                }
            });
            markers.push(marker);
            marker.addTo(castleLayerGroup);
            return; // ì „ì¥ì´ë©´ ë” ì´ìƒ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
        }
        
        // 5. ì¼ë°˜ ì„±/ë„ì‹œ ë§ˆì»¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        if (!layerVisibility.city) {
            return;
        }
        if (!isWithinDuration) {
            return;
        }
        
        const currentCountry = countryInfo; // â¬…ï¸ ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜í•œ countryInfo ì‚¬ìš©
        if (!currentCountry) return;
        
        // ğŸš© êµ­ê°€ ì¡´ì† ê¸°ê°„ ì²´í¬
        const countryStartCombined = yearMonthToTotalMonths(currentCountry.start, currentCountry.start_month);
        const countryEndCombined = (currentCountry.end === null || isNaN(currentCountry.end)) ? Infinity : yearMonthToTotalMonths(currentCountry.end, currentCountry.end_month); 
        
        if (!(countryStartCombined <= currentTotalMonths && countryEndCombined >= currentTotalMonths)) return; 

        //const king = getKingByYear(countryName, year, month); // âœ… ìˆ˜ì •: countryName ì‚¬ìš©
     
        //    const builtText = `${castleBuiltYear}ë…„ ${castle.built_month || 1}ì›”`;
        //    const destroyedText = castle.destroyed === null ? 'í˜„ì¬' : `${castle.destroyed}ë…„ ${castle.destroyed_month || 12}ì›”`;
            
            let kingHtml = king ? `<br><b>ì™•:</b> ${king.name} (${king.start}ë…„ ${king.start_month||1}ì›” ~ ${king.end === null ? 'í˜„ì¬' : `${king.end}ë…„ ${king.end_month||1}ì›”`})` : "";
           // ğŸš© [ìˆ˜ì •] êµ­ê¸° ì´ë¯¸ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜ ì¶”ê°€
        const flagHtml = currentCountry.flag ?
            `<img src="${currentCountry.flag}" class="country-flag-img" style="width: 20px; height: 13px; border: 1px solid #ccc; margin-right: 5px; vertical-align: middle;">` : '';
        const countryEthnicity = currentCountry.ethnicity ? `<br>ë¯¼ì¡±: ${currentCountry.ethnicity}` : '';
        const editorInfoHtml = castle.createdBy ? `<br><small style="font-size:12px; font-weight:600;">ì‚¬ê´€: ${castle.createdBy}</small>` : '';
        
        popupHtml = `<b>${castleName}</b><br>${flagHtml} ${countryName}${countryEthnicity}<br>ì¡´ì†: ${builtText} ~ ${destroyedText}` 
                + (castle.desc ? `<br><span>${castle.desc}</span>` : "") 
                + (castle.photo ? `<br><img src="${castle.photo}" style="max-width:150px; max-height:100px; object-fit:cover;">` : "") 
                + kingHtml
                + editorInfoHtml;


            // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì¼ë°˜/ìˆ˜ë„ êµ¬ë¶„ ì—†ì´ ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ì‚¬ìš©
            if (castle.custom_icon) {
                const iconWidth = castle.icon_width || 32;
                const iconHeight = castle.icon_height || 32;
                const customIconHtml = `<img src="${castle.custom_icon}" style="width: ${iconWidth}px; height: ${iconHeight}px; object-fit: contain;">`;
                const customIcon = L.divIcon({
                    className: 'custom-icon-marker',
                    html: customIconHtml,
                    iconSize: [iconWidth, iconHeight],
                    iconAnchor: [iconWidth / 2, iconHeight],
                    popupAnchor: [0, -iconHeight]
                });
                marker = L.marker([castle.lat, castle.lng], { icon: customIcon, zIndexOffset: activeHistoryRecord.is_capital ? 1000 : 0 });
            } else if (currentCountry.flag && !activeHistoryRecord.is_capital) { // ğŸš© [ìˆ˜ì •] activeHistoryRecord ì‚¬ìš©
              // ... ê¸°ì¡´ ê¹ƒë°œ + ì´ë¦„ ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
          // ğŸš© [ìˆ˜ì •] êµ­ê¸° ì œê±° í›„ ì¼ë°˜ ì„±ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ë¡œ í†µì¼
          const dotColorF = currentCountry.color || 'white';
          const flagAndNameIconHtml = `
            <div style="position: relative; display: flex; flex-direction: column; align-items: center; transform: scale(var(--marker-scale, 1));">
              <div style="color:${dotColorF}; font-size:10px; line-height:1; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.4)); text-shadow: -1px -1px 1px rgba(0,0,0,0.45), 1px 1px 1px rgba(0,0,0,0.45);">â–¼</div>
              <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color:#f0e6c8; font-family:'Nanum Myeongjo',serif; font-weight:400; font-size:10px; white-space:nowrap; padding-bottom:1px; text-shadow: 0px 0px 2px rgba(0,0,0,0.9), 0px 0px 4px rgba(0,0,0,0.8);">${castleName}</div>
            </div>
              `;
              const customIcon = L.divIcon({
                  className: 'custom-flag-name-marker', 
                  html: flagAndNameIconHtml,
                  iconAnchor: [10, -5]
              });
              marker = L.marker([castle.lat, castle.lng], { icon: customIcon });
            } else if (activeHistoryRecord.is_capital) { // ğŸš© [ì œê±°] ì „ì¥ ì²´í¬ëŠ” ì´ë¯¸ ìœ„ì—ì„œ(êµ­ê°€ ì²´í¬ ì „ì—) ì²˜ë¦¬ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìˆ˜ë„/ì¼ë°˜ ì„±ë§Œ ì²˜ë¦¬
              // ... ê¸°ì¡´ ì™•ì„± ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
              // êµ­ê¸° ìœ ë¬´ ê´€ê³„ì—†ì´ ë‚™ê´€ ìŠ¤íƒ€ì¼ë¡œ í†µì¼
            const sealChar = currentCountry.sealText || (()=>{ const n=currentCountry.name||''; const hanja=(n.match(/[\u4E00-\u9FFF\uF900-\uFAFF]/g)||[]); if(hanja.length) return hanja.slice(-1)[0]; const hangul=(n.match(/[ê°€-í£]/g)||[]); return hangul.length ? hangul.slice(-1)[0] : '?'; })();
            const sealColor = currentCountry.color || '#c0392b';
            const capitalIconHtml = `<div class="capital-marker">
                <div class="capital-seal" style="background-color:${sealColor}; border-color: ${sealColor}; filter: brightness(0.75);">${sealChar}</div>
                <span class="city-name">${castleName}</span>
            </div>`;
                const customIcon = L.divIcon({
                  className: 'custom-capital-flag-marker',
                  html: capitalIconHtml,
                  iconAnchor: [6, -2]
                });
                marker = L.marker([castle.lat, castle.lng], { icon: customIcon, zIndexOffset: 1000 });
            } else { 
              // ... ê¸°ì¡´ ì¼ë°˜ ì„±/ë„ì‹œ ë§ˆì»¤ ë¡œì§ ìœ ì§€ ...
          // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¼ë°˜ì„± ë§ˆì»¤ë¥¼ ì›(dot)ì—ì„œ ì—­ì‚¼ê°í˜•(â–¼)ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
          const dotColor = currentCountry.color || 'white'; 
              const markerHtml = `<div style="position: relative; display: flex; flex-direction: column; align-items: center; transform: scale(var(--marker-scale, 1));">
                                    <div style="color:${dotColor}; font-size:10px; line-height:1; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.4)); text-shadow: -1px -1px 1px rgba(0,0,0,0.45), 1px 1px 1px rgba(0,0,0,0.45);">â–¼</div><div class="city-marker-text" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color:#f0e6c8; font-family:'Nanum Myeongjo',serif; font-weight:400; font-size:10px; white-space:nowrap; padding-bottom:1px; text-shadow: 0px 0px 2px rgba(0,0,0,0.9), 0px 0px 4px rgba(0,0,0,0.8);">${castleName}</div>
                                  </div>`;
              const customIcon = L.divIcon({
                className: 'custom-city-marker',
                html: markerHtml,
                iconAnchor: [6, 6],
                popupAnchor: [0.5, -5]
              });
              marker = L.marker([castle.lat, castle.lng], { icon: customIcon });
            }
        
            if (marker) {
              
              
              marker.bindPopup(popupHtml, { autoClose: false, closeOnClick: false });
              
              let popupTimeout;
              
              marker.on('mouseover', function(e) {
                clearTimeout(popupTimeout);
                // ì´ì „ íŒì—… ë‹«ê¸°
                if (currentOpenPopup && currentOpenPopup !== this) {
                  currentOpenPopup.closePopup();
                }
                this.openPopup();
                currentOpenPopup = this;
              });
              
              marker.on('popupopen', function(e) {
                const popup = e.popup;
                if (popup && popup._container) {
                    popup._container.addEventListener('mouseenter', function() {
                        clearTimeout(popupTimeout);
                    }, { once: true });
                    popup._container.addEventListener('mouseleave', function() {
                        if (marker && marker.closePopup) {
                            marker.closePopup();
                        }
                    });
                }
              });
              
              marker.on('mouseout', function(e) {
                popupTimeout = setTimeout(() => {
                    const popup = this.getPopup();
                    if (!popup || !popup._container || !popup._container.matches(':hover')) {
                        if (this && this.closePopup) {
                            this.closePopup();
                        }
                    }
                }, 300);
              });
              
              marker.on('click', (e) => { 
                map.flyTo(e.latlng, 10); // ğŸš© [ìˆ˜ì •] í´ë¦­ ì‹œ ì¤Œì¸í•˜ë©° ì´ë™
                if (editMode) {
                    openCastleForm(castle._id);
                } else {
                    if (marker && marker._popup) {
                        marker.openPopup();
                    }
                }
              });
              markers.push(marker);
              marker.addTo(castleLayerGroup);

              // íŠ¸ë˜í‚¹ ì •ë³´ ì„¤ì • (allCastleMarkersë¡œ ì¤‘ì•™ ê´€ë¦¬)
              try {
                  marker._castleData = castle;
                  marker.isCapital = isCapitalCastle(castle);
                  if (!allCastleMarkers.includes(marker)) allCastleMarkers.push(marker);
              } catch (e) { /* ì•ˆì „ ì²˜ë¦¬ */ }

              marker = null; 
            }
        });
        
        console.log(`âœ… ì„±/ë„ì‹œ ë Œë”ë§ ì™„ë£Œ: ë§ˆì»¤ ${markers.length}ê°œ (ë·°í¬íŠ¸ ê¸°ì¤€)`);
        // ğŸ¯ ë¡œë”© í™”ë©´ í•´ì œ ì‹ í˜¸ â€” checkTerritoriesRenderedê°€ ì´ í”Œë˜ê·¸ë¥¼ ê°ì§€
        window._castleMarkersRendered = true;
    }

// ğŸš€ [ìµœì í™”] getCountryInfoById ìºì‹œ â€” countries.find() ë°˜ë³µ í˜¸ì¶œ ë°©ì§€
let _countryLookupMap = null;
let _countryLookupVersion = 0; // countries ë°°ì—´ ë³€ê²½ ê°ì§€ìš©

function _buildCountryLookup() {
    _countryLookupMap = new Map();
    countries.forEach(c => {
        if (!c) return;
        // _id ê¸°ë°˜ ì¡°íšŒ (ë¬¸ìì—´ë¡œ í†µì¼)
        if (c._id) {
            _countryLookupMap.set(String(c._id), c);
        }
        // ì´ë¦„ ê¸°ë°˜ ì¡°íšŒ (ì˜í†  ë°ì´í„°ì˜ country_idê°€ ë¬¸ìì—´ì¸ ê²½ìš°)
        if (c.name) _countryLookupMap.set(c.name, c);
        if (c.name_kor) _countryLookupMap.set(c.name_kor, c);
        if (c.name_eng) _countryLookupMap.set(c.name_eng, c);
        if (c.name_chi) _countryLookupMap.set(c.name_chi, c);
    });
    _countryLookupVersion = countries.length;
}

function getCountryInfoById(id) {
    if (!id) return null;

    // countries ë°°ì—´ì´ ë³€ê²½ë˜ë©´ ìºì‹œ ì¬êµ¬ì¶•
    if (!_countryLookupMap || _countryLookupVersion !== countries.length) {
        _buildCountryLookup();
    }

    return _countryLookupMap.get(String(id)) || null;
}

// ğŸš© [ì¶”ê°€] êµ­ê°€ ì •ë³´ ë³€ê²½ ì‹œ ìºì‹œ ê°•ì œ ë¬´íš¨í™”
function invalidateCountryLookupCache() {
    _countryLookupMap = null;
    _countryLookupVersion = 0;
    // ğŸš© [ìˆ˜ì •] localStorage ìºì‹œë„ í•¨ê»˜ ë¬´íš¨í™” (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ìµœì‹  ë°ì´í„° ë¡œë“œ)
    localStorage.removeItem('countries_cache');
    localStorage.removeItem('countries_cache_time');
    localStorage.removeItem('countries_cache_version');
}
    // --- 5. ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™” ---
    
    // ğŸš© [ì¶”ê°€] API ì‘ë‹µ ì—ëŸ¬ ì²˜ë¦¬ í•¨ìˆ˜
    function handleApiError(response) {
        // í† í° ë§Œë£Œ ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ (ì•Œë¦¼ ì—†ì´ ì¡°ìš©íˆ)
        if (response.status === 401 || response.status === 403) {
            console.warn('í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒí•©ë‹ˆë‹¤.');
            // alert ì œê±° - ì„¸ì…˜ì´ ê±°ì˜ ë§Œë£Œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¶ˆí•„ìš”
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            window.location.href = 'login.html';
            return true; // ì—ëŸ¬ ì²˜ë¦¬ë¨
        }
        return false; // ì—ëŸ¬ ì²˜ë¦¬ ì•ˆ ë¨
    }
    
    // ğŸš© [ì¶”ê°€] í† í° ê°€ì ¸ì˜¤ê¸° í—¬í¼ í•¨ìˆ˜
    function getToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }
    
    async function fetchData(endpoint) {
      try {
        console.log(`ğŸ“¡ [Fetch] ${endpoint} ìš”ì²­ ì‹œì‘...`);
        
        // ğŸš€ [ìµœì í™”] countries ë°ì´í„° ìºì‹± (localStorage)
        if (endpoint === 'countries') {
            const cachedData = localStorage.getItem('countries_cache');
            const cacheTime = localStorage.getItem('countries_cache_time');
            const cacheVersion = localStorage.getItem('countries_cache_version');
            const CACHE_DURATION = 60 * 60 * 1000; // 1ì‹œê°„ (êµ­ê°€ ì¶”ê°€/ìˆ˜ì • ë°˜ì˜ì„ ìœ„í•´ ë‹¨ì¶•)
            // ë‚ ì§œ ê¸°ë°˜ ë²„ì „ í‚¤: ë§¤ì¼ ìë™ ë¬´íš¨í™” (YYYY-MM-DD)
            const todayKey = new Date().toISOString().slice(0, 10);
            
            if (cachedData && cacheTime && cacheVersion === todayKey) {
                const age = Date.now() - parseInt(cacheTime);
                if (age < CACHE_DURATION) {
                    console.log(`ğŸ’¾ [ìºì‹œ] countries ìºì‹œ ì‚¬ìš© (${(age / 1000 / 60).toFixed(1)}ë¶„ ì „ ì €ì¥)`);
                    return JSON.parse(cachedData);
                }
            }
        }
        
        const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        // ğŸš© [ì¶”ê°€] í† í° ë§Œë£Œ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ (ì•Œë¦¼ ì—†ì´ ì¡°ìš©íˆ)
        if (response.status === 401 || response.status === 403) {
            console.warn('í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒí•©ë‹ˆë‹¤.');
            // alert ì œê±° - ì„¸ì…˜ì´ ê±°ì˜ ë§Œë£Œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¶ˆí•„ìš”
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            window.location.href = 'login.html';
            return [];
        }
        
        if (!response.ok) {
          throw new Error(`${endpoint} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        console.log(`âœ… [Fetch] ${endpoint} ì™„ë£Œ (${data.length || 0}ê°œ)`);
        
        // ğŸš€ [ìµœì í™”] countries ë°ì´í„° ìºì‹± ì €ì¥
        if (endpoint === 'countries') {
            const todayKey = new Date().toISOString().slice(0, 10);
            localStorage.setItem('countries_cache', JSON.stringify(data));
            localStorage.setItem('countries_cache_time', Date.now().toString());
            localStorage.setItem('countries_cache_version', todayKey);
            console.log('ğŸ’¾ [ìºì‹œ] countries ë°ì´í„° ì €ì¥ ì™„ë£Œ');
        }
        
        return data;
      } catch (error) {
        console.error(`âŒ [Fetch] ${endpoint} ì˜¤ë¥˜:`, error);
        
        // ğŸš€ [ìµœì í™”] ì˜¤ë¥˜ ì‹œ ìºì‹œ ë°ì´í„° ì‚¬ìš© (countries)
        if (endpoint === 'countries') {
            const cachedData = localStorage.getItem('countries_cache');
            if (cachedData) {
                console.log('ğŸ’¾ [ìºì‹œ] ì˜¤ë¥˜ ë°œìƒ, countries ìºì‹œ ë°ì´í„° ì‚¬ìš©');
                return JSON.parse(cachedData);
            }
        }
        
        return []; 
      }
    }

    // ğŸš© [ìµœì í™”] ë ˆì´ì–´ ì„¤ì • ë¨¼ì € ë¡œë“œ (ë°ì´í„° ë¡œë”© ì „)
    async function loadLayerSettings() {
        console.log('ğŸš€ [1ë‹¨ê³„] ë ˆì´ì–´ ì„¤ì • ìš°ì„  ë¡œë“œ...');
        try {
            const response = await fetch(`${API_BASE_URL}/layer-settings`);
            if (!response.ok) {
                console.log('âš ï¸ ë ˆì´ì–´ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                return null;
            }

            const data = await response.json();
            const settings = data.settings;
            console.log('âœ… ë ˆì´ì–´ ì„¤ì • ë¡œë“œ ì„±ê³µ:', settings);
            
            // layerVisibility ê°ì²´ ì—…ë°ì´íŠ¸
            Object.assign(layerVisibility, settings);
            
            return settings;
        } catch (error) {
            console.error('âŒ ë ˆì´ì–´ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            return null;
        }
    }

    // ğŸš© [ì¶”ê°€] ë ˆì´ì–´ ì„¤ì • UI ì ìš© (ë°ì´í„° ë¡œë”© í›„)
    function applyLayerSettingsToUI(settings) {
        if (!settings) return;
        
        console.log('ğŸ¨ ë ˆì´ì–´ ì„¤ì • UI ì ìš© ì¤‘...');
        
        // ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ë“¤ì˜ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        Object.entries(settings).forEach(([layerKey, isEnabled]) => {
            const button = document.querySelector(`.layer-toggle-btn[data-layer="${layerKey}"]`);
            if (button) {
                if (isEnabled) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
        });

        // ëª¨ë°”ì¼ ë ˆì´ì–´ ì²´í¬ë°•ìŠ¤ë“¤ë„ ì—…ë°ì´íŠ¸
        const mobileCheckboxes = document.querySelectorAll('#mobile-layer-menu input[type="checkbox"]');
        mobileCheckboxes.forEach(checkbox => {
            const layerKey = checkbox.dataset.layer;
            if (settings.hasOwnProperty(layerKey)) {
                checkbox.checked = settings[layerKey];
            }
        });
        
        console.log('âœ… ë ˆì´ì–´ ì„¤ì • UI ì ìš© ì™„ë£Œ');
    }

    // ğŸš© [ê¸°ì¡´] ë ˆì´ì–´ ê¸°ë³¸ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ë° ì ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
    async function loadAndApplyLayerSettings() {
        console.log('ğŸš€ loadAndApplyLayerSettings í•¨ìˆ˜ ì‹œì‘');
        try {
            console.log('ğŸ”„ ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...');
            const response = await fetch(`${API_BASE_URL}/layer-settings`);
            console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);
            if (!response.ok) {
                console.log('âš ï¸ ë ˆì´ì–´ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                return;
            }

            const data = await response.json();
            const settings = data.settings;
            console.log('âœ… ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ:', settings);

            // ğŸš€ [ìµœì í™”] ë ˆì´ì–´ ì¼ê´„ ì—…ë°ì´íŠ¸ - í•œ ë²ˆì˜ ë Œë”ë§ ì‚¬ì´í´ë¡œ ì²˜ë¦¬
            let needsMapUpdate = false;
            const layersToUpdate = [];

            // ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ë“¤ì˜ ì´ˆê¸° ìƒíƒœ ì„¤ì • ë° ë ˆì´ì–´ í‘œì‹œ/ìˆ¨ê¹€ ì ìš©
            Object.entries(settings).forEach(([layerKey, isEnabled]) => {
                const button = document.querySelector(`.layer-toggle-btn[data-layer="${layerKey}"]`);
                if (button) {
                    if (isEnabled) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                    // layerVisibility ê°ì²´ë„ ì—…ë°ì´íŠ¸
                    layerVisibility[layerKey] = isEnabled;

                    // UI ì „ìš© ë ˆì´ì–´ ì²˜ë¦¬ (ë§µ ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”)
                    if (layerKey === 'timeline') {
                        const timelineWrapper = document.getElementById('timeline-control');
                        if (timelineWrapper) {
                            timelineWrapper.style.display = isEnabled ? 'block' : 'none';
                        }
                        // ì—°ëŒ€í‘œ ë°” ì»¨í…Œì´ë„ˆ pointer-events ì œì–´
                        const timelineContainer = document.getElementById('timeline-container');
                        if (timelineContainer) {
                            timelineContainer.style.pointerEvents = isEnabled ? 'auto' : 'none';
                        }
                        // ì—°ëŒ€í‘œ ì‚¬ì´ë“œë°” í† ê¸€
                        const timelineSidebar = document.getElementById('timeline-sidebar');
                        if (timelineSidebar) {
                            if (isEnabled) {
                                timelineSidebar.classList.add('open');
                                timelineSidebar.style.display = 'block';
                                timelineSidebar.style.pointerEvents = 'auto';
                                timelineSidebar.style.opacity = '1';
                            } else {
                                timelineSidebar.classList.remove('open');
                                timelineSidebar.style.display = 'none';
                                timelineSidebar.style.pointerEvents = 'none';
                                timelineSidebar.style.opacity = '0';
                            }
                        }
                    } else if (layerKey === 'kingPanel') {
                        const kingPanel = document.getElementById('map-king-panel');
                        if (kingPanel) {
                            kingPanel.style.display = isEnabled ? 'block' : 'none';
                        }
                    } else if (layerKey === 'historyPanel') {
                        const historyPanel = document.getElementById('map-history-panel');
                        if (historyPanel) {
                            historyPanel.style.display = isEnabled ? 'block' : 'none';
                        }
                    } else if (layerKey === 'eventSidebar') {
                        // ğŸš© [ê³¼ì œ2] ì‚¬ê±´ëª©ë¡ ì‚¬ì´ë“œë°” ì„¤ì • ì ìš©
                        const eventSidebar = document.getElementById('event-sidebar');
                        if (eventSidebar) {
                            if (isEnabled) {
                                eventSidebar.classList.add('open');
                                if (typeof renderEventSidebar === 'function') renderEventSidebar();
                            } else {
                                eventSidebar.classList.remove('open');
                            }
                        }
                    }
                    // ë‹¤ë¥¸ ë ˆì´ì–´ë“¤ì€ í•œ ë²ˆë§Œ ì—…ë°ì´íŠ¸ ì˜ˆì•½
                    else {
                        needsMapUpdate = true;
                        layersToUpdate.push(layerKey);
                    }
                } else {
                    console.warn(`âš ï¸ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: .layer-toggle-btn[data-layer="${layerKey}"]`);
                }
            });

            // ğŸš€ [ìµœì í™”] ëª¨ë“  ë§µ ë ˆì´ì–´ë¥¼ í•œ ë²ˆì— ì—…ë°ì´íŠ¸
            if (needsMapUpdate) {
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
                console.log(`ğŸ—ºï¸ ì¼ê´„ ë§µ ë ˆì´ì–´ ì—…ë°ì´íŠ¸ (${layersToUpdate.length}ê°œ):`, layersToUpdate.join(', '));
            }

            // ëª¨ë°”ì¼ ë ˆì´ì–´ ì²´í¬ë°•ìŠ¤ë“¤ë„ ì—…ë°ì´íŠ¸
            const mobileCheckboxes = document.querySelectorAll('#mobile-layer-menu input[type="checkbox"]');
            mobileCheckboxes.forEach(checkbox => {
                const layerKey = checkbox.dataset.layer;
                if (settings.hasOwnProperty(layerKey)) {
                    checkbox.checked = settings[layerKey];
                }
            });

            console.log('ğŸ‰ ë ˆì´ì–´ ì„¤ì • ì ìš© ì™„ë£Œ');
        } catch (error) {
            console.error('âŒ ë ˆì´ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
            // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ìœ ì§€
        }
    }

    //  [IndexedDB] ì˜í†  íƒ€ì¼ ìºì‹± ì‹œìŠ¤í…œ
    const TERRITORY_DB_NAME = 'TerritoryTilesDB';
    const TERRITORY_DB_VERSION = 1;
    const TERRITORY_STORE_NAME = 'tiles';
    const TERRITORY_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„

    // ğŸš€ [IndexedDB] Castles ìºì‹± ì‹œìŠ¤í…œ
    const CASTLES_DB_NAME = 'CastlesDB';
    const CASTLES_DB_VERSION = 3;
    const CASTLES_STORE_NAME = 'castles';
    const CASTLES_CACHE_DURATION = 3 * 60 * 60 * 1000; // 3ì‹œê°„

    // ğŸš€ [IndexedDB] Events ìºì‹± ì‹œìŠ¤í…œ
    const EVENTS_DB_NAME = 'EventsDB';
    const EVENTS_DB_VERSION = 1;
    const EVENTS_STORE_NAME = 'events';
    const EVENTS_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„

    // ğŸš€ [IndexedDB] Drawings ìºì‹± ì‹œìŠ¤í…œ
    const DRAWINGS_DB_NAME = 'DrawingsDB';
    const DRAWINGS_DB_VERSION = 1;
    const DRAWINGS_STORE_NAME = 'drawings';
    const DRAWINGS_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„

    // ğŸš€ [IndexedDB] Contributions ìºì‹± ì‹œìŠ¤í…œ
    const CONTRIBUTIONS_DB_NAME = 'ContributionsDB';
    const CONTRIBUTIONS_DB_VERSION = 1;
    const CONTRIBUTIONS_STORE_NAME = 'contributions';
    const CONTRIBUTIONS_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„

    // IndexedDB ì´ˆê¸°í™” (ì˜í† )
    function openTerritoryDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(TERRITORY_DB_NAME, TERRITORY_DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(TERRITORY_STORE_NAME)) {
                    const objectStore = db.createObjectStore(TERRITORY_STORE_NAME, { keyPath: 'id' });
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    console.log('âœ… IndexedDB ì˜í†  íƒ€ì¼ ì €ì¥ì†Œ ìƒì„± ì™„ë£Œ');
                }
            };
        });
    }

    // IndexedDB ì´ˆê¸°í™” (Castles)
    function openCastlesDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(CASTLES_DB_NAME, CASTLES_DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (db.objectStoreNames.contains(CASTLES_STORE_NAME)) {
                    db.deleteObjectStore(CASTLES_STORE_NAME);
                }
                const objectStore = db.createObjectStore(CASTLES_STORE_NAME, { keyPath: 'id' });
                objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                console.log('âœ… IndexedDB Castles ì €ì¥ì†Œ ìƒì„± ì™„ë£Œ');
            };
        });
    }

    // IndexedDB ì´ˆê¸°í™” (Events)
    function openEventsDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(EVENTS_DB_NAME, EVENTS_DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(EVENTS_STORE_NAME)) {
                    const objectStore = db.createObjectStore(EVENTS_STORE_NAME, { keyPath: 'id' });
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    console.log('âœ… IndexedDB Events ì €ì¥ì†Œ ìƒì„± ì™„ë£Œ');
                }
            };
        });
    }

    // IndexedDB ì´ˆê¸°í™” (Drawings)
    function openDrawingsDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DRAWINGS_DB_NAME, DRAWINGS_DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(DRAWINGS_STORE_NAME)) {
                    const objectStore = db.createObjectStore(DRAWINGS_STORE_NAME, { keyPath: 'id' });
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    console.log('âœ… IndexedDB Drawings ì €ì¥ì†Œ ìƒì„± ì™„ë£Œ');
                }
            };
        });
    }

    // IndexedDB ì´ˆê¸°í™” (Contributions)
    function openContributionsDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(CONTRIBUTIONS_DB_NAME, CONTRIBUTIONS_DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(CONTRIBUTIONS_STORE_NAME)) {
                    const objectStore = db.createObjectStore(CONTRIBUTIONS_STORE_NAME, { keyPath: 'id' });
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    console.log('âœ… IndexedDB Contributions ì €ì¥ì†Œ ìƒì„± ì™„ë£Œ');
                }
            };
        });
    }

    // ğŸš€ [IndexedDB] Castles ìºì‹œ ë¡œë“œ
    async function loadCastlesFromCache() {
        try {
            const db = await openCastlesDB();
            const transaction = db.transaction([CASTLES_STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(CASTLES_STORE_NAME);
            const mainRequest = objectStore.get('all_castles');
            const mainCached = await new Promise((resolve, reject) => {
                mainRequest.onsuccess = () => resolve(mainRequest.result);
                mainRequest.onerror = () => reject(mainRequest.error);
            });
            if (!mainCached) return null;
            const age = Date.now() - mainCached.timestamp;
            if (age > CASTLES_CACHE_DURATION) {
                console.log('âš ï¸ Castles ìºì‹œ ë§Œë£Œ (3ì‹œê°„ ì´ˆê³¼)');
                return null;
            }
            let allData = [...mainCached.data];
            if (mainCached.totalChunks && mainCached.totalChunks > 1) {
                for (let i = 1; i < mainCached.totalChunks; i++) {
                    const chunkRequest = objectStore.get(`castles_chunk_${i}`);
                    const chunkData = await new Promise((resolve, reject) => {
                        chunkRequest.onsuccess = () => resolve(chunkRequest.result);
                        chunkRequest.onerror = () => reject(chunkRequest.error);
                    });
                    if (chunkData && chunkData.data) allData = allData.concat(chunkData.data);
                }
            }
            console.log(`ğŸ’¾ Castles ìºì‹œ ë¡œë“œ: ${allData.length}ê°œ (${(age/1000/60).toFixed(1)}ë¶„ ì „ ì €ì¥)`);
            return allData;
        } catch (error) {
            console.warn('âš ï¸ Castles ìºì‹œ ë¡œë“œ ì‹¤íŒ¨:', error);
            return null;
        }
    }

    // ğŸš€ [IndexedDB] Castles ìºì‹œ ì €ì¥ (ì²­í¬ ë‹¨ìœ„)
    async function saveCastlesCache(castlesData) {
        try {
            const db = await openCastlesDB();
            const CHUNK_SIZE = 500;
            const chunks = Math.ceil(castlesData.length / CHUNK_SIZE);
            for (let i = 0; i < chunks; i++) {
                const chunkData = castlesData.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                const transaction = db.transaction([CASTLES_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(CASTLES_STORE_NAME);
                objectStore.put({
                    id: i === 0 ? 'all_castles' : `castles_chunk_${i}`,
                    data: chunkData,
                    timestamp: Date.now(),
                    chunkIndex: i,
                    totalChunks: chunks
                });
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
                if (i < chunks - 1) await new Promise(r => setTimeout(r, 0));
            }
            console.log(`ğŸ’¾ Castles ìºì‹œ ì €ì¥ ì™„ë£Œ (${chunks}ê°œ ì²­í¬, ${castlesData.length}ê°œ)`);
        } catch (error) {
            console.warn('âš ï¸ Castles ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', error);
        }
    }

    // ìºì‹œì—ì„œ ì˜í†  ë°ì´í„° ë¡œë“œ
    async function loadTerritoriesFromCache() {
        try {
            const db = await openTerritoryDB();
            const transaction = db.transaction([TERRITORY_STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(TERRITORY_STORE_NAME);
            const request = objectStore.get('all_territories');
            
            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const cached = request.result;
                    if (!cached) {
                        resolve(null);
                        return;
                    }
                    
                    // ìºì‹œ ìœ íš¨ì„± í™•ì¸ (24ì‹œê°„)
                    const age = Date.now() - cached.timestamp;
                    if (age > TERRITORY_CACHE_DURATION) {
                        console.log('âš ï¸ IndexedDB ìºì‹œ ë§Œë£Œ (24ì‹œê°„ ì´ˆê³¼)');
                        resolve(null);
                        return;
                    }
                    
                    console.log(`ğŸ’¾ IndexedDBì—ì„œ ì˜í†  ë°ì´í„° ë¡œë“œ: ${cached.data.length}ê°œ (${(age / 1000 / 60).toFixed(1)}ë¶„ ì „ ì €ì¥)`);
                    resolve(cached.data);
                };
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.warn('âš ï¸ IndexedDB ë¡œë“œ ì‹¤íŒ¨:', error);
            return null;
        }
    }

    // ìºì‹œì— ì˜í†  ë°ì´í„° ì €ì¥
    async function saveTerritoriesCache(territoriesData) {
        try {
            const db = await openTerritoryDB();
            const transaction = db.transaction([TERRITORY_STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(TERRITORY_STORE_NAME);
            
            const cacheData = {
                id: 'all_territories',
                data: territoriesData,
                timestamp: Date.now()
            };
            
            objectStore.put(cacheData);
            
            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log('ğŸ’¾ IndexedDBì— ì˜í†  ë°ì´í„° ì €ì¥ ì™„ë£Œ');
                    resolve();
                };
                transaction.onerror = () => reject(transaction.error);
            });
        } catch (error) {
            console.warn('âš ï¸ IndexedDB ì €ì¥ ì‹¤íŒ¨:', error);
        }
    }

    // ğŸš€ [IndexedDB] Events ë°ì´í„° ë¡œë“œ
    async function loadEventsFromCache() {
        try {
            const db = await openEventsDB();
            const transaction = db.transaction([EVENTS_STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(EVENTS_STORE_NAME);
            const request = objectStore.get('all_events');
            
            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const cached = request.result;
                    if (!cached) {
                        resolve(null);
                        return;
                    }
                    
                    const age = Date.now() - cached.timestamp;
                    if (age > EVENTS_CACHE_DURATION) {
                        console.log('â° Events ìºì‹œ ë§Œë£Œë¨ (24ì‹œê°„ ì´ˆê³¼)');
                        resolve(null);
                        return;
                    }
                    
                    console.log(`ğŸ’¾ IndexedDBì—ì„œ Events ë°ì´í„° ë¡œë“œ: ${cached.data.length}ê°œ (${(age / 1000 / 60).toFixed(1)}ë¶„ ì „ ì €ì¥)`);
                    resolve(cached.data);
                };
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.warn('âš ï¸ Events IndexedDB ë¡œë“œ ì‹¤íŒ¨:', error);
            return null;
        }
    }

    // ğŸš€ [IndexedDB] Events ë°ì´í„° ì €ì¥
    async function saveEventsCache(eventsData) {
        try {
            const db = await openEventsDB();
            const transaction = db.transaction([EVENTS_STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(EVENTS_STORE_NAME);
            
            const cacheData = {
                id: 'all_events',
                data: eventsData,
                timestamp: Date.now()
            };
            
            objectStore.put(cacheData);
            
            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log(`ğŸ’¾ IndexedDBì— Events ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${eventsData.length}ê°œ`);
                    resolve();
                };
                transaction.onerror = () => reject(transaction.error);
            });
        } catch (error) {
            console.warn('âš ï¸ Events IndexedDB ì €ì¥ ì‹¤íŒ¨:', error);
        }
    }

    // ğŸš€ [IndexedDB] Drawings ë°ì´í„° ë¡œë“œ
    async function loadDrawingsFromCache() {
        try {
            const db = await openDrawingsDB();
            const transaction = db.transaction([DRAWINGS_STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(DRAWINGS_STORE_NAME);
            const request = objectStore.get('all_drawings');
            
            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const cached = request.result;
                    if (!cached) {
                        resolve(null);
                        return;
                    }
                    
                    const age = Date.now() - cached.timestamp;
                    if (age > DRAWINGS_CACHE_DURATION) {
                        console.log('â° Drawings ìºì‹œ ë§Œë£Œë¨ (24ì‹œê°„ ì´ˆê³¼)');
                        resolve(null);
                        return;
                    }
                    
                    console.log(`ğŸ’¾ IndexedDBì—ì„œ Drawings ë°ì´í„° ë¡œë“œ: ${cached.data.length}ê°œ (${(age / 1000 / 60).toFixed(1)}ë¶„ ì „ ì €ì¥)`);
                    resolve(cached.data);
                };
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.warn('âš ï¸ Drawings IndexedDB ë¡œë“œ ì‹¤íŒ¨:', error);
            return null;
        }
    }

    // ğŸš€ [IndexedDB] Drawings ë°ì´í„° ì €ì¥
    async function saveDrawingsCache(drawingsData) {
        try {
            const db = await openDrawingsDB();
            const transaction = db.transaction([DRAWINGS_STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(DRAWINGS_STORE_NAME);
            
            const cacheData = {
                id: 'all_drawings',
                data: drawingsData,
                timestamp: Date.now()
            };
            
            objectStore.put(cacheData);
            
            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log(`ğŸ’¾ IndexedDBì— Drawings ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${drawingsData.length}ê°œ`);
                    resolve();
                };
                transaction.onerror = () => reject(transaction.error);
            });
        } catch (error) {
            console.warn('âš ï¸ Drawings IndexedDB ì €ì¥ ì‹¤íŒ¨:', error);
        }
    }

    // ğŸš€ [IndexedDB] Contributions ë°ì´í„° ë¡œë“œ
    async function loadContributionsFromCache() {
        try {
            const db = await openContributionsDB();
            const transaction = db.transaction([CONTRIBUTIONS_STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(CONTRIBUTIONS_STORE_NAME);
            const request = objectStore.get('all_contributions');
            
            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const cached = request.result;
                    if (!cached) {
                        resolve(null);
                        return;
                    }
                    
                    const age = Date.now() - cached.timestamp;
                    if (age > CONTRIBUTIONS_CACHE_DURATION) {
                        console.log('â° Contributions ìºì‹œ ë§Œë£Œë¨ (24ì‹œê°„ ì´ˆê³¼)');
                        resolve(null);
                        return;
                    }
                    
                    console.log(`ğŸ’¾ IndexedDBì—ì„œ Contributions ë°ì´í„° ë¡œë“œ: ${cached.data.length}ê°œ (${(age / 1000 / 60).toFixed(1)}ë¶„ ì „ ì €ì¥)`);
                    resolve(cached.data);
                };
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.warn('âš ï¸ Contributions IndexedDB ë¡œë“œ ì‹¤íŒ¨:', error);
            return null;
        }
    }

    // ğŸš€ [IndexedDB] Contributions ë°ì´í„° ì €ì¥
    async function saveContributionsCache(contributionsData) {
        try {
            const db = await openContributionsDB();
            const transaction = db.transaction([CONTRIBUTIONS_STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(CONTRIBUTIONS_STORE_NAME);
            
            const cacheData = {
                id: 'all_contributions',
                data: contributionsData,
                timestamp: Date.now()
            };
            
            objectStore.put(cacheData);
            
            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log(`ğŸ’¾ IndexedDBì— Contributions ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${contributionsData.length}ê°œ`);
                    resolve();
                };
                transaction.onerror = () => reject(transaction.error);
            });
        } catch (error) {
            console.warn('âš ï¸ Contributions IndexedDB ì €ì¥ ì‹¤íŒ¨:', error);
        }
    }
    
    // ğŸ¯ [v2.0.6] ë¡œë”© ìƒíƒœ í‘œì‹œ í•¨ìˆ˜ - ì´ˆê¸° ë¡œë”© í™”ë©´ ì—…ë°ì´íŠ¸
    const loadingMessages = [
        'ì—­ì‚¬ì˜ ë¬¸ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...',
        'ì‚°ë‘¥ ë°˜ë„ì—ì„œ ì‚¬ì‹ ì´ ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...',
        'ê³ êµ¬ë ¤ì˜ ê¸°ë¡ì„ ì •ë¦¬í•˜ëŠ” ì¤‘...',
        'ë°±ì œì˜ ì˜í† ë¥¼ í¼ì¹˜ëŠ” ì¤‘...',
        'ì‹ ë¼ì˜ ì—­ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...',
        'ê³ ë ¤ì˜ ë§Œë¦¬ë¥¼ ì¸¡ëŸ‰í•˜ëŠ” ì¤‘...',
        'ì¡°ì„ ì˜ ì§€ë„ë¥¼ ê·¸ë¦¬ëŠ” ì¤‘...',
        'ê³¼ê±°ì˜ ê¸°ë¡ì„ ë³µì›í•˜ëŠ” ì¤‘...',
        'ì‹œê°„ ì—¬í–‰ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
        'ì—­ì‚¬ì„œë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤...',
        'ì™•ì¡°ì˜ í¥ë§ì„±ì‡ ë¥¼ ê¸°ë¡í•˜ëŠ” ì¤‘...',
        'ì „ì¥ì˜ ìì·¨ë¥¼ ë”ë“¬ëŠ” ì¤‘...',
        'ì˜› ë„ìì§€ë¥¼ ì°¾ëŠ” ì¤‘...',
        'ê°•ì—­ì˜ ë³€ì²œì„ ì¶”ì í•˜ëŠ” ì¤‘...',
        'ëŒ€ë¥™ì˜ ì˜í† ë¥¼ ë³µì›í•˜ëŠ” ì¤‘...',
        'í•œë°˜ë„ì˜ ê²½ê³„ë¥¼ ê·¸ë¦¬ëŠ” ì¤‘...',
        'ì—­ì‚¬ì˜ ì§€ë„ê°€ í¼ì³ì§€ê³  ìˆìŠµë‹ˆë‹¤...'
    ];
    
    function showLoadingStatus(message, percent) {
        // ì´ˆê¸° ë¡œë”© í™”ë©´ ì—…ë°ì´íŠ¸
        const messageEl = document.getElementById('loading-message-text');
        const progressBar = document.getElementById('loading-progress-bar-initial');
        const percentageEl = document.getElementById('loading-percentage-initial');
        
        if (messageEl && progressBar && percentageEl) {
            // ë©”ì‹œì§€ê°€ ì œê³µë˜ì§€ ì•Šìœ¼ë©´ ëœë¤ ì„ íƒ
            const displayMessage = message || loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
            messageEl.textContent = displayMessage;
            progressBar.style.width = percent + '%';
            percentageEl.textContent = percent + '%';
        }
    }
    
    function hideLoadingStatus() {
        // ğŸš€ [v2.0.6] ì´ˆê¸° ë¡œë”© í™”ë©´ ì œê±°
        const initialScreen = document.getElementById('initial-loading-screen');
        if (initialScreen) {
            initialScreen.style.transition = 'opacity 0.25s ease-out';
            initialScreen.style.opacity = '0';
            setTimeout(() => {
                initialScreen.remove();
            }, 260);
        }
    }

    async function initialize() {
      console.log("â±ï¸ ë°ì´í„° ì´ˆê¸°í™” ì‹œì‘...");
      const startTime = performance.now();
      
      try {
      // ğŸ¯ ë¡œë”© íŒ¨ë„ í‘œì‹œ
      showLoadingStatus('ì—­ì‚¬ì˜ ë¬¸ì„ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 0);

      // ğŸ¯ [í•µì‹¬] ìºì‹œ ë°ì´í„° ë¨¼ì € í™•ì¸ (ì´ˆê¸°í™” ì „ì—!)
      const cachedCountries = localStorage.getItem('countries_cache');
      const territoriesPromise = loadTerritoriesFromCache();
      const eventsPromise = loadEventsFromCache();
      const drawingsPromise = loadDrawingsFromCache();
      const contributionsPromise = loadContributionsFromCache();
      const castlesPromise = loadCastlesFromCache(); // ğŸš€ [ì¶”ê°€] Castles ìºì‹œ ìš°ì„  ë¡œë“œ
      
      // ë³‘ë ¬ ëŒ€ê¸° (castles í¬í•¨)
      const [cachedTerritories, cachedEvents, cachedDrawings, cachedContributions, cachedCastles] = await Promise.all([
          territoriesPromise,
          eventsPromise,
          drawingsPromise,
          contributionsPromise,
          castlesPromise
      ]);
      
      // castles: ìºì‹œê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©, ì—†ìœ¼ë©´ ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œ
      if (cachedCastles && cachedCastles.length > 0) {
          castles = cachedCastles;
          console.log(`ğŸ’¾ castles ìºì‹œ ì‚¬ìš©: ${castles.length}ê°œ (ì¦‰ì‹œ ë Œë”ë§ ê°€ëŠ¥)`);
      } else {
          castles = [];
          console.log('ğŸ° castles: ìºì‹œ ì—†ìŒ, ë°±ê·¸ë¼ìš´ë“œ DB ë¡œë“œ ì˜ˆì •');
      }
      
      if (!cachedTerritories || cachedTerritories.length === 0) {
          territories = [];
          console.log('ğŸ“¦ territories ì´ˆê¸°í™” (ìºì‹œ ì—†ìŒ)');
      } else {
          console.log('ğŸ’¾ territories ìºì‹œ ë³´ì¡´ (ì´ˆê¸°í™” ìƒëµ)');
      }
      
      if (!cachedEvents || cachedEvents.length === 0) {
          events = [];
          console.log('ğŸ“¦ events ì´ˆê¸°í™” (ìºì‹œ ì—†ìŒ)');
      } else {
          events = cachedEvents;
          console.log(`ğŸ’¾ events ìºì‹œ ì‚¬ìš©: ${events.length}ê°œ (ì´ˆê¸°í™” ìƒëµ)`);
      }
      
      if (!cachedDrawings || cachedDrawings.length === 0) {
          drawings = [];
          console.log('ğŸ“¦ drawings ì´ˆê¸°í™” (ìºì‹œ ì—†ìŒ)');
      } else {
          drawings = cachedDrawings;
          console.log(`ğŸ’¾ drawings ìºì‹œ ì‚¬ìš©: ${drawings.length}ê°œ (ì´ˆê¸°í™” ìƒëµ)`);
      }
      
      if (!cachedContributions || cachedContributions.length === 0) {
          contributions = [];
          console.log('ğŸ“¦ contributions ì´ˆê¸°í™” (ìºì‹œ ì—†ìŒ)');
      } else {
          contributions = cachedContributions;
          console.log(`ğŸ’¾ contributions ìºì‹œ ì‚¬ìš©: ${contributions.length}ê°œ (ì´ˆê¸°í™” ìƒëµ)`);
      }
      
      // ë‚˜ë¨¸ì§€ëŠ” í•­ìƒ ì´ˆê¸°í™” (events/drawingsëŠ” ìºì‹œê°€ ìˆìœ¼ë©´ ë³´ì¡´)
      if (!cachedEvents || cachedEvents.length === 0) events = [];
      if (!cachedDrawings || cachedDrawings.length === 0) drawings = [];
      history = [];
      naturalFeatures = [];

      try {
          // ===== ğŸš€ [0ë‹¨ê³„] ìºì‹œëœ í•µì‹¬ ë°ì´í„° ë³‘ë ¬ ì¦‰ì‹œ ì ìš© =====
          // ğŸ¯ [í•µì‹¬] countries, territories, castlesë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œí•˜ì—¬ êµ­ê°€ ìƒ‰ìƒ ë§¤ì¹­ ê°€ëŠ¥!
          console.log('ğŸš€ ìºì‹œëœ í•µì‹¬ ë°ì´í„° ë³‘ë ¬ ë¡œë”© ì‹œì‘...');
          
          // ì´ë¯¸ ìœ„ì—ì„œ ë¡œë“œí–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í• ë‹¹ë§Œ
          
          let hasCachedData = false;
          
          // Countries ìºì‹œ ì ìš©
          if (cachedCountries) {
              try {
                  countries = JSON.parse(cachedCountries);
                  console.log(`ğŸ’¾ [ì¦‰ì‹œ ìºì‹œ] countries ${countries.length}ê°œ ë¡œë“œ ì™„ë£Œ`);
                  hasCachedData = true;
              } catch (e) {
                  console.warn('âš ï¸ Countries ìºì‹œ íŒŒì‹± ì‹¤íŒ¨:', e);
              }
          }
          
          // Territories ìºì‹œ ì ìš©
          if (cachedTerritories && cachedTerritories.length > 0) {
              territories = cachedTerritories;
              window.territories = cachedTerritories; // ğŸ¯ [í•µì‹¬] ì „ì—­ ë³€ìˆ˜ ëª…ì‹œì  í• ë‹¹
              console.log(`ğŸ’¾ [ì¦‰ì‹œ ìºì‹œ] territories ${territories.length}ê°œ IndexedDBì—ì„œ ë¡œë“œ ì™„ë£Œ`);
              hasCachedData = true;
          }
          
          // Castles ìºì‹œ ì ìš©
          if (cachedCastles && cachedCastles.length > 0) {
              castles = cachedCastles;
              console.log(`ğŸ’¾ [ì¦‰ì‹œ ìºì‹œ] castles ${castles.length}ê°œ IndexedDBì—ì„œ ë¡œë“œ ì™„ë£Œ`);
              hasCachedData = true;
          }
          
          // ğŸ¯ [í•µì‹¬] territories + countries ìºì‹œê°€ ì¤€ë¹„ë˜ë©´ ë Œë”ë§
          if (hasCachedData && countries.length > 0 && territories.length > 0) {
              console.log(`ğŸš€ [ìºì‹œ ê°•ì œ ë Œë”ë§] countries: ${countries.length}, territories: ${territories.length}, castles: ${castles.length}`);
              
              // ğŸ·ï¸ [ì´ˆê³ ì† ë¼ë²¨] ë¼ë²¨ì€ castles ë¡œë“œ í›„ ë Œë”ë§ë¨ (ë°±ê·¸ë¼ìš´ë“œ)
              
              // ğŸ¯ [í•µì‹¬] isInitializing í”Œë˜ê·¸ ì¼ì‹œì ìœ¼ë¡œ í•´ì œ (ìºì‹œ ë Œë”ë§ í—ˆìš©)
              const wasInitializing = isInitializing;
              isInitializing = false;
              console.log('ğŸ”“ [ìºì‹œ ë Œë”ë§] isInitializing í”Œë˜ê·¸ ì¼ì‹œ í•´ì œ (ë¬¸ ì—´ë¦¼)');
              
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
              
              // ğŸ¯ [ë³µì›] í”Œë˜ê·¸ ë³µì› (ë‹¤ë¥¸ ê³³ì—ì„œì˜ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
              isInitializing = wasInitializing;
              console.log('ğŸ”’ [ìºì‹œ ë Œë”ë§] isInitializing í”Œë˜ê·¸ ë³µì›');
              
              console.log('ğŸ—ºï¸ [ì¦‰ì‹œ ë Œë”ë§] ìºì‹œ ë°ì´í„°ë¡œ êµ­ê°€ ìƒ‰ìƒì´ ì…í˜€ì§„ ì™„ì „í•œ ì§€ë„ ë Œë”ë§ ì™„ë£Œ (0.5ì´ˆ)');
              showLoadingStatus('ê³¼ê±°ì˜ ê¸°ë¡ì„ ë³µì›í–ˆìŠµë‹ˆë‹¤...', 35);
              
              // ğŸ“Š ë””ë²„ê¹…: ì‹¤ì œ ë Œë”ë§ëœ ì˜í†  ìˆ˜ í™•ì¸
              if (territories.length > 0) {
                  const renderedTerritories = territories.filter(t => {
                      const country = getCountryInfoById(t.properties?.country_id);
                      return country != null;
                  });
                  console.log(`ğŸ“Š [ë””ë²„ê¹…] ìºì‹œ ë Œë”ë§: ì „ì²´ ${territories.length}ê°œ, êµ­ê°€ ë§¤ì¹­ ì„±ê³µ ${renderedTerritories.length}ê°œ, êµ­ê°€ì—†ìŒ ${territories.length - renderedTerritories.length}ê°œ`);
              }
          }
      } catch (error) {
          console.error('âŒ [ìºì‹œ ë Œë”ë§ ì˜¤ë¥˜]', error);
          // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìºì‹œ ì—†ì´ ì •ìƒ ë¡œë”© ì§„í–‰
      }

      // ===== ğŸš€ [1ë‹¨ê³„] ë ˆì´ì–´ ì„¤ì • ìš°ì„  ë¡œë“œ (0-5%) =====
          showLoadingStatus('ì§€ë„ ì œì‘ ë„êµ¬ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 5);
          const layerSettings = await loadLayerSettings();
          console.log('ğŸ“‹ í™œì„±í™”ëœ ë ˆì´ì–´:', Object.entries(layerVisibility).filter(([k, v]) => v).map(([k]) => k));
          
          // ===== ğŸš€ [2ë‹¨ê³„] í•„ìˆ˜ ë°ì´í„°ë§Œ ë³‘ë ¬ ë¡œë”© (5-60%) =====
          console.log('ğŸš€ í•„ìˆ˜ ë°ì´í„° ë³‘ë ¬ ë¡œë”© ì‹œì‘...');
          const parallelStartTime = performance.now();
          showLoadingStatus('ì‚°ë‘¥ ë°˜ë„ì—ì„œ ì‚¬ì‹ ì´ ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...', 25);
          
          // ğŸ¯ [ìµœì í™”] ë ˆì´ì–´ ì„¤ì •ì— ë”°ë¼ ë¡œë”©í•  ë°ì´í„° ê²°ì •
          // ğŸš€ [ìµœì í™”] history, castles ì œì™¸ - ì§€ë„ ë Œë”ë§ í›„ ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œ
          
          // ğŸš€ [ìµœì í™” v2.1.2] countries ìºì‹œê°€ ìˆìœ¼ë©´ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ìŠ¤í‚µ!
          const countriesAlreadyLoaded = countries.length > 0;
          
          const loadPromises = {
              // ğŸ¯ countries: ìºì‹œê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ resolve, ì—†ìœ¼ë©´ ë„¤íŠ¸ì›Œí¬ ìš”ì²­
              countries: countriesAlreadyLoaded 
                  ? Promise.resolve(countries).then(d => { console.log('âš¡ [ì´ˆê³ ì†] countries ìºì‹œ ì‚¬ìš© (ë„¤íŠ¸ì›Œí¬ ìŠ¤í‚µ)'); return d; })
                  : fetchData('countries'),
              // âŒ events: ì œì™¸ - ì—°ëŒ€í‘œ ì „ìš©, ì§€ë„ ë Œë”ë§ì— ë¶ˆí•„ìš” (ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œë¡œ ì „í™˜)
              // âŒ history: ì œì™¸ - 2,221ê°œë¡œ ê°€ì¥ ë¬´ê±°ì›€, ì§€ë„ì— ì§ì ‘ ì˜í–¥ ì—†ìŒ
              // âŒ castles: ì œì™¸ - 1,168ê°œ, 11ì´ˆ ì†Œìš”, ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œë¡œ ì „í™˜
          };
          
          // ì§„í–‰ë¥  í‘œì‹œë¥¼ ìœ„í•œ ê°œë³„ ì™„ë£Œ ì¶”ì 
          let completedCount = 0;
          const totalLoads = Object.keys(loadPromises).length;
          
          // ğŸ¯ [ë””ë²„ê¹…] ê° ìš”ì²­ì˜ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ì¶”ì 
          const timingMap = {};
          
          // ğŸ¯ [í•µì‹¬ ìµœì í™”] countries ë°ì´í„°ê°€ ì˜¤ëŠ” ì¦‰ì‹œ 1ì°¨ ë Œë”ë§ (Promise.all ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
          loadPromises.countries.then(data => {
              countries = data || [];
              // ğŸ”‘ [í•µì‹¬] countries êµì²´ ì‹œ lookup ìºì‹œ ê°•ì œ ë¬´íš¨í™” (êµ­ê°€ì—†ìŒ ë§¤ì¹­ ì‹¤íŒ¨ ë°©ì§€)
              _countryLookupMap = null;
              // ğŸ”‘ [ì§„ë‹¨] countries ì¬ë¡œë“œ ì‹œ ë§¤ì¹­ ì‹¤íŒ¨ ë¡œê·¸ ë¦¬ì…‹ (ìƒˆ ë°ì´í„°ë¡œ ì¬ì§„ë‹¨)
              if (updateMap._loggedMissingIds) updateMap._loggedMissingIds.clear();
              console.log(`âœ… [ì¦‰ì‹œ ë Œë”ë§] countries ${countries.length}ê°œ ë¡œë“œ ì™„ë£Œ (lookup ìºì‹œ ì´ˆê¸°í™”)`);
              
              // ï¿½ [v3.5 ìµœì í™”] ë””ë°”ìš´ìŠ¤ëœ ë‹¨ì¼ í˜¸ì¶œ (ê¸°ì¡´: ì¦‰ì‹œ 1íšŒ + rAF ë§¤ì¹­ ì¬ì‹œë„ 1íšŒ â†’ ì´ 2íšŒ)
              requestUpdateMap();
              console.log('ï¿½ï¸ [ì¦‰ì‹œ ë Œë”ë§] countries ë°ì´í„°ë¡œ ì§€ë„ ë Œë”ë§ ì˜ˆì•½ ì™„ë£Œ');
          }).catch(err => {
              console.error('âŒ countries ì¦‰ì‹œ ë¡œë“œ ì‹¤íŒ¨:', err);
          });
          
          const results = await Promise.all(
              Object.entries(loadPromises).map(async ([key, promise]) => {
                  const requestStart = performance.now();
                  try {
                      const data = await promise;
                      const requestEnd = performance.now();
                      const duration = ((requestEnd - requestStart) / 1000).toFixed(2);
                      timingMap[key] = duration;
                      
                      completedCount++;
                      const progress = 10 + Math.floor((completedCount / totalLoads) * 50);
                      showLoadingStatus(`${key} ë°ì´í„° ë¡œë“œ ì™„ë£Œ...`, progress);
                      console.log(`â±ï¸ [íƒ€ì´ë°] ${key}: ${duration}ì´ˆ`);
                      return [key, data];
                  } catch (error) {
                      console.error(`âŒ ${key} ë¡œë“œ ì‹¤íŒ¨:`, error);
                      return [key, []];
                  }
              })
          );
          
          const parallelEndTime = performance.now();
          const parallelDuration = ((parallelEndTime - parallelStartTime) / 1000).toFixed(2);
          console.log(`â±ï¸ [íƒ€ì´ë°] Promise.all ì „ì²´: ${parallelDuration}ì´ˆ`);
          console.log(`ğŸ“Š [íƒ€ì´ë°] ìƒì„¸:`, timingMap);
          
          // ê²°ê³¼ í• ë‹¹
          const dataMap = Object.fromEntries(results);
          countries = dataMap.countries || [];
          // ğŸ”‘ [í•µì‹¬] countries ì¬í• ë‹¹ ì‹œ lookup ìºì‹œ ê°•ì œ ë¬´íš¨í™”
          _countryLookupMap = null;
          
          // ğŸš€ [ë°±ê·¸ë¼ìš´ë“œ ë¡œë”©] eventsë¥¼ í•­ìƒ ë¹„ë™ê¸° ë¡œë”© (ì—°ëŒ€í‘œ/ì‚¬ê±´ëª©ë¡ ê³µìš©)
          if (events.length === 0) {
              console.log('ğŸ“… [ë°±ê·¸ë¼ìš´ë“œ] events ë°ì´í„° ë¡œë”© ì‹œì‘...');
              fetchData('events').then(data => {
                  events = data || [];
                  console.log(`âœ… [ë°±ê·¸ë¼ìš´ë“œ] events ${events.length}ê°œ ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë“œ ì™„ë£Œ`);
                  
                  // IndexedDBì— ìºì‹±
                  saveEventsCache(events).then(() => {
                      console.log('ğŸ’¾ [ë°±ê·¸ë¼ìš´ë“œ] events IndexedDB ìºì‹± ì™„ë£Œ');
                  });
                  
                  // ì—°ëŒ€í‘œ UIê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ì—…ë°ì´íŠ¸
                  if (typeof updateTimeline === 'function') {
                      updateTimeline();
                  }
                  // ğŸš© [ì¶”ê°€] ì‚¬ê±´ ê·¸ë£¹í™” ì‚¬ì´ë“œë°” ë Œë”ë§
                  if (typeof renderEventSidebar === 'function') {
                      renderEventSidebar();
                  }
                  // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì¬ìƒì„±
                  createDynastyTimeline();
              }).catch(err => {
                  console.error('âŒ [ë°±ê·¸ë¼ìš´ë“œ] events ë¡œë“œ ì‹¤íŒ¨:', err);
                  events = [];
              });
          } else if (events.length > 0) {
              console.log(`â™»ï¸ [ë°±ê·¸ë¼ìš´ë“œ] events ìºì‹œ ì‚¬ìš©: ${events.length}ê°œ (ë„¤íŠ¸ì›Œí¬ ìŠ¤í‚µ)`);
              // ìºì‹œëœ eventsë¡œ ì‚¬ì´ë“œë°” ë Œë”ë§ ì‹œë„
              if (typeof renderEventSidebar === 'function') {
                  renderEventSidebar();
              }
          }
          
          // ğŸ¯ [í•µì‹¬] castlesì™€ historyëŠ” ìºì‹œê°€ ì—†ì„ ë•Œë§Œ ì´ˆê¸°í™” (ìºì‹œ ë°ì´í„° ë³´í˜¸!)
          if (castles.length === 0) {
              history = []; // ğŸš€ [ìµœì í™”] ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œ
              console.log('ğŸ“¦ castles/history ì´ˆê¸°í™” (ìºì‹œ ì—†ìŒ, ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œ ëŒ€ê¸°)');
          } else {
              console.log('ğŸ’¾ castles ìºì‹œ ë³´ì¡´ (ì´ˆê¸°í™” ìƒëµ, í˜„ì¬ ê°œìˆ˜:', castles.length, ')');
          }
          
          console.log(`âœ… ë³‘ë ¬ ë¡œë”© ì™„ë£Œ: countries ${countries.length}, events ${events.length}, history (ì§€ì—° ë¡œë”©), castles (ìºì‹œ: ${castles.length}ê°œ)`);
          
          // ğŸš€ [ìµœì í™”] ì‹œê°„ ëª©ë¡ ìƒì„± (history ì—†ì´ eventsë§Œ ë¨¼ì €)
          showLoadingStatus('ì—­ì‚¬ì˜ ì‹œê°„ì¶•ì„ ì •ë ¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 60);
          const eventTimes = events.map(e => yearMonthToTotalMonths(e.year, e.month || 1));
          historyEventTimes = [...new Set(eventTimes)].sort((a, b) => a - b);
          console.log(`ğŸ“… ì—°ëŒ€í‘œ ì‹œê°„ ëª©ë¡ (eventsë§Œ): ${historyEventTimes.length}ê°œ ì‹œì `);
          
          showLoadingStatus('ê°•ì—­ì„ ê²€ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 75);
          
          // ğŸš€ [v2.0.8] ì˜í†  ë°ì´í„°ë¥¼ í•„ìˆ˜ ë¡œë”©ìœ¼ë¡œ ë³€ê²½ (ë¹ˆ ì§€ë„ í˜„ìƒ ë°©ì§€)
          if (layerVisibility.territoryPolygon) {
              // ìºì‹œê°€ ì—†ìœ¼ë©´ í•„ìˆ˜ ë¡œë”©
              if (territories.length === 0) {
                  console.log('ğŸ—ºï¸ ì˜í†  ë°ì´í„° í•„ìˆ˜ ë¡œë”© ì‹œì‘... (ë¹ˆ ì§€ë„ ë°©ì§€)');
                  const territoryStartTime = performance.now();
                  try {
                      showLoadingStatus('ëŒ€ë¥™ì˜ ê°•ì—­ì„ ë³µì›í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 77);
                      await loadTerritoryTiles();
                      const territoryLoadTime = ((performance.now() - territoryStartTime) / 1000).toFixed(2);
                      console.log(`âœ… ì˜í†  ë°ì´í„° ë¡œë”© ì™„ë£Œ: ${territories.length}ê°œ (${territoryLoadTime}ì´ˆ)`);
                      
                      // ğŸ¯ [IndexedDB] ë¡œë“œí•œ ì˜í†  ë°ì´í„°ë¥¼ ìºì‹œì— ì €ì¥
                      if (territories.length > 0) {
                          await saveTerritoriesCache(territories);
                          console.log('ğŸ’¾ ì˜í†  ë°ì´í„° IndexedDB ìºì‹œ ì €ì¥ ì™„ë£Œ');
                      }
                      
                      // ğŸš€ [v2.0.9] ì˜í†  ë¡œë”© ì™„ë£Œ â†’ ì´ˆê¸°í™” í”Œë˜ê·¸ í•´ì œ ë° ì¦‰ì‹œ ë Œë”ë§
                      isInitializing = false;
                      console.log('ğŸ”“ [ì´ˆê¸°í™” ì™„ë£Œ] isInitializing = false (ì˜í†  ë¡œë”© ì™„ë£Œ)');
                      
                      requestUpdateMap();
                      console.log('ğŸ—ºï¸ [ì¦‰ì‹œ ë Œë”ë§] ì˜í†  ë°ì´í„°ë¡œ ì§€ë„ ë Œë”ë§ ì˜ˆì•½');
                  } catch (error) {
                      console.error('âŒ ì˜í†  ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                      isInitializing = false; // ì˜¤ë¥˜ ì‹œì—ë„ í•´ì œ
                  }
              } else {
                  console.log('âœ… ì˜í†  ë°ì´í„° ì´ë¯¸ ë¡œë“œë¨ (ìºì‹œ ì‚¬ìš©):', territories.length, 'ê°œ');
                  // ìºì‹œ ì‚¬ìš© ì‹œì—ë„ í”Œë˜ê·¸ í•´ì œ
                  isInitializing = false;
                  console.log('ğŸ”“ [ì´ˆê¸°í™” ì™„ë£Œ] isInitializing = false (ìºì‹œ ì‚¬ìš©)');
              }
          } else {
              console.log('â­ï¸ ì˜í†  ë ˆì´ì–´ ë¹„í™œì„±í™” â†’ ë¡œë“œ ìŠ¤í‚µ');
          }
          
          // ===== ğŸš€ [ìµœì í™”] ì¶”ê°€ ë°ì´í„° ë³‘ë ¬ ë¡œë”© (80-90%) =====
          const additionalStartTime = performance.now();
          console.log('ğŸ“¦ ì¶”ê°€ ë°ì´í„° ë³‘ë ¬ ë¡œë”© ì‹œì‘...');
          showLoadingStatus('ì¬ìœ„ ì‹œê¸°ì™€ í™œë™ ë²”ìœ„ë¥¼ ê³µê°„ì ìœ¼ë¡œ ê²€ì¦ ì¤‘ì…ë‹ˆë‹¤...', 82);
          
          const additionalLoadPromises = {};
          
          // ì™• ë°ì´í„° (kingPanel ë ˆì´ì–´ê°€ ì¼œì ¸ìˆì„ ë•Œë§Œ)
          if (layerVisibility.kingPanel) {
              additionalLoadPromises.kings = fetchData('kings');
          } else {
              additionalLoadPromises.kings = Promise.resolve([]);
          }
          
          // âŒ drawings: ì œê±° - ì‚¬ìš©ì ê·¸ë¦¬ê¸° ë°ì´í„°, ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œë¡œ ì „í™˜ (21ì´ˆ ë³‘ëª© ì œê±°)
          // âŒ contributions: ì œê±° - ì‚¬ìš©ì ê¸°ì—¬ ë°ì´í„°, ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œë¡œ ì „í™˜ (4ì´ˆ ë³‘ëª© ì œê±°)
          
          // ìì—° ì§€í˜•ì§€ë¬¼ (natural ë ˆì´ì–´ê°€ ì¼œì ¸ìˆì„ ë•Œë§Œ)
          if (layerVisibility.natural || layerVisibility.rivers) {
              additionalLoadPromises.naturalFeatures = fetchData('natural-features');
          } else {
              additionalLoadPromises.naturalFeatures = Promise.resolve([]);
          }
          
          // ğŸš€ ë³‘ë ¬ ì‹¤í–‰
          const additionalTimingMap = {};
          const additionalResults = await Promise.all(
              Object.entries(additionalLoadPromises).map(async ([key, promise]) => {
                  const requestStart = performance.now();
                  try {
                      const data = await promise;
                      const requestEnd = performance.now();
                      const duration = ((requestEnd - requestStart) / 1000).toFixed(2);
                      additionalTimingMap[key] = duration;
                      console.log(`â±ï¸ [íƒ€ì´ë°] ${key}: ${duration}ì´ˆ`);
                      return [key, data];
                  } catch (error) {
                      console.error(`âŒ ${key} ë¡œë“œ ì‹¤íŒ¨:`, error);
                      return [key, key === 'kings' ? {} : []];
                  }
              })
          );
          
          const additionalEndTime = performance.now();
          const additionalDuration = ((additionalEndTime - additionalStartTime) / 1000).toFixed(2);
          console.log(`â±ï¸ [íƒ€ì´ë°] ì¶”ê°€ ë°ì´í„° Promise.all ì „ì²´: ${additionalDuration}ì´ˆ`);
          console.log(`ğŸ“Š [íƒ€ì´ë°] ì¶”ê°€ ë°ì´í„° ìƒì„¸:`, additionalTimingMap);
          
          const additionalData = Object.fromEntries(additionalResults);
          
          // ì™• ë°ì´í„° ì²˜ë¦¬
          kings = {};
          if (layerVisibility.kingPanel && Array.isArray(additionalData.kings)) {
              let totalKings = 0;
              additionalData.kings.forEach(item => {
                  if (item.country_id && Array.isArray(item.kings)) {
                      kings[item.country_id] = item.kings;
                      totalKings += item.kings.length;
                  }
              });
              console.log(`âœ… ì™• ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${Object.keys(kings).length}ê°œ êµ­ê°€, ì´ ${totalKings}ëª… ì™•`);
          } else {
              console.log('â­ï¸ ì™• íŒ¨ë„ ë¹„í™œì„±í™” â†’ ë¡œë“œ ìŠ¤í‚µ');
          }
          
          // ğŸš€ [ë°±ê·¸ë¼ìš´ë“œ ë¡œë”©] drawingsëŠ” ì‚¬ìš©ì ê·¸ë¦¬ê¸° ì „ìš©ìœ¼ë¡œ ë¹„ë™ê¸° ë¡œë”© (ìºì‹œ ìš°ì„ )
          if (drawings.length === 0) {
              console.log('âœï¸ [ë°±ê·¸ë¼ìš´ë“œ] drawings ë°ì´í„° ë¡œë”© ì‹œì‘ (ìºì‹œ ì—†ìŒ)...');
              fetchData('drawings').then(data => {
                  drawings = data || [];
                  console.log(`âœ… [ë°±ê·¸ë¼ìš´ë“œ] drawings ${drawings.length}ê°œ ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë“œ ì™„ë£Œ`);
                  
                  // IndexedDBì— ìºì‹±
                  saveDrawingsCache(drawings).then(() => {
                      console.log('ğŸ’¾ [ë°±ê·¸ë¼ìš´ë“œ] drawings IndexedDB ìºì‹± ì™„ë£Œ');
                  });
                  
                  // ì§€ë„ì— drawings ë°˜ì˜
                  requestUpdateMap();
                  console.log('ğŸ—ºï¸ [ë°±ê·¸ë¼ìš´ë“œ] drawings ë°ì´í„° ì§€ë„ ë°˜ì˜ ì™„ë£Œ');
              }).catch(err => {
                  console.error('âŒ [ë°±ê·¸ë¼ìš´ë“œ] drawings ë¡œë“œ ì‹¤íŒ¨:', err);
                  drawings = [];
              });
          } else {
              console.log(`â™»ï¸ [ë°±ê·¸ë¼ìš´ë“œ] drawings ìºì‹œ ì‚¬ìš©: ${drawings.length}ê°œ (ë„¤íŠ¸ì›Œí¬ ìŠ¤í‚µ)`);
          }
          
          // ğŸš€ [ë°±ê·¸ë¼ìš´ë“œ ë¡œë”©] contributionsëŠ” ì‚¬ìš©ì ê¸°ì—¬ ì „ìš©ìœ¼ë¡œ ë¹„ë™ê¸° ë¡œë”© (í•­ìƒ ìµœì‹  ë°ì´í„° ë¡œë“œ)
          if (layerVisibility.userContributions) {
              console.log('ğŸ‘¥ [ë°±ê·¸ë¼ìš´ë“œ] contributions ë°ì´í„° ë¡œë”© ì‹œì‘ (ìºì‹œ:', contributions.length, 'ê°œ)...');
              fetchData('contributions').then(data => {
                  contributions = data || [];
                  console.log(`âœ… [ë°±ê·¸ë¼ìš´ë“œ] contributions ${contributions.length}ê°œ ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë“œ ì™„ë£Œ`);
                  
                  // IndexedDBì— ìºì‹±
                  saveContributionsCache(contributions).then(() => {
                      console.log('ğŸ’¾ [ë°±ê·¸ë¼ìš´ë“œ] contributions IndexedDB ìºì‹± ì™„ë£Œ');
                  });
                  
                  // ì§€ë„ì— contributions ë°˜ì˜
                  requestUpdateMap();
                  console.log('ğŸ—ºï¸ [ë°±ê·¸ë¼ìš´ë“œ] contributions ë°ì´í„° ì§€ë„ ë°˜ì˜ ì™„ë£Œ');
              }).catch(err => {
                  console.error('âŒ [ë°±ê·¸ë¼ìš´ë“œ] contributions ë¡œë“œ ì‹¤íŒ¨:', err);
                  contributions = [];
              });
          } else if (contributions.length > 0) {
              console.log(`â™»ï¸ [ë°±ê·¸ë¼ìš´ë“œ] contributions ìºì‹œ ì‚¬ìš©: ${contributions.length}ê°œ (ë ˆì´ì–´ ë¹„í™œì„±í™”)`);
          } else {
              console.log('â­ï¸ ìœ ì € ê¸°ì—¬ ë ˆì´ì–´ ë¹„í™œì„±í™” â†’ contributions ë¡œë“œ ìŠ¤í‚µ');
          }
          
          // ìì—° ì§€í˜•ì§€ë¬¼
          naturalFeatures = additionalData.naturalFeatures || [];
          if (layerVisibility.natural || layerVisibility.rivers) {
              console.log(`âœ… ìì—° ì§€í˜•ì§€ë¬¼: ${naturalFeatures.length}ê°œ`);
          } else {
              console.log('â­ï¸ ìì—° ì§€í˜•ì§€ë¬¼ ë ˆì´ì–´ ë¹„í™œì„±í™” â†’ ë¡œë“œ ìŠ¤í‚µ');
          }
          
          console.log('âœ… ì¶”ê°€ ë°ì´í„° ë³‘ë ¬ ë¡œë”© ì™„ë£Œ');
          
          // ===== ìµœì¢… ì§€ë„ ì—…ë°ì´íŠ¸ (ì¶”ê°€ ë°ì´í„° ë°˜ì˜) =====
          console.log('ğŸ—ºï¸ ì¶”ê°€ ë°ì´í„° ì§€ë„ ë°˜ì˜ ì‹œì‘...');
          console.log(`  ğŸ“Š ë°ì´í„° í˜„í™©: countries ${countries.length}, castles ${castles.length}, territories ${territories.length}, history (ì§€ì—° ë¡œë”© ì¤‘), events ${events.length}`);
          
          // ğŸš€ [v2.0.9] ì´ˆê¸°í™” í”Œë˜ê·¸ëŠ” ì˜í†  ë¡œë”© í›„ ì´ë¯¸ í•´ì œë¨ (ì¤‘ë³µ ì œê±°)
          // isInitializingì€ ì˜í†  ë¡œë”© ì™„ë£Œ ì‹œì ì— falseë¡œ ë³€ê²½ë¨
          
          // ğŸ¯ [ìµœì í™”] ì¶”ê°€ ë°ì´í„°(drawings, naturalFeatures ë“±) ë°˜ì˜
          // ğŸ¯ [í•µì‹¬] territoriesê°€ ìˆìœ¼ë©´ updateMap í˜¸ì¶œ (castlesëŠ” ë°±ê·¸ë¼ìš´ë“œ ëŒ€ê¸° ì¤‘)
          if (castles.length > 0 || territories.length > 0) {
              requestUpdateMap();
              console.log('âœ… ì¶”ê°€ ë°ì´í„° ì§€ë„ ë°˜ì˜ ì˜ˆì•½ (drawings, naturalFeatures ë“±)');
          } else {
              console.log('â­ï¸ castles/territories ì—†ìŒ, ì¶”ê°€ ë°ì´í„° ë Œë”ë§ ìŠ¤í‚µ (ìºì‹œ ë°ì´í„° ë³´í˜¸)');
          }
          
          // ===== ë¡œë”© ì™„ë£Œ =====
          const totalTime = ((performance.now() - startTime) / 1000).toFixed(2);
          console.log(`ğŸ‰ ì „ì²´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ! (ì´ ${totalTime}ì´ˆ)`);
          
          // ğŸš€ [ìµœì í™”] ìš°ì„ ìˆœìœ„ ë‚®ì€ ë°ì´í„°ë“¤ ë°±ê·¸ë¼ìš´ë“œ ë¡œë”©
          
          // 1ï¸âƒ£ history ë°ì´í„° (2,221ê°œ)
          console.log('ğŸ“š history ë°ì´í„° ë°±ê·¸ë¼ìš´ë“œ ë¡œë”© ì‹œì‘... (2,221ê°œ)');
          setTimeout(async () => {
              try {
                  history = await fetchData('history');
                  console.log(`âœ… history ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œ ì™„ë£Œ: ${history.length}ê°œ`);
                  
                  // ğŸš€ [ìµœì í™”] ì‹œê°„ ëª©ë¡ ì¬ìƒì„±ì„ requestIdleCallbackìœ¼ë¡œ ì§€ì—° (1,605ê°œ ì‹œì  = DOM ë¶€í•˜)
                  const updateTimeline = () => {
                      const historyTimes = history.map(h => yearMonthToTotalMonths(h.year, h.month || 1));
                      const eventTimes = events.map(e => yearMonthToTotalMonths(e.year, e.month || 1));
                      historyEventTimes = [...new Set([...historyTimes, ...eventTimes])].sort((a, b) => a - b);
                      console.log(`âœ… ì—°ëŒ€í‘œ ì‹œê°„ ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${historyEventTimes.length}ê°œ ì‹œì `);
                  };
                  
                  // ë¸Œë¼ìš°ì €ê°€ í•œê°€í•  ë•Œ ì‹¤í–‰ (ë˜ëŠ” 2ì´ˆ íƒ€ì„ì•„ì›ƒ)
                  if (window.requestIdleCallback) {
                      requestIdleCallback(updateTimeline, { timeout: 2000 });
                  } else {
                      setTimeout(updateTimeline, 500);
                  }
              } catch (error) {
                  console.error('âŒ history ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                  history = [];
              }
          }, 100); // 100ms í›„ ì‹¤í–‰ (UI ë Œë”ë§ ì™„ë£Œ í›„)
          
          // 2ï¸âƒ£ castles ë°ì´í„° - ìºì‹œ ìš°ì„ , ì—†ìœ¼ë©´ DB ë¡œë“œ í›„ ìºì‹œ ì €ì¥
          if (layerVisibility.city || layerVisibility.territoryPolygon) {
              if (castles.length > 0) {
                  // ìºì‹œ íˆíŠ¸: ì´ë¯¸ ìœ„ì—ì„œ í• ë‹¹ë¨
                  console.log(`âš¡ castles ìºì‹œ ì‚¬ìš© (${castles.length}ê°œ) â†’ DB ì¬ìš”ì²­ ë¶ˆí•„ìš”`);
                  populateCitySelectForEdit();
                  // ğŸš€ [v3.5] ìºì‹œ íˆíŠ¸ ì‹œ ë°”ë¡œ ë Œë”ë§ (requestUpdateMapì€ ë””ë°”ìš´ìŠ¤ë¨)
                  requestUpdateMap();
              } else {
                  // ìºì‹œ ë¯¸ìŠ¤: DBì—ì„œ ë¡œë“œ
                  console.log('ğŸ° castles ìºì‹œ ì—†ìŒ â†’ DB ë¡œë”© ì‹œì‘...');
                  setTimeout(async () => {
                      try {
                          const castleLoadStart = performance.now();
                          const allCastlesData = await fetchData('castle');
                          const castleLoadTime = ((performance.now() - castleLoadStart) / 1000).toFixed(2);
                          console.log(`âœ… castles DB ë¡œë“œ ì™„ë£Œ: ${allCastlesData.length}ê°œ (${castleLoadTime}ì´ˆ)`);
                          
                          const countryNameMap = new Map();
                          countries.forEach(c => { if (c.name) countryNameMap.set(c.name, c._id); });
                          
                          const processStart = performance.now();
                          castles = allCastlesData.map(castle => {
                              if (castle.history && Array.isArray(castle.history) && castle.history.length > 0) {
                                  const firstHistory = castle.history[0];
                                  if (firstHistory.start_year !== undefined && firstHistory.country_id) return castle;
                              }
                              let processedHistory;
                              const hasHistory = castle.history && Array.isArray(castle.history) && castle.history.length > 0;
                              if (hasHistory) {
                                  processedHistory = castle.history.map(h => {
                                      let resolvedCountryId = h.country_id || castle.country_id || '';
                                      if (typeof resolvedCountryId !== 'string') resolvedCountryId = String(resolvedCountryId);
                                      if (!resolvedCountryId && h.country) resolvedCountryId = countryNameMap.get(h.country) || '';
                                      return {
                                          name: h.name ?? castle.name ?? '',
                                          country_id: resolvedCountryId,
                                          start_year: h.start_year ?? castle.built_year ?? -5000,
                                          start_month: h.start_month ?? castle.built_month ?? 1,
                                          end_year: h.end_year ?? castle.destroyed_year ?? null,
                                          end_month: h.end_month ?? castle.destroyed_month ?? 12,
                                          is_capital: h.is_capital ?? castle.is_capital ?? false,
                                          is_battle: h.is_battle ?? false
                                      };
                                  });
                              } else {
                                  processedHistory = [{
                                      name: castle.name || '',
                                      country_id: castle.country_id || '',
                                      start_year: castle.built_year || -5000,
                                      start_month: castle.built_month || 1,
                                      end_year: castle.destroyed_year,
                                      end_month: castle.destroyed_month || 12,
                                      is_capital: castle.is_capital || false,
                                      is_battle: castle.is_battle || false
                                  }];
                              }
                              if (castle.is_capital && !processedHistory.some(h => h.is_capital)) {
                                  processedHistory[0].is_capital = true;
                              }
                              return { ...castle, history: processedHistory };
                          });
                          
                          console.log(`âœ… castles ì²˜ë¦¬ ì™„ë£Œ: ${castles.length}ê°œ (${((performance.now()-processStart)/1000).toFixed(2)}ì´ˆ)`);
                          
                          // ğŸš€ IndexedDB ìºì‹œ ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
                          saveCastlesCache(castles).catch(e => console.warn('âš ï¸ castles ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', e));
                          
                          if (layerVisibility.countryLabel || layerVisibility.placeLabel || layerVisibility.ethnicLabel) {
                              const { year, month } = getCurrentYearMonth();
                              renderImmediateCountryLabels(year, month);
                          }
                          populateCitySelectForEdit();
                          requestUpdateMap();
                          console.log('ğŸ—ºï¸ castles ë§ˆì»¤ ë Œë”ë§ ì™„ë£Œ');
                      } catch (error) {
                          console.error('âŒ castles DB ë¡œë“œ ì‹¤íŒ¨:', error);
                          castles = [];
                      }
                  }, 200);
              }
          } else {
              console.log('â­ï¸ castles ë¡œë”© ìŠ¤í‚µ (city, territoryPolygon ëª¨ë‘ ë¹„í™œì„±í™”)');
          }
                      
          // ğŸ¯ [v2.1.2] ë¡œë”© ì™„ë£Œ ì¡°ê±´ ê°œì„ 
          showLoadingStatus('ì—­ì‚¬ì˜ ì „ì¥ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!', 100);
          
          let _checkRetryCount = 0;
          const _checkMaxRetries = 10; // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸° (500ms Ã— 10íšŒ)
          const checkTerritoriesRendered = () => {
              _checkRetryCount++;
              // ì¡°ê±´ 1: ì„±/ë„ì‹œ ë§ˆì»¤ ë Œë”ë§ ì™„ë£Œ ì‹ í˜¸ (ê°€ì¥ í™•ì‹¤í•œ ì™„ë£Œ ê¸°ì¤€)
              const castlesReady = window._castleMarkersRendered === true;
              // ì¡°ê±´ 2: Leafletì´ ì‹¤ì œë¡œ ë­”ê°€ ê·¸ë ¸ëŠ”ì§€ (ì˜í†  í´ë¦¬ê³¤ or ë§ˆì»¤)
              const hasInteractive = document.querySelector('.leaflet-interactive') !== null;
              // ì¡°ê±´ 3: ì´ˆê¸°í™” í”Œë˜ê·¸ í•´ì œë¨
              const isReady = !window.isInitializing && !isInitializing;
              // ì¡°ê±´ 4: ìµœëŒ€ ëŒ€ê¸° ì´ˆê³¼
              const isTimeout = _checkRetryCount >= _checkMaxRetries;

              if (castlesReady || isTimeout) {
                  const reason = castlesReady ? 'ì„±/ë„ì‹œ ë§ˆì»¤ ë Œë”ë§ ì™„ë£Œ' : 'ìµœëŒ€ ëŒ€ê¸° ì´ˆê³¼';
                  console.log(`âœ… ë¡œë”© í™”ë©´ í•´ì œ (${reason}, ${_checkRetryCount}íšŒ ì‹œë„)`);
                  setTimeout(() => hideLoadingStatus(), 150);
              } else {
                  console.log(`â³ ë¡œë”© ìœ ì§€ ì¤‘... (${_checkRetryCount}/${_checkMaxRetries}, castles=${castlesReady}, dom=${hasInteractive}, init=${isReady})`);
                  setTimeout(checkTerritoriesRendered, 500);
              }
          };
          
          // ğŸš€ territories ìºì‹œ ìˆìœ¼ë©´ 100ms, ì—†ìœ¼ë©´ 300ms í›„ ì²« í™•ì¸
          setTimeout(checkTerritoriesRendered, territories.length > 0 ? 100 : 300);
          
      } catch (error) {
          console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
          hideLoadingStatus();
      }
    }

      // ğŸš© [ìµœì í™”] ì˜í†  ë°ì´í„° ì§€ì—° ë¡œë”© í•¨ìˆ˜ - í™˜ê²½ì— ë”°ë¼ ìë™ ì„ íƒ
      window.loadTerritoryTiles = async function() {
          if (territories.length > 0) {
              console.log('âœ… ì˜í†  ë°ì´í„° ì´ë¯¸ ë¡œë“œë¨:', territories.length, 'ê°œ');
              return;
          }

          try {
              console.time("ğŸ—ºï¸ ì˜í†  íƒ€ì¼ ë¡œë“œ");
              const territoryBtns = document.querySelectorAll('[data-layer="territoryPolygon"]');
              territoryBtns.forEach(btn => {
                  if (btn.tagName === 'BUTTON') btn.textContent = 'ì˜í†  ë¡œë”©ì¤‘...';
              });
              
              const bounds = map.getBounds();
              
              // ğŸ“– [ìµœì í™”] ì •ì  íƒ€ì¼ íŒŒì¼ ì‚¬ìš© (ë„¤íŠ¸ì›Œí¬ ì§€ì—° í•´ê²°)
              console.log(`ğŸ“¡ [ì •ì  íŒŒì¼] ì˜í†  íƒ€ì¼ ë°ì´í„° ë¡œë“œ`);
              await loadTerritoryFromStaticTiles(bounds);
              return;
              
          } catch (error) {
              console.error('âŒ ì˜í†  íƒ€ì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
              const territoryBtns = document.querySelectorAll('[data-layer="territoryPolygon"]');
              territoryBtns.forEach(btn => {
                  if (btn.tagName === 'BUTTON') btn.textContent = 'ì˜í†  (ë¡œë“œ ì‹¤íŒ¨)';
              });
          }
      };

      // ğŸ”„ [ì •ì  íŒŒì¼] ì •ì  íƒ€ì¼ íŒŒì¼ì—ì„œ ì˜í†  ë¡œë“œ
      // ğŸš€ [ìµœì í™”] ì „ì²´ territoriesë¥¼ í•œ ë²ˆë§Œ ë¡œë“œ (287ê°œ - ë§¤ìš° ì ìŒ)
      let allTerritoriesLoaded = false;
      
      async function loadTerritoryFromStaticTiles(bounds) {
          // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ìŠ¤í‚µ
          if (allTerritoriesLoaded && territories.length > 0) {
              console.log(`âœ… ìºì‹œëœ ì˜í†  ì‚¬ìš©: ${territories.length}ê°œ`);
              const territoryBtns = document.querySelectorAll('[data-layer="territoryPolygon"]');
              territoryBtns.forEach(btn => {
                  if (btn.tagName === 'BUTTON') btn.textContent = `ì˜í†  ${territories.length}ê°œ`;
              });
              return;
          }

          console.log(`ğŸ“¡ [ì •ì  íŒŒì¼] ì „ì²´ ì˜í†  ë°ì´í„° ë¡œë”©...`);

          const territoryBtns = document.querySelectorAll('[data-layer="territoryPolygon"]');
          const startTime = Date.now();

          try {
              // 1. íƒ€ì¼ ì¸ë±ìŠ¤ ë¡œë“œ
              // ğŸ¯ [ë¡œì»¬/ì„œë²„ í˜¸í™˜] ì ˆëŒ€ ê²½ë¡œ + ìºì‹œ ë¬´íš¨í™”
              // - ë¡œì»¬ ê°œë°œ: /public/tiles/ (Express static ë¯¸ë“¤ì›¨ì–´)
              // - Vercel ë°°í¬: /tiles/ (public í´ë”ê°€ ë£¨íŠ¸ë¡œ ì´ë™)
              
              // ğŸ”¥ [ìºì‹œ ë¬´íš¨í™”] íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ë¡œ Vercel Edge Cache ìš°íšŒ
              const timestamp = new Date().getTime();
              const origin = window.location.origin; // ì ˆëŒ€ ê²½ë¡œ ìƒì„±
              
              // ğŸš€ [v2.0.9] í™˜ê²½ ìë™ ê°ì§€ (404 ì—ëŸ¬ ë°©ì§€, 2.4ì´ˆ ë‹¨ì¶•)
              const isLocal = origin.includes('localhost') || origin.includes('127.0.0.1');
              const primaryPath = isLocal ? '/public/tiles' : '/tiles';
              const fallbackPath = isLocal ? '/tiles' : '/public/tiles';
              
              let tilesBasePath = primaryPath;
              let indexUrl = `${origin}${primaryPath}/index.json?v=${timestamp}`;
              
              console.log(`ğŸ“¡ [í™˜ê²½ ê°ì§€] ${isLocal ? 'ë¡œì»¬' : 'ë°°í¬'} ëª¨ë“œ, ìš°ì„  ê²½ë¡œ: ${indexUrl}`);
              
              // ìš°ì„  ê²½ë¡œ ì‹œë„ + ìºì‹œ ë¬´íš¨í™” í—¤ë”
              let indexResponse = await fetch(indexUrl, {
                  method: 'GET',
                  headers: {
                      'Accept': 'application/json',
                      'Cache-Control': 'no-cache',
                      'Pragma': 'no-cache'
                  }
              });
              
              // 404ë©´ í´ë°± ê²½ë¡œ ì‹œë„
              if (!indexResponse.ok) {
                  console.log(`ğŸ”„ ${primaryPath} ì‹¤íŒ¨, ${fallbackPath} ì‹œë„...`);
                  tilesBasePath = fallbackPath;
                  indexUrl = `${origin}${fallbackPath}/index.json?v=${timestamp}`;
                  indexResponse = await fetch(indexUrl, {
                      method: 'GET',
                      headers: {
                          'Accept': 'application/json',
                          'Cache-Control': 'no-cache',
                          'Pragma': 'no-cache'
                      }
                  });
              }
              
              if (!indexResponse.ok) {
                  throw new Error(`íƒ€ì¼ ì¸ë±ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ${indexResponse.status} (URL: ${indexUrl})`);
              }
              
              const tileIndex = await indexResponse.json();
              console.log(`ğŸ“Š íƒ€ì¼ ì¸ë±ìŠ¤: ${tileIndex.length}ê°œ íƒ€ì¼ (ê²½ë¡œ: ${tilesBasePath})`);

              // 2. ëª¨ë“  íƒ€ì¼ íŒŒì¼ë“¤ ë¡œë“œ (287ê°œ ì˜í† ëŠ” ì¶©ë¶„íˆ ì‘ì•„ì„œ ì „ì²´ ë¡œë“œ ê°€ëŠ¥)
              // ë³‘ë ¬ë¡œ 10ê°œì”© ë¡œë“œí•´ì„œ ì„œë²„ ë¶€í•˜ ë°©ì§€
              const batchSize = 10;
              const allFeatures = [];
              
              for (let i = 0; i < tileIndex.length; i += batchSize) {
                  const batch = tileIndex.slice(i, i + batchSize);
                  const batchPromises = batch.map(async (tile) => {
                      try {
                          // ê°ì§€ëœ ê²½ë¡œ ì‚¬ìš© + ìºì‹œ ë¬´íš¨í™”
                          const tileUrl = `${origin}${tilesBasePath}/${tile.filename}?v=${timestamp}`;
                          const tileResponse = await fetch(tileUrl, {
                              method: 'GET',
                              headers: {
                                  'Accept': 'application/json',
                                  'Cache-Control': 'no-cache',
                                  'Pragma': 'no-cache'
                              }
                          });
                          if (!tileResponse.ok) {
                              console.warn(`íƒ€ì¼ ë¡œë“œ ì‹¤íŒ¨: ${tile.filename}`);
                              return [];
                          }
                          const tileData = await tileResponse.json();
                          return tileData.features || [];
                      } catch (error) {
                          console.warn(`íƒ€ì¼ ë¡œë“œ ì˜¤ë¥˜: ${tile.filename}`, error);
                          return [];
                      }
                  });
                  
                  const batchResults = await Promise.all(batchPromises);
                  allFeatures.push(...batchResults.flat());
                  
                  // ì§„í–‰ë¥  í‘œì‹œ
                  const progress = Math.floor((i + batch.length) / tileIndex.length * 100);
                  territoryBtns.forEach(btn => {
                      if (btn.tagName === 'BUTTON') {
                          btn.textContent = `ì˜í†  ë¡œë”©ì¤‘... ${progress}%`;
                      }
                  });
              }

              // 3. ğŸš€ [ìµœì í™”] ì¤‘ë³µ ì œê±° - _id ê¸°ì¤€ìœ¼ë¡œ ê³ ìœ í•œ ì˜í† ë§Œ ì €ì¥
              const uniqueTerritories = new Map();
              
              allFeatures.forEach(feature => {
                  const id = feature.properties?._id || feature.properties?.id || feature.id;
                  if (id && !uniqueTerritories.has(id)) {
                      uniqueTerritories.set(id, {
                          _id: id,
                          name: feature.properties?.name || 'ì˜í† ',
                          name_ko: feature.properties?.name_ko,
                          name_type: feature.properties?.name_type,
                          type: feature.geometry?.type,
                          coordinates: feature.geometry?.coordinates,
                          level: feature.properties?.level,
                          start: feature.properties?.start_year || feature.properties?.start,
                          end: feature.properties?.end_year || feature.properties?.end
                      });
                  }
              });
              
              territories = Array.from(uniqueTerritories.values());
              allTerritoriesLoaded = true;
              const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
              
              console.log(`ğŸ‰ ì •ì  íŒŒì¼ ë¡œë“œ ì™„ë£Œ!`);
              console.log(`  ğŸ“¦ ì›ë³¸ features: ${allFeatures.length}ê°œ`);
              console.log(`  âœ… ê³ ìœ  ì˜í† : ${territories.length}ê°œ`);
              console.log(`  â±ï¸ ì†Œìš” ì‹œê°„: ${elapsed}ì´ˆ`);
              
              territoryBtns.forEach(btn => {
                  if (btn.tagName === 'BUTTON') btn.textContent = `ì˜í†  ${territories.length}ê°œ`;
              });

              // ğŸš€ [ìµœì í™”] updateMap ì¤‘ë³µ í˜¸ì¶œ ì œê±°
              // ìµœì¢… ë Œë”ë§ì€ initialize() í•¨ìˆ˜ ëì—ì„œ í•œ ë²ˆë§Œ ì‹¤í–‰
              console.log('âœ… ì˜í†  ë¡œë“œ ì™„ë£Œ (ë Œë”ë§ì€ ìµœì¢… ë‹¨ê³„ì—ì„œ ìˆ˜í–‰)');

          } catch (error) {
              console.error('âŒ ì •ì  íŒŒì¼ ì˜í†  ë¡œë“œ ì‹¤íŒ¨:', error);
              // í´ë°±: MongoDBì—ì„œ ë¡œë“œ
              console.log('ğŸ”„ MongoDB í´ë°± ì‚¬ìš©');
              await loadTerritoryFromMongoDB(bounds);
          }
      }

      // ğŸ”„ [MongoDB í´ë°±] ì •ì  íŒŒì¼ì´ ì—†ì„ ë•Œ MongoDBì—ì„œ ë¡œë“œ
      
      async function loadTerritoryFromMongoDB(bounds) {
          // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ìŠ¤í‚µ
          if (allTerritoriesLoaded && territories.length > 0) {
              console.log(`âœ… ìºì‹œëœ ì˜í†  ì‚¬ìš©: ${territories.length}ê°œ`);
              return;
          }
          
          console.log(`ğŸ“¡ [MongoDB] ì „ì²´ ì˜í†  ë°ì´í„° ë¡œë”©...`);
          
          // ğŸ”‘ í† í°ì´ ìˆìœ¼ë©´ í—¤ë”ì— í¬í•¨ (ì„ íƒì  ì¸ì¦)
          const headers = {};
          const token = getToken();
          if (token) {
              headers['Authorization'] = `Bearer ${token}`;
          }
          
          // ì§„í–‰ë¥  í‘œì‹œ
          const territoryBtns = document.querySelectorAll('[data-layer="territoryPolygon"]');
          const startTime = Date.now();
          let progressInterval = setInterval(() => {
              const elapsed = Math.floor((Date.now() - startTime) / 1000);
              territoryBtns.forEach(btn => {
                  if (btn.tagName === 'BUTTON') {
                      btn.textContent = `ì˜í†  ë¡œë”©ì¤‘... ${elapsed}ì´ˆ`;
                  }
              });
          }, 1000);
          
          try {
              // ğŸš€ bounds ì—†ì´ ì „ì²´ ì˜í†  ë¡œë“œ (ìºì‹± í™œìš©)
              const response = await fetch(
                  `${API_BASE_URL}/territories`,
                  { headers }
              );
              
              if (!response.ok) {
                  const errorText = await response.text();
                  console.error(`âŒ MongoDB ì˜í†  ë¡œë“œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`, errorText);
                  throw new Error(`MongoDB ì˜í†  ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
              }
              
              const data = await response.json();
              const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
              
              territories = data.map(t => ({
                  _id: t._id,
                  name: t.name,
                  name_ko: t.name_ko,
                  name_type: t.name_type,
                  type: t.geometry?.type || t.type,
                  coordinates: t.geometry?.coordinates || t.coordinates,
                  level: t.level,
                  start: t.start || t.start_year,
                  end: t.end || t.end_year
              }));
              
              allTerritoriesLoaded = true;
              clearInterval(progressInterval);
              
              console.timeEnd("ğŸ—ºï¸ ì˜í†  íƒ€ì¼ ë¡œë“œ");
              console.log(`ğŸ‰ ì „ì²´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ! (ì´ ${elapsed}ì´ˆ)`);
              
              territoryBtns.forEach(btn => {
                  if (btn.tagName === 'BUTTON') btn.textContent = `ì˜í†  ${territories.length}ê°œ`;
              });
              
              // ì˜í†  ë Œë”ë§
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } catch (error) {
              console.error('âŒ ì˜í†  ë¡œë“œ ì‹¤íŒ¨:', error);
              clearInterval(progressInterval);
              territoryBtns.forEach(btn => {
                  if (btn.tagName === 'BUTTON') btn.textContent = 'ì˜í†  (ë¡œë“œ ì‹¤íŒ¨)';
              });
          }
      }
      
      // ğŸš© [ìµœì í™”] ì¦ë¶„ ì—…ë°ì´íŠ¸ í—¬í¼ í•¨ìˆ˜ë“¤ - ì„œë²„ ì‘ë‹µ ë°ì´í„°ë¡œ ì •í™•íˆ ë™ê¸°í™”
      window.updateCastleInMemory = async (castleKey, serverResponseData) => {
          try {
              // 1. ì—…ë°ì´íŠ¸í•  ëŒ€ìƒ ì°¾ê¸°
              const index = castles.findIndex(c => c.name === castleKey || c._id === castleKey);
              let updatedCastle = serverResponseData;

              // ë§Œì•½ ì„œë²„ ì‘ë‹µì´ ì—†ë‹¤ë©´ ì„œë²„ì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° (ì•ˆì „ì¥ì¹˜)
              if (!updatedCastle) {
                  console.log('ğŸ“¡ serverResponseDataê°€ ì—†ì–´ ì„œë²„ì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜´');
                  const response = await fetch(`${API_BASE_URL}/castle/${castleKey}`, {
                      headers: { 'Authorization': `Bearer ${getToken()}` }
                  });
                  if (!response.ok) {
                      throw new Error(`Failed to fetch castle: ${response.status}`);
                  }
                  updatedCastle = await response.json();
              }

              console.log('ğŸ“¥ ì‚¬ìš©í•  ë°ì´í„°:', updatedCastle);

              if (index !== -1 && updatedCastle) {
                  const oldCastle = { ...castles[index] }; // ë³€ê²½ ì „ ìƒíƒœ ë°±ì—…

                  // ğŸš¨ [í•µì‹¬ ìˆ˜ì • 1] ì „ì—­ ë°°ì—´(castles)ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                  castles[index] = updatedCastle;
                  console.log(`ğŸ”„ ë©”ëª¨ë¦¬ìƒ ë°ì´í„° êµì²´ ì™„ë£Œ: ${updatedCastle.name} (íƒ€ì…: ${updatedCastle.is_natural_feature ? 'ìì—°ì§€ë¬¼' : 'ì„±'})`);

                  // 2. ì§€ë„ UI ì—…ë°ì´íŠ¸ (íƒ€ì…ë³„ ë¶„ê¸°)
                  if (updatedCastle.is_label) {
                      console.log('ğŸ·ï¸ ë¼ë²¨ ì—…ë°ì´íŠ¸ ì‹œì‘...');
                      const { year, month } = getCurrentYearMonth();
                      try {
                          updateSingleLabel(oldCastle, updatedCastle, year, month);
                      } catch (labelError) {
                          console.error('âŒ ë¼ë²¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨, ì „ì²´ ë§µ ê°±ì‹ :', labelError);
                          updateMap(year, month);
                      }
                  }
                  else if (updatedCastle.is_natural_feature) {
                      console.log('ğŸŒ³ ìì—° ì§€í˜•ì§€ë¬¼ ê°œë³„ ì—…ë°ì´íŠ¸ ì‹œì‘...');
                      try {
                          // ì„±(Castle)ì—ì„œ ìì—°ì§€ë¬¼ë¡œ ë³€í•œ ê²½ìš°, ê¸°ì¡´ ì„± ë§ˆì»¤ë¥¼ ì§€ì›Œì•¼ í•¨
                          if (!oldCastle.is_natural_feature && window.castleLayerGroup) {
                               // ê¸°ì¡´ ë§ˆì»¤ ë ˆì´ì–´ì—ì„œ í•´ë‹¹ IDë¥¼ ê°€ì§„ ë§ˆì»¤ ì œê±° ì‹œë„
                               window.castleLayerGroup.eachLayer(layer => {
                                  if (layer.options && layer.options.id === castleKey) {
                                      window.castleLayerGroup.removeLayer(layer);
                                      console.log('ğŸ—‘ï¸ ë³€í™˜ëœ ì„± ë§ˆì»¤ ì œê±°ë¨');
                                  }
                               });
                          }

                          // ìì—°ì§€ë¬¼ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
                          updateSingleNaturalFeature(oldCastle, updatedCastle);

                      } catch (error) {
                          console.error('âŒ ìì—° ì§€í˜•ì§€ë¬¼ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
                          const { year, month } = getCurrentYearMonth();
                          updateMap(year, month);
                      }
                  }
                  else {
                      // ì¼ë°˜ ì„±/ì „ì¥ì€ ì „ì²´ ë§µ ê°±ì‹ 
                      const { year, month } = getCurrentYearMonth();
                      updateMap(year, month);
                  }

                  // ğŸš¨ [í•µì‹¬ ìˆ˜ì • 2] ë°°ì—´ ì—…ë°ì´íŠ¸ ì™„ë£Œ
                  console.log('âœ… ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
              } else {
                  console.warn(`âš ï¸ ë©”ëª¨ë¦¬ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${castleKey}. ì „ì²´ ë§µ ê°±ì‹ `);
                  const { year, month } = getCurrentYearMonth();
                  updateMap(year, month);
              }
          } catch (error) {
              console.error(`âŒ ì„±/ì „ì¥ ë™ê¸°í™” ì‹¤íŒ¨: ${castleKey}`, error);
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          }
      };
      
      window.addCastleInMemory = (newCastle) => {
          // ì„œë²„ ì‘ë‹µ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ë©”ëª¨ë¦¬ì— ì¶”ê°€
          castles.push(newCastle);
          console.log(`âœ… ì„±/ì „ì¥ ë©”ëª¨ë¦¬ ì¶”ê°€ ì™„ë£Œ: ${newCastle.name} (ID: ${newCastle._id})`);
          console.log(`   ğŸ” is_label: ${newCastle.is_label}, label_type: ${newCastle.label_type}`);
          populateCitySelectForEdit(); // ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
          
          const { year, month } = getCurrentYearMonth();
          console.log(`   ğŸ“… í˜„ì¬ ì‹œê°„: ${year}ë…„ ${month}ì›”`);
          
          // ğŸ¨ [ìµœì í™”] ë¼ë²¨ì¸ ê²½ìš° ì‹œê°„ ì²´í¬ í›„ ê°œë³„ ì¶”ê°€
          if (newCastle.is_label) {
              const startYear = newCastle.start_year || newCastle.built_year || -Infinity;
              const endYear = newCastle.end_year || newCastle.destroyed_year || Infinity;
              const isWithinDuration = startYear <= year && endYear >= year;
              
              console.log(`   ğŸ·ï¸ ë¼ë²¨ ê°ì§€! ì‹œê°„ ì²´í¬: ${startYear} <= ${year} <= ${endYear} = ${isWithinDuration}`);
              
              if (isWithinDuration) {
                  console.log(`ğŸ·ï¸ ë¼ë²¨ ì¶”ê°€: ${newCastle.name} (í˜„ì¬ ${year}ë…„)`);
                  try {
                      addSingleLabel(newCastle, year, month);
                  } catch (error) {
                      console.error('âŒ ë¼ë²¨ ì¶”ê°€ ì‹¤íŒ¨, ì „ì²´ ë§µ ê°±ì‹ :', error);
                      updateMap(year, month);
                  }
              } else {
                  console.log(`â­ï¸ ë¼ë²¨ "${newCastle.name}"ì€ í˜„ì¬ ì‹œê°„ëŒ€(${year}ë…„)ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                  console.log(`   ğŸ“… í‘œì‹œ ê¸°ê°„: ${startYear}ë…„ ~ ${endYear === Infinity ? 'í˜„ì¬' : endYear + 'ë…„'}`);
                  alert(`ë¼ë²¨ "${newCastle.name}"ì´ ì¶”ê°€ë˜ì—ˆì§€ë§Œ, í˜„ì¬ ì‹œê°„ëŒ€(${year}ë…„)ì—ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\ní‘œì‹œ ê¸°ê°„: ${startYear}ë…„ ~ ${endYear === Infinity ? 'í˜„ì¬' : endYear + 'ë…„'}`);
              }
          } 
          // ğŸŒ³ [ì¶”ê°€] ìì—° ì§€í˜•ì§€ë¬¼ì¸ ê²½ìš° ê°œë³„ ì¶”ê°€
          else if (newCastle.is_natural_feature) {
              const startYear = newCastle.start_year || newCastle.built_year || -Infinity;
              const endYear = newCastle.end_year || newCastle.destroyed_year || Infinity;
              const isWithinDuration = startYear <= year && endYear >= year;
              
              console.log(`   ğŸŒ³ ìì—° ì§€í˜•ì§€ë¬¼ ê°ì§€! ì‹œê°„ ì²´í¬: ${startYear} <= ${year} <= ${endYear} = ${isWithinDuration}`);
              
              if (isWithinDuration) {
                  console.log(`ğŸŒ³ ìì—° ì§€í˜•ì§€ë¬¼ ì¶”ê°€: ${newCastle.name} (í˜„ì¬ ${year}ë…„)`);
                  try {
                      addSingleNaturalFeature(newCastle, year, month);
                  } catch (error) {
                      console.error('âŒ ìì—° ì§€í˜•ì§€ë¬¼ ì¶”ê°€ ì‹¤íŒ¨, ì „ì²´ ë§µ ê°±ì‹ :', error);
                      updateMap(year, month);
                  }
              } else {
                  console.log(`â­ï¸ ìì—° ì§€í˜•ì§€ë¬¼ "${newCastle.name}"ì€ í˜„ì¬ ì‹œê°„ëŒ€(${year}ë…„)ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                  console.log(`   ğŸ“… í‘œì‹œ ê¸°ê°„: ${startYear}ë…„ ~ ${endYear === Infinity ? 'í˜„ì¬' : endYear + 'ë…„'}`);
                  alert(`ìì—° ì§€í˜•ì§€ë¬¼ "${newCastle.name}"ì´ ì¶”ê°€ë˜ì—ˆì§€ë§Œ, í˜„ì¬ ì‹œê°„ëŒ€(${year}ë…„)ì—ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\ní‘œì‹œ ê¸°ê°„: ${startYear}ë…„ ~ ${endYear === Infinity ? 'í˜„ì¬' : endYear + 'ë…„'}`);
              }
          }
          else {
              // ì¼ë°˜ ì„±/ì „ì¥ì€ ì „ì²´ ë§µ ê°±ì‹ 
              updateMap(year, month);
          }
      };
      
      window.deleteCastleInMemory = (castleKey) => {
          // name ë˜ëŠ” _idë¡œ ì°¾ê¸°
          const index = castles.findIndex(c => c.name === castleKey || c._id === castleKey);
          if (index !== -1) {
              castles.splice(index, 1);
              console.log(`âœ… ì„±/ì „ì¥ ë©”ëª¨ë¦¬ ì‚­ì œ: ${castleKey}`);
              populateCitySelectForEdit(); // ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } else {
              console.warn(`âš ï¸ ì‚­ì œí•  ì„±/ì „ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${castleKey}`);
          }
      };
      
      // ğŸŒŠ [ìì—°ì§€í˜•] ë©”ëª¨ë¦¬ ì¶”ê°€/ì‚­ì œ í•¨ìˆ˜
      window.addNaturalFeatureInMemory = (newFeature) => {
          naturalFeatures.push(newFeature);
          console.log(`âœ… ìì—°ì§€í˜• ë©”ëª¨ë¦¬ ì¶”ê°€ ì™„ë£Œ: ${newFeature.name} (ID: ${newFeature._id})`);
          
          // ì¦‰ì‹œ ì§€ë„ ê°±ì‹ 
          const { year, month } = getCurrentYearMonth();
          updateMap(year, month);
      };
      
      window.deleteNaturalFeatureInMemory = (featureKey) => {
          const index = naturalFeatures.findIndex(f => f.name === featureKey || f._id === featureKey);
          if (index !== -1) {
              naturalFeatures.splice(index, 1);
              console.log(`âœ… ìì—°ì§€í˜• ë©”ëª¨ë¦¬ ì‚­ì œ: ${featureKey}`);
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } else {
              console.warn(`âš ï¸ ì‚­ì œí•  ìì—°ì§€í˜•ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${featureKey}`);
          }
      };
      
      window.updateCountryInMemory = async (originalNameOrId, serverResponseData) => {
          // ì„œë²„ì—ì„œ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ë™ê¸°í™”
          try {
              // ğŸš© [ìˆ˜ì •] _id ë˜ëŠ” nameìœ¼ë¡œ fetch (ì´ë¦„ ë³€ê²½ ì‹œì—ë„ ì•ˆì „)
              const fetchKey = serverResponseData.name || originalNameOrId;
              const updatedCountry = await fetchData(`countries/${encodeURIComponent(fetchKey)}`);
              // ğŸ”„ [ìˆ˜ì •] name ë˜ëŠ” _idë¡œ ì°¾ê¸°
              const index = countries.findIndex(c => c.name === originalNameOrId || String(c._id) === String(originalNameOrId));
              
              if (index !== -1 && updatedCountry) {
                  countries[index] = updatedCountry;
                  
                  // ğŸš© [í•µì‹¬ ìˆ˜ì •] ìºì‹œ ê°•ì œ ë¬´íš¨í™” â€” ì´ë¦„ ë³€ê²½ì´ ì¦‰ì‹œ ë°˜ì˜ë˜ë„ë¡
                  invalidateCountryLookupCache();
                  
                  // ğŸš© [ìˆ˜ì •] localStorage ìºì‹œë„ ì¦‰ì‹œ ê°±ì‹  (ì¬ë¡œê·¸ì¸ í›„ì—ë„ ë³´ì´ë„ë¡)
                  try {
                      localStorage.setItem('countries_cache', JSON.stringify(countries));
                      localStorage.setItem('countries_cache_time', Date.now().toString());
                  } catch(e) { console.warn('countries_cache ì €ì¥ ì‹¤íŒ¨', e); }
                  
                  console.log(`âœ… êµ­ê°€ DB ë™ê¸°í™” ì™„ë£Œ: ${originalNameOrId} â†’ ${updatedCountry.name}`, updatedCountry);
                  
                  // ğŸš© [ìˆ˜ì •] ì „ì²´ ë§µ ê°±ì‹  (ì˜í†  êµ­ê°€ëª…, ìˆ˜ë„ëª…, ë¼ë²¨ ë“± ëª¨ë‘ ë°˜ì˜)
                  const { year, month } = getCurrentYearMonth();
                  updateMap(year, month);
                  
                  // ğŸš© [ì¶”ê°€] êµ­ê°€ í¸ì§‘ select ëª©ë¡ë„ ê°±ì‹ 
                  if (typeof updateCountrySelectForEdit === 'function') {
                      updateCountrySelectForEdit();
                  }
              } else {
                  console.warn(`âš ï¸ ë©”ëª¨ë¦¬ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${originalNameOrId}`);
              }
          } catch (error) {
              console.error(`âŒ êµ­ê°€ ë™ê¸°í™” ì‹¤íŒ¨: ${originalNameOrId}`, error);
          }
      };
      
      window.addCountryInMemory = (newCountry) => {
          countries.push(newCountry);
          invalidateCountryLookupCache();
          // ğŸš© [ìˆ˜ì •] localStorage ìºì‹œë„ ì¦‰ì‹œ ê°±ì‹  (ì¬ë¡œê·¸ì¸ í›„ì—ë„ ë³´ì´ë„ë¡)
          try {
              localStorage.setItem('countries_cache', JSON.stringify(countries));
              localStorage.setItem('countries_cache_time', Date.now().toString());
          } catch(e) { console.warn('countries_cache ì €ì¥ ì‹¤íŒ¨', e); }
          console.log(`âœ… êµ­ê°€ ë©”ëª¨ë¦¬ ì¶”ê°€: ${newCountry.name} (ID: ${newCountry._id})`);
          const { year, month } = getCurrentYearMonth();
          updateMap(year, month);
          if (typeof updateCountrySelectForEdit === 'function') updateCountrySelectForEdit();
      };
      
      window.deleteCountryInMemory = (countryName) => {
          // ğŸ”„ [ìˆ˜ì •] name ë˜ëŠ” _idë¡œ ì°¾ê¸°
          const index = countries.findIndex(c => c.name === countryName || String(c._id) === String(countryName));
          if (index !== -1) {
              countries.splice(index, 1);
              invalidateCountryLookupCache();
              // ğŸš© [ìˆ˜ì •] localStorage ìºì‹œë„ ì¦‰ì‹œ ê°±ì‹  (ì¬ë¡œê·¸ì¸ í›„ì—ë„ ë°˜ì˜ë˜ë„ë¡)
              try {
                  localStorage.setItem('countries_cache', JSON.stringify(countries));
                  localStorage.setItem('countries_cache_time', Date.now().toString());
              } catch(e) { console.warn('countries_cache ì €ì¥ ì‹¤íŒ¨', e); }
              console.log(`âœ… êµ­ê°€ ë©”ëª¨ë¦¬ ì‚­ì œ: ${countryName}`);
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
              if (typeof updateCountrySelectForEdit === 'function') updateCountrySelectForEdit();
          } else {
              console.warn(`âš ï¸ ì‚­ì œí•  êµ­ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${countryName}`);
          }
      };
      
      window.updateEventInMemory = async (eventId, serverResponseData) => {
          // ì„œë²„ì—ì„œ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ë™ê¸°í™”
          try {
              const updatedEvent = await fetchData(`events/${eventId}`);
              const index = events.findIndex(e => e._id === eventId);
              
              if (index !== -1 && updatedEvent) {
                  events[index] = updatedEvent;
                  console.log(`âœ… ì´ë²¤íŠ¸ DB ë™ê¸°í™” ì™„ë£Œ: ${eventId}`, updatedEvent);
              } else {
                  console.warn(`âš ï¸ ë©”ëª¨ë¦¬ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${eventId}`);
              }
              
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } catch (error) {
              console.error(`âŒ ì´ë²¤íŠ¸ ë™ê¸°í™” ì‹¤íŒ¨: ${eventId}`, error);
          }
      };
      
      window.addEventInMemory = (newEvent) => {
          events.push(newEvent);
          console.log(`âœ… ì´ë²¤íŠ¸ ë©”ëª¨ë¦¬ ì¶”ê°€: ${newEvent._id}`);
          const { year, month } = getCurrentYearMonth();
          updateMap(year, month);
      };
      
      window.deleteEventInMemory = (eventId) => {
          const index = events.findIndex(e => e._id === eventId);
          if (index !== -1) {
              events.splice(index, 1);
              console.log(`âœ… ì´ë²¤íŠ¸ ë©”ëª¨ë¦¬ ì‚­ì œ: ${eventId}`);
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } else {
              console.warn(`âš ï¸ ì‚­ì œí•  ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${eventId}`);
          }
      };
      
      window.updateKingInMemory = async (kingId, serverResponseData) => {
          // ì„œë²„ì—ì„œ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ë™ê¸°í™”
          try {
              const updatedKing = await fetchData(`kings/${kingId}`);
              let found = false;
              
              // kings ê°ì²´ì˜ ëª¨ë“  êµ­ê°€ ë°°ì—´ì„ ìˆœíšŒí•˜ë©° í•´ë‹¹ ì™•ì„ ì°¾ìŒ
              for (const cId in kings) {
                  const list = kings[cId];
                  const idx = list.findIndex(k => k._id === kingId || k._id.toString() === kingId);
                  if (idx !== -1) {
                      // êµ­ê°€ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
                      const newCId = updatedKing.country_id || updatedKing.countryId;
                      if (newCId && newCId !== cId) {
                          // ê¸°ì¡´ êµ­ê°€ì—ì„œ ì œê±°
                          list.splice(idx, 1);
                          // ìƒˆ êµ­ê°€ì— ì¶”ê°€
                          if (!kings[newCId]) kings[newCId] = [];
                          kings[newCId].push(updatedKing);
                      } else {
                          // ê°™ì€ êµ­ê°€ ë‚´ ì—…ë°ì´íŠ¸
                          list[idx] = updatedKing;
                      }
                      found = true;
                      console.log(`âœ… ì™• DB ë™ê¸°í™” ì™„ë£Œ: ${kingId}`);
                      break;
                  }
              }
              
              if (!found && updatedKing) {
                  // ë©”ëª¨ë¦¬ì— ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€ (êµ­ê°€ IDê°€ ìˆëŠ” ê²½ìš°)
                  const cId = updatedKing.country_id || updatedKing.countryId;
                  if (cId) {
                      if (!kings[cId]) kings[cId] = [];
                      kings[cId].push(updatedKing);
                      console.log(`âœ… ì™• ë©”ëª¨ë¦¬ ì‹ ê·œ ì¶”ê°€ (ë™ê¸°í™”): ${kingId}`);
                  }
              }
              
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } catch (error) {
              console.error(`âŒ ì™• ë™ê¸°í™” ì‹¤íŒ¨: ${kingId}`, error);
          }
      };
      
      window.addKingInMemory = (newKing) => {
          const cId = newKing.countryId || newKing.country_id;
          if (cId) {
              if (!kings[cId]) kings[cId] = [];
              kings[cId].push(newKing);
              console.log(`âœ… ì™• ë©”ëª¨ë¦¬ ì¶”ê°€: ${newKing._id} (êµ­ê°€: ${cId})`);
          } else {
              console.error("âŒ ì™• ë©”ëª¨ë¦¬ ì¶”ê°€ ì‹¤íŒ¨: êµ­ê°€ ID ì—†ìŒ", newKing);
          }
          const { year, month } = getCurrentYearMonth();
          updateMap(year, month);
      };
      
      window.deleteKingInMemory = (kingId) => {
          let found = false;
          for (const cId in kings) {
              const list = kings[cId];
              const idx = list.findIndex(k => k._id === kingId || k._id.toString() === kingId);
              if (idx !== -1) {
                  list.splice(idx, 1);
                  found = true;
                  console.log(`âœ… ì™• ë©”ëª¨ë¦¬ ì‚­ì œ: ${kingId}`);
                  break;
              }
          }
          
          if (found) {
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } else {
              console.warn(`âš ï¸ ì‚­ì œí•  ì™•ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${kingId}`);
          }
      };
      
      window.updateDrawingInMemory = async (drawingId, serverResponseData) => {
          // ì„œë²„ì—ì„œ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ë™ê¸°í™”
          try {
              const updatedDrawing = await fetchData(`drawings/${drawingId}`);
              const index = drawings.findIndex(d => d._id === drawingId);
              
              if (index !== -1 && updatedDrawing) {
                  drawings[index] = updatedDrawing;
                  console.log(`âœ… ê·¸ë¦¬ê¸° DB ë™ê¸°í™” ì™„ë£Œ: ${drawingId}`, updatedDrawing);
              } else {
                  console.warn(`âš ï¸ ë©”ëª¨ë¦¬ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${drawingId}`);
              }
              
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } catch (error) {
              console.error(`âŒ ê·¸ë¦¬ê¸° ë™ê¸°í™” ì‹¤íŒ¨: ${drawingId}`, error);
          }
      };
      
      window.addDrawingInMemory = (newDrawing) => {
          drawings.push(newDrawing);
          console.log(`âœ… ê·¸ë¦¬ê¸° ë©”ëª¨ë¦¬ ì¶”ê°€: ${newDrawing._id}`);
          const { year, month } = getCurrentYearMonth();
          updateMap(year, month);
      };
      
      window.deleteDrawingInMemory = (drawingId) => {
          const index = drawings.findIndex(d => d._id === drawingId);
          if (index !== -1) {
              drawings.splice(index, 1);
              console.log(`âœ… ê·¸ë¦¬ê¸° ë©”ëª¨ë¦¬ ì‚­ì œ: ${drawingId}`);
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } else {
              console.warn(`âš ï¸ ì‚­ì œí•  ê·¸ë¦¬ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${drawingId}`);
          }
      };
      
      // ğŸš© [ìˆ˜ì •] ì´ì „/ë‹¤ìŒ ì—­ì‚¬ ì´ë™ í•¨ìˆ˜ë¡œ ì¶”ì¶œ
      const gotoPrevHistory = () => {
          const year = parseInt(yearInput.value);
          const month = parseInt(monthInput.value);
          const currentTotalMonths = yearMonthToTotalMonths(year, month);
          
          // í˜„ì¬ ì‹œì ë³´ë‹¤ ì´ì „ì˜ ê¸°ë¡ë“¤ ì¤‘ ê°€ì¥ ë‚˜ì¤‘ì˜ ì‹œê°„ì„ ì°¾ìŠµë‹ˆë‹¤.
          const prevTime = historyEventTimes.filter(t => t < currentTotalMonths).pop();

          if (prevTime !== undefined) {
              const { year: targetYear, month: targetMonth } = totalMonthsToYearMonth(prevTime);
              updateTime(targetYear, targetMonth);
          }
      };

      const gotoNextHistory = () => {
          const year = parseInt(yearInput.value);
          const month = parseInt(monthInput.value);
          const currentTotalMonths = yearMonthToTotalMonths(year, month);

          // í˜„ì¬ ì‹œì ë³´ë‹¤ ì´í›„ì˜ ê¸°ë¡ë“¤ ì¤‘ ê°€ì¥ ì²˜ìŒì˜ ì‹œê°„ì„ ì°¾ìŠµë‹ˆë‹¤.
          const nextTime = historyEventTimes.find(t => t > currentTotalMonths);

          if (nextTime !== undefined) {
              const { year: targetYear, month: targetMonth } = totalMonthsToYearMonth(nextTime);
              updateTime(targetYear, targetMonth);
          }
      };

      const openHistoryForm = () => {
          editingHistoryKey = null;
          closeAllFormsExcept('historyForm');
          document.getElementById('historyForm').style.display = 'block';
          document.getElementById('addHistoryForm').reset();
          document.getElementById('deleteHistoryBtn').style.display = 'none';
          document.getElementById('historyYear').value = yearInput.value;
          document.getElementById('historyMonth').value = monthInput.value;
          document.getElementById('saveHistoryBtn').textContent = 'ì €ì¥';
      };

      // ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ ì´ì „/ë‹¤ìŒ/ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
      const mapPrevHistoryBtn = document.getElementById('map-prev-history-btn');
      const mapNextHistoryBtn = document.getElementById('map-next-history-btn');
      const mapOpenHistoryFormBtn = document.getElementById('map-open-history-form-btn');
      
      if (mapPrevHistoryBtn) {
          mapPrevHistoryBtn.addEventListener('click', gotoPrevHistory);
      }
      
      if (mapNextHistoryBtn) {
          mapNextHistoryBtn.addEventListener('click', gotoNextHistory);
      }
      
      if (mapOpenHistoryFormBtn) {
          mapOpenHistoryFormBtn.addEventListener('click', openHistoryForm);
      }
      
      // ğŸš© [ì¶”ê°€] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ê´€ë ¨ ê¸°ëŠ¥
      const mapHistoryPanel = document.getElementById('map-history-panel');
      const mapHistoryResizer = document.getElementById('map-history-resizer');
      
      // íŒ¨ë„ì˜ ì›ë˜ ë„ˆë¹„ë¥¼ ì €ì¥í•  ë³€ìˆ˜ (ì „ì—­ìœ¼ë¡œ ì„ ì–¸í•˜ì—¬ í† ê¸€ê³¼ ë¦¬ì‚¬ì´ì €ì—ì„œ ê³µìœ )
      let savedPanelWidth = 320; // ê¸°ë³¸ê°’
      
      // ğŸš© [ìˆ˜ì •] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ì´ë²¤íŠ¸ ì²˜ë¦¬
      if (mapHistoryPanel) {
          // í´ë¦­ ì´ë²¤íŠ¸ê°€ ì§€ë„ë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë°©ì§€ (ë¦¬ì‚¬ì´ì € ì œì™¸)
          mapHistoryPanel.addEventListener('click', (e) => {
              if (e.target.id !== 'map-history-resizer') {
                  e.stopPropagation();
              }
          });
          mapHistoryPanel.addEventListener('dblclick', (e) => {
              if (e.target.id !== 'map-history-resizer') {
                  e.stopPropagation();
              }
          });
          
          // ë§ˆìš°ìŠ¤ íœ  ìŠ¤í¬ë¡¤ ì‹œ ì§€ë„ì— ì˜í–¥ ì—†ë„ë¡ ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
          mapHistoryPanel.addEventListener('wheel', (e) => {
              e.stopPropagation();
          }, { passive: true });
          
          // ğŸš© [ìˆ˜ì •] ì´ˆê¸° ìƒíƒœ ì„¤ì •: layerVisibility.historyPanel ê°’ì— ë”°ë¼ ê²°ì •
          if (layerVisibility.historyPanel) {
              mapHistoryPanel.style.display = 'block';
          } else {
              mapHistoryPanel.style.display = 'none';
          }
      }

      // ğŸš© [ì¶”ê°€] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥
      if (mapHistoryPanel && mapHistoryResizer) {
          let isResizing = false;
          let startX = 0;
          let startWidth = 0;
          
          // ë¦¬ì‚¬ì´ì €ì— ì§ì ‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          mapHistoryResizer.addEventListener('mousedown', (e) => {
              console.log('Resizer mousedown'); // ë””ë²„ê¹…ìš©
              isResizing = true;
              startX = e.clientX;
              startWidth = mapHistoryPanel.offsetWidth;
              
              // ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
              e.preventDefault();
              e.stopPropagation(); // ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
              document.body.style.cursor = 'ew-resize';
              document.body.style.userSelect = 'none';
          }, true); // capture phaseì—ì„œ ì´ë²¤íŠ¸ ì¡ê¸°
          
          document.addEventListener('mousemove', (e) => {
              if (!isResizing) return;
              
              e.preventDefault();
              
              // ì™¼ìª½ìœ¼ë¡œ ë“œë˜ê·¸í•˜ë©´ ë„ˆë¹„ ì¦ê°€, ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë“œë˜ê·¸í•˜ë©´ ë„ˆë¹„ ê°ì†Œ
              const deltaX = startX - e.clientX;
              const newWidth = Math.max(200, Math.min(800, startWidth + deltaX));
              
              // width ì§ì ‘ ì„¤ì • (CSS í´ë˜ìŠ¤ ì˜¤ë²„ë¼ì´ë“œ)
              mapHistoryPanel.style.setProperty('width', `${newWidth}px`, 'important');
          });
          
          document.addEventListener('mouseup', () => {
              if (isResizing) {
                  console.log('Resizing ended'); // ë””ë²„ê¹…ìš©
                  isResizing = false;
                  document.body.style.cursor = '';
                  document.body.style.userSelect = '';
                  
                  // ë¦¬ì‚¬ì´ì§•ì´ ëë‚¬ì„ ë•Œ í˜„ì¬ ë„ˆë¹„ë¥¼ ì €ì¥ (ê°ì¶”ê¸°/í¼ì¹˜ê¸° ì‹œ ë³µì›ìš©)
                  if (mapHistoryPanel.classList.contains('expanded')) {
                      savedPanelWidth = mapHistoryPanel.offsetWidth;
                      console.log('Saved panel width:', savedPanelWidth); // ë””ë²„ê¹…ìš©
                  }
              }
          });
      }

      // ğŸš© [ì¶”ê°€] ì™• ëª©ë¡ íŒ¨ë„ í† ê¸€ ê¸°ëŠ¥
      const mapKingPanel = document.getElementById('map-king-panel');
      const mapKingToggleBtn = document.getElementById('map-king-toggle-btn');
      const mapKingList = document.getElementById('map-king-list');
      
      if (mapKingToggleBtn && mapKingPanel && mapKingList) {
          // ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
          mapKingPanel.addEventListener('click', (e) => e.stopPropagation());
          mapKingPanel.addEventListener('dblclick', (e) => e.stopPropagation());
          mapKingPanel.addEventListener('wheel', (e) => e.stopPropagation(), { passive: true });
          
          // ì´ˆê¸° ìƒíƒœ ì„¤ì •: ëª¨ë°”ì¼ì€ ì ‘íŒ ìƒíƒœ, PCëŠ” í¼ì³ì§„ ìƒíƒœ
          const isMobile = document.body.classList.contains('force-mobile');
          let isKingPanelExpanded = !isMobile;
          
          if (!isKingPanelExpanded) {
              mapKingList.style.display = 'none';
              mapKingToggleBtn.innerHTML = 'â–¼';
              mapKingToggleBtn.title = 'íŒ¨ë„ í¼ì¹˜ê¸°';
          } else {
              mapKingList.style.display = 'block';
              mapKingToggleBtn.innerHTML = 'â–²';
              mapKingToggleBtn.title = 'íŒ¨ë„ ì ‘ê¸°';
          }
          
          mapKingToggleBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              isKingPanelExpanded = !isKingPanelExpanded;
              
              if (isKingPanelExpanded) {
                  mapKingList.style.display = 'block';
                  mapKingToggleBtn.innerHTML = 'â–²';
                  mapKingToggleBtn.title = 'íŒ¨ë„ ì ‘ê¸°';
              } else {
                  mapKingList.style.display = 'none';
                  mapKingToggleBtn.innerHTML = 'â–¼';
                  mapKingToggleBtn.title = 'íŒ¨ë„ í¼ì¹˜ê¸°';
              }
          });
      }

      // ğŸš© [ìˆ˜ì •] íŒ¨ë„ ë“œë˜ê·¸ ê³µí†µ ìœ í‹¸
      //   - mousedown ì—ì„œëŠ” styleì„ ì „í˜€ ê±´ë“œë¦¬ì§€ ì•Šê³  ì˜¤í”„ì…‹ë§Œ ê¸°ë¡
      //   - mousemove ì²« í˜¸ì¶œ ì‹œ right/bottom â†’ left/top ì „í™˜ (layout flush ì´í›„ì´ë¯€ë¡œ ì•ˆì „)
      function makePanelDraggable(panelId, headerId, { clearRight = false, clearBottom = false } = {}) {
          const panel = document.getElementById(panelId);
          const header = document.getElementById(headerId);
          if (!panel || !header) return;

          let isDragging = false;
          let needsConversion = false; // ì²« mousemove ì—ì„œë§Œ style ì „í™˜
          let offsetX, offsetY;

          header.addEventListener('mousedown', (e) => {
              if (e.target.closest('button')) return;

              // mousedown ì‹œì ì˜ íŒ¨ë„ ìœ„ì¹˜ (style ë³€ê²½ ì „ â€” 100% ì •í™•)
              const rect = panel.getBoundingClientRect();
              offsetX = e.clientX - rect.left;
              offsetY = e.clientY - rect.top;

              isDragging = true;
              needsConversion = true; // style ì „í™˜ì€ ì²« mousemove ë¡œ ë¯¸ë£¸
              header.style.cursor = 'grabbing';
              e.preventDefault();
          });

          document.addEventListener('mousemove', (e) => {
              if (!isDragging) return;

              // ì²« mousemove ì—ì„œ right/bottom â†’ left/top ìœ¼ë¡œ ì „í™˜
              if (needsConversion) {
                  needsConversion = false;
                  const rect = panel.getBoundingClientRect();
                  if (clearRight)  panel.style.right  = 'auto';
                  if (clearBottom) panel.style.bottom = 'auto';
                  // ì „í™˜ ì „ rect ë¡œ left/top ê³ ì • (ì í”„ ì—†ìŒ)
                  panel.style.left = rect.left + 'px';
                  panel.style.top  = rect.top  + 'px';
              }

              let newLeft = e.clientX - offsetX;
              let newTop  = e.clientY - offsetY;
              newLeft = Math.max(0, Math.min(window.innerWidth  - panel.offsetWidth,  newLeft));
              newTop  = Math.max(0, Math.min(window.innerHeight - panel.offsetHeight, newTop));
              panel.style.left = newLeft + 'px';
              panel.style.top  = newTop  + 'px';
          });

          document.addEventListener('mouseup', () => {
              if (isDragging) { isDragging = false; needsConversion = false; header.style.cursor = 'grab'; }
          });
      }

      // ğŸš© [ì¶”ê°€] ì™• íŒ¨ë„ ë“œë˜ê·¸ ì´ë™ (bottom ê¸°ë°˜ â†’ top ì „í™˜)
      makePanelDraggable('map-king-panel', 'map-king-panel-header', { clearBottom: true });

      // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ íŒ¨ë„ ë“œë˜ê·¸ ì´ë™ (right ê¸°ë°˜ â†’ left ì „í™˜)
      makePanelDraggable('map-history-panel', 'map-history-panel-header', { clearRight: true });

      // ğŸš© [ì¶”ê°€] ì™• íŒ¨ë„ / ì—­ì‚¬ ê¸°ë¡ íŒ¨ë„ ë‹«ê¸° ë²„íŠ¼
      (function() {
          function closePanel(panelId, layerKey, checkboxId) {
              const panel = document.getElementById(panelId);
              if (panel) panel.style.display = 'none';
              if (layerVisibility) layerVisibility[layerKey] = false;
              // PC ë©”ë‰´ ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
              const cb = document.getElementById(checkboxId);
              if (cb) cb.checked = false;
              // ëª¨ë°”ì¼ ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
              const mobileCb = document.querySelector(`.mobile-layer-checkbox[data-layer="${layerKey}"]`);
              if (mobileCb) mobileCb.checked = false;
          }

          const kingCloseBtn = document.getElementById('map-king-close-btn');
          if (kingCloseBtn) {
              kingCloseBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  closePanel('map-king-panel', 'kingPanel', 'menu-layer-king');
              });
          }

          const historyCloseBtn = document.getElementById('map-history-close-btn');
          if (historyCloseBtn) {
              historyCloseBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  closePanel('map-history-panel', 'historyPanel', 'menu-layer-history');
              });
          }
      })();


      map.on('zoomend', () => {
          const zoom = map.getZoom();
          let scale = 1.0;

          // ì¤Œ ë ˆë²¨ì— ë”°ë¼ scale ê°’ ê²°ì • (ë‹¨ì¡°ì¦ê°€ â€” ì—­ì „ ì—†ìŒ)
          if (zoom <= 4) scale = 0.5;
          else if (zoom === 5) scale = 0.7;
          else if (zoom === 6) scale = 0.9;
          else if (zoom === 7) scale = 1.0;
          else if (zoom === 8) scale = 1.1;
          else if (zoom >= 9) scale = 1.2;

          // map ì»¨í…Œì´ë„ˆì— CSS ë³€ìˆ˜(--marker-scale) ì„¤ì •
          const mapContainer = map.getContainer();
          mapContainer.style.setProperty('--marker-scale', scale);

          // ğŸš© [ì¶”ê°€] bodyì— ì¤Œ ë ˆë²¨ í´ë˜ìŠ¤ ì¶”ê°€ (ìì—°ì§€ë¬¼ ë¼ë²¨ í¬ê¸° ì¡°ì ˆìš©)
          document.body.className = document.body.className.replace(/zoom-level-\d+/g, '');
          document.body.classList.add(`zoom-level-${zoom}`);
      });

      // ì´ˆê¸° ë¡œë“œ ì‹œ ë§ˆì»¤ í¬ê¸° ì„¤ì •
      map.fire('zoomend');

      // ğŸ“–ï¸ [ì¶”ê°€] ì§€ë„ ì´ë™/ì¤Œ ì‹œ ì˜í†  ì¦ë¶„ ì—…ë°ì´íŠ¸
      let updateTerritoryTimeout;
      let renderedTerritoryKeys = new Set(); // ì´ë¯¸ ë Œë”ë§ëœ ì˜í†  ì¶”ì 
      
      map.on('moveend', () => {
          // ë””ë°”ìš´ìŠ¤: ì§€ë„ ì´ë™ì´ ëë‚œ í›„ 500ms ëŒ€ê¸°
          clearTimeout(updateTerritoryTimeout);
          updateTerritoryTimeout = setTimeout(() => {
              if (layerVisibility.territoryPolygon && territories.length > 0) {
                  updateVisibleTerritories();
              }
          }, 500);

          // ğŸ”§ [ë©”ëª¨ë¦¬ ìµœì í™”] moveend ë§ˆì»¤ ì¬ë Œë”ë§: pad(1.5) ì—¬ìœ ë¡œ ëŒ€ë¶€ë¶„ ì»¤ë²„ë˜ë¯€ë¡œ
          // ë·° ì¤‘ì‹¬ì´ ì´ì „ ë Œë”ë§ boundsë¥¼ ì‹¤ì œë¡œ ë²—ì–´ë‚œ ê²½ìš°ì—ë§Œ ì¬ë Œë”ë§
          if (currentMacroMode !== 0) {
              clearTimeout(window._moveendMarkerTimer);
              window._moveendMarkerTimer = setTimeout(() => {
                  // ë§ˆì§€ë§‰ ë Œë”ë§ ì‹œ padded boundsë¥¼ ê¸°ë¡í•´ë’€ë‹¤ê°€ ë²—ì–´ë‚  ë•Œë§Œ ì‹¤í–‰
                  const center = map.getCenter();
                  const lastBounds = window._lastMarkerRenderBounds;
                  if (lastBounds && lastBounds.contains(center)) return; // ì•„ì§ bounds ì•ˆ â†’ ìŠ¤í‚µ
                  const { year, month } = typeof getCurrentYearMonth === 'function'
                      ? getCurrentYearMonth()
                      : { year: parseInt(yearInput?.value || 400), month: 1 };
                  window._lastMarkerRenderBounds = map.getBounds().pad(1.0);
                  updateMap(year, month, false, true);
              }, 600); // ë””ë°”ìš´ìŠ¤ 300 â†’ 600ms
          }
      });
      
      // ğŸ—ºï¸ [v3.2] ë³´ì´ëŠ” ì˜ì—­ì˜ ì˜í† ë§Œ ì¦ë¶„ ì—…ë°ì´íŠ¸ (êµ­ê°€ë³„ ë³‘í•©)
      function updateVisibleTerritories() {
          const { year, month } = getCurrentYearMonth();
          const view = map.getBounds();
          const viewBox = { 
              minLat: view.getSouth(), 
              maxLat: view.getNorth(), 
              minLng: view.getWest(), 
              maxLng: view.getEast() 
          };
          
          let addedCount = 0;
          const countryFeatures = new Map(); // countryId â†’ { features: [], countryInfo, style }
          
          territories.forEach(territory => {
              const territoryKey = `${territory._id || territory.name}_${year}`;
              
              // âœ… ì´ë¯¸ ë Œë”ë§ëœ ì˜í† ëŠ” ìŠ¤í‚µ
              if (renderedTerritoryKeys.has(territoryKey)) {
                  return;
              }
              
              // ë·°í¬íŠ¸ ë°–ì˜ ì˜í† ëŠ” ìŠ¤í‚µ
              const tBounds = getTerritoryBounds(territory);
              if (tBounds && (tBounds.maxLat < viewBox.minLat || tBounds.minLat > viewBox.maxLat || 
                              tBounds.maxLng < viewBox.minLng || tBounds.minLng > viewBox.maxLng)) {
                  return;
              }
              
              // ì‹œê°„ ë²”ìœ„ ì²´í¬
              const startYear = territory.start || territory.start_year || -5000;
              const endYear = territory.end || territory.end_year || 3000;
              if (!(year >= startYear && year <= endYear)) return;
              
              // ì§€ë°° êµ­ê°€ ê²°ì • (ë°°íƒ€ì  êµ¬ì—­ ì ìœ )
              const dominantResult = calculateDominantCountry(territory, year, month);
              if (!dominantResult) return;
              
              const dominantCountryId = dominantResult.countryId;
              const countryInfo = getCountryInfoById(dominantCountryId);
              if (!countryInfo) return;
              
              // ë¯¼ì¡± í•„í„°ë§
              if (selectedEthnicity !== 'all') {
                  if (!countryInfo.ethnicity || !countryInfo.ethnicity.includes(selectedEthnicity)) {
                      return;
                  }
              }
              
              // Feature ìˆ˜ì§‘ (êµ­ê°€ë³„ ê·¸ë£¹í•‘)
              const feature = {
                  type: 'Feature',
                  geometry: {
                      type: territory.type,
                      coordinates: territory.coordinates
                  },
                  properties: {
                      name: territory.name,
                      country_id: dominantCountryId,
                      startYear: startYear,
                      endYear: endYear,
                      isExclusive: dominantResult.isExclusive,
                      countriesInZone: dominantResult.countriesInZone
                  }
              };
              
              if (!countryFeatures.has(dominantCountryId)) {
                  const computedStyle = getTerritoryStyle(territory, countryInfo, year, month);
                  countryFeatures.set(dominantCountryId, {
                      features: [],
                      countryInfo: countryInfo,
                      style: computedStyle
                  });
              }
              countryFeatures.get(dominantCountryId).features.push(feature);
              
              // êµ­ê°€ëª… ê°±ì‹ ìš©: _renderedCountryIds / _renderedCountryCentroids ë™ê¸°í™”
              _renderedCountryIds.add(dominantCountryId);
              const tBndsInc = getTerritoryBounds(territory);
              if (tBndsInc) {
                  const cLat = (tBndsInc.minLat + tBndsInc.maxLat) / 2;
                  const cLng = (tBndsInc.minLng + tBndsInc.maxLng) / 2;
                  if (_renderedCountryCentroids.has(dominantCountryId)) {
                      const c = _renderedCountryCentroids.get(dominantCountryId);
                      c.lat += cLat; c.lng += cLng; c.count++;
                  } else {
                      _renderedCountryCentroids.set(dominantCountryId, { lat: cLat, lng: cLng, count: 1 });
                  }
              }

              renderedTerritoryKeys.add(territoryKey);
              addedCount++;
          });
          
          // ğŸš© [v3.3] êµ­ê°€ë³„ ì „ìš© rendererë¡œ ë Œë”ë§ (ì¤‘ì²© fillOpacity ë°©ì§€)
          countryFeatures.forEach(({ features, countryInfo, style }, countryId) => {
              const featureCollection = {
                  type: 'FeatureCollection',
                  features: features
              };
              
              const groupOpacity = style.fillOpacity || 0.3;
              const pathStyle = Object.assign({}, style, {
                  fillOpacity: 1,
                  opacity: 1
              });
              
              const countryRenderer = L.svg({ padding: 0.5 });
              
              const countryLayer = L.geoJSON(featureCollection, {
                  style: pathStyle,
                  renderer: countryRenderer,
                  onEachFeature: (feature, layer) => {
                      const props = feature.properties;
                      const sY = props.startYear;
                      const eY = props.endYear;
                      const popupContent = `<b>${props.name || 'ì˜í† '}</b><br>ì§€ë°°êµ­: ${countryInfo.name}<br>ê¸°ê°„: ${sY}ë…„ ~ ${eY === 3000 ? 'í˜„ì¬' : eY + 'ë…„'}`;
                      layer.bindPopup(popupContent);
                  }
              });
              
              territoryLayerGroup.addLayer(countryLayer);
              
              setTimeout(() => {
                  if (countryRenderer._container) {
                      countryRenderer._container.style.opacity = groupOpacity;
                  }
              }, 0);
          });
          
          if (addedCount > 0) {
              console.log(`ğŸ—ºï¸ ì˜í†  ì¦ë¶„ ì—…ë°ì´íŠ¸: ${addedCount}ê°œ ì¶”ê°€ë¨ (${countryFeatures.size}ê°œ êµ­ê°€ ë ˆì´ì–´)`);
              // ìƒˆ ì˜í† ê°€ ì¶”ê°€ëìœ¼ë¯€ë¡œ êµ­ê°€ëª… ë¼ë²¨ ê°±ì‹ 
              renderMacroCountryNames();
          }
      }
      
      // ğŸ—ºï¸ [ì¶”ê°€] ì—°ë„ ë³€ê²½ ì‹œ ë Œë”ë§ëœ ì˜í†  ì¶”ì  ì´ˆê¸°í™”
      window.clearRenderedTerritories = function() {
          renderedTerritoryKeys.clear();
      };

      // ğŸ“–ğŸš© [ì¶”ê°€] ì†ë„ ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
      playbackSpeedSlider.oninput = () => {
          speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
          // ì¬ìƒ ì¤‘ì´ë¼ë©´ ì†ë„ë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë©ˆì·„ë‹¤ê°€ ë‹¤ì‹œ ì‹œì‘)
          if (playInterval) {
              stopPlayback();
              startPlayback();
          }
      };

      countryColors = {};
      countries.forEach(c => { countryColors[c.name] = c.color; });
      countries.sort((a, b) => { return a.name.localeCompare(b.name, 'ko'); });
      
      // ğŸš© [ì œê±°] kings ë³€í™˜ ë¡œì§ì€ ë°±ê·¸ë¼ìš´ë“œ ë¡œë”© í•¨ìˆ˜ ë‚´ë¶€ë¡œ ì´ë™ë¨

      // ğŸš© [ì œê±°ë¨] ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ê¸°ëŠ¥ í™œì„±í™” - í–„ë²„ê±° ë©”ë‰´ë¡œ ì´ë™ë¨
      // const logoutBtnHeader = document.getElementById('logoutBtnHeader');
      // logoutBtnHeader.addEventListener('click', () => {
      //     if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      //         // ğŸš© [ìˆ˜ì •] ë‘ ì €ì¥ì†Œì˜ í† í°ì„ ëª¨ë‘ ì‚­ì œ
      //         localStorage.removeItem('token');
      //         sessionStorage.removeItem('token');
      //         localStorage.removeItem('token');
      //         window.location.href = 'login.html';
      //     }
      // });

      // ğŸš© [ì‚­ì œë¨] ê³ ëŒ€ ì§€ë„ ë²„íŠ¼ ë™ì  ìƒì„± ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (íƒ‘ë°”ë¡œ ì´ë™ë¨)
      // const mapButtonContainer = document.getElementById('ancient-map-button-container');
      // ... (ì „ì²´ ì½”ë“œ ì‚­ì œë¨)

      // ğŸš© [ì¶”ê°€] íƒ‘ë°” ê³ ì§€ë„ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
      const topbarAncientMapsBtn = document.getElementById('topbar-ancient-maps-btn');
      const topbarAncientMapsDropdown = document.getElementById('topbar-ancient-maps-dropdown-menu');
      
      if (topbarAncientMapsBtn && topbarAncientMapsDropdown) {
          // íƒ‘ë°” ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼
          topbarAncientMapsBtn.onmouseover = () => {
              topbarAncientMapsBtn.style.background = 'rgba(255,255,255,0.2)';
              topbarAncientMapsBtn.style.transform = 'translateY(-1px)';
          };
          topbarAncientMapsBtn.onmouseout = () => {
              topbarAncientMapsBtn.style.background = 'rgba(255,255,255,0.1)';
              topbarAncientMapsBtn.style.transform = 'translateY(0)';
          };
          
          // íƒ‘ë°” ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìƒì„±
          topbarAncientMapsDropdown.innerHTML = '';
          ancientMaps.forEach(mapInfo => {
              const listItem = document.createElement('div');
              listItem.className = 'topbar-ancient-map-item';
              listItem.textContent = mapInfo.name;
              listItem.style.cssText = `
                  padding: 8px 12px;
                  font-size: 12px;
                  color: #ecf0f1;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  border-bottom: 1px solid rgba(255,255,255,0.1);
                  font-family: 'Noto Serif KR', serif;
                  border-radius: 4px;
                  margin: 2px 0;
              `;
              
              // ë§ˆì§€ë§‰ ì•„ì´í…œì€ í…Œë‘ë¦¬ ì œê±°
              if (ancientMaps.indexOf(mapInfo) === ancientMaps.length - 1) {
                  listItem.style.borderBottom = 'none';
              }
              
              // í˜¸ë²„ íš¨ê³¼
              listItem.onmouseover = () => {
                  listItem.style.background = 'rgba(255,255,255,0.1)';
              };
              listItem.onmouseout = () => {
                  listItem.style.background = 'transparent';
              };
              
              // í´ë¦­ ì´ë²¤íŠ¸
              listItem.addEventListener('click', () => {
                  // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                  topbarAncientMapsDropdown.style.display = 'none';
                  
                  // ì§€ë„ ì—´ê¸° ë¡œì§
                  if (mapInfo.id === 'surnameBtn') {
                      window.open(mapInfo.url, '_blank');
                  } else {
                      const newTab = window.open();
                      newTab.document.write(`
                          <!DOCTYPE html>
                          <html lang="ko"><head><meta charset="UTF-8"><title>${mapInfo.name}</title>
                          <style>
                              body { margin: 0; background-color: #111; text-align: center; }
                              img { max-width: 100%; height: auto; cursor: zoom-in; transition: max-width 0.2s ease-in-out; }
                              img.zoomed { max-width: none; cursor: zoom-out; }
                          </style></head>
                          <body><img src="${mapInfo.url}" alt="${mapInfo.name}" onclick="this.classList.toggle('zoomed')"></body>
                          </html>
                      `);
                      newTab.document.close();
                  }
              });
              
              topbarAncientMapsDropdown.appendChild(listItem);
          });
          
          // íƒ‘ë°” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
          topbarAncientMapsBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const isVisible = topbarAncientMapsDropdown.style.display === 'block';
              topbarAncientMapsDropdown.style.display = isVisible ? 'none' : 'block';
          });
          
          // ì™¸ë¶€ í´ë¦­ ì‹œ íƒ‘ë°” ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          document.addEventListener('click', (e) => {
              if (!topbarAncientMapsBtn.contains(e.target) && !topbarAncientMapsDropdown.contains(e.target)) {
                  topbarAncientMapsDropdown.style.display = 'none';
              }
          });
      }
      
      // ğŸš© [ì‚­ì œë¨] ì§€ë„ ë²„íŠ¼ ì»¨í…Œì´ë„ˆì— í´ë¦­ ì „íŒŒ ë°©ì§€ ì ìš© (ì»¨í…Œì´ë„ˆ ì‚­ì œë¨)
      // L.DomEvent.disableClickPropagation(mapButtonContainer);
      // L.DomEvent.disableScrollPropagation(mapButtonContainer);

    // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± í¸ì§‘ ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” (í•œ ë²ˆë§Œ ë“±ë¡)
    let citySearchForEditInitialized = false;
    function initCitySearchForEdit() {
        if (citySearchForEditInitialized) return;
        const citySearchInputForEdit = document.getElementById('citySearchInputForEdit');
        const citySearchResults = document.getElementById('citySearchResults');
        const citySelectForEdit = document.getElementById('citySelectForEdit');
        if (!citySearchInputForEdit || !citySearchResults || !citySelectForEdit) return;
        
        citySearchForEditInitialized = true;
        citySearchInputForEdit.addEventListener('input', () => {
            const searchTerm = citySearchInputForEdit.value.toLowerCase();
            citySearchResults.innerHTML = '';
            if (searchTerm.length === 0) {
                citySearchResults.style.display = 'none';
                const select = document.getElementById('citySelectForEdit');
                for (let i = 0; i < select.options.length; i++) {
                    select.options[i].hidden = false;
                }
                return;
            }

            const select = document.getElementById('citySelectForEdit');
            for (let i = 0; i < select.options.length; i++) {
                const option = select.options[i];
                if (option.value === "") { option.hidden = false; continue; }
                option.hidden = !option.textContent.toLowerCase().includes(searchTerm);
            }

            const filteredCastles = castles.filter(c => 
                !c.is_military_flag && 
                !c.is_natural_feature && 
                c.name.toLowerCase().includes(searchTerm)
            );

            filteredCastles.forEach(castle => {
                const div = document.createElement('div');
                const typeLabel = castle.is_label ? 'ì§€ëª…' : 'ì„±/ë„ì‹œ';
                const countryName = getCountryInfoById(castle.country_id)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                div.textContent = `${castle.name} [${typeLabel}] (${countryName})`;
                div.style.padding = '8px';
                div.style.cursor = 'pointer';
                div.onmouseover = () => div.style.backgroundColor = '#5d7185';
                div.onmouseout = () => div.style.backgroundColor = '';
                div.onclick = () => {
                    citySearchInputForEdit.value = '';
                    citySelectForEdit.value = castle._id;
                    citySearchResults.style.display = 'none';
                };
                citySearchResults.appendChild(div);
            });

            citySearchResults.style.display = filteredCastles.length > 0 ? 'block' : 'none';
        });
    }

      updateCountrySelect();
      populateKingCountrySelect(); // ğŸš© [ìˆ˜ì •] í•¨ìˆ˜ ì´ë¦„ ë³€ê²½ì— ë”°ë¥¸ í˜¸ì¶œ ìˆ˜ì •
      populateCitySelectForEdit(); // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
      createSliderTicks();
      const initialTotalMonths = parseInt(combinedSlider.value);
      const { year: initialYear, month: initialMonth } = totalMonthsToYearMonth(initialTotalMonths);
      updateTime(initialYear, initialMonth); // updateTimeìœ¼ë¡œ ì´ˆê¸°í™”
      
      console.log(`âœ… UI ì´ˆê¸°í™” ì™„ë£Œ!`);

      // ğŸš© [ìˆ˜ì •] ë„ì‹œ/ì„±/ì§€ëª… ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateCitySelectForEdit() {
        const select = document.getElementById('citySelectForEdit');
        if (!select) return;
        select.innerHTML = '<option value="">-- ë„ì‹œ/ì„±/ì§€ëª… ì„ íƒ --</option>'; // ì´ˆê¸°í™”
        // ğŸš© [ìˆ˜ì •] êµ°ëŒ€ì™€ ìì—° íƒ€ì…ë§Œ ì œì™¸í•˜ê³ , ì§€ëª…ë„ í¬í•¨
        const filteredCastles = castles.filter(c => !c.is_military_flag && !c.is_natural_feature)
                                       .sort((a, b) => a.name.localeCompare(b.name, 'ko'));
        filteredCastles.forEach(castle => {
            const typeLabel = castle.is_label ? 'ì§€ëª…' : 'ì„±/ë„ì‹œ';
            const countryName = getCountryInfoById(castle.country_id)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
            select.innerHTML += `<option value="${castle._id}">${castle.name} [${typeLabel}] (${countryName})</option>`;
        });
        // ğŸš© [ìˆ˜ì •] ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì•„ì§ ì—†ìœ¼ë©´ ë“±ë¡
        initCitySearchForEdit();
    }

    // ì—°ëŒ€í‘œ ë°ì´í„° ë²”ìœ„ (createDynastyTimelineì´ ê³„ì‚° í›„ ì €ì¥, updateTimelineScrollì—ì„œ ì‚¬ìš©)
    var timelineDataMin = null;
    var timelineDataMax = null;

        // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” ëˆˆê¸ˆì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    function createSliderTicks() {
        // â”€â”€ 1. ìŠ¬ë¼ì´ë” ìœ„ ë…ë¦½ ëˆˆê¸ˆ ë°” (í•­ìƒ í‘œì‹œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const ticksBar = document.getElementById('slider-ticks-bar');
        if (ticksBar) {
            ticksBar.innerHTML = '';
            const sliderMin = parseInt(combinedSlider.min);   // -60000
            const sliderMax = parseInt(combinedSlider.max);   //  24359
            const totalRange = sliderMax - sliderMin;

            // ì „ì²´ ì—°ë„ ë²”ìœ„ë¥¼ ì»¤ë²„í•˜ëŠ” ëˆˆê¸ˆ ê°„ê²© ê²°ì •
            // major: 500ë…„, minor: 100ë…„
            const MAJOR = 500, MINOR = 100;

            // ëˆˆê¸ˆì„ ì°ì„ ì—°ë„ ëª©ë¡ (major ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘, minor í¬í•¨)
            const startYear = Math.ceil(-5000 / MINOR) * MINOR;
            const endYear   = Math.floor(2500  / MINOR) * MINOR;

            for (let y = startYear; y <= endYear; y += MINOR) {
                const tm = yearMonthToTotalMonths(y, 1);
                if (tm < sliderMin || tm > sliderMax) continue;
                const pct = ((tm - sliderMin) / totalRange) * 100;
                const isMajor = (y % MAJOR === 0);

                const tick = document.createElement('div');
                tick.className = 'slider-tick';
                tick.style.left = pct + '%';

                if (isMajor) {
                    const lbl = document.createElement('div');
                    lbl.className = 'slider-tick-label major';
                    lbl.textContent = y < 0 ? `${Math.abs(y)}BC` : `${y}`;
                    tick.appendChild(lbl);
                }

                const line = document.createElement('div');
                line.className = 'slider-tick-line' + (isMajor ? ' major' : '');
                line.style.height = isMajor ? '10px' : '6px';

                tick.appendChild(line);
                ticksBar.appendChild(tick);
            }

            // â”€â”€ ì‹œëŒ€ ë§ˆì»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // í•œêµ­ì‚¬ â†’ slider-korea-bar (ìŠ¬ë¼ì´ë” ë°”ë¡œ ìœ„)
            // ì¤‘êµ­ì‚¬ â†’ slider-ticks-bar (ìŠ¬ë¼ì´ë” ì•„ë˜ ëˆˆê¸ˆë°”)
            const koreaBar = document.getElementById('slider-korea-bar');
            if (koreaBar) koreaBar.innerHTML = '';

            const koreaMarkers = [
                { year: -3898, label: 'ë°°ë‹¬êµ­'   },  // í™˜ì›… ì²œí™© â€” ì‹ ì‹œ(ç¥å¸‚) ê°œì²œ
                { year: -2333, label: 'ê³ ì¡°ì„ '   },  // ë‹¨êµ° ì¡°ì„  ê±´êµ­
                { year: -1400, label: 'ì„œêµ­(å¾)'  },  // ë™ì´ì¡± ì„œêµ­ â€” íšŒìˆ˜ ìœ ì—­
                { year:  -200, label: 'ë¶€ ì—¬'    },  // ë¶€ì—¬ ê±´êµ­ â€” ë§Œì£¼ ì˜ˆë§¥ê³„ ì™•êµ­
                { year:   -57, label: 'ì‚¼êµ­ì‹œëŒ€'  },
                { year:   676, label: 'í†µì¼ì‹ ë¼'  },
                { year:   918, label: 'ê³  ë ¤'    },
                { year:  1392, label: 'ì¡° ì„ '    },
                { year:  1945, label: 'ëŒ€í•œë¯¼êµ­'  },
            ];

            const chinaMarkers = [
                { year: -2070, label: 'ê³ ëŒ€ ì™•ì¡°'  },  // í•˜Â·ìƒÂ·ì£¼
                { year:  -770, label: 'ì¶˜ì¶”ì „êµ­'   },  // ì£¼(å‘¨) ë™ì²œ
                { year:  -221, label: 'ì§„Â·í•œ'      },  // ì§„(ç§¦) í†µì¼
                { year:   220, label: 'ìœ„ì§„ë‚¨ë¶ì¡°'  },  // í›„í•œ ë©¸ë§
                { year:   581, label: 'ìˆ˜Â·ë‹¹'      },  // ìˆ˜(éš‹) ì¬í†µì¼
                { year:   907, label: 'ì˜¤ëŒ€ì‹­êµ­'   },  // ë‹¹(å”) ë©¸ë§
                { year:   960, label: 'ì†¡Â·ì›'      },  // ì†¡(å®‹) ê±´êµ­
                { year:  1368, label: 'ëª…Â·ì²­'      },  // ëª…(æ˜) ê±´êµ­
                { year:  1912, label: 'í˜„ëŒ€ ì¤‘êµ­'  },  // ì²­(æ·¸) ë©¸ë§
            ];

            const makeMarker = (y, label, type, parentEl) => {
                const tm = yearMonthToTotalMonths(y, 1);
                if (tm < sliderMin || tm > sliderMax) return;
                const pct = ((tm - sliderMin) / totalRange) * 100;

                const marker = document.createElement('div');
                marker.className = 'era-marker ' + type;
                marker.style.left = pct + '%';
                marker.title = `${label} (${y < 0 ? 'ê¸°ì›ì „ ' + Math.abs(y) : y}ë…„) â€” í´ë¦­í•˜ì—¬ ì´ë™`;
                marker.style.pointerEvents = 'auto';

                const lbl = document.createElement('div');
                lbl.className = 'era-marker-label';
                lbl.textContent = label;
                marker.appendChild(lbl);

                const line = document.createElement('div');
                line.className = 'era-marker-line';
                marker.appendChild(line);

                marker.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tm2 = yearMonthToTotalMonths(y, 1);
                    combinedSlider.value = tm2;
                    const { year: yr, month: mo } = totalMonthsToYearMonth(tm2);
                    updateUI(yr, mo);
                    updateSliderTooltip(yr, mo);
                    updateMap(yr, mo, false, true);
                });

                parentEl.appendChild(marker);
            };

            // í•œêµ­ì‚¬ ë§ˆì»¤ â†’ koreaBar
            if (koreaBar) {
                koreaMarkers.forEach(({ year: y, label }) => makeMarker(y, label, 'korea', koreaBar));
            }
            // ì¤‘êµ­ì‚¬ ë§ˆì»¤ â†’ ticksBar (ëˆˆê¸ˆ ì•„ë˜ì— í•¨ê»˜)
            chinaMarkers.forEach(({ year: y, label }) => makeMarker(y, label, 'china', ticksBar));
        }

        // â”€â”€ 2. timeline-content ì•ˆ ëˆˆê¸ˆ (ì—°ëŒ€í‘œ í™œì„±í™” ì‹œì—ë§Œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const timelineContent = document.getElementById('timeline-content');
        const existingTicks = timelineContent ? timelineContent.querySelector('.slider-ticks-container') : null;
        if (existingTicks) existingTicks.remove();

        if (!layerVisibility.timeline || !timelineContent) {
            return;
        }

        const ticksContainer = document.createElement('div');
        ticksContainer.className = 'slider-ticks-container';
        ticksContainer.style.cssText = "width: 100%; height: 30px; display: flex; font-size: 11px; font-family: 'Nanum Myeongjo', serif; color: #f5e9d2; position: absolute; top: -32px; left: 0; z-index: 1000; pointer-events: none;";

        const sliderMin = parseInt(combinedSlider.min);
        const displayMin = (timelineDataMin !== null) ? timelineDataMin : sliderMin;
        const displayMax = (timelineDataMax !== null) ? timelineDataMax : parseInt(combinedSlider.max);
        const totalSliderMonths = displayMax - displayMin;

        for (let year = -5000; year <= 2500; year += 500) {
            const tickMonths = yearMonthToTotalMonths(year, 1);
            if (tickMonths < displayMin || tickMonths > displayMax) continue;
            const positionPercent = ((tickMonths - displayMin) / totalSliderMonths) * 100;

            const tick = document.createElement('div');
            tick.style.cssText = `position: absolute; left: ${positionPercent}%; transform: translateX(-50%); text-align: center;`;
            tick.innerHTML = `<span style="border-left: 2px solid #f5e9d2; padding-left: 4px; height: 28px; display: inline-block; line-height: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,1); font-weight: bold;">${year}</span>`;
            ticksContainer.appendChild(tick);
        }

        timelineContent.appendChild(ticksContainer);
    }
    
    // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„°ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ (ì´ˆê¸°í™” ì‹œ í•œ ë²ˆë§Œ í˜¸ì¶œ)
    function createEthnicityFilters() {
        // ğŸš© [ìˆ˜ì •] ì´ë¯¸ í•„í„°ê°€ ì¡´ì¬í•˜ë©´ ë‹¤ì‹œ ìƒì„±í•˜ì§€ ì•ŠìŒ
        if (document.getElementById('mapEthnicityFilterSelect')) {
            return;
        }
        
        const ethnicityFilterContainer = document.getElementById('ethnicityFilterContainer');
        const mapEthnicityContainer = document.getElementById('mapEthnicityContainer');
        // ğŸš© [ìˆ˜ì •] ëª¨ë“  êµ­ê°€ì˜ ë¯¼ì¡±ì„ í¬í•¨ (ì£¼ìš” ì™•ì¡° í¬í•¨)
        const ethnicities = [...new Set(countries.filter(c => c.ethnicity).map(c => c.ethnicity))].sort();
        
        // ğŸš© [ìˆ˜ì •] ìƒë‹¨ ë¯¼ì¡± í•„í„° (controls-wrapperê°€ ì œê±°ë˜ì–´ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        if (ethnicityFilterContainer) {
            let selectElement = document.createElement('select');
            selectElement.id = 'ethnicityFilterSelect';
            selectElement.style.cssText = 'padding: 5px 4px; border-radius: 4px; border: 1px solid #5d7185; font-size: 13px; width: 120px; height: 100%; box-sizing: border-box;';
            selectElement.innerHTML = '<option value="all">-- ëª¨ë“  ë¯¼ì¡± --</option>';
            ethnicities.forEach(ethnicity => {
                selectElement.innerHTML += `<option value="${ethnicity}">${ethnicity}</option>`;
            });
            ethnicityFilterContainer.innerHTML = '';
            ethnicityFilterContainer.appendChild(selectElement);
            selectElement.addEventListener('change', () => {
                // ì§€ë„ ë¯¼ì¡± í•„í„°ë„ ë™ê¸°í™”
                const mapEthnicitySelect = document.getElementById('mapEthnicityFilterSelect');
                if (mapEthnicitySelect) {
                    mapEthnicitySelect.value = selectElement.value;
                    // ğŸš© [ì¶”ê°€] ì§€ë„ í•„í„° ìŠ¤íƒ€ì¼ë„ ë™ê¸°í™”
                    if (selectElement.value && selectElement.value !== 'all') {
                        mapEthnicitySelect.classList.add('filter-active');
                    } else {
                        mapEthnicitySelect.classList.remove('filter-active');
                    }
                }
                // ğŸš© [ì¶”ê°€] ì„ íƒëœ ë¯¼ì¡± ê°’ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                selectedEthnicity = selectElement.value;
                // ğŸš© [ì¶”ê°€] í•„í„° í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš©
                if (selectedEthnicity && selectedEthnicity !== 'all') {
                    selectElement.classList.add('filter-active');
                } else {
                    selectElement.classList.remove('filter-active');
                }
                
                // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„° ì„ íƒ ì‹œ í•´ë‹¹ ë¯¼ì¡±ì˜ ì²« ë²ˆì§¸ êµ­ê°€ë¡œ ì—°ë„ ì í”„
                if (selectedEthnicity && selectedEthnicity !== 'all') {
                    const filteredCountries = countries.filter(c => c.ethnicity === selectedEthnicity && c.start !== null).sort((a, b) => a.start - b.start);
                    if (filteredCountries.length > 0) {
                        const firstCountry = filteredCountries[0];
                        updateTime(firstCountry.start, firstCountry.start_month || 1);
                    }
                }
                
                // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ê°±ì‹ 
                createDynastyTimeline();
                // ğŸš© [ì¶”ê°€] ì§€ë„ ê°±ì‹  (ì„±/ë„ì‹œ í•„í„°ë§)
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
            });
        }
        
        // ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ë¶€ ë¯¼ì¡± í•„í„° ìƒì„±
        if (mapEthnicityContainer) {
            let mapEthnicitySelect = document.createElement('select');
            mapEthnicitySelect.id = 'mapEthnicityFilterSelect';
            mapEthnicitySelect.style.cssText = 'padding: 4px 6px; border-radius: 4px; border: 1px solid #5d7185; font-size: 11px; min-width: 110px;';
            mapEthnicitySelect.innerHTML = '<option value="all">-- ëª¨ë“  ë¯¼ì¡± --</option>';
            ethnicities.forEach(ethnicity => {
                mapEthnicitySelect.innerHTML += `<option value="${ethnicity}">${ethnicity}</option>`;
            });
            mapEthnicityContainer.innerHTML = '';
            mapEthnicityContainer.appendChild(mapEthnicitySelect);
            mapEthnicitySelect.addEventListener('change', () => {
                // ìƒë‹¨ ë¯¼ì¡± í•„í„°ë„ ë™ê¸°í™” (ì¡´ì¬í•˜ëŠ” ê²½ìš°ë§Œ)
                const ethnicityFilterSelect = document.getElementById('ethnicityFilterSelect');
                if (ethnicityFilterSelect) {
                    ethnicityFilterSelect.value = mapEthnicitySelect.value;
                    // ğŸš© [ì¶”ê°€] ìƒë‹¨ í•„í„° ìŠ¤íƒ€ì¼ë„ ë™ê¸°í™”
                    if (mapEthnicitySelect.value && mapEthnicitySelect.value !== 'all') {
                        ethnicityFilterSelect.classList.add('filter-active');
                    } else {
                        ethnicityFilterSelect.classList.remove('filter-active');
                    }
                }
                // ğŸš© [ì¶”ê°€] ì„ íƒëœ ë¯¼ì¡± ê°’ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                selectedEthnicity = mapEthnicitySelect.value;
                // ğŸš© [ì¶”ê°€] í•„í„° í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš©
                if (selectedEthnicity && selectedEthnicity !== 'all') {
                    mapEthnicitySelect.classList.add('filter-active');
                } else {
                    mapEthnicitySelect.classList.remove('filter-active');
                }
                
                // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„° ì„ íƒ ì‹œ í•´ë‹¹ ë¯¼ì¡±ì˜ ì²« ë²ˆì§¸ êµ­ê°€ë¡œ ì—°ë„ ì í”„
                if (selectedEthnicity && selectedEthnicity !== 'all') {
                    const filteredCountries = countries.filter(c => c.ethnicity === selectedEthnicity && c.start !== null).sort((a, b) => a.start - b.start);
                    if (filteredCountries.length > 0) {
                        const firstCountry = filteredCountries[0];
                        updateTime(firstCountry.start, firstCountry.start_month || 1);
                    }
                }
                
                // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ê°±ì‹ 
                createDynastyTimeline();
                // ğŸš© [ì¶”ê°€] ì§€ë„ ê°±ì‹  (ì„±/ë„ì‹œ í•„í„°ë§)
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
            });
        }
    }
    // ğŸš© [ìˆ˜ì •] ì£¼ìš” êµ­ê°€ì™€ ë‚˜ë¨¸ì§€ êµ­ê°€ë¥¼ ë¶„ë¦¬í•˜ì—¬ ë Œë”ë§í•˜ë„ë¡ ë¡œì§ ìˆ˜ì •
    function createDynastyTimeline() {
        const timelineContainer = document.getElementById('timeline-container');
        const timelineContent = document.getElementById('timeline-content');
        const timelineSidebarEl = document.getElementById('timeline-sidebar');
        
        if (!timelineContainer || !timelineContent || countries.length === 0) {
            return;
        }
    
        // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ê°€ì‹œì„± ìƒíƒœì— ë”°ë¼ timeline-sidebarë§Œ í‘œì‹œ/ìˆ¨ê¹€ (ìŠ¬ë¼ì´ë”ëŠ” í•­ìƒ í‘œì‹œ)
        if (!layerVisibility.timeline) {
            if (timelineSidebarEl) {
                timelineSidebarEl.style.display = 'none';
                timelineSidebarEl.style.opacity = '0';
                timelineSidebarEl.style.pointerEvents = 'none';
            }
            return;
        }
        
        if (timelineSidebarEl) {
            timelineSidebarEl.style.display = 'block';
            timelineSidebarEl.style.opacity = '1';
            timelineSidebarEl.style.pointerEvents = 'auto';
        }
        timelineContainer.style.display = 'block';
        timelineContent.innerHTML = ''; // ì»¨í…ì¸  ì´ˆê¸°í™”
        
        // ğŸš© [ìˆ˜ì •] ìœ íš¨í•œ êµ­ê°€ í•„í„°ë§ (startê°€ ìˆëŠ” êµ­ê°€)
        let validCountries = countries.filter(c => c.start !== null);
        
        // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„° ì ìš© (ë¶€ë¶„ ì¼ì¹˜)
        if (selectedEthnicity && selectedEthnicity !== 'all') {
            validCountries = validCountries.filter(c => c.ethnicity && c.ethnicity.includes(selectedEthnicity));
        }
        
        if (validCountries.length === 0) {
            // í•„í„° ê²°ê³¼ê°€ ì—†ì„ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
            timelineContent.innerHTML = '<div style="padding: 10px; color: #aaa; text-align: center;">ì„ íƒí•œ í•„í„°ì— í•´ë‹¹í•˜ëŠ” êµ­ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
    
        // ìŠ¬ë¼ì´ë”ì˜ min/max ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ê¸°ê°„ ê³„ì‚°
        const sliderMin = parseInt(combinedSlider.min);
        const sliderMax = parseInt(combinedSlider.max);

        // ğŸš© ì‹¤ì œ ë°ì´í„° ë²”ìœ„ ê³„ì‚° (ë°ì´í„°ê°€ ìˆëŠ” ë¶€ë¶„ + ìŠ¬ë¼ì´ë” ì „ì²´ ë²”ìœ„ ì‚¬ìš©)
        // ìŠ¬ë¼ì´ë” ì „ì²´ ë²”ìœ„ë¥¼ í‘œì‹œ ë²”ìœ„ë¡œ ì‚¬ìš©í•˜ì—¬ -5000ë…„ë¶€í„° í•­ìƒ í‘œì‹œ
        const dataMin = sliderMin;
        const dataMax = sliderMax;
        const totalDisplayMonths = dataMax - dataMin;

        // ëª¨ë“ˆ ë³€ìˆ˜ì— ì €ì¥ (updateTimelineScroll, createSliderTicksì—ì„œ ì‚¬ìš©)
        timelineDataMin = dataMin;
        timelineDataMax = dataMax;

        // ğŸš© [ìˆ˜ì •] í•„í„°ë§ëœ êµ­ê°€ë¥¼ í‘œì‹œ
        let allCountries = validCountries;
    
        const processCountries = (countriesToProcess) => {
            let maxLaneIndex = 0;

            // ë¯¼ì¡± ìš°ì„ ìˆœìœ„: ë™ì´ì¡± ìµœìƒë‹¨, í•œêµ­ ê´€ë ¨ ë¯¼ì¡± ìƒë‹¨
            const koreanEthnicities = ['ë™ì´', 'ë™ì´ì¡±', 'ê³ ì¡°ì„ ', 'ë¶€ì—¬', 'ê³ êµ¬ë ¤', 'ë°±ì œ', 'ì‹ ë¼', 'ê°€ì•¼', 'ë°œí•´', 'ê³ ë ¤', 'ì¡°ì„ ', 'í•œêµ­'];

            // ë¯¼ì¡±ë³„ë¡œ ê·¸ë£¹í™”
            const ethnicityMap = new Map();
            countriesToProcess.forEach(c => {
                const eth = c.ethnicity || 'ê¸°íƒ€';
                if (!ethnicityMap.has(eth)) ethnicityMap.set(eth, []);
                ethnicityMap.get(eth).push(c);
            });

            // ë¯¼ì¡± ì´ë¦„ ì •ë ¬: ìš°ì„ ìˆœìœ„ ë¯¼ì¡± ë¨¼ì €, ë‚˜ë¨¸ì§€ëŠ” ê°€ë‚˜ë‹¤ìˆœ
            const sortedEthnicities = Array.from(ethnicityMap.keys()).sort((a, b) => {
                const ai = koreanEthnicities.indexOf(a);
                const bi = koreanEthnicities.indexOf(b);
                if (ai !== -1 && bi !== -1) return ai - bi;
                if (ai !== -1) return -1;
                if (bi !== -1) return 1;
                return a.localeCompare(b, 'ko');
            });

            let currentRow = 0;

            sortedEthnicities.forEach(ethnicity => {
                const groupCountries = ethnicityMap.get(ethnicity).slice().sort((a, b) => a.start - b.start);
                const groupStartRow = currentRow;
                const lanes = [];

                // ë¯¼ì¡± ë¼ë²¨ ì‚½ì…
                const label = document.createElement('div');
                label.style.cssText = `position: absolute; left: 0; top: ${currentRow * 14}px; font-size: 11px; font-family: 'Nanum Myeongjo', serif; color: rgba(255,220,150,0.95); white-space: nowrap; pointer-events: none; font-weight: bold; z-index: 2; background: rgba(0,0,0,0.55); padding: 1px 5px; border-radius: 2px; line-height: 13px;`;
                label.textContent = ethnicity;
                timelineContent.appendChild(label);

                groupCountries.forEach(country => {
                    const startMonths = yearMonthToTotalMonths(country.start, country.start_month || 1);
                    const endYear = country.end === null || isNaN(country.end) ? totalMonthsToYearMonth(sliderMax).year : country.end;
                    const endMonths = yearMonthToTotalMonths(endYear, country.end_month || 12);

                    if (isNaN(startMonths) || isNaN(endMonths)) {
                        console.warn('âš ï¸ êµ­ê°€ ë Œë”ë§ ì‹¤íŒ¨ (NaN):', country.name);
                        return;
                    }

                    const leftPercent = ((startMonths - dataMin) / totalDisplayMonths) * 100;
                    const widthPercent = ((endMonths - startMonths) / totalDisplayMonths) * 100;

                    // í‘œì‹œ ë²”ìœ„ ë°–ì´ë©´ ê±´ë„ˆëœ€
                    if (leftPercent + widthPercent < 0 || leftPercent > 100) return;

                    // ì™¼ìª½ ê²½ê³„ì—ì„œ ì˜ë¦° ê²½ìš° left/width ì¡°ì •
                    const clampedLeft = Math.max(0, leftPercent);
                    const clampedWidth = Math.max(0.1, widthPercent - (clampedLeft - leftPercent));

                    let laneIndex = lanes.findIndex(laneEndTime => laneEndTime <= startMonths);
                    if (laneIndex === -1) laneIndex = lanes.length;
                    lanes[laneIndex] = endMonths;

                    const finalLaneIndex = groupStartRow + laneIndex;

                    const bar = document.createElement('div');
                    bar.className = 'timeline-bar';
                    bar.classList.add(country.is_main_dynasty ? 'main-dynasty' : 'minor-dynasty');
                    bar.style.left = `${clampedLeft}%`;
                    bar.style.width = `${clampedWidth}%`;
                    bar.style.top = `${finalLaneIndex * 14}px`;
                    bar.style.backgroundColor = country.color || '#7f8c8d';

                    bar.textContent = country.name;
                    const endYearText = country.end ? `${country.end}ë…„` : 'í˜„ì¬';
                    bar.title = `${country.name}${country.ethnicity ? ` (${country.ethnicity})` : ''} (${country.start}ë…„ ~ ${endYearText})`;

                    bar.dataset.startYear = country.start;
                    bar.dataset.startMonth = country.start_month || 1;
                    bar.dataset.countryId = country._id;

                    timelineContent.appendChild(bar);
                    maxLaneIndex = Math.max(maxLaneIndex, finalLaneIndex);
                });

                currentRow = groupStartRow + Math.max(lanes.length, 1) + 1; // +1 gap between groups
            });

            return Math.max(maxLaneIndex + 1, 1);
        };        
        // ëª¨ë“  êµ­ê°€ë¥¼ í•¨ê»˜ ì²˜ë¦¬í•˜ì—¬ ê²¹ì¹˜ì§€ ì•Šê²Œ ë°°ì¹˜
        const finalLaneCount = processCountries(allCountries);
    
        // ì»¨í…Œì´ë„ˆ ë†’ì´ ìë™ ì¡°ì ˆ (ë ˆì¸ ê°„ê²© ë„“ê²Œ, ìµœëŒ€ ë†’ì´ ì œí•œ)
        const calculatedHeight = finalLaneCount * 14 + 30; // lane ë†’ì´ + ì—¬ìœ  ê³µê°„
        const minHeight = Math.max(calculatedHeight, 80); // ìµœì†Œ 80px
        const maxHeight = Math.round(window.innerHeight * 0.65); // ìµœëŒ€ í™”ë©´ 65%
        const finalHeight = Math.min(minHeight, maxHeight);
        
        timelineContent.style.height = `${calculatedHeight}px`; // ì‹¤ì œ ì½˜í…ì¸  ë†’ì´
        timelineContainer.style.height = `${finalHeight}px`; // ì»¨í…Œì´ë„ˆëŠ” ìµœëŒ€ ë†’ì´ ì œí•œ
        timelineContainer.style.minHeight = '80px'; // ìµœì†Œ ë†’ì´ ë³´ì¥
        
        // ğŸš© [ì¶”ê°€] ì—°ë„ tick ìƒì„±
        createSliderTicks();        // ğŸš© [ì¶”ê°€] í˜„ì¬ ì‹œì ì„ ì¤‘ì•™ì— ë°°ì¹˜í•˜ëŠ” í•¨ìˆ˜ (ì•½ê°„ ì§€ì—°ì‹œì¼œ DOM ì—…ë°ì´íŠ¸ í›„ ì‹¤í–‰)
        setTimeout(() => {
            updateTimelineScroll(true); // ì´ˆê¸° ë¡œë“œì‹œ transition ì—†ì´ ì¦‰ì‹œ ì´ë™
            // createHistoricalEventMarkers(); // ğŸš© [ì œê±°] ì—­ì‚¬ì  ì‚¬ê±´ ë§ˆì»¤ ìƒì„± - ì œê±°ë¨
        }, 100);
    }
    
    // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ìŠ¤í¬ë¡¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateTimelineScroll(skipTransition = false) {
        const timelineContainer = document.getElementById('timeline-container');
        const timelineContent = document.getElementById('timeline-content');
        const timelineSidebar = document.getElementById('timeline-sidebar');
        const timelineSidebarContent = timelineSidebar?.querySelector('#timeline-content');
        
        if (!timelineContainer || !timelineContent) return;
        
        const sliderMin = parseInt(combinedSlider.min);
        const sliderMax = parseInt(combinedSlider.max);
        // ì—°ëŒ€í‘œê°€ ë°ì´í„° ë²”ìœ„ë¡œ ë Œë”ë§ëœ ê²½ìš° í•´ë‹¹ ë²”ìœ„ ì‚¬ìš©
        const displayMin = (timelineDataMin !== null) ? timelineDataMin : sliderMin;
        const displayMax = (timelineDataMax !== null) ? timelineDataMax : sliderMax;
        const totalDisplayMonths = displayMax - displayMin;
        const currentValue = parseInt(combinedSlider.value);
        
        // í˜„ì¬ ì‹œì ì˜ í¼ì„¼íŠ¸ ê³„ì‚°
        const currentPercent = ((currentValue - displayMin) / totalDisplayMonths);
        
        // timeline-containerì˜ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ offset ê³„ì‚°
        const containerWidth = timelineContainer.offsetWidth;
        const contentWidth = timelineContent.offsetWidth;
        const offset = (containerWidth / 2) - (contentWidth * currentPercent);
        
        // timeline-sidebarì˜ offset ê³„ì‚° (sidebarì˜ ì‹¤ì œ í‘œì‹œ ë„ˆë¹„ ì‚¬ìš©)
        let sidebarOffset = offset;
        if (timelineSidebarContent && timelineSidebar) {
            const sidebarWidth = timelineSidebar.offsetWidth - 30; // padding ê³ ë ¤
            sidebarOffset = (sidebarWidth / 2) - (contentWidth * currentPercent);
        }
        
        // transition ì œì–´ - ë” ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜
        if (skipTransition) {
            timelineContent.style.transition = 'none';
            if (timelineSidebarContent) timelineSidebarContent.style.transition = 'none';
        } else {
            timelineContent.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            if (timelineSidebarContent) timelineSidebarContent.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        }
        
        // transformìœ¼ë¡œ ì´ë™
        timelineContent.style.transform = `translateX(${offset}px)`;
        if (timelineSidebarContent) {
            timelineSidebarContent.style.transform = `translateX(${sidebarOffset}px)`;
        }
        
        // skipTransitionì´ì—ˆë‹¤ë©´ ë‹¤ìŒ í”„ë ˆì„ì— transition ë³µì›
        if (skipTransition) {
            requestAnimationFrame(() => {
                timelineContent.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                if (timelineSidebarContent) timelineSidebarContent.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            });
        }
    }
    
    // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë“œë˜ê·¸ ê¸°ëŠ¥ êµ¬í˜„
    function initTimelineDrag() {
        const timelineContainer = document.getElementById('timeline-container');
        const timelineContent = document.getElementById('timeline-content');
        if (!timelineContainer || !timelineContent) return;
        
        let isDragging = false;
        let hasDragged = false; // ğŸš© [ì¶”ê°€] ì‹¤ì œë¡œ ë“œë˜ê·¸ê°€ ë°œìƒí–ˆëŠ”ì§€ ì¶”ì 
        let startX = 0;
        let startSliderValue = 0;
        
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        timelineContainer.addEventListener('mousedown', (e) => {
            isDragging = true;
            hasDragged = false; // ğŸš© [ì¶”ê°€] ì´ˆê¸°í™”
            startX = e.clientX;
            startSliderValue = parseInt(combinedSlider.value);
            timelineContainer.style.cursor = 'grabbing';
            timelineContent.style.transition = 'none'; // ë“œë˜ê·¸ ì¤‘ì—ëŠ” transition ì œê±°
            e.preventDefault();
            e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            e.preventDefault();
            e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            
            const deltaX = e.clientX - startX;
            
            // ğŸš© [ì¶”ê°€] 5px ì´ìƒ ì´ë™í•˜ë©´ ë“œë˜ê·¸ë¡œ ê°„ì£¼
            if (Math.abs(deltaX) > 5) {
                hasDragged = true;
            }
            
            const containerWidth = timelineContainer.offsetWidth;
            const contentWidth = timelineContent.offsetWidth;
            
            // í”½ì…€ ì´ë™ì„ ìŠ¬ë¼ì´ë” ê°’ìœ¼ë¡œ ë³€í™˜
            const sliderMin = parseInt(combinedSlider.min);
            const sliderMax = parseInt(combinedSlider.max);
            const totalSliderMonths = sliderMax - sliderMin;
            
            const deltaMonths = -deltaX * (totalSliderMonths / contentWidth);
            const newValue = Math.max(sliderMin, Math.min(sliderMax, startSliderValue + deltaMonths));
            
            combinedSlider.value = Math.round(newValue);
            const { year, month } = totalMonthsToYearMonth(Math.round(newValue));
            updateTime(year, month, true); // ğŸš© ì—°ëŒ€í‘œ ë“œë˜ê·¸ ì¤‘ì—ëŠ” ìºì‹œë§Œ ì‚¬ìš©
            updateTimelineScroll(true); // transition ì—†ì´ ì—…ë°ì´íŠ¸
        });
        
        document.addEventListener('mouseup', (e) => {
            if (isDragging) {
                isDragging = false;
                timelineContainer.style.cursor = 'grab';
                timelineContent.style.transition = 'transform 0.3s ease';
                // ğŸš© ë“œë˜ê·¸ ì™„ë£Œ í›„ ì •í™•í•œ ë Œë”ë§
                const { year, month } = getCurrentYearMonth();
                updateTime(year, month, false);
                e.preventDefault();
                e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                
                // ğŸš© [ì¶”ê°€] ë“œë˜ê·¸ê°€ ë°œìƒí•œ ê²½ìš° ì ì‹œ í›„ hasDraggedë¥¼ ë¦¬ì…‹
                if (hasDragged) {
                    setTimeout(() => {
                        hasDragged = false;
                    }, 100);
                }
            }
        });
        
        // í„°ì¹˜ ì´ë²¤íŠ¸
        timelineContainer.addEventListener('touchstart', (e) => {
            isDragging = true;
            hasDragged = false; // ğŸš© [ì¶”ê°€] ì´ˆê¸°í™”
            startX = e.touches[0].clientX;
            startSliderValue = parseInt(combinedSlider.value);
            timelineContent.style.transition = 'none';
            e.preventDefault();
            e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
        }, { passive: false });
        
        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            e.preventDefault();
            e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            
            const deltaX = e.touches[0].clientX - startX;
            
            // ğŸš© [ì¶”ê°€] 5px ì´ìƒ ì´ë™í•˜ë©´ ë“œë˜ê·¸ë¡œ ê°„ì£¼
            if (Math.abs(deltaX) > 5) {
                hasDragged = true;
            }
            
            const containerWidth = timelineContainer.offsetWidth;
            const contentWidth = timelineContent.offsetWidth;
            
            const sliderMin = parseInt(combinedSlider.min);
            const sliderMax = parseInt(combinedSlider.max);
            const totalSliderMonths = sliderMax - sliderMin;
            
            const deltaMonths = -deltaX * (totalSliderMonths / contentWidth);
            const newValue = Math.max(sliderMin, Math.min(sliderMax, startSliderValue + deltaMonths));
            
            combinedSlider.value = Math.round(newValue);
            const { year, month } = totalMonthsToYearMonth(Math.round(newValue));
            updateTime(year, month, true); // ğŸš© í„°ì¹˜ ë“œë˜ê·¸ ì¤‘ì—ëŠ” ìºì‹œë§Œ ì‚¬ìš©
            updateTimelineScroll(true);
        }, { passive: false });
        
        document.addEventListener('touchend', (e) => {
            if (isDragging) {
                isDragging = false;
                timelineContent.style.transition = 'transform 0.3s ease';
                // ğŸš© ë“œë˜ê·¸ ì™„ë£Œ í›„ ì •í™•í•œ ë Œë”ë§
                const { year, month } = getCurrentYearMonth();
                updateTime(year, month, false);
                e.preventDefault();
                e.stopPropagation(); // ğŸš© [ìˆ˜ì •] ì§€ë„ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                
                // ğŸš© [ì¶”ê°€] ë“œë˜ê·¸ê°€ ë°œìƒí•œ ê²½ìš° ì ì‹œ í›„ hasDraggedë¥¼ ë¦¬ì…‹
                if (hasDragged) {
                    setTimeout(() => {
                        hasDragged = false;
                    }, 100);
                }
            }
        }, { passive: false });
        
        // ğŸš© [ì¶”ê°€] hasDragged ìƒíƒœë¥¼ ì™¸ë¶€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•¨ìˆ˜ ë°˜í™˜
        return () => hasDragged;
    }

    // ğŸš© [ì¶”ê°€] timeline-sidebar ë‚´ ê°€ë¡œ ë“œë˜ê·¸ ìŠ¤í¬ë¡¤
    function initTimelineSidebarDrag() {
        const sidebar = document.getElementById('timeline-sidebar');
        const content = document.getElementById('timeline-content');
        if (!sidebar || !content) return;

        let isDragging = false;
        let isHorizontal = null; // null: ë°©í–¥ ë¯¸ê²°ì •
        let startX = 0;
        let startY = 0;
        let startSliderValue = 0;

        const onStart = (clientX, clientY) => {
            isDragging = true;
            isHorizontal = null;
            startX = clientX;
            startY = clientY;
            startSliderValue = parseInt(combinedSlider.value);
            content.style.transition = 'none';
        };

        const onMove = (clientX, clientY, e) => {
            if (!isDragging) return;
            const deltaX = clientX - startX;
            const deltaY = clientY - startY;

            // ë°©í–¥ ê²°ì • (ì²« 5px ì´ë™ í›„)
            if (isHorizontal === null && (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)) {
                isHorizontal = Math.abs(deltaX) >= Math.abs(deltaY);
            }
            if (isHorizontal === null) return;

            if (isHorizontal) {
                // ê°€ë¡œ ë“œë˜ê·¸: ìŠ¬ë¼ì´ë” ì´ë™, ì„¸ë¡œ ìŠ¤í¬ë¡¤ ì°¨ë‹¨
                if (e) e.preventDefault();
                const contentWidth = content.offsetWidth;
                const sliderMin = parseInt(combinedSlider.min);
                const sliderMax = parseInt(combinedSlider.max);
                const totalSliderMonths = sliderMax - sliderMin;
                const deltaMonths = -deltaX * (totalSliderMonths / contentWidth);
                const newValue = Math.max(sliderMin, Math.min(sliderMax, startSliderValue + deltaMonths));
                combinedSlider.value = Math.round(newValue);
                const { year, month } = totalMonthsToYearMonth(Math.round(newValue));
                updateTime(year, month, true);
                updateTimelineScroll(true);
            }
            // ì„¸ë¡œ ì œìŠ¤ì²˜ë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ â†’ ë¸Œë¼ìš°ì € ê¸°ë³¸ ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©
        };

        const onEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            isHorizontal = null;
            content.style.transition = 'transform 0.3s ease';
            const { year, month } = getCurrentYearMonth();
            updateTime(year, month, false);
        };

        sidebar.addEventListener('mousedown', (e) => { onStart(e.clientX, e.clientY); e.preventDefault(); });
        document.addEventListener('mousemove', (e) => { if (isDragging) { onMove(e.clientX, e.clientY, e); } });
        document.addEventListener('mouseup', () => onEnd());

        sidebar.addEventListener('touchstart', (e) => { onStart(e.touches[0].clientX, e.touches[0].clientY); }, { passive: true });
        sidebar.addEventListener('touchmove', (e) => { if (isDragging) { onMove(e.touches[0].clientX, e.touches[0].clientY, e); } }, { passive: false });
        sidebar.addEventListener('touchend', () => onEnd());
    }


    // --- 6. UI ì—…ë°ì´íŠ¸ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    // ğŸš© [ìˆ˜ì •] updateUI í•¨ìˆ˜: yearì™€ month ê°’ì„ ì§ì ‘ ì‚¬ìš© (ìŒìˆ˜ ì›” ë°©ì§€)
    function updateUI(year, month) {
      // ğŸš© [ìˆ˜ì •] B.C./A.D. í˜•ì‹ìœ¼ë¡œ ë³€ê²½í•˜ê³  ìë¦¿ìˆ˜ ê³ ì •
      const era = year < 1 ? 'B.C.' : 'A.D.';
      const yearNum = year < 1 ? Math.abs(year - 1) : year;
      const yearStr = String(yearNum).padStart(4, '0'); // 4ìë¦¬ ê³ ì • (0001, 0400, 2024 ë“±)
      const monthStr = String(month).padStart(2, '0'); // 2ìë¦¬ ê³ ì • (01, 12 ë“±)
      const ganjiText = getGanji(year, month);
      
      // ğŸš© [ìˆ˜ì •] yearInputì—ëŠ” ë‚´ë¶€ ì—°ë„ ê°’ ìœ ì§€ (ìŒìˆ˜ëŠ” B.C.)
      yearInput.value = year;
      monthInput.value = month;
      
      // ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ìš© ê°œë³„ ë¼ë²¨ ìš”ì†Œë“¤ ì—…ë°ì´íŠ¸ (eraLabel ì¶”ê°€)
      const eraLabel = document.getElementById('eraLabel');
      if (eraLabel) eraLabel.textContent = era;
      if (yearLabel) yearLabel.textContent = yearStr;
      if (monthLabel) monthLabel.textContent = monthStr;
      if (ganjiLabel) ganjiLabel.textContent = ganjiText;
      
      // ğŸš© [ì¶”ê°€] PCìš© ê°œë³„ ë¼ë²¨ ìš”ì†Œë“¤ ì—…ë°ì´íŠ¸ (AD/BC í‘œê¸° í¬í•¨)
      const yearLabelPc = document.getElementById('yearLabel-pc');
      const monthLabelPc = document.getElementById('monthLabel-pc');
      const ganjiLabelPc = document.getElementById('ganjiLabel-pc');
      
      if (yearLabelPc) yearLabelPc.textContent = `${era} ${yearStr}`;
      if (monthLabelPc) monthLabelPc.textContent = monthStr;
      if (ganjiLabelPc) ganjiLabelPc.textContent = `  ${ganjiText}`; // ì—¬ìœ  ê³µë°± ì¶”ê°€
      
      updateHistoryPanel(year);
      updateKingLabel(year, month);
    }

    function getCurrentYearMonth() {
        const year = parseInt(yearInput.value);
        const month = parseInt(monthInput.value);
        return { year, month };
    }

    // ğŸš© [ì¶”ê°€] ì‚¬ê±´ ì¹´í…Œê³ ë¦¬ì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜
    function getEventColor(category) {
        const colors = {
            foundation: '#e74c3c',    // ë¶‰ì€ìƒ‰ - ê±´êµ­
            unification: '#f39c12',  // ì£¼í™©ìƒ‰ - í†µì¼
            battle: '#e67e22',       // ì£¼í™©ìƒ‰ - ì „íˆ¬
            political: '#9b59b6',    // ë³´ë¼ìƒ‰ - ì •ì¹˜
            invasion: '#c0392b',     // ì§„í•œ ë¹¨ê°• - ì¹¨ëµ
            foreign: '#34495e',      // ì–´ë‘ìš´ íšŒìƒ‰ - ì™¸ì„¸ ê°„ì„­
            transition: '#27ae60'    // ì´ˆë¡ìƒ‰ - ì „í™˜ê¸°
        };
        return colors[category] || '#95a5a6';
    }

    // ğŸš© [ì¶”ê°€] ì‚¬ìš©ìê°€ ì—°ë„ ì…ë ¥ì°½ì„ ë¹„ìš°ê³  í¬ì»¤ìŠ¤ë¥¼ ìƒì—ˆì„ ë•Œì˜ ì²˜ë¦¬
    yearInput.addEventListener('input', (e) => {
        const value = e.target.value;
        if (value !== '' && value !== '-') {
            updateTime(parseInt(value) || 0, parseInt(monthInput.value) || 1);
        }
    });

    // ğŸš© [ì¶”ê°€] ì—°ë„ ì…ë ¥ì°½ì˜ ìŠ¤í”¼ë„ˆ ë²„íŠ¼ í´ë¦­ ì‹œ ì›” ìë™ ë³€ê²½
    yearInput.addEventListener('input', (e) => {
        const year = parseInt(e.target.value) || 0;
        const month = parseInt(monthInput.value) || 1;
        // ì‚¬ìš©ìê°€ ì§ì ‘ íƒ€ì´í•‘í•˜ëŠ” ê²½ìš°ëŠ” ì œì™¸í•˜ê³ , ìŠ¤í”¼ë„ˆ ë²„íŠ¼ í´ë¦­ ë“±ìœ¼ë¡œ ê°’ì´ ë³€ê²½ë  ë•Œë§Œ updateTime í˜¸ì¶œ
        if (e.inputType !== 'insertText' && e.inputType !== 'deleteContentBackward') {
            updateTime(year, month);
        }
    });
    // ğŸš© [ìˆ˜ì •] ì›” ì…ë ¥ì°½ ë³€ê²½ ì‹œ ì—°ë„ ìë™ ì¦ê° ê¸°ëŠ¥ ê°œì„ 
    monthInput.addEventListener('input', () => {
        const year = parseInt(yearInput.value) || 0;
        const month = parseInt(monthInput.value) || 1;
        updateTime(year, month);
    });

    // ğŸš© [ì¶”ê°€] ì—°ë„ í† ê¸€ë°” ì „ì²´ ì˜ì—­ì˜ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì§€ë„ë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë°©ì§€
    const timeControlsMap = document.getElementById('time-controls-map');
    if (timeControlsMap) {
        timeControlsMap.addEventListener('mousedown', (e) => {
            e.stopPropagation();
        });
        timeControlsMap.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        timeControlsMap.addEventListener('dblclick', (e) => {
            e.stopPropagation();
        });
    }
    
    // ğŸš© [ì¶”ê°€] ì—°ë„/ì›” ì…ë ¥ì°½ì˜ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì§€ë„ë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë°©ì§€
    yearInput.addEventListener('mousedown', (e) => {
        e.stopPropagation();
    });
    yearInput.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    monthInput.addEventListener('mousedown', (e) => {
        e.stopPropagation();
    });
    monthInput.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    
    // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ìš© í™”ì‚´í‘œ ë²„íŠ¼ ì´ë²¤íŠ¸ (ê°€ì†ë„ í¬í•¨)
    const prevYearBtn = document.getElementById('prevYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');
    
    let yearChangeInterval = null;
    let yearChangeSpeed = 1;
    let holdStartTime = 0;
    
    function startYearChange(direction) {
        // ğŸš© [ìˆ˜ì •] ì›” ë‹¨ìœ„ë¡œ ë³€ê²½
        let currentYear = parseInt(yearInput.value) || 0;
        let currentMonth = parseInt(monthInput.value) || 1;
        
        // ì›” ì¦ê°€/ê°ì†Œ
        currentMonth += direction;
        
        // ì›” ë²”ìœ„ ì¡°ì • ë° ì—°ë„ ë³€ê²½
        if (currentMonth > 12) {
            currentMonth = 1;
            currentYear += 1;
        } else if (currentMonth < 1) {
            currentMonth = 12;
            currentYear -= 1;
        }
        
        yearInput.value = currentYear;
        monthInput.value = currentMonth;
        yearInput.dispatchEvent(new Event('input'));
        monthInput.dispatchEvent(new Event('input'));
        
        holdStartTime = Date.now();
        yearChangeSpeed = 1;
        
        // ì—°ì† ë³€ê²½ ì‹œì‘
        if (yearChangeInterval) clearInterval(yearChangeInterval);
        yearChangeInterval = setInterval(() => {
            const holdDuration = Date.now() - holdStartTime;
            
            // ğŸš© [ìˆ˜ì •] ê°€ì†ë„ ê³„ì‚°: 0-500msëŠ” 1ê°œì›”/100ms, 500-1500msëŠ” 3ê°œì›”/100ms, 1500ms+ëŠ” 12ê°œì›”(1ë…„)/100ms
            if (holdDuration > 1500) {
                yearChangeSpeed = 12; // 1ë…„ì”©
            } else if (holdDuration > 500) {
                yearChangeSpeed = 3; // 3ê°œì›”ì”©
            } else {
                yearChangeSpeed = 1; // 1ê°œì›”ì”©
            }
            
            let currentYear = parseInt(yearInput.value) || 0;
            let currentMonth = parseInt(monthInput.value) || 1;
            
            // ì—¬ëŸ¬ ê°œì›” ì¦ê°€/ê°ì†Œ
            currentMonth += direction * yearChangeSpeed;
            
            // ì›” ë²”ìœ„ ì¡°ì • ë° ì—°ë„ ë³€ê²½
            while (currentMonth > 12) {
                currentMonth -= 12;
                currentYear += 1;
            }
            while (currentMonth < 1) {
                currentMonth += 12;
                currentYear -= 1;
            }
            
            yearInput.value = currentYear;
            monthInput.value = currentMonth;
            yearInput.dispatchEvent(new Event('input'));
            monthInput.dispatchEvent(new Event('input'));
        }, 100);
    }
    
    function stopYearChange() {
        if (yearChangeInterval) {
            clearInterval(yearChangeInterval);
            yearChangeInterval = null;
        }
        yearChangeSpeed = 1;
    }
    
    if (prevYearBtn) {
        prevYearBtn.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            e.preventDefault();
            startYearChange(-1);
        });
        prevYearBtn.addEventListener('mouseup', stopYearChange);
        prevYearBtn.addEventListener('mouseleave', stopYearChange);
        prevYearBtn.addEventListener('touchstart', (e) => {
            e.stopPropagation();
            e.preventDefault();
            startYearChange(-1);
        });
        prevYearBtn.addEventListener('touchend', stopYearChange);
        prevYearBtn.addEventListener('touchcancel', stopYearChange);
    }
    
    if (nextYearBtn) {
        nextYearBtn.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            e.preventDefault();
            startYearChange(1);
        });
        nextYearBtn.addEventListener('mouseup', stopYearChange);
        nextYearBtn.addEventListener('mouseleave', stopYearChange);
        nextYearBtn.addEventListener('touchstart', (e) => {
            e.stopPropagation();
            e.preventDefault();
            startYearChange(1);
        });
        nextYearBtn.addEventListener('touchend', stopYearChange);
        nextYearBtn.addEventListener('touchcancel', stopYearChange);
    }

    function updateTime(year, month, cacheOnly = false) {
        // ğŸš© [ìˆ˜ì •] yearInput, monthInput ì—…ë°ì´íŠ¸ëŠ” updateUIì—ì„œ ì²˜ë¦¬
        const totalMonths = yearMonthToTotalMonths(year, month);
        const sliderMin = parseInt(combinedSlider.min);
        const sliderMax = parseInt(combinedSlider.max);
        if (totalMonths >= sliderMin && totalMonths <= sliderMax) {
            combinedSlider.value = totalMonths;
        } 
        
        updateMap(year, month, cacheOnly); // ğŸš© cacheOnly ë§¤ê°œë³€ìˆ˜ ì „ë‹¬
        updateUI(year, month);
        checkAndDisplayEvent(year, month);
        // createHistoricalEventMarkers(); // ğŸš© [ì œê±°] ì—°ë„ ë³€ê²½ ì‹œ ì‚¬ê±´ ë§ˆì»¤ ì—…ë°ì´íŠ¸ - ì œê±°ë¨
        updateTimelineScroll(); // ğŸš© [ì¶”ê°€] ì—°ë„ ë³€ê²½ ì‹œ ì—°ëŒ€í‘œë„ í•¨ê»˜ ì´ë™
    }

    // ğŸš© [ìˆ˜ì •] ì›” ì…ë ¥ í•„ë“œì—ì„œ í™”ì‚´í‘œ í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì—°ë„ ë³€ê²½ ë¡œì§ ì¶©ëŒ í•´ê²°
    monthInput.addEventListener('keydown', (e) => {
        let keydownYear = parseInt(yearInput.value) || 0;
        const currentMonth = parseInt(monthInput.value) || 1;

        if (e.key === 'ArrowDown' && currentMonth === 1) {
            e.preventDefault(); // ê¸°ë³¸ ë™ì‘(ê°’ì´ 0ì´ ë˜ëŠ” ê²ƒ)ì„ ë§‰ìŒ
            updateTime(keydownYear - 1, 12);
        } else if (e.key === 'ArrowUp' && currentMonth === 12) {
            e.preventDefault(); // ê¸°ë³¸ ë™ì‘(ê°’ì´ 13ì´ ë˜ëŠ” ê²ƒ)ì„ ë§‰ìŒ
            updateTime(keydownYear + 1, 1);
        }
    });
    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¬ìƒ ì œì–´ ë¡œì§: BC/AD ì „í™˜ ë° ì›” í‘œì‹œ ë¬¸ì œ í•´ê²°
    let playInterval = null;
    
 function startPlayback() {
        if (playInterval) return; 

        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline';

        const monthsPerSecond = parseInt(playbackSpeedSlider.value) || 12;
        const intervalDuration = 1000 / monthsPerSecond; 

        playInterval = setInterval(() => {
            let totalMonths = parseInt(combinedSlider.value);
            
            // 1. ì´ ì›”ìˆ˜ë¥¼ 1 ì¦ê°€
            totalMonths++;
            
            // 2. ìŠ¬ë¼ì´ë” ìµœëŒ€ê°’ì„ ì´ˆê³¼í•˜ë©´ ì •ì§€
            if (totalMonths > parseInt(combinedSlider.max)) {
                stopPlayback();
                return;
            }
            
            // 3. ìƒˆë¡œìš´ ì—°/ì›” ê³„ì‚°
            const { year, month } = totalMonthsToYearMonth(totalMonths);
            
            // 4. UI ì—…ë°ì´íŠ¸
            combinedSlider.value = totalMonths;
            
            yearInput.value = year;
            monthInput.value = month;

            // ğŸš© [ìˆ˜ì •] ì¬ìƒ ì¤‘ì—ëŠ” updateTime í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ëª¨ë“  UIì™€ ì§€ë„ë¥¼ ì¼ê´€ì„± ìˆê²Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            updateTime(year, month);
            /*
            updateMap(year, month);
            updateUI(year, month);
            checkAndDisplayEvent(year, month);
            */
        }, intervalDuration); 
    }

    function stopPlayback() {
        clearInterval(playInterval);
        playInterval = null;
        playBtn.style.display = 'inline';
        pauseBtn.style.display = 'none';
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜ ë§¨ ë§ˆì§€ë§‰ì— ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    const originalInitialize = initialize;
    initialize = async () => {
        await originalInitialize();
        
        // ğŸš© [ì¶”ê°€] ì¬ìƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        playBtn.addEventListener('click', startPlayback);
        pauseBtn.addEventListener('click', stopPlayback);
        
        // ì†ë„ ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        playbackSpeedSlider.addEventListener('input', () => {
            speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
            if (playInterval) {
                stopPlayback();
                startPlayback(); // ì¦‰ì‹œ ìƒˆ ì†ë„ë¡œ ë‹¤ì‹œ ì‹œì‘
            }
        });
        
         // ìŠ¬ë¼ì´ë” ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ë“œë˜ê·¸ ì¤‘)
         // ğŸš© [ê°œì„  v2] rAF ê¸°ë°˜ìœ¼ë¡œ ë§¤ í”„ë ˆì„ ìµœì‹ ê°’ ë°˜ì˜ â€” UIëŠ” ì¦‰ì‹œ, ì§€ë„ëŠ” rAF 1í”„ë ˆì„ í›„
         let _sliderRAF = null;
         let _sliderLastMapYear = null;
         let _sliderLastMapMonth = null;
         let _sliderPendingYear = null;
         let _sliderPendingMonth = null;

         combinedSlider.addEventListener('input', () => {
             // ì‘ë™ ì¤‘ì—ëŠ” í˜„ì¬ì‹œê°„ ë ˆì´ë¸”ì„ ì‘ê²Œ í‘œì‹œ(ì‹œê°ì  í”¼ë“œë°±)
             const compactizeTimeLabels = () => {
                 try { timeLabelDisplay?.classList.add('compact'); } catch(e){}
                 try { document.getElementById('timeLabelDisplay-pc')?.classList.add('compact'); } catch(e){}
                 try { document.getElementById('current-year-display')?.classList.add('compact'); } catch(e){}
             };
             compactizeTimeLabels();

             const totalMonths = parseInt(combinedSlider.value);
             const { year, month } = totalMonthsToYearMonth(totalMonths);

             // UIÂ·íˆ´íŒì€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (0ms ë”œë ˆì´)
             updateUI(year, month);
             updateSliderTooltip(year, month);

             // ì§€ë„ ì—…ë°ì´íŠ¸: rAFë¡œ ë‹¤ìŒ í”„ë ˆì„ì— í•œ ë²ˆë§Œ ì‹¤í–‰ (ì—°ì† ì…ë ¥ ì‹œ ë§ˆì§€ë§‰ ê°’ë§Œ)
             _sliderPendingYear = year;
             _sliderPendingMonth = month;
             if (!_sliderRAF) {
                 _sliderRAF = requestAnimationFrame(() => {
                     _sliderRAF = null;
                     // ì´ì „ í”„ë ˆì„ê³¼ ì—°ë„/ì›”ì´ ê°™ìœ¼ë©´ ì§€ë„ ì¬ë Œë”ë§ ìƒëµ
                     if (_sliderLastMapYear === _sliderPendingYear && _sliderLastMapMonth === _sliderPendingMonth) return;
                     _sliderLastMapYear = _sliderPendingYear;
                     _sliderLastMapMonth = _sliderPendingMonth;
                     updateMap(_sliderLastMapYear, _sliderLastMapMonth);
                 });
             }
         });

         // ìŠ¬ë¼ì´ë” ì¡°ì‘ì´ ëë‚˜ë©´ compact í´ë˜ìŠ¤ ì œê±° + ìµœì¢… ì§€ë„ ì—…ë°ì´íŠ¸ ë³´ì¥
         const removeCompactLabels = () => {
             try { timeLabelDisplay?.classList.remove('compact'); } catch(e){}
             try { document.getElementById('timeLabelDisplay-pc')?.classList.remove('compact'); } catch(e){}
             try { document.getElementById('current-year-display')?.classList.remove('compact'); } catch(e){}
             // ğŸš© slider-dragging í´ë˜ìŠ¤ ì œê±° (íŠ¸ëœì§€ì…˜ ì›ìƒë³µêµ¬)
             document.body.classList.remove('slider-dragging');
             // rAF ì·¨ì†Œ í›„ ìµœì¢…ê°’ìœ¼ë¡œ ì •í™•í•˜ê²Œ ì§€ë„ ì—…ë°ì´íŠ¸
             if (_sliderRAF) {
                 cancelAnimationFrame(_sliderRAF);
                 _sliderRAF = null;
             }
             if (_sliderPendingYear !== null) {
                 updateMap(_sliderPendingYear, _sliderPendingMonth, false, true);
                 _sliderLastMapYear = _sliderPendingYear;
                 _sliderLastMapMonth = _sliderPendingMonth;
                 _sliderPendingYear = null;
                 _sliderPendingMonth = null;
             }
         };
         combinedSlider.addEventListener('change', removeCompactLabels);
         combinedSlider.addEventListener('mouseup', removeCompactLabels);
         combinedSlider.addEventListener('touchend', removeCompactLabels);
        
        // ì´ˆê¸° ì—°ë„ í‘œì‹œ ì„¤ì •
        const initialTotalMonths = parseInt(combinedSlider.value);
        const { year: initialYear, month: initialMonth } = totalMonthsToYearMonth(initialTotalMonths);
        updateSliderTooltip(initialYear, initialMonth);
        
        // ìŠ¬ë¼ì´ë”ì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë²—ì–´ë‚˜ë„ íˆ´íŒ ìœ ì§€ (í•­ìƒ í‘œì‹œ)
        // combinedSlider.addEventListener('mouseleave', () => {
        //     const tooltip = document.getElementById('slider-year-tooltip');
        //     tooltip.classList.remove('show');
        // });
        
        // ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ ìë™ ì •ì§€
        combinedSlider.addEventListener('mousedown', () => {
            document.body.classList.add('slider-dragging');
            stopPlayback();
        });
        combinedSlider.addEventListener('touchstart', () => {
            document.body.classList.add('slider-dragging');
            stopPlayback();
        });
        
        // ì´ˆê¸° ì†ë„ ë””ìŠ¤í”Œë ˆì´ ì„¤ì •
        speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
        
        // ğŸš© [ì¶”ê°€] íƒ€ì„ë¼ì¸ ì»¨íŠ¸ë¡¤ì—ì„œ Leaflet ì´ë²¤íŠ¸ ì¶©ëŒ ë°©ì§€
        const timelineDiv = document.getElementById('timeline-control');
        if (timelineDiv) {
            L.DomEvent.disableClickPropagation(timelineDiv);
            L.DomEvent.disableScrollPropagation(timelineDiv);
        }
        
        // ğŸš© [ì œê±°] ì´ë²¤íŠ¸ ë§ˆì»¤ ìƒì„± - ì œê±°ë¨
        
        // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ ë²„íŠ¼ ì´ë²¤íŠ¸
        const closeTimelineBtn = document.getElementById('close-timeline-sidebar');
        if (closeTimelineBtn) {
            closeTimelineBtn.addEventListener('click', () => {
                const sidebar = document.getElementById('timeline-sidebar');
                sidebar.style.display = 'none';
                sidebar.style.opacity = '0';
                sidebar.style.pointerEvents = 'none';
                
                // í–„ë²„ê±° ë©”ë‰´ ì²´í¬ë°•ìŠ¤ë„ í•´ì œ
                const timelineCheckbox = document.getElementById('menu-layer-timeline');
                if (timelineCheckbox) {
                    timelineCheckbox.checked = false;
                    layerVisibility.timeline = false;
                }
            });
        }
    };
    
    // ğŸš© [ì¶”ê°€] ìŠ¬ë¼ì´ë” ì—°ë„ íˆ´íŒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateSliderTooltip(year, month) {
        const tooltip = document.getElementById('slider-year-tooltip');
        const yearIndicator = document.getElementById('year-indicator');
        const slider = document.getElementById('combinedSlider');
        const yearDisplay = document.getElementById('current-year-display');
        
        if (!tooltip || !slider) return;
        
        // íˆ´íŒ í…ìŠ¤íŠ¸ ì„¤ì •
        const yearText = year <= 0 ? `ê¸°ì›ì „ ${Math.abs(year)}ë…„` : `${year}ë…„`;
        tooltip.textContent = yearText;
        
        // year-indicator ì—…ë°ì´íŠ¸ (ìŠ¬ë¼ì´ë” í•¸ë“¤ ì¤‘ì•™ì— í¬ê²Œ í‘œì‹œ)
        if (yearIndicator) {
            yearIndicator.textContent = yearText;
            yearIndicator.style.opacity = '1'; // í‘œì‹œ
            
            // 2ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            clearTimeout(yearIndicator.hideTimeout);
            yearIndicator.hideTimeout = setTimeout(() => {
                yearIndicator.style.opacity = '0';
            }, 2000);
        }
        
        // ìŠ¬ë¼ì´ë” í•¸ë“¤ ìœ„ì¹˜ ê³„ì‚°
        const min = parseInt(slider.min);
        const max = parseInt(slider.max);
        const value = parseInt(slider.value);
        const percentage = ((value - min) / (max - min)) * 100;
        
        // íˆ´íŒ ìœ„ì¹˜ ì„¤ì •
        tooltip.style.left = `${percentage}%`;
        tooltip.classList.add('show');
        
        // ì™¼ìª½ ìƒë‹¨ ì—°ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (yearDisplay) {
            const era = year <= 0 ? 'B.C.' : 'A.D.';
            const yearStr = year <= 0 ? String(Math.abs(year)).padStart(4, '0') : String(year).padStart(4, '0');
            const monthStr = String(month).padStart(2, '0');
            const ganji = getGanji(year, month);
            yearDisplay.textContent = `${era} ${yearStr}ë…„ ${monthStr}ì›” ${ganji}`;
        }
    }
    
    // --- 7. ì—­ì‚¬ ê¸°ë¡ íŒ¨ë„ ì—…ë°ì´íŠ¸ ---
    function updateHistoryPanel(year) {
      const filteredRecords = history.filter(h => h.year === year);
      
      // const historyYearTitle = document.getElementById('historyYearTitle'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
      let titleText = `${year <= 0 ? ' ê¸°ì›ì „' : ' ì„œê¸°'} ${Math.abs(year)}ë…„ ì—­ì‚¬ ê¸°ë¡`;
      
      const firstKoreanRecord = filteredRecords.find(r => r.records?.korean?.content);
      if (firstKoreanRecord && firstKoreanRecord.event_name) {
        titleText += ` - ${firstKoreanRecord.event_name}`;
      }
      // historyYearTitle.textContent = titleText; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°

      // ğŸš© [ì œê±°] ì˜¤ë¥¸ìª½ íŒ¨ë„ ìš”ì†Œë“¤ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
      // const koreanContainer = document.getElementById('koreanRecords');
      // const foreignContainer = document.getElementById('foreignRecords');
      // const trueHistoryContainer = document.getElementById('trueHistoryRecords');

      // ğŸš© [ì¶”ê°€] ìƒì„±ì/ìˆ˜ì •ì ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” HTMLì„ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
      const createEditorInfoHtml = (record) => {
          let editorInfo = record.lastModifiedBy
              ? `ë§ˆì§€ë§‰ ìˆ˜ì •: ${record.lastModifiedBy}`
              : (record.createdBy ? `ìƒì„±ì: ${record.createdBy}` : '');

          // ğŸš© [ì¶”ê°€] contributionì—ì„œ ì˜¨ ê¸°ë¡ì¸ ê²½ìš° ê¸°ì—¬ì ì •ë³´ í‘œì‹œ
          if (record.contribution_id || record.records?.korean?.contribution_id) {
              const contributor = record.contributor || record.records?.korean?.contributor;
              if (contributor) {
                  editorInfo += (editorInfo ? ' | ' : '') + `ê¸°ì—¬ì: ${contributor} ğŸ‘¤`;
              }
          }

          return editorInfo
              ? `<small style="float: right; color: #ecf0f1; font-size: 10px;">${editorInfo}</small>`
              : '';
      };

      // ğŸš© [ì œê±°] ì˜¤ë¥¸ìª½ íŒ¨ë„ìš© ì»¨í…ì¸  ìƒì„± ì½”ë“œ
      // const koreanContent = filteredRecords.filter(r => r.records?.korean?.content).map(r => `<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.korean.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.korean.source}</span><br>` : ''}${r.records.korean.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';
      // const foreignContent = filteredRecords.filter(r => r.records?.foreign?.content).map(r => `<div class="record-item foreign"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.foreign.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.foreign.source}</span><br>` : ''}${r.records.foreign.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';
      
      // koreanContainer.innerHTML = koreanContent;
      // foreignContainer.innerHTML = foreignContent;
      // trueHistoryContainer.innerHTML = filteredRecords.filter(r => r.records?.true_history?.content).map(r => `<div class="record-item true_history"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.true_history.content.trim()}</div>`).join('') || 'ê¸°ë¡ ì—†ìŒ';
      
      // ğŸš© [ìˆ˜ì •] ëª¨ë“  ì—­ì‚¬ê¸°ë¡ì„ í†µí•©í•˜ì—¬ í‘œì‹œ (êµ¬ë¶„ ì—†ì´)
      const allRecordsContent = filteredRecords.flatMap(r => {
          const recordItems = [];
          if (r.records?.korean?.content) {
              recordItems.push(`<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.korean.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.korean.source}</span><br>` : ''}${r.records.korean.content.trim()}</div>`);
          }
          if (r.records?.foreign?.content) {
              recordItems.push(`<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.foreign.source ? `<span style="font-weight: bold; color: #000000;">ì¶œì „: ${r.records.foreign.source}</span><br>` : ''}${r.records.foreign.content.trim()}</div>`);
          }
          if (r.records?.true_history?.content) {
              recordItems.push(`<div class="record-item"><button onclick="editHistory('${r._id}')" ${editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin') ? '' : 'style="display:none;"'}>í¸ì§‘</button>${createEditorInfoHtml(r)}${r.records.true_history.content.trim()}</div>`);
          }
          return recordItems;
      }).join('') || 'ê¸°ë¡ ì—†ìŒ';
      
      // ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ ì—­ì‚¬ ê¸°ë¡ íŒ¨ë„ ì—…ë°ì´íŠ¸
      const mapHistoryYearTitle = document.getElementById('map-history-year-title');
      const mapAllRecordsContent = document.getElementById('map-all-records-content');
      if (mapHistoryYearTitle) mapHistoryYearTitle.textContent = titleText;
      if (mapAllRecordsContent) mapAllRecordsContent.innerHTML = allRecordsContent;

      
      // ğŸš© [ìˆ˜ì •] ê´€ë¦¬ìì´ê³  í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ 'ê¸°ë¡ ì¶”ê°€' ë²„íŠ¼ í‘œì‹œ - ì§€ë„ ë‚´ íŒ¨ë„ë§Œ ì‚¬ìš©
      // openHistoryFormBtn.style.display = (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) ? 'inline-block' : 'none'; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
      const mapOpenHistoryFormBtn = document.getElementById('map-open-history-form-btn');
      if (mapOpenHistoryFormBtn) {
          mapOpenHistoryFormBtn.style.display = (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) ? 'inline-block' : 'none';
      } 
    }


    // --- 8. ì„±/êµ°ëŒ€ í¼ ê´€ë¦¬ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    
    // ğŸš© [ìˆ˜ì •] ê²½ë¡œ ì§€ì  ì¶”ê°€ í•¨ìˆ˜ (í˜„ì¬ ë§ˆì»¤ ìœ„ì¹˜ ìë™ ì…ë ¥)
    window.addPathPoint = function(point = {}) {
        const list = pathDataList;
        
        // í˜„ì¬ ìŠ¬ë¼ì´ë”ì˜ ì—°ë„ì™€ ì›”ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ê°€ì ¸ì˜´
        const defaultYear = yearInput.value;
        const defaultMonth = monthInput.value;
        
        // í¸ì§‘ ë§ˆì»¤ê°€ ìˆëŠ” ê²½ìš° ìœ„ë„/ê²½ë„ë¥¼ ê°€ì ¸ì˜´
        let defaultLat = '';
        let defaultLng = '';
        if (editMarker) {
            const latlng = editMarker.getLatLng();
            defaultLat = latlng.lat.toFixed(6);
            defaultLng = latlng.lng.toFixed(6);
        }

        const row = document.createElement('div');
        row.className = 'path-point-row';
        
        row.innerHTML = `
            <input type="number" class="path-year path-time-input" placeholder="ì—°ë„" value="${point.target_year || defaultYear}" required>
            <input type="number" class="path-month path-time-input" placeholder="ì›”" min="1" max="12" value="${point.target_month || defaultMonth}" required>
            <input type="number" step="any" class="path-lat" placeholder="ìœ„ë„" value="${point.lat || defaultLat}" required>
            <input type="number" step="any" class="path-lng" placeholder="ê²½ë„" value="${point.lng || defaultLng}" required>
            <button type="button" onclick="removePathPoint(this)">X</button>
        `;
        list.appendChild(row);
    }
    
    // ğŸš© [ì¶”ê°€] ê²½ë¡œ ì§€ì  ì œê±° í•¨ìˆ˜ (ë™ì¼)
    window.removePathPoint = function(button) {
        button.closest('.path-point-row').remove();
    }

    // ğŸš© [ì¶”ê°€] í¼ì—ì„œ ê²½ë¡œ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ (ë™ì¼)
    function collectPathData() {
        const pathPoints = document.querySelectorAll('#pathDataList .path-point-row');
        const pathData = [];
        pathPoints.forEach(row => {
            pathData.push({
                target_year: parseInt(row.querySelector('.path-year').value) || null,
                target_month: parseInt(row.querySelector('.path-month').value) || 1,
                lat: parseFloat(row.querySelector('.path-lat').value) || null,
                lng: parseFloat(row.querySelector('.path-lng').value) || null,
            });
        });
        return pathData.filter(p => p.target_year !== null && p.lat !== null && p.lng !== null);
    }
    cancelCitySelectionBtn.addEventListener('click', () => {
        editCitySelectionForm.style.display = 'none';
    });
    editSelectedCityBtn.addEventListener('click', () => {
        const selectedCityId = citySelectForEdit.value;
        if (selectedCityId) { editCitySelectionForm.style.display = 'none'; openCastleForm(selectedCityId); } else { alert('í¸ì§‘í•  ë„ì‹œ/ì„±ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); }
    });

    
    // ì§€ë„ í´ë¦­ ì‹œ ì„± ì¶”ê°€ í¼ ì—´ê¸° (í¸ì§‘ ëª¨ë“œì—ì„œë§Œ)
    map.on('click', (e) => {
      // ğŸš© [ì¶”ê°€] ê¸°ì—¬ ëª¨ë“œì¼ ë•Œ í¼ ì—´ê¸° (ì¼ë°˜ ìœ ì €ë„ ê°€ëŠ¥í•˜ì§€ë§Œ ê²ŒìŠ¤íŠ¸ëŠ” ì œì™¸)
      if (contributionMode && !currentUser?.isGuest) {
          const latlng = e.latlng;
          document.getElementById('contribLat').value = latlng.lat;
          document.getElementById('contribLng').value = latlng.lng;
          
          if (contributionMarker) map.removeLayer(contributionMarker);
          contributionMarker = L.marker(latlng).addTo(map);
          
          const form = document.getElementById('contributionForm');
          form.style.display = 'block';
          openForm('contributionForm'); // ì¤‘ì•™ ì •ë ¬
          return;
      }

      // ğŸš© [ìˆ˜ì •] í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•ŒëŠ” ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ (ê´€ë¦¬ì ì „ìš©)
      if (!editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return;

      // ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ëŠ” ì¤‘ì¼ ë•ŒëŠ” í¼ì„ ì—´ì§€ ì•Šê³  ì¢…ë£Œ
      if (isDrawing) return;

      // ğŸš© [ìˆ˜ì •] ì§€ë„ í´ë¦­ ì‹œ ë°”ë¡œ í¼ì„ ì—´ì§€ ì•Šê³ , ìš°í´ë¦­ ë©”ë‰´ë¥¼ í†µí•´ ì—´ë„ë¡ ë³€ê²½ (ì•„ë˜ contextmenu ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì°¸ì¡°)
      // ì´ í•¸ë“¤ëŸ¬ëŠ” ì´ì œ ë¹„ì–´ìˆì–´ë„ ë˜ì§€ë§Œ, í–¥í›„ ë‹¤ë¥¸ í´ë¦­ ê¸°ë°˜ ê¸°ëŠ¥ì„ ìœ„í•´ ë‚¨ê²¨ë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    });

    // ğŸš© [ì¶”ê°€] ì§€ë„ì—ì„œ ìš°í´ë¦­ ì‹œ ì¢Œí‘œ ë³µì‚¬ íŒì—… í‘œì‹œ
    map.on('contextmenu', (e) => {
      const latlng = e.latlng;
      const textToCopy = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
      
      // ğŸš© [ìˆ˜ì •] íŒì—… ì»¨í…ì¸ ë¥¼ flexboxë¡œ ì„¤ì •í•˜ì—¬ ë‚´ë¶€ ìš”ì†Œë“¤ì„ ì„¸ë¡œë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
      const popupContent = document.createElement('div');
      popupContent.style.display = 'flex';
      popupContent.style.flexDirection = 'column';
      popupContent.style.gap = '8px'; // ë²„íŠ¼ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ì˜ ê°„ê²©
      popupContent.innerHTML = `<span class="vintage-desc">${textToCopy}</span>`;
      
      const copyButton = document.createElement('button');
      copyButton.innerText = 'ì¢Œí‘œ ë³µì‚¬';
      copyButton.className = 'primary'; // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
      copyButton.onclick = () => {
        navigator.clipboard.writeText(textToCopy).then(() => {
          map.closePopup();
        }).catch(err => {
          console.error('ì¢Œí‘œ ë³µì‚¬ ì‹¤íŒ¨:', err);
          alert('ì¢Œí‘œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
      };

      // ğŸš© [ì¶”ê°€] í¸ì§‘ ëª¨ë“œ ì§„ì…/ë‚˜ê°€ê¸° ë²„íŠ¼ (admin/superuserë§Œ) - privileged ë³€ìˆ˜ ì„ ì–¸
      const privileged = currentUser?.role === 'superuser' || currentUser?.role === 'admin';

      const addCastleButton = document.createElement('button');
      addCastleButton.innerText = 'ì—¬ê¸°ì— ìƒˆ ì˜¤ë¸Œì íŠ¸ ë§Œë“¤ê¸°';
      addCastleButton.className = 'primary';
      addCastleButton.onclick = () => {
      map.closePopup();
      // ğŸš© [ì¶”ê°€] ì„± ì¶”ê°€ í¼ì„ ì—¬ëŠ” ë¡œì§
      editingCastleKey = null;
      closeAllFormsExcept('castleForm');
      openForm('castleForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
      addCastleForm.reset();
      document.getElementById('deleteCastle').style.display = 'none';
      
      // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('customIcon').value = '';
      document.getElementById('iconWidth').value = '';
      document.getElementById('iconHeight').value = '';
      
      document.getElementById('castleLat').value = e.latlng.lat.toFixed(6);
      document.getElementById('castleLng').value = e.latlng.lng.toFixed(6);
      
      const currentYear = parseInt(yearInput.value);
      const currentMonth = parseInt(monthInput.value);
      // document.getElementById('castleBuilt').value = currentYear;
      // document.getElementById('castleBuiltMonth').value = currentMonth;
      
      document.getElementById('pathDataList').innerHTML = ''; // ê²½ë¡œ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      // ğŸš© [ì¶”ê°€] í¼ ì—´ ë•Œ êµ­ê°€ í•„ë“œë¥¼ ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ì„¤ì •
      // document.getElementById('castleCountry').value = ''; 
      // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” ë° ê¸°ë³¸ í•­ëª© ì¶”ê°€
      document.getElementById('castleHistoryList').innerHTML = '';
      addCastleHistoryRow({
          name: '',
          country_id: '',
          start_year: currentYear,
          start_month: currentMonth,
          end_year: '',
          end_month: 12
      });

      // const defaultCountryName = document.getElementById('castleCountry').value;
      // const defaultCountry = getCountryInfoById(defaultCountryName);
      // if (defaultCountry) {
      //   document.getElementById('castleDestroyed').value = defaultCountry.end || '';
      //   document.getElementById('castleDestroyedMonth').value = defaultCountry.end_month || 12;
      // }
      
      if (editMarker) map.removeLayer(editMarker);
      editMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
      editMarker.on('dragend', (event) => {
        const marker = event.target;
        const position = marker.getLatLng();
        document.getElementById('castleLat').value = position.lat.toFixed(6);
        document.getElementById('castleLng').value = position.lng.toFixed(6);
      });
      editMarker.bindPopup('ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •').openPopup();
      
      // ğŸš© ìì—° ì§€ë¬¼/êµ°ëŒ€ í”Œë˜ê·¸ ë¯¸ì²´í¬ ìƒíƒœë¡œ ê´€ë ¨ ì„¹ì…˜ ìˆ¨ê¹€
      pathDataSection.style.display = 'none';
      militaryFlagDetails.style.display = 'none';
      
      naturalFeatureDetails.style.display = 'none';

      // ğŸš© ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° 'ì¼ë°˜'ìœ¼ë¡œ ì´ˆê¸°í™”
      setActiveMarkerType('normal');
      };

      // ğŸš© [ìˆ˜ì •] í¸ì§‘ ëª¨ë“œ ë²„íŠ¼ì„ ë¨¼ì € ì¶”ê°€
      if (privileged) {
        const editModeButtonBottom = document.createElement('button');
        editModeButtonBottom.className = 'primary';
        
        if (editMode) {
          editModeButtonBottom.innerText = 'í¸ì§‘ ëª¨ë“œ ë‚˜ê°€ê¸°';
          editModeButtonBottom.style.backgroundColor = '#dc3545';
          editModeButtonBottom.onclick = () => {
            console.log('í¸ì§‘ ëª¨ë“œ ë‚˜ê°€ê¸° í´ë¦­');
            map.closePopup();
            // í¸ì§‘ ëª¨ë“œ ì§ì ‘ í•´ì œ
            editMode = false;
            const editDropdownContainerElement = document.getElementById('edit-dropdown-container');
            if (editDropdownContainerElement) {
                editDropdownContainerElement.style.display = 'none';
            }
            const topbarEditContainer = document.getElementById('topbar-edit-dropdown-container');
            if (topbarEditContainer) {
                topbarEditContainer.style.display = 'none';
            }
            // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ë‹«ê¸°
            const topbarEditDropdownMenu = document.getElementById('topbar-edit-dropdown-menu');
            if (topbarEditDropdownMenu) {
                topbarEditDropdownMenu.style.display = 'none';
            }
            if (typeof drawControl !== 'undefined' && drawControl) {
                map.removeControl(drawControl);
            }
            if (typeof updateHistoryPanel === 'function' && typeof currentYear !== 'undefined') {
                updateHistoryPanel(currentYear);
            }
          };
        } else {
          editModeButtonBottom.innerText = 'í¸ì§‘ ëª¨ë“œ ì§„ì…';
          editModeButtonBottom.style.backgroundColor = '#28a745';
          editModeButtonBottom.onclick = () => {
            console.log('í¸ì§‘ ëª¨ë“œ ì§„ì… í´ë¦­', {currentUser, editMode, privileged});
            map.closePopup();
            // í¸ì§‘ ëª¨ë“œ ì§ì ‘ í™œì„±í™”
            editMode = true;
            const editDropdownContainerElement = document.getElementById('edit-dropdown-container');
            if (editDropdownContainerElement) {
                editDropdownContainerElement.style.display = 'inline-block';
            }
            const topbarEditContainer = document.getElementById('topbar-edit-dropdown-container');
            if (topbarEditContainer) {
                topbarEditContainer.style.display = 'inline-block';
            }
            // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìë™ ì—´ê¸°
            const topbarEditDropdownMenu = document.getElementById('topbar-edit-dropdown-menu');
            if (topbarEditDropdownMenu) {
                topbarEditDropdownMenu.style.display = 'block';
            }
            if (typeof initializeDrawControl === 'function') {
                initializeDrawControl();
            }
            if (typeof updateHistoryPanel === 'function' && typeof currentYear !== 'undefined') {
                updateHistoryPanel(currentYear);
            }
          };
        }
        popupContent.appendChild(editModeButtonBottom);
      }

      popupContent.appendChild(copyButton);
      // ğŸš© [ì¶”ê°€] í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ 'ì„± ì¶”ê°€' ë²„íŠ¼ì„ íŒì—…ì— í‘œì‹œ
      if (editMode && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) {
        popupContent.appendChild(addCastleButton);
      }
      
      // ğŸš© [ì¶”ê°€] ì¼ë°˜ ìœ ì €ìš© 'ì—­ì‚¬ ì—°êµ¬ ì‚¬ë£Œ ì œì¶œ ê½‚ê¸°' ë²„íŠ¼ (ê²ŒìŠ¤íŠ¸ ì œì™¸)
      if (currentUser && !currentUser.isGuest) {
          const addContributionButton = document.createElement('button');
          addContributionButton.innerText = 'ì—­ì‚¬ ì—°êµ¬ ì‚¬ë£Œ ì œì¶œ';
          addContributionButton.className = 'primary';
          addContributionButton.style.marginTop = '5px';
          addContributionButton.onclick = () => {
              map.closePopup();
              // ê¸°ì—¬ í¼ ì—´ê¸°
              document.getElementById('contribLat').value = latlng.lat;
              document.getElementById('contribLng').value = latlng.lng;
              
              if (contributionMarker) map.removeLayer(contributionMarker);
              contributionMarker = L.marker(latlng).addTo(map);
              
              const form = document.getElementById('contributionForm');
              form.style.display = 'block';
              openForm('contributionForm'); // ì¤‘ì•™ ì •ë ¬
          };
          popupContent.appendChild(addContributionButton);
      }

      L.popup()
        .setLatLng(latlng)
        .setContent(popupContent)
        .openOn(map);
    });

    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    markerTypeSelector.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const type = e.target.dataset.type;
            setActiveMarkerType(type);
        }
    });


    /** ì„± í¸ì§‘ í¼ ì—´ê¸° (ë§ˆì»¤ í´ë¦­ ì‹œ í˜¸ì¶œ) */
    window.openCastleForm = function(id) {
        if (!editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return; 
        const castle = castles.find(c => c._id === id);
        map.closePopup();
        if (!castle) return alert("ì„± ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    try { console.info('DEBUG: opening castle form for', id, castle); } catch (e) {}
        const countryInfo = getCountryInfoById(castle.country_id); 

        editingCastleKey = id;
        closeAllFormsExcept('castleForm');
        openForm('castleForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
        document.getElementById('cloneCastle').style.display = 'inline-block'; // ğŸš© [ì¶”ê°€] í¸ì§‘ ì‹œ ë³µì œ ë²„íŠ¼ í‘œì‹œ
        document.getElementById('deleteCastle').style.display = 'inline-block';
        
        // ğŸš© [ì¶”ê°€] ê¸°ì—¬ ë³€í™˜ ê´€ë ¨ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('originContributionId').value = '';
        document.getElementById('originContributor').value = '';

        // ğŸš© [ìˆ˜ì •] ìƒë‹¨ ëŒ€í‘œ ì´ë¦„ í•„ë“œë§Œ ì±„ì›ë‹ˆë‹¤.
        document.getElementById('castleName').value = castle.name; // ë©”ì¸ ì´ë¦„
        
        document.getElementById('castleLat').value = castle.lat;
        document.getElementById('castleLng').value = castle.lng;
        document.getElementById('castleDesc').value = castle.desc ?? '';
        document.getElementById('castlePhoto').value = castle.photo ?? '';
        // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜ í•„ë“œ ë¡œë“œ
        document.getElementById('customIcon').value = castle.custom_icon ?? '';
        document.getElementById('iconWidth').value = castle.icon_width ?? '';
        document.getElementById('iconHeight').value = castle.icon_height ?? '';
        // ğŸš© [ì¶”ê°€] êµ­ê°€ê°€ ìˆì„ ê²½ìš°, ê¸°ë³¸ íŒŒê´´ ì—°ë„ ì„¤ì •ì„ ìœ„í•œ ê°’ ì €ì¥
        
        // ğŸš© [ì¶”ê°€] ê¸°ì—¬ë¡œ ë˜ëŒë¦¬ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ê²°ì •
        const revertBtn = document.getElementById('revertContributionBtn');
        document.getElementById('originContributionId').value = castle.originContributionId || '';
        if (castle.originContributionId && (currentUser?.role === 'superuser' || currentUser?.role === 'admin')) {
            revertBtn.style.display = 'inline-block';
            revertBtn.onclick = () => revertContribution(castle._id, castle.originContributionId);
        } else {
            revertBtn.style.display = 'none';
        }

        if (countryInfo) {
        }

        // ğŸš© [ìˆ˜ì •] ì²´í¬ë°•ìŠ¤ ëŒ€ì‹  ë§ˆì»¤ íƒ€ì… ì„ íƒê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
        let currentType = 'normal';
        if (castle.is_battle) {
            currentType = 'battle';
        } else if (castle.is_natural_feature) {
            currentType = 'natural';
        } else if (castle.is_military_flag) {
            currentType = 'military';
        } else if (castle.is_label) {
            currentType = 'label';
        }
        console.log('ğŸ° Castle í¼ ì—´ê¸° - castle.is_natural_feature:', castle.is_natural_feature, 'ê²°ì •ëœ íƒ€ì…:', currentType); // ğŸš© [ë””ë²„ê·¸] íƒ€ì… ê²°ì • ê³¼ì • í™•ì¸
        document.getElementById('labelSize').value = castle.label_size || 'medium'; // ğŸš© [ì¶”ê°€] ê¸€ì í¬ê¸° ë¡œë“œ
        setActiveMarkerType(currentType);

        // ğŸš© [ì¶”ê°€] ìì—° ë˜ëŠ” ì§€ëª… íƒ€ì…ì¼ ê²½ìš° êµ­ê°€ í•„ë“œë¥¼ 'ìì—°ì§€ë¬¼'ë¡œ ì„¤ì •
        if (currentType === 'label') {
            document.getElementById('labelColor').value = castle.label_color || '#FFFFFF';
            document.getElementById('labelType').value = castle.label_type || 'place'; // âœ¨ [ì‹ ê·œ] ë¼ë²¨ íƒ€ì… ë¡œë“œ
        }

        // ğŸš© [ìˆ˜ì •] íƒ€ì…ì— ë”°ë¼ ë‹¨ì¼ ê¸°ê°„ í•„ë“œ ì±„ìš°ê¸°
        if (['natural', 'label'].includes(currentType)) {
            document.getElementById('simpleStartYear').value = castle.built_year || '';
            document.getElementById('simpleStartMonth').value = castle.built_month || '';
            document.getElementById('simpleEndYear').value = castle.destroyed_year || '';
            document.getElementById('simpleEndMonth').value = castle.destroyed_month || '';
        }

        // ğŸš© [ìˆ˜ì •] íƒ€ì…ì— ë”°ë¼ ì—­ì‚¬ ê¸°ë¡ ë˜ëŠ” ë‹¨ì¼ ê¸°ê°„ í•„ë“œ ì±„ìš°ê¸°
        if (currentType === 'normal' || currentType === 'battle') { // ğŸš© [ìˆ˜ì •] ì „ì¥ íƒ€ì…ë„ ì—­ì‚¬ ê¸°ë¡ ì‚¬ìš©
            // ì„±/ì™•ì„±/ì „ì¥: ë³µì¡í•œ ì—­ì‚¬ ê¸°ë¡
            const historyListContainer = document.getElementById('castleHistoryList'); 
            historyListContainer.innerHTML = ''; // ì´ˆê¸°í™” 

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ castle.historyê°€ ë¹„ì–´ìˆê±°ë‚˜ ì—†ì„ ê²½ìš°,
            // ìµœìƒìœ„ í•„ë“œ(name, country_id ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ ì—­ì‚¬ ê¸°ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤.
            const baseHistory = (castle.history && castle.history.length > 0)
                ? castle.history
                : [{
                    name: castle.name, country_id: castle.country_id,
                    start_year: castle.built_year, start_month: castle.built_month, end_year: castle.destroyed_year, end_month: castle.destroyed_month, is_capital: castle.is_capital, is_battle: castle.is_battle
                }];

            sortHistoryByStart(baseHistory).forEach(h => {
                addCastleHistoryRow(h);
            });
        } else {
            // ê·¸ ì™¸ íƒ€ì…: ë‹¨ìˆœ ê¸°ê°„ 
            document.getElementById('simpleStartYear').value = castle.built_year || castle.start_year || '';
            document.getElementById('simpleStartMonth').value = castle.built_month || '';
            document.getElementById('simpleEndYear').value = castle.destroyed_year || '';
            document.getElementById('simpleEndMonth').value = castle.destroyed_month || '';

            // êµ°ëŒ€ íƒ€ì… ê´€ë ¨ í•„ë“œ
            if (currentType === 'military') {
                // ğŸš© [ìˆ˜ì •] ìë™ ì™„ì„± input í•„ë“œì— ê°’ ì±„ìš°ê¸°
                militaryCountryId.value = castle.country_id || '';
                militaryCountryNameInput.value = castle.country_id ? getCountryInfoById(castle.country_id)?.name || '' : '';
                generalNameInput.value = castle.general_name || '';
                troopCountInput.value = castle.troop_count || '';
                generalPhotoInput.value = castle.general_photo || '';
                document.getElementById('pathDataList').innerHTML = '';
                if (Array.isArray(castle.path_data)) {
                    castle.path_data.forEach(point => addPathPoint(point));
                }
            } else if (currentType === 'natural') {
                const naturalTypeFromData = castle.natural_feature_type || 'mountain';
                const hasOption = Array.from(naturalFeatureType.options).some(opt => opt.value === naturalTypeFromData);
                naturalFeatureType.value = hasOption ? naturalTypeFromData : 'mountain';
            }
        }
        
        if (editMarker) map.removeLayer(editMarker);
        editMarker = L.marker([castle.lat, castle.lng], { draggable: true }).addTo(map);
        editMarker.on('dragend', (event) => {
            const marker = event.target;
            const position = marker.getLatLng();
            document.getElementById('castleLat').value = position.lat.toFixed(6);
            document.getElementById('castleLng').value = position.lng.toFixed(6);
        });
        // ğŸš© [ìˆ˜ì •] editMarkerê°€ ìœ íš¨í•  ë•Œë§Œ íŒì—…ì„ ì—´ë„ë¡ ìˆ˜ì •
        if (editMarker) {
            editMarker.bindPopup('ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •').openPopup();
        }

        map.setView([castle.lat, castle.lng], map.getZoom());
    };
    
    // êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ê±´ì„¤/íŒŒê´´ ì—°ë„ ìë™ ì±„ìš°ê¸°
    /*
    castleCountrySelect.addEventListener('change', (e) => {
        const selectedCountryId = e.target.value;
        const selectedCountry = getCountryInfoById(selectedCountryId);

        if (selectedCountry) {
            document.getElementById('castleBuilt').value = selectedCountry.start;
            document.getElementById('castleBuiltMonth').value = selectedCountry.start_month || 1;
            document.getElementById('castleDestroyed').value = selectedCountry.end || '';
            document.getElementById('castleDestroyedMonth').value = selectedCountry.end_month || 12;
        } else {
            document.getElementById('castleBuilt').value = yearInput.value;
            document.getElementById('castleDestroyed').value = '';
            document.getElementById('castleDestroyedMonth').value = 12;
        }
    });
    */
    
    // ğŸš© [ì¶”ê°€] ë§ˆì»¤ íƒ€ì… ë²„íŠ¼ ìƒíƒœë¥¼ ì„¤ì •í•˜ê³  ê´€ë ¨ UIë¥¼ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
    function setActiveMarkerType(type) {
        // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
        markerTypeSelector.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
        });
        // ì„ íƒëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
        const activeButton = markerTypeSelector.querySelector(`button[data-type="${type}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }

        // ğŸš© [í•µì‹¬ ìˆ˜ì •] íƒ€ì…ì— ë”°ë¼ UI ìš”ì†Œë“¤ì˜ ê°€ì‹œì„±ì„ ì œì–´í•©ë‹ˆë‹¤.
        const isCastle = (type === 'normal'); // ğŸš© [ìˆ˜ì •] 'capital' íƒ€ì… ì¡°ê±´ ì œê±°
        const isBattle = (type === 'battle'); // ğŸš© [ì¶”ê°€] ì „ì¥ íƒ€ì…
        const isMilitary = (type === 'military');
        const isNatural = (type === 'natural');
        const isLabel = (type === 'label');

        // ì´ë¦„ í•„ë“œ: êµ°ëŒ€ íƒ€ì…ì€ 'ì¥ìˆ˜ ì´ë¦„'ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ìˆ¨ê¹€
        const castleNameInput = document.getElementById('castleName');
        castleNameInput.closest('.form-row').style.display = isMilitary ? 'none' : 'flex';
        // êµ°ëŒ€ íƒ€ì…ì´ë©´ required ì œê±°, ì•„ë‹ˆë©´ required ì¶”ê°€
        if (isMilitary) {
            castleNameInput.removeAttribute('required');
        } else {
            castleNameInput.setAttribute('required', 'required');
        }

        // ë³µì¡í•œ ì—­ì‚¬ ê¸°ë¡ ì„¹ì…˜
        castleHistorySection.style.display = (isCastle || isBattle) ? 'block' : 'none';
        
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] íˆìŠ¤í† ë¦¬ ì„¹ì…˜ì´ ìˆ¨ê²¨ì§ˆ ë•Œ required ì†ì„± ì œê±°
        const historyInputs = castleHistorySection.querySelectorAll('input[required]');
        historyInputs.forEach(input => {
            if (!isCastle && !isBattle) {
                input.removeAttribute('required');
            }
        });

        // ë‹¨ìˆœ ê¸°ê°„ ì„¤ì • ì„¹ì…˜
        simpleDateSection.style.display = (isCastle || isBattle) ? 'none' : 'block';
        document.getElementById('simpleStartMonth').style.display = (isNatural || isLabel) ? 'none' : 'inline-block';
        document.getElementById('simpleEndMonth').style.display = (isNatural || isLabel) ? 'none' : 'inline-block';

        // ğŸš© [ìˆ˜ì •] ì„¤ëª… ë° ì‚¬ì§„ í•„ë“œ ê°€ì‹œì„± ë¡œì§ ë³µì›
        castleDescRow.style.display = (isCastle || isMilitary || isLabel || isBattle) ? 'flex' : 'none';
        castlePhotoRow.style.display = (isCastle || isLabel || isBattle) ? 'flex' : 'none';

        // êµ°ëŒ€ ì „ìš© í•„ë“œ
        militaryFlagDetails.style.display = isMilitary ? 'block' : 'none';
        pathDataSection.style.display = isMilitary ? 'block' : 'none';

        // ğŸš© [ìˆ˜ì •] êµ°ëŒ€ íƒ€ì…ì¼ ë•Œë§Œ ì†Œì† êµ­ê°€ ì…ë ¥ í•„ë“œë¥¼ í•„ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        document.getElementById('militaryCountryNameInput').required = isMilitary;


        // ìì—° ì „ìš© í•„ë“œ
        naturalFeatureDetails.style.display = isNatural ? 'flex' : 'none';

        // ì§€ëª… ì „ìš© í•„ë“œ
        document.getElementById('labelColorRow').style.display = isLabel ? 'flex' : 'none';
        document.getElementById('labelTypeRow').style.display = isLabel ? 'flex' : 'none'; // âœ¨ [ì‹ ê·œ] ë¼ë²¨ íƒ€ì… ì„ íƒ
        document.getElementById('labelSizeRow').style.display = isLabel ? 'flex' : 'none';
    }
    
    // ğŸš© [ì¶”ê°€] ì„± í¸ì§‘ í¼ì— ì—­ì‚¬ ê¸°ë¡ í–‰ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addCastleHistoryRow(history = {}) {
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] ìƒˆ ê¸°ë¡ ì¶”ê°€ ì‹œ, ì´ì „ ê¸°ë¡ì˜ ì¢…ë£Œì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì‹œì‘ì¼ì„ ì„¤ì •í•˜ê³ , ìƒë‹¨ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        if (Object.keys(history).length === 0) { // ìƒˆ ê¸°ë¡ ì¶”ê°€ ì‹œì—ë§Œ (í¸ì§‘ ì‹œì—ëŠ” ì‹¤í–‰ ì•ˆ í•¨)
            const historyRows = document.querySelectorAll('#castleHistoryList .history-record-row');
            
            // ìƒë‹¨ í•„ë“œì˜ ì´ë¦„ì„ ê°€ì ¸ì™€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            history.name = document.getElementById('castleName').value;

            // ğŸš© [ìˆ˜ì •] ìƒˆ ê¸°ë¡ ì¶”ê°€ ì‹œ, ì´ì „ ê¸°ë¡ì˜ ì¢…ë£Œ ì—°ë„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘ ì—°ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
            if (historyRows.length > 0) {
                const lastRow = historyRows[historyRows.length - 1];
                const prevEndYear = parseInt(lastRow.querySelector('input.history-end-year').value || '');
                const prevEndMonth = parseInt(lastRow.querySelector('input.history-end-month').value || '');

                if (!isNaN(prevEndYear) && !isNaN(prevEndMonth)) {
                    history.start_year = (prevEndMonth === 12) ? prevEndYear + 1 : prevEndYear;
                    history.start_month = (prevEndMonth === 12) ? 1 : prevEndMonth + 1;
                }
            } else {
                // ğŸš© [ì¶”ê°€] ì´ì „ ê¸°ë¡ì´ ì—†ì„ ê²½ìš°, í˜„ì¬ ìŠ¬ë¼ì´ë”ì˜ ì—°ì›”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                history.start_year = parseInt(yearInput.value);
                history.start_month = parseInt(monthInput.value);
            }

            // ğŸš© [ì¶”ê°€] ìƒˆ ê¸°ë¡ ì¶”ê°€ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
            history.country_id = '';
            history.end_year = ''; // ë¹ˆ ê°’ìœ¼ë¡œ ì‹œì‘
            history.end_month = 12; // ğŸš© [ìˆ˜ì •] ì¢…ë£Œ ì›” ê¸°ë³¸ê°’ì„ 12ì›”ë¡œ ì„¤ì •
            history.is_capital = false; // ê¸°ë³¸ì ìœ¼ë¡œ ìˆ˜ë„ ì•„ë‹˜
            history.is_battle = false; // ê¸°ë³¸ì ìœ¼ë¡œ ì „ì¥ ì•„ë‹˜
        }

        const container = document.getElementById('castleHistoryList');
        const row = document.createElement('div');
        row.className = 'history-record-row'; 
        row.style.width = '100%'; 

        // ğŸš© [ìˆ˜ì •] êµ­ê°€ëª…ê³¼ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const countryName = history.country_id ? getCountryInfoById(history.country_id)?.name || '' : '';

        // ğŸš© [ìˆ˜ì •] í•œ ì¤„ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½
        // ğŸš© [ìˆ˜ì •] ê° ì…ë ¥ í•„ë“œ ìœ„ì— ë ˆì´ë¸” ì¶”ê°€
        // ğŸš© [í•µì‹¬ ìˆ˜ì •] êµ­ê°€ ì„ íƒì„ <select>ì—ì„œ ìë™ ì™„ì„± <input>ìœ¼ë¡œ ë³€ê²½
        row.innerHTML = `
            <div class="history-field-container history-name"><label>ì´ë¦„</label><input type="text" class="history-name" name="history-name" placeholder="ì´ë¦„" value="${history.name || ''}" required></div>
            <div class="history-field-container history-country" style="position: relative;"><label>êµ­ê°€</label><input type="text" class="history-country-name" placeholder="êµ­ê°€ëª… ì…ë ¥..." autocomplete="off" value="${countryName}"><input type="hidden" class="history-country-id" value="${history.country_id || ''}"><div class="autocomplete-results"></div></div>
            <div class="history-field-container history-start-year"><label>ì‹œì‘ì—°ë„</label><input type="number" class="history-start-year" name="history-start-year" placeholder="ì‹œì‘" value="${history.start_year ?? ''}" required></div>
            <div class="history-field-container history-start-month"><label>ì›”</label><input type="number" class="history-start-month" name="history-start-month" placeholder="ì›”" min="1" max="12" value="${history.start_month || 1}" required></div>
            <span style="align-self: flex-end;">~</span>
            <div class="history-field-container history-end-year"><label>ì¢…ë£Œì—°ë„</label><input type="number" class="history-end-year" placeholder="ì¢…ë£Œ" value="${history.end_year ?? ''}"></div>
            <div class="history-field-container history-end-month"><label>ì›”</label><input type="number" class="history-end-month" placeholder="ì›”" min="1" max="12" value="${history.end_month ?? 12}"></div>
            <div class="history-field-container" style="align-self: flex-end;"><label style="margin-bottom: 8px;">ìˆ˜ë„</label><input type="checkbox" class="history-is-capital" ${history.is_capital ? 'checked' : ''}></div>
            <div class="history-field-container" style="align-self: flex-end;"><label style="margin-bottom: 8px;">ì „ì¥</label><input type="checkbox" class="history-is-battle" ${history.is_battle ? 'checked' : ''}></div>
            <button type="button" onclick="this.parentElement.remove()">X</button>
        `;
                // í¼ ì œì¶œ ì‹œ required ì—ëŸ¬ ë°©ì§€: ë¹ˆ ê°’ì´ë©´ required ì œê±° ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì •
                setTimeout(() => {
                    const startYearInput = row.querySelector('input.history-start-year');
                    if (startYearInput && (startYearInput.value === '' || startYearInput.value == null)) {
                        startYearInput.required = false;
                    }
                }, 0);
                container.appendChild(row);
    }
    // ğŸš© [ì¶”ê°€] 'ì—­ì‚¬ ê¸°ë¡ ì¶”ê°€' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('addCastleHistoryBtn').addEventListener('click', () => addCastleHistoryRow());

    // ğŸš© [ì¶”ê°€] ê¸°ì—¬ë¥¼ ì •ì‹ ì˜¤ë¸Œì íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ê´€ë¦¬ììš©)
    window.convertContribution = (contribId) => {
        const contrib = contributions.find(c => c._id === contribId);
        if (!contrib) return alert("ê¸°ì—¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        // ğŸš© [ì¶”ê°€] ì‚¬ê´€ê¸°ë¡ì¸ ê²½ìš° ì—­ì‚¬ê¸°ë¡ìœ¼ë¡œ ë³€í™˜
        if (contrib.category === 'historical_record') {
            convertHistoricalRecordToHistory(contrib);
            return;
        }

        // ê¸°ì¡´ ë¡œì§: ì¼ë°˜ ê¸°ì—¬ëŠ” ì„±ìœ¼ë¡œ ë³€í™˜
        // ì„± í¸ì§‘ í¼ ì—´ê¸° (ìƒˆ ì˜¤ë¸Œì íŠ¸ ëª¨ë“œ)
        editingCastleKey = null;
        closeAllFormsExcept('castleForm');
        openForm('castleForm');
        addCastleForm.reset();
        
        // ê¸°ì—¬ ë°ì´í„°ë¡œ í¼ ì±„ìš°ê¸°
        document.getElementById('castleName').value = contrib.name;
        document.getElementById('castleLat').value = contrib.lat;
        document.getElementById('castleLng').value = contrib.lng;
        document.getElementById('castleDesc').value = contrib.description + (contrib.evidence ? `\n\n[ì¦ê±°/ì°¸ê³ ] ${contrib.evidence}` : "");
        
        // ğŸš© [í•µì‹¬] ì›ë³¸ ê¸°ì—¬ì ì •ë³´ ì„¤ì •
        document.getElementById('originContributionId').value = contrib._id;
        document.getElementById('originContributor').value = contrib.username;
        
        // ë§ˆì»¤ íƒ€ì… ì„¤ì • (ê¸°ë³¸ê°’: ì„±/ë„ì‹œ)
        setActiveMarkerType('normal');
        
        // ì„ì‹œ ë§ˆì»¤ í‘œì‹œ
        if (editMarker) map.removeLayer(editMarker);
        editMarker = L.marker([contrib.lat, contrib.lng], { draggable: true }).addTo(map);
        map.setView([contrib.lat, contrib.lng], 10);
    };

    // ğŸš© [ì¶”ê°€] ì‚¬ê´€ê¸°ë¡ì„ ì—­ì‚¬ê¸°ë¡ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    window.convertHistoricalRecordToHistory = async (contrib) => {
        try {
            // ì—­ì‚¬ê¸°ë¡ í¼ ë°ì´í„° êµ¬ì„±
            const historyData = {
                year: contrib.year || new Date().getFullYear(),
                month: contrib.month || 1,
                day: contrib.day || 1,
                name: contrib.name || 'ì‚¬ê´€ ê¸°ë¡',
                lat: contrib.lat,
                lng: contrib.lng,
                records: {
                    korean: {
                        content: contrib.content || contrib.description,
                        source: contrib.source || 'ì‚¬ê´€ ê¸°ë¡',
                        contributor: contrib.username,
                        contribution_id: contrib._id
                    }
                },
                is_battle: contrib.is_battle || false,
                contributor: contrib.username,
                contribution_id: contrib._id
            };

            // ì—­ì‚¬ê¸°ë¡ ìƒì„± API í˜¸ì¶œ
            const response = await fetch(`${API_BASE_URL}/history`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(historyData)
            });

            if (!response.ok) {
                throw new Error(`ì—­ì‚¬ê¸°ë¡ ìƒì„± ì‹¤íŒ¨: ${response.status}`);
            }

            // contribution ìƒíƒœë¥¼ approvedë¡œ ë³€ê²½
            const statusResponse = await fetch(`${API_BASE_URL}/contributions/${contrib._id}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status: 'approved' })
            });

            if (!statusResponse.ok) {
                console.warn('Contribution ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', statusResponse.status);
            }

            // ì„±ê³µ ë©”ì‹œì§€
            alert(`ì‚¬ê´€ê¸°ë¡ì´ ì—­ì‚¬ê¸°ë¡ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nê¸°ë¡ëª…: ${contrib.name}\nì œì¶œì: ${contrib.username}`);

            // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            contributions = await fetchData('contributions');
            historyData = await fetchData('history'); // ì—­ì‚¬ê¸°ë¡ ë°ì´í„° ìƒˆë¡œê³ ì¹¨

            // UI ì—…ë°ì´íŠ¸
            displayContributions();

        } catch (error) {
            console.error('ì‚¬ê´€ê¸°ë¡ ë³€í™˜ ì˜¤ë¥˜:', error);
            alert(`ì‚¬ê´€ê¸°ë¡ ë³€í™˜ ì‹¤íŒ¨: ${error.message}`);
        }
    };

    // ğŸš© [ì¶”ê°€] ìŠ¹ì¸ëœ ì˜¤ë¸Œì íŠ¸ë¥¼ ë‹¤ì‹œ ê¸°ì—¬(ëŒ€ê¸° ìƒíƒœ)ë¡œ ë˜ëŒë¦¬ëŠ” í•¨ìˆ˜
    window.revertContribution = async (castleId, contribId) => {
        if (!confirm('ì´ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ìœ ì € ê¸°ì—¬(ëŒ€ê¸° ìƒíƒœ)ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        try {
            // 1. ê¸°ì—¬ ìƒíƒœë¥¼ pendingìœ¼ë¡œ ë³€ê²½
            const statusResponse = await fetch(`${API_BASE_URL}/contributions/${contribId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status: 'pending' })
            });
            
            if (!statusResponse.ok) throw new Error('ê¸°ì—¬ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');

            // 2. ì„± ì˜¤ë¸Œì íŠ¸ ì‚­ì œ
            const deleteResponse = await fetch(`${API_BASE_URL}/castle/${castleId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!deleteResponse.ok) throw new Error('ì˜¤ë¸Œì íŠ¸ ì‚­ì œ ì‹¤íŒ¨');

            // 3. ë©”ëª¨ë¦¬ ë° UI ì—…ë°ì´íŠ¸
            deleteCastleInMemory(castleId);
            document.getElementById('castleForm').style.display = 'none';
            if (editMarker) { map.removeLayer(editMarker); editMarker = null; }

            // 4. ê¸°ì—¬ ë°ì´í„° ìµœì‹ í™” (pending ìƒíƒœì¸ ê¸°ì—¬ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´)
            contributions = await fetchData('contributions');
            
            // 5. ë§µ ê°±ì‹  (ê¸°ì—¬ í•€ ë‹¤ì‹œ í‘œì‹œ)
            const { year, month } = getCurrentYearMonth();
            updateMap(year, month);
            
            alert('ì„±ê³µì ìœ¼ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.');
        } catch (error) {
            console.error(error);
            alert(`ë˜ëŒë¦¬ê¸° ì‹¤íŒ¨: ${error.message}`);
        }
    };

    // ì„± í¼ ì œì¶œ (ì €ì¥/ì—…ë°ì´íŠ¸)
    addCastleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // ğŸš© [í•µì‹¬ ìˆ˜ì •] ìˆ¨ê²¨ì§„ í•„ë“œì˜ required ì†ì„±ì„ ì„ì‹œë¡œ ì œê±°í•˜ì—¬ HTML5 ê²€ì¦ ìš°íšŒ
      const historyRows = document.querySelectorAll('#castleHistoryList .history-record-row');
      historyRows.forEach(row => {
          const nameInput = row.querySelector('input.history-name');
          const startYearInput = row.querySelector('input.history-start-year');
          if (nameInput) nameInput.removeAttribute('required');
          if (startYearInput) startYearInput.removeAttribute('required');
      });
      
      const isUpdate = editingCastleKey !== null;
      const url = isUpdate ? `${API_BASE_URL}/castle/${editingCastleKey}` : `${API_BASE_URL}/castle`;
      const method = isUpdate ? 'PUT' : 'POST';

      const selectedType = markerTypeSelector.querySelector('button.active')?.dataset.type || 'normal'; // ğŸš© [ìˆ˜ì •] 'capital' íƒ€ì… ì¡°ê±´ ì œê±°
      console.log('ğŸ› ï¸ Castle ìˆ˜ì • - ì„ íƒëœ íƒ€ì…:', selectedType); // ğŸš© [ë””ë²„ê·¸] ì„ íƒëœ íƒ€ì… í™•ì¸
// ğŸš© [í•„ìˆ˜ ìˆ˜ì •]: country í•„ë“œë¥¼ ì‚­ì œí•˜ê³  country_idë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
      // ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.

      const data = {
        name: document.getElementById('castleName').value,
        lat: parseFloat(document.getElementById('castleLat').value),
        lng: parseFloat(document.getElementById('castleLng').value),
        photo: document.getElementById('castlePhoto').value || null,
        desc: document.getElementById('castleDesc').value,
        is_capital: false, // ğŸš© [ìˆ˜ì •] ìµœìƒìœ„ is_capitalì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        is_battle: selectedType === 'battle',
        is_military_flag: selectedType === 'military',
        is_natural_feature: selectedType === 'natural',
        is_label: selectedType === 'label',
        label_type: selectedType === 'label' ? (document.getElementById('labelType')?.value || 'place') : null, // âœ¨ [ì‹ ê·œ] ë¼ë²¨ ì„¸ë¶€ íƒ€ì…
        label_color: document.getElementById('labelColor').value,
        label_size: document.getElementById('labelSize').value,
        natural_feature_type: selectedType === 'natural' ? document.getElementById('naturalFeatureType').value : null,
        built_year: selectedType === 'natural' ? (document.getElementById('simpleStartYear').value ? parseInt(document.getElementById('simpleStartYear').value) : null) : null,
        destroyed_year: selectedType === 'natural' ? (document.getElementById('simpleEndYear').value ? parseInt(document.getElementById('simpleEndYear').value) : null) : null,
        custom_icon: document.getElementById('customIcon').value || null, // ğŸš© [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•„ì´ì½˜
        icon_width: document.getElementById('iconWidth').value ? parseInt(document.getElementById('iconWidth').value) : null, // ğŸš© [ì¶”ê°€] ì•„ì´ì½˜ ë„ˆë¹„
        icon_height: document.getElementById('iconHeight').value ? parseInt(document.getElementById('iconHeight').value) : null, // ğŸš© [ì¶”ê°€] ì•„ì´ì½˜ ë†’ì´
        originContributionId: document.getElementById('originContributionId').value || null // ğŸš© [ì¶”ê°€] ì›ë³¸ ê¸°ì—¬ ID ì €ì¥
      };
      console.log('ğŸ“¤ Castle ìˆ˜ì • - ì „ì†¡ ë°ì´í„°:', JSON.stringify(data, null, 2)); // ğŸš© [ë””ë²„ê·¸] ì „ì†¡ ë°ì´í„° í™•ì¸

      if (selectedType === 'normal' || selectedType === 'battle') { // ğŸš© [ìˆ˜ì •] ì „ì¥ íƒ€ì…ë„ ì—­ì‚¬ ê¸°ë¡ ì‚¬ìš©
          const historyRows = document.querySelectorAll('#castleHistoryList .history-record-row');
          const historyData = Array.from(historyRows).map(row => {
              const nameVal = row.querySelector('input.history-name').value;
              // Prefer hidden country id; if missing, attempt lookup by typed country name
              let countryIdVal = row.querySelector('input.history-country-id').value;
              if (!countryIdVal) {
                  const typedName = row.querySelector('input.history-country-name').value?.trim();
                  if (typedName) {
                      const matched = countries.find(c => c.name.toLowerCase() === typedName.toLowerCase());
                      if (matched) countryIdVal = matched._id;
                  }
              }

              const rawStartYear = row.querySelector('input.history-start-year').value;
              const rawStartMonth = row.querySelector('input.history-start-month').value;
              const rawEndYear = row.querySelector('input.history-end-year').value;
              const rawEndMonth = row.querySelector('input.history-end-month').value;

              const isBattleChecked = row.querySelector('input.history-is-battle')?.checked || false;
              console.log('ğŸ” ì „ì¥ ì²´í¬ë°•ìŠ¤ ìƒíƒœ:', isBattleChecked, 'for', nameVal);
              
              return {
                  name: nameVal,
                  country_id: countryIdVal || '', // keep empty string if not found
                  start_year: rawStartYear !== '' ? parseInt(rawStartYear) : null,
                  start_month: rawStartMonth !== '' ? parseInt(rawStartMonth) : 1,
                  end_year: rawEndYear !== '' ? parseInt(rawEndYear) : null,
                  end_month: rawEndMonth !== '' ? parseInt(rawEndMonth) : 12,
                  is_capital: row.querySelector('input.history-is-capital').checked,
                  is_battle: isBattleChecked
              };
          });

          data.history = historyData;
          // í˜¸í™˜ì„±ì„ ìœ„í•´ ì²« ë²ˆì§¸ ê¸°ë¡ì„ ëŒ€í‘œê°’ìœ¼ë¡œ ì €ì¥
          data.country_id = historyData[0]?.country_id;
          data.built_year = historyData[0]?.start_year;
          data.built_month = historyData[0]?.start_month;
          data.destroyed_year = historyData[0]?.end_year;
          data.destroyed_month = historyData[0]?.end_month;
      } else {
          // ë‹¨ìˆœ ê¸°ê°„ íƒ€ì… (ì§€ëª…, ìì—°, êµ°ëŒ€)
          data.history = []; // ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
          data.country_id = null; // ğŸš© [ìˆ˜ì •] country_idë¥¼ nullë¡œ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
          data.built_year = document.getElementById('simpleStartYear').value ? parseInt(document.getElementById('simpleStartYear').value) : null;
          data.built_month = document.getElementById('simpleStartMonth').value ? parseInt(document.getElementById('simpleStartMonth').value) : null;
          data.destroyed_year = document.getElementById('simpleEndYear').value ? parseInt(document.getElementById('simpleEndYear').value) : null;
          data.destroyed_month = document.getElementById('simpleEndMonth').value ? parseInt(document.getElementById('simpleEndMonth').value) : null;
      }

      // ğŸš© [ì¶”ê°€] ìƒì„±ì ë° ìˆ˜ì •ì ì •ë³´ ì¶”ê°€
      if (isUpdate) {
        data.lastModifiedBy = currentUser.username;
      } else {
        // ğŸš© [ìˆ˜ì •] ê¸°ì—¬ ë³€í™˜ì¸ ê²½ìš° ì›ë³¸ ê¸°ì—¬ìë¥¼ ìƒì„±ìë¡œ ì„¤ì •
        const originContributor = document.getElementById('originContributor').value;
        data.createdBy = originContributor || currentUser.username;
      }

      if (data.is_military_flag) {
        data.country_id = militaryCountryId.value; // ğŸš© [ìˆ˜ì •] hidden inputì—ì„œ êµ­ê°€ ID ì €ì¥
        data.name = generalNameInput.value; // êµ°ëŒ€ íƒ€ì…ì€ ì¥ìˆ˜ ì´ë¦„ì„ ë©”ì¸ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
        // ğŸš© ìˆ˜ì •: generalNameInput, troopCountInput, generalPhotoInput ì‚¬ìš©
        data.general_name = generalNameInput.value;
        data.troop_count = parseInt(troopCountInput.value) || 0;
        data.general_photo = generalPhotoInput.value || null; // ë§µí•‘ ë³€ìˆ˜ ì‚¬ìš©
        
        // ğŸš© ê²½ë¡œ ë°ì´í„° ì¶”ê°€
        data.path_data = collectPathData();
      } else {
        data.path_data = [];
      }
      
      if (!data.name || data.lat === undefined || data.lng === undefined) {
          return alert("ì˜¤ë¸Œì íŠ¸ì˜ ì´ë¦„, ìœ„ë„, ê²½ë„ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
      }
      if (data.is_military_flag && !data.country_id) {
          return alert("êµ°ëŒ€ì˜ ì†Œì† êµ­ê°€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
      }
      if (data.is_military_flag && data.path_data.length < 2) {
          alert("ê²½ë¡œ ì§€ì  2ê°œ ë¯¸ë§Œìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ì§€ë„ì—ì„œ êµ°ëŒ€ëŠ” ì´ë™í•˜ì§€ ì•Šê³  ì •ì  ìœ„ì¹˜ì— í‘œì‹œë©ë‹ˆë‹¤.");
      }
      
      // ğŸš© [ë””ë²„ê·¸] ì„œë²„ë¡œ ì „ì†¡ë˜ëŠ” ë°ì´í„° í™•ì¸
      console.log('ğŸ“¤ ì„œë²„ ì „ì†¡ ë°ì´í„°:', JSON.stringify(data, null, 2));
      
      try {
          const response = await fetch(url, {
              method: method,
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(data)
          });

          // ğŸš© [ì¶”ê°€] í† í° ë§Œë£Œ ì²´í¬
          if (handleApiError(response)) return;

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
          }

          // ğŸš© [ì¶”ê°€] ê¸°ì—¬ ë³€í™˜ì´ì—ˆë‹¤ë©´, í•´ë‹¹ ê¸°ì—¬ ìƒíƒœë¥¼ 'approved'ë¡œ ë³€ê²½
          const originContributionId = document.getElementById('originContributionId').value;
          if (originContributionId) {
              try {
                  await fetch(`${API_BASE_URL}/contributions/${originContributionId}/status`, {
                      method: 'PUT',
                      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                      body: JSON.stringify({ status: 'approved' })
                  });
                  // ë©”ëª¨ë¦¬ì—ì„œ í•´ë‹¹ ê¸°ì—¬ ì œê±° (ë” ì´ìƒ pendingì´ ì•„ë‹ˆë¯€ë¡œ)
                  const contribIndex = contributions.findIndex(c => c._id === originContributionId);
                  if (contribIndex !== -1) contributions.splice(contribIndex, 1);
                  console.log('âœ… ê¸°ì—¬ ìŠ¹ì¸ ì²˜ë¦¬ ì™„ë£Œ');
              } catch (err) {
                  console.error('ê¸°ì—¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
              }
          }

          document.getElementById('castleForm').style.display = 'none';
          if (editMarker && map.hasLayer(editMarker) && editMarker.getPopup()) {
              editMarker.closePopup();
          }
          if (editMarker) {
              map.removeLayer(editMarker);
              editMarker = null;
          }
          
          // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì¦ë¶„ ì—…ë°ì´íŠ¸
          const responseData = await response.json();
          console.log('ğŸ“¥ ì„œë²„ ì‘ë‹µ ë°ì´í„°:', responseData);
          
          if (isUpdate) {
              // ìˆ˜ì •ì˜ ê²½ìš°: updateCastleInMemory í•¨ìˆ˜ ì‚¬ìš©
              if (responseData.castle) {
                  await updateCastleInMemory(editingCastleKey, responseData.castle);
              }
          } else {
              // ì¶”ê°€ì˜ ê²½ìš°: addCastleInMemory í•¨ìˆ˜ ì‚¬ìš©
              if (responseData.castle) {
                  addCastleInMemory(responseData.castle);
              }
          }
          
          // ğŸš© [ìˆ˜ì •] ìì—° ì§€í˜•ì§€ë¬¼ì¸ ê²½ìš° updateCastleInMemoryì—ì„œ ì´ë¯¸ ê°œë³„ ì—…ë°ì´íŠ¸í–ˆìœ¼ë¯€ë¡œ ì „ì²´ ë§µ ê°±ì‹  ìƒëµ
          const isNaturalFeature = responseData.castle && responseData.castle.is_natural_feature;
          if (!isNaturalFeature) {
              // ë§µ ì—…ë°ì´íŠ¸ (ê¸°ì—¬ í•€ ì œê±° ë° ìƒˆ ì˜¤ë¸Œì íŠ¸ í‘œì‹œ)
              const { year, month } = getCurrentYearMonth();
              updateMap(year, month);
          } else {
              console.log('ğŸŒ³ ìì—° ì§€í˜•ì§€ë¬¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ, ì „ì²´ ë§µ ê°±ì‹  ìƒëµ');
          }
      } catch (error) {
        console.error("Castle ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
        alert(`Castle ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
      }
    });

    // ì„± í¼ ì·¨ì†Œ
    cancelCastle.addEventListener('click', () => {
      document.getElementById('castleForm').style.display = 'none';
      // ğŸš© [ì¶”ê°€] ë§ˆì»¤ì˜ íŒì—…ì„ ëª…ì‹œì ìœ¼ë¡œ ë‹«ì€ í›„ ë ˆì´ì–´ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
      if (editMarker && map.hasLayer(editMarker) && editMarker.getPopup()) {
          editMarker.closePopup();
      }
      if (editMarker) {
        map.removeLayer(editMarker);
        editMarker = null;
      }
    });

    // ì„± íœ´ì§€í†µìœ¼ë¡œ ì´ë™
    deleteCastle.addEventListener('click', async () => {
        if (!editingCastleKey) return;

        if (!confirm('ì •ë§ë¡œ ì´ ì„±/ì „ì¥ ì •ë³´ë¥¼ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(íœ´ì§€í†µì—ì„œ ë³µì›í•˜ê±°ë‚˜ ì˜êµ¬ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/castle/${editingCastleKey}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}` // ğŸš© [ìˆ˜ì •] ì‚­ì œ ìš”ì²­ì—ë„ í† í° ì¶”ê°€
                }
            });

            // ğŸš© [ì¶”ê°€] í† í° ë§Œë£Œ ì²´í¬
            if (handleApiError(response)) return;

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const result = await response.json();
            alert(result.message || 'íœ´ì§€í†µìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì„± ì‚­ì œ ì„±ê³µ í›„, ì„ì‹œ í¸ì§‘ ë§ˆì»¤ì™€ íŒì—…ì„ ì œê±°í•©ë‹ˆë‹¤.
            if (editMarker && map.hasLayer(editMarker) && editMarker.getPopup()) {
                editMarker.closePopup();
            }
            if (editMarker) {
                map.removeLayer(editMarker);
                editMarker = null;
            }
            document.getElementById('castleForm').style.display = 'none';

            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
            deleteCastleInMemory(editingCastleKey);
        } catch (error) {
            console.error("Castle íœ´ì§€í†µ ì´ë™ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Castle íœ´ì§€í†µ ì´ë™ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    // ğŸš© [ì¶”ê°€] ì„±/ì§€ë¬¼ ë³µì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('cloneCastle').addEventListener('click', () => {
        if (!editingCastleKey) return;

        const originalCastleName = document.getElementById('castleName').value;
        
        // ë³µì œ ëª¨ë“œë¡œ ì „í™˜
        editingCastleKey = null; // ìƒˆ í•­ëª©ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•´ í‚¤ë¥¼ nullë¡œ ì„¤ì •

        // UI ì—…ë°ì´íŠ¸
        document.querySelector('#castleForm h3').textContent = `'${originalCastleName}' ë³µì œí•˜ì—¬ ì •ë³´ ì¶”ê°€`;
        document.getElementById('deleteCastle').style.display = 'none';
        document.getElementById('cloneCastle').style.display = 'none';
        document.querySelector('#addCastleForm button[type="submit"]').textContent = 'ì¶”ê°€';

        // ğŸš© [ìˆ˜ì •] ì—­ì‚¬ ê¸°ë¡ í–‰ ì¶”ê°€ ì œê±° - ê¸°ì¡´ ë°ì´í„°ë§Œ ìœ ì§€
        alert(`'${originalCastleName}'ì˜ ë³µì œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  'ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
    });

    /** êµ­ê°€ ëª©ë¡ì„ ì„±/ìœ„ì¹˜ í¼ì˜ <select>ì— ì—…ë°ì´íŠ¸ */
    function updateCountrySelect() {
      // ì´ í•¨ìˆ˜ëŠ” ì´ì œ addCastleHistoryRow ë‚´ë¶€ì—ì„œ ë™ì ìœ¼ë¡œ í˜¸ì¶œë˜ë¯€ë¡œ, ì „ì—­ ì—…ë°ì´íŠ¸ëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤.
    }

    // ì§€ë„ ê²€ìƒ‰ ê¸°ëŠ¥ (ì´ë™ë§Œ)
    if (searchBtn) {
        searchBtn.addEventListener('click', async () => {
        const query = searchInput.value.trim().toLowerCase();
    if (!query) return;

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê²€ìƒ‰ ë¡œì§ ë³€ê²½: ì§€ì—­ëª…ê³¼ ì—­ì‚¬ ê¸°ë¡ì„ ëª¨ë‘ ê²€ìƒ‰
    if (query !== lastSearchQuery) {
        // ìƒˆë¡œìš´ ê²€ìƒ‰ì–´ì¼ ê²½ìš°
        // ğŸš© [ìˆ˜ì •] ëª¨ë“  ê°ì²´(ì„±, êµ°ëŒ€, ìì—°ì§€ë¬¼ ë“±)ì˜ ì´ë¦„ê³¼ ì¥ìˆ˜ ì´ë¦„ê¹Œì§€ ê²€ìƒ‰í•˜ë„ë¡ í•„í„°ë§ ì¡°ê±´ í™•ì¥
        const matchingCastles = castles
            .filter(c => 
                (c.name && c.name.toLowerCase().includes(query)) ||
                (c.general_name && c.general_name.toLowerCase().includes(query))
            )
            .map(c => ({ type: 'castle', data: c, year: c.built_year || c.built || 0 }));

        const matchingHistory = history
            .filter(h =>
                (h.event_name && h.event_name.toLowerCase().includes(query)) ||
                (h.records?.korean?.content && h.records.korean.content.toLowerCase().includes(query)) ||
                (h.records?.foreign?.content && h.records.foreign.content.toLowerCase().includes(query)) ||
                (h.records?.true_history?.content && h.records.true_history.content.toLowerCase().includes(query))
            )
            .map(h => ({ type: 'history', data: h, year: h.year }));

        // ğŸš© [ì¶”ê°€] ê·¸ë ¤ì§„ ì§€í˜•/ì§€ë¬¼(ê°•, ì„±ê³½ ë“±)ì˜ ì´ë¦„ë„ ê²€ìƒ‰ ëŒ€ìƒì— í¬í•¨
        const matchingDrawings = drawings
            .filter(d => d.name && d.name.toLowerCase().includes(query))
            .map(d => ({ type: 'drawing', data: d, year: d.start_year || 0 }));

        const combinedResults = [...matchingCastles, ...matchingHistory, ...matchingDrawings];

        if (combinedResults.length === 0) {
            alert(`"${query}"ì— í•´ë‹¹í•˜ëŠ” ì§€ì—­, ì¸ë¬¼, ì§€í˜• ë˜ëŠ” ì—­ì‚¬ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            lastSearchQuery = '';
            lastSearchResults = [];
            lastSearchIndex = -1;
            return;
        }

        // ê²°ê³¼ë¥¼ ì—°ë„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì €ì¥
        lastSearchResults = combinedResults.sort((a, b) => a.year - b.year);
        lastSearchQuery = query;
        lastSearchIndex = 0;
    } else {
        // ë™ì¼í•œ ê²€ìƒ‰ì–´ì¼ ê²½ìš°, ë‹¤ìŒ ê²°ê³¼ë¡œ ì¸ë±ìŠ¤ ì´ë™
        if (lastSearchResults.length === 0) return; // ì´ì „ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
        lastSearchIndex = (lastSearchIndex + 1) % lastSearchResults.length;
    }

    // í˜„ì¬ ì¸ë±ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ê²°ê³¼ë¡œ ì§€ë„ ë° ì‹œê°„ ì—…ë°ì´íŠ¸
    const currentResult = lastSearchResults[lastSearchIndex];
    
    if (currentResult.type === 'castle') {
        const castle = currentResult.data;
        const year = castle.built_year || castle.built;
        const month = castle.built_month || 1;
        if (year) updateTime(year, month);
        map.flyTo([castle.lat, castle.lng], 10);
    } else if (currentResult.type === 'history') {
        const historyItem = currentResult.data;
        const year = historyItem.year;
        const month = historyItem.month || 1;
        if (year) updateTime(year, month);
        // ì—­ì‚¬ ê¸°ë¡ì€ íŠ¹ì • ì¢Œí‘œê°€ ì—†ìœ¼ë¯€ë¡œ ì§€ë„ ì´ë™ì€ í•˜ì§€ ì•ŠìŒ
    } else if (currentResult.type === 'drawing') {
        const drawing = currentResult.data;
        const year = drawing.start_year;
        if (year) updateTime(year, 1); // ì›”ì€ 1ì›”ë¡œ ê³ ì •

        // GeoJSON ë°ì´í„°ì˜ ì¤‘ì‹¬ì ì„ ê³„ì‚°í•˜ì—¬ ì´ë™
        const tempLayer = L.geoJSON(drawing.geojson);
        const bounds = tempLayer.getBounds();
        if (bounds.isValid()) {
            map.flyTo(bounds.getCenter(), 8);
        }
    }
        }); // ğŸš© [ìˆ˜ì •] searchBtn.addEventListener ì¢…ë£Œ
    } // ğŸš© [ìˆ˜ì •] searchBtn ì¡´ì¬ ì—¬ë¶€ ì²´í¬ ì¢…ë£Œ
    
    // ğŸš© [ì¶”ê°€] ê²€ìƒ‰ì°½ì—ì„œ ì—”í„° í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
    if (searchInput && searchBtn) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // í¼ ì œì¶œ ë“± ê¸°ë³¸ ë™ì‘ ë°©ì§€
                searchBtn.click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
            }
        });
    }

    // ğŸš© [ì¶”ê°€] ë©”ì¸ ê²€ìƒ‰ì°½ ìë™ ì™„ì„± ê¸°ëŠ¥
    const mainSearchResults = document.getElementById('mapSearchResults'); // ğŸš© [ìˆ˜ì •] ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ ê²°ê³¼

    if (searchInput) {
        searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim().toLowerCase();
        mainSearchResults.innerHTML = '';

        if (query.length === 0) {
            mainSearchResults.style.display = 'none';
            return;
        }

        // ê²€ìƒ‰ ë¡œì§ (ê¸°ì¡´ searchBtn í´ë¦­ ì´ë²¤íŠ¸ì™€ ìœ ì‚¬)
        const matchingCastles = castles
            .filter(c => (c.name && c.name.toLowerCase().includes(query)) || (c.general_name && c.general_name.toLowerCase().includes(query)))
            .map(c => ({ type: 'castle', text: `[ì„±/ë„ì‹œ] ${c.name} (${c.built_year || c.built || 0}ë…„)`, data: c }));

        const matchingHistory = history
            .filter(h => (h.event_name && h.event_name.toLowerCase().includes(query)) || (h.records?.korean?.content && h.records.korean.content.toLowerCase().includes(query)) || (h.records?.foreign?.content && h.records.foreign.content.toLowerCase().includes(query)) || (h.records?.true_history?.content && h.records.true_history.content.toLowerCase().includes(query)))
            .map(h => ({ type: 'history', text: `[ì—­ì‚¬] ${h.event_name} (${h.year}ë…„)`, data: h }));

        const matchingDrawings = drawings
            .filter(d => d.name && d.name.toLowerCase().includes(query))
            .map(d => ({ type: 'drawing', text: `[ì§€í˜•] ${d.name} (${d.start_year || 0}ë…„)`, data: d }));

        const combinedResults = [...matchingCastles, ...matchingHistory, ...matchingDrawings]
            .sort((a, b) => (a.data.year || a.data.built_year || a.data.start_year || 0) - (b.data.year || b.data.built_year || b.data.start_year || 0));

        if (combinedResults.length === 0) {
            mainSearchResults.style.display = 'none';
            return;
        }

        combinedResults.forEach(result => {
            const div = document.createElement('div');
            div.textContent = result.text;
            div.style.padding = '10px 12px';
            div.style.cursor = 'pointer';
            div.style.fontSize = '14px';
            div.style.borderBottom = '1px solid #5d7185';
            div.onmouseover = () => div.style.backgroundColor = '#5d7185';
            div.onmouseout = () => div.style.backgroundColor = '';
            div.onclick = () => {
                // í•­ëª© í´ë¦­ ì‹œ ë™ì‘ (ê¸°ì¡´ searchBtn ë¡œì§ê³¼ ë™ì¼)
                if (result.type === 'castle') {
                    const castle = result.data;
                    const year = castle.built_year || castle.built;
                    const month = castle.built_month || 1;
                    if (year) updateTime(year, month);
                    map.flyTo([castle.lat, castle.lng], 10);
                } else if (result.type === 'history') {
                    const historyItem = result.data;
                    if (historyItem.year) updateTime(historyItem.year, historyItem.month || 1);
                } else if (result.type === 'drawing') {
                    const drawing = result.data;
                    if (drawing.start_year) updateTime(drawing.start_year, 1);
                    const tempLayer = L.geoJSON(drawing.geojson);
                    const bounds = tempLayer.getBounds();
                    if (bounds.isValid()) map.flyTo(bounds.getCenter(), 8);
                }
                searchInput.value = '';
                mainSearchResults.style.display = 'none';
            };
            mainSearchResults.appendChild(div);
        });

        mainSearchResults.style.display = 'block';
    });
    } // ğŸš© [ìˆ˜ì •] searchInput ì¡´ì¬ ì—¬ë¶€ ì²´í¬ ì¢…ë£Œ

    // ğŸš© [ì¶”ê°€] ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ í•„í„° ê¸°ëŠ¥ ì—°ë™
    const mapSearchInput = document.getElementById('mapSearchInput');
    const mapSearchBtn = document.getElementById('mapSearchBtn');
    const mapSearchResults = document.getElementById('mapSearchResults');
    
    // ì§€ë„ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ê¸°ì¡´ searchBtnê³¼ ë™ì¼í•œ ë™ì‘
    if (mapSearchBtn) {
        mapSearchBtn.addEventListener('click', () => {
            searchInput.value = mapSearchInput.value;
            searchBtn.click();
        });
    }
    
    // ì§€ë„ ê²€ìƒ‰ ì…ë ¥ì°½ì—ì„œ ì—”í„° í‚¤ ì…ë ¥ ì‹œ
    if (mapSearchInput) {
        mapSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchInput.value = mapSearchInput.value;
                searchBtn.click();
            }
        });
        
        // ìë™ì™„ì„± ê¸°ëŠ¥
        mapSearchInput.addEventListener('input', () => {
            const query = mapSearchInput.value.trim().toLowerCase();
            mapSearchResults.innerHTML = '';
            
            if (query.length === 0) {
                mapSearchResults.style.display = 'none';
                return;
            }
            
            const matchingCastles = castles
                .filter(c => 
                    (c.name && c.name.toLowerCase().includes(query)) ||
                    (c.general_name && c.general_name.toLowerCase().includes(query))
                )
                .slice(0, 5);
            
            const matchingHistory = history
                .filter(h => h.event_name && h.event_name.toLowerCase().includes(query))
                .slice(0, 5);
            
            const matchingDrawings = drawings
                .filter(d => d.name && d.name.toLowerCase().includes(query))
                .slice(0, 3);
            
            const allResults = [...matchingCastles, ...matchingHistory, ...matchingDrawings];
            
            if (allResults.length === 0) {
                mapSearchResults.style.display = 'none';
                return;
            }
            
            allResults.forEach(item => {
                const div = document.createElement('div');
                div.style.padding = '8px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #5d7185';
                
                if (item.name) {
                    div.textContent = `${item.name} (${item.built_year || item.start_year || '?'}ë…„)`;
                } else if (item.event_name) {
                    div.textContent = `${item.event_name} (${item.year}ë…„)`;
                }
                
                div.addEventListener('mouseenter', () => div.style.backgroundColor = '#2c3e50');
                div.addEventListener('mouseleave', () => div.style.backgroundColor = 'transparent');
                
                div.onclick = () => {
                    mapSearchInput.value = item.name || item.event_name;
                    searchInput.value = mapSearchInput.value;
                    searchBtn.click();
                    mapSearchResults.style.display = 'none';
                };
                
                mapSearchResults.appendChild(div);
            });
            
            mapSearchResults.style.display = 'block';
        });
    }
    
    // --- 9. êµ­ê°€ í¸ì§‘ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    
    function updateCountrySelectForEdit() {
        const select = countrySelectForEdit;
        // ğŸš© [ìˆ˜ì •] êµ­ê°€ ëª©ë¡ì— ë¯¼ì¡± ì •ë³´ í‘œì‹œ
        select.innerHTML = '<option value="">--- ê¸°ì¡´ êµ­ê°€ ì„ íƒ ---</option>' +
            countries.map(c => `<option value="${c.name}">${c.name}${c.ethnicity ? ` (${c.ethnicity})` : ''}</option>`).join('');
    }

    countrySelectForEdit.addEventListener('change', () => {
        const name = countrySelectForEdit.value;
        if (!name) {
            document.getElementById('editCountryForm').reset();
            document.getElementById('countryOriginalName').value = '';
            document.getElementById('countryOriginalId').value = '';
            document.getElementById('deleteCountryBtn').style.display = 'none';
            document.getElementById('saveCountryBtn').textContent = 'ì €ì¥';
            return;
        }
        
        const country = getCountryInfo(name);
        if (!country) return;

        document.getElementById('countryOriginalName').value = country.name;
        document.getElementById('countryOriginalId').value = country._id;
        document.getElementById('countryName').value = country.name;
        document.getElementById('countryStart').value = country.start;
        document.getElementById('countryStartMonth').value = country.start_month || 1;
        document.getElementById('countryEnd').value = country.end;
        document.getElementById('countryEndMonth').value = country.end_month || 12;
        document.getElementById('countryColor').value = country.color || '#ffffff'; // ğŸš© [ìˆ˜ì •] country.colorê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’(#ffffff)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        document.getElementById('countryFlag').value = country.flag || '';
        document.getElementById('countryEthnicity').value = country.ethnicity || '';
        document.getElementById('isMainDynasty').checked = country.is_main_dynasty || false;
        document.getElementById('countrySealText').value = country.sealText || '';

        document.getElementById('deleteCountryBtn').style.display = 'inline-block';
        document.getElementById('saveCountryBtn').textContent = 'ì €ì¥';
    });
    
    // ğŸš© [ìˆ˜ì •] êµ­ê°€ í¸ì§‘ í¼ ë‚´ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ìë™ ì™„ì„± ë°©ì‹ìœ¼ë¡œ ë³€ê²½
    const countrySearchInputForEdit = document.getElementById('countrySearchForEdit');
    const countrySearchResults = document.getElementById('countrySearchResults');

    countrySearchInputForEdit.addEventListener('input', () => {
        const searchTerm = countrySearchInputForEdit.value.toLowerCase();
        countrySearchResults.innerHTML = '';
        if (searchTerm.length === 0) {
            countrySearchResults.style.display = 'none';
            return;
        }

        const filteredCountries = countries.filter(c => 
            c.name.toLowerCase().includes(searchTerm) || 
            (c.ethnicity && c.ethnicity.toLowerCase().includes(searchTerm))
        );

        filteredCountries.forEach(country => {
            const div = document.createElement('div');
            div.textContent = `${country.name}${country.ethnicity ? ` (${country.ethnicity})` : ''}`;
            div.style.padding = '8px';
            div.style.cursor = 'pointer';
            div.onmouseover = () => div.style.backgroundColor = '#5d7185';
            div.onmouseout = () => div.style.backgroundColor = '';
            div.onclick = () => {
                countrySearchInputForEdit.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                countrySelectForEdit.value = country.name; // select íƒœê·¸ ê°’ ë³€ê²½
                countrySelectForEdit.dispatchEvent(new Event('change')); // change ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
                countrySearchResults.style.display = 'none'; // ê²°ê³¼ ëª©ë¡ ìˆ¨ê¸°ê¸°
            };
            countrySearchResults.appendChild(div);
        });
        countrySearchResults.style.display = filteredCountries.length > 0 ? 'block' : 'none';
    });

    document.getElementById('editCountryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const originalName = document.getElementById('countryOriginalName').value;
        const originalId = document.getElementById('countryOriginalId').value;
        const newName = document.getElementById('countryName').value;
        const isUpdate = !!originalName;
        
        const data = {
            name: newName,
            start: parseInt(document.getElementById('countryStart').value),
            start_month: parseInt(document.getElementById('countryStartMonth').value) || 1,
            end: document.getElementById('countryEnd').value ? parseInt(document.getElementById('countryEnd').value) : null,
            end_month: parseInt(document.getElementById('countryEndMonth').value) || 12,
            color: document.getElementById('countryColor').value,
            flag: document.getElementById('countryFlag').value || null,
            ethnicity: document.getElementById('countryEthnicity').value || null,
            is_main_dynasty: document.getElementById('isMainDynasty').checked,
            sealText: document.getElementById('countrySealText').value.trim() || null
        };
        
        if (!data.name || isNaN(data.start) || !data.color) {
            return alert("êµ­ê°€ ì´ë¦„, ì‹œì‘ ì—°ë„, ìƒ‰ìƒì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        try {
            // ğŸš© [ìˆ˜ì •] í† í° ê°€ì ¸ì˜¤ê¸°
            const token = getToken();
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // ğŸš© [ì¶”ê°€] í† í° ë””ì½”ë”©í•˜ì—¬ ê¶Œí•œ í™•ì¸
            const payload = parseJwt(token);
            if (!payload || (payload.role !== 'admin' && payload.role !== 'superuser')) {
                alert('â›” êµ­ê°€ ì •ë³´ ìˆ˜ì •ì€ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n\ní˜„ì¬ ê³„ì •: ' + (payload?.username || 'ì•Œ ìˆ˜ ì—†ìŒ') + '\nê¶Œí•œ: ' + (payload?.role || 'ì—†ìŒ') + '\n\nê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            let url = `${API_BASE_URL}/countries`;
            let method = 'POST';

            if (isUpdate) {
                // ğŸš© [ìˆ˜ì •] _id ê¸°ë°˜ PUTìœ¼ë¡œ ë³€ê²½ (ì´ë¦„ ë³€ê²½ ì‹œì—ë„ ì•ˆì „)
                const identifier = originalId || originalName;
                url = `${API_BASE_URL}/countries/${encodeURIComponent(identifier)}`; 
                method = 'PUT';
            }
            
            const response = await fetch(url, {
                method: method,
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // ğŸš© [ìˆ˜ì •] ì¸ì¦ í† í° ì¶”ê°€
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            alert(isUpdate ? "êµ­ê°€ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ìƒˆ êµ­ê°€ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì¦ë¶„ ì—…ë°ì´íŠ¸
            if (isUpdate) {
                updateCountryInMemory(originalId || originalName, data);
            } else {
                const responseData = await response.json();
                addCountryInMemory({ ...data, _id: responseData.id });
            }

            // ğŸš© [ìˆ˜ì •] í¼ í•„ë“œë¥¼ ë¦¬ì…‹í•©ë‹ˆë‹¤.
            document.getElementById('editCountryForm').reset();
            document.getElementById('countryOriginalName').value = '';
            document.getElementById('countryOriginalId').value = '';
            document.getElementById('deleteCountryBtn').style.display = 'none';
            document.getElementById('saveCountryBtn').textContent = 'ì €ì¥/ì¶”ê°€';
            document.getElementById('countryColor').value = '#ffffff'; // ìƒ‰ìƒ ê¸°ë³¸ê°’
            document.getElementById('countrySearchForEdit').value = ''; // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
            document.getElementById('countrySealText').value = ''; // ë‚™ì¸ ê¸€ì”¨ ì´ˆê¸°í™”

            // ğŸš© [ìˆ˜ì •] ìˆ˜ì •í–ˆë˜ êµ­ê°€ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì¤ë‹ˆë‹¤.
            document.getElementById('countrySelectForEdit').value = newName;

        } catch (error) {
            console.error("Country ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Country ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    document.getElementById('deleteCountryBtn').addEventListener('click', async () => {
        const originalName = document.getElementById('countryOriginalName').value;
        const originalId = document.getElementById('countryOriginalId').value;
        if (!originalName || !confirm('ì •ë§ë¡œ ì´ êµ­ê°€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ë‹¹ êµ­ê°€ì˜ ëª¨ë“  ì„±/ì „ì¥ ì •ë³´ëŠ” ìœ ì§€ë˜ì§€ë§Œ êµ­ê°€ ì •ë³´ê°€ ì—†ì–´ì§‘ë‹ˆë‹¤.')) return;
        try {
            // ğŸš© [ìˆ˜ì •] í† í° ê°€ì ¸ì˜¤ê¸°
            const token = getToken();
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // ğŸš© [ì¶”ê°€] í† í° ë””ì½”ë”©í•˜ì—¬ ê¶Œí•œ í™•ì¸
            const payload = parseJwt(token);
            if (!payload || (payload.role !== 'admin' && payload.role !== 'superuser')) {
                alert('â›” êµ­ê°€ ì •ë³´ ì‚­ì œëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n\ní˜„ì¬ ê³„ì •: ' + (payload?.username || 'ì•Œ ìˆ˜ ì—†ìŒ') + '\nê¶Œí•œ: ' + (payload?.role || 'ì—†ìŒ') + '\n\nê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ğŸš© [ìˆ˜ì •] _id ê¸°ë°˜ ì‚­ì œë¡œ ë³€ê²½
            const identifier = originalId || originalName;
            const response = await fetch(`${API_BASE_URL}/countries/${encodeURIComponent(identifier)}`, { 
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            document.getElementById('countryForm').style.display = 'none';
            
            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
            deleteCountryInMemory(originalId || originalName);
        } catch (error) {
            console.error("Country ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`Country ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    document.getElementById('cancelCountryBtn').addEventListener('click', () => {
        document.getElementById('countryForm').style.display = 'none';
    });

    // --- 10. ì´ë²¤íŠ¸ í¸ì§‘ í¼ ê´€ë¦¬ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function populateEventSelect() {
        const select = document.getElementById('eventSelect');
        // ğŸš© [ìˆ˜ì •] ì—°ë„ ìˆœìœ¼ë¡œ ì •ë ¬
        events.sort((a, b) => a.year - b.year || a.month - b.month);
        select.innerHTML = '<option value="">--- ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ---</option>' +
            events.map(event => `<option value="${event._id}">${event.year}ë…„: ${event.text}</option>`).join('');
    }

    document.getElementById('eventSelect').addEventListener('change', (e) => {
        const eventId = e.target.value;
        const form = document.getElementById('editEventForm');
        const deleteBtn = document.getElementById('deleteEventBtn');
        const saveBtn = document.getElementById('saveEventBtn');

        if (!eventId) {
            form.reset();
            document.getElementById('eventMongoId').value = '';
            deleteBtn.style.display = 'none';
            saveBtn.textContent = 'ì €ì¥/ì¶”ê°€';
            return;
        }

        const event = events.find(ev => ev._id === eventId);
        if (event) {
            document.getElementById('eventMongoId').value = event._id;
            document.getElementById('eventYear').value = event.year;
            document.getElementById('eventMonth').value = event.month || 1;
            document.getElementById('eventText').value = event.text;
            document.getElementById('eventPhoto').value = event.photo || ''; // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL í•„ë“œ ì±„ìš°ê¸°
            deleteBtn.style.display = 'inline-block';
            saveBtn.textContent = 'ì €ì¥';
        }
    });

    document.getElementById('editEventForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const eventId = document.getElementById('eventMongoId').value;
        const isUpdate = !!eventId;
        const url = isUpdate ? `${API_BASE_URL}/events/${eventId}` : `${API_BASE_URL}/events`;
        const method = isUpdate ? 'PUT' : 'POST';

        const data = {
            year: parseInt(document.getElementById('eventYear').value),
            month: parseInt(document.getElementById('eventMonth').value) || 1,
            text: document.getElementById('eventText').value,
            photo: document.getElementById('eventPhoto').value || null, // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL ë°ì´í„° ìˆ˜ì§‘
        };

        if (isNaN(data.year) || !data.text) {
            return alert("ì—°ë„ì™€ ì´ë²¤íŠ¸ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        }

        try {
            const response = await fetch(url, { 
                method: method, 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                body: JSON.stringify(data) 
            });
            if (!response.ok) throw new Error('ì´ë²¤íŠ¸ ì €ì¥ ì‹¤íŒ¨');
            
            document.getElementById('eventForm').style.display = 'none';
            
            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì¦ë¶„ ì—…ë°ì´íŠ¸
            if (eventId) {
                updateEventInMemory(eventId, data);
            } else {
                const responseData = await response.json();
                addEventInMemory({ ...data, _id: responseData.id });
            }
        } catch (error) { alert(error.message); }
    });

    document.getElementById('deleteEventBtn').addEventListener('click', async () => {
        const eventId = document.getElementById('eventMongoId').value;
        if (!eventId || !confirm('ì´ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try { 
            const response = await fetch(`${API_BASE_URL}/events/${eventId}`, { 
                method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } 
            });
            if (!response.ok) throw new Error('ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨');
            
            document.getElementById('eventForm').style.display = 'none';
            
            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
            deleteEventInMemory(eventId);
        } catch (error) { alert(error.message); }
    });

    document.getElementById('cancelEventBtn').addEventListener('click', () => { document.getElementById('eventForm').style.display = 'none'; });

    // --- 10. ì™• í¸ì§‘ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)

    // ğŸš© [ìˆ˜ì •] ì™• í¸ì§‘ í¼ì˜ êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateKingCountrySelect() {
        const select = document.getElementById('kingCountrySelect');
        if (!select) return;
        select.innerHTML = '<option value="">-- ëª©ë¡ì—ì„œ ì„ íƒ --</option>' + 
            countries.map(c => `<option value="${c._id}">${c.name}${c.ethnicity ? ` (${c.ethnicity})` : ''}</option>`).join('');
    }

    // ğŸš© [ì¶”ê°€] êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ, ì…ë ¥ì°½ê³¼ IDë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('kingCountrySelect').addEventListener('change', (e) => {
        const countryId = e.target.value;
        const country = getCountryInfoById(countryId);
        
        document.getElementById('kingCountryId').value = countryId;
        document.getElementById('kingCountryNameInput').value = country ? country.name : '';
        
        if (countryId) {
            loadKingsForCountry();
        }
    });
    
    // ğŸš© [ìˆ˜ì •] ì™• í¸ì§‘ í¼ì˜ êµ­ê°€ ê²€ìƒ‰ ìë™ ì™„ì„± ê¸°ëŠ¥ (ë“œë¡­ë‹¤ìš´ê³¼ ì—°ë™)
    const kingCountryNameInput = document.getElementById('kingCountryNameInput');
    const kingCountryResults = document.getElementById('kingCountryResults');
    const kingCountryIdInput = document.getElementById('kingCountryId');

    kingCountryNameInput.addEventListener('input', () => {
        const searchTerm = kingCountryNameInput.value.toLowerCase();
        kingCountryResults.innerHTML = '';
        if (searchTerm.length === 0) {
            kingCountryResults.style.display = 'none';
            return;
        }

        const filteredCountries = countries.filter(c => c.name.toLowerCase().includes(searchTerm));
        
        filteredCountries.forEach(country => {
            const div = document.createElement('div');
            div.textContent = `${country.name}${country.ethnicity ? ` (${country.ethnicity})` : ''}`;
            div.style.padding = '8px';
            div.style.cursor = 'pointer';
            div.onmouseover = () => div.style.backgroundColor = '#5d7185';
            div.onmouseout = () => div.style.backgroundColor = '';
            div.onclick = () => {
                kingCountryNameInput.value = country.name;
                kingCountryIdInput.value = country._id;
                document.getElementById('kingCountrySelect').value = country._id; // ğŸš© [ì¶”ê°€] ë“œë¡­ë‹¤ìš´ë„ í•¨ê»˜ ë³€ê²½
                kingCountryResults.style.display = 'none';
                loadKingsForCountry(); // êµ­ê°€ê°€ ì„ íƒë˜ì—ˆìœ¼ë¯€ë¡œ ì™• ëª©ë¡ì„ ë¡œë“œí•©ë‹ˆë‹¤.
            };
            kingCountryResults.appendChild(div);
        });

        kingCountryResults.style.display = filteredCountries.length > 0 ? 'block' : 'none';
    });

    // ì…ë ¥ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ëª©ë¡ ìˆ¨ê¸°ê¸°
    document.addEventListener('click', (e) => {
        if (e.target !== kingCountryNameInput && e.target !== kingCountryResults) {
            kingCountryResults.style.display = 'none';
        }
    });

    function loadKingsForCountry(resetForm = false) {
        // ğŸš© [ìˆ˜ì •] ìˆ¨ê²¨ì§„ inputì—ì„œ countryIdë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const countryId = kingCountryIdInput.value;
        const kingKey = countryId;
        const kingList = kings[kingKey] || [];
        
        const select = kingSelect;
        select.innerHTML = '<option value="">--- ìƒˆ ì™• ì¶”ê°€ ---</option>' + 
                          kingList.map((k, index) => {
                              const startMonth = k.start_month || 1;
                              const endMonth = k.end_month || 1;
                              const endYearText = k.end === null ? 'í˜„ì¬' : `${k.end}ë…„ ${endMonth}ì›”`;
                              
                              return `<option value="${index}" 
                                        data-start="${k.start}" 
                                        data-end="${k.end}"
                                        data-start-month="${startMonth}"
                                        data-end-month="${endMonth}"
                                        data-id="${k._id ? k._id.toString() : ''}"
                                >${k.name} (${k.start}ë…„ ${startMonth}ì›” ~ ${endYearText})</option>`;
                          }).join('');
        if (resetForm) {
            document.getElementById('kingName').value = '';
            document.getElementById('kingSummary').value = ''; // ğŸš© í•œì¤„í‰ ì´ˆê¸°í™”
            document.getElementById('kingStart').value = '';
            document.getElementById('kingStartMonth').value = 1;
            document.getElementById('kingEnd').value = '';
            document.getElementById('kingEndMonth').value = 12;
            document.getElementById('kingOriginalKey').value = '';
            document.getElementById('kingOriginalIndex').value = '';
            document.getElementById('deleteKingBtn').style.display = 'none';
            document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
        }
    }

kingSelect.addEventListener('change', () => {
    const index = kingSelect.value;
    // ğŸš© [ìˆ˜ì •] ìˆ¨ê²¨ì§„ inputì—ì„œ countryIdë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const countryId = kingCountryIdInput.value;
    const kingList = kings[countryId] || []; // â¬…ï¸ ì˜¬ë°”ë¥¸ ì¡°íšŒ
    const kingMongoIdField = document.getElementById('kingMongoId'); 
        
        if (index === "") {
            document.getElementById('editKingForm').reset();
            document.getElementById('kingName').value = '';
            document.getElementById('kingStartMonth').value = 1;
            document.getElementById('kingEndMonth').value = 1;
            document.getElementById('kingOriginalKey').value = '';
            document.getElementById('kingOriginalIndex').value = '';
            document.getElementById('deleteKingBtn').style.display = 'none';
            document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
            kingMongoIdField.value = ''; 

            return;
        }

        const king = kingList[parseInt(index)];
        if (!king) return;
        kingMongoIdField.value = king._id ? king._id.toString() : ''; 
        
        
        document.getElementById('kingName').value = king.name;
        document.getElementById('kingSummary').value = king.summary || ''; // ğŸš© í•œì¤„í‰ ë¡œë“œ
        document.getElementById('kingStart').value = king.start;
        document.getElementById('kingStartMonth').value = king.start_month || 1;
        document.getElementById('kingEnd').value = king.end || '';
        document.getElementById('kingEndMonth').value = king.end_month || 12;
        document.getElementById('kingOriginalKey').value = countryId;
        document.getElementById('kingOriginalIndex').value = index;
        document.getElementById('deleteKingBtn').style.display = 'inline-block';
        document.getElementById('saveKingBtn').textContent = 'ì €ì¥';
    });



    // ì™• í¼ ì œì¶œ (ì¶”ê°€/ìˆ˜ì •)
    document.getElementById('editKingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const kingMongoId = document.getElementById('kingMongoId').value; 
        const isUpdate = kingMongoId !== '';
        
        // ğŸš© [ìˆ˜ì •] ìˆ¨ê²¨ì§„ inputì—ì„œ countryIdë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const countryId = document.getElementById('kingCountryId').value;

        const newKingData = {
            countryId: countryId, // ğŸš¨ countryIdë¥¼ ì „ì†¡
            name: document.getElementById('kingName').value,
            summary: document.getElementById('kingSummary').value || '', // ğŸš© í•œì¤„í‰ ì¶”ê°€
            start: parseInt(document.getElementById('kingStart').value),
            start_month: parseInt(document.getElementById('kingStartMonth').value) || 1,
            end: parseInt(document.getElementById('kingEnd').value) || null,
            end_month: parseInt(document.getElementById('kingEndMonth').value) || 12,
        };

        // ğŸš© [ë””ë²„ê·¸] ì €ì¥í•  ë°ì´í„° í™•ì¸
        console.log('ì €ì¥í•  ì™• ë°ì´í„°:', newKingData);

        // ğŸš© [ìˆ˜ì •] ì—…ë°ì´íŠ¸ ì‹œì—ëŠ” ì™•ì˜ _idë¥¼ ë°ì´í„°ì— í¬í•¨ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.
        if (isUpdate) {
            newKingData._id = kingMongoId;
        }
        
        if (!newKingData.name || isNaN(newKingData.start)) {
            return alert("ì™• ì´ë¦„ê³¼ ì‹œì‘ ì—°ë„ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        let method = isUpdate ? 'PUT' : 'POST';
        let url = isUpdate ? `${API_BASE_URL}/kings/${kingMongoId}` : `${API_BASE_URL}/kings`; 

        try {
            const response = await fetch(url, {
                method: method, 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(newKingData)
            });

            // ğŸš© [ì¶”ê°€] í† í° ë§Œë£Œ ì²´í¬
            if (handleApiError(response)) return;

            if (!response.ok) {
                const errorData = await response.json(); 
                throw new Error(`${response.status}: ${errorData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
            
            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì¦ë¶„ ì—…ë°ì´íŠ¸
            const responseData = await response.json();
            
            if (!isUpdate) { // ì¶”ê°€(POST) ì„±ê³µ ì‹œì—ë§Œ ì—°ì† ì¶”ê°€ ëª¨ë“œ ì‘ë™
                
                // 1. ë©”ëª¨ë¦¬ì— ìƒˆ ì™• ì¶”ê°€
                addKingInMemory({ ...newKingData, _id: responseData.id });
                
                // 2. êµ­ê°€ëª…ê³¼ êµ­ê°€ IDëŠ” ìœ ì§€
                document.getElementById('kingCountryId').value = countryId; 
                
                // 3. í¼ í•„ë“œ ë¦¬ì…‹
                document.getElementById('editKingForm').reset();

                // ğŸš© [ì¶”ê°€] í¼ ë¦¬ì…‹ í›„, ìœ ì§€í•´ì•¼ í•  êµ­ê°€ëª…ê³¼ ë“œë¡­ë‹¤ìš´ ì„ íƒ ìƒíƒœë¥¼ ë³µì›í•©ë‹ˆë‹¤.
                const preservedCountry = getCountryInfoById(countryId);
                if (preservedCountry) {
                    document.getElementById('kingCountryNameInput').value = preservedCountry.name;
                    document.getElementById('kingCountrySelect').value = countryId;
                }
                
                // 4. ë¦¬ì…‹ í›„, ì´ˆê¸°ê°’ê³¼ ë²„íŠ¼ ìƒíƒœ ì¬ì„¤ì •
                document.getElementById('kingSelect').value = ''; // 'ìƒˆ ì™• ì¶”ê°€' ì„ íƒ
                document.getElementById('kingStartMonth').value = 1;
                document.getElementById('kingEndMonth').value = 12;
                document.getElementById('deleteKingBtn').style.display = 'none';
                document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
                document.getElementById('kingMongoId').value = '';
                
                // 5. í˜„ì¬ êµ­ê°€ì˜ ì™• ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
                loadKingsForCountry(false); // ë¦¬ì…‹í•˜ì§€ ì•ŠìŒ (í¼ì€ ì´ë¯¸ ë¦¬ì…‹ë¨)

            //    alert("ì™• ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ê°™ì€ êµ­ê°€ì— ì—°ì† ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

            } else { // ìˆ˜ì •(PUT) ì„±ê³µ ì‹œ
                // 1. ë©”ëª¨ë¦¬ì—ì„œ ì™• ì •ë³´ ì—…ë°ì´íŠ¸
                updateKingInMemory(kingMongoId, newKingData);

                // 2. êµ­ê°€ ì„ íƒ ìœ ì§€
                document.getElementById('kingCountryId').value = countryId;

                // 3. í¼ í•„ë“œ ë¦¬ì…‹
                document.getElementById('editKingForm').reset();
                document.getElementById('kingSelect').value = ''; // 'ìƒˆ ì™• ì¶”ê°€' ì„ íƒ
                document.getElementById('kingStartMonth').value = 1;
                document.getElementById('kingEndMonth').value = 12;
                document.getElementById('deleteKingBtn').style.display = 'none';
                document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
                document.getElementById('kingMongoId').value = ''; // ğŸš© [í•µì‹¬ ìˆ˜ì •] ìˆ˜ì • ì™„ë£Œ í›„, ë‹¤ìŒ ì‘ì—…ì„ ìœ„í•´ ì™• IDë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.

                // 4. í˜„ì¬ êµ­ê°€ì˜ ì™• ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
                loadKingsForCountry(false);
              //  alert("ì™• ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ì†í•´ì„œ ì‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }

        } catch (error) {
            console.error("King ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`King ì •ë³´ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });

    // ì™• í¼ ì‚­ì œ (DELETE ìš”ì²­)
    document.getElementById('deleteKingBtn').addEventListener('click', async () => {
        const kingMongoId = document.getElementById('kingMongoId').value; 
        
        if (!kingMongoId || !confirm('ì •ë§ë¡œ ì´ ì™•ì˜ ì¬ìœ„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/kings/${kingMongoId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`${response.status}: ${errorData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }

            document.getElementById('kingForm').style.display = 'none';
            
            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
            deleteKingInMemory(kingMongoId);
        } catch (error) {
            console.error("King ì •ë³´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`King ì •ë³´ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    });


    // ğŸ‘‘ ì™• í¸ì§‘ ëª¨ë“œì—ì„œ í˜¸ì¶œ: URL IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì™• ì •ë³´ í¼ì— ì±„ìš°ê¸°
    window.editKing = (kingsId) => {
        document.getElementById('kingMongoId').value = kingsId; 
        document.getElementById('deleteKingBtn').style.display = 'inline';
        document.getElementById('saveKingBtn').textContent = 'ì €ì¥';


    if (!kingsId) return alert('í¸ì§‘í•  ì™•ì˜ IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');

    let targetKing = null;
    let countryId = null; 

    outer: for (const key in kings) {
        if (kings.hasOwnProperty(key)) {
            const index = kings[key].findIndex(k => k._id && k._id.toString() === kingsId);
            if (index !== -1) {
                targetKing = kings[key][index];
                countryId = key; // ğŸš© keyëŠ” ì´ì œ countryIdì…ë‹ˆë‹¤.
                break outer;
            }
        }
    }

    if (!targetKing) {
        console.error("IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", kingsId);
        return alert('í•´ë‹¹ IDë¥¼ ê°€ì§„ ì™• ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„° ë¶ˆì¼ì¹˜)');
    }
    // ğŸš¨ [í•µì‹¬ ìˆ˜ì •] countryIdë¥¼ <select>ì— ì„¤ì •í•˜ì—¬ loadKingsForCountryê°€ ì‘ë™í•˜ë„ë¡ í•¨
    kingCountryIdInput.value = countryId;
    kingCountryNameInput.value = getCountryInfoById(countryId)?.name || '';
    document.getElementById('kingCountrySelect').value = countryId; // ğŸš© [ì¶”ê°€] ë“œë¡­ë‹¤ìš´ë„ í•¨ê»˜ ë³€ê²½
    // ğŸš© [ì¶”ê°€] êµ­ê°€ë¥¼ ì„ íƒí–ˆìœ¼ë¯€ë¡œ, í•´ë‹¹ êµ­ê°€ì˜ ì™• ëª©ë¡ì„ ë¡œë“œí•˜ì—¬ <select>ì— ì±„ì›ë‹ˆë‹¤.
    loadKingsForCountry(false); // falseë¡œ ì„¤ì •í•˜ì—¬ í˜„ì¬ í¼ ê°’(countryId)ì„ ìœ ì§€

    // ğŸš© [ì¶”ê°€] ë¡œë“œëœ ëª©ë¡ì—ì„œ í˜„ì¬ ì™•ì„ ì°¾ì•„ì„œ kingSelectë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    const kingList = kings[countryId];
    const targetIndex = kingList.findIndex(k => k._id && k._id.toString() === kingsId);
    document.getElementById('kingSelect').value = targetIndex.toString(); // <select> ê°’ì„ í•´ë‹¹ indexë¡œ ë³€ê²½

        
        document.getElementById('kingName').value = targetKing.name || '';
        document.getElementById('kingSummary').value = targetKing.summary || ''; // ğŸš© í•œì¤„í‰ ë¡œë“œ
        document.getElementById('kingStart').value = targetKing.start || '';
        document.getElementById('kingStartMonth').value = targetKing.start_month || 1;
        document.getElementById('kingEnd').value = targetKing.end || '';
        document.getElementById('kingEndMonth').value = targetKing.end_month || 12;
        
        document.getElementById('kingForm').style.display = 'block';
    }; 

    document.getElementById('cancelKingBtn').addEventListener('click', () => {
        document.getElementById('kingForm').style.display = 'none';
    }); 
    
    document.getElementById('editDrawingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const drawingId = document.getElementById('drawingMongoId').value;
        const isUpdate = !!drawingId;
        const url = isUpdate ? `${API_BASE_URL}/drawings/${drawingId}` : `${API_BASE_URL}/drawings`;
        const method = isUpdate ? 'PUT' : 'POST';

        const data = {
            name: document.getElementById('drawingName').value,
            type: document.getElementById('drawingType').value,
            color: document.getElementById('drawingColor').value, // ğŸš© [ì¶”ê°€] ìƒ‰ìƒ í•„ë“œ
            start_year: parseInt(document.getElementById('drawingStartYear').value),
            end_year: document.getElementById('drawingEndYear').value ? parseInt(document.getElementById('drawingEndYear').value) : null,
            geojson: JSON.parse(document.getElementById('drawingGeoJson').value)
        };

        if (!data.name || isNaN(data.start_year)) {
            return alert("ì´ë¦„ê³¼ ì‹œì‘ ì—°ë„ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        }

        try {
            const response = await fetch(url, { 
                method, 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                body: JSON.stringify(data) 
            });
            // ğŸš© [ì¶”ê°€] í† í° ë§Œë£Œ ì²´í¬
            if (handleApiError(response)) return;
            
            if (!response.ok) throw new Error('ê·¸ë¦¬ê¸° ì •ë³´ ì €ì¥ ì‹¤íŒ¨');
            
            document.getElementById('drawingForm').style.display = 'none';
            
            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì¦ë¶„ ì—…ë°ì´íŠ¸
            if (isUpdate) {
                updateDrawingInMemory(drawingId, data);
            } else {
                const responseData = await response.json();
                addDrawingInMemory({ ...data, _id: responseData.id });
            }
        } catch (error) { alert(error.message); }
    });

    document.getElementById('cancelDrawingBtn').addEventListener('click', () => { document.getElementById('drawingForm').style.display = 'none'; });

    // ğŸš© [ì¶”ê°€] ìƒ‰ìƒ ì„ íƒê¸° ì´ë²¤íŠ¸ - ì„ íƒí•œ ìƒ‰ìƒ hex ê°’ í‘œì‹œ
    document.getElementById('drawingColor').addEventListener('input', (e) => {
        document.getElementById('drawingColorHex').textContent = e.target.value;
    });

    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ê·¸ë¦¬ê¸° í¼ì˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    document.getElementById('deleteDrawingBtn').addEventListener('click', async () => {
        const drawingId = document.getElementById('drawingMongoId').value;
        if (!drawingId || !confirm('ì •ë§ë¡œ ì´ ë„í˜•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/drawings/${drawingId}`, { 
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            // ğŸš© [ì¶”ê°€] í† í° ë§Œë£Œ ì²´í¬
            if (handleApiError(response)) return;
            
            if (!response.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
            
            document.getElementById('drawingForm').style.display = 'none';
            
            // ğŸš© [ìµœì í™”] ì „ì²´ fetch ëŒ€ì‹  ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
            deleteDrawingInMemory(drawingId);
        } catch (error) {
            alert(error.message);
        }
    });

    // --- 11. ê·¸ë¦¬ê¸° í¼ ê´€ë¦¬ --- (ğŸš© [ì‹ ê·œ ì¶”ê°€])
    function openDrawingForm(geojson, drawingData = null) {
        closeAllFormsExcept('drawingForm');
        const form = document.getElementById('drawingForm');
        form.style.display = 'block';
        
        // ğŸš© [ì¶”ê°€] ìœ„ì¹˜ ê°•ì œ ì„¤ì • - ìš°ì¸¡ í•˜ë‹¨
        form.style.position = 'absolute';
        form.style.bottom = '10px';
        form.style.right = '10px';
        form.style.left = 'auto';
        form.style.top = 'auto';
        form.style.transform = 'none';
        
        // ğŸš© [ë””ë²„ê·¸] ì½˜ì†”ì— ìœ„ì¹˜ ì •ë³´ ì¶œë ¥
        console.log('drawingForm ìœ„ì¹˜ ì„¤ì •:', {
            position: form.style.position,
            bottom: form.style.bottom,
            right: form.style.right,
            left: form.style.left,
            top: form.style.top,
            computed: window.getComputedStyle(form).position,
            computedBottom: window.getComputedStyle(form).bottom,
            computedRight: window.getComputedStyle(form).right
        });
        
        document.getElementById('editDrawingForm').reset();

        document.getElementById('drawingGeoJson').value = JSON.stringify(geojson);

        if (drawingData) { // í¸ì§‘ ëª¨ë“œ
            document.getElementById('drawingMongoId').value = drawingData._id;
            document.getElementById('drawingName').value = drawingData.name;
            document.getElementById('drawingType').value = drawingData.type;
            document.getElementById('drawingColor').value = drawingData.color || '#3388ff'; // ğŸš© [ì¶”ê°€] ìƒ‰ìƒ ë¡œë“œ
            document.getElementById('drawingColorHex').textContent = drawingData.color || '#3388ff';
            document.getElementById('drawingStartYear').value = drawingData.start_year;
            document.getElementById('drawingEndYear').value = drawingData.end_year || '';
            document.getElementById('deleteDrawingBtn').style.display = 'inline-block';
            document.getElementById('saveDrawingBtn').textContent = 'ì €ì¥';
        } else { // ì¶”ê°€ ëª¨ë“œ
            document.getElementById('drawingMongoId').value = '';
            document.getElementById('drawingColor').value = '#3388ff'; // ğŸš© [ì¶”ê°€] ê¸°ë³¸ ìƒ‰ìƒ
            document.getElementById('drawingColorHex').textContent = '#3388ff';
            document.getElementById('drawingStartYear').value = yearInput.value; // í˜„ì¬ ì—°ë„ ê¸°ë³¸ê°’
            document.getElementById('deleteDrawingBtn').style.display = 'none';
            document.getElementById('saveDrawingBtn').textContent = 'ì €ì¥';
        }
    };
    // --- 12. ì‚¬ì„œ ê¸°ë¡ í¼ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    
    // openHistoryFormBtn ì´ë²¤íŠ¸ëŠ” ì´ë¯¸ openHistoryForm í•¨ìˆ˜ë¡œ ì²˜ë¦¬ë¨ (ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°)
    // openHistoryFormBtn.addEventListener('click', () => {
    //     editingHistoryKey = null; // ì´ ë²„íŠ¼ ìì²´ê°€ ê´€ë¦¬ìì—ê²Œë§Œ ë³´ì´ë¯€ë¡œ ë‚´ë¶€ ê¶Œí•œ ì²´í¬ëŠ” ë¶ˆí•„ìš”
    //     closeAllFormsExcept('historyForm');
    //     document.getElementById('historyForm').style.display = 'block';
    //     document.getElementById('addHistoryForm').reset();
    //     document.getElementById('deleteHistoryBtn').style.display = 'none'; // ğŸš© [ì¶”ê°€] ì¶”ê°€ ëª¨ë“œì—ì„œëŠ” ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
        
    //     document.getElementById('historyYear').value = yearInput.value;
    //     document.getElementById('historyMonth').value = monthInput.value;
    //     document.getElementById('saveHistoryBtn').textContent = 'ì €ì¥';
    // });

    document.getElementById('cancelHistoryBtn').addEventListener('click', () => {
        document.getElementById('historyForm').style.display = 'none';
    });
    
    // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('deleteHistoryBtn').addEventListener('click', async () => {
        if (!editingHistoryKey) return;
        if (!confirm('ì •ë§ë¡œ ì´ ì—­ì‚¬ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/history/${editingHistoryKey}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) throw new Error('ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

            document.getElementById('historyForm').style.display = 'none';
            initialize(); // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        } catch (error) {
            alert(error.message);
        }
    });

    document.getElementById('addHistoryForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const isUpdate = editingHistoryKey !== null;
        const url = isUpdate ? `${API_BASE_URL}/history/${editingHistoryKey}` : `${API_BASE_URL}/history`;
        const method = isUpdate ? 'PUT' : 'POST';
        
        const data = {
            year: parseInt(document.getElementById('historyYear').value),
            month: parseInt(document.getElementById('historyMonth').value) || 1,
            event_name: document.getElementById('historyEvent').value,
            create_event: document.getElementById('createEvent').checked, // ğŸš© [ìˆ˜ì •] create_event í”Œë˜ê·¸ë¥¼ history ë°ì´í„°ì— í¬í•¨
            photo: document.getElementById('historyPhoto').value || null, // ğŸš© [ì¶”ê°€] ì‚¬ì§„ ë°ì´í„° ìˆ˜ì§‘
            records: {
                korean: {
                    source: document.getElementById('koreanSource').value,
                    content: document.getElementById('koreanContent').value
                },
                foreign: {
                    source: document.getElementById('foreignSource').value,
                    content: document.getElementById('foreignContent').value
                },
                true_history: {
                    content: document.getElementById('trueHistoryContent').value
                }
            }
        };
        const createEvent = document.getElementById('createEvent').checked; // ğŸš© [ì¶”ê°€] ì²´í¬ë°•ìŠ¤ ê°’ í™•ì¸

        if (isNaN(data.year) || !data.event_name) {
            return alert("ì—°ë„ì™€ ì´ë²¤íŠ¸ëª…ì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
        }
        
        try {
            const response = await fetch(url, {
                method: method, 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            // --- ğŸš© [í•µì‹¬ ì¶”ê°€] ì´ë²¤íŠ¸ ë°ì´í„° ë™ê¸°í™” ë¡œì§ ---
            let historyId;
            if (isUpdate) {
                historyId = editingHistoryKey; // ì—…ë°ì´íŠ¸ ì‹œì—ëŠ” ê¸°ì¡´ ID ì‚¬ìš©
                await response.json(); // ì‘ë‹µì„ ì½ì–´ ë²„í¼ë¥¼ ë¹„ì›ë‹ˆë‹¤.
            } else {
                const savedHistoryResponse = await response.json(); // POST ì‘ë‹µì—ì„œ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                historyId = savedHistoryResponse.id;
            }
            const linkedEvent = events.find(e => e.history_id === historyId);

            if (createEvent) {
                // ì²´í¬ë°•ìŠ¤ í™œì„±í™”: ì´ë²¤íŠ¸ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
                const eventData = {
                    year: data.year,
                    month: data.month,
                    text: data.event_name,
                    photo: data.photo,
                    history_id: historyId // ì‚¬ì„œ ê¸°ë¡ ID ì—°ê²°
                };

                const eventMethod = linkedEvent ? 'PUT' : 'POST';
                const eventUrl = linkedEvent ? `${API_BASE_URL}/events/${linkedEvent._id}` : `${API_BASE_URL}/events`;

                const eventResponse = await fetch(eventUrl, {
                    method: eventMethod,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },                    
                    body: JSON.stringify(eventData)
                });
                if (!eventResponse.ok) throw new Error('ì—°ë™ ì´ë²¤íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

            } else if (linkedEvent) {
                // ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”: ì—°ê²°ëœ ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
                const eventResponse = await fetch(`${API_BASE_URL}/events/${linkedEvent._id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!eventResponse.ok) throw new Error('ì—°ë™ ì´ë²¤íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            // --- ì´ë²¤íŠ¸ ë™ê¸°í™” ë¡œì§ ë ---


            document.getElementById('historyForm').style.display = "none";
            initialize(); 
        } catch (error) {
            console.error("History ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            alert(`History ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
    });
    
    window.editHistory = function(key) {
        const record = history.find(h => h._id === key); 
        if (!record || !editMode || !(currentUser?.role === 'superuser' || currentUser?.role === 'admin')) return; // ğŸš© [ìˆ˜ì •] ê¶Œí•œ ì²´í¬
        if (!record) return alert("ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        editingHistoryKey = key;
        closeAllFormsExcept('historyForm');
        document.getElementById('historyForm').style.display = "block";
        document.getElementById('deleteHistoryBtn').style.display = 'inline-block'; // ğŸš© [ì¶”ê°€] í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        
        document.getElementById('historyKey').value = key;
        document.getElementById('historyMonth').value = record.month;
        document.getElementById('historyYear').value = record.year;
        document.getElementById('historyEvent').value = record.event_name;
        document.getElementById('historyPhoto').value = record.photo ?? ''; // ğŸš© [ì¶”ê°€] ì‚¬ì§„ URL ì±„ìš°ê¸°

        // ğŸš© [ìˆ˜ì •] ì—°ê²°ëœ ì´ë²¤íŠ¸ ì¡´ì¬ ì—¬ë¶€ê°€ ì•„ë‹Œ, history ë°ì´í„°ì— ì €ì¥ëœ create_event í”Œë˜ê·¸ ê°’ìœ¼ë¡œ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // const linkedEvent = events.find(e => e.history_id === key);
        document.getElementById('createEvent').checked = record.create_event || false;

        
        document.getElementById('koreanSource').value = record.records?.korean?.source ?? '';
        document.getElementById('koreanContent').value = record.records?.korean?.content ?? '';
        
        document.getElementById('foreignSource').value = record.records?.foreign?.source ?? '';
        document.getElementById('foreignContent').value = record.records?.foreign?.content ?? '';
        
        document.getElementById('trueHistoryContent').value = record.records?.true_history?.content ?? '';
        document.getElementById('saveHistoryBtn').textContent = 'ì €ì¥';
    }

    // --- 15. í¼ ì´ë™(ë“œë˜ê·¸) ê¸°ëŠ¥ ---
    function makeFormsDraggable() {
        const formIds = ['castleForm', 'historyForm', 'countryForm', 'kingForm', 'eventForm', 'drawingForm', 'editCitySelectionForm']; // ğŸš© [ì¶”ê°€] editCitySelectionForm í¬í•¨

        formIds.forEach(id => {
            const form = document.getElementById(id);
            const header = form.querySelector('h3');

            if (!header) return;

            let isDragging = false;
            let offsetX, offsetY;

            header.addEventListener('mousedown', (e) => {
                // í¼ ë‚´ë¶€ì˜ ë‹¤ë¥¸ ìš”ì†Œ(input, select ë“±)ì—ì„œ ì‹œì‘ëœ mousedownì€ ë¬´ì‹œ
                if (e.target !== header) return;

                isDragging = true;
                offsetX = e.clientX - form.offsetLeft;
                offsetY = e.clientY - form.offsetTop;

                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;
                
                let newLeft = e.clientX - offsetX;
                let newTop = e.clientY - offsetY;

                form.style.left = `${newLeft}px`;
                form.style.top = `${newTop}px`;
            }

            function onMouseUp() {
                isDragging = false;
                document.body.style.userSelect = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        });
    }

    makeFormsDraggable();
    
    // ğŸš© [ì¶”ê°€] ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰)
    function initializeDrawControl() {
        // ì‚¬ìš©ì ê¶Œí•œì— ë”°ë¼ ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ì„ ì§€ë„ì— ì¶”ê°€
        const user = parseJwt(token);
        if (user && (user.role === 'admin' || user.role === 'superuser')) {
            if (drawControl) map.removeControl(drawControl); // ì¤‘ë³µ ë°©ì§€
            drawControl = new L.Control.Draw({
                position: 'topleft', // ğŸš© [ìˆ˜ì •] ê·¸ë¦¬ê¸° íˆ´ë°”ë¥¼ ì—°ëŒ€í‘œ í•˜ë‹¨ì— ë°°ì¹˜ (CSSë¡œ ìœ„ì¹˜ ì¡°ì •)
                edit: false, // ë„í˜• í´ë¦­ìœ¼ë¡œë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥
                draw: { 
                    polygon: {
                        shapeOptions: {
                            color: '#3388ff',
                            fillOpacity: 0.5 // ğŸš© [ìˆ˜ì •] ë‹¤ê°í˜• ë‚´ë¶€ íˆ¬ëª…ë„ ì¦ê°€ (ê¸°ë³¸ê°’ 0.2 â†’ 0.5)
                        }
                    }, 
                    polyline: {
                        shapeOptions: {
                            color: '#3388ff',
                            opacity: 0.8
                        }
                    }, 
                    rectangle: {
                        shapeOptions: {
                            color: '#3388ff',
                            fillOpacity: 0.5 // ğŸš© [ìˆ˜ì •] ì‚¬ê°í˜• ë‚´ë¶€ íˆ¬ëª…ë„ ì¦ê°€
                        }
                    }, 
                    circle: {
                        shapeOptions: {
                            color: '#3388ff',
                            fillOpacity: 0.5 // ğŸš© [ìˆ˜ì •] ì› ë‚´ë¶€ íˆ¬ëª…ë„ ì¦ê°€
                        }
                    }, 
                    marker: true, 
                    circlemarker: false 
                }
            });
            map.addControl(drawControl);

            // ê·¸ë¦¬ê¸° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë°”ì¸ë”©
            map.on(L.Draw.Event.CREATED, function (e) {
                const layer = e.layer;
                const geojson = layer.toGeoJSON();
                
                // ğŸš© [ì¶”ê°€] Circleì˜ ê²½ìš° radius ì†ì„± ë³´ì¡´
                if (layer instanceof L.Circle) {
                    geojson.properties = geojson.properties || {};
                    geojson.properties.radius = layer.getRadius();
                }
                
                openDrawingForm(geojson);
            });
            map.on('draw:drawstart', () => { isDrawing = true; });
            map.on('draw:drawstop', () => { isDrawing = false; });
        }
    }

    // ğŸš© [ì¶”ê°€] PC ë²„ì „ ìƒë‹¨ íŒ¨ë„ í† ê¸€ ê¸°ëŠ¥ ì´ˆê¸°í™”
    function initializeTopPanelToggle() {
        const toggleBtn = document.getElementById('pcTopPanelToggleBtn');
        const body = document.body;
        const controlsWrapper = document.getElementById('controls-wrapper');
        const timelineContainer = document.getElementById('timeline-container');
        let isControlsHidden = false;

        toggleBtn.addEventListener('click', () => {
            if (window.innerWidth <= 967) {
                // ëª¨ë°”ì¼: ìƒë‹¨ ë©”ë‰´ëŠ” í•­ìƒ í‘œì‹œë˜ë¯€ë¡œ í† ê¸€í•˜ì§€ ì•ŠìŒ
                // ì˜¤ë¥¸ìª½ íŒ¨ë„ë§Œ í† ê¸€
                const rightPanel = document.getElementById('rightPanel');
                if (rightPanel) {
                    rightPanel.classList.toggle('visible');
                    document.body.classList.toggle('controls-visible', rightPanel.classList.contains('visible'));
                }
            } else {
                // PC ë™ì‘
                isControlsHidden = !isControlsHidden;

                // ğŸš© [ìˆ˜ì •] ì „ì²´ íŒ¨ë„ì„ ìˆ¨ê¸°ëŠ” ëŒ€ì‹ , íŠ¹ì • ë¶€ë¶„ë§Œ ìˆ¨ê¸°ë„ë¡ ë³€ê²½
                const slider = document.getElementById('combinedSlider');
                const sliderTicks = controlsWrapper.querySelector('.slider-ticks-container'); // ëˆˆê¸ˆ ì»¨í…Œì´ë„ˆ

                if (slider) slider.style.display = isControlsHidden ? 'none' : 'block';
                if (sliderTicks) sliderTicks.style.display = isControlsHidden ? 'none' : 'flex'; // ëˆˆê¸ˆì€ flexë¡œ ë³µì›
                if (timelineContainer) timelineContainer.style.display = isControlsHidden ? 'none' : 'block';

                // ğŸš© [ìˆ˜ì •] ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                toggleBtn.classList.toggle('active', !isControlsHidden);
            }
            map.invalidateSize(); // ì§€ë„ í¬ê¸° ì¬ê³„ì‚°ì€ í•­ìƒ ìˆ˜í–‰
            if (!isControlsHidden) {
                // ğŸš© [ìˆ˜ì •] íŒ¨ë„ì´ ë‹¤ì‹œ ë‚˜íƒ€ë‚  ë•Œ, ì—°ëŒ€í‘œì˜ ìœ„ì¹˜ë¥¼ ì¬ì¡°ì •í•˜ê³  ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
                createDynastyTimeline(); 
            }
        });
    }

    // ğŸš© [ìˆ˜ì •] window ê¸€ë¡œë²Œ í•¨ìˆ˜ë“¤ì„ DOMContentLoaded ë°–ì—ì„œ ì •ì˜í•˜ì—¬ í•­ìƒ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•¨
    window.voteContribution = async (id) => {
        try {
            console.log('voteContribution called with id:', id);
            const response = await fetch(`${API_BASE_URL}/contributions/${id}/vote`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            console.log('vote response data:', data);

            if (response.ok) {
                const countSpan = document.getElementById(`vote-count-${id}`);
                if (countSpan && data.votes !== undefined) {
                    countSpan.textContent = data.votes;
                }
                
                const openPopups = document.querySelectorAll('.leaflet-popup');
                openPopups.forEach(popup => {
                    const popupContent = popup.querySelector('.leaflet-popup-content');
                    if (popupContent && popupContent.innerHTML.includes(`voteContribution('${id}')`)) {
                        map.closePopup();
                    }
                });
                
                const modalVoteBtn = document.querySelector(`#contributionDetailModal button[onclick="voteContribution('${id}')"]`);
                if (modalVoteBtn && data.action === 'vote') {
                    modalVoteBtn.style.display = 'none';
                }
                
                const votersList = document.querySelector('#contributionDetailModal .voters-list');
                if (votersList) {
                    fetch(`${API_BASE_URL}/contributions?status=pending`)
                        .then(response => response.json())
                        .then(contribs => {
                            const contribution = contribs.find(c => c._id === id);
                            if (contribution && contribution.votedBy) {
                                votersList.innerHTML = contribution.votedBy.length > 0 ? 
                                    contribution.votedBy.map(voter => `<div style="margin-bottom: 5px;">â€¢ ${voter}</div>`).join('') : 
                                    '<div style="color: #bdc3c7; font-style: italic;">ì•„ì§ ì¶”ì²œìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                            }
                        })
                        .catch(error => console.error('Failed to update voters list:', error));
                }
                
                alert(data.message);
            } else {
                alert(data.message || 'ì¶”ì²œ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('voteContribution error:', error);
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    };

    window.deleteMyContribution = async (id) => {
        if (!confirm('ì •ë§ë¡œ ì´ ì‚¬ë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì‚­ì œëœ ì‚¬ë£ŒëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìœ¼ë©°, ì‚¬ë£Œ ì œì¶œ ì ìˆ˜(3ì )ê°€ ì°¨ê°ë©ë‹ˆë‹¤.')) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/contributions/${id}/my`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            if (response.ok) {
                alert('âœ… ' + data.message);
                const detailModal = document.getElementById('contributionDetailModal');
                if (detailModal) detailModal.style.display = 'none';
                
                if (typeof contributions !== 'undefined' && Array.isArray(contributions)) {
                    contributions = contributions.filter(c => c._id !== id);
                }
                
                if (typeof loadContributions === 'function') loadContributions();
                if (typeof updateTopBarUserInfo === 'function') updateTopBarUserInfo();
            } else {
                alert('âŒ ' + (data.message || 'ì‚­ì œ ì‹¤íŒ¨'));
            }
        } catch (error) {
            alert('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
        }
    };


    // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì¤‘ë³µ ì„ ì–¸ëœ DOMContentLoaded ë¦¬ìŠ¤ë„ˆë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•˜ê³ , ëˆ„ë½ëœ ë ˆì´ì–´ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    document.addEventListener('DOMContentLoaded', async () => {
        // ğŸš€ [v2.0.5] í˜ì´ì§€ ë¡œë”© ì‹œì‘ - ì´ˆê¸° í™”ë©´ì€ ì´ë¯¸ í‘œì‹œë¨
        console.log('ğŸ“„ DOM ë¡œë”© ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...');
        
        // ğŸš© [ì¶”ê°€] í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ ë° currentUser ì„¤ì •
        if (token) {
            currentUser = parseJwt(token);
            console.log('ğŸ‘¤ currentUser ì„¤ì •ë¨:', currentUser);
        } else {
            console.log('âŒ í† í° ì—†ìŒ, currentUser null ìœ ì§€');
        }
        
        // ğŸš© [ì¶”ê°€] ì§ê¸‰ëª… â†’ í’ˆê³„+ì§ê¸‰ëª… ë³€í™˜ í•¨ìˆ˜ (DBì— êµ¬ í˜•ì‹ìœ¼ë¡œ ì €ì¥ëœ ê²½ìš° ëŒ€ë¹„)
        const POSITION_RANK_MAP = {
            'ê°ìˆ˜êµ­ì‚¬': 'ì •1í’ˆ ê°ìˆ˜êµ­ì‚¬', 'íŒì‚¬ê´€ì‚¬': 'ì¢…1í’ˆ íŒì‚¬ê´€ì‚¬',
            'ìˆ˜êµ­ì‚¬': 'ì •2í’ˆ ìˆ˜êµ­ì‚¬',     'ë™ìˆ˜êµ­ì‚¬': 'ì¢…2í’ˆ ë™ìˆ˜êµ­ì‚¬',
            'ìˆ˜ì°¬ê´€': 'ì •3í’ˆ ìˆ˜ì°¬ê´€',     'ì§ìˆ˜ì°¬ê´€': 'ì¢…3í’ˆ ì§ìˆ˜ì°¬ê´€',
            'ì‚¬ê´€ìˆ˜ì°¬': 'ì •4í’ˆ ì‚¬ê´€ìˆ˜ì°¬', 'ì‹œê°•í•™ì‚¬': 'ì¢…4í’ˆ ì‹œê°•í•™ì‚¬',
            'ê¸°ê±°ì£¼': 'ì •5í’ˆ ê¸°ê±°ì£¼',     'ê¸°ê±°ì‚¬': 'ì¢…5í’ˆ ê¸°ê±°ì‚¬',
            'ê¸°ê±°ë‘': 'ì •6í’ˆ ê¸°ê±°ë‘',     'ê¸°ê±°ë„ìœ„': 'ì¢…6í’ˆ ê¸°ê±°ë„ìœ„',
            'ìˆ˜ì°¬': 'ì •7í’ˆ ìˆ˜ì°¬',         'ì§ë¬¸í•œ': 'ì¢…7í’ˆ ì§ë¬¸í•œ',
            'ì£¼ì„œ': 'ì •8í’ˆ ì£¼ì„œ',         'ê²€ì—´': 'ì¢…8í’ˆ ê²€ì—´',
            'ì •ì': 'ì •9í’ˆ ì •ì',         'ìˆ˜ë¶„ê¶Œì§€': 'ì¢…9í’ˆ ìˆ˜ë¶„ê¶Œì§€',
            'ë°±ì„±': 'ë°±ì„±'
        };
        function normalizePosition(pos) {
            if (!pos) return 'ì¢…9í’ˆ ìˆ˜ë¶„ê¶Œì§€';
            // ì´ë¯¸ í’ˆê³„ê°€ ë¶™ì–´ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ
            if (/^(ì •|ì¢…)[0-9]í’ˆ/.test(pos)) return pos;
            return POSITION_RANK_MAP[pos] || pos;
        }
        
        // ğŸš© [ìˆ˜ì •] ì‹¤ì‹œê°„ ì§ê¸‰ ê³„ì‚° í•¨ìˆ˜ (ì¬ìƒê¸‰ í¬í•¨ - ìˆœìœ„ ê¸°ë°˜)
        // ì¬ìƒê¸‰(ìƒìœ„ 4ëª…)ì€ ìˆœìœ„ ê¸°ë°˜, í•™ê´€ê¸‰ì€ ì ìˆ˜ ê¸°ë°˜ ìë™ ì§„ê¸‰
        function calculateRealtimePosition(userData, rank = null, designatedRank = null) {
            if (!userData) return 'ìˆ˜ë¶„ê¶Œì§€';
            
            // admin/superuser ìë™ ì§ê¸‰ ì—†ìŒ â€” designated_rankë¡œë§Œ ì¬ìƒê¸‰ ë°›ìŒ
            
            const totalCount = userData.totalCount || 0;
            const approvedCount = userData.approvedCount || 0;
            const totalVotes = userData.totalVotes || 0;
            const reviewScore = userData.reviewScore || 0;
            const approvalScore = userData.approvalScore || 0;
            
            const score = (totalCount * 3) + (approvedCount * 10) + totalVotes + reviewScore + approvalScore;
            
            // ğŸš© ê³ ë ¤ ì‚¬ê´€ í†µí•© 18ë‹¨ê³„ ì§ê¸‰í‘œ
            // ì •1í’ˆ~ì¢…2í’ˆ (ì¬ìƒê¸‰ - admin ì§€ì • ë˜ëŠ” ìˆœìœ„ + ìµœì†Œ ì ìˆ˜ ê¸°ì¤€)
            
            // admin ì§€ì • ì¬ìƒê¸‰ ìš°ì„  ì ìš©
            const _dr = designatedRank || userData.designated_rank || null;
            if (_dr === 1) return 'ì •1í’ˆ ê°ìˆ˜êµ­ì‚¬';
            if (_dr === 2) return 'ì¢…1í’ˆ íŒì‚¬ê´€ì‚¬';
            if (_dr === 3) return 'ì •2í’ˆ ìˆ˜êµ­ì‚¬';
            if (_dr === 4) return 'ì¢…2í’ˆ ë™ìˆ˜êµ­ì‚¬';
            
            // ì ìˆ˜+ìˆœìœ„ ê¸°ë°˜ ì¬ìƒê¸‰
            if (rank === 1 && score >= 5000) return 'ì •1í’ˆ ê°ìˆ˜êµ­ì‚¬';      // ì •1í’ˆ - ì‚¬ê´€ì˜ ìµœê³  ìˆ˜ì¥
            if (rank === 2 && score >= 4300) return 'ì¢…1í’ˆ íŒì‚¬ê´€ì‚¬';      // ì¢…1í’ˆ - ëŒ€ì‚¬ ê¸°ë¡ ìµœì¢… ìŠ¹ì¸
            if (rank === 3 && score >= 3700) return 'ì •2í’ˆ ìˆ˜êµ­ì‚¬';        // ì •2í’ˆ - ì‹¤ë¡ í¸ì°¬ ì´ê´„
            if (rank === 4 && score >= 3100) return 'ì¢…2í’ˆ ë™ìˆ˜êµ­ì‚¬';      // ì¢…2í’ˆ - ì •ë‹¹ë¬¸í•™ ê²¸ì„
            
            // ì •3í’ˆ~ì¢…4í’ˆ (ìƒê¸‰ ì‚¬ê´€)
            if (score >= 2600) return 'ì •3í’ˆ ìˆ˜ì°¬ê´€';                      // ì •3í’ˆ - ê¸°ë¡ ê²€í†  ë° êµì •
            if (score >= 2100) return 'ì¢…3í’ˆ ì§ìˆ˜ì°¬ê´€';                    // ì¢…3í’ˆ - ì¢Œìš°ì‚°ê¸°ìƒì‹œ ê²¸ì„
            if (score >= 1700) return 'ì •4í’ˆ ì‚¬ê´€ìˆ˜ì°¬';                    // ì •4í’ˆ - ê³ ìœ„ ê´€ì› ê²¸ì„
            if (score >= 1400) return 'ì¢…4í’ˆ ì‹œê°•í•™ì‚¬';                    // ì¢…4í’ˆ - ì—­ì‚¬ì  ì‚¬ë¡€ ê°•ë¡ 
            
            // ì •5í’ˆ~ì¢…6í’ˆ (ì¤‘ê¸‰ ì‚¬ê´€)
            if (score >= 1100) return 'ì •5í’ˆ ê¸°ê±°ì£¼';                      // ì •5í’ˆ - ì™•ì˜ ì–¸í–‰ ê¸°ë¡ (í•µì‹¬ ì‚¬ê´€)
            if (score >= 850) return 'ì¢…5í’ˆ ê¸°ê±°ì‚¬';                       // ì¢…5í’ˆ - ê¸°ë¡ ì´ˆì•ˆ ì‘ì„±
            if (score >= 650) return 'ì •6í’ˆ ê¸°ê±°ë‘';                       // ì •6í’ˆ - ì‚¬ì´ˆ ì‘ì„± ì‹¤ë¬´
            if (score >= 450) return 'ì¢…6í’ˆ ê¸°ê±°ë„ìœ„';                     // ì¢…6í’ˆ - êµ­ì™• í–‰ì°¨ ê¸°ë¡
            
            // ì •7í’ˆ~ì¢…9í’ˆ (í•˜ê¸‰ ì‚¬ê´€)
            if (score >= 300) return 'ì •7í’ˆ ìˆ˜ì°¬';                         // ì •7í’ˆ - í•œë¦¼ì› ì‹¤ë¬´ ì‚¬ê´€
            if (score >= 200) return 'ì¢…7í’ˆ ì§ë¬¸í•œ';                       // ì¢…7í’ˆ - ë¬¸ì¥ê³¼ ê¸°ë¡ ì •ë¹„
            if (score >= 120) return 'ì •8í’ˆ ì£¼ì„œ';                         // ì •8í’ˆ - íšŒì˜ ê¸°ë¡ ë° ì‚¬ë³¸ ê´€ë¦¬
            if (score >= 60) return 'ì¢…8í’ˆ ê²€ì—´';                          // ì¢…8í’ˆ - ê¸°ë¡ë¬¼ 1ì°¨ í™•ì¸
            if (score >= 30) return 'ì •9í’ˆ ì •ì';                          // ì •9í’ˆ - ë¬¸í—Œ ë³´ê´€ ë° ì •ë¦¬
            return 'ì¢…9í’ˆ ìˆ˜ë¶„ê¶Œì§€';                                       // ì¢…9í’ˆ - ì‹¤ë¬´ ìˆ˜ìŠµ
        }
        
        // ğŸš© [ì¶”ê°€] ìŠ¹ê¸‰ ì¶•í•˜ íš¨ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showPromotionEffect(oldPosition, newPosition) {
            // ìŠ¹ê¸‰ ì—¬ë¶€ í™•ì¸ (ì´ì „ ì§ê¸‰ê³¼ ë‹¤ë¥´ê³ , ë” ë†’ì€ ì§ê¸‰ì¸ ê²½ìš°)
            // ê³ ë ¤ ì‚¬ê´€ í†µí•© 18ë‹¨ê³„ ì§ê¸‰í‘œ (ì¢…9í’ˆâ†’ì •1í’ˆ)
            const positionOrder = [
                'ì¢…9í’ˆ ìˆ˜ë¶„ê¶Œì§€', 'ì •9í’ˆ ì •ì', 'ì¢…8í’ˆ ê²€ì—´', 'ì •8í’ˆ ì£¼ì„œ', 'ì¢…7í’ˆ ì§ë¬¸í•œ', 'ì •7í’ˆ ìˆ˜ì°¬',
                'ì¢…6í’ˆ ê¸°ê±°ë„ìœ„', 'ì •6í’ˆ ê¸°ê±°ë‘', 'ì¢…5í’ˆ ê¸°ê±°ì‚¬', 'ì •5í’ˆ ê¸°ê±°ì£¼',
                'ì¢…4í’ˆ ì‹œê°•í•™ì‚¬', 'ì •4í’ˆ ì‚¬ê´€ìˆ˜ì°¬', 'ì¢…3í’ˆ ì§ìˆ˜ì°¬ê´€', 'ì •3í’ˆ ìˆ˜ì°¬ê´€',
                'ì¢…2í’ˆ ë™ìˆ˜êµ­ì‚¬', 'ì •2í’ˆ ìˆ˜êµ­ì‚¬', 'ì¢…1í’ˆ íŒì‚¬ê´€ì‚¬', 'ì •1í’ˆ ê°ìˆ˜êµ­ì‚¬'
            ];
            
            const oldIndex = positionOrder.indexOf(oldPosition);
            const newIndex = positionOrder.indexOf(newPosition);
            
            // ğŸš© [ìˆ˜ì •] ì´ë¯¸ ì´ ìŠ¹ê¸‰ ì•Œë¦¼ì„ í‘œì‹œí•œ ì ì´ ìˆìœ¼ë©´ ë‹¤ì‹œ ë³´ì—¬ì£¼ì§€ ì•ŠìŒ (1íšŒë§Œ í‘œì‹œ)
            const shownKey = `promotionShown_${newPosition}`;
            if (localStorage.getItem(shownKey)) {
                return;
            }
            
            if (newIndex > oldIndex && oldIndex !== -1) {
                // ìŠ¹ê¸‰ ì•Œë¦¼ì„ í‘œì‹œí–ˆìŒì„ ê¸°ë¡ (1íšŒ í‘œì‹œ ë³´ì¥)
                localStorage.setItem(shownKey, '1');
                // ìŠ¹ê¸‰ íš¨ê³¼ ì˜¤ë²„ë ˆì´ ìƒì„±
                const overlay = document.createElement('div');
                overlay.id = 'promotionOverlay';
                overlay.innerHTML = `
                    <div class="promotion-content">
                        <div class="promotion-icon">ğŸŠ</div>
                        <div class="promotion-title">ìŠ¹ê¸‰ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!</div>
                        <div class="promotion-rank">
                            <span class="old-rank">${oldPosition}</span>
                            <span class="arrow">âœ</span>
                            <span class="new-rank">${newPosition}</span>
                        </div>
                        <div class="promotion-message">ìƒˆë¡œìš´ ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                        <button class="promotion-close" onclick="closePromotionEffect()">í™•ì¸</button>
                    </div>
                `;
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.85);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    animation: fadeIn 0.5s ease;
                `;
                
                // ìŠ¤íƒ€ì¼ ì¶”ê°€
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes scaleIn {
                        from { transform: scale(0.5); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                    @keyframes glow {
                        0%, 100% { box-shadow: 0 0 20px rgba(243, 156, 18, 0.5); }
                        50% { box-shadow: 0 0 40px rgba(243, 156, 18, 0.8), 0 0 60px rgba(230, 126, 34, 0.5); }
                    }
                    @keyframes float {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                    @keyframes confetti {
                        0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
                        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
                    }
                    .promotion-content {
                        background: linear-gradient(145deg, #2c3e50, #34495e);
                        border: 3px solid #f39c12;
                        border-radius: 20px;
                        padding: 40px 60px;
                        text-align: center;
                        animation: scaleIn 0.5s ease, glow 2s ease-in-out infinite;
                    }
                    .promotion-icon {
                        font-size: 80px;
                        animation: float 2s ease-in-out infinite;
                    }
                    .promotion-title {
                        font-size: 2em;
                        color: #f39c12;
                        margin: 20px 0;
                        font-weight: bold;
                        text-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
                    }
                    .promotion-rank {
                        font-size: 1.5em;
                        margin: 30px 0;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 20px;
                    }
                    .old-rank {
                        color: #bdc3c7;
                        text-decoration: line-through;
                    }
                    .arrow {
                        color: #27ae60;
                        font-size: 1.5em;
                        animation: float 1s ease-in-out infinite;
                    }
                    .new-rank {
                        color: #f39c12;
                        font-weight: bold;
                        font-size: 1.3em;
                        text-shadow: 0 0 10px rgba(243, 156, 18, 0.5);
                    }
                    .promotion-message {
                        color: #ecf0f1;
                        margin: 20px 0;
                        font-size: 1.1em;
                    }
                    .promotion-close {
                        background: linear-gradient(135deg, #f39c12, #e67e22);
                        color: #1a1a2e;
                        border: none;
                        padding: 15px 40px;
                        font-size: 1.2em;
                        font-weight: bold;
                        border-radius: 30px;
                        cursor: pointer;
                        margin-top: 20px;
                        transition: all 0.3s ease;
                    }
                    .promotion-close:hover {
                        transform: scale(1.05);
                        box-shadow: 0 5px 20px rgba(243, 156, 18, 0.5);
                    }
                    .confetti {
                        position: fixed;
                        width: 10px;
                        height: 10px;
                        top: 0;
                        animation: confetti 3s linear forwards;
                        z-index: 10001;
                    }
                `;
                document.head.appendChild(style);
                document.body.appendChild(overlay);
                
                // ì»¨í˜í‹° íš¨ê³¼ ì¶”ê°€
                const colors = ['#f39c12', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#1abc9c'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);
                    
                    // 3ì´ˆ í›„ ì œê±°
                    setTimeout(() => confetti.remove(), 5000);
                }
                
                // íš¨ê³¼ìŒ (ì˜µì…˜)
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp6hk4N1bHSAkZ+sraabj394eYWRnqyztK6kkYB2dX+Ok6CwubmwnpOHfHZ7iJOdrLa5t6qckoiAeoKMl6KvuLu1qp6TiYF8gYyXo6+4u7WqnpOJgXyCjJeir7i7taqek4mBfIKMl6OvuLu1qp6TiYF8goyXoq+4u7WqnpOJgXyCjJeir7i7taqek4mBfIKMl6KvuLu1qp6TiYF8goyXoq+4u7WqnpOJgXyCjJejr7i7taqek4mBfIKMl6KvuLu1');
                    audio.volume = 0.3;
                    audio.play().catch(() => {});
                } catch (e) {}
                
                // localStorageì— í˜„ì¬ ì§ê¸‰ ì €ì¥
                localStorage.setItem('lastKnownPosition', newPosition);
            }
        }
        
        // ğŸš© [ì¶”ê°€] ìŠ¹ê¸‰ íš¨ê³¼ ë‹«ê¸° í•¨ìˆ˜
        window.closePromotionEffect = function() {
            const overlay = document.getElementById('promotionOverlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }
        };

        // ğŸš© [ì¶”ê°€] íƒ‘ë°” ì‚¬ìš©ì ì •ë³´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        // ğŸš€ [ìµœì í™”] ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ ìºì‹œ ì¶”ê°€
        let lastUserInfoUpdate = 0;
        const USER_INFO_CACHE_DURATION = 30000; // 30ì´ˆ ìºì‹œ
        
        async function updateTopBarUserInfo(forceUpdate = false, blocking = false) {
            console.log('ğŸš€ updateTopBarUserInfo í˜¸ì¶œë¨ (forceUpdate:', forceUpdate, ', blocking:', blocking, ')');
            
            // ğŸš€ [ìµœì í™”] 30ì´ˆ ì´ë‚´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ (ê°•ì œ ì—…ë°ì´íŠ¸ ì œì™¸)
            const now = Date.now();
            if (!forceUpdate && (now - lastUserInfoUpdate) < USER_INFO_CACHE_DURATION) {
                console.log('â­ï¸ ìºì‹œëœ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš© (ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:', Math.floor((now - lastUserInfoUpdate) / 1000), 'ì´ˆ ì „)');
                return;
            }
            
            console.log('currentUser:', currentUser);
            console.log('token:', token);
            
            if (!currentUser || !token) {
                console.log('âŒ currentUser ë˜ëŠ” tokenì´ ì—†ìŒ');
                return;
            }
            
            // ğŸš© [ìµœì í™”] ì´ˆê¸° ë¡œë”© ì‹œ (blocking=false) ë¡œì»¬ ìºì‹œ ì •ë³´ë¡œ ì¦‰ì‹œ UI ë Œë”ë§
            const usernameDisplay = document.getElementById('usernameDisplay');
            if (!blocking && usernameDisplay) {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìºì‹œëœ ì •ë³´ ì‚¬ìš©
                const cachedPosition = localStorage.getItem('lastKnownPosition') || currentUser.position || 'ë°±ì„±';
                usernameDisplay.textContent = `${cachedPosition} ${currentUser.username}ë‹˜`;
                console.log('âš¡ ìºì‹œëœ ì •ë³´ë¡œ ì¦‰ì‹œ UI ë Œë”ë§:', cachedPosition);
            }
            
            try {
                // ğŸš© [ì¶”ê°€] ì„œë²„ì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë°±ê·¸ë¼ìš´ë“œ)
                console.log('ğŸ“¡ /api/user/me í˜¸ì¶œ ì¤‘... (ë°±ê·¸ë¼ìš´ë“œ)');
                const userResponse = await fetch('/api/user/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (userResponse.ok) {
                    const latestUserInfo = await userResponse.json();
                    console.log('ğŸ‘¤ ìµœì‹  ì‚¬ìš©ì ì •ë³´:', latestUserInfo);
                    // currentUser ì—…ë°ì´íŠ¸ (DB ì§ê¸‰ ë°˜ì˜)
                    if (latestUserInfo.position) {
                        currentUser.position = latestUserInfo.position;
                        console.log('âœ… currentUser.position ì—…ë°ì´íŠ¸:', currentUser.position);
                    }
                }
                
                console.log('ğŸ“¡ /api/rankings í˜¸ì¶œ ì¤‘... (ë°±ê·¸ë¼ìš´ë“œ)');
                // ì‚¬ìš©ìì˜ ë­í‚¹ ë°ì´í„° ì¡°íšŒ
                const response = await fetch('/api/rankings');
                const rankings = await response.json();
                console.log('ğŸ“Š ë­í‚¹ ë°ì´í„°:', rankings);
                
                // í˜„ì¬ ì‚¬ìš©ìì˜ ë­í‚¹ ë°ì´í„° ì°¾ê¸°
                const userRanking = rankings.find(ranking => ranking.username === currentUser.username);
                console.log('ğŸ‘¤ ì‚¬ìš©ì ë­í‚¹ ë°ì´í„°:', userRanking);
                
                if (!usernameDisplay) {
                    console.warn('âš ï¸ usernameDisplay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
                
                if (userRanking) {
                    // ğŸš© [ìˆ˜ì •] DB ì§ê¸‰ì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì‹¤ì‹œê°„ ê³„ì‚°
                    // adminì´ ìˆ˜ë™ìœ¼ë¡œ ì§ê¸‰ì„ ë¶€ì—¬í•œ ê²½ìš° DB ì§ê¸‰ ìš°ì„ 
                    let displayPosition;
                    if (currentUser.position && currentUser.position !== 'ë°±ì„±' && currentUser.position !== 'ìˆ˜ë¶„ê¶Œì§€') {
                        // DBì— ì €ì¥ëœ ì§ê¸‰ì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš© (í’ˆê³„ ì •ê·œí™” í¬í•¨)
                        displayPosition = normalizePosition(currentUser.position);
                        console.log('ğŸ… DB ì§ê¸‰ ì‚¬ìš©:', displayPosition);
                    } else {
                        // DB ì§ê¸‰ì´ ì—†ê±°ë‚˜ ê¸°ë³¸ê°’ì´ë©´ ì‹¤ì‹œê°„ ê³„ì‚°
                        displayPosition = calculateRealtimePosition(userRanking);
                        console.log('ğŸ… ì‹¤ì‹œê°„ ì§ê¸‰ ê³„ì‚°:', displayPosition);
                    }
                    
                    // ğŸš© [ì¶”ê°€] ìŠ¹ê¸‰ ì²´í¬ - ì´ì „ ì§ê¸‰ê³¼ ë¹„êµ
                    const lastKnownPosition = localStorage.getItem('lastKnownPosition');
                    if (lastKnownPosition && lastKnownPosition !== displayPosition) {
                        showPromotionEffect(lastKnownPosition, displayPosition);
                    }
                    
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í˜„ì¬ ì§ê¸‰ ì €ì¥ (ì§ê¸‰ì´ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ì²˜ìŒ ì €ì¥í•˜ëŠ” ê²½ìš°)
                    // lastKnownPositionì´ ì§ê¸‰í‘œì— ì—†ëŠ” êµ¬ë²„ì „ ê°’ì´ì–´ë„ í•­ìƒ ìµœì‹  ì§ê¸‰ìœ¼ë¡œ ê°±ì‹ 
                    localStorage.setItem('lastKnownPosition', displayPosition);
                    
                    // íƒ‘ë°” ì—…ë°ì´íŠ¸
                    usernameDisplay.textContent = `${displayPosition} ${currentUser.username}ë‹˜`;
                    console.log('âœ… íƒ‘ë°” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    // ë­í‚¹ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
                    console.log('âš ï¸ ë­í‚¹ ë°ì´í„° ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©');
                    const defaultPosition = normalizePosition(currentUser.position || 'ë°±ì„±');
                    usernameDisplay.textContent = `${defaultPosition} ${currentUser.username}ë‹˜`;
                    localStorage.setItem('lastKnownPosition', defaultPosition);
                }
                
                // ğŸš€ [ìµœì í™”] ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ê¸°ë¡
                lastUserInfoUpdate = Date.now();
                console.log('âœ… ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ (ìºì‹œ ê°±ì‹ )');
                
            } catch (error) {
                console.error('âŒ íƒ‘ë°” ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ì‹œ ìºì‹œëœ ê°’ ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
                if (usernameDisplay) {
                    const cachedPosition = normalizePosition(localStorage.getItem('lastKnownPosition') || currentUser.position || 'ë°±ì„±');
                    usernameDisplay.textContent = `${cachedPosition} ${currentUser.username}ë‹˜`;
                }
            }
        }



        // ğŸš© [ì¶”ê°€] drawingForm ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© - ìš°ì¸¡ í•˜ë‹¨
        const drawingForm = document.getElementById('drawingForm');
        if (drawingForm) {
            drawingForm.style.position = 'absolute';
            drawingForm.style.bottom = '10px';
            drawingForm.style.right = '10px';
            drawingForm.style.left = 'auto';
            drawingForm.style.top = 'auto';
            drawingForm.style.transform = 'none';
        }
        
        await initialize();
        initializeTopPanelToggle(); // ğŸš© [ì¶”ê°€] PC ë²„ì „ ìƒë‹¨ íŒ¨ë„ í† ê¸€ ì´ˆê¸°í™”

        createEthnicityFilters(); // ğŸš© [ì¶”ê°€] ë¯¼ì¡± í•„í„° ìƒì„±
        createDynastyTimeline(); // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ (ë‚´ë¶€ì—ì„œ tickë„ ìƒì„±)
        
        // ğŸš© [ìˆ˜ì •] ì´ˆê¸°ì—ëŠ” timeline-sidebar í‘œì‹œ (ì—°ëŒ€í‘œê°€ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡)
        // ğŸš© [ìˆ˜ì •] timeline-sidebar ì´ˆê¸° ìƒíƒœ ì„¤ì • (layerVisibilityì— ë”°ë¼)
        const timelineSidebar = document.getElementById('timeline-sidebar');
        if (timelineSidebar) {
            if (layerVisibility && layerVisibility.timeline) {
                timelineSidebar.style.display = 'block';
                timelineSidebar.style.opacity = '1';
            } else {
                timelineSidebar.style.display = 'none';
                timelineSidebar.style.opacity = '0';
            }
        }
        
        const checkTimelineDragged = initTimelineDrag(); // ğŸš© [ìˆ˜ì •] ë“œë˜ê·¸ ìƒíƒœ ì²´í¬ í•¨ìˆ˜ë¥¼ ì €ì¥
        initTimelineSidebarDrag(); // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ì‚¬ì´ë“œë°” ë“œë˜ê·¸ ìŠ¤í¬ë¡¤

        // ğŸš© [ìµœì í™”] ë ˆì´ì–´ ì„¤ì • UIë§Œ ë™ê¸°í™” (API í˜¸ì¶œ ì œê±°, ë©”ëª¨ë¦¬ ìºì‹œ ì‚¬ìš©)
        console.log('ğŸ DOMContentLoaded ì™„ë£Œ, ë ˆì´ì–´ ì„¤ì • UI ë™ê¸°í™”');
        if (layerVisibility) {
            applyLayerSettingsToUI(layerVisibility);
            console.log('âœ… ë ˆì´ì–´ UI ë™ê¸°í™” ì™„ë£Œ (ìºì‹œ ì‚¬ìš©)');
        }

        // ğŸš© [ì¶”ê°€] UI ì»¨í…Œì´ë„ˆì—ì„œ í´ë¦­/ë“œë˜ê·¸ ì „íŒŒ ì°¨ë‹¨ (ì§€ë„ì™€ì˜ ì´ë²¤íŠ¸ ì¶©ëŒ ë°©ì§€)
        (function disableUIEventPropagation() {
            const uiIds = [
                'controls-wrapper','timeline-control','hamburger-menu-panel',
                'mobile-layer-menu','map-history-panel','map-king-panel','leftColumn','rightPanel','top-bar-container',
                'event-sidebar'
            ];
            uiIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && L && L.DomEvent && typeof L.DomEvent.disableClickPropagation === 'function') {
                    L.DomEvent.disableClickPropagation(el);
                    L.DomEvent.disableScrollPropagation && L.DomEvent.disableScrollPropagation(el);
                }
            });
        })();
        
        // ğŸš© [ì¶”ê°€] ì¤Œ ë ˆë²¨ ê¸°ë°˜ ì„± ë§ˆì»¤ í•„í„°ë§ í•¨ìˆ˜
        function isCapitalCastle(castle) {
            // ìˆ˜ë„ íŒë³„: is_capital í•„ë“œê°€ trueì´ê±°ë‚˜ ì£¼ìš” ê±°ì /ìˆ˜ë„ ì´ë¦„
            if (castle.is_capital === true) return true;
            
            const capitalNames = [
                // ì£¼ìš” ìˆ˜ë„ ë° ë„ì‹œ
                'ì„œìš¸', 'í•œì„±', 'ê²½ì„±', 'í‰ì–‘', 'ê°œì„±', 'ê°œê²½', 'ë‚¨ê²½', 'ì„œê²½', 'ë™ê²½', 'ì¤‘ê²½', 'ìƒê²½', 'í•˜ê²½',
                'ë¶€ì—¬', 'ê³µì£¼', 'ì›…ì§„', 'ì‚¬ë¹„', 'ê²½ì£¼', 'ì„œë¼ë²Œ', 'ê¸ˆì„±', 'ì›”ì„±', 'ê³„ë¦¼', 'ëŒ€êµ¬', 'í¬í•­', 'ìš¸ì‚°', 'ì°½ì›', 'ì§„ì£¼',
                'ì¡¸ë³¸', 'êµ­ë‚´ì„±', 'í™˜ë„ì‚°ì„±', 'í‰ì–‘ì„±', 'ì•ˆí•™ê¶', 'ì¥ì•ˆì„±', 'ì¶•ì„±', 'ìˆ˜ì„±', 'ë‚™ë‘', 'ëŒ€ë™',
                'ì² ì›', 'í™©ì£¼', 'ê°•ë¦‰', 'ì¶˜ì²œ', 'ìˆ˜ì›', 'ì„±ê· ê´€', 'ì¸ì²œ', 'ê°•í™”', 'ê´‘ì£¼', 'ì „ì£¼', 'ì²­ì£¼', 'ë¶€ì‚°',
                'ìš©ì²œ', 'ìš©ì›', 'í˜„ë•', 'ì••ë¡', 'ë‚¨í•´', 'ìƒê²½ìš©ì²œë¶€', 'ë™ê²½ìš©ì›ë¶€', 'ì¤‘ê²½í˜„ë•ë¶€', 'ì„œê²½ì••ë¡ë¶€', 'ë‚¨ê²½ë‚¨í•´ë¶€',
                // ì™•ì¡°ë³„ ì£¼ìš” ë„ì‹œ
                'ê³ ë ¤', 'ì¡°ì„ ', 'ê³ êµ¬ë ¤', 'ë°±ì œ', 'ì‹ ë¼', 'í†µì¼ì‹ ë¼', 'ë°œí•´', 'ê°€ì•¼', 'ë§ˆí•œ', 'ì§„í•œ', 'ë³€í•œ',
                // ì£¼ìš” ì„± ì´ë¦„ íŒ¨í„´
                'ê¶', 'ì„±', 'ê²½', 'ë¶€', 'ì§„', 'ì£¼', 'êµ°', 'í˜„', 'ë„', 'ëª©'
            ];
            
            // ì´ë¦„ì´ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
            if (castle.name) {
                return capitalNames.some(capital => castle.name.includes(capital)) ||
                       castle.name.includes('ìˆ˜ë„') ||
                       castle.name.includes('ë„ì') ||
                       castle.name.includes('ì™•ë„') ||
                       castle.name.includes('ì²œë„');
            }
            
            return false;
        }
        
        // ğŸš€ [ìµœì í™”] updateCastleMarkersByZoomì€ applyLODModeê°€ ëŒ€ì²´
        // zoom < 7: applyLODModeê°€ castleLayerGroup ì „ì²´ë¥¼ removeLayer â†’ ë§ˆì»¤ ê°œë³„ ì¡°ì‘ ë¶ˆí•„ìš”
        // zoom >= 7: updateMapì´ ë·°í¬íŠ¸ ê¸°ë°˜ í•„í„°ë§ìœ¼ë¡œ ë Œë”ë§ â†’ ê°œë³„ add/remove ë¶ˆí•„ìš”
        function updateCastleMarkersByZoom() {
            // LOD ì‹œìŠ¤í…œì´ ì²˜ë¦¬í•˜ë¯€ë¡œ ë¹ˆ í•¨ìˆ˜ë¡œ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
            return;
        }
        
        // ğŸš© [ì¶”ê°€] ì¤Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ë¹„í™œì„±í™” â€” applyLODModeê°€ ëŒ€ì²´)
        // if (map) { map.on('zoomend', updateCastleMarkersByZoom); }
        
        // ğŸš€ [ìµœì í™”] ì´ë²¤íŠ¸ ê·¸ë£¹í™” ìºì‹œ â€” ë™ì¼í•œ events ë°ì´í„°ì— ëŒ€í•´ ì¬ê³„ì‚° ë°©ì§€
        let _eventGroupCache = null;
        let _eventGroupCacheKey = null;
        
        // ğŸ¯ [ê³¼ì œ2 êµ¬í˜„] events ë°ì´í„°ë¥¼ DBì˜ category/ethnicity í•„ë“œë¡œ ë™ì  ê·¸ë£¹í™”
        function categorizeEventsDynamic(eventsData) {
            // ğŸš€ [ìµœì í™”] ìºì‹œ í‚¤ = events ë°°ì—´ ê¸¸ì´ + ì²« ë²ˆì§¸/ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ID (ë³€ê²½ ê°ì§€)
            const cacheKey = `${eventsData.length}_${eventsData[0]?._id || ''}_${eventsData[eventsData.length - 1]?._id || ''}`;
            if (_eventGroupCache && _eventGroupCacheKey === cacheKey) {
                return _eventGroupCache;
            }
            
            const groups = {};

            eventsData.forEach(event => {
                let groupKey = null;

                // 1ì°¨: country_idë¡œ êµ­ê°€ëª… ë§¤ì¹­ (ê°€ì¥ ì •í™•)
                if (event.country_id) {
                    const country = getCountryInfoById(event.country_id);
                    if (country) groupKey = country.name;
                }

                // 2ì°¨: titleì—ì„œ êµ­ê°€ëª… í‚¤ì›Œë“œ ë§¤ì¹­ (í•œêµ­ ì™•ì¡°ëª… ìš°ì„ )
                if (!groupKey && event.title) {
                    const title = event.title;
                    const dynastyKeywords = ['ê³ êµ¬ë ¤', 'ë°±ì œ', 'ì‹ ë¼', 'ê³ ë ¤', 'ì¡°ì„ ', 'ë°œí•´', 'ê°€ì•¼', 'ë¶€ì—¬', 'ë§ˆí•œ', 'ì§„í•œ', 'ë³€í•œ', 'ë™ì´'];
                    const matched = dynastyKeywords.find(k => title.includes(k));
                    if (matched) {
                        groupKey = matched;
                    } else {
                        // DB countriesì—ì„œ ë§¤ì¹­ ì‹œë„
                        const matchedCountry = countries.find(c => c.name && title.includes(c.name));
                        if (matchedCountry) groupKey = matchedCountry.name;
                    }
                }

                // 3ì°¨: DB ethnicity ë˜ëŠ” category í•„ë“œ (í´ë°±)
                if (!groupKey) {
                    groupKey = event.ethnicity || event.category || 'ê¸°íƒ€';
                }

                if (!groups[groupKey]) groups[groupKey] = [];
                groups[groupKey].push(event);
            });

            // ğŸ¯ [ë™ì´ì¡± ìš°ì„ ] ì •ë ¬: ë™ì´ì¡± ìµœìƒë‹¨, ê·¸ ë’¤ ê³ êµ¬ë ¤â†’ë°±ì œâ†’ì‹ ë¼â†’ê³ ë ¤â†’ë°œí•´ ìˆœ, ë‚˜ë¨¸ì§€ëŠ” ì´ë²¤íŠ¸ ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
            const priorityOrder = ['ë™ì´ì¡±', 'ë™ì´', 'ê³ êµ¬ë ¤', 'ë°±ì œ', 'ì‹ ë¼', 'ê°€ì•¼', 'ê³ ë ¤', 'ë°œí•´', 'ì¡°ì„ ', 'ë¶€ì—¬', 'ë§ˆí•œ', 'ì§„í•œ', 'ë³€í•œ'];
            const sorted = Object.entries(groups)
                .sort(([a, evtA], [b, evtB]) => {
                    const idxA = priorityOrder.findIndex(p => a.includes(p));
                    const idxB = priorityOrder.findIndex(p => b.includes(p));
                    // ë‘˜ ë‹¤ ìš°ì„ ìˆœìœ„ ëª©ë¡ì— ìˆìœ¼ë©´ ëª©ë¡ ìˆœì„œëŒ€ë¡œ
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    // í•œìª½ë§Œ ìš°ì„ ìˆœìœ„ ëª©ë¡ì— ìˆìœ¼ë©´ ê·¸ìª½ì´ ìœ„
                    if (idxA !== -1) return -1;
                    if (idxB !== -1) return 1;
                    // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì´ë²¤íŠ¸ ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
                    return evtB.length - evtA.length;
                });
            const result = Object.fromEntries(sorted);
            
            // ğŸš€ [ìµœì í™”] ìºì‹œ ì €ì¥
            _eventGroupCache = result;
            _eventGroupCacheKey = cacheKey;
            
            return result;
        }
        
        // ğŸ¯ [ê³¼ì œ2 êµ¬í˜„] ìš°ì¸¡ ì‚¬ì´ë“œë°”ì— ì•„ì½”ë””ì–¸ í˜•íƒœë¡œ ë Œë”ë§ (DB ê¸°ë°˜ ë™ì  ë¶„ë¥˜)
        function renderEventSidebar() {
            // ğŸš€ [ìµœì í™”] ì‚¬ê±´ëª©ë¡ í† ê¸€ì´ êº¼ì ¸ ìˆìœ¼ë©´ ë Œë”ë§ ìì²´ë¥¼ ìŠ¤í‚µ
            if (!layerVisibility || !layerVisibility.eventSidebar) {
                return;
            }
            
            // ğŸ›¡ï¸ [ë°©ì–´] event-sidebar DOM ì¡´ì¬ ì—¬ë¶€ ë¨¼ì € í™•ì¸ (null ì°¸ì¡° ë°©ì§€)
            const sidebarEl = document.getElementById('event-sidebar');
            const contentDiv = document.getElementById('event-sidebar-content');
            if (!sidebarEl || !contentDiv) {
                console.warn('âš ï¸ renderEventSidebar: #event-sidebar ë˜ëŠ” #event-sidebar-content DOM ì—†ìŒ');
                return;
            }
            
            // eventsì™€ historicalEvents ë³‘í•© (ë‘˜ ë‹¤ í™œìš©)
            const allEvents = (typeof events !== 'undefined' && events && events.length > 0) ? events 
                : (typeof historicalEvents !== 'undefined' && historicalEvents ? historicalEvents : []);
            if (!allEvents || allEvents.length === 0) {
                contentDiv.innerHTML = '<p style="color: #999; text-align: center;">í‘œì‹œí•  ì‚¬ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const groups = categorizeEventsDynamic(allEvents);
            
            // ê¸°ì¡´ ë‚´ìš© í´ë¦¬ì–´
            contentDiv.innerHTML = '';
            
            // ê° ê·¸ë£¹ë³„ ì•„ì½”ë””ì–¸ ìƒì„±
            Object.entries(groups).forEach(([groupName, groupEvents]) => {
                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                
                // ê·¸ë£¹ë³„ ìƒ‰ìƒ (DBì˜ country color ë˜ëŠ” ê¸°ë³¸ìƒ‰)
                const matchedCountry = countries.find(c => c.name === groupName);
                const groupColor = matchedCountry?.color || '#4ecdc4';
                
                const header = document.createElement('button');
                header.className = 'accordion-header';
                header.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${groupColor};margin-right:6px;"></span>${groupName} <span style="color:#aaa;">(${groupEvents.length}ê±´)</span>`;
                header.onclick = () => {
                    const content = header.nextElementSibling;
                    content.classList.toggle('open');
                    header.classList.toggle('active');
                };
                
                const content = document.createElement('div');
                content.className = 'accordion-content';
                
                // ì´ë²¤íŠ¸ë¥¼ ì—°ë„ ìˆœìœ¼ë¡œ ì •ë ¬
                groupEvents.sort((a, b) => (a.year || 0) - (b.year || 0));
                
                // ì´ë²¤íŠ¸ ëª©ë¡ ìƒì„±
                groupEvents.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.className = 'event-item';
                    
                    const eventYear = event.year || 'ì—°ë„ë¯¸ìƒ';
                    const title = event.title || event.name || 'ì œëª©ì—†ìŒ';
                    const description = event.description || '';
                    
                    eventItem.innerHTML = `
                        <div class="event-year">${eventYear < 0 ? 'B.C. ' + Math.abs(eventYear) : eventYear}ë…„</div>
                        <div class="event-title">${title}</div>
                        ${description ? `<div class="event-description">${description.substring(0, 80)}${description.length > 80 ? '...' : ''}</div>` : ''}
                    `;
                    
                    // ğŸ¯ [ê³¼ì œ2 í•µì‹¬] í´ë¦­ ì‹œ íƒ€ì„ìŠ¬ë¼ì´ë” ì—°ë„ ë³€ê²½ + updateMap í˜¸ì¶œ
                    eventItem.addEventListener('click', () => {
                        if (event.year) {
                            const targetMonth = event.month || 1;
                            const targetTotalMonths = yearMonthToTotalMonths(event.year, targetMonth);
                            
                            // íƒ€ì„ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½
                            if (combinedSlider) {
                                combinedSlider.value = targetTotalMonths;
                                combinedSlider.dispatchEvent(new Event('input'));
                            }
                            if (yearInput) {
                                yearInput.value = event.year;
                            }
                            
                            // ì§€ë„ ê°±ì‹ 
                            updateMap(event.year, targetMonth, false, true);
                            
                            console.log(`ğŸ“œ [ì—°ëŒ€í‘œ] ì‚¬ê±´ í´ë¦­: "${title}" â†’ ${event.year}ë…„ ${targetMonth}ì›”ë¡œ ì´ë™`);
                        }
                    });
                    
                    content.appendChild(eventItem);
                });
                
                accordionItem.appendChild(header);
                accordionItem.appendChild(content);
                contentDiv.appendChild(accordionItem);
            });

            // ğŸš© [ê³¼ì œ2] ì‚¬ì´ë“œë°”ì— L.DomEvent.disableClickPropagation ì ìš© (ì§€ë„ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€)
            const sidebar = document.getElementById('event-sidebar');
            if (sidebar && typeof L !== 'undefined' && L.DomEvent) {
                L.DomEvent.disableClickPropagation(sidebar);
                L.DomEvent.disableScrollPropagation(sidebar);
            }
            
            console.log(`âœ… renderEventSidebar: ${Object.keys(groups).length}ê°œ ê·¸ë£¹, ì´ ${allEvents.length}ê°œ ì´ë²¤íŠ¸ ë Œë”ë§ ì™„ë£Œ`);
        }

        // ğŸš© [ê³¼ì œ2] ì‚¬ê±´ëª©ë¡ ì‚¬ì´ë“œë°” ë‹«ê¸° ë²„íŠ¼
        const closeEventSidebarBtn = document.getElementById('close-event-sidebar');
        if (closeEventSidebarBtn) {
            closeEventSidebarBtn.addEventListener('click', () => {
                const eventSidebar = document.getElementById('event-sidebar');
                if (eventSidebar) eventSidebar.classList.remove('open');
                layerVisibility.eventSidebar = false;
                const btn = document.querySelector('.layer-toggle-btn[data-layer="eventSidebar"]');
                if (btn) btn.classList.remove('active');
            });
        }

        // ğŸš© [ê³¼ì œ2] ì‚¬ì´ë“œë°”, íƒ€ì„ë¼ì¸ ë“± UI ì»¨í…Œì´ë„ˆì— L.DomEvent ì „íŒŒ ë°©ì§€
        ['event-sidebar', 'timeline-sidebar', 'timeline-control', 'map-king-panel'].forEach(id => {
            const el = document.getElementById(id);
            if (el && typeof L !== 'undefined' && L.DomEvent) {
                L.DomEvent.disableClickPropagation(el);
                L.DomEvent.disableScrollPropagation(el);
            }
        });
        
        // ğŸš€ [ìµœì í™”] ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ (ë°±ê·¸ë¼ìš´ë“œ, Non-blocking)
        if (currentUser && token) {
            console.log('ğŸ” [DOMContentLoaded] updateTopBarUserInfo() ë°±ê·¸ë¼ìš´ë“œ í˜¸ì¶œ ì‹œì‘');
            setTimeout(() => {
                updateTopBarUserInfo(false, false).then(() => {
                    console.log('âœ… [DOMContentLoaded] updateTopBarUserInfo() ë°±ê·¸ë¼ìš´ë“œ ì™„ë£Œ');
                }).catch(err => {
                    console.error('âš ï¸ [DOMContentLoaded] updateTopBarUserInfo() ì˜¤ë¥˜:', err);
                });
            }, 200); // 200ms í›„ ì‹¤í–‰ (ì´ˆê¸°í™” ì™„ë£Œ í›„)
        }

    // initializeDrawControl(); // ê·¸ë¦¬ê¸° ì»¨íŠ¸ë¡¤ì€ í¸ì§‘ëª¨ë“œì—ì„œë§Œ í™œì„±í™”

        // ğŸ” [NEW] í–„ë²„ê±° ë©”ë‰´ ê¸°ëŠ¥ ì´ˆê¸°í™”
        const hamburgerBtn = document.getElementById('hamburger-menu-btn');
        const hamburgerPanel = document.getElementById('hamburger-menu-panel');
        const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');
        
        function toggleHamburgerMenu() {
            const isActive = hamburgerPanel.classList.contains('active');
            if (isActive) {
                hamburgerPanel.classList.remove('active');
                hamburgerOverlay.classList.remove('active');
                hamburgerBtn.classList.remove('active');
            } else {
                // ğŸš© [ìˆ˜ì •] ë©”ë‰´ ì—´ ë•Œ í˜„ì¬ ì§€ë„ì˜ ì—°ì›”ê³¼ ì—°ë™
                const { year, month } = getCurrentYearMonth();
                const menuYearEl = document.getElementById('menu-year-input');
                const menuMonthEl = document.getElementById('menu-month-input');
                if (menuYearEl) menuYearEl.value = year;
                if (menuMonthEl) menuMonthEl.value = month;

                // ğŸš© [ì¶”ê°€] admin/superuser ì „ìš© ë²„íŠ¼ â€” ì—´ ë•Œë§ˆë‹¤ ê¶Œí•œ ì¬í™•ì¸
                const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'superuser');
                const userMgmtBtn = document.getElementById('menu-user-management');
                const terrMgmtBtn = document.getElementById('menu-territory-management');
                if (userMgmtBtn) userMgmtBtn.style.display = isAdmin ? '' : 'none';
                if (terrMgmtBtn) terrMgmtBtn.style.display = isAdmin ? '' : 'none';
                
                hamburgerPanel.classList.add('active');
                hamburgerOverlay.classList.add('active');
                hamburgerBtn.classList.add('active');
            }
        }
        
        if (hamburgerBtn) {
            hamburgerBtn.addEventListener('click', toggleHamburgerMenu);
        }
        
        if (hamburgerOverlay) {
            hamburgerOverlay.addEventListener('click', toggleHamburgerMenu);
        }
        
        // ğŸ” ë©”ë‰´ ë‚´ ê²€ìƒ‰ ê¸°ëŠ¥ ì—°ê²°
        const menuSearchBtn = document.getElementById('menu-search-btn');
        const menuSearchInput = document.getElementById('menu-search-input');
        if (menuSearchBtn && menuSearchInput) {
            menuSearchBtn.addEventListener('click', () => {
                const searchTerm = menuSearchInput.value;
                const mapSearchInput = document.getElementById('mapSearchInput');
                if (mapSearchInput) {
                    mapSearchInput.value = searchTerm;
                    document.getElementById('mapSearchBtn')?.click();
                }
                toggleHamburgerMenu();
            });
        }
        
        // ğŸ” ë©”ë‰´ ë‚´ ì‹œê°„ ì´ë™ ê¸°ëŠ¥ ì—°ê²°
        const menuGoToTimeBtn = document.getElementById('menu-go-to-time');
        const menuYearInput = document.getElementById('menu-year-input');
        const menuMonthInput = document.getElementById('menu-month-input');
        if (menuGoToTimeBtn && menuYearInput && menuMonthInput) {
            const doMenuGoToTime = () => {
                const year = parseInt(menuYearInput.value);
                const month = Math.min(12, Math.max(1, parseInt(menuMonthInput.value) || 1));
                if (isNaN(year)) return;
                // ìŠ¬ë¼ì´ë” ë²”ìœ„ í´ë¨í”„
                const totalMonths = yearMonthToTotalMonths(year, month);
                const sMin = parseInt(combinedSlider.min);
                const sMax = parseInt(combinedSlider.max);
                const clamped = Math.min(sMax, Math.max(sMin, totalMonths));
                combinedSlider.value = clamped;
                // yearInput/monthInput ë™ê¸°í™”
                const mapped = totalMonthsToYearMonth(clamped);
                document.getElementById('yearInput').value = mapped.year;
                document.getElementById('monthInput').value = mapped.month;
                updateTime(mapped.year, mapped.month);
                // ğŸš© [ìˆ˜ì •] ë©”ë‰´ë¥¼ ë‹«ì€ ë’¤ ë¼ë²¨ì„ í•œ ë²ˆ ë” ëª…ì‹œì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                toggleHamburgerMenu();
                updateUI(mapped.year, mapped.month);
                updateSliderTooltip(mapped.year, mapped.month); // current-year-display ì—…ë°ì´íŠ¸

                // ğŸš© [ì¶”ê°€] í•´ë‹¹ ì‹œì ì˜ ìˆ˜ë„ â†’ ì§€ë„ ì´ë™
                setTimeout(() => {
                    const targetTotal = yearMonthToTotalMonths(mapped.year, mapped.month);
                    // í˜„ì¬ ì‹œì ì— í™œì„±í™”ëœ ìˆ˜ë„ ë§ˆì»¤ íƒìƒ‰
                    let capital = castles.find(c => {
                        if (!c.lat || !c.lng) return false;
                        const hist = getActiveHistoryInfo(c.history, targetTotal);
                        return hist && (hist.record.is_capital || c.is_capital);
                    });
                    // ìˆ˜ë„ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œì ì— í™œì„±í™”ëœ ì²« ë²ˆì§¸ ì„±/ë„ì‹œ
                    if (!capital) {
                        capital = castles.find(c => {
                            if (!c.lat || !c.lng || c.is_label || c.is_natural_feature || c.is_military_flag) return false;
                            return getActiveHistoryInfo(c.history, targetTotal) !== null;
                        });
                    }
                    if (capital) {
                        map.flyTo([capital.lat, capital.lng], Math.max(map.getZoom(), 5), { animate: true, duration: 1.2 });
                    }
                }, 100);
            };
            menuGoToTimeBtn.addEventListener('click', doMenuGoToTime);
            menuYearInput.addEventListener('keydown', e => { if (e.key === 'Enter') doMenuGoToTime(); });
            menuMonthInput.addEventListener('keydown', e => { if (e.key === 'Enter') doMenuGoToTime(); });
        }
        
        // ğŸ” ë©”ë‰´ ë‚´ ë ˆì´ì–´ í† ê¸€ ì—°ê²°
        const layerCheckboxes = {
            'menu-layer-city': 'city',
            'menu-layer-territory': 'territoryPolygon',
            'menu-layer-country-label': 'countryLabel',
            'menu-layer-place-label': 'placeLabel',
            'menu-layer-ethnic-label': 'ethnicLabel',
            'menu-layer-military': 'military',
            'menu-layer-natural': 'natural',
            'menu-layer-rivers': 'rivers',
            'menu-layer-timeline': 'timeline',
            'menu-layer-king': 'kingPanel',
            'menu-layer-history': 'historyPanel'
        };
        
        Object.keys(layerCheckboxes).forEach(checkboxId => {
            const checkbox = document.getElementById(checkboxId);
            const layerName = layerCheckboxes[checkboxId];
            if (checkbox) {
                checkbox.checked = layerVisibility[layerName] === true;
                checkbox.addEventListener('change', () => {
                    layerVisibility[layerName] = checkbox.checked;
                    if (layerName === 'timeline') {
                        // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ í† ê¸€ ì‹œ timeline-sidebar í‘œì‹œ/ìˆ¨ê¹€
                        const timelineSidebar = document.getElementById('timeline-sidebar');
                        if (timelineSidebar) {
                            timelineSidebar.style.display = checkbox.checked ? 'block' : 'none';
                        }
                        // ì—°ëŒ€í‘œ ì¬ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
                        if (checkbox.checked) {
                            createDynastyTimeline();
                        }
                    } else if (layerName === 'kingPanel' || layerName === 'historyPanel') {
                        const panelMap = {
                            'kingPanel': document.getElementById('map-king-panel'),
                            'historyPanel': document.getElementById('map-history-panel')
                        };
                        const panel = panelMap[layerName];
                        if (panel) {
                            panel.style.display = checkbox.checked ? 'block' : 'none';
                        }
                    } else {
                        const { year, month } = getCurrentYearMonth();
                        updateMap(year, month);
                    }
                });
            }
        });
        
        // ğŸ” ë©”ë‰´ ë‚´ ë¯¼ì¡± í•„í„° ì—°ê²°
        const menuEthnicitySelect = document.getElementById('menu-ethnicity-select');
        if (menuEthnicitySelect) {
            // ë¯¼ì¡± ì˜µì…˜ ì±„ìš°ê¸° - countries ë¡œë“œ í›„ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥
            setTimeout(() => {
                if (countries && countries.length > 0) {
                    const ethnicities = [...new Set(countries.map(c => c.ethnicity).filter(e => e))];
                    console.log('ğŸ” ë¯¼ì¡± í•„í„° ì±„ìš°ê¸°:', ethnicities);
                    ethnicities.forEach(eth => {
                        const option = document.createElement('option');
                        option.value = eth;
                        option.textContent = eth;
                        menuEthnicitySelect.appendChild(option);
                    });
                }
            }, 1000);
            
            menuEthnicitySelect.addEventListener('change', () => {
                selectedEthnicity = menuEthnicitySelect.value;
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
            });
        }
        
        // ğŸ” ë©”ë‰´ ë‚´ êµ­ê°€ í•„í„° ì—°ê²°
        const menuCountrySelect = document.getElementById('menu-country-select');
        if (menuCountrySelect) {
            // êµ­ê°€ ì˜µì…˜ ì±„ìš°ê¸° - countries ë¡œë“œ í›„ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥
            setTimeout(() => {
                if (countries && countries.length > 0) {
                    console.log('ğŸ” êµ­ê°€ í•„í„° ì±„ìš°ê¸°:', countries.length);
                    countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country._id;
                        option.textContent = country.name;
                        menuCountrySelect.appendChild(option);
                    });
                }
            }, 1000);
            
            menuCountrySelect.addEventListener('change', () => {
                selectedCountryId = menuCountrySelect.value;
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
            });
        }
        
        // ğŸ” ë©”ë‰´ ë‚´ ë„êµ¬ ë²„íŠ¼ ì—°ê²°
        const menuHistoricalRecordBtn = document.getElementById('menu-historical-record');
        if (menuHistoricalRecordBtn) {
            menuHistoricalRecordBtn.addEventListener('click', () => {
                console.log('ğŸ“œ ì‚¬ê´€ ê¸°ë¡ ì œì¶œ ë©”ë‰´ ë²„íŠ¼ í´ë¦­ë¨');
                const form = document.getElementById('historicalRecordForm');
                if (form) {
                    console.log('ğŸ“œ í¼ ìš”ì†Œ ë°œê²¬, í‘œì‹œí•¨');
                    form.style.display = 'block';
                    openForm('historicalRecordForm'); // ì¤‘ì•™ ì •ë ¬
                } else {
                    console.log('âŒ historicalRecordForm ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
                toggleHamburgerMenu();
            });
        } else {
            console.log('âŒ menu-historical-record ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }
        
        // ğŸš© [ì¶”ê°€] ì‚¬ê´€ ì‚¬ë£Œ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const menuContributionsToggle = document.getElementById('menu-layer-contributions');
        if (menuContributionsToggle) {
            menuContributionsToggle.addEventListener('change', () => {
                if (menuContributionsToggle.checked) {
                    // ì‚¬ë£Œ ë ˆì´ì–´ í‘œì‹œ
                    if (contributionLayerGroup && !map.hasLayer(contributionLayerGroup)) {
                        contributionLayerGroup.addTo(map);
                    }
                } else {
                    // ì‚¬ë£Œ ë ˆì´ì–´ ìˆ¨ê¹€
                    if (contributionLayerGroup && map.hasLayer(contributionLayerGroup)) {
                        map.removeLayer(contributionLayerGroup);
                    }
                }
            });
        }
        
        // ğŸš© [ì¶”ê°€] í–„ë²„ê±° ë©”ë‰´ - ê³„ì • ê´€ë¦¬ ë²„íŠ¼
        const menuAccountBtn = document.getElementById('menu-account-management');
        if (menuAccountBtn) {
            menuAccountBtn.addEventListener('click', () => {
                // íŒì—… ì°½ í¬ê¸° ë° ìœ„ì¹˜ ì„¤ì •
                const width = 500;
                const height = 600;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                window.open(
                    'account.html',
                    'accountPopup',
                    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
                );
                toggleHamburgerMenu();
            });
        }
        
        // ğŸš© [ì¶”ê°€] í–„ë²„ê±° ë©”ë‰´ - íšŒì› ê´€ë¦¬ ë²„íŠ¼ (admin/superuser ì „ìš©)
        const menuUserBtn = document.getElementById('menu-user-management');
        if (menuUserBtn) {
            // admin/superuserì—ê²Œë§Œ ë²„íŠ¼ í‘œì‹œ
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'superuser')) {
                menuUserBtn.style.display = '';
            }
            menuUserBtn.addEventListener('click', () => {
                // íŒì—… ì°½ í¬ê¸° ë° ìœ„ì¹˜ ì„¤ì •
                const width = 1200;
                const height = 800;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                window.open(
                    'admin.html',
                    'adminPopup',
                    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
                );
                toggleHamburgerMenu();
            });
        }
        
        // ğŸš© [ì¶”ê°€] í–„ë²„ê±° ë©”ë‰´ - ì˜í†  ê´€ë¦¬ ë²„íŠ¼ (admin/superuser ì „ìš©)
        const menuTerritoryBtn = document.getElementById('menu-territory-management');
        if (menuTerritoryBtn) {
            // admin/superuserì—ê²Œë§Œ ë²„íŠ¼ í‘œì‹œ
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'superuser')) {
                menuTerritoryBtn.style.display = '';
            }
            menuTerritoryBtn.addEventListener('click', () => {
                // íŒì—… ì°½ í¬ê¸° ë° ìœ„ì¹˜ ì„¤ì •
                const width = 1400;
                const height = 900;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                window.open(
                    'territory_manager.html',
                    'territoryPopup',
                    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
                );
                toggleHamburgerMenu();
            });
        }
        
        // ğŸš© [ì¶”ê°€] í–„ë²„ê±° ë©”ë‰´ - ë­í‚¹ ë²„íŠ¼
        const menuRankingBtn = document.getElementById('menu-ranking-btn');
        if (menuRankingBtn) {
            menuRankingBtn.addEventListener('click', () => {
                window.open('ranking.html', '_blank', 'width=900,height=700,scrollbars=yes');
                toggleHamburgerMenu();
            });
        }
        
        // ğŸš© [ì¶”ê°€] í–„ë²„ê±° ë©”ë‰´ - ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const menuLogoutBtn = document.getElementById('menu-logout');
        if (menuLogoutBtn) {
            menuLogoutBtn.addEventListener('click', () => {
                if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    // ë‘ ì €ì¥ì†Œì˜ í† í°ì„ ëª¨ë‘ ì‚­ì œ
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('token');
                    window.location.href = 'login.html';
                }
                toggleHamburgerMenu();
            });
        }
        
        // ğŸš© [ì¶”ê°€] ìƒë‹¨ íƒ‘ë°” í¸ì§‘ ë²„íŠ¼ ê¸°ëŠ¥
        const topbarEditBtn = document.getElementById('topbarEditBtn');
        const topbarEditDropdownMenu = document.getElementById('topbar-edit-dropdown-menu');
        const topbarEditContainer = document.getElementById('topbar-edit-dropdown-container');
        
        if (topbarEditBtn && topbarEditDropdownMenu) {
            topbarEditBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = topbarEditDropdownMenu.style.display === 'block';
                topbarEditDropdownMenu.style.display = isVisible ? 'none' : 'block';
            });
            
            // í¸ì§‘ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', (e) => {
                if (topbarEditContainer && !topbarEditContainer.contains(e.target)) {
                    topbarEditDropdownMenu.style.display = 'none';
                }
            });
            
            // í¸ì§‘ ë²„íŠ¼ë“¤ ì—°ê²°
            document.getElementById('topbar-cityEditBtn')?.addEventListener('click', () => {
                closeAllFormsExcept('editCitySelectionForm');
                openForm('editCitySelectionForm');
                const searchInput = document.getElementById('editCitySelectionForm')?.querySelector('#citySearchInputForEdit');
                if (searchInput) searchInput.value = '';
                populateCitySelectForEdit();
                topbarEditDropdownMenu.style.display = 'none';
            });
            
            document.getElementById('topbar-countryEditBtn')?.addEventListener('click', () => {
                closeAllFormsExcept('countryForm');
                openForm('countryForm');
                updateCountrySelectForEdit();
                document.getElementById('editCountryForm').reset();
                document.getElementById('countryOriginalName').value = '';
                document.getElementById('countryOriginalId').value = '';
                document.getElementById('deleteCountryBtn').style.display = 'none';
                document.getElementById('saveCountryBtn').textContent = 'ì €ì¥/ì¶”ê°€';
                document.getElementById('countryColor').value = '#ffffff';
                const searchInput = document.getElementById('countryForm')?.querySelector('#countrySearchForEdit');
                if (searchInput) searchInput.value = '';
                topbarEditDropdownMenu.style.display = 'none';
            });
            
            document.getElementById('topbar-kingEditBtn')?.addEventListener('click', () => {
                closeAllFormsExcept('kingForm');
                openForm('kingForm');
                document.getElementById('editKingForm').reset();
                document.getElementById('deleteKingBtn').style.display = 'none';
                document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
                document.getElementById('kingCountryId').value = '';
                document.getElementById('kingCountryNameInput').value = '';
                document.getElementById('kingCountrySelect').value = '';
                document.getElementById('kingSelect').innerHTML = '<option value="">--- ìƒˆ ì™• ì¶”ê°€ ---</option>';
                loadKingsForCountry(true);
                topbarEditDropdownMenu.style.display = 'none';
            });
            
            document.getElementById('topbar-eventEditBtn')?.addEventListener('click', () => {
                closeAllFormsExcept('eventForm');
                openForm('eventForm');
                document.getElementById('editEventForm').reset();
                document.getElementById('deleteEventBtn').style.display = 'none';
                document.getElementById('saveEventBtn').textContent = 'ì €ì¥/ì¶”ê°€';
                populateEventSelect();
                topbarEditDropdownMenu.style.display = 'none';
            });
            
            document.getElementById('topbar-trashBtn')?.addEventListener('click', () => {
                openForm('trashForm');
                topbarEditDropdownMenu.style.display = 'none';
            });
            
            document.getElementById('topbar-exitEditBtn')?.addEventListener('click', () => {
                setEditModeState(false);
                topbarEditDropdownMenu.style.display = 'none';
            });
            
            // í¸ì§‘ëª¨ë“œì¼ ë•Œë§Œ ë²„íŠ¼ í‘œì‹œ
            if (editMode && currentUser && (currentUser.role === 'admin' || currentUser.role === 'superuser')) {
                topbarEditContainer.style.display = 'block';
            }
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ê´€ ê¸°ë¡ ì œì¶œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const historicalRecordButton = document.getElementById('historicalRecordButton');
        if (historicalRecordButton) {
            historicalRecordButton.addEventListener('click', () => {
                const form = document.getElementById('historicalRecordForm');
                if (form) {
                    form.style.display = 'block';
                    openForm('historicalRecordForm'); // ì¤‘ì•™ ì •ë ¬
                }
            });
        }

        // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ ê°ì§€ ë° ì´ˆê¸° ì„¤ì •
        const isMobileDevice = window.innerWidth <= 967 || window.innerHeight > window.innerWidth;
        if (isMobileDevice) {
            document.body.classList.add('force-mobile');
            
            // íƒ‘ë°”ëŠ” CSSì—ì„œ ìƒë‹¨ fixedë¡œ ì²˜ë¦¬ë¨
            const topBarContainer = document.getElementById('top-bar-container');
            if (topBarContainer) topBarContainer.style.display = 'flex';
            
            // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ í‘œì‹œ (layerVisibility.timelineì´ trueì¸ ê²½ìš°)
            if (layerVisibility.timeline) {
                const timelineWrapper = document.getElementById('timeline-control');
                if (timelineWrapper) {
                    timelineWrapper.style.display = 'block';
                }
            }
            
            // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ ì´ˆê¸° ì¶•ì†Œ ìƒíƒœë¡œ ì„¤ì •
            const mapHistoryPanel = document.getElementById('map-history-panel');
            if (mapHistoryPanel) {
                mapHistoryPanel.classList.remove('expanded');
                mapHistoryPanel.style.display = 'none'; // ğŸš© [ì¶”ê°€] ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€
            }
            
            // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ì™•ëª©ë¡ íŒ¨ë„ ì´ˆê¸° ìˆ¨ê¹€
            const mapKingPanel = document.getElementById('map-king-panel');
            if (mapKingPanel) {
                mapKingPanel.style.display = 'none'; // ğŸš© [ì¶”ê°€] ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€
            }
        } else {
            // ğŸš© [ì¶”ê°€] PCì—ì„œë„ íŒ¨ë„ ì´ˆê¸° ìˆ¨ê¹€
            const mapHistoryPanel = document.getElementById('map-history-panel');
            if (mapHistoryPanel) {
                mapHistoryPanel.style.display = 'none';
            }
            
            const mapKingPanel = document.getElementById('map-king-panel');
            if (mapKingPanel) {
                mapKingPanel.style.display = 'none';
            }
        }

        // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ í‘œì‹œ ë²„íŠ¼ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        const mobileLayerToggleBtn = document.getElementById('mobile-layer-toggle-btn');
        const mobileLayerMenu = document.getElementById('mobile-layer-menu');
        const mobileLayerCheckboxes = document.querySelectorAll('.mobile-layer-checkbox');
        
        if (mobileLayerToggleBtn && mobileLayerMenu) {
            // ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
            mobileLayerToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = mobileLayerMenu.style.display === 'block';
                mobileLayerMenu.style.display = isVisible ? 'none' : 'block';
                mobileLayerToggleBtn.textContent = isVisible ? 'í‘œì‹œ â–¾' : 'í‘œì‹œ â–´';
            });
            
            // ë¬¸ì„œ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
            document.addEventListener('click', () => {
                if (mobileLayerMenu.style.display === 'block') {
                    mobileLayerMenu.style.display = 'none';
                    mobileLayerToggleBtn.textContent = 'í‘œì‹œ â–¾';
                }
            });
            
            // ë©”ë‰´ ë‚´ë¶€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            mobileLayerMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ í•´ë‹¹ ë ˆì´ì–´ í† ê¸€
            mobileLayerCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const layerName = checkbox.dataset.layer;
                    const isChecked = checkbox.checked;
                    
                    // ê¸°ì¡´ layerVisibility ê°ì²´ ì—…ë°ì´íŠ¸
                    layerVisibility[layerName] = isChecked;
                    
                    // ë ˆì´ì–´ í‘œì‹œ/ìˆ¨ê¹€ (ê¸°ì¡´ í† ê¸€ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë¡œì§)
                    if (layerName === 'timeline') {
                        const timelineWrapper = document.getElementById('timeline-control');
                        if (timelineWrapper) {
                            timelineWrapper.style.display = isChecked ? 'block' : 'none';
                        }
                        // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ ì‚¬ì´ë“œë°” í† ê¸€ - displayì™€ pointer-eventsë„ í•¨ê»˜ ì œì–´
                        const timelineSidebar = document.getElementById('timeline-sidebar');
                        if (timelineSidebar) {
                            if (isChecked) {
                                timelineSidebar.classList.add('open');
                                timelineSidebar.style.display = 'block';
                                timelineSidebar.style.pointerEvents = 'auto';
                                timelineSidebar.style.opacity = '1';
                            } else {
                                timelineSidebar.classList.remove('open');
                                timelineSidebar.style.display = 'none';
                                timelineSidebar.style.pointerEvents = 'none';
                                timelineSidebar.style.opacity = '0';
                            }
                        }
                    } else if (layerName === 'kingPanel') {
                        // ğŸš© [ì¶”ê°€] ì™•ëª©ë¡ íŒ¨ë„ í† ê¸€
                        const kingPanel = document.getElementById('map-king-panel');
                        if (kingPanel) {
                            kingPanel.style.display = isChecked ? 'block' : 'none';
                        }
                    } else if (layerName === 'historyPanel') {
                        // ğŸš© [ì¶”ê°€] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ í† ê¸€
                        const historyPanel = document.getElementById('map-history-panel');
                        if (historyPanel) {
                            historyPanel.style.display = isChecked ? 'block' : 'none';
                        }
                    } else {
                        // ë‹¤ë¥¸ ë ˆì´ì–´ë“¤ì€ ë§µ ì—…ë°ì´íŠ¸
                        const { year, month } = getCurrentYearMonth();
                        updateMap(year, month);
                    }
                    
                    // ğŸš© [ìˆ˜ì •] PC í† ê¸€ ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”
                    applyLayerSettingsToUI(layerVisibility);
                });
            });
        }

        // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ìš© í¸ì§‘ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        const mobileEditBtn = document.getElementById('mobile-edit-btn');
        const mobileEditMenu = document.getElementById('mobile-edit-menu');
        if (mobileEditBtn && mobileEditMenu) {
            // í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
            mobileEditBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!editMode) {
                    setEditModeState(true);
                }
                if (mobileEditMenu.style.display === 'none') {
                    mobileEditMenu.style.display = 'block';
                    mobileEditBtn.textContent = 'í¸ì§‘ â–´';
                } else {
                    mobileEditMenu.style.display = 'none';
                    mobileEditBtn.textContent = 'í¸ì§‘ â–¾';
                }
            });
            
            // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
            document.addEventListener('click', (e) => {
                if (!mobileEditBtn.contains(e.target) && !mobileEditMenu.contains(e.target)) {
                    mobileEditMenu.style.display = 'none';
                    mobileEditBtn.textContent = 'í¸ì§‘ â–¾';
                }
            });
            
            // ë©”ë‰´ ë‚´ë¶€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            mobileEditMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // ê° ë©”ë‰´ í•­ëª©ì— ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
            document.getElementById('mobile-cityEditBtn').addEventListener('click', () => {
                closeAllFormsExcept('editCitySelectionForm');
                openForm('editCitySelectionForm');
                const searchInput = document.getElementById('editCitySelectionForm').querySelector('#citySearchInputForEdit');
                if (searchInput) searchInput.value = '';
                populateCitySelectForEdit();
                mobileEditMenu.style.display = 'none';
                mobileEditBtn.textContent = 'í¸ì§‘ â–¾';
            });
            
            document.getElementById('mobile-countryEditBtn').addEventListener('click', () => {
                closeAllFormsExcept('countryForm');
                openForm('countryForm');
                updateCountrySelectForEdit();
                document.getElementById('editCountryForm').reset();
                document.getElementById('countryOriginalName').value = '';
                document.getElementById('countryOriginalId').value = '';
                document.getElementById('deleteCountryBtn').style.display = 'none';
                document.getElementById('saveCountryBtn').textContent = 'ì €ì¥/ì¶”ê°€';
                document.getElementById('countryColor').value = '#ffffff';
                const searchInput = document.getElementById('countryForm').querySelector('#countrySearchForEdit');
                if (searchInput) searchInput.value = '';
                mobileEditMenu.style.display = 'none';
                mobileEditBtn.textContent = 'í¸ì§‘ â–¾';
            });
            
            document.getElementById('mobile-kingEditBtn').addEventListener('click', () => {
                closeAllFormsExcept('kingForm');
                openForm('kingForm');
                document.getElementById('editKingForm').reset();
                document.getElementById('deleteKingBtn').style.display = 'none';
                document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
                document.getElementById('kingCountryId').value = '';
                document.getElementById('kingCountryNameInput').value = '';
                document.getElementById('kingCountrySelect').value = '';
                document.getElementById('kingSelect').innerHTML = '<option value="">--- ìƒˆ ì™• ì¶”ê°€ ---</option>';
                loadKingsForCountry(true);
                mobileEditMenu.style.display = 'none';
                mobileEditBtn.textContent = 'í¸ì§‘ â–¾';
            });
            
            document.getElementById('mobile-eventEditBtn').addEventListener('click', () => {
                closeAllFormsExcept('eventForm');
                openForm('eventForm');
                document.getElementById('editEventForm').reset();
                document.getElementById('deleteEventBtn').style.display = 'none';
                document.getElementById('saveEventBtn').textContent = 'ì €ì¥/ì¶”ê°€';
                populateEventSelect();
                mobileEditMenu.style.display = 'none';
                mobileEditBtn.textContent = 'í¸ì§‘ â–¾';
            });
            
            document.getElementById('mobile-exitEditBtn').addEventListener('click', () => {
                setEditModeState(false);
                mobileEditMenu.style.display = 'none';
                mobileEditBtn.textContent = 'í¸ì§‘ â–¾';
            });
        }

        // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ìš© íŒ¨ë„ í† ê¸€ ë° ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì´ˆê¸°í™”
        // ğŸš© [ì¶”ê°€] êµ°ëŒ€ í¼ì˜ êµ­ê°€ ëª©ë¡ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        const countryOptions = countries.map(c => `<option value="${c._id}">${c.name}${c.ethnicity ? ` (${c.ethnicity})` : ''}</option>`).join('');
        if (militaryCountrySelect) {
            militaryCountrySelect.innerHTML = `<option value="">-- ëª©ë¡ì—ì„œ ì„ íƒ --</option>${countryOptions}`;
        }


        // ğŸš© [ì¶”ê°€] ì—­ì‚¬ ê¸°ë¡ì˜ êµ­ê°€ ì…ë ¥ í•„ë“œì— ëŒ€í•œ ìë™ ì™„ì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„)
        document.getElementById('castleHistoryList').addEventListener('input', (e) => {
            if (e.target.classList.contains('history-country-name')) {
                const input = e.target;
                const resultsContainer = input.nextElementSibling.nextElementSibling; // input -> hidden input -> results div
                const query = input.value.toLowerCase();
                resultsContainer.innerHTML = '';

                if (query.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }

                const filteredCountries = countries.filter(c => c.name.toLowerCase().includes(query));

                filteredCountries.forEach(country => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = country.name;
                    item.onclick = () => {
                        input.value = country.name;
                        input.nextElementSibling.value = country._id; // hidden inputì— ID ì €ì¥
                        resultsContainer.style.display = 'none';

                        // ğŸš© [ìˆ˜ì •] êµ­ê°€ ì„ íƒ ì‹œ, í•´ë‹¹ êµ­ê°€ì˜ ì‹œì‘/ë©¸ë§ ì—°ë„ì™€ ì›”ì„ ìë™ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.
                        const row = input.closest('.history-record-row');
                        const startYearInput = row.querySelector('input.history-start-year');
                        const startMonthInput = row.querySelector('input.history-start-month');
                        const endYearInput = row.querySelector('input.history-end-year');
                        const endMonthInput = row.querySelector('input.history-end-month');
                        if (startYearInput && country.start) {
                            startYearInput.value = country.start;
                        }
                        if (startMonthInput && country.start_month) {
                            startMonthInput.value = country.start_month;
                        }
                        if (endYearInput && country.end) {
                            endYearInput.value = country.end;
                        }
                        if (endMonthInput && country.end_month) {
                            endMonthInput.value = country.end_month;
                        }
                    };
                    resultsContainer.appendChild(item);
                });

                resultsContainer.style.display = filteredCountries.length > 0 ? 'block' : 'none';
            }
        });

        // ğŸš© [ì¶”ê°€] ìë™ ì™„ì„± ê²°ê³¼ ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ì°½ ìˆ¨ê¸°ê¸°
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.history-country')) {
                document.querySelectorAll('.autocomplete-results').forEach(el => el.style.display = 'none');
            }
        });

        // ğŸš© [ì¶”ê°€] êµ°ëŒ€ í¼ì˜ êµ­ê°€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        militaryCountrySelect.addEventListener('change', (e) => {
            const countryId = e.target.value;
            const country = getCountryInfoById(countryId);
            
            if (country) {
                militaryCountryNameInput.value = country.name;
                militaryCountryId.value = country._id;
            } else {
                militaryCountryNameInput.value = '';
                militaryCountryId.value = '';
            }
        });

        // ğŸš© [ì¶”ê°€] êµ°ëŒ€ í¼ì˜ ì†Œì† êµ­ê°€ ì…ë ¥ í•„ë“œì— ëŒ€í•œ ìë™ ì™„ì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const militaryCountryResults = document.getElementById('militaryCountryResults');
        const militaryCountryId = document.getElementById('militaryCountryId');

        militaryCountryNameInput.addEventListener('input', (e) => {
            const input = e.target;
            const resultsContainer = militaryCountryResults;
            const query = input.value.toLowerCase();
            resultsContainer.innerHTML = '';

            if (query.length === 0) {
                resultsContainer.style.display = 'none';
                militaryCountryId.value = ''; // ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ IDë„ ì´ˆê¸°í™”
                return;
            }

            const filteredCountries = countries.filter(c => c.name.toLowerCase().includes(query));

            filteredCountries.forEach(country => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = country.name;
                item.onclick = () => {
                    input.value = country.name;
                    militaryCountryId.value = country._id; // hidden inputì— ID ì €ì¥
                    militaryCountrySelect.value = country._id; // ë“œë¡­ë‹¤ìš´ë„ ë™ê¸°í™”
                    resultsContainer.style.display = 'none';
                };
                resultsContainer.appendChild(item);
            });

            resultsContainer.style.display = filteredCountries.length > 0 ? 'block' : 'none';
        });

        // ğŸš© [ì¶”ê°€] êµ°ëŒ€ í¼ ìë™ ì™„ì„± ê²°ê³¼ ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ì°½ ìˆ¨ê¸°ê¸°
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#militaryFlagDetails .form-row > div')) { // í•´ë‹¹ form-row ë‚´ë¶€ì˜ flex ì»¨í…Œì´ë„ˆ ì™¸ë¶€ í´ë¦­ ì‹œ
                militaryCountryResults.style.display = 'none';
            }
        });


        const controlsWrapper = document.getElementById('controls-wrapper');
        // const rightPanel = document.getElementById('rightPanel'); // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°
        const mapElement = document.getElementById('map');

        // ğŸš© [ìˆ˜ì •] ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°ë¡œ ì¸í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”
        // mapElement.addEventListener('click', () => {
        //     // ê²€ìƒ‰ì°½ì— í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ ë‹«ì§€ ì•ŠìŒ (ëª¨ë°”ì¼ ê²€ìƒ‰ UX ê°œì„ )
        //     const searchInput = document.getElementById('mapSearchInput');
        //     if (document.activeElement === searchInput) return;
        //     // ëª¨ë°”ì¼ì—ì„œëŠ” ìš°ì¸¡ íŒ¨ë„ë§Œ ë‹«ìŒ
        //     if (window.innerWidth <= 967) {
        //         rightPanel.classList.remove('visible');
        //     } else {
        //         const controlsWrapper = document.getElementById('controls-wrapper');
        //         if (controlsWrapper) {
        //             controlsWrapper.classList.remove('visible');
        //         }
        //         rightPanel.classList.remove('visible');
        //     }
        //     document.body.classList.remove('controls-visible');
        // });

        // ğŸš© [í•µì‹¬ ìˆ˜ì •] ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„(ìŠ¬ë¼ì´ë”©) ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
        // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ì‹œ controls-wrapper í•­ìƒ ë³´ì´ê²Œ
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('focus', () => {
                controlsWrapper.classList.add('visible');
                document.body.classList.add('controls-visible');
            });
        }
        // ì´ì œ íŒ¨ë„ì€ ë²„íŠ¼ìœ¼ë¡œë§Œ ì—´ê³  ë‹«ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

        // ğŸš© [ì¶”ê°€] ì¬ìƒ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ì„ ì´ê³³ìœ¼ë¡œ í†µí•©í•©ë‹ˆë‹¤.
        playBtn.addEventListener('click', startPlayback);
        pauseBtn.addEventListener('click', stopPlayback);

        playbackSpeedSlider.oninput = () => {
            speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`;
            if (playInterval) {
                stopPlayback();
                startPlayback(); // ì¦‰ì‹œ ìƒˆ ì†ë„ë¡œ ë‹¤ì‹œ ì‹œì‘
            }
        };
        speedDisplay.textContent = `${playbackSpeedSlider.value}ì›”/ì´ˆ`; // ì´ˆê¸° í‘œì‹œ

        combinedSlider.addEventListener('mousedown', stopPlayback);
        combinedSlider.addEventListener('touchstart', stopPlayback);

        // ğŸš© [ìˆ˜ì •] ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ì‹œ ì¶”ê°€í•©ë‹ˆë‹¤.
        layerToggles.addEventListener('click', (e) => {
            if (e.target.classList.contains('layer-toggle-btn')) {
                const button = e.target;
                const layerType = button.dataset.layer;
                
                button.classList.toggle('active');
                layerVisibility[layerType] = button.classList.contains('active');
                
                // ğŸš© [ì¶”ê°€] ê¸°ì—¬ ë ˆì´ì–´ í† ê¸€ ì‹œ contributionMode í† ê¸€ (ê²ŒìŠ¤íŠ¸ëŠ” ì´ë¯¸ ë²„íŠ¼ì´ ìˆ¨ê²¨ì§)
                if (layerType === 'userContributions') {
                    contributionMode = !contributionMode;
                }
                
                // ğŸš© [ìˆ˜ì •] ì˜í†  ë ˆì´ì–´ í† ê¸€ ì‹œ - ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œ ì™„ë£Œ í™•ì¸
                if (layerType === 'territoryPolygon' && layerVisibility.territoryPolygon) {
                    if (territories.length === 0) {
                        console.log('â³ ì˜í†  ë°ì´í„° ë¡œë”© ì¤‘... (ë°±ê·¸ë¼ìš´ë“œ)');
                        // ë°±ê·¸ë¼ìš´ë“œ ë¡œë”©ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ë Œë”ë§ë¨
                    } else {
                        // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ë Œë”ë§
                        const { year, month } = getCurrentYearMonth();
                        updateMap(year, month);
                    }
                    return;
                }
                
                // ğŸš© [ìˆ˜ì •] ì—°ëŒ€í‘œ í† ê¸€ ì‹œì—ëŠ” timeline-sidebarë§Œ í† ê¸€ (ìŠ¬ë¼ì´ë”ëŠ” í•­ìƒ í‘œì‹œ)
                if (layerType === 'timeline') {
                    const timelineSidebar = document.getElementById('timeline-sidebar');
                    if (timelineSidebar) {
                        if (layerVisibility.timeline) {
                            timelineSidebar.style.display = 'block';
                            timelineSidebar.style.opacity = '1';
                        } else {
                            timelineSidebar.style.display = 'none';
                            timelineSidebar.style.opacity = '0';
                        }
                    }
                } else if (layerType === 'kingPanel') {
                    // ğŸš© [ì¶”ê°€] ì™•ëª©ë¡ íŒ¨ë„ í† ê¸€
                    const kingPanel = document.getElementById('map-king-panel');
                    if (kingPanel) {
                        kingPanel.style.display = layerVisibility.kingPanel ? 'block' : 'none';
                    }
                } else if (layerType === 'historyPanel') {
                    // ğŸš© [ì¶”ê°€] ì—­ì‚¬ê¸°ë¡ íŒ¨ë„ í† ê¸€
                    const historyPanel = document.getElementById('map-history-panel');
                    if (historyPanel) {
                        historyPanel.style.display = layerVisibility.historyPanel ? 'block' : 'none';
                    }
                } else if (layerType === 'eventSidebar') {
                    // ğŸš© [ê³¼ì œ2] ì‚¬ê±´ëª©ë¡ ì‚¬ì´ë“œë°” í† ê¸€
                    const eventSidebar = document.getElementById('event-sidebar');
                    if (eventSidebar) {
                        if (layerVisibility.eventSidebar) {
                            eventSidebar.classList.add('open');
                            // ì‚¬ì´ë“œë°”ê°€ ì—´ë¦´ ë•Œ ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë”© ì‹œë„
                            if (events.length === 0 && historicalEvents.length > 0) {
                                renderEventSidebar();
                            } else if (events.length > 0) {
                                renderEventSidebar();
                            }
                            // events ë¡œë”©ì´ ì•„ì§ ì•ˆëìœ¼ë©´ ë°±ê·¸ë¼ìš´ë“œ ë¡œë“œ
                            if (events.length === 0) {
                                fetchData('events').then(data => {
                                    events = data || [];
                                    renderEventSidebar();
                                }).catch(err => console.error('events ë¡œë“œ ì‹¤íŒ¨:', err));
                            }
                        } else {
                            eventSidebar.classList.remove('open');
                        }
                    }
                } else {
                    // ì¦‰ì‹œ ë¼ë²¨ ë ˆì´ì–´(êµ­ê°€/ì§€ëª…/ë¯¼ì¡±) ë” ì²˜ë¦¬: ë¼ë²¨ ë§ˆì»¤ë¥¼ ì¦‰ì‹œ ì œê±°í•˜ì—¬ UI ë¶ˆì¼ì¹˜ ë°©ì§€
                    if (layerType === 'countryLabel' || layerType === 'placeLabel' || layerType === 'ethnicLabel') {
                        // ğŸš© [ê³¼ì œ1] countryLabel í† ê¸€ ì‹œ ê±°ì‹œ ëª¨ë“œ êµ­ê°€ëª…ë„ ê°±ì‹ 
                        if (layerType === 'countryLabel' && currentMacroMode) {
                            renderMacroCountryNames();
                        }
                        try {
                            const labelKind = layerType === 'countryLabel' ? 'country' : (layerType === 'placeLabel' ? 'place' : 'ethnic');
                            for (let i = allCastleMarkers.length - 1; i >= 0; i--) {
                                const m = allCastleMarkers[i];
                                const d = m?._castleData;
                                if (!d) continue;
                                const isLabel = !!d.is_label;
                                const lt = d.label_type || (isLabel ? 'place' : null);
                                if (isLabel && lt === labelKind) {
                                    if (map.hasLayer(m)) map.removeLayer(m);
                                    // also remove from labelLayerGroup if present
                                    try { labelLayerGroup.removeLayer(m); } catch(e) {}
                                    allCastleMarkers.splice(i, 1);
                                }
                            }
                        } catch (err) { console.warn('ë¼ë²¨ ì¦‰ì‹œ ì œê±° ì¤‘ ì˜¤ë¥˜:', err); }
                    }
                     const { year, month } = getCurrentYearMonth();
                     updateMap(year, month);
                 }
                 
                 // ğŸš© [ìˆ˜ì •] ëª¨ë°”ì¼ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™”
                 const mobileCheckbox = document.querySelector(`#mobile-layer-menu input[data-layer="${layerType}"]`);
                 if (mobileCheckbox) {
                     mobileCheckbox.checked = layerVisibility[layerType];
                 }
             }
         });

        // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œ ë§‰ëŒ€ í´ë¦­ ì‹œ í•´ë‹¹ êµ­ê°€ì˜ ì‹œì‘ ì—°ë„ë¡œ ì´ë™
        const timelineContainer = document.getElementById('timeline-container');
        timelineContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('timeline-bar')) {
                // ğŸš© [ì¶”ê°€] ë“œë˜ê·¸ ì¤‘ì´ì—ˆë‹¤ë©´ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
                if (typeof checkTimelineDragged === 'function' && checkTimelineDragged()) {
                    return;
                }
                
                const bar = e.target;
                const startYear = parseInt(bar.dataset.startYear);
                const startMonth = parseInt(bar.dataset.startMonth);
                const countryId = bar.dataset.countryId;

                // 1. ì‹œê°„ ì´ë™
                updateTime(startYear, startMonth);

                // ğŸš© [ì¶”ê°€] ì—°ëŒ€í‘œë„ í•´ë‹¹ ì‹œì ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                updateTimelineScroll();

                // 2. ğŸš© [ì¶”ê°€] í•´ë‹¹ êµ­ê°€ì˜ ìˆ˜ë„ë¥¼ ì°¾ì•„ í´ë¡œì¦ˆì—…
                if (countryId) {
                    const startTime = yearMonthToTotalMonths(startYear, startMonth);
                    // í•´ë‹¹ êµ­ê°€ì˜ ì‹œì‘ ì‹œì ì— ìœ íš¨í•œ ìˆ˜ë„ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                    const capital = castles.find(c => c.country_id === countryId && c.is_capital && yearMonthToTotalMonths(c.built_year, c.built_month || 1) <= startTime && (c.destroyed === null || yearMonthToTotalMonths(c.destroyed, c.destroyed_month || 12) >= startTime));
                    
                    if (capital) {
                        map.flyTo([capital.lat, capital.lng], 10);
                    }
                }
            }
        });

        // ğŸš© [ì¶”ê°€] í¸ì§‘ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const mainEditBtn = document.getElementById('mainEditBtn');
        const editDropdownMenu = document.getElementById('edit-dropdown-menu');
        const exitEditBtnDropdown = document.getElementById('exitEditBtnDropdown');
        const editDropdownContainer = document.getElementById('edit-dropdown-container');

        function setEditModeState(newState) {
            console.log('setEditModeState í˜¸ì¶œ:', {newState, currentUser, currentRole: currentUser?.role});
            const privileged = currentUser?.role === 'superuser' || currentUser?.role === 'admin';
            editMode = privileged ? !!newState : false;
            console.log('í¸ì§‘ ëª¨ë“œ ìƒíƒœ ë³€ê²½:', {editMode, privileged});
            // ğŸš© [ìˆ˜ì •] localStorage ì €ì¥ ì œê±° - ë¡œê·¸ì¸ ì‹œ í•­ìƒ ì¼ë°˜ ë·° ëª¨ë“œë¡œ ì‹œì‘
            if (editDropdownContainer) {
                editDropdownContainer.style.display = privileged ? 'inline-block' : 'none';
            }
            if (exitEditBtnDropdown) {
                exitEditBtnDropdown.style.display = editMode ? 'block' : 'none';
            }

            // ğŸ—‘ï¸ íœ´ì§€í†µ ë²„íŠ¼ í‘œì‹œ ì œì–´ (ê´€ë¦¬ìë§Œ)
            const trashBtnDropdown = document.getElementById('trashBtnDropdown');
            if (trashBtnDropdown) {
                trashBtnDropdown.style.display = (editMode && privileged) ? 'block' : 'none';
            }

            // íƒ‘ë°” í¸ì§‘ ë²„íŠ¼ í‘œì‹œ ì œì–´
            const topbarEditContainer = document.getElementById('topbar-edit-dropdown-container');
            console.log('íƒ‘ë°” í¸ì§‘ ì»¨í…Œì´ë„ˆ:', topbarEditContainer, 'display:', (editMode && privileged) ? 'inline-block' : 'none');
            if (topbarEditContainer) {
                topbarEditContainer.style.display = (editMode && privileged) ? 'inline-block' : 'none';
            }

            // openHistoryFormBtn.style.display = (editMode && privileged) ? 'inline-block' : 'none'; // ì˜¤ë¥¸ìª½ íŒ¨ë„ ì œê±°

            if (editMode && privileged) {
                if (typeof initializeDrawControl === 'function') {
                    initializeDrawControl();
                }
            } else {
                if (typeof drawControl !== 'undefined' && drawControl) {
                    map.removeControl(drawControl);
                }
            }

            if (!editMode && editDropdownMenu) {
                editDropdownMenu.classList.remove('show');
            }

            if (typeof currentYear !== 'undefined') {
                updateHistoryPanel(currentYear);
            }
        }

        mainEditBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            if (!editMode) {
                setEditModeState(true);
            }
            editDropdownMenu.classList.toggle('show');
        });

        // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('cityEditBtnDropdown').addEventListener('click', () => {
            closeAllFormsExcept('editCitySelectionForm');
            openForm('editCitySelectionForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
            const searchInput = document.getElementById('editCitySelectionForm').querySelector('#citySearchInputForEdit');
            if (searchInput) searchInput.value = '';
            populateCitySelectForEdit();
            editDropdownMenu.classList.remove('show');
        });

        document.getElementById('countryEditBtnDropdown').addEventListener('click', () => {
            closeAllFormsExcept('countryForm');
            openForm('countryForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
            updateCountrySelectForEdit();
            document.getElementById('editCountryForm').reset();
            document.getElementById('countryOriginalName').value = '';
            document.getElementById('countryOriginalId').value = '';
            document.getElementById('deleteCountryBtn').style.display = 'none';
            document.getElementById('saveCountryBtn').textContent = 'ì €ì¥/ì¶”ê°€';
            document.getElementById('countryColor').value = '#ffffff';
            const searchInput = document.getElementById('countryForm').querySelector('#countrySearchForEdit');
            if (searchInput) searchInput.value = '';
            editDropdownMenu.classList.remove('show');
        });

        document.getElementById('kingEditBtnDropdown').addEventListener('click', () => {
            closeAllFormsExcept('kingForm');
            openForm('kingForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
            document.getElementById('editKingForm').reset();
            document.getElementById('deleteKingBtn').style.display = 'none';
            document.getElementById('saveKingBtn').textContent = 'ì¶”ê°€';
            // ğŸš© [ì¶”ê°€] í¼ì„ ì—´ ë•Œ êµ­ê°€ ê´€ë ¨ í•„ë“œë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
            document.getElementById('kingCountryId').value = '';
            document.getElementById('kingCountryNameInput').value = '';
            document.getElementById('kingCountrySelect').value = '';
            document.getElementById('kingSelect').innerHTML = '<option value="">--- ìƒˆ ì™• ì¶”ê°€ ---</option>';

            loadKingsForCountry(true);
            editDropdownMenu.classList.remove('show');
        });

        document.getElementById('eventEditBtnDropdown').addEventListener('click', () => {
            closeAllFormsExcept('eventForm');
            openForm('eventForm'); // ğŸš© [ìˆ˜ì •] openForm í•¨ìˆ˜ ì‚¬ìš©
            document.getElementById('editEventForm').reset();
            document.getElementById('deleteEventBtn').style.display = 'none';
            document.getElementById('saveEventBtn').textContent = 'ì €ì¥/ì¶”ê°€';
            populateEventSelect();
            editDropdownMenu.classList.remove('show');
        });

        if (exitEditBtnDropdown) {
            exitEditBtnDropdown.addEventListener('click', () => {
                setEditModeState(false);
                editDropdownMenu.classList.remove('show');
            });
        }

        // ğŸš© [ìˆ˜ì •] ê²ŒìŠ¤íŠ¸ ì—¬ë¶€ì— ë”°ë¼ ê³„ì • ê´€ë¦¬ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        if (currentUser) {
            const accountLinkEl = document.getElementById('accountLink');
            if (currentUser.isGuest) {
                if (accountLinkEl) accountLinkEl.style.setProperty('display', 'none', 'important');
                // ğŸš© [ì¶”ê°€] ê²ŒìŠ¤íŠ¸ëŠ” ê¸°ì—¬ ê¸°ëŠ¥ ìˆ¨ê¹€
                const userContributionsBtn = document.querySelector('button[data-layer="userContributions"]');
                if (userContributionsBtn) userContributionsBtn.style.display = 'none';
                // ğŸš© [ì¶”ê°€] ê²ŒìŠ¤íŠ¸ëŠ” ì‚¬ê´€ ê¸°ë¡ ì œì¶œ ë²„íŠ¼ ìˆ¨ê¹€
                const historicalRecordBtn = document.getElementById('historicalRecordButton');
                if (historicalRecordBtn) historicalRecordBtn.style.display = 'none';
            } else {
                if (accountLinkEl) accountLinkEl.style.display = 'inline-block';
                // ğŸš© [ì¶”ê°€] ì¼ë°˜ ìœ ì €ëŠ” ê¸°ì—¬ ê¸°ëŠ¥ í‘œì‹œ
                const userContributionsBtn = document.querySelector('button[data-layer="userContributions"]');
                if (userContributionsBtn) userContributionsBtn.style.display = 'inline-block';
                // ğŸš© [ì¶”ê°€] ì¼ë°˜ ìœ ì €ëŠ” ì‚¬ê´€ ê¸°ë¡ ì œì¶œ ë²„íŠ¼ í‘œì‹œ
                const historicalRecordBtn = document.getElementById('historicalRecordButton');
                if (historicalRecordBtn) historicalRecordBtn.style.display = 'block';
            }
            const isPrivileged = currentUser.role === 'admin' || currentUser.role === 'superuser';
            const approverPositions = ['ìˆ˜êµ­ì‚¬', 'ë™ìˆ˜êµ­ì‚¬', 'ê°ìˆ˜êµ­ì‚¬', 'ë¬¸í•˜ì‹œì¤‘'];
            const rankingBtn = document.getElementById('rankingBtn');
            if (rankingBtn) {
                // ğŸš© [ìˆ˜ì •] ì‚¬ê´€ ë­í‚¹ì€ ë¡œê·¸ì¸í•œ ëª¨ë“  ìœ ì €ê°€ ë³¼ ìˆ˜ ìˆë„ë¡ í•¨
                rankingBtn.style.display = 'inline-block';
            }
            // ğŸš© [ìˆ˜ì •] íšŒì› ê´€ë¦¬ëŠ” admin ì—­í• ë§Œ í‘œì‹œ (ê²ŒìŠ¤íŠ¸ ì œì™¸)
            const adminLinkEl = document.getElementById('adminLink');
            if (adminLinkEl) {
                if (currentUser.role === 'admin' && !currentUser.isGuest) {
                    adminLinkEl.style.setProperty('display', 'inline-block', 'important');
                } else {
                    adminLinkEl.style.setProperty('display', 'none', 'important');
                }
            }
            const territoryManagerLinkEl = document.getElementById('territoryManagerLink');
            if (territoryManagerLinkEl) {
                territoryManagerLinkEl.style.display = isPrivileged ? 'inline-block' : 'none';
            }
            // ğŸš© [ìˆ˜ì •] í¸ì§‘ ë²„íŠ¼ì€ ê´€ë¦¬ìë§Œ í‘œì‹œ
            if (editDropdownContainer) {
                editDropdownContainer.style.display = isPrivileged ? 'inline-block' : 'none';
            }
            // ğŸš© [ì¶”ê°€] ëª¨ë°”ì¼ í¸ì§‘ ë²„íŠ¼ë„ ê´€ë¦¬ìë§Œ í‘œì‹œ
            const mobileEditDropdownContainer = document.getElementById('mobile-edit-dropdown-container');
            if (mobileEditDropdownContainer) {
                mobileEditDropdownContainer.style.display = isPrivileged ? 'block' : 'none';
            }
            // ğŸš© [ì œê±°] ì¤‘ë³µ í˜¸ì¶œ - ì´ë¯¸ initialize() ì´ì „ì— í˜¸ì¶œë¨
            // await updateTopBarUserInfo();
            // ğŸš© [ìˆ˜ì •] ë¡œê·¸ì¸ ì‹œ í•­ìƒ ì¼ë°˜ ë·° ëª¨ë“œë¡œ ì‹œì‘ (í¸ì§‘ëª¨ë“œ ìë™ í™œì„±í™” ì œê±°)
            setEditModeState(false);
        } else {
            // ğŸš© [ìˆ˜ì •] ë¹„ë¡œê·¸ì¸ ì‹œ íšŒì› ê´€ë¦¬ ìˆ¨ê¹€ (importantë¡œ ê°•ì œ)
            const adminLinkEl2 = document.getElementById('adminLink');
            if (adminLinkEl2) adminLinkEl2.style.setProperty('display', 'none', 'important');
            const territoryManagerLinkEl2 = document.getElementById('territoryManagerLink');
            if (territoryManagerLinkEl2) territoryManagerLinkEl2.style.display = 'none';
            // ğŸš© [ìˆ˜ì •] ë¹„ë¡œê·¸ì¸ ì‹œ í¸ì§‘ ë²„íŠ¼ ìˆ¨ê¹€
            if (editDropdownContainer) {
                editDropdownContainer.style.display = 'none';
            }
            // ğŸš© [ì¶”ê°€] ë¹„ë¡œê·¸ì¸ ì‹œ ëª¨ë°”ì¼ í¸ì§‘ ë²„íŠ¼ë„ ìˆ¨ê¹€
            const mobileEditDropdownContainer = document.getElementById('mobile-edit-dropdown-container');
            if (mobileEditDropdownContainer) {
                mobileEditDropdownContainer.style.display = 'none';
            }
            setEditModeState(false);
        }

        // ğŸš© [ìˆ˜ì •] ë„ì‹œ/ì„±/ì§€ëª… í¸ì§‘ í¼ì˜ ìë™ ì™„ì„± ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
        initCitySearchForEdit();


        // ğŸš© [ì¶”ê°€] ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
        window.addEventListener('click', (e) => {
            if (mainEditBtn && !mainEditBtn.contains(e.target) && editDropdownMenu && !editDropdownMenu.contains(e.target)) {
                editDropdownMenu.classList.remove('show');
            }
            // ğŸš© [ì¶”ê°€] ë©”ì¸ ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            if (searchInput && !searchInput.contains(e.target) && mainSearchResults && !mainSearchResults.contains(e.target)) {
                mainSearchResults.style.display = 'none';
            }
            // ğŸš© [ì¶”ê°€] êµ­ê°€ í¸ì§‘ ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            if (countrySearchInputForEdit && !countrySearchInputForEdit.contains(e.target) && countrySearchResults && !countrySearchResults.contains(e.target)) {
                countrySearchResults.style.display = 'none';
            }
            // ğŸš© [ì¶”ê°€] ë„ì‹œ/ì„± ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            const _citySearchInput = document.getElementById('citySearchInputForEdit');
            const _citySearchResults = document.getElementById('citySearchResults');
            if (_citySearchInput && !_citySearchInput.contains(e.target) && _citySearchResults && !_citySearchResults.contains(e.target)) {
                _citySearchResults.style.display = 'none';
            }
        });

        // ğŸš© [ì¶”ê°€] ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const satelliteBtn = document.getElementById('satellite-tile-btn');
        const normalBtn = document.getElementById('normal-tile-btn');
        const satelliteBtnPc = document.getElementById('satellite-tile-btn-pc');
        const normalBtnPc = document.getElementById('normal-tile-btn-pc');

        const switchTileLayer = (newLayerKey, clickedBtn) => {
            if (currentTileLayer !== baseMaps[newLayerKey]) {
                map.removeLayer(currentTileLayer);
                currentTileLayer = baseMaps[newLayerKey];
                map.addLayer(currentTileLayer);

                // ìœ„ì„± ëª¨ë“œ: ì„¸í”¼ì•„ í•„í„° ì œê±° (ì›ë³¸ ì»¬ëŸ¬ í‘œì‹œ)
                // ê·¸ ì™¸ ëª¨ë“œ: ë¹ˆí‹°ì§€ ì„¸í”¼ì•„ í•„í„° ë³µì›
                const mapEl = document.getElementById('map');
                if (mapEl) {
                    if (newLayerKey === 'ìœ„ì„±ëª¨ë“œ') {
                        mapEl.style.filter = 'none';
                    } else {
                        mapEl.style.filter = '';
                    }
                }

                // ëª¨ë°”ì¼ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (satelliteBtn) {
                    satelliteBtn.classList.remove('active');
                }
                if (normalBtn) {
                    normalBtn.classList.remove('active');
                }
                
                // PC ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (satelliteBtnPc) {
                    satelliteBtnPc.classList.remove('active');
                }
                if (normalBtnPc) {
                    normalBtnPc.classList.remove('active');
                }
                
                clickedBtn.classList.add('active');
            }
        };

        if (satelliteBtn) {
            satelliteBtn.addEventListener('click', () => switchTileLayer('ìœ„ì„±', satelliteBtn));
        }
        if (normalBtn) {
            normalBtn.addEventListener('click', () => switchTileLayer('ì¼ë°˜', normalBtn));
        }
        if (satelliteBtnPc) {
            satelliteBtnPc.addEventListener('click', () => switchTileLayer('ìœ„ì„±', satelliteBtnPc));
        }
        if (normalBtnPc) {
            normalBtnPc.addEventListener('click', () => switchTileLayer('ì¼ë°˜', normalBtnPc));
        }

        // ğŸš© [ìˆ˜ì •] í•œë¦¼í•™ì‚¬ ë­í‚¹ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const rankingBtn = document.getElementById('rankingBtn');
        const contributionForm = document.getElementById('contributionForm');
        const cancelContribBtn = document.getElementById('cancelContribBtn');
        const addContributionForm = document.getElementById('addContributionForm');

        // ğŸš© [ìˆ˜ì •] ì‚¬ê´€ ë­í‚¹ ë²„íŠ¼ - íŒì—…ìœ¼ë¡œ ì—´ê¸°
        if (rankingBtn) {
            rankingBtn.addEventListener('click', () => {
                // íŒì—… ì°½ í¬ê¸° ë° ìœ„ì¹˜ ì„¤ì •
                const width = 1300;
                const height = 850;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                window.open(
                    'ranking.html',
                    'rankingWindow',
                    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
                );
            });
        }


        // ğŸ—‘ï¸ íœ´ì§€í†µ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        const trashBtnDropdown = document.getElementById('trashBtnDropdown');
        const trashModal = document.getElementById('trashModal');
        const closeTrashBtn = document.getElementById('closeTrashBtn');

        // íœ´ì§€í†µ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        if (trashBtnDropdown) {
            trashBtnDropdown.addEventListener('click', async () => {
                if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'superuser')) {
                    alert('íœ´ì§€í†µì€ ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                await openTrashModal();
            });
        }

        // íœ´ì§€í†µ ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
        if (closeTrashBtn) {
            closeTrashBtn.addEventListener('click', () => {
                if (trashModal) trashModal.style.display = 'none';
            });
        }

        // ì‚¬ë£Œ ìƒì„¸ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const contributionDetailModal = document.getElementById('contributionDetailModal');
        const closeContributionDetailBtn = document.getElementById('closeContributionDetailBtn');

        if (closeContributionDetailBtn) {
            closeContributionDetailBtn.addEventListener('click', () => {
                if (contributionDetailModal) {
                    contributionDetailModal.style.display = 'none';
                    // í¬ì»¤ìŠ¤ ë³µì›
                    setTimeout(() => {
                        document.body.focus();
                    }, 100);
                }
            });
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
        if (contributionDetailModal) {
            contributionDetailModal.addEventListener('click', (e) => {
                if (e.target === contributionDetailModal) {
                    contributionDetailModal.style.display = 'none';
                    // í¬ì»¤ìŠ¤ ë³µì›
                    setTimeout(() => {
                        document.body.focus();
                    }, 100);
                }
            });
        }

        window.addEventListener('click', (e) => {
            if (e.target === contributionDetailModal) {
                contributionDetailModal.style.display = 'none';
            }
        });

        if (cancelContribBtn) {
            cancelContribBtn.addEventListener('click', () => {
                if (contributionForm) contributionForm.style.display = 'none';
                if (contributionMarker) map.removeLayer(contributionMarker);
            });
        }

        // ğŸš© [ì¶”ê°€] ìœ í˜• ë³€ê²½ ì‹œ ì„±/ë„ì‹œ ì „ìš© í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        const contribPlaceType = document.getElementById('contribPlaceType');
        if (contribPlaceType) {
            contribPlaceType.addEventListener('change', () => {
                const isNatural = contribPlaceType.value.startsWith('natural_');
                const countryRow = document.getElementById('contribCountryRow');
                const startRow = document.getElementById('contribStartYearRow');
                const endRow = document.getElementById('contribEndYearRow');
                const newCountryRow = document.getElementById('contribNewCountryRow');
                const capitalRow = document.getElementById('contribCapitalRow');
                if (countryRow) countryRow.style.display = isNatural ? 'none' : '';
                if (startRow) startRow.style.display = isNatural ? 'none' : '';
                if (endRow) endRow.style.display = isNatural ? 'none' : '';
                if (newCountryRow) newCountryRow.style.display = 'none';
                if (capitalRow) capitalRow.style.display = isNatural ? 'none' : '';
            });
        }

        // ğŸš© [ì¶”ê°€] contribution í¼ ì—´ë¦´ ë•Œ êµ­ê°€ ëª©ë¡ ì±„ìš°ê¸°
        function populateContribCountrySelect() {
            const select = document.getElementById('contribCountryId');
            if (!select || !countries || countries.length === 0) return;
            select.innerHTML = '<option value="">-- êµ­ê°€ ì„ íƒ --</option>';
            countries.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c._id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });
            // ìƒˆ êµ­ê°€ ì§ì ‘ ì…ë ¥ ì˜µì…˜
            const newOpt = document.createElement('option');
            newOpt.value = '__new__';
            newOpt.textContent = 'â• ëª©ë¡ì— ì—†ëŠ” êµ­ê°€ ì§ì ‘ ì…ë ¥...';
            select.appendChild(newOpt);

            // ì„ íƒ ë³€ê²½ ì‹œ ìƒˆ êµ­ê°€ ì…ë ¥ í•„ë“œ í† ê¸€
            select.onchange = () => {
                const newRow = document.getElementById('contribNewCountryRow');
                if (newRow) newRow.style.display = select.value === '__new__' ? '' : 'none';
                if (select.value !== '__new__') {
                    const inp = document.getElementById('contribNewCountryName');
                    if (inp) inp.value = '';
                }
            };
        }
        // contributionFormì´ ë³´ì¼ ë•Œ êµ­ê°€ ëª©ë¡ ê°±ì‹ 
        const contribFormObserver = new MutationObserver(() => {
            if (contributionForm && contributionForm.style.display !== 'none') {
                populateContribCountrySelect();
            }
        });
        if (contributionForm) {
            contribFormObserver.observe(contributionForm, { attributes: true, attributeFilter: ['style'] });
        }

        if (addContributionForm) {
            addContributionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const placeType = document.getElementById('contribPlaceType')?.value || 'city';
                const isNatural = placeType.startsWith('natural_');
                const startYearVal = document.getElementById('contribStartYear')?.value;
                const endYearVal = document.getElementById('contribEndYear')?.value;
                const countryId = document.getElementById('contribCountryId')?.value;
                const newCountryName = document.getElementById('contribNewCountryName')?.value.trim();

                // ğŸš© [ê²€ì¦] ì„±/ë„ì‹œì¸ ê²½ìš° ì—°ë„ì™€ êµ­ê°€ í•„ìˆ˜
                if (!isNatural) {
                    if (!startYearVal) {
                        alert('ì„±/ë„ì‹œì˜ ê²½ìš° ì‹œì‘ ì—°ë„ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }
                    if (!countryId) {
                        alert('ì„±/ë„ì‹œì˜ ê²½ìš° ì†Œì† êµ­ê°€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }
                    if (countryId === '__new__' && !newCountryName) {
                        alert('ìƒˆ êµ­ê°€ëª…ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }
                }
                
                const isCapital = !isNatural && document.getElementById('contribIsCapital')?.checked === true;

                const data = {
                    name: document.getElementById('contribName').value.trim(),
                    lat: parseFloat(document.getElementById('contribLat').value),
                    lng: parseFloat(document.getElementById('contribLng').value),
                    category: document.getElementById('contribCategory').value,
                    description: document.getElementById('contribDesc').value,
                    evidence: document.getElementById('contribEvidence').value,
                    placeType: placeType,
                    is_natural_feature: isNatural,
                    natural_feature_type: isNatural ? placeType.replace('natural_', '') : null,
                    country_id: isNatural ? null : (countryId === '__new__' ? null : countryId),
                    new_country_name: (!isNatural && countryId === '__new__') ? newCountryName : null,
                    start_year: isNatural ? -5000 : (startYearVal ? parseInt(startYearVal) : null),
                    end_year: isNatural ? null : (endYearVal ? parseInt(endYearVal) : null),
                    is_capital: isCapital
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/contributions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(data)
                    });
                    
                    const responseData = await response.json();

                    if (response.ok) {
                        alert('ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ê²€í†  í›„ ë°˜ì˜ë©ë‹ˆë‹¤.');
                        contributionForm.style.display = 'none';
                        addContributionForm.reset();
                        if (contributionMarker) map.removeLayer(contributionMarker);
                        // ëª¨ë“œ ì¢…ë£Œ
                        
                        // ğŸš© [ìˆ˜ì •] ì„œë²„ì—ì„œ ë°›ì€ ì‹¤ì œ IDê°€ í¬í•¨ëœ ê°ì²´ ì‚¬ìš©
                        if (responseData.contribution) {
                            contributions.push(responseData.contribution);
                        } else {
                            // Fallback (í˜¹ì‹œ ì„œë²„ê°€ êµ¬ë²„ì „ì¼ ê²½ìš°)
                            const tempContrib = { ...data, _id: 'temp_' + Date.now(), username: currentUser.username, status: 'pending', votes: 0 };
                            contributions.push(tempContrib);
                        }
                        
                        // ìœ ì €ë³µì› ë ˆì´ì–´ê°€ ì¼œì ¸ìˆìœ¼ë©´ ë§µ ì—…ë°ì´íŠ¸
                        if (layerVisibility.userContributions) {
                            const { year, month } = getCurrentYearMonth();
                            updateMap(year, month);
                        }
                    } else {
                        alert(responseData.message || 'ì œì¶œ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    console.error(error);
                    alert('ì˜¤ë¥˜ ë°œìƒ');
                }
            });
        }

        // ğŸš© [ì¶”ê°€] ì‚¬ê´€ ê¸°ë¡ ì œì¶œ í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const cancelRecordBtn = document.getElementById('cancelRecordBtn');
        if (cancelRecordBtn) {
            cancelRecordBtn.addEventListener('click', () => {
                console.log('ğŸ“œ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ë¨');
                const historicalRecordForm = document.getElementById('historicalRecordForm');
                if (historicalRecordForm) {
                    historicalRecordForm.style.display = 'none';
                    console.log('âœ… ì—­ì‚¬ê¸°ë¡ í¼ ë‹«í˜');
                } else {
                    console.log('âŒ historicalRecordForm ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
            });
        } else {
            console.log('âŒ cancelRecordBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }

        const addHistoricalRecordForm = document.getElementById('addHistoricalRecordForm');
        if (addHistoricalRecordForm) {
            addHistoricalRecordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    name: document.getElementById('recordName').value,
                    year: parseInt(document.getElementById('recordYear').value),
                    source: document.getElementById('recordSource').value,
                    content: document.getElementById('recordContent').value,
                    evidence: document.getElementById('recordEvidence').value,
                    category: 'historical_record' // ì‚¬ê´€ ê¸°ë¡ ì¹´í…Œê³ ë¦¬
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/contributions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(data)
                    });
                    
                    const responseData = await response.json();

                    if (response.ok) {
                        alert('ì‚¬ê´€ ê¸°ë¡ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ê²€í†  í›„ ë°˜ì˜ë©ë‹ˆë‹¤.');
                        const historicalRecordForm = document.getElementById('historicalRecordForm');
                        if (historicalRecordForm) historicalRecordForm.style.display = 'none';
                        addHistoricalRecordForm.reset();
                        
                        // ğŸš© [ì¶”ê°€] ì„œë²„ì—ì„œ ë°›ì€ ì‹¤ì œ IDê°€ í¬í•¨ëœ ê°ì²´ ì‚¬ìš©
                        if (responseData.contribution) {
                            contributions.push(responseData.contribution);
                        } else {
                            // Fallback
                            const tempContrib = { ...data, _id: 'temp_' + Date.now(), username: currentUser.username, status: 'pending', votes: 0 };
                            contributions.push(tempContrib);
                        }
                        
                        // ìœ ì €ë³µì› ë ˆì´ì–´ê°€ ì¼œì ¸ìˆìœ¼ë©´ ë§µ ì—…ë°ì´íŠ¸
                        if (layerVisibility.userContributions) {
                            const { year, month } = getCurrentYearMonth();
                            updateMap(year, month);
                        }
                    } else {
                        alert(responseData.message || 'ì œì¶œ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    console.error(error);
                    alert('ì˜¤ë¥˜ ë°œìƒ');
                }
            });
        }
        window.voteContribution = async (id) => {
            try {
                console.log('voteContribution called with id:', id);
                const response = await fetch(`${API_BASE_URL}/contributions/${id}/vote`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                console.log('vote response data:', data);

                if (response.ok) {
                    // ğŸš© [ìˆ˜ì •] ì„œë²„ì—ì„œ ë°›ì€ ìµœì‹  ì¶”ì²œ ìˆ˜ë¡œ UI ì—…ë°ì´íŠ¸
                    const countSpan = document.getElementById(`vote-count-${id}`);
                    console.log('countSpan found:', countSpan, 'data.votes:', data.votes);
                    if (countSpan && data.votes !== undefined) {
                        countSpan.textContent = data.votes;
                        console.log('Updated countSpan to:', data.votes);
                    }
                    
                    // íŒì—… ë²„íŠ¼ë„ ì—…ë°ì´íŠ¸ (ì§€ë„ íŒì—…) - íŒì—…ì„ ë‹«ì•„ì„œ ìµœì‹  ë°ì´í„°ë¡œ ë‹¤ì‹œ ì—´ë¦¬ë„ë¡ í•¨
                    const openPopups = document.querySelectorAll('.leaflet-popup');
                    openPopups.forEach(popup => {
                        const popupContent = popup.querySelector('.leaflet-popup-content');
                        if (popupContent && popupContent.innerHTML.includes(`voteContribution('${id}')`)) {
                            // ì´ íŒì—…ì´ í•´ë‹¹ contributionì˜ ê²ƒì´ë¼ë©´ ë‹«ê¸°
                            map.closePopup();
                            console.log('Closed popup for contribution:', id);
                        }
                    });
                    
                    // ëª¨ë‹¬ ë²„íŠ¼ë„ ì—…ë°ì´íŠ¸ (contribution ìƒì„¸ ì •ë³´ íŒì—…)
                    const modalVoteBtn = document.querySelector(`#contributionDetailModal button[onclick="voteContribution('${id}')"]`);
                    console.log('modalVoteBtn found:', modalVoteBtn);
                    if (modalVoteBtn) {
                        if (data.action === 'vote') {
                            // ì¶”ì²œ í›„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                            modalVoteBtn.style.display = 'none';
                        }
                    }
                    
                    // ëª¨ë‹¬ì˜ ì¶”ì²œì ëª©ë¡ë„ ì—…ë°ì´íŠ¸
                    const votersList = document.querySelector('#contributionDetailModal .voters-list');
                    if (votersList) {
                        // ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸ (ê°„ë‹¨í•˜ê²Œ ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨)
                        fetch(`${API_BASE_URL}/contributions?status=pending`)
                            .then(response => response.json())
                            .then(contributions => {
                                const contribution = contributions.find(c => c._id === id);
                                if (contribution && contribution.votedBy) {
                                    votersList.innerHTML = contribution.votedBy.length > 0 ? 
                                        contribution.votedBy.map(voter => `<div style="margin-bottom: 5px;">â€¢ ${voter}</div>`).join('') : 
                                        '<div style="color: #bdc3c7; font-style: italic;">ì•„ì§ ì¶”ì²œìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                                }
                            })
                            .catch(error => console.error('Failed to update voters list:', error));
                    }
                    
                    alert(data.message);
                } else {
                    alert(data.message || 'ì¶”ì²œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('voteContribution error:', error);
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        };

        // ğŸš© [ì¶”ê°€] ë³¸ì¸ ì‚¬ë£Œ ì‚­ì œ í•¨ìˆ˜
        window.deleteMyContribution = async (id) => {
            if (!confirm('ì •ë§ë¡œ ì´ ì‚¬ë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/contributions/${id}/my`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}` 
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert(data.message);
                    
                    // ì „ì—­ contributions ë°°ì—´ì—ì„œ ì‚­ì œ
                    const contributionIndex = contributions.findIndex(c => c._id === id);
                    if (contributionIndex !== -1) {
                        contributions.splice(contributionIndex, 1);
                        console.log(`âœ… [ì‚­ì œ ì™„ë£Œ] Contribution ë©”ëª¨ë¦¬ì—ì„œ ì œê±°: ${id}`);
                    }
                    
                    // ë§ˆì»¤ ì¦‰ì‹œ ì œê±°
                    if (map.getSource('userContributions')) {
                        const geojsonData = {
                            type: 'FeatureCollection',
                            features: contributions
                                .filter(c => ['pending', 'reviewed'].includes(c.status) && c.lat && c.lng && c.type !== 'historical_record')
                                .map(c => {
                                    const isMyContribution = c.created_by_username === currentUser?.username;
                                    const isReviewed = c.status === 'reviewed';
                                    let iconColor = isReviewed ? '#27ae60' : (isMyContribution ? '#3498db' : '#e67e22');
                                    
                                    return {
                                        type: 'Feature',
                                        geometry: { type: 'Point', coordinates: [c.lng, c.lat] },
                                        properties: {
                                            id: c._id,
                                            name: c.name,
                                            type: c.type,
                                            status: c.status,
                                            created_by: c.created_by_username,
                                            iconColor: iconColor,
                                            isMyContribution: isMyContribution,
                                            isReviewed: isReviewed
                                        }
                                    };
                                })
                        };
                        map.getSource('userContributions').setData(geojsonData);
                        console.log(`âœ… [ì‚­ì œ ì™„ë£Œ] ë§ˆì»¤ ì œê±°ë¨`);
                    }
                    
                    // íŒì—… ë‹«ê¸°
                    map.closePopup();
                } else {
                    alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('deleteMyContribution error:', error);
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        };

        // ï¿½ ì‚¬ë£Œ ìƒì„¸ë³´ê¸° - ìƒˆ íƒ­ì—ì„œ ranking.html ì—´ê¸° (sessionStorage í† í° ê³µìœ  ë¬¸ì œ í•´ê²°)
        window.openContribDetail = (id) => {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token') || '';
            const url = `ranking.html?contributionId=${encodeURIComponent(id)}${token ? '&t=' + encodeURIComponent(token) : ''}`;
            window.open(url, '_blank');
        };

        // ï¿½ğŸš© [ì¶”ê°€] ìŠ¹ì¸ í•¨ìˆ˜
        // ğŸš© [ìˆ˜ì •] ìµœì¢… ìŠ¹ì¸ í•¨ìˆ˜ (ìˆ˜êµ­ì‚¬ ì´ìƒ ê°€ëŠ¥ - ìƒˆ API ì‚¬ìš©, ìŠ¹ì¸ í›„ ë§ˆì»¤ ë³€í™˜)
        window.approveContribution = (id) => {
            // ê¸°ì—¬ ë°ì´í„° ì°¾ê¸°
            const contrib = (typeof contributions !== 'undefined' && Array.isArray(contributions))
                ? contributions.find(c => c._id === id)
                : null;
            if (!contrib) return alert('ê¸°ì—¬ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            // ê¸°ì—¬ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
            const modal = document.getElementById('contributionDetailModal');
            if (modal) modal.style.display = 'none';

            // editMode ê°•ì œ í™œì„±í™” (ê´€ë¦¬ìëŠ” í•­ìƒ í¸ì§‘ ê°€ëŠ¥)
            if (!editMode) {
                editMode = true;
                const editBtn = document.getElementById('editModeBtn');
                if (editBtn) editBtn.classList.add('active');
            }

            // castleFormì„ ìƒˆ í•­ëª© ëª¨ë“œë¡œ ì´ˆê¸°í™”
            editingCastleKey = null;
            closeAllFormsExcept('castleForm');
            openForm('castleForm');
            document.getElementById('cloneCastle').style.display = 'none';
            document.getElementById('deleteCastle').style.display = 'none';

            // ğŸš© ê¸°ì—¬ ì •ë³´ë¥¼ hidden inputì— ì„¸íŒ… (ì €ì¥ ì‹œ ìë™ approved ì²˜ë¦¬)
            document.getElementById('originContributionId').value = contrib._id;
            document.getElementById('originContributor').value = contrib.username || '';

            // ê¸°ë³¸ í•„ë“œ ì±„ìš°ê¸°
            document.getElementById('castleName').value = contrib.name || '';
            document.getElementById('castleLat').value = contrib.lat ?? '';
            document.getElementById('castleLng').value = contrib.lng ?? '';
            document.getElementById('castleDesc').value = contrib.description || contrib.desc || '';
            document.getElementById('castlePhoto').value = contrib.photo || '';
            document.getElementById('customIcon').value = '';
            document.getElementById('iconWidth').value = '';
            document.getElementById('iconHeight').value = '';

            // ë§ˆì»¤ íƒ€ì… ê²°ì •
            let markerType = 'normal';
            if (contrib.category === 'natural') markerType = 'natural';
            else if (contrib.category === 'label') markerType = 'label';
            else if (contrib.is_battle) markerType = 'battle';
            setActiveMarkerType(markerType);

            // ì—­ì‚¬ ê¸°ë¡ ì±„ìš°ê¸° (normal / battle)
            if (markerType === 'normal' || markerType === 'battle') {
                const historyListContainer = document.getElementById('castleHistoryList');
                historyListContainer.innerHTML = '';
                addCastleHistoryRow({
                    name: contrib.name || '',
                    country_id: contrib.country_id || '',
                    start_year: contrib.start_year ?? '',
                    start_month: contrib.start_month ?? 1,
                    end_year: contrib.end_year ?? '',
                    end_month: contrib.end_month ?? 12,
                    is_capital: contrib.is_capital || false,
                    is_battle: contrib.is_battle || false,
                });
            } else {
                // ìì—°/ë¼ë²¨: ë‹¨ìˆœ ê¸°ê°„
                document.getElementById('simpleStartYear').value = contrib.start_year ?? '';
                document.getElementById('simpleStartMonth').value = contrib.start_month ?? '';
                document.getElementById('simpleEndYear').value = contrib.end_year ?? '';
                document.getElementById('simpleEndMonth').value = contrib.end_month ?? '';
            }

            // í¸ì§‘ ë§ˆì»¤ ì§€ë„ì— ì¶”ê°€
            if (editMarker) map.removeLayer(editMarker);
            if (contrib.lat && contrib.lng) {
                editMarker = L.marker([contrib.lat, contrib.lng], { draggable: true }).addTo(map);
                editMarker.on('dragend', (e) => {
                    const pos = e.target.getLatLng();
                    document.getElementById('castleLat').value = pos.lat.toFixed(6);
                    document.getElementById('castleLng').value = pos.lng.toFixed(6);
                });
                editMarker.bindPopup(`ğŸ“‹ ê¸°ì—¬ ê²€í†  ì¤‘: ${contrib.name}<br>ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •`).openPopup();
                map.setView([contrib.lat, contrib.lng], Math.max(map.getZoom(), 8));
            }
        };

        window.loadContributions = async () => {
            try {
                contributions = await fetchData('contributions');
                const { year, month } = getCurrentYearMonth();
                updateMap(year, month);
                console.log('Contributions reloaded and map updated');
            } catch (error) {
                console.error('Failed to reload contributions:', error);
            }
        };

        // ğŸš© [ì¶”ê°€] ë³¸ì¸ ì‚¬ë£Œ ì‚­ì œ í•¨ìˆ˜ (ìŠ¹ì¸ ì „ì—ë§Œ ê°€ëŠ¥)
        window.deleteMyContribution = async (id) => {
            if (!confirm('ì •ë§ë¡œ ì´ ì‚¬ë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì‚­ì œëœ ì‚¬ë£ŒëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìœ¼ë©°, ì‚¬ë£Œ ì œì¶œ ì ìˆ˜(3ì )ê°€ ì°¨ê°ë©ë‹ˆë‹¤.')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/contributions/${id}/my`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('âœ… ' + data.message);
                    // ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    document.getElementById('contributionDetailModal').style.display = 'none';
                    
                    // contributions ë°°ì—´ì—ì„œ ì‚­ì œëœ í•­ëª© ì œê±°
                    if (typeof contributions !== 'undefined' && Array.isArray(contributions)) {
                        contributions = contributions.filter(c => c._id !== id);
                    }
                    
                    loadContributions();
                    // ì‚¬ìš©ì ì •ë³´ ê°±ì‹ 
                    updateTopBarUserInfo();
                } else {
                    alert('âŒ ' + (data.message || 'ì‚­ì œ ì‹¤íŒ¨'));
                }
            } catch (error) {
                alert('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
        };

        window.deleteContribution = async (id) => {
            if (!confirm('ì •ë§ë¡œ ì´ ì‚¬ë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/contributions/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert(data.message);
                    // ëª¨ë‹¬ ë‹«ê¸° ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    document.getElementById('contributionDetailModal').style.display = 'none';
                    
                    // contributions ë°°ì—´ì—ì„œ ì‚­ì œëœ í•­ëª© ì œê±°
                    if (typeof contributions !== 'undefined' && Array.isArray(contributions)) {
                        contributions = contributions.filter(c => c._id !== id);
                    }
                    
                    loadContributions();
                } else {
                    alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        };

        // ğŸš© [ì¶”ê°€] ê²€í†  í•¨ìˆ˜
        window.reviewContribution = async (id, status) => {
            const comment = document.getElementById('reviewComment')?.value || '';
            if (!confirm(`ì •ë§ë¡œ ì´ ì‚¬ë£Œë¥¼ ${status === 'approved' ? 'ê²€í†  ì™„ë£Œ' : 'ê²€í†  ê±°ë¶€'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/contributions/${id}/review`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ status, comment })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert(data.message);
                    // ëª¨ë‹¬ ë‹«ê¸°
                    document.getElementById('contributionDetailModal').style.display = 'none';
                    
                    // ğŸŸ¢ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸: ë§ˆì»¤ ìƒ‰ìƒ ì¦‰ì‹œ ë³€ê²½
                    if (status === 'reviewed') {
                        // ì „ì—­ contributions ë°°ì—´ì—ì„œ í•´ë‹¹ contribution ì°¾ì•„ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸
                        const contribution = contributions.find(c => c._id === id);
                        if (contribution) {
                            contribution.status = 'reviewed';
                            console.log(`âœ… [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] ${contribution.name}ì˜ ìƒíƒœë¥¼ 'reviewed'ë¡œ ë³€ê²½`);
                        }
                        
                        // userContributions ë ˆì´ì–´ì˜ ëª¨ë“  ë§ˆì»¤ ë‹¤ì‹œ ë Œë”ë§
                        if (map.getSource('userContributions')) {
                            console.log('ğŸ”„ [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] ì‚¬ê´€ ë§ˆì»¤ ë‹¤ì‹œ ë Œë”ë§ ì¤‘...');
                            
                            const geojsonData = {
                                type: 'FeatureCollection',
                                features: []
                            };

                            contributions.forEach(c => {
                                // pending ë˜ëŠ” reviewed ìƒíƒœë§Œ í‘œì‹œ
                                if (!['pending', 'reviewed'].includes(c.status)) return;
                                if (!c.lat || !c.lng) return;
                                if (c.type === 'historical_record') return;

                                const isMyContribution = c.created_by_username === currentUser?.username;
                                const isReviewed = c.status === 'reviewed';

                                let iconColor;
                                if (isReviewed) {
                                    iconColor = '#27ae60'; // ğŸŸ¢ ì´ˆë¡ìƒ‰: 1ì°¨ ê²€í†  ì™„ë£Œ
                                } else if (isMyContribution) {
                                    iconColor = '#3498db'; // ğŸ”µ íŒŒë€ìƒ‰: ë‚´ê°€ ì œì¶œí•œ ì‚¬ë£Œ
                                } else {
                                    iconColor = '#e67e22'; // ğŸŸ  ì£¼í™©ìƒ‰: ë‹¤ë¥¸ ì‚¬ëŒì˜ ì‚¬ë£Œ
                                }

                                geojsonData.features.push({
                                    type: 'Feature',
                                    geometry: {
                                        type: 'Point',
                                        coordinates: [c.lng, c.lat]
                                    },
                                    properties: {
                                        id: c._id,
                                        name: c.name,
                                        type: c.type,
                                        status: c.status,
                                        created_by: c.created_by_username,
                                        iconColor: iconColor,
                                        isMyContribution: isMyContribution,
                                        isReviewed: isReviewed
                                    }
                                });
                            });

                            map.getSource('userContributions').setData(geojsonData);
                            console.log(`âœ… [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] ${geojsonData.features.length}ê°œ ë§ˆì»¤ ë Œë”ë§ ì™„ë£Œ`);
                        }
                    } else if (status === 'approved') {
                        // approvedëœ ê²½ìš° ë§ˆì»¤ ì œê±° (ì •ì‹ Castleë¡œ ì „í™˜ë¨)
                        const contributionIndex = contributions.findIndex(c => c._id === id);
                        if (contributionIndex !== -1) {
                            console.log(`âœ… [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] ${contributions[contributionIndex].name} ìŠ¹ì¸ë¨ - ë§ˆì»¤ ì œê±°`);
                            contributions.splice(contributionIndex, 1);
                            
                            // ë§ˆì»¤ ë‹¤ì‹œ ë Œë”ë§ (approvedëœ ê²ƒ ì œì™¸)
                            if (map.getSource('userContributions')) {
                                const geojsonData = {
                                    type: 'FeatureCollection',
                                    features: contributions
                                        .filter(c => ['pending', 'reviewed'].includes(c.status) && c.lat && c.lng && c.type !== 'historical_record')
                                        .map(c => {
                                            const isMyContribution = c.created_by_username === currentUser?.username;
                                            const isReviewed = c.status === 'reviewed';
                                            let iconColor = isReviewed ? '#27ae60' : (isMyContribution ? '#3498db' : '#e67e22');
                                            
                                            return {
                                                type: 'Feature',
                                                geometry: { type: 'Point', coordinates: [c.lng, c.lat] },
                                                properties: {
                                                    id: c._id,
                                                    name: c.name,
                                                    type: c.type,
                                                    status: c.status,
                                                    created_by: c.created_by_username,
                                                    iconColor: iconColor,
                                                    isMyContribution: isMyContribution,
                                                    isReviewed: isReviewed
                                                }
                                            };
                                        })
                                };
                                map.getSource('userContributions').setData(geojsonData);
                                console.log(`âœ… [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] ìŠ¹ì¸ëœ ë§ˆì»¤ ì œê±° ì™„ë£Œ`);
                            }
                        }
                    }
                } else {
                    alert(data.message || 'ê²€í†  ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ê²€í†  ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        };
        // ğŸš© [ìˆ˜ì •] ì‚¬ë£Œ ìƒì„¸ë³´ê¸° â†’ ranking.html íŒì—…ìœ¼ë¡œ ë³€ê²½
        function showContributionDetail(contribution) {
            // contributionì´ ê°ì²´ì¸ ê²½ìš° ID ì¶”ì¶œ, ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            const contributionId = typeof contribution === 'object' ? contribution._id : contribution;
            
            // ranking.html íŒì—…ì„ ì—´ê³  íŠ¹ì • ì‚¬ë£Œë¡œ ì´ë™
            const width = 1300;
            const height = 850;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            const features = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`;
            
            window.open(`ranking.html?contributionId=${contributionId}`, '_blank', features);
        }

        // ğŸš© [ìˆ˜ì •] ê²€í†  ëª¨ë‹¬ â†’ ranking.html íŒì—…ìœ¼ë¡œ ë³€ê²½
        window.showReviewModal = (contributionId) => {
            // ranking.html íŒì—…ì„ ì—´ê³  íŠ¹ì • ì‚¬ë£Œë¡œ ì´ë™
            const width = 1300;
            const height = 850;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            const features = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`;
            
            window.open(`ranking.html?contributionId=${contributionId}`, '_blank', features);
        }

        async function displayRanking() {
            try {
                // ğŸš© [ì¶”ê°€] ìºì‹œ ìš°íšŒë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒë¼ë¯¸í„°
                const timestamp = Date.now();
                const response = await fetch(`/api/rankings?_t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const users = await response.json();
                
                // ğŸš© [ìˆ˜ì •] body ì˜ì—­ì—ë§Œ ë Œë”ë§ (í—¤ë”ëŠ” ê³ ì •)
                const rankingDisplay = document.getElementById('rankingDisplay');
                const rankingBody = document.getElementById('rankingDisplay-body');
                if (!rankingDisplay || !rankingBody) {
                    console.log('rankingDisplay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
                
                // ğŸš© [ì¶”ê°€] í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const currentUser = parseJwt(token);
                const currentUsername = currentUser?.username;

                if (!Array.isArray(users) || users.length === 0) {
                    rankingBody.innerHTML = '<div style="color: #95a5a6; font-size: 11px;">ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                // ìƒìœ„ 5ëª… í‘œì‹œ
                const topUsers = users.slice(0, 5);
                rankingBody.innerHTML = topUsers.map((user, index) => {
                        const rank = index + 1;
                        const medal = rank === 1 ? 'ğŸ‘‘' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : 'ğŸ…';
                        const isMe = user.username === currentUsername;
                        const pos = normalizePosition(user.position || '');
                        const isAdmin = user.role === 'admin' || user.role === 'superuser';
                        const isDesignated = !isAdmin && user.designated_rank != null;
                        const badge = isAdmin
                            ? '<span style="font-size:9px; background:#8e44ad; color:#fff; border-radius:3px; padding:0 3px; margin-left:3px;">ê´€ë¦¬ì</span>'
                            : isDesignated
                                ? '<span style="font-size:9px; background:#c0392b; color:#fff; border-radius:3px; padding:0 3px; margin-left:3px;">ì§€ì •</span>'
                                : '';
                        return `<div style="margin-bottom: 3px; font-size: 11px; ${isMe ? 'color: #3498db; font-weight: bold;' : 'color: #ecf0f1;'}">`
                            + `${medal} ${user.username}${isMe ? ' ğŸ‘¤' : ''}${badge}`
                            + `<span style="color: #f39c12; font-size: 10px; margin-left: 4px;">${pos}</span>`
                            + `<span style="color: #95a5a6; font-size: 10px; margin-left: 4px;">(${user.score || 0}P)</span>`
                            + `</div>`;
                    }).join('');
            } catch (error) {
                console.error('Error fetching ranking data:', error);
                const rankingBody = document.getElementById('rankingDisplay-body');
                if (rankingBody) {
                    rankingBody.innerHTML = '<div style="color: #e74c3c; font-size: 11px;">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
                }
            }
        }

        // ğŸš© [ìˆ˜ì •] íŠ¹ì • ì‚¬ìš©ìì˜ ì‚¬ë£Œ í‘œì‹œ í•¨ìˆ˜ - ranking.html íŒì—…ìœ¼ë¡œ ì—´ê¸°
        window.showUserContributions = async (username) => {
            // ranking.html íŒì—…ì„ ì—´ê³  í•´ë‹¹ ì‚¬ìš©ìì˜ ì‚¬ë£Œë¥¼ í‘œì‹œ
            const width = 1300;
            const height = 850;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            window.open(
                `ranking.html?user=${encodeURIComponent(username)}`,
                'rankingWindow',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
        };

        async function displayContributions() {
            try {
                const response = await fetch('/api/contributions');
                const contributions = await response.json();
                const container = document.getElementById('contributionsList');
                const filter = document.getElementById('contributionFilter').value;
                const currentUser = parseJwt(token);

                // ë””ë²„ê¹… ì •ë³´ ì¶”ê°€
                console.log('=== ì‚¬ë£Œ í‘œì‹œ ë””ë²„ê¹… ===');
                console.log('í† í° ì¡´ì¬:', !!token);
                console.log('í˜„ì¬ ì‚¬ìš©ì:', currentUser);
                console.log('í•„í„° ê°’:', filter);
                console.log('ì´ ì‚¬ë£Œ ìˆ˜:', contributions.length);

                if (currentUser) {
                    console.log('ì‚¬ìš©ì ID:', currentUser.id);
                    console.log('ì‚¬ìš©ì _id:', currentUser._id);
                    console.log('ì‚¬ìš©ì sub:', currentUser.sub);
                    console.log('ì‚¬ìš©ì userId:', currentUser.userId);
                    console.log('ì‚¬ìš©ì ì´ë¦„:', currentUser.username);
                    
                    // ë‹¤ì–‘í•œ ID í•„ë“œë¡œ ì‹œë„
                    const possibleIds = [currentUser.id, currentUser._id, currentUser.sub, currentUser.userId].filter(id => id);
                    console.log('ê°€ëŠ¥í•œ IDë“¤:', possibleIds);
                    
                    const userContributions = contributions.filter(c => {
                        const match = possibleIds.some(id => c.userId === id || c.userId === id?.toString());
                        console.log('ì‚¬ë£Œ ë¹„êµ:', c.userId, 'vs ê°€ëŠ¥í•œ IDë“¤:', possibleIds, 'ì¼ì¹˜:', match, 'ì œëª©:', c.name || c.title);
                        return match;
                    });
                    console.log('ì‚¬ìš©ìì˜ ì‚¬ë£Œ ìˆ˜:', userContributions.length);
                }

                container.innerHTML = ''; // Clear previous data

                let filteredContributions = contributions;
                if (filter === 'mine' && currentUser) {
                    // ë‹¤ì–‘í•œ ID í•„ë“œë¡œ ì‹œë„
                    const possibleIds = [currentUser.id, currentUser._id, currentUser.sub, currentUser.userId].filter(id => id);
                    filteredContributions = contributions.filter(c => 
                        possibleIds.some(id => c.userId === id || c.userId === id?.toString())
                    );
                    console.log('í•„í„°ë§ í›„ ì‚¬ë£Œ ìˆ˜:', filteredContributions.length);
                }

                if (filteredContributions.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #bdc3c7;">í‘œì‹œí•  ì‚¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                filteredContributions.forEach(contribution => {
                    const item = document.createElement('div');
                    item.style.border = '1px solid #5d7185';
                    item.style.borderRadius = '8px';
                    item.style.padding = '15px';
                    item.style.marginBottom = '10px';
                    item.style.backgroundColor = '#2c3e50';
                    item.style.cursor = 'pointer';
                    item.style.transition = 'all 0.2s ease';

                    // ğŸš© [ìˆ˜ì •] ìì‹ ì˜ ì‚¬ë£ŒëŠ” íŒŒë€ìƒ‰ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ì ìš©
                    const possibleIds = currentUser ? [currentUser.id, currentUser._id, currentUser.sub, currentUser.userId].filter(id => id) : [];
                    const isMyContribution = currentUser && possibleIds.some(id => contribution.userId === id || contribution.userId === id?.toString());
                    if (isMyContribution) {
                        item.style.border = '2px solid #3498db';
                        item.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                        item.style.boxShadow = '0 0 8px rgba(52, 152, 219, 0.3)';
                    }

                    // ğŸš© [ìˆ˜ì •] reviewed ìƒíƒœ ì¶”ê°€
                    const statusColor = contribution.status === 'approved' ? '#27ae60' : 
                                       contribution.status === 'reviewed' ? '#3498db' :
                                       contribution.status === 'rejected' ? '#e74c3c' : '#f39c12';
                    const statusText = contribution.status === 'approved' ? 'ìµœì¢… ìŠ¹ì¸' : 
                                      contribution.status === 'reviewed' ? 'ê²€í†  ì™„ë£Œ' :
                                      contribution.status === 'rejected' ? 'ê±°ë¶€ë¨' : 'ê²€í†  ëŒ€ê¸°';
                    const statusIcon = contribution.status === 'approved' ? 'âœ…' : 
                                      contribution.status === 'reviewed' ? 'ğŸ”' :
                                      contribution.status === 'rejected' ? 'âŒ' : 'â³';

                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: #ffffff;">${contribution.name || contribution.title || 'ì œëª© ì—†ìŒ'} ${isMyContribution ? 'ğŸ‘¤' : ''}</div>
                            <div style="color: ${statusColor}; font-weight: bold; font-size: 0.9em;">${statusIcon} ${statusText}</div>
                        </div>
                        <div style="color: #bdc3c7; margin-bottom: 10px; font-size: 0.9em;">ì œì¶œì: ${contribution.username || 'ì•Œ ìˆ˜ ì—†ìŒ'} | ${new Date(contribution.createdAt).toLocaleDateString()}</div>
                        <div style="color: #ffffff; line-height: 1.4; margin-bottom: 10px;">${contribution.description || 'ë‚´ìš© ì—†ìŒ'}</div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #95a5a6;">
                            ğŸ‘ ${contribution.votes || 0}${(contribution.commentCount > 0) ? ` &nbsp;ğŸ’¬ <span style="color:#f1c40f;">${contribution.commentCount}</span>` : ''} &nbsp;|&nbsp; ${contribution.category || 'ë¯¸ë¶„ë¥˜'}
                        </div>
                    `;

                    // í˜¸ë²„ íš¨ê³¼
                    item.onmouseover = () => {
                        item.style.transform = 'translateY(-2px)';
                        item.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                    };
                    item.onmouseout = () => {
                        item.style.transform = 'translateY(0)';
                        item.style.boxShadow = 'none';
                    };

                    // í´ë¦­ ì´ë²¤íŠ¸ë¡œ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
                    item.onclick = () => showContributionDetail(contribution);

                    // íˆ¬í‘œ ë²„íŠ¼ ì¶”ê°€ (ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ì´ê³  ìì‹ ì˜ ì‚¬ë£Œê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
                    if (contribution.status === 'pending' && currentUser && !isMyContribution) {
                        const voteBtn = document.createElement('button');
                        voteBtn.textContent = 'ì¶”ì²œí•˜ê¸°';
                        voteBtn.style.marginTop = '10px';
                        voteBtn.style.padding = '5px 10px';
                        voteBtn.style.backgroundColor = '#3498db';
                        voteBtn.style.color = 'white';
                        voteBtn.style.border = 'none';
                        voteBtn.style.borderRadius = '4px';
                        voteBtn.style.cursor = 'pointer';
                        voteBtn.onclick = (e) => {
                            e.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                            voteContribution(contribution._id);
                        };
                        item.appendChild(voteBtn);
                    }

                    // ğŸš© ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ ì¶”ê°€
                    let adminControls = '';
                    if (currentUser) {
                        const userPosition = currentUser.position;
                        const isAdminRole = currentUser.role === 'admin' || currentUser.role === 'superuser';
                        // ê²€í†  ê¶Œí•œ: ì‹œê°•í•™ì‚¬(ì¢…4í’ˆ) ~ ìˆ˜ì°¬ê´€(ì •3í’ˆ) - ìƒê¸‰ ì‚¬ê´€
                        const reviewerPositions = [
                            'ì‹œê°•í•™ì‚¬', 'ì‚¬ê´€ìˆ˜ì°¬', 'ì§ìˆ˜ì°¬ê´€', 'ìˆ˜ì°¬ê´€'
                        ];
                        // ìŠ¹ì¸ ê¶Œí•œ: ë™ìˆ˜êµ­ì‚¬(ì¢…2í’ˆ) ~ ê°ìˆ˜êµ­ì‚¬(ì •1í’ˆ) - ì¬ìƒê¸‰
                        const approverPositions = ['ë™ìˆ˜êµ­ì‚¬', 'ìˆ˜êµ­ì‚¬', 'íŒì‚¬ê´€ì‚¬', 'ê°ìˆ˜êµ­ì‚¬'];
                        
                        const canReview = isAdminRole || reviewerPositions.includes(userPosition);
                        const canApprove = isAdminRole || approverPositions.includes(userPosition);
                        
                        // ê²€í†  ë²„íŠ¼ (ì‹œê°•í•™ì‚¬ ì´ìƒ ë˜ëŠ” admin/superuser) - pending ìƒíƒœë©´ í‘œì‹œ
                        if (canReview && contribution.status === 'pending') {
                            adminControls += `<button onclick="event.stopPropagation(); showReviewModal('${contribution._id}')" class="button-style" style="padding: 2px 6px; font-size: 11px; margin-left: 5px; background-color: #f39c12;">ğŸ” ê²€í† </button>`;
                        }
                        
                        // ìŠ¹ì¸ ë²„íŠ¼ (ë™ìˆ˜êµ­ì‚¬ ì´ìƒ ë˜ëŠ” admin/superuser) - pending ë˜ëŠ” reviewed ìƒíƒœ
                        if (canApprove && (contribution.status === 'pending' || contribution.status === 'reviewed')) {
                            adminControls += `<button onclick="event.stopPropagation(); approveContribution('${contribution._id}')" class="button-style primary" style="padding: 2px 6px; font-size: 11px; margin-left: 5px; background-color: #27ae60;">âœ… ìµœì¢… ìŠ¹ì¸</button>`;
                        }
                        
                        // ë§ˆì»¤ ë³€í™˜ ë²„íŠ¼ (ë™ìˆ˜êµ­ì‚¬ ì´ìƒ ë˜ëŠ” admin/superuser) - approved ìƒíƒœì—ì„œë§Œ
                        if ((canApprove || isAdminRole) && contribution.status === 'approved') {
                            adminControls += `<button onclick="event.stopPropagation(); convertContribution('${contribution._id}')" class="button-style primary" style="padding: 2px 6px; font-size: 11px; margin-left: 5px;">ğŸ° ë§ˆì»¤ ë³€í™˜</button>`;
                        }
                    }

                    // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ì„ ì¶”ê°€
                    if (adminControls) {
                        const controlsDiv = document.createElement('div');
                        controlsDiv.style.marginTop = '10px';
                        controlsDiv.innerHTML = adminControls;
                        item.appendChild(controlsDiv);
                    }

                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error fetching contributions:', error);
                const container = document.getElementById('contributionsList');
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">ì‚¬ë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ğŸš© [ì¶”ê°€] ì´ˆê¸° ë­í‚¹ í‘œì‹œ
        displayRanking();

        // ğŸš© [ì¶”ê°€] ë­í‚¹ í—¤ë” í´ë¦­ ì‹œ ranking.html íŒì—… ì—´ê¸°
        const rankingDisplayHeader = document.getElementById('rankingDisplay-header');
        if (rankingDisplayHeader) {
            rankingDisplayHeader.addEventListener('click', () => {
                const width = 1300, height = 850;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                window.open('ranking.html', 'rankingWindow',
                    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
            });
        }

        // ğŸš© [ì¶”ê°€] 5ë¶„ë§ˆë‹¤ ë­í‚¹ ì—…ë°ì´íŠ¸
        setInterval(displayRanking, 5 * 60 * 1000);

    });
  </script>

  <!-- ğŸš© [ì¶”ê°€] ì‚¬ê´€ ëª¨ì§‘ íŒì—… ëª¨ë‹¬ -->
  <style>
    /* ì‚¬ê´€ëª¨ì§‘ íŒì—… ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    #welcomePopupModal .recruit-inner {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #ecf0f1;
      margin: 3% auto;
      padding: 30px;
      border: 3px solid #f39c12;
      width: 95%;
      max-width: 780px;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      position: relative;
      box-sizing: border-box;
    }
    #welcomePopupModal .header-icon img {
      max-width: 80px;
      height: auto;
    }
    #welcomePopupModal .recruit-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }
    #welcomePopupModal .recruit-4col {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      text-align: center;
    }
    #welcomePopupModal .recruit-steps {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }
    #welcomePopupModal .recruit-h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: 2.2em;
      background: linear-gradient(135deg, #f39c12, #e67e22, #d35400);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 15px 0;
    }
    @media (max-width: 600px) {
      #welcomePopupModal {
        align-items: flex-start;
      }
      #welcomePopupModal .recruit-inner {
        margin: 0;
        padding: 14px 10px 20px;
        border-radius: 0;
        border-left: none;
        border-right: none;
        border-top: none;
        max-height: none;
        width: 100%;
        box-sizing: border-box;
      }
      #welcomePopupModal .recruit-h1 {
        font-size: 1.3em !important;
        margin: 8px 0 !important;
      }
      #welcomePopupModal .recruit-header-section {
        margin-bottom: 12px !important;
      }
      #welcomePopupModal .recruit-header-section p {
        font-size: 0.85em !important;
        margin: 4px 0 !important;
      }
      #welcomePopupModal .header-icon img {
        max-width: 48px !important;
      }
      #welcomePopupModal .recruit-quote {
        padding: 10px 12px !important;
        margin-bottom: 12px !important;
      }
      #welcomePopupModal .recruit-quote p {
        font-size: 0.95em !important;
        margin: 0 !important;
      }
      #welcomePopupModal .recruit-2col {
        grid-template-columns: 1fr !important;
        gap: 10px;
        margin-bottom: 12px !important;
      }
      #welcomePopupModal .recruit-2col > div {
        padding: 12px !important;
      }
      #welcomePopupModal .recruit-2col li {
        font-size: 0.85em !important;
        padding: 4px 0 4px 18px !important;
      }
      #welcomePopupModal .recruit-rank-section {
        padding: 12px !important;
        margin-bottom: 12px !important;
      }
      #welcomePopupModal .recruit-rank-section h3 {
        margin-bottom: 8px !important;
        font-size: 0.95em !important;
      }
      #welcomePopupModal .recruit-rank-section p {
        margin-bottom: 8px !important;
        font-size: 0.8em !important;
      }
      #welcomePopupModal .recruit-4col {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 6px;
      }
      #welcomePopupModal .recruit-4col > div {
        padding: 8px 4px !important;
      }
      #welcomePopupModal .recruit-4col .rank-label {
        font-size: 0.75em !important;
      }
      #welcomePopupModal .recruit-steps {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px;
      }
      #welcomePopupModal .recruit-steps > div {
        padding: 10px 8px !important;
      }
      #welcomePopupModal .recruit-steps h4 {
        font-size: 0.8em !important;
        margin: 0 !important;
      }
      #welcomePopupModal .recruit-steps p {
        font-size: 0.7em !important;
        margin: 2px 0 0 !important;
      }
      #welcomePopupModal .recruit-cta {
        padding: 14px 10px !important;
        margin-bottom: 10px !important;
      }
      #welcomePopupModal .recruit-cta h2 {
        font-size: 0.95em !important;
        margin-bottom: 10px !important;
      }
      #welcomePopupModal .recruit-cta a {
        padding: 10px 20px !important;
        font-size: 0.9em !important;
      }
      #welcomePopupModal #showFullRankInfoBtn {
        font-size: 0.8em !important;
        padding: 6px 14px !important;
      }
    }
  </style>

  <div id="welcomePopupModal" style="display: none; position: fixed; z-index: 999999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;">
    <div class="recruit-inner">
      
      <!-- ë‹«ê¸° ë²„íŠ¼ -->
      <button id="closeWelcomePopupBtn" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #ecf0f1; transition: color 0.3s;">&times;</button>
      
      <!-- í—¤ë” -->
      <div class="recruit-header-section" style="text-align: center; margin-bottom: 30px;">
       <div class="header-icon"><img src="https://github.com/projeffmanager-design/historymap/blob/main/2I63ySQI9qG-97MMKptL_n5FJhNOWE2DLt-ZKOcLL5TKeV4xxTfCN06j0lhGg5YMDH0ade2X99P-pzcKInnlOg.png?raw=true"></div>
        <h1 class="recruit-h1">ê³ ë ¤ë§Œë¦¬ì§€ë„ ì‚¬ê´€ ëª¨ì§‘</h1>
        <p style="font-size: 1.1em; color: #bdc3c7; font-style: italic;">å²é¤¨ (ì—­ì‚¬ë¥¼ ê¸°ë¡í•˜ëŠ” ê´€ì²­)</p>
      </div>

      <!-- ì¸ìš©ë¬¸ ë°•ìŠ¤ -->
      <div class="recruit-quote" style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(243, 156, 18, 0.15), rgba(230, 126, 34, 0.1)); border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #f39c12;">
        <p style="font-family: 'Noto Serif KR', serif; font-size: 1.3em; color: #f39c12; font-weight: 700;">"ìƒì–´ë²„ë¦° ìš°ë¦¬ ì—­ì‚¬ì˜ ì§€ëª…ì„ ë˜ì°¾ì•„ ì£¼ì„¸ìš”"</p>
      </div>

      <!-- 2ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ -->
      <div class="recruit-2col">
        <!-- ëª¨ì§‘ ëŒ€ìƒ -->
        <div style="background: rgba(44, 62, 80, 0.5); padding: 20px; border-radius: 12px; border: 1px solid rgba(243, 156, 18, 0.3);">
          <h3 style="color: #f39c12; margin-bottom: 15px; font-size: 1.1em;">ğŸ¯ ëª¨ì§‘ ëŒ€ìƒ</h3>
          <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="padding: 8px 0; padding-left: 20px; position: relative; font-size: 0.95em;"><span style="position: absolute; left: 0; color: #e67e22;">â–¸</span>í•œêµ­ ê³ ëŒ€ì‚¬/ì¤‘ì„¸ì‚¬ì— ê´€ì‹¬ ìˆëŠ” ë¶„</li>
            <li style="padding: 8px 0; padding-left: 20px; position: relative; font-size: 0.95em;"><span style="position: absolute; left: 0; color: #e67e22;">â–¸</span>ê³ ì§€ë„, ì‚¬ì„œ ì—°êµ¬ì— í¥ë¯¸ ìˆëŠ” ë¶„</li>
            <li style="padding: 8px 0; padding-left: 20px; position: relative; font-size: 0.95em;"><span style="position: absolute; left: 0; color: #e67e22;">â–¸</span>ì§€ë¦¬/ê¸°í›„ ì¦ê±°ë¡œ ì—­ì‚¬ë¥¼ íƒêµ¬í•˜ê³  ì‹¶ì€ ë¶„</li>
            <li style="padding: 8px 0; padding-left: 20px; position: relative; font-size: 0.95em;"><span style="position: absolute; left: 0; color: #e67e22;">â–¸</span>ì—­ì‚¬ ë³µì›ì— ê¸°ì—¬í•˜ê³  ì‹¶ì€ ëª¨ë“  ë¶„</li>
          </ul>
        </div>

        <!-- ì‚¬ê´€ì˜ ì—­í•  -->
        <div style="background: rgba(44, 62, 80, 0.5); padding: 20px; border-radius: 12px; border: 1px solid rgba(52, 152, 219, 0.3);">
          <h3 style="color: #3498db; margin-bottom: 15px; font-size: 1.1em;">ğŸ“œ ì‚¬ê´€ì˜ ì—­í• </h3>
          <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="padding: 8px 0; padding-left: 20px; position: relative; font-size: 0.95em;"><span style="position: absolute; left: 0; color: #3498db;">â–¸</span>ì‚¬ë£Œì™€ ê³ ì§€ë„ë¥¼ ê·¼ê±°ë¡œ ìƒì–´ë²„ë¦° ì§€ëª… ë³µì›</li>
            <li style="padding: 8px 0; padding-left: 20px; position: relative; font-size: 0.95em;"><span style="position: absolute; left: 0; color: #3498db;">â–¸</span>ì—­ì‚¬ ì—°êµ¬ ì„±ê³¼ë¥¼ ê¸°ë¡ìœ¼ë¡œ ë‚¨ê¸°ê¸°</li>
            <li style="padding: 8px 0; padding-left: 20px; position: relative; font-size: 0.95em;"><span style="position: absolute; left: 0; color: #3498db;">â–¸</span>ë‹¤ë¥¸ ì‚¬ê´€ì˜ ì—°êµ¬ ê²€í†  ë° ì¶”ì²œ</li>
            <li style="padding: 8px 0; padding-left: 20px; position: relative; font-size: 0.95em;"><span style="position: absolute; left: 0; color: #f39c12;">â–¸</span><strong style="color: #f39c12;">ìŠ¹ì¸ëœ ì—°êµ¬ëŠ” ë³¸ì¸ ì´ë¦„ìœ¼ë¡œ ì§€ë„ì— ì˜êµ¬ ë“±ë¡</strong></li>
          </ul>
        </div>
      </div>

      <!-- ì§ê¸‰ ì²´ê³„ ìš”ì•½ -->
      <div class="recruit-rank-section" style="background: rgba(44, 62, 80, 0.5); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(243, 156, 18, 0.3);">
        <h3 style="color: #f39c12; margin-bottom: 15px; font-size: 1.1em;">ğŸ‘‘ ì‚¬ê´€ 18ë‹¨ê³„ ì§ê¸‰ ì²´ê³„</h3>
        <p style="margin-bottom: 15px; color: #bdc3c7; font-size: 0.9em;">ê¸°ì—¬ë„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ìŠ¹ê¸‰ë©ë‹ˆë‹¤</p>
        
        <div class="recruit-4col">
          <div style="background: linear-gradient(135deg, #f39c12, #e67e22); padding: 12px 8px; border-radius: 8px;">
            <div style="font-weight: bold; color: #1a1a2e; font-size: 0.85em;">ì •1í’ˆ~ì¢…2í’ˆ</div>
            <div style="font-size: 0.75em; color: #1a1a2e; opacity: 0.8;">ì¬ìƒê¸‰ (ìƒìœ„ 4ì¸)</div>
          </div>
          <div style="background: linear-gradient(135deg, #bdc3c7, #95a5a6); padding: 12px 8px; border-radius: 8px;">
            <div style="font-weight: bold; color: #1a1a2e; font-size: 0.85em;">ì •3í’ˆ~ì¢…4í’ˆ</div>
            <div style="font-size: 0.75em; color: #1a1a2e; opacity: 0.8;">ìƒê¸‰ ì‚¬ê´€</div>
          </div>
          <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 12px 8px; border-radius: 8px;">
            <div style="font-weight: bold; color: white; font-size: 0.85em;">ì •5í’ˆ~ì¢…6í’ˆ</div>
            <div style="font-size: 0.75em; color: white; opacity: 0.8;">ì¤‘ê¸‰ ì‚¬ê´€</div>
          </div>
          <div style="background: linear-gradient(135deg, #3498db, #2980b9); padding: 12px 8px; border-radius: 8px;">
            <div style="font-weight: bold; color: white; font-size: 0.85em;">ì •7í’ˆ~ì¢…9í’ˆ</div>
            <div style="font-size: 0.75em; color: white; opacity: 0.8;">í•˜ê¸‰ ì‚¬ê´€/ì…ë¬¸</div>
          </div>
        </div>

        <div style="margin-top: 15px; text-align: center;">
          <button id="showFullRankInfoBtn" style="background: none; border: 1px solid #f39c12; color: #f39c12; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;">ğŸ“œ ì „ì²´ ì§ê¸‰í‘œ ë³´ê¸°</button>
        </div>
      </div>

      <!-- ì°¸ì—¬ ë°©ë²• -->
      <div style="margin-bottom: 25px;">
        <h3 style="color: #3498db; margin-bottom: 15px; font-size: 1.1em;">ğŸš€ ì°¸ì—¬ ë°©ë²•</h3>
        <div class="recruit-steps">
          <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 12px; padding: 15px; text-align: center;">
            <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">1</div>
            <h4 style="color: #3498db; margin-bottom: 5px; font-size: 0.9em;">ì‚¬ì´íŠ¸ ì ‘ì†</h4>
          </div>
          <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 12px; padding: 15px; text-align: center;">
            <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">2</div>
            <h4 style="color: #3498db; margin-bottom: 5px; font-size: 0.9em;">íšŒì›ê°€ì…</h4>
          </div>
          <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 12px; padding: 15px; text-align: center;">
            <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">3</div>
            <h4 style="color: #3498db; margin-bottom: 5px; font-size: 0.9em;">ì—­ì‚¬ ì—°êµ¬</h4>
            <p style="font-size: 0.75em; color: #bdc3c7;">ìš°í´ë¦­ â†’ ì‚¬ë£Œ ì œì¶œ</p>
          </div>
          <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 12px; padding: 15px; text-align: center;">
            <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">4</div>
            <h4 style="color: #3498db; margin-bottom: 5px; font-size: 0.9em;">ìŠ¹ê¸‰!</h4>
          </div>
        </div>
      </div>

      <!-- CTA ë²„íŠ¼ ì˜ì—­ -->
      <div class="recruit-cta" style="text-align: center; padding: 25px; background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.1)); border-radius: 15px; margin-bottom: 20px;">
        <h2 style="font-family: 'Noto Serif KR', serif; font-size: 1.5em; color: #f39c12; margin-bottom: 20px;">ğŸŒ í•¨ê»˜ ìƒì–´ë²„ë¦° ì—­ì‚¬ë¥¼ ë˜ì°¾ìì‹œë‹¤!</h2>
        <a href="register.html" style="display: inline-block; padding: 15px 40px; font-size: 1.2em; font-weight: bold; color: #1a1a2e; background: linear-gradient(135deg, #f39c12, #e67e22); border: none; border-radius: 50px; text-decoration: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(243, 156, 18, 0.4);">
          íšŒì›ê°€ì…í•˜ê³  ì°¸ì—¬í•˜ê¸° <span style="margin-left: 10px;">â†’</span>
        </a>
      </div>

      <!-- ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸° -->
      <div style="text-align: center; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
        <label style="cursor: pointer; color: #7f8c8d; font-size: 0.9em; display: inline-flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="dontShowTodayCheckbox" style="cursor: pointer; width: 16px; height: 16px;">
          ì˜¤ëŠ˜ í•˜ë£¨ ì´ ì°½ì„ ë³´ì§€ ì•ŠìŠµë‹ˆë‹¤
        </label>
      </div>
    </div>
  </div>

  <script>
  // ğŸš© [ì¶”ê°€] ì‚¬ê´€ ëª¨ì§‘ íŒì—… ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
  (function() {
    const POPUP_STORAGE_KEY = 'welcomePopupDontShowToday';
    
    // íŒì—…ì„ ë³´ì—¬ì¤„ì§€ í™•ì¸
    function shouldShowPopup() {
      const dontShowDate = localStorage.getItem(POPUP_STORAGE_KEY);
      if (!dontShowDate) return true;
      
      // ì˜¤ëŠ˜ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹)
      const today = new Date().toISOString().split('T')[0];
      return dontShowDate !== today;
    }
    
    // íŒì—… í‘œì‹œ
    function showWelcomePopup() {
      const popup = document.getElementById('welcomePopupModal');
      if (popup && shouldShowPopup()) {
        popup.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }
    }
    
    // íŒì—… ë‹«ê¸°
    function closeWelcomePopup() {
      const popup = document.getElementById('welcomePopupModal');
      const checkbox = document.getElementById('dontShowTodayCheckbox');
      
      if (checkbox && checkbox.checked) {
        // ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸° - ì˜¤ëŠ˜ ë‚ ì§œ ì €ì¥
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(POPUP_STORAGE_KEY, today);
      }
      
      if (popup) {
        popup.style.display = 'none';
        document.body.style.overflow = '';
      }
    }
    
    // ì „ì²´ ì§ê¸‰í‘œ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
    function showFullRankInfo() {
      closeWelcomePopup();
      // ê¸°ì¡´ ì§ê¸‰ ì•ˆë‚´ ëª¨ë‹¬ ì—´ê¸°
      const rankInfoModal = document.getElementById('rankInfoModal');
      if (rankInfoModal) {
        rankInfoModal.style.display = 'block';
      }
    }
    
    // ğŸš© event-sidebarì—ë§Œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ ì ìš© (timeline-containerëŠ” JS pointer-eventsë¡œ ì œì–´)
    const eventSidebar = document.getElementById('event-sidebar');
    
    if (eventSidebar && L && L.DomEvent) {
      L.DomEvent.disableClickPropagation(eventSidebar);
      L.DomEvent.disableScrollPropagation(eventSidebar);
      console.log('âœ… event-sidebarì— í´ë¦­/ìŠ¤í¬ë¡¤ ì „íŒŒ ë°©ì§€ ì ìš©');
    }
    
    // DOM ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.addEventListener('DOMContentLoaded', function() {
      // ì•½ê°„ì˜ ë”œë ˆì´ í›„ íŒì—… í‘œì‹œ (ì§€ë„ ë¡œë”© ì™„ë£Œ í›„)
      setTimeout(showWelcomePopup, 1500);
      
      // ë‹«ê¸° ë²„íŠ¼
      const closeBtn = document.getElementById('closeWelcomePopupBtn');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeWelcomePopup);
      }
      
      // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
      const popup = document.getElementById('welcomePopupModal');
      if (popup) {
        popup.addEventListener('click', function(e) {
          if (e.target === popup) {
            closeWelcomePopup();
          }
        });
      }
      
      // ì „ì²´ ì§ê¸‰í‘œ ë³´ê¸° ë²„íŠ¼
      const fullRankBtn = document.getElementById('showFullRankInfoBtn');
      if (fullRankBtn) {
        fullRankBtn.addEventListener('click', showFullRankInfo);
      }
      
      // ğŸŸ¢ [ì¶”ê°€] ranking.htmlì—ì„œ ê²€í†  ì™„ë£Œ ë©”ì‹œì§€ ë°›ì•„ì„œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
      window.addEventListener('message', async (event) => {
        console.log('ğŸ“¨ [ë©”ì‹œì§€ ìˆ˜ì‹ ] event.data:', event.data);
        
        if (event.data.type === 'contributionReviewed') {
          const { contributionId, newStatus } = event.data;
          console.log(`ğŸ“¨ [ë©”ì‹œì§€ ìˆ˜ì‹ ] ${contributionId} â†’ ${newStatus}`);
          console.log('ğŸ—ºï¸ [ë””ë²„ê·¸] map ì¡´ì¬:', !!map);
          console.log('ğŸ—ºï¸ [ë””ë²„ê·¸] userContributions ì†ŒìŠ¤ ì¡´ì¬:', map ? !!map.getSource('userContributions') : 'map ì—†ìŒ');
          console.log('ğŸ“Š [ë””ë²„ê·¸] í˜„ì¬ contributions ê°œìˆ˜:', contributions.length);
          
          // ğŸ”„ ì„œë²„ì—ì„œ ìµœì‹  contributions ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          try {
            console.log('ğŸ”„ [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            const freshContributions = await fetchData('contributions');
            console.log('ğŸ“¥ [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] ë°›ì€ ë°ì´í„°:', freshContributions ? freshContributions.length : 'null');
            
            if (freshContributions && freshContributions.length > 0) {
              contributions = freshContributions;
              console.log(`âœ… [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] Contributions ë°ì´í„° ê°±ì‹  ì™„ë£Œ: ${contributions.length}ê°œ`);
              
              // userContributions ë ˆì´ì–´ ë‹¤ì‹œ ë Œë”ë§
              if (map.getSource('userContributions')) {
                const geojsonData = {
                  type: 'FeatureCollection',
                  features: contributions
                    .filter(c => ['pending', 'reviewed'].includes(c.status) && c.lat && c.lng && c.type !== 'historical_record')
                    .map(c => {
                      const isMyContribution = c.created_by_username === currentUser?.username;
                      const isReviewed = c.status === 'reviewed';
                      let iconColor = isReviewed ? '#27ae60' : (isMyContribution ? '#3498db' : '#e67e22');
                      
                      return {
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: [c.lng, c.lat] },
                        properties: {
                          id: c._id,
                          name: c.name,
                          type: c.type,
                          status: c.status,
                          created_by: c.created_by_username,
                          iconColor: iconColor,
                          isMyContribution: isMyContribution,
                          isReviewed: isReviewed
                        }
                      };
                    })
                };
                map.getSource('userContributions').setData(geojsonData);
                console.log(`âœ… [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] ë§ˆì»¤ ${geojsonData.features.length}ê°œ ë Œë”ë§ ì™„ë£Œ`);
              } else {
                console.warn('âš ï¸ [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] userContributions ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
              }
            }
          } catch (error) {
            console.error('âŒ [ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] Contributions ê°±ì‹  ì‹¤íŒ¨:', error);
          }
        }
      });
    });
  })();
  </script>

  <style>
  /* ğŸš© [ì¶”ê°€] íŒì—… ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  
  #welcomePopupModal > div {
    animation: popupSlideIn 0.4s ease-out;
  }
  
  @keyframes popupSlideIn {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    #welcomePopupModal > div {
      margin: 2% auto;
      padding: 20px;
      max-height: 95vh;
    }
    
    #welcomePopupModal h1 {
      font-size: 1.5em !important;
    }
    
    #welcomePopupModal .quote-box p {
      font-size: 1em !important;
    }
    
    /* 2ì»¬ëŸ¼ì„ 1ì»¬ëŸ¼ìœ¼ë¡œ */
    #welcomePopupModal > div > div:nth-child(4) {
      grid-template-columns: 1fr !important;
    }
    
    /* ì§ê¸‰ 4ì»¬ëŸ¼ì„ 2ì»¬ëŸ¼ìœ¼ë¡œ */
    #welcomePopupModal > div > div:nth-child(5) > div:nth-child(3) {
      grid-template-columns: repeat(2, 1fr) !important;
    }
    
    /* ì°¸ì—¬ë°©ë²• 4ì»¬ëŸ¼ì„ 2ì»¬ëŸ¼ìœ¼ë¡œ */
    #welcomePopupModal > div > div:nth-child(6) > div {
      grid-template-columns: repeat(2, 1fr) !important;
    }
  }
  </style>

</body>
</html>