<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜í†  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        /* ğŸš© [ì¶”ê°€] íŒì—… ì „ìš© í—¤ë” */
        .popup-header {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .popup-header h1 {
            margin: 0;
            font-size: 1.8em;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
            display: none; /* ğŸš© íŒì—… í—¤ë”ê°€ ëŒ€ì‹ í•˜ë¯€ë¡œ ìˆ¨ê¹€ */
        }
        .header .back-btn {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .header .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        .content {
            padding: 40px;
        }
        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
        }
        .section h2::before {
            content: 'ğŸ“';
            margin-right: 10px;
            font-size: 28px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        textarea {
            font-family: monospace;
            min-height: 150px;
            resize: vertical;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        button {
            flex: 1;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-info { color: #569cd6; }
        .log-warning { color: #dcdcaa; }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .info-box ul {
            list-style: none;
            padding-left: 0;
        }
        .info-box li {
            padding: 5px 0;
            color: #555;
        }
        .info-box li::before {
            content: 'âœ“ ';
            color: #4caf50;
            font-weight: bold;
            margin-right: 8px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- ğŸš© [ì¶”ê°€] íŒì—… ì „ìš© í—¤ë” -->
    <div class="popup-header">
        <h1>ğŸ—ºï¸ ì˜í†  ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
    </div>
    
    <div class="container">
        <div class="header">
            <a href="javascript:history.back()" class="back-btn">â† ëŒì•„ê°€ê¸°</a>
            <h1>ğŸ—ºï¸ ì˜í†  ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p>GeoJSON/OSM ë§í¬ë¥¼ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ MongoDBì— ì €ì¥í•©ë‹ˆë‹¤</p>
        </div>

        <div class="content">
            <form id="territoryForm" onsubmit="return false;" novalidate>
                <!-- ì •ë³´ ì„¹ì…˜ -->
                <div class="info-box">
                    <h3>ğŸ¯ ìë™ ì²˜ë¦¬ í•­ëª©</h3>
                    <ul>
                        <li>GeoJSON ê²€ì¦ ë° ë³€í™˜</li>
                        <li>Bounding Box (bbox) ìë™ ê³„ì‚°</li>
                        <li>ì‹œê°„ ë²”ìœ„ (start_year, end_year) ìë™ ì„¤ì •</li>
                        <li>MongoDB ì¸ë±ìŠ¤ ìë™ ì ìš©</li>
                        <li>ì¤‘ë³µ í™•ì¸ ë° ì—…ë°ì´íŠ¸</li>
                        <li>OpenStreetMap ë³´ê¸°: <a href="https://www.openstreetmap.org/#map=5/35.69/116.50" target="_blank" rel="noopener noreferrer">https://www.openstreetmap.org/#map=5/35.69/116.50</a></li>
                    </ul>
                </div>

                <!-- 0. ì¸ì¦ -->
                <div class="section">
                    <h2>ğŸ” ì¸ì¦</h2>
                    <div class="form-group">
                        <label>JWT í† í° (ìë™ ê°ì§€ë¨)</label>
                        <input type="password" id="jwt_token" placeholder="ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤" readonly style="background: #e9ecef;">
                        <small style="color: #6c757d; display: block; margin-top: 5px;">
                            ğŸ’¡ ì´ë¯¸ ë¡œê·¸ì¸í•œ ê²½ìš° ìë™ìœ¼ë¡œ ê°ì§€ë©ë‹ˆë‹¤. ìˆ˜ë™ ì…ë ¥ ì‹œ readonly í•´ì œ í›„ ë¶™ì—¬ë„£ê¸°
                        </small>
                    </div>
                </div>

                <!-- 1. ê¸°ë³¸ ì •ë³´ ì…ë ¥ -->
                <div class="section">
                    <h2>ê¸°ë³¸ ì •ë³´</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label>ì˜ë¬¸ ì´ë¦„ *</label>
                            <input type="text" id="name" placeholder="ì˜ˆ: Laos" required>
                        </div>
                        <div class="form-group">
                            <label>í•œê¸€ ì´ë¦„ *</label>
                            <input type="text" id="name_ko" placeholder="ì˜ˆ: ë¼ì˜¤ìŠ¤" required>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>ì½”ë“œ</label>
                            <input type="text" id="code" placeholder="ì˜ˆ: LA (ì„ íƒì‚¬í•­)">
                        </div>
                        <div class="form-group">
                            <label>íƒ€ì…</label>
                            <select id="type">
                                <option value="country">êµ­ê°€ (Country)</option>
                                <option value="admin_area">í–‰ì •êµ¬ì—­ (Admin Area)</option>
                                <option value="historical">ì—­ì‚¬ì  ì˜í† </option>
                                <option value="cultural">ë¬¸í™”ê¶Œ</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>ì‹œì‘ ì—°ë„</label>
                            <input type="number" id="start_year" value="-3000" placeholder="-3000">
                        </div>
                        <div class="form-group">
                            <label>ì¢…ë£Œ ì—°ë„</label>
                            <input type="number" id="end_year" value="3000" placeholder="3000">
                        </div>
                    </div>
                </div>

                <!-- 2. GeoJSON ì…ë ¥ -->
                <div class="section">
                    <h2>ì§€ë¦¬ ë°ì´í„°</h2>
                    <div class="form-group">
                        <label>ì…ë ¥ ë°©ì‹ ì„ íƒ</label>
                        <select id="input_method" onchange="toggleInputMethod()">
                            <option value="geojson">GeoJSON ì§ì ‘ ì…ë ¥</option>
                            <option value="osm">OSM Relation ID</option>
                            <option value="url">GeoJSON URL</option>
                        </select>
                    </div>

                    <div id="geojson_input" class="form-group">
                        <label>GeoJSON ë°ì´í„° *</label>
                        <textarea id="geojson" placeholder='{"type":"Feature","geometry":{"type":"Polygon","coordinates":[...]}}'></textarea>
                    </div>

                    <div id="osm_input" class="form-group" style="display:none;">
                        <label>OSM Relation ID *</label>
                        <input type="text" id="osm_id" placeholder="ì˜ˆ: 49903 (Laos)">
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn-secondary" onclick="fetchFromOSM()" style="flex:1;">
                                ğŸŒ OSMì—ì„œ ê°€ì ¸ì˜¤ê¸°
                            </button>
                            <button class="btn-warning" onclick="deleteByOSM()" style="flex:1; background:#dc3545; color:white;">
                                ğŸ—‘ï¸ OSMìœ¼ë¡œ ê¸°ì¡´ ì˜í†  ì‚­ì œ
                            </button>
                            <button class="btn-secondary" onclick="openOSMMap()" style="flex:1; background:#17a2b8; color:white;">OSM ì§€ë„ ì—´ê¸°</button>
                            <button class="btn-secondary" onclick="intersectPreview()" style="flex:1; background:#6f42c1; color:white;">ì´ ì˜ì—­ê³¼ êµì°¨í•˜ëŠ” ì˜í†  ê²€ìƒ‰</button>
                        </div>
                    </div>

                    <div id="url_input" class="form-group" style="display:none;">
                        <label>GeoJSON URL *</label>
                        <input type="text" id="geojson_url" placeholder="https://example.com/data.geojson">
                        <button class="btn-secondary" onclick="fetchFromURL()" style="margin-top: 10px;">
                            ğŸ“¥ URLì—ì„œ ê°€ì ¸ì˜¤ê¸°
                        </button>
                    </div>
                </div>

                <!-- 3. ì‹¤í–‰ ë²„íŠ¼ -->
                <div class="section">
                    <h2>ì‹¤í–‰</h2>
                    <div class="button-group">
                        <button class="btn-primary" onclick="processAndSave()">
                            âœ… ì²˜ë¦¬ ë° ì €ì¥
                        </button>
                        <button class="btn-secondary" onclick="validateOnly()">
                            ğŸ” ê²€ì¦ë§Œ í•˜ê¸°
                        </button>
                        <button class="btn-success" onclick="exportJSON()">
                            ğŸ“¤ JSON ë‚´ë³´ë‚´ê¸°
                        </button>
                    </div>
                    <div class="progress-bar" id="progress">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>

                <!-- 4. ë¡œê·¸ -->
                <div class="section">
                    <h2>ì²˜ë¦¬ ë¡œê·¸</h2>
                    <div class="log-area" id="log"></div>
                </div>

                <!-- êµì°¨ ê²€ìƒ‰ ê²°ê³¼ -->
                <div id="intersect_results" style="display:none; margin-top:12px; background:#fff; padding:12px; border-radius:8px; border:1px solid #e0e0e0;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong>êµì°¨ ê²€ìƒ‰ ê²°ê³¼</strong>
                        <button class="btn-secondary" onclick="document.getElementById('intersect_results').style.display='none'" style="background:#6c757d; color:white;">ë‹«ê¸°</button>
                    </div>
                    <div id="intersect_results_list" style="max-height:300px; overflow:auto; margin-bottom:8px;"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-warning" onclick="deleteSelectedFromIntersect()" style="background:#dc3545; color:white;">ì„ íƒëœ í•­ëª© ì‚­ì œ</button>
                        <button class="btn-secondary" onclick="selectAllIntersect(true)">ëª¨ë‘ ì„ íƒ</button>
                        <button class="btn-secondary" onclick="selectAllIntersect(false)">ì„ íƒ í•´ì œ</button>
                        <button class="btn-success" onclick="backupThenDeleteSelectedIntersect()" style="background:#198754; color:white;">ë°±ì—… í›„ ì‚­ì œ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // í™˜ê²½ ê°ì§€ ê°œì„  (file:// í”„ë¡œí† ì½œ ëŒ€ì‘)
        const isLocal = window.location.hostname === 'localhost' 
                     || window.location.hostname === '127.0.0.1'
                     || window.location.protocol === 'file:';
        
        // í•­ìƒ ê°™ì€ í˜¸ìŠ¤íŠ¸ì˜ /apië¥¼ ì‚¬ìš© (ë¡œì»¬ì´ë“  í”„ë¡œë•ì…˜ì´ë“  ë™ì¼ ì„œë²„)
        const API_BASE = (window.location.protocol === 'file:')
            ? 'http://localhost:3000/api'
            : `${window.location.origin}/api`;

        // í™˜ê²½ ì •ë³´ ë¡œê¹…
        console.log('ğŸŒ í™˜ê²½ ê°ì§€:', {
            hostname: window.location.hostname,
            protocol: window.location.protocol,
            isLocal: isLocal,
            API_BASE: API_BASE
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í† í° ê°ì§€
        window.addEventListener('DOMContentLoaded', () => {
            // í™˜ê²½ ì •ë³´ í‘œì‹œ
            log(`ğŸŒ í™˜ê²½: ${isLocal ? 'ë¡œì»¬ ê°œë°œ' : 'í”„ë¡œë•ì…˜'}`, 'info');
            log(`ğŸ“¡ API: ${API_BASE}`, 'info');
            
            // íŒŒì¼ ì‹œìŠ¤í…œ ê²½ê³ 
            if (window.location.protocol === 'file:') {
                log('âš ï¸  íŒŒì¼ì—ì„œ ì§ì ‘ ì—´ë ¸ìŠµë‹ˆë‹¤. ë¡œì»¬ ì„œë²„ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.', 'error');
                log('ğŸ’¡ http://localhost:3000/territory_manager.html ë¡œ ì ‘ì†í•˜ì„¸ìš”', 'info');
            }
            
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            const tokenInput = document.getElementById('jwt_token');
            
            if (token) {
                tokenInput.value = token.substring(0, 20) + '...'; // ì¼ë¶€ë§Œ í‘œì‹œ
                tokenInput.dataset.fullToken = token; // ì „ì²´ í† í° ì €ì¥
                log('âœ“ JWT í† í° ìë™ ê°ì§€ë¨', 'success');
            } else {
                tokenInput.placeholder = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. index.htmlì—ì„œ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.';
                tokenInput.style.background = '#fff3cd';
                log('âš ï¸  ë¡œê·¸ì¸ í† í°ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        });

        // í† í° ìˆ˜ë™ ì…ë ¥ í™œì„±í™”
        document.addEventListener('DOMContentLoaded', () => {
            const tokenInput = document.getElementById('jwt_token');
            tokenInput.addEventListener('dblclick', () => {
                tokenInput.removeAttribute('readonly');
                tokenInput.style.background = 'white';
                tokenInput.placeholder = 'ì—¬ê¸°ì— JWT í† í°ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”';
                log('ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ í™œì„±í™”', 'info');
            });
        });

        function log(message, type = 'info') {
            const logArea = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function toggleInputMethod() {
            const method = document.getElementById('input_method').value;
            const nameKoField = document.getElementById('name_ko');

            // ì…ë ¥ ë°©ì‹ì— ë”°ë¥¸ í•„ë“œ í‘œì‹œ
            document.getElementById('geojson_input').style.display = method === 'geojson' ? 'block' : 'none';
            document.getElementById('osm_input').style.display = method === 'osm' ? 'block' : 'none';
            document.getElementById('url_input').style.display = method === 'url' ? 'block' : 'none';

            // OSM ì…ë ¥ ë°©ì‹ì¼ ë•ŒëŠ” í•œê¸€ ì´ë¦„ í•„ìˆ˜ ì…ë ¥ í•´ì œ
            if (method === 'osm') {
                nameKoField.removeAttribute('required');
                nameKoField.placeholder = 'ì˜ˆ: ë¼ì˜¤ìŠ¤ (OSMì—ì„œ ìë™ ì±„ìš°ê¸° ê°€ëŠ¥)';
                log('ğŸ’¡ OSM ì…ë ¥ ë°©ì‹: í•œê¸€ ì´ë¦„ì€ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤ (OSMì—ì„œ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤)', 'info');
            } else {
                nameKoField.setAttribute('required', 'required');
                nameKoField.placeholder = 'ì˜ˆ: ë¼ì˜¤ìŠ¤';
            }
        }

        async function fetchFromOSM() {
            const osmId = document.getElementById('osm_id').value.trim();
            if (!osmId) {
                log('OSM Relation IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            // OSM ID í˜•ì‹ ê²€ì¦ (ìˆ«ìë§Œ)
            if (!/^\d+$/.test(osmId)) {
                log('OSM IDëŠ” ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 2297418)', 'error');
                return;
            }

            log(`ğŸ” OSM Relation ${osmId}ì—ì„œ ì •ë³´ ì¡°íšŒ ì¤‘...`, 'info');
            setProgress(20);

            try {
                // 1. Overpass APIë¡œ ìƒì„¸ ì •ë³´ ì¡°íšŒ (ë” ì •í™•í•œ í•œêµ­ì–´/ì˜ì–´ ì´ë¦„)
                const overpassQuery = `
                    [out:json][timeout:25];
                    relation(${osmId});
                    out body;
                `;

                const overpassResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'KoreaHistoryMap/1.0'
                    },
                    body: `data=${encodeURIComponent(overpassQuery)}`
                });

                if (!overpassResponse.ok) {
                    throw new Error(`Overpass API ì˜¤ë¥˜: ${overpassResponse.status}`);
                }

                const overpassData = await overpassResponse.json();
                setProgress(50);

                if (!overpassData.elements || overpassData.elements.length === 0) {
                    throw new Error('OSMì—ì„œ í•´ë‹¹ Relationì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                const relation = overpassData.elements[0];
                const tags = relation.tags || {};

                // ì´ë¦„ ì •ë³´ ì¶”ì¶œ (ìš°ì„ ìˆœìœ„: name > name:ko > name:en)
                const name = tags.name || tags['name:ko'] || tags['name:en'] || `OSM Relation ${osmId}`;
                const nameKo = tags['name:ko'] || tags.name || '';
                const nameEn = tags['name:en'] || tags.name || '';

                // admin_level ì„¤ì •
                const adminLevel = tags.admin_level ? parseInt(tags.admin_level) : 4;

                // í¼ í•„ë“œ ìë™ ì±„ìš°ê¸°
                document.getElementById('name').value = nameEn || name; // ì˜ë¬¸ ì´ë¦„
                document.getElementById('name_ko').value = nameKo || name; // í•œê¸€ ì´ë¦„

                // ì¶”ê°€ ì •ë³´ ì„¤ì •
                document.getElementById('code').value = osmId;

                // íƒ€ì… ì„¤ì • (admin_levelì— ë”°ë¼)
                let type = 'province';
                if (adminLevel === 2) type = 'country';
                else if (adminLevel >= 6) type = 'admin_area';
                else if (adminLevel <= 3) type = 'country';
                document.getElementById('type').value = type;

                // OSM ID ì €ì¥
                let osmIdField = document.getElementById('osm_id_hidden');
                if (!osmIdField) {
                    osmIdField = document.createElement('input');
                    osmIdField.type = 'hidden';
                    osmIdField.id = 'osm_id_hidden';
                    osmIdField.name = 'osm_id';
                    // territoryForm may not exist if the page doesn't use a <form> element.
                    // Append to a safe container instead (prefer the form if present).
                    const territoryForm = document.getElementById('territoryForm') || document.querySelector('.container') || document.body;
                    territoryForm.appendChild(osmIdField);
                    if (!document.getElementById('territoryForm')) {
                        console.warn('territoryForm element not found; appended osm_id_hidden to .container or body');
                    }
                }
                osmIdField.value = `r${osmId}`;

                // 2. GeoJSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Nominatim ì‚¬ìš©)
                setProgress(80);
                const geoUrl = `https://nominatim.openstreetmap.org/lookup?osm_ids=R${osmId}&format=geojson&polygon_geojson=1`;
                const geoResponse = await fetch(geoUrl, {
                    headers: { 'User-Agent': 'KoreaHistoryMap/1.0' }
                });

                if (geoResponse.ok) {
                    const geoData = await geoResponse.json();
                    if (geoData.features && geoData.features.length > 0) {
                        const geojson = JSON.stringify(geoData.features[0], null, 2);
                        document.getElementById('geojson').value = geojson;
                        // store bbox for intersection queries
                        const feature = geoData.features[0];
                        const g = feature.geometry || feature;
                        const computedBbox = calculateBBox(g);
                        if (computedBbox) {
                            document.getElementById('osm_bbox_hidden')?.remove();
                            const b = document.createElement('input');
                            b.type = 'hidden'; b.id = 'osm_bbox_hidden'; b.name = 'osm_bbox';
                            b.value = JSON.stringify(computedBbox);
                            document.getElementById('territoryForm').appendChild(b);
                        }
                    }
                }

                setProgress(100);
                log(`âœ… OSM ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${name}`, 'success');
                log(`  ğŸ‡°ğŸ‡· í•œê¸€: ${nameKo || 'ìë™ ì„¤ì •ë¨'}`, 'info');
                log(`  ğŸ‡ºğŸ‡¸ ì˜ë¬¸: ${nameEn}`, 'info');
                log(`  ğŸ·ï¸  í–‰ì •ë‹¨ê³„: ${adminLevel}`, 'info');
                log(`  ğŸ“Š íƒ€ì…: ${type}`, 'info');

                // ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ì€ í˜„ì¬ ì‚¬ìš© ì¤‘ì§€ë¨
                // ìë™ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° ì—´ê¸° (ì‚¬ìš©ì í¸ì˜)
                // try {
                //     previewByOSM();
                // } catch (e) {
                //     // ë¬´ì‹œ - ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ìœ¼ë¡œ ì‹œë„í•˜ë„ë¡ í•¨
                // }

                // í•œê¸€ ì´ë¦„ì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (!nameKo || nameKo === nameEn) {
                    log('ğŸ’¡ í•œê¸€ ì´ë¦„ì´ ìë™ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.', 'warning');
                }

            } catch (error) {
                log(`âŒ OSM ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                setProgress(0);
            }
        }

        async function fetchFromURL() {
            const url = document.getElementById('geojson_url').value.trim();
            if (!url) {
                log('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            log('URLì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'info');
            setProgress(30);

            try {
                const response = await fetch(url);

                // HTTP ì˜¤ë¥˜ ì²´í¬
                if (!response.ok) {
                    // ê°€ëŠ¥í•œ ê²½ìš° ì‘ë‹µ ë³¸ë¬¸ì˜ ì§§ì€ ìŠ¤ë‹ˆí«ì„ ê°€ì ¸ì™€ì„œ ì—ëŸ¬ ë©”ì‹œì§€ì— í¬í•¨
                    const text = await response.text().catch(() => '');
                    const snippet = (text || '').slice(0, 200).replace(/\s+/g, ' ');
                    throw new Error(`HTTP ${response.status} ${response.statusText}${snippet ? ' â€” ì‘ë‹µ ì¼ë¶€: ' + snippet : ''}`);
                }

                // Content-Type ê²€ì‚¬ (ì¼ë°˜ì ì¸ GeoJSON/JSON íƒ€ì… í—ˆìš©)
                const contentType = (response.headers.get('content-type') || '').toLowerCase();
                if (!/application\/(geo\+)?json|json/.test(contentType)) {
                    // HTML ì—ëŸ¬ í˜ì´ì§€ê°€ ë°˜í™˜ë˜ëŠ” ê²½ìš° ì¹œì ˆí•œ ë©”ì‹œì§€ ì œê³µ
                    const text = await response.text().catch(() => '');
                    if (text.trim().startsWith('<')) {
                        throw new Error('ì‘ë‹µì´ HTMLì…ë‹ˆë‹¤ (404 í˜ì´ì§€ ë˜ëŠ” ë¦¬ë””ë ‰ì…˜). URLì´ ì˜¬ë°”ë¥´ê³  ì„œë²„ê°€ GeoJSONì„ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                    }

                    // Content-Typeì´ ì´ìƒí•˜ì§€ë§Œ ë³¸ë¬¸ì´ JSONì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‹œë„í•´ë³¸ë‹¤
                    try {
                        const parsed = JSON.parse(text);
                        const geojson = JSON.stringify(parsed, null, 2);
                        document.getElementById('geojson').value = geojson;
                        log('âœ“ URL ë°ì´í„° ë¡œë“œ ì™„ë£Œ (Content-Type ë¹„í‘œì¤€ì´ì§€ë§Œ JSON íŒŒì‹± ì„±ê³µ)', 'success');
                        setProgress(100);
                        return;
                    } catch (e) {
                        throw new Error('ì„œë²„ ì‘ë‹µì´ JSON/GeoJSONì´ ì•„ë‹™ë‹ˆë‹¤. (Content-Type=' + contentType + ')');
                    }
                }

                // ì •ìƒì ì¸ JSON/GeoJSON íŒŒì‹±
                const data = await response.json();
                const geojson = JSON.stringify(data, null, 2);
                document.getElementById('geojson').value = geojson;
                log('âœ“ URL ë°ì´í„° ë¡œë“œ ì™„ë£Œ', 'success');
                setProgress(100);
            } catch (error) {
                // ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” CORS ì˜¤ë¥˜ ë©”ì‹œì§€ ë³´ì™„
                let msg = error.message || String(error);
                if (msg.includes('Failed to fetch')) {
                    msg = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” CORS ì°¨ë‹¨: ì„œë²„ê°€ ì™¸ë¶€ ìš”ì²­ì„ í—ˆìš©í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš” (ë¸Œë¼ìš°ì € ì½˜ì†”ì˜ ë„¤íŠ¸ì›Œí¬ íƒ­ í™•ì¸)';
                }
                log(`URL ë¡œë“œ ì‹¤íŒ¨: ${msg}`, 'error');
                setProgress(0);
            }
        }

        function calculateBBox(geometry) {
            if (!geometry || !geometry.coordinates) return null;

            let minLat = Infinity, maxLat = -Infinity;
            let minLng = Infinity, maxLng = -Infinity;

            const processCoords = (coords) => {
                if (typeof coords[0] === 'number') {
                    // [lng, lat] í˜•ì‹
                    const [lng, lat] = coords;
                    if (lat < minLat) minLat = lat;
                    if (lat > maxLat) maxLat = lat;
                    if (lng < minLng) minLng = lng;
                    if (lng > maxLng) maxLng = lng;
                } else {
                    // ì¤‘ì²© ë°°ì—´
                    coords.forEach(processCoords);
                }
            };

            processCoords(geometry.coordinates);

            return { minLat, maxLat, minLng, maxLng };
        }

        function validateOnly() {
            log('=== ê²€ì¦ ì‹œì‘ ===', 'info');
            const data = collectFormData();
            if (!data) return;

            log('âœ“ ê¸°ë³¸ ì •ë³´ ê²€ì¦ ì™„ë£Œ', 'success');
            log(`  - ì´ë¦„: ${data.name} (${data.name_ko})`, 'info');
            log(`  - íƒ€ì…: ${data.type}`, 'info');
            log(`  - ì‹œê°„ ë²”ìœ„: ${data.start_year} ~ ${data.end_year}`, 'info');
            log(`âœ“ GeoJSON ê²€ì¦ ì™„ë£Œ`, 'success');
            log(`  - Type: ${data.geometry.type}`, 'info');
            log(`  - BBox: [${data.bbox.minLat.toFixed(2)}, ${data.bbox.minLng.toFixed(2)}] â†’ [${data.bbox.maxLat.toFixed(2)}, ${data.bbox.maxLng.toFixed(2)}]`, 'info');
            log('=== ê²€ì¦ ì™„ë£Œ ===', 'success');
        }

        function collectFormData() {
            const name = document.getElementById('name').value.trim();
            const name_ko = document.getElementById('name_ko').value.trim();
            const geojsonText = document.getElementById('geojson').value.trim();
            const osmId = document.getElementById('osm_id_hidden')?.value;

            // OSM IDê°€ ìˆëŠ” ê²½ìš°: nameë§Œ í•„ìˆ˜, name_koëŠ” ì„ íƒ
            // OSM IDê°€ ì—†ëŠ” ê²½ìš°: ê¸°ì¡´ì²˜ëŸ¼ nameê³¼ name_ko ëª¨ë‘ í•„ìˆ˜
            const isOsmImport = !!osmId;
            if (!name || !geojsonText || (!isOsmImport && !name_ko)) {
                const required = isOsmImport ? 'ì´ë¦„, GeoJSON' : 'ì´ë¦„, í•œêµ­ì–´ ì´ë¦„, GeoJSON';
                log(`${required}ì„(ë¥¼) ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”`, 'error');
                return null;
            }

            let geojsonData;
            try {
                geojsonData = JSON.parse(geojsonText);
            } catch (e) {
                log('GeoJSON íŒŒì‹± ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', 'error');
                return null;
            }

            const geometry = geojsonData.geometry || geojsonData;
            if (!geometry.coordinates) {
                log('GeoJSONì— coordinatesê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return null;
            }

            const bbox = calculateBBox(geometry);
            if (!bbox) {
                log('BBox ê³„ì‚° ì‹¤íŒ¨', 'error');
                return null;
            }

            const data = {
                name,
                // name_en may not exist in the minimal form UI; fall back to English name = name
                name_en: document.getElementById('name_en')?.value?.trim() || name,
                name_ko: name_ko || name, // OSM importì‹œ name_koê°€ ì—†ìœ¼ë©´ nameìœ¼ë¡œ ëŒ€ì²´
                code: document.getElementById('code').value.trim(),
                type: document.getElementById('type').value,
                // admin_level and country are optional in the UI; use defaults when missing
                admin_level: parseInt(document.getElementById('admin_level')?.value) || 4,
                country: document.getElementById('country')?.value?.trim() || name,
                geometry,
                bbox,
                start_year: parseInt(document.getElementById('start_year').value) || -5000,
                end_year: parseInt(document.getElementById('end_year').value) || 3000,
                properties: {
                    source: isOsmImport ? 'OSM Import' : 'TerritoryManager',
                    import_date: new Date().toISOString()
                }
            };

            // OSM IDê°€ ìˆëŠ” ê²½ìš° ì¶”ê°€
            if (osmId) {
                data.osm_id = osmId;
            }
            return data;
        }

        async function processAndSave() {
            log('=== ì²˜ë¦¬ ì‹œì‘ ===', 'info');
            setProgress(10);

            const data = collectFormData();
            if (!data) {
                setProgress(0);
                return;
            }

            setProgress(30);
            log('âœ“ ë°ì´í„° ê²€ì¦ ì™„ë£Œ', 'success');

            // start, end í•„ë“œë„ ì¶”ê°€ (í”„ë¡ íŠ¸ì—”ë“œ í˜¸í™˜ì„±)
            data.start = data.start_year;
            data.end = data.end_year;

            setProgress(50);
            log('MongoDBì— ì €ì¥ ì¤‘...', 'info');

            try {
                // í† í° ê°€ì ¸ì˜¤ê¸° (ìš°ì„ ìˆœìœ„: dataset â†’ localStorage â†’ sessionStorage)
                const tokenInput = document.getElementById('jwt_token');
                let token = tokenInput.dataset.fullToken || tokenInput.value;
                if (!token || token.includes('...')) {
                    token = localStorage.getItem('token') || sessionStorage.getItem('token');
                }
                
                if (!token) {
                    throw new Error('JWT í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                }
                
                log(`API í˜¸ì¶œ: POST ${API_BASE}/territories`, 'info');
                
                const response = await fetch(`${API_BASE}/territories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                setProgress(80);

                if (response.ok) {
                    const result = await response.json();
                    log('âœ“ MongoDB ì €ì¥ ì™„ë£Œ', 'success');
                    log(`  - ID: ${result._id || result.insertedId}`, 'info');
                    setProgress(100);
                    log('=== ì²˜ë¦¬ ì™„ë£Œ ===', 'success');
                    log('ğŸ’¡ index.htmlì„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì§€ë„ì—ì„œ í™•ì¸í•˜ì„¸ìš”', 'info');
                } else {
                    const errorText = await response.text();
                    let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = errorJson.message || errorMsg;
                    } catch (e) {
                        if (errorText) errorMsg += ` - ${errorText}`;
                    }
                    log(`ì €ì¥ ì‹¤íŒ¨: ${errorMsg}`, 'error');
                    setProgress(0);
                }
            } catch (error) {
                let errorMsg = error.message;
                if (error.message === 'Failed to fetch') {
                    errorMsg = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:\n' +
                              '  1. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸ (npm start)\n' +
                              '  2. ë¡œì»¬: http://localhost:3000 ì ‘ì† ê°€ëŠ¥ ì—¬ë¶€\n' +
                              '  3. í”„ë¡œë•ì…˜: Vercel ë°°í¬ ìƒíƒœ í™•ì¸';
                }
                log(`ì €ì¥ ì‹¤íŒ¨: ${errorMsg}`, 'error');
                setProgress(0);
            }
        }

        function exportJSON() {
            const data = collectFormData();
            if (!data) return;

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.name}_territory.json`;
            a.click();
            log(`âœ“ JSON íŒŒì¼ ë‚´ë³´ë‚´ê¸°: ${data.name}_territory.json`, 'success');
        }

        function setProgress(percent) {
            const progressBar = document.getElementById('progress');
            const progressFill = document.getElementById('progress-fill');
            progressBar.style.display = percent > 0 ? 'block' : 'none';
            progressFill.style.width = `${percent}%`;
        }

        // ì´ˆê¸°í™”
        log('ì˜í†  ê´€ë¦¬ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ', 'success');

        async function deleteByOSM() {
            const osmId = document.getElementById('osm_id').value.trim();
            if (!osmId) {
                log('ì‚­ì œí•  OSM Relation IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            if (!/^-?\d+$/.test(osmId)) {
                log('OSM IDëŠ” ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 2697305)', 'error');
                return;
            }

            const confirmed = confirm(`OSM Relation ${osmId}ìœ¼ë¡œ ì—°ê²°ëœ ì˜í† ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€ëŠ¥)`);
            if (!confirmed) return;

            setProgress(10);
            log(`ğŸ—‘ï¸ OSM Relation ${osmId}ìœ¼ë¡œ ì—°ê²°ëœ ì˜í†  ì‚­ì œ ì¤‘...`, 'info');

            try {
                const tokenInput = document.getElementById('jwt_token');
                let token = tokenInput.dataset.fullToken || tokenInput.value;
                if (!token || token.includes('...')) {
                    token = localStorage.getItem('token') || sessionStorage.getItem('token');
                }
                if (!token) {
                    log('JWT í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error');
                    setProgress(0);
                    return;
                }

                const response = await fetch(`${API_BASE}/territories/by-osm/${encodeURIComponent(osmId)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                setProgress(60);

                if (response.ok) {
                    const result = await response.json();
                    log(`âœ“ ì‚­ì œ ì™„ë£Œ: ${result.deletedCount}ê°œ ì‚­ì œë¨`, 'success');
                    setProgress(100);
                } else {
                    const text = await response.text();
                    log(`ì‚­ì œ ì‹¤íŒ¨: HTTP ${response.status} - ${text}`, 'error');
                    setProgress(0);
                }
            } catch (error) {
                log(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
                setProgress(0);
            }
        }

        async function intersectPreview() {
            // Read bbox from hidden osm_bbox_hidden that's set when geojson is loaded
            const bboxInput = document.getElementById('osm_bbox_hidden');
            if (!bboxInput) {
                log('ë¨¼ì € OSMì—ì„œ GeoJSONì„ ê°€ì ¸ì™€ ì˜ì—­ì„ ë¡œë“œí•˜ì„¸ìš”', 'error');
                return;
            }
            const bbox = JSON.parse(bboxInput.value);

            setProgress(10);
            log('ğŸ” ì˜ì—­ êµì°¨ ì˜í†  ê²€ìƒ‰ ì¤‘...', 'info');

            try {
                const tokenInput = document.getElementById('jwt_token');
                let token = tokenInput.dataset.fullToken || tokenInput.value;
                if (!token || token.includes('...')) token = localStorage.getItem('token') || sessionStorage.getItem('token');
                if (!token) { log('JWT í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error'); setProgress(0); return; }

                const response = await fetch(`${API_BASE}/territories/intersect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ bbox })
                });

                if (!response.ok) {
                    const text = await response.text();
                    log(`êµì°¨ ê²€ìƒ‰ ì‹¤íŒ¨: HTTP ${response.status} - ${text}`, 'error');
                    setProgress(0);
                    return;
                }

                const result = await response.json();
                const list = result.territories || [];
                const container = document.getElementById('intersect_results_list');
                container.innerHTML = '';

                if (list.length === 0) {
                    container.innerHTML = '<div>ì´ ì˜ì—­ê³¼ êµì°¨í•˜ëŠ” ì˜í† ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    list.forEach(t => {
                        const div = document.createElement('div');
                        div.style.borderBottom = '1px solid #f0f0f0';
                        div.style.padding = '8px 0';
                        div.innerHTML = `
                            <label style="display:flex; gap:10px; align-items:center;">
                                <input type="checkbox" class="intersect-checkbox" data-id="${t._id}">
                                <div style="flex:1;">
                                    <div><strong>${t.name}</strong> (${t.name_ko || '-'})</div>
                                    <div style="font-size:12px; color:#666;">íƒ€ì…: ${t.type || '-'} | ê¸°ê°„: ${t.start_year || '-'} ~ ${t.end_year || '-' } | osm_id: ${t.osm_id || '-'}</div>
                                </div>
                            </label>
                        `;
                        container.appendChild(div);
                    });
                }

                document.getElementById('intersect_results').style.display = 'block';
                setProgress(100);
                log(`âœ“ êµì°¨ ê²€ìƒ‰ ì™„ë£Œ: ${list.length}ê°œ í•­ëª©`, 'success');
            } catch (error) {
                log(`êµì°¨ ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}`, 'error');
                setProgress(0);
            }
        }

        function selectAllIntersect(yes) {
            document.querySelectorAll('.intersect-checkbox').forEach(cb => cb.checked = !!yes);
        }

        async function deleteSelectedFromIntersect() {
            const checked = Array.from(document.querySelectorAll('.intersect-checkbox:checked'));
            if (checked.length === 0) { log('ì‚­ì œí•  í•­ëª©ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
            const ids = checked.map(cb => cb.getAttribute('data-id'));
            const confirmed = confirm(`ì„ íƒëœ ${ids.length}ê°œì˜ ì˜í† ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€ëŠ¥)`);
            if (!confirmed) return;
            setProgress(10); log(`ğŸ—‘ï¸ ì„ íƒëœ ${ids.length}ê°œ ì‚­ì œ ì¤‘...`, 'info');
            try {
                const tokenInput = document.getElementById('jwt_token');
                let token = tokenInput.dataset.fullToken || tokenInput.value;
                if (!token || token.includes('...')) token = localStorage.getItem('token') || sessionStorage.getItem('token');
                if (!token) { log('JWT í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error'); setProgress(0); return; }
                const promises = ids.map(id => fetch(`${API_BASE}/territories/${encodeURIComponent(id)}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }));
                const results = await Promise.all(promises);
                let deleted = 0; for (const r of results) if (r.ok) deleted++;
                log(`âœ“ ì‚­ì œ ì™„ë£Œ: ${deleted}/${ids.length} í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                setProgress(100);
                // refresh
                document.getElementById('intersect_results').style.display = 'none';
            } catch (error) { log(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error'); setProgress(0); }
        }

        async function backupThenDeleteSelectedIntersect() {
            const checked = Array.from(document.querySelectorAll('.intersect-checkbox:checked'));
            if (checked.length === 0) { log('ë°±ì—… ë° ì‚­ì œí•  í•­ëª©ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
            const ids = checked.map(cb => cb.getAttribute('data-id'));
            const confirmed = confirm(`ì„ íƒëœ ${ids.length}ê°œì˜ ì˜í† ë¥¼ ë°±ì—…í•œ ë’¤ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!confirmed) return;
            setProgress(10); log(`ğŸ’¾ ì„ íƒëœ ${ids.length}ê°œ ë°±ì—… ì¤‘...`, 'info');
            try {
                const tokenInput = document.getElementById('jwt_token');
                let token = tokenInput.dataset.fullToken || tokenInput.value;
                if (!token || token.includes('...')) token = localStorage.getItem('token') || sessionStorage.getItem('token');
                if (!token) { log('JWT í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error'); setProgress(0); return; }
                const fetches = ids.map(id => fetch(`${API_BASE}/territories/${encodeURIComponent(id)}`, { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } }).then(r => { if (!r.ok) throw new Error(`ID ${id} ì¡°íšŒ ì‹¤íŒ¨: ${r.status}`); return r.json(); }));
                const docs = await Promise.all(fetches);
                const osmIdVal = document.getElementById('osm_id').value.trim() || 'backup';
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `territory_backup_${osmIdVal}_${timestamp}.json`;
                const blob = new Blob([JSON.stringify(docs, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
                log(`âœ“ ë°±ì—… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${filename}`, 'success'); setProgress(60);
                const confirmedDelete = confirm(`ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì„ íƒëœ ${ids.length}ê°œë¥¼ ì§€ê¸ˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€ëŠ¥)`);
                if (!confirmedDelete) { setProgress(0); return; }
                setProgress(70); log(`ğŸ—‘ï¸ ì„ íƒëœ ${ids.length}ê°œ ì‚­ì œ ì¤‘...`, 'info');
                const promises = ids.map(id => fetch(`${API_BASE}/territories/${encodeURIComponent(id)}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }));
                const results = await Promise.all(promises); let deleted = 0; for (const r of results) if (r.ok) deleted++;
                log(`âœ“ ì‚­ì œ ì™„ë£Œ: ${deleted}/${ids.length} í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success'); setProgress(100);
                document.getElementById('intersect_results').style.display = 'none';
            } catch (error) { log(`ë°±ì—…/ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error'); setProgress(0); }
        }
    </script>
</body>
</html>
